
20190115151658å¼€å§‹æ‰§è¡Œ2019-01-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151658
/*
CREATE TABLE `cuspro_archives` (
  `ccuscode` varchar(20) default null comment '¿Í»§±àÂë',
  `ccusname` varchar(120) default null comment '¿Í»§Ãû³Æ',
  `item_code` varchar(60) default null comment 'ÏîÄ¿±àÂë',
  `citemname` varchar(255) default null comment 'ÏîÄ¿Ãû³Æ',
  `cinvcode` varchar(60) default null comment '´æ»õ±àÂë',
  `cinvname` varchar(255) default null comment '´æ»õÃû³Æ',
  `equipment` varchar(255) default null comment 'ÊÇ·ñÉè±¸',
  `type` varchar(60) DEFAULT NULL COMMENT 'ÏúÊÛÀàĞÍ',
  `cbustype` varchar(60) DEFAULT NULL COMMENT 'ÒµÎñÀàĞÍ',
  `plan_start_dt` date default null comment '²úÆ·¼Æ»®ÆôÓÃÊ±¼ä',
  `bidding_dt` date default null comment 'ÖĞ±êÈÕÆÚ',
  `contract_dt` date default null comment 'ºÏÍ¬ÈÕÆÚ',
  `first_consign_dt` date default null comment '³õ´Î·¢»õÈÕÆÚ',
  `last_consign_dt` date default null comment '×îºóÒ»´Î·¢»õÈÕÆÚ',
  `iquantity_addup` int DEFAULT NULL COMMENT 'ÀÛ¼Æ·¢»õÊı',
  `install_dt`date default null comment '×°»úÊ±¼ä',
  `first_invoice_dt` date default null comment '³õ´Î¿ªÆ±ÈÕÆÚ',
  `first_invoice_price_dt` date default null comment '³õ´Î¿ªÆ±ÈÕÆÚ(µ¥¼Û´óÓÚ0)',
  `last_invoice_dt` date default null comment '×îºóÒ»´Î¿ªÆ±ÈÕÆÚ',
  `isum_addup` decimal(18,4) DEFAULT NULL COMMENT 'ÀÛ¼Æ¿ªÆ±½ğ¶î',
  `product_start_dt` date default null comment '²úÆ·ÆôÓÃÈÕÆÚ',
  `product_end_dt` date default null comment '²úÆ·Í£ÓÃÈÕÆÚ',
  `end_date` date default null comment 'È·ÈÏ¶ªµ¥ÈÕÆÚ',
  `cinvbrand` varchar(60) DEFAULT NULL COMMENT 'Æ·ÅÆ',
  `competitor` varchar(20) DEFAULT NULL COMMENT 'ÊÇ·ñ¾ºÕù¶ÔÊÖ',
  `cohr` varchar(20) default null comment '¹«Ë¾£¨¿Í»§¹©Ó¦ÉÌ£©'
 ) engine=innodb default charset=utf8 comment '¿Í»§²úÆ·µµ°¸'
;

20190115151906å¼€å§‹æ‰§è¡Œ2019-01-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151906
/*
CREATE TABLE `cuspro_archives` (
  `ccuscode` varchar(20) default null comment 'å®¢æˆ·ç¼–ç ',
  `ccusname` varchar(120) default null comment 'å®¢æˆ·åç§°',
  `item_code` varchar(60) default null comment 'é¡¹ç›®ç¼–ç ',
  `citemname` varchar(255) default null comment 'é¡¹ç›®åç§°',
  `cinvcode` varchar(60) default null comment 'å­˜è´§ç¼–ç ',
  `cinvname` varchar(255) default null comment 'å­˜è´§åç§°',
  `equipment` varchar(255) default null comment 'æ˜¯å¦è®¾å¤‡',
  `type` varchar(60) DEFAULT NULL COMMENT 'é”€å”®ç±»å‹',
  `cbustype` varchar(60) DEFAULT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
  `plan_start_dt` date default null comment 'äº§å“è®¡åˆ’å¯ç”¨æ—¶é—´',
  `bidding_dt` date default null comment 'ä¸­æ ‡æ—¥æœŸ',
  `contract_dt` date default null comment 'åˆåŒæ—¥æœŸ',
  `first_consign_dt` date default null comment 'åˆæ¬¡å‘è´§æ—¥æœŸ',
  `last_consign_dt` date default null comment 'æœ€åä¸€æ¬¡å‘è´§æ—¥æœŸ',
  `iquantity_addup` int DEFAULT NULL COMMENT 'ç´¯è®¡å‘è´§æ•°',
  `install_dt`date default null comment 'è£…æœºæ—¶é—´',
  `first_invoice_dt` date default null comment 'åˆæ¬¡å¼€ç¥¨æ—¥æœŸ',
  `first_invoice_price_dt` date default null comment 'åˆæ¬¡å¼€ç¥¨æ—¥æœŸ(å•ä»·å¤§äº0)',
  `last_invoice_dt` date default null comment 'æœ€åä¸€æ¬¡å¼€ç¥¨æ—¥æœŸ',
  `isum_addup` decimal(18,4) DEFAULT NULL COMMENT 'ç´¯è®¡å¼€ç¥¨é‡‘é¢',
  `product_start_dt` date default null comment 'äº§å“å¯ç”¨æ—¥æœŸ',
  `product_end_dt` date default null comment 'äº§å“åœç”¨æ—¥æœŸ',
  `end_date` date default null comment 'ç¡®è®¤ä¸¢å•æ—¥æœŸ',
  `cinvbrand` varchar(60) DEFAULT NULL COMMENT 'å“ç‰Œ',
  `competitor` varchar(20) DEFAULT NULL COMMENT 'æ˜¯å¦ç«äº‰å¯¹æ‰‹',
  `cohr` varchar(20) default null comment 'å…¬å¸ï¼ˆå®¢æˆ·ä¾›åº”å•†ï¼‰'
 ) engine=innodb default charset=utf8 comment 'å®¢æˆ·äº§å“æ¡£æ¡ˆ'
;

20190115151954å¼€å§‹æ‰§è¡Œ2019-01-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151954


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115151954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151954

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115151954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151954

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115151955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151955

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115151956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151956



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115151956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115151956

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152003


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152003
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152009

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152018

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152032

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152032

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152040
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190115152139

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190115152321

20190116020001å¼€å§‹æ‰§è¡Œ2019-01-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020003



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020040

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020040

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020048
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190116020150

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190116020335

20190117020001å¼€å§‹æ‰§è¡Œ2019-01-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020003



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020038

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020039

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020047
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117020148

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117020331

20190117103709å¼€å§‹æ‰§è¡Œ2019-01-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103709


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103709

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103710

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103710

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103711



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103712

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103718


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103719
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103724

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103734
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103734

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103747

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103748
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103748

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103756
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103756
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117103857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117103857

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117104040

20190117173035å¼€å§‹æ‰§è¡Œ2019-01-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173035


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173035

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173036

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173037

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173037



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173038

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173045


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173045
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173051
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173051

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173100
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173100

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173114
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173114

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173114
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173114

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173122
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173122
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190117173224

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190117173409

20190118020001å¼€å§‹æ‰§è¡Œ2019-01-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020038

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020039

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020047
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190118020147

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190118020330

20190119020001å¼€å§‹æ‰§è¡Œ2019-01-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020039

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020040

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020048
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190119020150

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190119020334

20190120020001å¼€å§‹æ‰§è¡Œ2019-01-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020039

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020039

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020047
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190120020147

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190120020332

20190121020001å¼€å§‹æ‰§è¡Œ2019-01-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020003



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020039

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020039

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020047
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190121020147

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190121020330

20190122020001å¼€å§‹æ‰§è¡Œ2019-01-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020002

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020003



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020039

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020039

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020048
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190122020148

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190122020332

20190123020001å¼€å§‹æ‰§è¡Œ2019-01-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020002

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020003



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020038

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020039

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020047
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190123020147

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190123020329

20190124020001å¼€å§‹æ‰§è¡Œ2019-01-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020003



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020016

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020025

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020039

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020039

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020047
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190124020148

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190124020332

20190126020001å¼€å§‹æ‰§è¡Œ2019-01-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020001

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020002

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020008


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020008
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020013

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020021

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020024

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020024

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020029
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020112
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190126020112

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190126020225

20190127020000å¼€å§‹æ‰§è¡Œ2019-01-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020001

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020001



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020002

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020008


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020008
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020013

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020021

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020024

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020024

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020029
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020112
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190127020112

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190127020225

20190128020000å¼€å§‹æ‰§è¡Œ2019-01-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020001

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020002

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020008


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020008
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020013

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020021

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020024

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020024

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020029
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020112
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190128020112

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190128020225

20190129020001å¼€å§‹æ‰§è¡Œ2019-01-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020009
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020014

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020016

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020029

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020029

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020034
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190129020125

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190129020241

20190130020000å¼€å§‹æ‰§è¡Œ2019-01-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020036

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020036

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020044
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020044
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190130020142

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190130020320

20190131020000å¼€å§‹æ‰§è¡Œ2019-01-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020036

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020036

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020044
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020044
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190131020142

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190131020321

20190201020001å¼€å§‹æ‰§è¡Œ2019-01-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020024

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020035

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190201020141

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190201020319

20190202020001å¼€å§‹æ‰§è¡Œ2019-02-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020024

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020035

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190202020141

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190202020320

20190203020000å¼€å§‹æ‰§è¡Œ2019-02-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190203020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190203020319

20190204020000å¼€å§‹æ‰§è¡Œ2019-02-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190204020141

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190204020319

20190205020000å¼€å§‹æ‰§è¡Œ2019-02-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020009
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190205020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190205020318

20190206020000å¼€å§‹æ‰§è¡Œ2019-02-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020009
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190206020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190206020319

20190207020001å¼€å§‹æ‰§è¡Œ2019-02-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020024

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020035

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190207020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190207020319

20190208020000å¼€å§‹æ‰§è¡Œ2019-02-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020035

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190208020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190208020319

20190209020001å¼€å§‹æ‰§è¡Œ2019-02-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020024

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020035

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190209020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190209020319

20190210020001å¼€å§‹æ‰§è¡Œ2019-02-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020010


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190210020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190210020319

20190211020000å¼€å§‹æ‰§è¡Œ2019-02-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190211020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190211020319

20190212020000å¼€å§‹æ‰§è¡Œ2019-02-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020000


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020000

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020010
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020015

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020034

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020042
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190212020140

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190212020318

20190213020001å¼€å§‹æ‰§è¡Œ2019-02-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020001


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020001

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020001

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020002

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020002



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020003

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020009


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020009
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020014

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020033

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020034

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020041
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213020138

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213020316

20190213105814å¼€å§‹æ‰§è¡Œ2019-02-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105814


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105814
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105814

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105814
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105814

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105815
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105815

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105816
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105816



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105816
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105816

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105823
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105823


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105823
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105823
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105828
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105828

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105836
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105836

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105847
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105847

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105848
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105848

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105855
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105855
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213105953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190213105953

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190213110132

20190624154038å¼€å§‹æ‰§è¡Œ2019-06-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154038


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154038

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154039

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154040

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154040



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154041

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154041


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154041
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154048

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154058

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154113
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154113

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154114
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154114

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154125
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624154241

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624154452

20190806093201å¼€å§‹æ‰§è¡Œ2019-08-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093222

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093239

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093239

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093252
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093418
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806093418

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806093645

20190807033201å¼€å§‹æ‰§è¡Œ2019-08-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033222

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033239

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033239

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033251
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033415
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807033415

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807033639

20190808033201å¼€å§‹æ‰§è¡Œ2019-08-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033239

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033252
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033416
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808033416

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808033643

20190809033201å¼€å§‹æ‰§è¡Œ2019-08-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033253
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033416
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809033416

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809033641

20190810033201å¼€å§‹æ‰§è¡Œ2019-08-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033242
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033242

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033243

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033256
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033424
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190810033424

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190810033656

20190811033201å¼€å§‹æ‰§è¡Œ2019-08-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033242
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033242

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033243

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033256
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033424
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190811033424

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190811033657

20190812033201å¼€å§‹æ‰§è¡Œ2019-08-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033214

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033225

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033243

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033243

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033256
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033425
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812033425

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812033703

20190813033201å¼€å§‹æ‰§è¡Œ2019-08-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033253
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033418
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813033418

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813033647

20190814033201å¼€å§‹æ‰§è¡Œ2019-08-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033239

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033252
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033417
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814033417

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814033643

20190815033201å¼€å§‹æ‰§è¡Œ2019-08-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033253
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033417
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815033417

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815033644

20190816033200å¼€å§‹æ‰§è¡Œ2019-08-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033200


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033253
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033417
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816033417

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816033643

20190817033201å¼€å§‹æ‰§è¡Œ2019-08-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033421
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817033421

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817033650

20190818033201å¼€å§‹æ‰§è¡Œ2019-08-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033241

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033242
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033242

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033255
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033255
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033421
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818033421

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818033651

20190819033201å¼€å§‹æ‰§è¡Œ2019-08-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033206
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033241

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033242
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033242

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033255
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033255
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033421
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819033421

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819033651

20190820033201å¼€å§‹æ‰§è¡Œ2019-08-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033214

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033242
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033242

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033242
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033242

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033255
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033255
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033422
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820033422

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820033652

20190821033200å¼€å§‹æ‰§è¡Œ2019-08-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033200


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033200

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033204


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033222

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033253
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033419
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821033419

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821033649

20190822033201å¼€å§‹æ‰§è¡Œ2019-08-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033420
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822033420

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822033650

20190823033201å¼€å§‹æ‰§è¡Œ2019-08-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033421
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823033421

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823033651

20190824033201å¼€å§‹æ‰§è¡Œ2019-08-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033420
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824033420

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824033650

20190825033201å¼€å§‹æ‰§è¡Œ2019-08-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033222

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033239

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033253
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033420
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825033420

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825033652

20190826033201å¼€å§‹æ‰§è¡Œ2019-08-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033420
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826033420

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826033651

20190827033201å¼€å§‹æ‰§è¡Œ2019-08-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033422
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190827033422

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190827033655

20190828033201å¼€å§‹æ‰§è¡Œ2019-08-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033240

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033422
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828033422

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828033655

20190829033201å¼€å§‹æ‰§è¡Œ2019-08-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033223

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033254
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033421
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829033421

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829033654

20190830033201å¼€å§‹æ‰§è¡Œ2019-08-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033206
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033213

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033225

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033242
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033242

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033243

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033257
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033257
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033425
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830033425

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830033703

20190831033201å¼€å§‹æ‰§è¡Œ2019-08-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033241

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033255
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033255
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033422
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831033422

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831033659

20190901033200å¼€å§‹æ‰§è¡Œ2019-08-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033200


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033200

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033204

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033240

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033255
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033255
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033423
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190901033423

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190901033659

20190902033201å¼€å§‹æ‰§è¡Œ2019-09-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,finnal_ccuscode,finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033204



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,true_ccuscode AS ccuscode,true_ccusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.x_cuspro_archives where statecode  = 'å¯ç”¨' GROUP BY true_ccuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.bi_item_name as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select bi_item_code,bi_item_name from edw.dic_item group by bi_item_code) b
    on a.item_code = b.bi_item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033205


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033205
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033212

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,sum(num_person)/3 from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 1 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode
union all
select LEFT(ccuscode,2) as type,
date_format(date_add(ddate,INTERVAL + 2 month),"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033224

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033241

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033241
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033241

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033256
insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,true_ccuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.x_cuspro_archives GROUP BY true_ccuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033422
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902033422

insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902033659

20190903033201å¼€å§‹æ‰§è¡Œ2019-09-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033205



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033230


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033236

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033239

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033256

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033257
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033257

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033316
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033316

CREATE INDEX index_mid4_cuspro_archives_cinvcode ON pdm.mid4_cuspro_archives(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033316
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033316
CREATE INDEX index_mid4_cuspro_archives_ccuscode ON pdm.mid4_cuspro_archives(ccuscode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033317
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033317
CREATE INDEX index_mid4_cuspro_archives_item_code ON pdm.mid4_cuspro_archives(item_code)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033317
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033317
CREATE INDEX index_mid4_cuspro_archives_type ON pdm.mid4_cuspro_archives(type)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033318
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033318
CREATE INDEX index_mid6_cuspro_archives_cinvcode ON pdm.mid6_cuspro_archives(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033318
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033318
CREATE INDEX index_mid6_cuspro_archives_ccuscode ON pdm.mid6_cuspro_archives(ccuscode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033319
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033319
CREATE INDEX index_mid6_cuspro_archives_item_code ON pdm.mid6_cuspro_archives(item_code)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033319
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033319
CREATE INDEX index_mid6_cuspro_archives_type ON pdm.mid6_cuspro_archives(type)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033320
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033320
CREATE INDEX index_mid7_cuspro_archives_cinvcode ON pdm.mid7_cuspro_archives(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033320
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033320
CREATE INDEX index_mid7_cuspro_archives_ccuscode ON pdm.mid7_cuspro_archives(ccuscode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033321
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033321
CREATE INDEX index_mid7_cuspro_archives_item_code ON pdm.mid7_cuspro_archives(item_code)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033321
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033321
CREATE INDEX index_mid7_cuspro_archives_type ON pdm.mid7_cuspro_archives(type)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033322
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033322

insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033724

CREATE INDEX index_mid8_cuspro_archives_cinvcode ON pdm.mid8_cuspro_archives(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033724
CREATE INDEX index_mid8_cuspro_archives_ccuscode ON pdm.mid8_cuspro_archives(ccuscode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033725
CREATE INDEX index_mid8_cuspro_archives_item_code ON pdm.mid8_cuspro_archives(item_code)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033725
CREATE INDEX index_mid8_cuspro_archives_type ON pdm.mid8_cuspro_archives(type)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033726
CREATE INDEX index_outdepot_order_temp_cinvcode ON pdm.outdepot_order_temp(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903033726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903033726
CREATE INDEX index_outdepot_order_temp_ccuscode ON pdm.outdepot_order_temp(ccuscode)
;

20190903085945å¼€å§‹æ‰§è¡Œ2019-09-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903085945


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903085945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903085945

create temporary table pdm.invoice_order_temp as
SELECT LEFT(ccuscode,2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903085946
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903085946

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT(ccuscode,2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT(ccuscode,2),finnal_ccuscode, item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903085947
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903085947

create temporary table pdm.outdepot_order_temp as
SELECT LEFT(ccuscode,2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum ,sum(iquantity) as iquantity_addup
  FROM pdm.outdepot_order 
 GROUP BY LEFT(ccuscode,2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903085948
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903085948



CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903085949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903085949

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090013


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090014
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090020

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT(ccuscode,2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order
where iquantity > 0
group by LEFT(ccuscode,2),yearmonth,finnal_ccuscode,item_code,cinvcode) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090023

create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT(a.ccuscode,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,a.finnal_ccuscode as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on a.finnal_ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT(a.ccuscode,2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by a.finnal_ccuscode,a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090040

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT(ccuscode,2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,finnal_ccuscode AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order 
 where cbustype <> 'LDT'
 GROUP BY 
  LEFT(ccuscode,2),finnal_ccuscode
	       ,item_code
	       ,cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090041

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090100
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090100

CREATE INDEX index_mid4_cuspro_archives_cinvcode ON pdm.mid4_cuspro_archives(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090101
CREATE INDEX index_mid4_cuspro_archives_ccuscode ON pdm.mid4_cuspro_archives(ccuscode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090101
CREATE INDEX index_mid4_cuspro_archives_item_code ON pdm.mid4_cuspro_archives(item_code)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090102
CREATE INDEX index_mid4_cuspro_archives_type ON pdm.mid4_cuspro_archives(type)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090102
CREATE INDEX index_mid6_cuspro_archives_cinvcode ON pdm.mid6_cuspro_archives(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090103
CREATE INDEX index_mid6_cuspro_archives_ccuscode ON pdm.mid6_cuspro_archives(ccuscode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090103
CREATE INDEX index_mid6_cuspro_archives_item_code ON pdm.mid6_cuspro_archives(item_code)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090104
CREATE INDEX index_mid6_cuspro_archives_type ON pdm.mid6_cuspro_archives(type)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090104
CREATE INDEX index_mid7_cuspro_archives_cinvcode ON pdm.mid7_cuspro_archives(cinvcode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090105
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090105
CREATE INDEX index_mid7_cuspro_archives_ccuscode ON pdm.mid7_cuspro_archives(ccuscode)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090105
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090105
CREATE INDEX index_mid7_cuspro_archives_item_code ON pdm.mid7_cuspro_archives(item_code)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090106
CREATE INDEX index_mid7_cuspro_archives_type ON pdm.mid7_cuspro_archives(type)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090106

insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903090508


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.iquantity_addup
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903090743

20190904033201å¼€å§‹æ‰§è¡Œ2019-09-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033204



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033204
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033234

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033235

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033235
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033249

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033249

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033304
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033304


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033408
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904033408


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (a.first_consign_dt > a.install_dt and a.first_consign_dt > a.first_invoice_dt) then a.first_consign_dt
            when (a.install_dt > a.first_consign_dt and a.install_dt > a.first_invoice_dt) then a.install_dt
            else a.first_invoice_dt end as date) as product_start_dt
      ,cast(case when a.last_consign_dt > a.last_invoice_dt then a.last_consign_dt
            else a.last_invoice_dt end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904033603

20190905033201å¼€å§‹æ‰§è¡Œ2019-09-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033204

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033206

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033411
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033411


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033609

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905033609
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905033609

20190906033201å¼€å§‹æ‰§è¡Œ2019-09-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033250

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033411
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033411


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033608

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906033608
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906033608

20190907033201å¼€å§‹æ‰§è¡Œ2019-09-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033204

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033411
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033411


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033609

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907033609
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907033609

20190908033201å¼€å§‹æ‰§è¡Œ2019-09-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033306
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033306


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033412


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033611

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908033611
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908033611

20190909033201å¼€å§‹æ‰§è¡Œ2019-09-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033204



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033204
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033249

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033250

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033410
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033410


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033607

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909033607
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909033607

20190910033201å¼€å§‹æ‰§è¡Œ2019-09-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033235

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033235
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033250

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033410
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033410


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033609

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910033609
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910033609

20190911033201å¼€å§‹æ‰§è¡Œ2019-09-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033250

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033411
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033411


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033610

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911033610
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911033610

20190912033201å¼€å§‹æ‰§è¡Œ2019-09-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033250

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033411
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033411


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033610

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912033610
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912033610

20190913033201å¼€å§‹æ‰§è¡Œ2019-09-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033204

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033206

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033305


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033412


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033612

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913033612
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913033612

20190914033201å¼€å§‹æ‰§è¡Œ2019-09-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033251

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033306
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033306


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033414


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033614
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033614

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033614
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914033614
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914033614

20190915033200å¼€å§‹æ‰§è¡Œ2019-09-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033200


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033236

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033251

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033306
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033306


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033414


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033615

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915033615
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915033615

20190916033201å¼€å§‹æ‰§è¡Œ2019-09-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033230


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033236

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033251

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033306
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033306


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033414


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033615

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916033615
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916033615

20190917033201å¼€å§‹æ‰§è¡Œ2019-09-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033306
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033306


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033412


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033613

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917033613
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917033613

20190918033201å¼€å§‹æ‰§è¡Œ2019-09-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033204

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033230


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033236

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033237

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033237
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033251

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033252

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033307
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033307


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033416
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033416


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033617

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918033617
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918033617

20190919033201å¼€å§‹æ‰§è¡Œ2019-09-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033229


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033229
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033235

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033236

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033236
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033250

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033251

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033306
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033306


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033413
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033413


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033613

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919033613
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919033613

20190920033200å¼€å§‹æ‰§è¡Œ2019-09-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033204



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033204
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033230


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033236

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033237

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033237
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033251

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033252

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033306
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033306


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033414


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033615

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920033615
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920033615

20190921033201å¼€å§‹æ‰§è¡Œ2019-09-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033230


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033236

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033237

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033237
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033251

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033252

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033307
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033307


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033414


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033615

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921033615
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921033615

20190922033201å¼€å§‹æ‰§è¡Œ2019-09-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033230


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033230
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033236

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033237

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033237
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033251

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033252

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033308
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033308


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033416
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033416


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033618
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033618

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033618
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922033618
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922033618

20190923033201å¼€å§‹æ‰§è¡Œ2019-09-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033204

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033206

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033231


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033231
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033237

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033238

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033238
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033253

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033253

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033309
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033309


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033418
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033418


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033624
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033624

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033624
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923033624
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923033624

20190924033201å¼€å§‹æ‰§è¡Œ2019-09-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033204

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033206

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033231


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033231
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033237

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033238

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033238
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033253

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033254

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033309
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033309


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033419
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033419


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033626
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033626

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033626
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924033626
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924033626

20190925033201å¼€å§‹æ‰§è¡Œ2019-09-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033231


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033231
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033237

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033238

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033238
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033253

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033254

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033310
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033310


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033421
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033421


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033632
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033632

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033632
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925033632
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925033632

20190926033201å¼€å§‹æ‰§è¡Œ2019-09-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033231


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033231
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033237

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033238

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033238
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033253

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033253

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033310
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033310


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033420
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033420


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033627
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033627

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033627
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926033627
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926033627

20190927033201å¼€å§‹æ‰§è¡Œ2019-09-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033231


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033231
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033237

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033238

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033238
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033253

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033253

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033310
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033310


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033420
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033420


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033628
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033628

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033628
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927033628
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927033628

20190928033201å¼€å§‹æ‰§è¡Œ2019-09-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033204

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033206

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033231


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033231
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033237

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033238

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033238
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033253

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033254

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033310
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033310


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033420
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033420


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033628
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033628

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033628
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928033628
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928033628

20190929033201å¼€å§‹æ‰§è¡Œ2019-09-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033201


truncate table pdm.cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033201

create temporary table pdm.invoice_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033202

create temporary table pdm.invoice_order_temp1 as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as ccusname,item_code,cinvcode,cinvname,min(ddate) as ddate ,sum(isum) AS isum 
  FROM pdm.invoice_order 
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(isum) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033203

create temporary table pdm.outdepot_order_temp as
SELECT LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end  as finnal_ccuscode,
                                case when finnal_ccusname = 'multi' then ccusname else finnal_ccusname end  as finnal_ccusname,item_code,cinvcode,cinvname,sum(iquantity) AS isum
  FROM pdm.outdepot_order 
 where finnal_ccuscode <> ''
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2),(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ), item_code, cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033205



drop table if exists pdm.mid1_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033205
CREATE TEMPORARY TABLE pdm.mid1_cuspro_archives AS 
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.invoice_order_temp WHERE isum > 0)
 UNION
( SELECT type,finnal_ccuscode as ccuscode,finnal_ccusname as ccusname, item_code, cinvcode,cinvname FROM pdm.outdepot_order_temp WHERE isum > 0)
UNION
( SELECT 'ZD' as type,bi_cuscode AS ccuscode,bi_cusname as ccusname, item_code, bi_cinvcode AS cinvcode,bi_cinvname as cinvname FROM edw.crm_account_equipments where statecode  = 'å¯ç”¨' GROUP BY bi_cuscode, item_code, bi_cinvcode )
union
( SELECT 'ZD' as type,ccuscode AS ccuscode,ccusname as ccusname, item_code, cinvcode AS cinvcode,cinvname as cinvname FROM edw.x_sales_budget_19 where plan_complete_dt_recount is not null GROUP BY ccuscode, cinvcode, item_code )

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033205

CREATE TEMPORARY TABLE pdm.mid2_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,b.level_three as item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.business_class as cbustype
  from pdm.mid1_cuspro_archives a
  left join (select item_code,level_three from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
  left join edw.map_inventory c
    on a.cinvcode = c.bi_cinvcode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033231


create TEMPORARY TABLE pdm.mid3_cuspro_archives as
select LEFT(ccuscode,2) as type,
       ccuscode as ccuscode,
       cinvcode as cinvcode,
       a.item_code as item_code,
       min(plan_complete_dt_recount) as plan_start_dt
  from edw.x_sales_budget_19 a
 where a.plan_complete_dt_recount > 0
 group by a.ccuscode,a.item_code

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033231
   

CREATE TEMPORARY TABLE pdm.mid4_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,b.plan_start_dt
  from pdm.mid2_cuspro_archives a
  left join pdm.mid3_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.type = b.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033237

CREATE TEMPORARY TABLE pdm.mid5_cuspro_archives as
select a.type,a.yearmonth,a.finnal_ccuscode,a.item_code,a.cinvcode,num_person from
(select LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2) as type,
date_format(ddate,"%Y-%m-%d") as `yearmonth`
,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ) as finnal_ccuscode
,item_code
,cinvcode
,count(*) as `num_person`
from pdm.outdepot_order 
where iquantity > 0
 GROUP BY LEFT((case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end ),2)
         ,(case when finnal_ccuscode = 'multi' then ccuscode else finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0) a
group by a.type,a.finnal_ccuscode,a.item_code,a.cinvcode,a.yearmonth
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033238

drop table if exists pdm.mid6_cuspro_archives
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033238
create TEMPORARY table pdm.mid6_cuspro_archives as
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) ,2) as type
      ,min(a.ddate) as mindate
      ,max(a.ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) as ccuscode
      ,a.item_code
      ,a.cinvcode
  from pdm.invoice_order a
  left join pdm.invoice_order_temp b
    on (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) = b.finnal_ccuscode
   and a.item_code = b.item_code
   and LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)  = b.type
   and a.cinvcode = b.cinvcode
 where b.finnal_ccuscode is not null
 group by (case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),a.item_code,a.cinvcode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033253

create TEMPORARY table pdm.mid7_cuspro_archives as 
select LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2) as type
      ,min(ddate) as mindate
      ,max(ddate) as maxdate
      ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ) AS ccuscode
      ,item_code
      ,cinvcode
  FROM pdm.outdepot_order  a
 where cbustype <> 'LDT'
   and finnal_ccuscode <> ''
 GROUP BY LEFT((case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end ),2)
         ,(case when a.finnal_ccuscode = 'multi' then a.ccuscode else a.finnal_ccuscode end )
	       ,item_code
	       ,cinvcode
 having sum(iquantity) > 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033254
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033254

create TEMPORARY table pdm.mid8_cuspro_archives as 
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mon1 as date) as first_consign_dt
      ,CAST(b.mon2 as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date)  as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join (select type,min(yearmonth) as mon1,max(yearmonth) as mon2,finnal_ccuscode,item_code,cinvcode from pdm.mid5_cuspro_archives group by finnal_ccuscode,item_code,cinvcode) b
    on a.ccuscode = b.finnal_ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype = 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033310
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033310


insert into pdm.mid8_cuspro_archives
select a.type
      ,a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,a.cbustype
      ,a.plan_start_dt
      ,CAST(b.mindate as date) as first_consign_dt
      ,CAST(b.maxdate as date) as last_consign_dt
      ,CAST(d.mon as date) as install_dt
      ,CAST(c.mindate as date) as first_invoice_dt
      ,CAST(c.maxdate as date) as last_invoice_dt
  from pdm.mid4_cuspro_archives a
  left join pdm.mid7_cuspro_archives b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
   and a.cinvcode = b.cinvcode
   and a.type = b.type
  left join pdm.mid6_cuspro_archives c
    on a.ccuscode = c.ccuscode
   and a.item_code = c.item_code
   and a.cinvcode = c.cinvcode
   and a.type = c.type
  left join (select 'ZD' as type,bi_cuscode AS ccuscode, item_code, bi_cinvcode AS cinvcode,min(new_installation_date) as mon FROM edw.crm_account_equipments GROUP BY bi_cuscode, item_code, bi_cinvcode) d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
 where a.cbustype <> 'LDT'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033419
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033419


insert into pdm.cuspro_archives
select a.ccuscode
      ,a.ccusname
      ,a.item_code
      ,a.item_name
      ,a.cinvcode
      ,a.cinvname
      ,c.equipment
      ,case when a.type = 'GR' then 'ä¸ªäººé”€å”®'
            when a.type = 'ZD' then 'ç»ˆç«¯é”€å”®'
            when a.type = 'DL' then 'ä»£ç†é”€å”®'
            else 'å…¶ä»–' end
      ,a.cbustype
      ,a.plan_start_dt
      ,null
      ,null
      ,a.first_consign_dt
      ,a.last_consign_dt
      ,e.isum
      ,a.install_dt
      ,a.first_invoice_dt
      ,d.ddate
      ,a.last_invoice_dt
      ,d.isum
      ,cast(case when (ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.install_dt,'1900-01-01') and ifnull(a.first_consign_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.first_consign_dt,'1900-01-01')
            when (ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_consign_dt,'1900-01-01') and ifnull(a.install_dt,'1900-01-01') > ifnull(a.first_invoice_dt,'1900-01-01')) then ifnull(a.install_dt,'1900-01-01')
            else ifnull(a.first_invoice_dt,'1900-01-01') end as date) as product_start_dt
      ,cast(case when ifnull(a.last_consign_dt,'1900-01-01') > ifnull(a.last_invoice_dt,'1900-01-01') then ifnull(a.last_consign_dt,'1900-01-01')
            else ifnull(a.last_invoice_dt,'1900-01-01') end as date) as product_end_dt
      ,null
      ,b.cinvbrand
      ,'å¦'
      ,'åšåœ£å…¬å¸'
  from pdm.mid8_cuspro_archives a
  left join (select bi_cinvcode,cinvbrand from edw.map_inventory group by bi_cinvcode)  b
    on a.cinvcode = b.bi_cinvcode
  left join edw.map_item c
    on a.item_code = c.item_code
  left join pdm.invoice_order_temp1 d
    on a.ccuscode = d.ccuscode
   and a.item_code = d.item_code
   and a.cinvcode = d.cinvcode
   and a.type = d.type
  left join pdm.outdepot_order_temp e
    on a.ccuscode = e.finnal_ccuscode
   and a.item_code = e.item_code
   and a.cinvcode = e.cinvcode
   and a.type = e.type

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033626
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033626

update pdm.cuspro_archives
   set product_start_dt = null
 where product_start_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033626
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929033626
update pdm.cuspro_archives
   set product_end_dt = null
 where product_end_dt = '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929033626
