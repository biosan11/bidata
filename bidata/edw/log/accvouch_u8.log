
20181210170715å¼€å§‹æ‰§è¡Œ1900-01-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20181210170715


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,case when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 0 then cdepfullname
            when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 1 then CONCAT('/',cdepfullname)
            when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 2 then CONCAT('//',cdepfullname)
            when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 3 then CONCAT('///',cdepfullname)
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20181210170715
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20181210170715

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '1900-01-01'

;

20181210170814å¼€å§‹æ‰§è¡Œ1900-01-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20181210170814


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,case when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 0 then cdepfullname
            when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 1 then CONCAT('/',cdepfullname)
            when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 2 then CONCAT('//',cdepfullname)
            when (LENGTH(cdepfullname) - LENGTH( REPLACE(cdepfullname,'/',''))) = 3 then CONCAT('///',cdepfullname)
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20181210170814
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20181210170814

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '1900-01-01'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20181210170819
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20181210170819

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20181210170819
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20181210170819


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.sales_region
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20181210170823

20190308100447å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308100447
/*
CREATE TABLE `accvouch_u8` (
  `db` varchar(20) DEFAULT NULL COMMENT 'À´Ô´ÏµÍ³',
  `i_id` int(11) DEFAULT NULL COMMENT '×Ô¶¯±àºÅ',
  `liuchengbh` varchar(100) DEFAULT NULL COMMENT 'Á÷³Ì±àºÅ',
  `iyear` int(11) DEFAULT NULL COMMENT 'Äê·İ',
  `iperiod` int(11) DEFAULT NULL COMMENT 'ÔÂ·İ',
  `dbill_date` datetime DEFAULT NULL COMMENT 'ÈÕÆÚ',
  `voucher_id` varchar(60) DEFAULT NULL COMMENT 'Æ¾Ö¤±àÂë',
  `ccode` varchar(40) DEFAULT NULL COMMENT '¿ÆÄ¿£¨Æ¾Ö¤ÖĞÄ©¼¶¿ÆÄ¿£©',
  `ccode_name` varchar(100) DEFAULT NULL COMMENT '¿ÆÄ¿Ãû³Æ£¨Æ¾Ö¤ÖĞÄ©¼¶¿ÆÄ¿£©',
  `ccode_lv2` varchar(40) DEFAULT NULL COMMENT 'U8¶ş¼¶¿ÆÄ¿',
  `ccode_name_lv2` varchar(100) DEFAULT NULL COMMENT 'U8¶ş¼¶¿ÆÄ¿Ãû³Æ',
  `cdept_id` varchar(12) DEFAULT NULL COMMENT '²¿ÃÅ±àÂë',
  `cdepname` varchar(255) DEFAULT NULL COMMENT '²¿ÃÅÃû³Æ',
  `cdepname_lv1` text COMMENT '¶ÔÓ¦µÄU8Ò»¼¶²¿ÃÅ',
  `cdepname_lv2` text COMMENT '¶ÔÓ¦µÄU8¶ş¼¶²¿ÃÅ',
  `cdepname_lv3` text COMMENT '¶ÔÓ¦µÄU8Èı¼¶²¿ÃÅ',
  `cdepname_lv4` text COMMENT '¶ÔÓ¦µÄU8ËÄ¼¶²¿ÃÅ',
  `cperson_id` varchar(20) DEFAULT NULL COMMENT 'Ö°Ô±±àÂë',
  `cpersonname` varchar(40) DEFAULT NULL COMMENT 'Ö°Ô±Ãû³Æ',
  `sales_region` varchar(20) DEFAULT NULL COMMENT 'µØÇø',
  `ccus_id` varchar(20) DEFAULT NULL COMMENT '¿Í»§±àºÅ',
  `bi_cuscode` varchar(20) DEFAULT NULL COMMENT 'bi¿Í»§±àºÅ',
  `bi_cusname` varchar(120) DEFAULT NULL COMMENT 'bi¿Í»§Ãû³Æ',
  `cdigest` varchar(120) DEFAULT NULL COMMENT 'bi¿Í»§Ãû³Æ',
  `mc` decimal(19,4) DEFAULT NULL COMMENT '½ğ¶î1',
  `mc` decimal(19,4) DEFAULT NULL COMMENT '½ğ¶î2',
  `sys_time` datetime DEFAULT NULL COMMENT 'Ê±¼ä´Á',
  KEY `index_accvouch_u8_db` (`db`),
  KEY `index_accvouch_u8_i_id` (`i_id`),
  KEY `index_accvouch_u8_i_cdigest` (`cdigest`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='u8Æ¾Ö¤ÕûºÏ±í'
;

20190308125345å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308125345
/*
CREATE TABLE `accvouch_u8` (
  `db` varchar(20) DEFAULT NULL COMMENT 'À´Ô´ÏµÍ³',
  `i_id` int(11) DEFAULT NULL COMMENT '×Ô¶¯±àºÅ',
  `liuchengbh` varchar(100) DEFAULT NULL COMMENT 'Á÷³Ì±àºÅ',
  `iyear` int(11) DEFAULT NULL COMMENT 'Äê·İ',
  `iperiod` int(11) DEFAULT NULL COMMENT 'ÔÂ·İ',
  `dbill_date` datetime DEFAULT NULL COMMENT 'ÈÕÆÚ',
  `voucher_id` varchar(60) DEFAULT NULL COMMENT 'Æ¾Ö¤±àÂë',
  `ccode` varchar(40) DEFAULT NULL COMMENT '¿ÆÄ¿£¨Æ¾Ö¤ÖĞÄ©¼¶¿ÆÄ¿£©',
  `ccode_name` varchar(100) DEFAULT NULL COMMENT '¿ÆÄ¿Ãû³Æ£¨Æ¾Ö¤ÖĞÄ©¼¶¿ÆÄ¿£©',
  `ccode_lv2` varchar(40) DEFAULT NULL COMMENT 'U8¶ş¼¶¿ÆÄ¿',
  `ccode_name_lv2` varchar(100) DEFAULT NULL COMMENT 'U8¶ş¼¶¿ÆÄ¿Ãû³Æ',
  `cdept_id` varchar(12) DEFAULT NULL COMMENT '²¿ÃÅ±àÂë',
  `cdepname` varchar(255) DEFAULT NULL COMMENT '²¿ÃÅÃû³Æ',
  `cdepname_lv1` text COMMENT '¶ÔÓ¦µÄU8Ò»¼¶²¿ÃÅ',
  `cdepname_lv2` text COMMENT '¶ÔÓ¦µÄU8¶ş¼¶²¿ÃÅ',
  `cdepname_lv3` text COMMENT '¶ÔÓ¦µÄU8Èı¼¶²¿ÃÅ',
  `cdepname_lv4` text COMMENT '¶ÔÓ¦µÄU8ËÄ¼¶²¿ÃÅ',
  `cperson_id` varchar(20) DEFAULT NULL COMMENT 'Ö°Ô±±àÂë',
  `cpersonname` varchar(40) DEFAULT NULL COMMENT 'Ö°Ô±Ãû³Æ',
  `sales_region` varchar(20) DEFAULT NULL COMMENT 'µØÇø',
  `ccus_id` varchar(20) DEFAULT NULL COMMENT '¿Í»§±àºÅ',
  `bi_cuscode` varchar(20) DEFAULT NULL COMMENT 'bi¿Í»§±àºÅ',
  `bi_cusname` varchar(120) DEFAULT NULL COMMENT 'bi¿Í»§Ãû³Æ',
  `cdigest` varchar(120) DEFAULT NULL COMMENT 'bi¿Í»§Ãû³Æ',
  `mc` decimal(19,4) DEFAULT NULL COMMENT '½ğ¶î1',
  `mc` decimal(19,4) DEFAULT NULL COMMENT '½ğ¶î2',
  `sys_time` datetime DEFAULT NULL COMMENT 'Ê±¼ä´Á',
  KEY `index_accvouch_u8_db` (`db`),
  KEY `index_accvouch_u8_i_id` (`i_id`),
  KEY `index_accvouch_u8_i_cdigest` (`cdigest`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='u8Æ¾Ö¤ÕûºÏ±í'
;

20190308125724å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308125724


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308125724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308125724

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-07'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308125724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308125724

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308125724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308125724


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308125725

20190315001510å¼€å§‹æ‰§è¡Œ2019-03-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001510


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001510

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-14'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001511

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001511


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001511

20190316001503å¼€å§‹æ‰§è¡Œ2019-03-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001503


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001503

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-15'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001504

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001504


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001504

20190317001502å¼€å§‹æ‰§è¡Œ2019-03-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001502


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001502

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-16'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001503

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001503


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001503

20190318001503å¼€å§‹æ‰§è¡Œ2019-03-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001503


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-17'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001504

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001504


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001504

20190319001502å¼€å§‹æ‰§è¡Œ2019-03-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001502


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001502

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-18'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001503

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001503


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001503

20190320001500å¼€å§‹æ‰§è¡Œ2019-03-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001500


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001500
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001500

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-19'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001501
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001501

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001501
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001501


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001501

20190321001503å¼€å§‹æ‰§è¡Œ2019-03-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001503


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001503

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-20'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001504

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001504


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001504

20190322112625å¼€å§‹æ‰§è¡Œ2019-03-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112625


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112625
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112625

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-21'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112626
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112626

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112626
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112626


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112626

20190323001504å¼€å§‹æ‰§è¡Œ2019-03-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-22'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001505

20190324001510å¼€å§‹æ‰§è¡Œ2019-03-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001510


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001510

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-23'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001511

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001511


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001511

20190325001504å¼€å§‹æ‰§è¡Œ2019-03-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-24'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001504

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001504


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001504

20190326001502å¼€å§‹æ‰§è¡Œ2019-03-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001502


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001502

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-25'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001503

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001503


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001503

20190327001505å¼€å§‹æ‰§è¡Œ2019-03-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001505


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001505

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-26'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001506

20190328001502å¼€å§‹æ‰§è¡Œ2019-03-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001502


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001502

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-27'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001503

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001503


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001503

20190329001501å¼€å§‹æ‰§è¡Œ2019-03-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001501


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001501
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001501

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-28'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001501
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001501

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001501
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001501


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001502

20190330001502å¼€å§‹æ‰§è¡Œ2019-03-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001502


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001502

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-29'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001503

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001503


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001503

20190331001503å¼€å§‹æ‰§è¡Œ2019-03-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001503


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001503

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-30'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001503

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001503


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001503

20190401001506å¼€å§‹æ‰§è¡Œ2019-03-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001506


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001506

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-03-31'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001506

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001506


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001506

20190402001504å¼€å§‹æ‰§è¡Œ2019-04-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-01'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001505

20190403001509å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001509


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001509

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-02'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001510

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001510


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001510

20190404135108å¼€å§‹æ‰§è¡Œ2019-04-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135108


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135108
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135108

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-03'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135109

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135109


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135109

20190405001508å¼€å§‹æ‰§è¡Œ2019-04-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001508


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001509

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-04'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001509

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001509


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001509

20190406001506å¼€å§‹æ‰§è¡Œ2019-04-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001506


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001506

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-05'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001507

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001507


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001507

20190407001514å¼€å§‹æ‰§è¡Œ2019-04-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001514


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001514

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-06'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001515

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001515


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001515

20190408001506å¼€å§‹æ‰§è¡Œ2019-04-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001506


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001506

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-07'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001507

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001507


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001507

20190409001507å¼€å§‹æ‰§è¡Œ2019-04-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001507


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001507

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-08'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001508

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001508


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001508

20190410001506å¼€å§‹æ‰§è¡Œ2019-04-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001506


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001506

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-09'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001507

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001507


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001507

20190411001512å¼€å§‹æ‰§è¡Œ2019-04-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001512


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001512

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-10'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001513

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001513


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001513

20190412001514å¼€å§‹æ‰§è¡Œ2019-04-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001514


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001514

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-11'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001515

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001515


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001515

20190413001511å¼€å§‹æ‰§è¡Œ2019-04-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001511


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001511

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-12'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001511

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001511


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001511

20190414001519å¼€å§‹æ‰§è¡Œ2019-04-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001519


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001519

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-13'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001520

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001520


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001520

20190415001504å¼€å§‹æ‰§è¡Œ2019-04-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-14'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001505

20190416001504å¼€å§‹æ‰§è¡Œ2019-04-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-15'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001505

20190417001507å¼€å§‹æ‰§è¡Œ2019-04-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001507


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001507

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-16'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001508

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001508


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001508

20190418001504å¼€å§‹æ‰§è¡Œ2019-04-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-17'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001505

20190419001502å¼€å§‹æ‰§è¡Œ2019-04-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001502


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001502

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-18'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001502

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001502


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001502

20190420001511å¼€å§‹æ‰§è¡Œ2019-04-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001511


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001511

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-19'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001512

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001512


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001512

20190421001510å¼€å§‹æ‰§è¡Œ2019-04-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001510


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001510

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-20'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001511

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001511


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001511

20190422001506å¼€å§‹æ‰§è¡Œ2019-04-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001506


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001506

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-21'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001506

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001506


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001506

20190423001509å¼€å§‹æ‰§è¡Œ2019-04-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001509


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001509

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-22'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001510

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001510


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001510

20190424001504å¼€å§‹æ‰§è¡Œ2019-04-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-23'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001505

20190425001503å¼€å§‹æ‰§è¡Œ2019-04-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001503


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001503

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-24'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001504

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001504


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001504

20190426001507å¼€å§‹æ‰§è¡Œ2019-04-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001507


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001507

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-25'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001508

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001508


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001508

20190427001513å¼€å§‹æ‰§è¡Œ2019-04-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001513


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001513

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-26'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001514

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001514


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001514

20190429091409å¼€å§‹æ‰§è¡Œ2019-04-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091409


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091409
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091409

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-28'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091410
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091410

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091410
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091410


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091410

20190430001510å¼€å§‹æ‰§è¡Œ2019-04-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001510


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001510

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-29'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001511

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001511


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001511

20190501001513å¼€å§‹æ‰§è¡Œ2019-04-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001513


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001513

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-04-30'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001514

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001514


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001514

20190502001516å¼€å§‹æ‰§è¡Œ2019-05-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001516


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001516

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-05-01'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001517

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001517


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001517

20190503001508å¼€å§‹æ‰§è¡Œ2019-05-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001508


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001508
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001508

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-05-02'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001509

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001509


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001509

20190504001512å¼€å§‹æ‰§è¡Œ2019-05-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001512


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001512

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-05-03'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001513

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001513


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001513

20190505001504å¼€å§‹æ‰§è¡Œ2019-05-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-05-04'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001505

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001505


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001505

20190506001500å¼€å§‹æ‰§è¡Œ2019-05-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001500


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001500
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001500

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-05-05'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001501
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001501

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001501
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001501


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001501

20190507001506å¼€å§‹æ‰§è¡Œ2019-05-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001506


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001506

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where left(a.dbill_date,10) >= '2019-05-06'
   and a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001507

delete a
  from edw.accvouch_u8 a
  join edw.accvouch_u8_pre b
    on a.db = b.db
   and a.i_id = b.i_id
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001507


insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001507

20190508001504å¼€å§‹æ‰§è¡Œ2019-05-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001504


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001504

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001512


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001512
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001521

20190509174309å¼€å§‹æ‰§è¡Œ2019-05-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174309


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174309
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174309

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174315
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174315


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174315
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174315
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174322

20190510001548å¼€å§‹æ‰§è¡Œ2019-05-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001548


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001548

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001555
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001555


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001555
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001555
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001602

20190511001550å¼€å§‹æ‰§è¡Œ2019-05-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001550


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001550

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001556
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001556


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001556
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001556
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001603

20190512001545å¼€å§‹æ‰§è¡Œ2019-05-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001545


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001545
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001545

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001552
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001552


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001552
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001552
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001559

20190513001542å¼€å§‹æ‰§è¡Œ2019-05-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001542


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001542
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001542

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001549
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001549


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001549
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001549
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001556

20190514001549å¼€å§‹æ‰§è¡Œ2019-05-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001549


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001549
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001549

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001556
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001556


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001556
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001556
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001603

20190515001552å¼€å§‹æ‰§è¡Œ2019-05-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001552


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001552
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001552

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001559
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001559


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001559
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001559
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001607

20190516001555å¼€å§‹æ‰§è¡Œ2019-05-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001555


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001555
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001555

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001602
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001602


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001602
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001602
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001609

20190517001606å¼€å§‹æ‰§è¡Œ2019-05-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001606


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001606
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001606

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001613


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001613
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001620

20190518001600å¼€å§‹æ‰§è¡Œ2019-05-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001600


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001600
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001600

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001607


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001607
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001614

20190519001600å¼€å§‹æ‰§è¡Œ2019-05-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001600


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001600
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001600

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001607


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001607
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001614

20190520001601å¼€å§‹æ‰§è¡Œ2019-05-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001601


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001601
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001601

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001608


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001608
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001615

20190521001605å¼€å§‹æ‰§è¡Œ2019-05-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001605


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001605
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001605

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001612


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001612
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001620

20190522001606å¼€å§‹æ‰§è¡Œ2019-05-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001606


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001606
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001606

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001612


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001613
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001620

20190523001600å¼€å§‹æ‰§è¡Œ2019-05-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001600


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001600
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001600

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001607


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001607
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001614

20190524001554å¼€å§‹æ‰§è¡Œ2019-05-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001554


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001554
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001554

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001601
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001601


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001602
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001602
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001609

20190525001558å¼€å§‹æ‰§è¡Œ2019-05-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001558


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001558
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001558

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001605
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001605


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001605
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001605
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001612

20190526001558å¼€å§‹æ‰§è¡Œ2019-05-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001558


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001558
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001558

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001605
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001605


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001605
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001605
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001612

20190527001601å¼€å§‹æ‰§è¡Œ2019-05-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001601


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001601
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001601

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname from ufdata.person group by cpersoncode) d
    on a.cperson_id = d.cpersoncode
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001608


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001608
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001615

20190528001601å¼€å§‹æ‰§è¡Œ2019-05-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001601


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001601
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001601

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001608


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001608
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001616

20190529001630å¼€å§‹æ‰§è¡Œ2019-05-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529001630


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529001630
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529001630

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529001638
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529001638


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529001638
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529001638
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529001645

20190530001607å¼€å§‹æ‰§è¡Œ2019-05-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001607


create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001607

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001614
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001614


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001614
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001614
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001622

20190531001609å¼€å§‹æ‰§è¡Œ2019-05-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531001609


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531001609

insert into edw.code values('640110','ÈËÔ±³É±¾')
;

20190531093514å¼€å§‹æ‰§è¡Œ2019-05-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531093514


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531093514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531093514

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531093514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531093514

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531093514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531093514

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531093520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531093520


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531093521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531093521
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531093527

20190601001608å¼€å§‹æ‰§è¡Œ2019-05-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001608


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001608

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001608

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001608

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001615


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001615
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001615
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001623

20190602001614å¼€å§‹æ‰§è¡Œ2019-06-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001614


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001614
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001614

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001614
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001614

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001614
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001614

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001622
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001622


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001622
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001622
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001629

20190603001613å¼€å§‹æ‰§è¡Œ2019-06-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001613


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001613

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001613

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001613

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001620
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001620


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001620
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001620
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001628

20190604001609å¼€å§‹æ‰§è¡Œ2019-06-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001609


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001609

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001609

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001609

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001617


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001617
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001624

20190605001611å¼€å§‹æ‰§è¡Œ2019-06-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001611


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001611

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001611

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001611

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001618
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001618


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001618
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001618
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001626

20190606001623å¼€å§‹æ‰§è¡Œ2019-06-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001623


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001623
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001623

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001623
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001623

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001623
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001623

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001631


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001631
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001638

20190607001600å¼€å§‹æ‰§è¡Œ2019-06-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001600


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001600
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001600

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001600
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001600

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001600
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001600

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001607
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001607


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001608
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001615

20190608001609å¼€å§‹æ‰§è¡Œ2019-06-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001609


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001609

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001609

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001609

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001617


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001617
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001624

20190610084641å¼€å§‹æ‰§è¡Œ2019-06-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610084641


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610084641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610084641

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610084641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610084641

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610084641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610084641

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610084648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610084648


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610084648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610084648
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610084656

20190611001609å¼€å§‹æ‰§è¡Œ2019-06-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001609


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001609

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001609

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001609
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001609

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001617


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001617
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001617
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001624

20190612001611å¼€å§‹æ‰§è¡Œ2019-06-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001611


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001611

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001611

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001611

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001619
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001619


truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001619
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001619
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001626

20190613001608å¼€å§‹æ‰§è¡Œ2019-06-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001608


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001608

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001608

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001608

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001616
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001616

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001616
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001616



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001616
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001616
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001624

20190614001629å¼€å§‹æ‰§è¡Œ2019-06-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614001629


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614001629
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614001629

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614001629
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614001629

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614001629
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614001629

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614001636

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614001637



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614001637
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614001645

20190615001637å¼€å§‹æ‰§è¡Œ2019-06-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615001637


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615001637

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615001637

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615001637

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615001645

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615001645



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615001645
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615001653

20190616001633å¼€å§‹æ‰§è¡Œ2019-06-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616001633


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616001633

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616001633

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616001633

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616001641

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616001642



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616001642
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616001649

20190617001638å¼€å§‹æ‰§è¡Œ2019-06-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617001638


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617001638
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617001638

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617001638
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617001638

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617001638
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617001638

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617001646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617001646

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617001647
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617001647



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617001647
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617001647
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617001655

20190618001632å¼€å§‹æ‰§è¡Œ2019-06-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618001632


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618001632
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618001632

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618001632
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618001632

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618001632
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618001632

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618001640

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618001641



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618001641
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618001648

20190619001637å¼€å§‹æ‰§è¡Œ2019-06-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619001637


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619001637

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619001637

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619001637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619001637

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619001645

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619001645



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619001645
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619001653

20190620001633å¼€å§‹æ‰§è¡Œ2019-06-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620001633


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620001633

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620001633

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620001633

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620001641

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620001642



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620001642
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620001650

20190621001646å¼€å§‹æ‰§è¡Œ2019-06-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621001646


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621001646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621001646

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621001646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621001646

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621001646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621001646

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621001654

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621001654



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621001654
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621001702

20190622001634å¼€å§‹æ‰§è¡Œ2019-06-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622001634


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622001634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622001634

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622001634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622001634

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622001634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622001634

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622001642

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622001643



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622001643
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622001651

20190623001634å¼€å§‹æ‰§è¡Œ2019-06-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623001634


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623001634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623001634

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623001634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623001634

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623001634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623001634

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623001642

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623001643



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623001643
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623001650

20190624091131å¼€å§‹æ‰§è¡Œ2019-06-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091131


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091131

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091131

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091131

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091139

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091139



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091139
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091147

20190625001634å¼€å§‹æ‰§è¡Œ2019-06-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625001634


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625001635

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625001635

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625001635

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625001643

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625001643



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625001643
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625001651

20190626144915å¼€å§‹æ‰§è¡Œ2019-06-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626144915


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626144915
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626144915

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626144915
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626144915

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626144915
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626144915

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626144923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626144923

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626144923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626144923



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626144923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626144923
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626144931

20190627001635å¼€å§‹æ‰§è¡Œ2019-06-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627001635


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627001635

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627001635

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627001635

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627001643

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627001644



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627001644
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627001652

20190628001656å¼€å§‹æ‰§è¡Œ2019-06-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628001656


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628001656
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628001656

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628001656
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628001656

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628001656
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628001656

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628001704
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628001704

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628001705



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628001705
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628001713

20190629001643å¼€å§‹æ‰§è¡Œ2019-06-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190629001643


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190629001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190629001643

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190629001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190629001643

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190629001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190629001643

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190629001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190629001651

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190629001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190629001652



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190629001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190629001652
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190629001700

20190702092022å¼€å§‹æ‰§è¡Œ2019-07-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092022


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092022

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092022

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092022

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092030

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092031



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092031
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092039

20190703001635å¼€å§‹æ‰§è¡Œ2019-07-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703001635


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703001635

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703001635

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703001635

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703001644

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703001645



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703001645
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703001654

20190704001635å¼€å§‹æ‰§è¡Œ2019-07-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704001635


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704001635

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704001635

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704001636

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704001644

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704001645



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704001645
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704001655

20190705001654å¼€å§‹æ‰§è¡Œ2019-07-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705001654


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705001654

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705001654

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705001654

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705001703
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705001703

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705001704
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705001704



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705001704
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705001704
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705001712

20190706001658å¼€å§‹æ‰§è¡Œ2019-07-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706001658


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706001658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706001658

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706001658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706001658

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706001658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706001658

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706001707

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706001707



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706001708
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706001717

20190707001700å¼€å§‹æ‰§è¡Œ2019-07-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707001700


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707001700

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707001700

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707001700

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707001709

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707001710



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707001710
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707001719

20190708001712å¼€å§‹æ‰§è¡Œ2019-07-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708001712


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708001712

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708001712

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708001712

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708001721

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708001721



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708001721
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708001730

20190709001659å¼€å§‹æ‰§è¡Œ2019-07-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709001659


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709001659
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709001659

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709001659
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709001659

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709001659
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709001659

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709001708

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709001709



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709001709
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709001718

20190710001701å¼€å§‹æ‰§è¡Œ2019-07-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710001701


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710001701

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710001701

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710001701

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710001710

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710001710



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710001710
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710001719

20190711001700å¼€å§‹æ‰§è¡Œ2019-07-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711001700


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711001700

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711001700

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711001700

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711001710

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711001710



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711001710
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711001721

20190712001720å¼€å§‹æ‰§è¡Œ2019-07-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712001720


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712001720

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712001720

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712001720

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712001729

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712001729



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712001729
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712001738

20190715090506å¼€å§‹æ‰§è¡Œ2019-07-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715090506


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715090506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715090506

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715090506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715090506

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715090506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715090506

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715090514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715090514

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715090515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715090515



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715090515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715090515
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715090523

20190716003817å¼€å§‹æ‰§è¡Œ2019-07-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716003817


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716003817
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716003817

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716003817
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716003817

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716003817
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716003817

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716003825
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716003825

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716003826
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716003826



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716003826
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716003826
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716003834

20190717001657å¼€å§‹æ‰§è¡Œ2019-07-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717001657


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717001657

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717001657

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717001657

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717001706

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717001706



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717001706
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717001716

20190718001718å¼€å§‹æ‰§è¡Œ2019-07-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718001718


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718001718

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718001718

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718001718

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718001728

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718001728



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718001728
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718001737

20190719001701å¼€å§‹æ‰§è¡Œ2019-07-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719001701


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719001701

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719001701

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719001701

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719001710

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719001710



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719001711
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719001721

20190720001631å¼€å§‹æ‰§è¡Œ2019-07-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720001631


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720001631

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720001631

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720001631

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720001640

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720001640



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720001640
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720001649

20190721001631å¼€å§‹æ‰§è¡Œ2019-07-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721001631


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721001631

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721001631

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721001631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721001631

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721001640

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721001641



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721001641
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721001650

20190722001633å¼€å§‹æ‰§è¡Œ2019-07-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722001633


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722001633

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722001633

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722001633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722001633

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722001643

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722001643



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722001643
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722001652

20190723001636å¼€å§‹æ‰§è¡Œ2019-07-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723001636


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723001636

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723001636

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723001636

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723001644

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723001645



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723001645
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723001645
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723001654

20190724001649å¼€å§‹æ‰§è¡Œ2019-07-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724001649


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724001649

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724001649

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724001649

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724001658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724001658

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724001658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724001658



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724001658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724001658
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724001709

20190725001639å¼€å§‹æ‰§è¡Œ2019-07-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725001639


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725001640

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725001640

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725001640

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select cdepcode,cdepname,cdepfullname from edw.department_pre group by cdepcode) c
    on a.cdept_id = c.cdepcode
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725001650

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725001650



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725001651
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725001701

20190726001635å¼€å§‹æ‰§è¡Œ2019-07-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001635


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001635

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001635

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001635

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001652

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001652



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001652
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)) as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001701

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001701

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001701

20190727001651å¼€å§‹æ‰§è¡Œ2019-07-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001651


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001651

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001651

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001651

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001707

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001708



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001708
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001718

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001718

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001718

20190728001644å¼€å§‹æ‰§è¡Œ2019-07-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001644


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001644

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001644

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001644
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001644

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001701

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001702



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001702
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001711

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001711

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001711

20190729001643å¼€å§‹æ‰§è¡Œ2019-07-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001643


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001643

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001643

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001643

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001701

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001702



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001702
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001710

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001710

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001710

20190730001706å¼€å§‹æ‰§è¡Œ2019-07-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001706


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001706

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001706

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001706

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001722

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001723



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001723
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001733
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001733

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001733
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730001733

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730001733

20190731001706å¼€å§‹æ‰§è¡Œ2019-07-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001706


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001706

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001706

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001706

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001724

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001725



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001725
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001734
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001734

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001734
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731001734

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731001734

20190801001648å¼€å§‹æ‰§è¡Œ2019-07-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001648


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001648

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001648

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001648

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001705

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001706



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001706
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001716

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001716

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001716

20190802001702å¼€å§‹æ‰§è¡Œ2019-08-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001702


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001702

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001702

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001702

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001719

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001720



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001720
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001729

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001729

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001729

20190803001718å¼€å§‹æ‰§è¡Œ2019-08-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001718


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001718

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001718

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001719

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001737
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001737

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001738



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001738
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001747

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803001747

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803001747

20190804001709å¼€å§‹æ‰§è¡Œ2019-08-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001709


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001709

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001709

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001709

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001727

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001728



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001728
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001737
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001737

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001737
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001737

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804001737

20190805001710å¼€å§‹æ‰§è¡Œ2019-08-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001710


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001710

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001710

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001710

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001728

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001729



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001729
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001738

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805001738

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805001738

20190806001649å¼€å§‹æ‰§è¡Œ2019-08-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001649


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001649

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001649

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001649

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001706

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001707



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001707
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001715
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001715

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001716

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001716

20190807001718å¼€å§‹æ‰§è¡Œ2019-08-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001718


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001718

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001718

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001718

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001737
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001737

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001738



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001738
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001747

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807001747

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807001747

20190808001648å¼€å§‹æ‰§è¡Œ2019-08-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001648


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001648

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001648

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001648

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001706

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001707



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001707
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001715
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001715

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001715
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001715

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001715

20190809001705å¼€å§‹æ‰§è¡Œ2019-08-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001705


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001705

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001705

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001705

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001722

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001722



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001722
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001733
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001733

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001733
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001733

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001733

20190812083932å¼€å§‹æ‰§è¡Œ2019-08-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083932


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083932

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083932

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083932

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083949

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083949



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083949
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083958

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812083958

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812083958

20190813001700å¼€å§‹æ‰§è¡Œ2019-08-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001700


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001700

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001700

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001700

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001719

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001719



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001719
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001730

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001730

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001730

20190814001659å¼€å§‹æ‰§è¡Œ2019-08-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001659


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001659
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001659

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001659
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001659

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001659
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001659

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001717

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001717



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001717
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001728

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001728

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001728

20190815001656å¼€å§‹æ‰§è¡Œ2019-08-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001656


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001657

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001657

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001657

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001714

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001715
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001715



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001715
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001715
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001726

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001726

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001726

20190816001653å¼€å§‹æ‰§è¡Œ2019-08-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001653


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001653

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001653

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001653

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001712

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001713
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001713

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001714



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001714
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001722

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001723


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001723

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001723

20190817001652å¼€å§‹æ‰§è¡Œ2019-08-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001652


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001652

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001652

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001652

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001712

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001713
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001713

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001714



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001714
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001723

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001723


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001723

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001723

20190818001622å¼€å§‹æ‰§è¡Œ2019-08-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001622


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001622
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001622

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001622
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001622

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001622
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001622

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001640

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001641

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001642



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001642
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001642
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001650

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001651


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001651

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001651

20190819001621å¼€å§‹æ‰§è¡Œ2019-08-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001621


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001621
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001621

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001621
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001621

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001621
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001621

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001639
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001639

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001640

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001641



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001641
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001650

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001650


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001650

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001650

20190820001623å¼€å§‹æ‰§è¡Œ2019-08-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001623


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001623
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001623

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001623
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001623

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001623
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001623

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001641

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001643

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001643



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001643
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001643
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001652

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001653


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001653

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001653

20190821001654å¼€å§‹æ‰§è¡Œ2019-08-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001654


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001654

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001654

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001654

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001713
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001713

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001715
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001715

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001716



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001716
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001725

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001725


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821001725

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821001725

20190822001641å¼€å§‹æ‰§è¡Œ2019-08-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001641


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001641

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001641

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001641

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001659
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001659

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001701

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001701



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001702
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001711

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001712


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001712

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001712

20190823001647å¼€å§‹æ‰§è¡Œ2019-08-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001647


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001647
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001647

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001647
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001647

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001648

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001706

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001708

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001709



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001709
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001718

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001718


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001718

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001718

20190824001708å¼€å§‹æ‰§è¡Œ2019-08-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001708


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001708

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001708

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001708

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001726

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001728

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001728



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001728
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001738

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001739


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824001739

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824001739

20190825001701å¼€å§‹æ‰§è¡Œ2019-08-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001701


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001701

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001701

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001701

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001720

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001721

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001722



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001722
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001733
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001733

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001734
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001734


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001734
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825001734

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825001734

20190826001656å¼€å§‹æ‰§è¡Œ2019-08-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001656


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001657

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001657

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001657

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001716

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001717

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001718



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001718
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001729

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001730


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826001730

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826001730

20190828085017å¼€å§‹æ‰§è¡Œ2019-08-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085017


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085017

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085017

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085017

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085035

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085036

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085037



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085037
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085045

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085046


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085046

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085046

20190829001701å¼€å§‹æ‰§è¡Œ2019-08-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001701


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001701

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001701

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001701
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001701

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001720

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001722

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001723



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001723
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001733
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001733

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001735
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001735


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001735
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829001735

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829001735

20190830001707å¼€å§‹æ‰§è¡Œ2019-08-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001707


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001707

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001707

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001707

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001725

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001727

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001728



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001728
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001738

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001739


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830001739

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830001739

20190831001636å¼€å§‹æ‰§è¡Œ2019-08-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001636


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001636

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001636

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001636

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001653

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001654

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001655
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001655



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001655
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001655
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001706
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001706

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001707


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001707

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001707

20190902094336å¼€å§‹æ‰§è¡Œ2019-09-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094336


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094336

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094336

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094336

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094353
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094353

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094354
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094354

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094355
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094355



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094355
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094355
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094404
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094404

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094405
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094405


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094405
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094405

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094405

20190903001651å¼€å§‹æ‰§è¡Œ2019-09-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001651


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001651

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001651

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001651

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001708

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001710

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001711



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001711
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001721

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001723


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903001723

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903001723

20190904104507å¼€å§‹æ‰§è¡Œ2019-09-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104507


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104507

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104507

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104507

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104522

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104523

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104523



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104523
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104532

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104533
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104533


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104533
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904104533

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904104533

20190905001650å¼€å§‹æ‰§è¡Œ2019-09-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001650


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001650

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001650

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001650

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001708

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001710

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001711



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001711
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001721

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001722


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905001723

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905001723

20190906001651å¼€å§‹æ‰§è¡Œ2019-09-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001651


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001651

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001651

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001651

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001710

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001711
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001711

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001712



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001712
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001723

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001725


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906001725

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906001725

20190907001705å¼€å§‹æ‰§è¡Œ2019-09-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001705


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001705

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001705

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001705

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001725

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001727

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001728



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001728
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001738

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001738


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907001738

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907001738

20190908001705å¼€å§‹æ‰§è¡Œ2019-09-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001705


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001705

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001705

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001705

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001724

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001727

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001727



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001728
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001737
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001737

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001738


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908001738

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908001738

20190909001655å¼€å§‹æ‰§è¡Œ2019-09-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001655


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001656
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001656

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001656
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001656

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001656
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001656

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001714

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001716

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001717



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001717
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001727

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001729


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909001729

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909001729

20190910001648å¼€å§‹æ‰§è¡Œ2019-09-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001648


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001648

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001648

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001648

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001707

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001709

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001709



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001710
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001721

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001722


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001722
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910001722

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910001722

20190911001648å¼€å§‹æ‰§è¡Œ2019-09-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001648


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001648

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001648

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001648

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001707

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001708

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001709



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001709
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001720

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001721


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911001721

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911001721

20190912001657å¼€å§‹æ‰§è¡Œ2019-09-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001657


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001657

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001657

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001658

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001716
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001716

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001718

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001718



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001719
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001731

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001732
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001732


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001732
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912001732

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912001732

20190913001707å¼€å§‹æ‰§è¡Œ2019-09-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001707


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001707

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001707

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001707

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001728

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001730

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001731



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001731
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001740

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001741
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001741


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001741
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913001741

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913001741

20190914001754å¼€å§‹æ‰§è¡Œ2019-09-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001754


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001754

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001754

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001754

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001813
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001813

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001814
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001814

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001815
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001815



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001815
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001815
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001824
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001824

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001825
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001825


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001825
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914001825

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914001825

20190915001649å¼€å§‹æ‰§è¡Œ2019-09-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001649


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001649

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001649

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001649

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001707

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001709
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001709

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001710



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001710
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001710
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001719

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001720


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001720
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915001720

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915001720

20190916001653å¼€å§‹æ‰§è¡Œ2019-09-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001653


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001653

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001653

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001653

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001712
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001712

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001713
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001713

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001714



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001714
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001714
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001723
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001723

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001724


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001724
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916001724

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916001724

20190917001719å¼€å§‹æ‰§è¡Œ2019-09-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001719


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001719

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001719

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001719

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001739

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001740

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001741
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001741



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001741
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001741
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001753
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001753

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001754


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917001754

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917001754

20190918001725å¼€å§‹æ‰§è¡Œ2019-09-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001725


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001725

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001725

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001725

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001745
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001745

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001747

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001747



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001748
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001748
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001759
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001759

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001800
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001800


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001800
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918001800

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918001800

20190919001717å¼€å§‹æ‰§è¡Œ2019-09-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001717


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001717

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001717
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001717

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001718
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001718

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001738

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001739

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001740



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001740
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001752
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001752

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001753
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001753


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001753
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919001753

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919001753

20190920001730å¼€å§‹æ‰§è¡Œ2019-09-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001730


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001731

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001731

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001731

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001751
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001751

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001753
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001753

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001754



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001754
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001805
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001805

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001807
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001807


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001807
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920001807

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920001807

20190921001721å¼€å§‹æ‰§è¡Œ2019-09-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001721


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001721

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001721

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001721
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001721

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001741
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001741

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001743
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001743

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001743
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001743



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001744
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001744
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001755
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001755

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001757
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001757


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001757
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921001757

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921001757

20190922001727å¼€å§‹æ‰§è¡Œ2019-09-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001727


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001727

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001727

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001727
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001727

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001747

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001749
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001749

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001750
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001750



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001750
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001750
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001801
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001801

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001803
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001803


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001803
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922001803

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922001803

20190923001813å¼€å§‹æ‰§è¡Œ2019-09-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001813


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001813
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001813

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001813
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001813

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001813
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001813

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001832
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001832

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001833
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001833

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001834
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001834



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001834
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001834
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001844
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001844

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001845
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001845


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001845
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923001845

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923001845

20190924001728å¼€å§‹æ‰§è¡Œ2019-09-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001728


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001728

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001728

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001728

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001749
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001749

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001751
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001751

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001752
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001752



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001752
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001752
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001802
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001802

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001803
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001803


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001803
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924001803

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924001803

20190925090423å¼€å§‹æ‰§è¡Œ2019-09-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090423


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090423
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090423

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090423
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090423

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090423
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090423

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090442
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090442

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090443
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090443

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090444
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090444



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090445
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090445
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090454
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090454

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090455
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090455


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090455
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090455

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090455

20190926001730å¼€å§‹æ‰§è¡Œ2019-09-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001730


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001730

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001730

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001731

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001751
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001751

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001753
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001753

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001754



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001754
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001754
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001805
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001805

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001807
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001807


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001807
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926001807

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926001807

20190927093726å¼€å§‹æ‰§è¡Œ2019-09-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093726


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093726

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093726

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093726

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093744
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093744

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093746
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093746

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093746
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093746



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093747
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093747
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093757
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093757

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093758
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093758


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093758
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927093758

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927093758

20190928001725å¼€å§‹æ‰§è¡Œ2019-09-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001725


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001725

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001725
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001725

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001726
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001726

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001744
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001744

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001746
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001746

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001748
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001748



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001748
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001748
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001758
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001758

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001800
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001800


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001800
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928001800

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928001800

20190929001719å¼€å§‹æ‰§è¡Œ2019-09-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001719


create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001719

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001719

create temporary table edw.department_pre as
select cdepcode
      ,cdepname
      ,db
      ,idepgrade
      ,case when idepgrade=  4 then cdepfullname
            when idepgrade=  3 then CONCAT(cdepfullname,'/')
            when idepgrade=  2 then CONCAT(cdepfullname,'//')
            when idepgrade=  1 then CONCAT(cdepfullname,'///')
            end as  cdepfullname
  from ufdata.department
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001719
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001719

create temporary table edw.accvouch_u8_pre as
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db <> 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001737
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001737

insert into edw.accvouch_u8_pre
select a.db
      ,a.i_id
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,case when char_length(a.ino_id) = 1 then CONCAT(a.csign,'-000',a.ino_id) 
            when char_length(a.ino_id) = 2 then CONCAT(a.csign,'-00',a.ino_id) 
            when char_length(a.ino_id) = 3 then CONCAT(a.csign,'-0',a.ino_id) 
            else CONCAT(a.csign,'-',a.ino_id)
            end as voucher_id
      ,a.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,c.cdepname
      ,substring_index(substring_index(c.cdepfullname, '/', 1) , '/', -1) as cdepname_lv1
      ,substring_index(substring_index(c.cdepfullname, '/', 2) , '/', -1) as cdepname_lv2
      ,substring_index(substring_index(c.cdepfullname, '/', 3) , '/', -1) as cdepname_lv3
      ,substring_index(substring_index(c.cdepfullname, '/', 4) , '/', -1) as cdepname_lv4
      ,a.cperson_id
      ,d.cpersonname
      ,a.ccus_id
      ,e.bi_cuscode
      ,e.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.ibook
      ,a.csign
      ,localtimestamp() as sys_time
  from ufdata.gl_accvouch a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on a.ccode = b.ccode
  left join (select * from edw.department_pre group by cdepcode,db) c
    on a.cdept_id = c.cdepcode
   and left(a.db,10) = left(c.db,10)
  left join (select cpersoncode,cpersonname,db from ufdata.person group by cpersoncode,left(db,10)) d
    on a.cperson_id = d.cpersoncode
   and left(a.db,10) = left(d.db,10)
  left join (select ccuscode,bi_cuscode,bi_cusname from edw.dic_customer group by ccuscode) e
    on a.ccus_id = e.ccuscode
 where a.iflag is null
   and a.db = 'UFDATA_007_2019'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001739

delete from edw.accvouch_u8_pre where ibook = '0' and csign = 'è®°'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001740



truncate table edw.accvouch_u8
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001740
insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from edw.code group by ccode) b
    on SUBSTRING(a.ccode,1,6) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db <> 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001752
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001752

insert into edw.accvouch_u8
select a.db
      ,a.i_id
      ,case when a.cdigest like '%BS-BSFK%' then left(CONCAT(RIGHT(SUBSTRING_INDEX(a.cdigest,'-',1),2),'-',SUBSTRING_INDEX(a.cdigest,'-',-2)),20)
            else a.cdigest end as liuchengbh
      ,a.iyear
      ,a.iperiod
      ,a.dbill_date
      ,a.voucher_id
      ,a.ccode
      ,a.ccode_name
      ,b.ccode
      ,b.ccode_name
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cperson_id
      ,a.cpersonname
      ,c.province
      ,a.ccus_id
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.cdigest
      ,a.mc
      ,a.md
      ,a.sys_time
  from edw.accvouch_u8_pre a
  left join (select ccode,ccode_name from ufdata.code group by ccode) b
    on SUBSTRING(a.ccode,1,8) = b.ccode
  left join (select bi_cuscode,sales_region,province from edw.map_customer group by bi_cuscode) c
    on a.bi_cuscode = c.bi_cuscode
 where a.db = 'UFDATA_007_2019'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001753
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001753


update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'æ‹›å¾…è´¹BS-BSFK-201904241249'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and mc = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001753
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929001753

update edw.accvouch_u8
   set liuchengbh = 'BS-BSFK-201904241249'
      ,cdigest = 'ç‹å½©ç´æŠ¥é”€BS-BSFK-201904010061'
 where liuchengbh = 'BS-BSFK-201904010061'
   and db = 'UFDATA_666_2018'
   and md = '0'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929001753
