
20190308125357开始执行2019-03-07数据加载日志:
SQL开始执行时间：20190308125357
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190308125357
SQL开始执行时间：20190308125357


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190308125358
SQL开始执行时间：20190308125358

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190308125358
SQL开始执行时间：20190308125358
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190308125404
SQL开始执行时间：20190308125404

delete FROM `oa_budget_19` where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;

20190308125828开始执行2019-03-07数据加载日志:
SQL开始执行时间：20190308125828
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190308125828
SQL开始执行时间：20190308125828

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190308125829
SQL开始执行时间：20190308125829





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190308125829
SQL开始执行时间：20190308125829


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190308125829
SQL开始执行时间：20190308125829

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190308125829
SQL开始执行时间：20190308125829
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190308125835
SQL开始执行时间：20190308125835

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190308125836
SQL开始执行时间：20190308125836

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190308125836
SQL开始执行时间：20190308125836

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190308125836
SQL开始执行时间：20190308125836

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190308125836
SQL开始执行时间：20190308125836

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190308125836
SQL开始执行时间：20190308125836

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190308125836
SQL开始执行时间：20190308125836
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190308125837

20190315001510开始执行2019-03-14数据加载日志:
SQL开始执行时间：20190315001510
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190315001510
SQL开始执行时间：20190315001510
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190315001511
SQL开始执行时间：20190315001511


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190315001512
SQL开始执行时间：20190315001512

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190315001512
SQL开始执行时间：20190315001512
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190315001518
SQL开始执行时间：20190315001518

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190315001519
SQL开始执行时间：20190315001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190315001519
SQL开始执行时间：20190315001519

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190315001519
SQL开始执行时间：20190315001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190315001519
SQL开始执行时间：20190315001519

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190315001519
SQL开始执行时间：20190315001519

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190315001520
SQL开始执行时间：20190315001520
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190315001520

20190316001503开始执行2019-03-15数据加载日志:
SQL开始执行时间：20190316001503
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190316001503
SQL开始执行时间：20190316001503
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190316001503
SQL开始执行时间：20190316001503



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190316001503
SQL开始执行时间：20190316001503
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190316001503
SQL开始执行时间：20190316001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190316001503
SQL开始执行时间：20190316001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190316001504
SQL开始执行时间：20190316001504
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190316001510
SQL开始执行时间：20190316001510



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190316001511
SQL开始执行时间：20190316001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190316001512
SQL开始执行时间：20190316001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190316001512
SQL开始执行时间：20190316001512

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190316001512
SQL开始执行时间：20190316001512

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190316001512
SQL开始执行时间：20190316001512
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190316001512

20190317001502开始执行2019-03-16数据加载日志:
SQL开始执行时间：20190317001502
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190317001502
SQL开始执行时间：20190317001502
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190317001503
SQL开始执行时间：20190317001503
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190317001509
SQL开始执行时间：20190317001509

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190317001510
SQL开始执行时间：20190317001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190317001510
SQL开始执行时间：20190317001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190317001511
SQL开始执行时间：20190317001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190317001511
SQL开始执行时间：20190317001511

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190317001511
SQL开始执行时间：20190317001511

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190317001511
SQL开始执行时间：20190317001511
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190317001511

20190318001503开始执行2019-03-17数据加载日志:
SQL开始执行时间：20190318001503
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190318001503
SQL开始执行时间：20190318001503
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190318001504
SQL开始执行时间：20190318001504


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190318001505
SQL开始执行时间：20190318001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190318001505
SQL开始执行时间：20190318001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190318001511
SQL开始执行时间：20190318001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190318001512
SQL开始执行时间：20190318001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190318001512
SQL开始执行时间：20190318001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190318001513
SQL开始执行时间：20190318001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190318001513
SQL开始执行时间：20190318001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190318001513
SQL开始执行时间：20190318001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190318001513
SQL开始执行时间：20190318001513
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190318001513

20190319001502开始执行2019-03-18数据加载日志:
SQL开始执行时间：20190319001502
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190319001502
SQL开始执行时间：20190319001502
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190319001503
SQL开始执行时间：20190319001503
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190319001504
SQL开始执行时间：20190319001504


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190319001505
SQL开始执行时间：20190319001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190319001505
SQL开始执行时间：20190319001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190319001511
SQL开始执行时间：20190319001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190319001512
SQL开始执行时间：20190319001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190319001512
SQL开始执行时间：20190319001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190319001513
SQL开始执行时间：20190319001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190319001513
SQL开始执行时间：20190319001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190319001513
SQL开始执行时间：20190319001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190319001513
SQL开始执行时间：20190319001513
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190319001513

20190320001500开始执行2019-03-19数据加载日志:
SQL开始执行时间：20190320001500
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190320001500
SQL开始执行时间：20190320001500
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190320001501
SQL开始执行时间：20190320001501


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190320001502
SQL开始执行时间：20190320001502

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190320001502
SQL开始执行时间：20190320001502
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190320001508
SQL开始执行时间：20190320001508

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190320001509
SQL开始执行时间：20190320001509

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190320001509
SQL开始执行时间：20190320001509

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190320001509
SQL开始执行时间：20190320001509

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190320001509
SQL开始执行时间：20190320001509

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190320001509
SQL开始执行时间：20190320001509
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190320001509

20190321001503开始执行2019-03-20数据加载日志:
SQL开始执行时间：20190321001503
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190321001503
SQL开始执行时间：20190321001503
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190321001504
SQL开始执行时间：20190321001504
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190321001510
SQL开始执行时间：20190321001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190321001511
SQL开始执行时间：20190321001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190321001511
SQL开始执行时间：20190321001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190321001511
SQL开始执行时间：20190321001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190321001511
SQL开始执行时间：20190321001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190321001512
SQL开始执行时间：20190321001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190321001512
SQL开始执行时间：20190321001512

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190321001512
SQL开始执行时间：20190321001512

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190321001512
SQL开始执行时间：20190321001512
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190321001512

20190322112625开始执行2019-03-21数据加载日志:
SQL开始执行时间：20190322112625
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190322112625
SQL开始执行时间：20190322112625
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190322112626
SQL开始执行时间：20190322112626
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190322112632
SQL开始执行时间：20190322112632

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190322112633
SQL开始执行时间：20190322112633

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190322112633
SQL开始执行时间：20190322112633

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190322112634
SQL开始执行时间：20190322112634

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190322112634
SQL开始执行时间：20190322112634

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190322112634
SQL开始执行时间：20190322112634

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190322112634
SQL开始执行时间：20190322112634
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190322112634

20190323001504开始执行2019-03-22数据加载日志:
SQL开始执行时间：20190323001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190323001504
SQL开始执行时间：20190323001504



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190323001505
SQL开始执行时间：20190323001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190323001511
SQL开始执行时间：20190323001511

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190323001512
SQL开始执行时间：20190323001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190323001512
SQL开始执行时间：20190323001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190323001512
SQL开始执行时间：20190323001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190323001512
SQL开始执行时间：20190323001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190323001512
SQL开始执行时间：20190323001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190323001512
SQL开始执行时间：20190323001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190323001513
SQL开始执行时间：20190323001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190323001513
SQL开始执行时间：20190323001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190323001513
SQL开始执行时间：20190323001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190323001513
SQL开始执行时间：20190323001513
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190323001513

20190324001510开始执行2019-03-23数据加载日志:
SQL开始执行时间：20190324001510
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190324001510
SQL开始执行时间：20190324001510


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190324001511
SQL开始执行时间：20190324001511

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190324001511
SQL开始执行时间：20190324001511
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190324001517
SQL开始执行时间：20190324001517

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190324001518
SQL开始执行时间：20190324001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190324001518
SQL开始执行时间：20190324001518

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190324001518
SQL开始执行时间：20190324001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190324001518
SQL开始执行时间：20190324001518

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190324001519
SQL开始执行时间：20190324001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190324001519
SQL开始执行时间：20190324001519

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190324001519
SQL开始执行时间：20190324001519

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190324001519
SQL开始执行时间：20190324001519
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190324001519

20190325001504开始执行2019-03-24数据加载日志:
SQL开始执行时间：20190325001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190325001504
SQL开始执行时间：20190325001504





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190325001505
SQL开始执行时间：20190325001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190325001505
SQL开始执行时间：20190325001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190325001505
SQL开始执行时间：20190325001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190325001511
SQL开始执行时间：20190325001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190325001512
SQL开始执行时间：20190325001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190325001512
SQL开始执行时间：20190325001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190325001512
SQL开始执行时间：20190325001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190325001512
SQL开始执行时间：20190325001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190325001513
SQL开始执行时间：20190325001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190325001513
SQL开始执行时间：20190325001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190325001513
SQL开始执行时间：20190325001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190325001513
SQL开始执行时间：20190325001513
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190325001513

20190326001502开始执行2019-03-25数据加载日志:
SQL开始执行时间：20190326001502
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190326001502
SQL开始执行时间：20190326001502
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190326001502
SQL开始执行时间：20190326001502



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190326001502
SQL开始执行时间：20190326001502
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190326001502
SQL开始执行时间：20190326001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190326001502
SQL开始执行时间：20190326001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190326001502
SQL开始执行时间：20190326001502
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190326001503
SQL开始执行时间：20190326001503
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190326001509
SQL开始执行时间：20190326001509



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190326001510
SQL开始执行时间：20190326001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190326001511
SQL开始执行时间：20190326001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190326001511
SQL开始执行时间：20190326001511

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190326001511
SQL开始执行时间：20190326001511

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190326001511
SQL开始执行时间：20190326001511
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190326001511

20190327001505开始执行2019-03-26数据加载日志:
SQL开始执行时间：20190327001505
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190327001505
SQL开始执行时间：20190327001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190327001506
SQL开始执行时间：20190327001506

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190327001506
SQL开始执行时间：20190327001506
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190327001512
SQL开始执行时间：20190327001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190327001513
SQL开始执行时间：20190327001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190327001513
SQL开始执行时间：20190327001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190327001513
SQL开始执行时间：20190327001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190327001513
SQL开始执行时间：20190327001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190327001514
SQL开始执行时间：20190327001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190327001514
SQL开始执行时间：20190327001514

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190327001514
SQL开始执行时间：20190327001514

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190327001514
SQL开始执行时间：20190327001514
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190327001514

20190328001502开始执行2019-03-27数据加载日志:
SQL开始执行时间：20190328001502
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190328001502
SQL开始执行时间：20190328001502



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190328001503
SQL开始执行时间：20190328001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190328001503
SQL开始执行时间：20190328001503
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190328001503
SQL开始执行时间：20190328001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190328001503
SQL开始执行时间：20190328001503





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190328001503
SQL开始执行时间：20190328001503


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190328001503
SQL开始执行时间：20190328001503

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190328001503
SQL开始执行时间：20190328001503
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190328001509
SQL开始执行时间：20190328001509

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190328001510
SQL开始执行时间：20190328001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190328001510
SQL开始执行时间：20190328001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190328001510
SQL开始执行时间：20190328001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190328001510
SQL开始执行时间：20190328001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190328001511
SQL开始执行时间：20190328001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190328001511
SQL开始执行时间：20190328001511

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190328001511
SQL开始执行时间：20190328001511

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190328001511
SQL开始执行时间：20190328001511
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190328001511

20190329001501开始执行2019-03-28数据加载日志:
SQL开始执行时间：20190329001501
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190329001501
SQL开始执行时间：20190329001501


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190329001502
SQL开始执行时间：20190329001502

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190329001502
SQL开始执行时间：20190329001502
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190329001508
SQL开始执行时间：20190329001508

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190329001509
SQL开始执行时间：20190329001509

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190329001509
SQL开始执行时间：20190329001509

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190329001509
SQL开始执行时间：20190329001509

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190329001509
SQL开始执行时间：20190329001509

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190329001510
SQL开始执行时间：20190329001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190329001510
SQL开始执行时间：20190329001510

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190329001510
SQL开始执行时间：20190329001510

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190329001510
SQL开始执行时间：20190329001510
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190329001510

20190330001502开始执行2019-03-29数据加载日志:
SQL开始执行时间：20190330001502
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190330001502
SQL开始执行时间：20190330001502
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190330001503
SQL开始执行时间：20190330001503
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190330001510
SQL开始执行时间：20190330001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190330001511
SQL开始执行时间：20190330001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190330001511
SQL开始执行时间：20190330001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190330001511
SQL开始执行时间：20190330001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190330001511
SQL开始执行时间：20190330001511

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190330001511
SQL开始执行时间：20190330001511

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190330001511
SQL开始执行时间：20190330001511
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190330001511

20190331001503开始执行2019-03-30数据加载日志:
SQL开始执行时间：20190331001503
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190331001503
SQL开始执行时间：20190331001503


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190331001504
SQL开始执行时间：20190331001504

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190331001504
SQL开始执行时间：20190331001504
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190331001510
SQL开始执行时间：20190331001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190331001511
SQL开始执行时间：20190331001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190331001511
SQL开始执行时间：20190331001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190331001512
SQL开始执行时间：20190331001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190331001512
SQL开始执行时间：20190331001512

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190331001512
SQL开始执行时间：20190331001512

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190331001512
SQL开始执行时间：20190331001512
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190331001512

20190401001506开始执行2019-03-31数据加载日志:
SQL开始执行时间：20190401001506
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190401001506
SQL开始执行时间：20190401001506


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190401001507
SQL开始执行时间：20190401001507

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190401001507
SQL开始执行时间：20190401001507
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190401001513
SQL开始执行时间：20190401001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190401001514
SQL开始执行时间：20190401001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190401001514
SQL开始执行时间：20190401001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190401001514
SQL开始执行时间：20190401001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190401001514
SQL开始执行时间：20190401001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190401001515
SQL开始执行时间：20190401001515

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190401001515
SQL开始执行时间：20190401001515

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190401001515
SQL开始执行时间：20190401001515

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190401001515
SQL开始执行时间：20190401001515
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190401001515

20190402001504开始执行2019-04-01数据加载日志:
SQL开始执行时间：20190402001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190402001504
SQL开始执行时间：20190402001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190402001505
SQL开始执行时间：20190402001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190402001512
SQL开始执行时间：20190402001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190402001513
SQL开始执行时间：20190402001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190402001513
SQL开始执行时间：20190402001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190402001513
SQL开始执行时间：20190402001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190402001513
SQL开始执行时间：20190402001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190402001513
SQL开始执行时间：20190402001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190402001514
SQL开始执行时间：20190402001514
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190402001514

20190403001509开始执行2019-04-02数据加载日志:
SQL开始执行时间：20190403001509
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190403001509
SQL开始执行时间：20190403001509
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190403001509
SQL开始执行时间：20190403001509



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190403001509
SQL开始执行时间：20190403001509
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190403001509
SQL开始执行时间：20190403001509

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190403001509
SQL开始执行时间：20190403001509

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190403001509
SQL开始执行时间：20190403001509
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190403001510
SQL开始执行时间：20190403001510
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190403001517
SQL开始执行时间：20190403001517

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190403001518
SQL开始执行时间：20190403001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190403001518
SQL开始执行时间：20190403001518

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190403001518
SQL开始执行时间：20190403001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190403001518
SQL开始执行时间：20190403001518

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190403001518
SQL开始执行时间：20190403001518

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190403001518
SQL开始执行时间：20190403001518
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190403001519

20190404135108开始执行2019-04-03数据加载日志:
SQL开始执行时间：20190404135108
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190404135108
SQL开始执行时间：20190404135108
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190404135109
SQL开始执行时间：20190404135109


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190404135110
SQL开始执行时间：20190404135110

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190404135110
SQL开始执行时间：20190404135110
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190404135116
SQL开始执行时间：20190404135116

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190404135117
SQL开始执行时间：20190404135117

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190404135117
SQL开始执行时间：20190404135117

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190404135118
SQL开始执行时间：20190404135118

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190404135118
SQL开始执行时间：20190404135118

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190404135118
SQL开始执行时间：20190404135118

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190404135118
SQL开始执行时间：20190404135118
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190404135118

20190405001508开始执行2019-04-04数据加载日志:
SQL开始执行时间：20190405001508
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190405001508
SQL开始执行时间：20190405001508
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190405001509
SQL开始执行时间：20190405001509


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190405001510
SQL开始执行时间：20190405001510

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190405001510
SQL开始执行时间：20190405001510
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190405001516
SQL开始执行时间：20190405001516

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190405001517
SQL开始执行时间：20190405001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190405001517
SQL开始执行时间：20190405001517

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190405001517
SQL开始执行时间：20190405001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190405001517
SQL开始执行时间：20190405001517

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190405001518
SQL开始执行时间：20190405001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190405001518
SQL开始执行时间：20190405001518

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190405001518
SQL开始执行时间：20190405001518

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190405001518
SQL开始执行时间：20190405001518
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190405001518

20190406001506开始执行2019-04-05数据加载日志:
SQL开始执行时间：20190406001506
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190406001506
SQL开始执行时间：20190406001506

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190406001507
SQL开始执行时间：20190406001507
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190406001507
SQL开始执行时间：20190406001507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190406001507
SQL开始执行时间：20190406001507





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190406001507
SQL开始执行时间：20190406001507


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190406001507
SQL开始执行时间：20190406001507

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190406001507
SQL开始执行时间：20190406001507
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190406001513
SQL开始执行时间：20190406001513

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190406001514
SQL开始执行时间：20190406001514


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190406001514
SQL开始执行时间：20190406001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190406001514
SQL开始执行时间：20190406001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190406001514
SQL开始执行时间：20190406001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190406001514
SQL开始执行时间：20190406001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190406001514
SQL开始执行时间：20190406001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190406001515
SQL开始执行时间：20190406001515

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190406001515
SQL开始执行时间：20190406001515

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190406001515
SQL开始执行时间：20190406001515

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190406001515
SQL开始执行时间：20190406001515
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190406001515

20190407001514开始执行2019-04-06数据加载日志:
SQL开始执行时间：20190407001514
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190407001514
SQL开始执行时间：20190407001514



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190407001515
SQL开始执行时间：20190407001515
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190407001521
SQL开始执行时间：20190407001521



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190407001522
SQL开始执行时间：20190407001522

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190407001523
SQL开始执行时间：20190407001523

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190407001523
SQL开始执行时间：20190407001523

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190407001523
SQL开始执行时间：20190407001523

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190407001523
SQL开始执行时间：20190407001523
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190407001523

20190408001506开始执行2019-04-07数据加载日志:
SQL开始执行时间：20190408001506
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190408001506
SQL开始执行时间：20190408001506
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190408001507
SQL开始执行时间：20190408001507
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190408001513
SQL开始执行时间：20190408001513



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190408001514
SQL开始执行时间：20190408001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190408001515
SQL开始执行时间：20190408001515

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190408001515
SQL开始执行时间：20190408001515

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190408001515
SQL开始执行时间：20190408001515

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190408001515
SQL开始执行时间：20190408001515
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190408001515

20190409001507开始执行2019-04-08数据加载日志:
SQL开始执行时间：20190409001507
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190409001507
SQL开始执行时间：20190409001507
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190409001508
SQL开始执行时间：20190409001508


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190409001509
SQL开始执行时间：20190409001509

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190409001509
SQL开始执行时间：20190409001509
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190409001515
SQL开始执行时间：20190409001515

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190409001516
SQL开始执行时间：20190409001516

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190409001516
SQL开始执行时间：20190409001516

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190409001516
SQL开始执行时间：20190409001516

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190409001516
SQL开始执行时间：20190409001516

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190409001517
SQL开始执行时间：20190409001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190409001517
SQL开始执行时间：20190409001517

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190409001517
SQL开始执行时间：20190409001517

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190409001517
SQL开始执行时间：20190409001517
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190409001517

20190410001506开始执行2019-04-09数据加载日志:
SQL开始执行时间：20190410001506
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190410001506
SQL开始执行时间：20190410001506
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190410001506
SQL开始执行时间：20190410001506



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190410001506
SQL开始执行时间：20190410001506
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190410001507
SQL开始执行时间：20190410001507
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190410001514
SQL开始执行时间：20190410001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190410001515
SQL开始执行时间：20190410001515

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190410001515
SQL开始执行时间：20190410001515

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190410001515
SQL开始执行时间：20190410001515

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190410001515
SQL开始执行时间：20190410001515

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190410001515
SQL开始执行时间：20190410001515

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190410001515
SQL开始执行时间：20190410001515
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190410001516

20190411001512开始执行2019-04-10数据加载日志:
SQL开始执行时间：20190411001512
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190411001512
SQL开始执行时间：20190411001512
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190411001512
SQL开始执行时间：20190411001512



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190411001512
SQL开始执行时间：20190411001512
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190411001513
SQL开始执行时间：20190411001513
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190411001520
SQL开始执行时间：20190411001520

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190411001521
SQL开始执行时间：20190411001521

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190411001521
SQL开始执行时间：20190411001521

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190411001521
SQL开始执行时间：20190411001521

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190411001521
SQL开始执行时间：20190411001521

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190411001522
SQL开始执行时间：20190411001522

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190411001522
SQL开始执行时间：20190411001522
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190411001522

20190412001514开始执行2019-04-11数据加载日志:
SQL开始执行时间：20190412001514
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190412001514
SQL开始执行时间：20190412001514
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190412001515
SQL开始执行时间：20190412001515
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190412001521
SQL开始执行时间：20190412001521

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190412001522
SQL开始执行时间：20190412001522


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190412001522
SQL开始执行时间：20190412001522

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190412001522
SQL开始执行时间：20190412001522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190412001522
SQL开始执行时间：20190412001522

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190412001522
SQL开始执行时间：20190412001522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190412001522
SQL开始执行时间：20190412001522

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190412001523
SQL开始执行时间：20190412001523

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190412001523
SQL开始执行时间：20190412001523

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190412001523
SQL开始执行时间：20190412001523

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190412001523
SQL开始执行时间：20190412001523
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190412001523

20190413001511开始执行2019-04-12数据加载日志:
SQL开始执行时间：20190413001511
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190413001511
SQL开始执行时间：20190413001511


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190413001512
SQL开始执行时间：20190413001512

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190413001512
SQL开始执行时间：20190413001512
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190413001518
SQL开始执行时间：20190413001518

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190413001519
SQL开始执行时间：20190413001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190413001519
SQL开始执行时间：20190413001519

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190413001519
SQL开始执行时间：20190413001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190413001519
SQL开始执行时间：20190413001519

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190413001520
SQL开始执行时间：20190413001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190413001520
SQL开始执行时间：20190413001520

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190413001520
SQL开始执行时间：20190413001520

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190413001520
SQL开始执行时间：20190413001520
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190413001520

20190414001519开始执行2019-04-13数据加载日志:
SQL开始执行时间：20190414001519
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190414001519
SQL开始执行时间：20190414001519



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190414001520
SQL开始执行时间：20190414001520
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190414001527
SQL开始执行时间：20190414001527

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190414001528
SQL开始执行时间：20190414001528

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190414001528
SQL开始执行时间：20190414001528

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190414001528
SQL开始执行时间：20190414001528

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190414001528
SQL开始执行时间：20190414001528

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190414001528
SQL开始执行时间：20190414001528

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190414001528
SQL开始执行时间：20190414001528
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190414001528

20190415001504开始执行2019-04-14数据加载日志:
SQL开始执行时间：20190415001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190415001504
SQL开始执行时间：20190415001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190415001504
SQL开始执行时间：20190415001504



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190415001504
SQL开始执行时间：20190415001504
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190415001504
SQL开始执行时间：20190415001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190415001504
SQL开始执行时间：20190415001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190415001504
SQL开始执行时间：20190415001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190415001505
SQL开始执行时间：20190415001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190415001512
SQL开始执行时间：20190415001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190415001513
SQL开始执行时间：20190415001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190415001513
SQL开始执行时间：20190415001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190415001513
SQL开始执行时间：20190415001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190415001513
SQL开始执行时间：20190415001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190415001513
SQL开始执行时间：20190415001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190415001513
SQL开始执行时间：20190415001513
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190415001513

20190416001504开始执行2019-04-15数据加载日志:
SQL开始执行时间：20190416001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190416001504
SQL开始执行时间：20190416001504
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190416001505
SQL开始执行时间：20190416001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190416001511
SQL开始执行时间：20190416001511
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190416001512
SQL开始执行时间：20190416001512



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190416001512
SQL开始执行时间：20190416001512

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190416001512
SQL开始执行时间：20190416001512

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190416001512
SQL开始执行时间：20190416001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190416001512
SQL开始执行时间：20190416001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190416001512
SQL开始执行时间：20190416001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190416001512
SQL开始执行时间：20190416001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190416001513
SQL开始执行时间：20190416001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190416001513
SQL开始执行时间：20190416001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190416001513
SQL开始执行时间：20190416001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190416001513
SQL开始执行时间：20190416001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190416001513
SQL开始执行时间：20190416001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190416001514
SQL开始执行时间：20190416001514
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190416001514

20190417001507开始执行2019-04-16数据加载日志:
SQL开始执行时间：20190417001507
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190417001507
SQL开始执行时间：20190417001507
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190417001507
SQL开始执行时间：20190417001507



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190417001507
SQL开始执行时间：20190417001507
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190417001507
SQL开始执行时间：20190417001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190417001507
SQL开始执行时间：20190417001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190417001508
SQL开始执行时间：20190417001508
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190417001515
SQL开始执行时间：20190417001515

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190417001516
SQL开始执行时间：20190417001516

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190417001516
SQL开始执行时间：20190417001516

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190417001517
SQL开始执行时间：20190417001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190417001517
SQL开始执行时间：20190417001517

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190417001517
SQL开始执行时间：20190417001517

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190417001517
SQL开始执行时间：20190417001517
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190417001517

20190418001504开始执行2019-04-17数据加载日志:
SQL开始执行时间：20190418001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190418001504
SQL开始执行时间：20190418001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190418001505
SQL开始执行时间：20190418001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190418001506
SQL开始执行时间：20190418001506

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190418001506
SQL开始执行时间：20190418001506
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190418001512
SQL开始执行时间：20190418001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190418001513
SQL开始执行时间：20190418001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190418001513
SQL开始执行时间：20190418001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190418001513
SQL开始执行时间：20190418001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190418001513
SQL开始执行时间：20190418001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190418001514
SQL开始执行时间：20190418001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190418001514
SQL开始执行时间：20190418001514

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190418001514
SQL开始执行时间：20190418001514

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190418001514
SQL开始执行时间：20190418001514
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190418001514

20190419001502开始执行2019-04-18数据加载日志:
SQL开始执行时间：20190419001502
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190419001502
SQL开始执行时间：20190419001502


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190419001503
SQL开始执行时间：20190419001503

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190419001503
SQL开始执行时间：20190419001503
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190419001509
SQL开始执行时间：20190419001509



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190419001510
SQL开始执行时间：20190419001510

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190419001510
SQL开始执行时间：20190419001510

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190419001510
SQL开始执行时间：20190419001510


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190419001510
SQL开始执行时间：20190419001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190419001510
SQL开始执行时间：20190419001510

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190419001510
SQL开始执行时间：20190419001510

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190419001511
SQL开始执行时间：20190419001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190419001511
SQL开始执行时间：20190419001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190419001511
SQL开始执行时间：20190419001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190419001511
SQL开始执行时间：20190419001511

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190419001511
SQL开始执行时间：20190419001511

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190419001511
SQL开始执行时间：20190419001511
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190419001511

20190420001511开始执行2019-04-19数据加载日志:
SQL开始执行时间：20190420001511
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190420001511
SQL开始执行时间：20190420001511
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190420001512
SQL开始执行时间：20190420001512


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190420001513
SQL开始执行时间：20190420001513

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190420001513
SQL开始执行时间：20190420001513
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190420001519
SQL开始执行时间：20190420001519

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190420001520
SQL开始执行时间：20190420001520


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190420001520
SQL开始执行时间：20190420001520

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190420001520
SQL开始执行时间：20190420001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190420001520
SQL开始执行时间：20190420001520

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190420001520
SQL开始执行时间：20190420001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190420001520
SQL开始执行时间：20190420001520

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190420001521
SQL开始执行时间：20190420001521

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190420001521
SQL开始执行时间：20190420001521

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190420001521
SQL开始执行时间：20190420001521

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190420001521
SQL开始执行时间：20190420001521
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190420001521

20190421001510开始执行2019-04-20数据加载日志:
SQL开始执行时间：20190421001510
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190421001510
SQL开始执行时间：20190421001510
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190421001510
SQL开始执行时间：20190421001510



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190421001510
SQL开始执行时间：20190421001510
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190421001510
SQL开始执行时间：20190421001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190421001510
SQL开始执行时间：20190421001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190421001510
SQL开始执行时间：20190421001510
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190421001511
SQL开始执行时间：20190421001511
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190421001518
SQL开始执行时间：20190421001518

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190421001519
SQL开始执行时间：20190421001519


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190421001519
SQL开始执行时间：20190421001519

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190421001519
SQL开始执行时间：20190421001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190421001519
SQL开始执行时间：20190421001519

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190421001519
SQL开始执行时间：20190421001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190421001519
SQL开始执行时间：20190421001519

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190421001520
SQL开始执行时间：20190421001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190421001520
SQL开始执行时间：20190421001520

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190421001520
SQL开始执行时间：20190421001520

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190421001520
SQL开始执行时间：20190421001520
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190421001520

20190422001506开始执行2019-04-21数据加载日志:
SQL开始执行时间：20190422001506
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190422001506
SQL开始执行时间：20190422001506


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190422001507
SQL开始执行时间：20190422001507

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190422001507
SQL开始执行时间：20190422001507
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190422001513
SQL开始执行时间：20190422001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190422001514
SQL开始执行时间：20190422001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190422001514
SQL开始执行时间：20190422001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190422001514
SQL开始执行时间：20190422001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190422001514
SQL开始执行时间：20190422001514

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190422001515
SQL开始执行时间：20190422001515

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190422001515
SQL开始执行时间：20190422001515

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190422001515
SQL开始执行时间：20190422001515

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190422001515
SQL开始执行时间：20190422001515
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190422001515

20190423001509开始执行2019-04-22数据加载日志:
SQL开始执行时间：20190423001509
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190423001509
SQL开始执行时间：20190423001509
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190423001509
SQL开始执行时间：20190423001509



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190423001509
SQL开始执行时间：20190423001509
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190423001509
SQL开始执行时间：20190423001509

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190423001509
SQL开始执行时间：20190423001509

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190423001509
SQL开始执行时间：20190423001509
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190423001510
SQL开始执行时间：20190423001510
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190423001517
SQL开始执行时间：20190423001517

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190423001518
SQL开始执行时间：20190423001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190423001518
SQL开始执行时间：20190423001518

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190423001519
SQL开始执行时间：20190423001519

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190423001519
SQL开始执行时间：20190423001519

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190423001519
SQL开始执行时间：20190423001519

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190423001519
SQL开始执行时间：20190423001519
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190423001519

20190424001504开始执行2019-04-23数据加载日志:
SQL开始执行时间：20190424001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190424001504
SQL开始执行时间：20190424001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190424001505
SQL开始执行时间：20190424001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190424001512
SQL开始执行时间：20190424001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190424001513
SQL开始执行时间：20190424001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190424001513
SQL开始执行时间：20190424001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190424001513
SQL开始执行时间：20190424001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190424001513
SQL开始执行时间：20190424001513

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190424001514
SQL开始执行时间：20190424001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190424001514
SQL开始执行时间：20190424001514

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190424001514
SQL开始执行时间：20190424001514

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190424001514
SQL开始执行时间：20190424001514
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190424001514

20190425001503开始执行2019-04-24数据加载日志:
SQL开始执行时间：20190425001503
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190425001503
SQL开始执行时间：20190425001503
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190425001503
SQL开始执行时间：20190425001503



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190425001503
SQL开始执行时间：20190425001503
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425001503
SQL开始执行时间：20190425001503

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190425001504
SQL开始执行时间：20190425001504
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511



create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190425001511
SQL开始执行时间：20190425001511

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425001512
SQL开始执行时间：20190425001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190425001512
SQL开始执行时间：20190425001512

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425001513
SQL开始执行时间：20190425001513

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190425001513
SQL开始执行时间：20190425001513

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425001513
SQL开始执行时间：20190425001513

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190425001513
SQL开始执行时间：20190425001513
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr

;
SQL结束执行时间：20190425001513

20190425100524开始执行2019-04-25数据加载日志:
SQL开始执行时间：20190425100524
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190425100524
SQL开始执行时间：20190425100524


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190425100525
SQL开始执行时间：20190425100525

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190425100525
SQL开始执行时间：20190425100525
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190425100531
SQL开始执行时间：20190425100531

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100532
SQL开始执行时间：20190425100532


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190425100532
SQL开始执行时间：20190425100532

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190425100534
SQL开始执行时间：20190425100534
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190425100534

20190425100922开始执行2019-04-25数据加载日志:
SQL开始执行时间：20190425100922
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190425100922
SQL开始执行时间：20190425100922
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190425100923
SQL开始执行时间：20190425100923
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190425100930
SQL开始执行时间：20190425100930

delete FROM edw.oa_budget_19 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100931
SQL开始执行时间：20190425100931


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
and cdepname_lv6 is null

;
SQL结束执行时间：20190425100931
SQL开始执行时间：20190425100931

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933

delete FROM edw.oa_budget_19_11 where CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190425100933
SQL开始执行时间：20190425100933
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190425100933

20190425100939开始执行2019-04-25数据加载日志:
SQL开始执行时间：20190425100939
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190425100939
SQL开始执行时间：20190425100939
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190425100940
SQL开始执行时间：20190425100940
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190425100946
SQL开始执行时间：20190425100946

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425100947
SQL开始执行时间：20190425100947

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190425100947
SQL开始执行时间：20190425100947

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100947
SQL开始执行时间：20190425100947


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190425100947
SQL开始执行时间：20190425100947

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190425100949
SQL开始执行时间：20190425100949
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190425100949

20190426001507开始执行2019-04-25数据加载日志:
SQL开始执行时间：20190426001507
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190426001507
SQL开始执行时间：20190426001507
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190426001508
SQL开始执行时间：20190426001508
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190426001515
SQL开始执行时间：20190426001515

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190426001516
SQL开始执行时间：20190426001516


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190426001516
SQL开始执行时间：20190426001516

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190426001518
SQL开始执行时间：20190426001518
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190426001518

20190427001513开始执行2019-04-26数据加载日志:
SQL开始执行时间：20190427001513
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190427001513
SQL开始执行时间：20190427001513
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190427001513
SQL开始执行时间：20190427001513



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190427001513
SQL开始执行时间：20190427001513
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190427001513
SQL开始执行时间：20190427001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190427001513
SQL开始执行时间：20190427001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190427001514
SQL开始执行时间：20190427001514
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190427001521
SQL开始执行时间：20190427001521

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190427001522
SQL开始执行时间：20190427001522


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190427001522
SQL开始执行时间：20190427001522

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190427001524
SQL开始执行时间：20190427001524
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190427001524

20190429091409开始执行2019-04-28数据加载日志:
SQL开始执行时间：20190429091409
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190429091409
SQL开始执行时间：20190429091409
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190429091409
SQL开始执行时间：20190429091409



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190429091409
SQL开始执行时间：20190429091409
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190429091409
SQL开始执行时间：20190429091409

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190429091409
SQL开始执行时间：20190429091409

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190429091409
SQL开始执行时间：20190429091409
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190429091410
SQL开始执行时间：20190429091410
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190429091417
SQL开始执行时间：20190429091417


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190429091418
SQL开始执行时间：20190429091418

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190429091420
SQL开始执行时间：20190429091420
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190429091420

20190430001510开始执行2019-04-29数据加载日志:
SQL开始执行时间：20190430001510
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190430001510
SQL开始执行时间：20190430001510
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190430001511
SQL开始执行时间：20190430001511

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190430001511
SQL开始执行时间：20190430001511





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190430001511
SQL开始执行时间：20190430001511


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190430001511
SQL开始执行时间：20190430001511

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190430001511
SQL开始执行时间：20190430001511
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190430001517
SQL开始执行时间：20190430001517

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190430001518
SQL开始执行时间：20190430001518

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190430001518
SQL开始执行时间：20190430001518

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190430001518
SQL开始执行时间：20190430001518

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190430001518
SQL开始执行时间：20190430001518


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190430001518
SQL开始执行时间：20190430001518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190430001520
SQL开始执行时间：20190430001520
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190430001520

20190501001513开始执行2019-04-30数据加载日志:
SQL开始执行时间：20190501001513
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190501001513
SQL开始执行时间：20190501001513
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190501001513
SQL开始执行时间：20190501001513



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190501001513
SQL开始执行时间：20190501001513
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190501001513
SQL开始执行时间：20190501001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190501001513
SQL开始执行时间：20190501001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190501001513
SQL开始执行时间：20190501001513
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190501001513
SQL开始执行时间：20190501001513

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190501001514
SQL开始执行时间：20190501001514
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190501001521
SQL开始执行时间：20190501001521


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190501001522
SQL开始执行时间：20190501001522

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190501001524
SQL开始执行时间：20190501001524
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190501001524

20190502001517开始执行2019-05-01数据加载日志:
SQL开始执行时间：20190502001517
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190502001517
SQL开始执行时间：20190502001517


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190502001518
SQL开始执行时间：20190502001518

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190502001518
SQL开始执行时间：20190502001518
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190502001524
SQL开始执行时间：20190502001524

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190502001525
SQL开始执行时间：20190502001525

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190502001525
SQL开始执行时间：20190502001525

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190502001525
SQL开始执行时间：20190502001525


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190502001525
SQL开始执行时间：20190502001525

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190502001527
SQL开始执行时间：20190502001527
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190502001527

20190503001508开始执行2019-05-02数据加载日志:
SQL开始执行时间：20190503001508
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190503001508
SQL开始执行时间：20190503001508
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190503001509
SQL开始执行时间：20190503001509
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190503001515
SQL开始执行时间：20190503001515

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190503001516
SQL开始执行时间：20190503001516

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190503001516
SQL开始执行时间：20190503001516

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190503001516
SQL开始执行时间：20190503001516

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190503001516
SQL开始执行时间：20190503001516


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190503001516
SQL开始执行时间：20190503001516

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190503001518
SQL开始执行时间：20190503001518
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190503001518

20190504001512开始执行2019-05-03数据加载日志:
SQL开始执行时间：20190504001512
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190504001512
SQL开始执行时间：20190504001512



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190504001513
SQL开始执行时间：20190504001513
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190504001520
SQL开始执行时间：20190504001520

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190504001522
SQL开始执行时间：20190504001522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190504001522
SQL开始执行时间：20190504001522

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190504001522
SQL开始执行时间：20190504001522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190504001522
SQL开始执行时间：20190504001522

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190504001522
SQL开始执行时间：20190504001522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190504001522
SQL开始执行时间：20190504001522

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190504001523
SQL开始执行时间：20190504001523

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190504001523
SQL开始执行时间：20190504001523
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190504001523

20190505001504开始执行2019-05-04数据加载日志:
SQL开始执行时间：20190505001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190505001504
SQL开始执行时间：20190505001504



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190505001505
SQL开始执行时间：20190505001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190505001512
SQL开始执行时间：20190505001512

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190505001514
SQL开始执行时间：20190505001514
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190505001515

20190506001500开始执行2019-05-05数据加载日志:
SQL开始执行时间：20190506001500
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190506001500
SQL开始执行时间：20190506001500
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190506001500
SQL开始执行时间：20190506001500



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190506001500
SQL开始执行时间：20190506001500
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190506001500
SQL开始执行时间：20190506001500

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190506001500
SQL开始执行时间：20190506001500

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190506001500
SQL开始执行时间：20190506001500
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190506001501
SQL开始执行时间：20190506001501
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190506001509
SQL开始执行时间：20190506001509

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190506001510
SQL开始执行时间：20190506001510


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190506001510
SQL开始执行时间：20190506001510

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190506001512
SQL开始执行时间：20190506001512
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190506001512

20190507001506开始执行2019-05-06数据加载日志:
SQL开始执行时间：20190507001506
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190507001506
SQL开始执行时间：20190507001506
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190507001506
SQL开始执行时间：20190507001506



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190507001506
SQL开始执行时间：20190507001506
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190507001507
SQL开始执行时间：20190507001507
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190507001515
SQL开始执行时间：20190507001515

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190507001516
SQL开始执行时间：20190507001516

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190507001516
SQL开始执行时间：20190507001516

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190507001516
SQL开始执行时间：20190507001516


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190507001516
SQL开始执行时间：20190507001516

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190507001518
SQL开始执行时间：20190507001518
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190507001518

20190508001504开始执行2019-05-07数据加载日志:
SQL开始执行时间：20190508001504
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190508001504
SQL开始执行时间：20190508001504
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190508001504
SQL开始执行时间：20190508001504



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190508001504
SQL开始执行时间：20190508001504
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190508001504
SQL开始执行时间：20190508001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190508001504
SQL开始执行时间：20190508001504

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190508001504
SQL开始执行时间：20190508001504
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190508001505
SQL开始执行时间：20190508001505
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190508001514
SQL开始执行时间：20190508001514

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190508001515
SQL开始执行时间：20190508001515


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190508001515
SQL开始执行时间：20190508001515

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190508001517
SQL开始执行时间：20190508001517
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190508001517

20190510001548开始执行2019-05-09数据加载日志:
SQL开始执行时间：20190510001548
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190510001548
SQL开始执行时间：20190510001548

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190510001549
SQL开始执行时间：20190510001549
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190510001557
SQL开始执行时间：20190510001557

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190510001558
SQL开始执行时间：20190510001558


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190510001558
SQL开始执行时间：20190510001558

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190510001600
SQL开始执行时间：20190510001600
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190510001600

20190511001550开始执行2019-05-10数据加载日志:
SQL开始执行时间：20190511001550
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190511001550
SQL开始执行时间：20190511001550



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190511001551
SQL开始执行时间：20190511001551

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190511001551
SQL开始执行时间：20190511001551
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190511001551
SQL开始执行时间：20190511001551

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190511001551
SQL开始执行时间：20190511001551





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190511001551
SQL开始执行时间：20190511001551


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190511001551
SQL开始执行时间：20190511001551

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190511001551
SQL开始执行时间：20190511001551
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190511001559
SQL开始执行时间：20190511001559

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190511001600
SQL开始执行时间：20190511001600


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190511001600
SQL开始执行时间：20190511001600

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190511001602
SQL开始执行时间：20190511001602
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190511001602

20190512001545开始执行2019-05-11数据加载日志:
SQL开始执行时间：20190512001545
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190512001545
SQL开始执行时间：20190512001545
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190512001546
SQL开始执行时间：20190512001546


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190512001547
SQL开始执行时间：20190512001547

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190512001547
SQL开始执行时间：20190512001547
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190512001555
SQL开始执行时间：20190512001555

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190512001558
SQL开始执行时间：20190512001558
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190512001558

20190513001542开始执行2019-05-12数据加载日志:
SQL开始执行时间：20190513001542
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190513001542
SQL开始执行时间：20190513001542
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190513001543
SQL开始执行时间：20190513001543


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190513001544
SQL开始执行时间：20190513001544

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190513001544
SQL开始执行时间：20190513001544
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190513001552
SQL开始执行时间：20190513001552


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190513001553
SQL开始执行时间：20190513001553

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190513001555
SQL开始执行时间：20190513001555
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190513001555

20190514001549开始执行2019-05-13数据加载日志:
SQL开始执行时间：20190514001549
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190514001549
SQL开始执行时间：20190514001549
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190514001550
SQL开始执行时间：20190514001550


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190514001551
SQL开始执行时间：20190514001551

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190514001551
SQL开始执行时间：20190514001551
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190514001559
SQL开始执行时间：20190514001559

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190514001602
SQL开始执行时间：20190514001602
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190514001602

20190515001552开始执行2019-05-14数据加载日志:
SQL开始执行时间：20190515001552
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190515001552
SQL开始执行时间：20190515001552

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190515001553
SQL开始执行时间：20190515001553
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190515001553
SQL开始执行时间：20190515001553

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190515001553
SQL开始执行时间：20190515001553





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190515001553
SQL开始执行时间：20190515001553


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190515001553
SQL开始执行时间：20190515001553

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190515001553
SQL开始执行时间：20190515001553
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190515001601
SQL开始执行时间：20190515001601

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190515001602
SQL开始执行时间：20190515001602


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190515001602
SQL开始执行时间：20190515001602

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190515001604
SQL开始执行时间：20190515001604
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190515001604

20190516001555开始执行2019-05-15数据加载日志:
SQL开始执行时间：20190516001555
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190516001555
SQL开始执行时间：20190516001555
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190516001555
SQL开始执行时间：20190516001555



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190516001555
SQL开始执行时间：20190516001555
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190516001556
SQL开始执行时间：20190516001556
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190516001604
SQL开始执行时间：20190516001604

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190516001605
SQL开始执行时间：20190516001605

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190516001605
SQL开始执行时间：20190516001605

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190516001605
SQL开始执行时间：20190516001605

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190516001605
SQL开始执行时间：20190516001605


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190516001605
SQL开始执行时间：20190516001605

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190516001608
SQL开始执行时间：20190516001608
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190516001608

20190517001605开始执行2019-05-16数据加载日志:
SQL开始执行时间：20190517001605
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190517001605
SQL开始执行时间：20190517001605
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190517001606
SQL开始执行时间：20190517001606


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190517001607
SQL开始执行时间：20190517001607

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190517001607
SQL开始执行时间：20190517001607
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190517001615
SQL开始执行时间：20190517001615

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190517001618
SQL开始执行时间：20190517001618
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190517001618

20190518001600开始执行2019-05-17数据加载日志:
SQL开始执行时间：20190518001600
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190518001600
SQL开始执行时间：20190518001600
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190518001600
SQL开始执行时间：20190518001600



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190518001600
SQL开始执行时间：20190518001600
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190518001601
SQL开始执行时间：20190518001601
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190518001609
SQL开始执行时间：20190518001609

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190518001609
SQL开始执行时间：20190518001609
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190518001610
SQL开始执行时间：20190518001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190518001613
SQL开始执行时间：20190518001613
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190518001613

20190519001600开始执行2019-05-18数据加载日志:
SQL开始执行时间：20190519001600
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190519001600
SQL开始执行时间：20190519001600
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190519001601
SQL开始执行时间：20190519001601
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190519001609
SQL开始执行时间：20190519001609

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190519001610
SQL开始执行时间：20190519001610


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190519001610
SQL开始执行时间：20190519001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190519001612
SQL开始执行时间：20190519001612
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190519001612

20190520001601开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520001601
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190520001601
SQL开始执行时间：20190520001601
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190520001602
SQL开始执行时间：20190520001602


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190520001603
SQL开始执行时间：20190520001603

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190520001603
SQL开始执行时间：20190520001603
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190520001611
SQL开始执行时间：20190520001611

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190520001614
SQL开始执行时间：20190520001614
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190520001614

20190521001605开始执行2019-05-20数据加载日志:
SQL开始执行时间：20190521001605
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190521001605
SQL开始执行时间：20190521001605
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190521001605
SQL开始执行时间：20190521001605



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190521001605
SQL开始执行时间：20190521001605
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190521001606
SQL开始执行时间：20190521001606
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190521001615
SQL开始执行时间：20190521001615


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190521001616
SQL开始执行时间：20190521001616

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190521001618
SQL开始执行时间：20190521001618
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190521001618

20190522001605开始执行2019-05-21数据加载日志:
SQL开始执行时间：20190522001605
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190522001605
SQL开始执行时间：20190522001605
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190522001606
SQL开始执行时间：20190522001606


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190522001607
SQL开始执行时间：20190522001607

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190522001607
SQL开始执行时间：20190522001607
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190522001615
SQL开始执行时间：20190522001615

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190522001618
SQL开始执行时间：20190522001618
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190522001618

20190523001600开始执行2019-05-22数据加载日志:
SQL开始执行时间：20190523001600
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190523001600
SQL开始执行时间：20190523001600
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190523001601
SQL开始执行时间：20190523001601


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190523001602
SQL开始执行时间：20190523001602

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190523001602
SQL开始执行时间：20190523001602
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190523001609
SQL开始执行时间：20190523001609
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190523001610
SQL开始执行时间：20190523001610

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190523001610
SQL开始执行时间：20190523001610

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190523001610
SQL开始执行时间：20190523001610

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190523001610
SQL开始执行时间：20190523001610

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190523001610
SQL开始执行时间：20190523001610


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190523001610
SQL开始执行时间：20190523001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190523001613
SQL开始执行时间：20190523001613
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190523001613

20190524001554开始执行2019-05-23数据加载日志:
SQL开始执行时间：20190524001554
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190524001554
SQL开始执行时间：20190524001554
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190524001555
SQL开始执行时间：20190524001555


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190524001556
SQL开始执行时间：20190524001556

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190524001556
SQL开始执行时间：20190524001556
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190524001604
SQL开始执行时间：20190524001604

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190524001607
SQL开始执行时间：20190524001607
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190524001607

20190525001558开始执行2019-05-24数据加载日志:
SQL开始执行时间：20190525001558
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190525001558
SQL开始执行时间：20190525001558
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190525001558
SQL开始执行时间：20190525001558



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190525001558
SQL开始执行时间：20190525001558
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190525001558
SQL开始执行时间：20190525001558

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190525001558
SQL开始执行时间：20190525001558

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190525001558
SQL开始执行时间：20190525001558
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190525001559
SQL开始执行时间：20190525001559
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190525001607
SQL开始执行时间：20190525001607

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190525001607
SQL开始执行时间：20190525001607
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190525001607
SQL开始执行时间：20190525001607
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190525001607
SQL开始执行时间：20190525001607
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190525001607
SQL开始执行时间：20190525001607
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190525001607
SQL开始执行时间：20190525001607
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190525001608
SQL开始执行时间：20190525001608

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190525001610
SQL开始执行时间：20190525001610
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190525001610

20190526001558开始执行2019-05-25数据加载日志:
SQL开始执行时间：20190526001558
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190526001558
SQL开始执行时间：20190526001558
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190526001559
SQL开始执行时间：20190526001559
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190526001607
SQL开始执行时间：20190526001607

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190526001608
SQL开始执行时间：20190526001608

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190526001608
SQL开始执行时间：20190526001608


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190526001608
SQL开始执行时间：20190526001608

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190526001610
SQL开始执行时间：20190526001610
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190526001610

20190527001601开始执行2019-05-26数据加载日志:
SQL开始执行时间：20190527001601
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190527001601
SQL开始执行时间：20190527001601
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190527001602
SQL开始执行时间：20190527001602
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190527001610
SQL开始执行时间：20190527001610

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190527001611
SQL开始执行时间：20190527001611


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190527001611
SQL开始执行时间：20190527001611

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190527001613
SQL开始执行时间：20190527001613
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190527001613

20190528001601开始执行2019-05-27数据加载日志:
SQL开始执行时间：20190528001601
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190528001601
SQL开始执行时间：20190528001601



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190528001602
SQL开始执行时间：20190528001602
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190528001610
SQL开始执行时间：20190528001610

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190528001611
SQL开始执行时间：20190528001611

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190528001611
SQL开始执行时间：20190528001611

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190528001611
SQL开始执行时间：20190528001611


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190528001611
SQL开始执行时间：20190528001611

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190528001613
SQL开始执行时间：20190528001613
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190528001613

20190529001630开始执行2019-05-28数据加载日志:
SQL开始执行时间：20190529001630
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190529001630
SQL开始执行时间：20190529001630
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190529001631
SQL开始执行时间：20190529001631


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190529001632
SQL开始执行时间：20190529001632

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190529001632
SQL开始执行时间：20190529001632
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190529001640
SQL开始执行时间：20190529001640

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190529001641
SQL开始执行时间：20190529001641

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190529001641
SQL开始执行时间：20190529001641

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190529001641
SQL开始执行时间：20190529001641


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190529001641
SQL开始执行时间：20190529001641

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190529001643
SQL开始执行时间：20190529001643
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190529001643

20190530001607开始执行2019-05-29数据加载日志:
SQL开始执行时间：20190530001607
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190530001607
SQL开始执行时间：20190530001607
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190530001607
SQL开始执行时间：20190530001607



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190530001607
SQL开始执行时间：20190530001607
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190530001607
SQL开始执行时间：20190530001607

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190530001607
SQL开始执行时间：20190530001607

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190530001607
SQL开始执行时间：20190530001607
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190530001608
SQL开始执行时间：20190530001608
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,c.name
      ,e.u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190530001617
SQL开始执行时间：20190530001617

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190530001619
SQL开始执行时间：20190530001619
  
update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190530001619

20190531001609开始执行2019-05-30数据加载日志:
SQL开始执行时间：20190531001609
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190531001609
SQL开始执行时间：20190531001609



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190531001610
SQL开始执行时间：20190531001610
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190531001618
SQL开始执行时间：20190531001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190531001620
SQL开始执行时间：20190531001620
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.cdepname_lv2 = b.second_dept
 ,a.cdepname_lv3 = b.third_dept
 ,a.cdepname_lv4 = b.fourth_dept
 ,a.cdepname_lv5 = b.fifth_dept
 ,a.cdepname_lv6 = b.sixth_dept

;
SQL结束执行时间：20190531001620

20190601001608开始执行2019-05-31数据加载日志:
SQL开始执行时间：20190601001608
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190601001608
SQL开始执行时间：20190601001608
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190601001609
SQL开始执行时间：20190601001609
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190601001617
SQL开始执行时间：20190601001617

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190601001618
SQL开始执行时间：20190601001618

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190601001618
SQL开始执行时间：20190601001618

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190601001618
SQL开始执行时间：20190601001618

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190601001618
SQL开始执行时间：20190601001618


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190601001618
SQL开始执行时间：20190601001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190601001620
SQL开始执行时间：20190601001620
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.cdepname_lv2 = b.second_dept
 ,a.cdepname_lv3 = b.third_dept
 ,a.cdepname_lv4 = b.fourth_dept
 ,a.cdepname_lv5 = b.fifth_dept
 ,a.cdepname_lv6 = b.sixth_dept

;
SQL结束执行时间：20190601001620

20190602001614开始执行2019-06-01数据加载日志:
SQL开始执行时间：20190602001614
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190602001614
SQL开始执行时间：20190602001614
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190602001614
SQL开始执行时间：20190602001614



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190602001614
SQL开始执行时间：20190602001614
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190602001615
SQL开始执行时间：20190602001615


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190602001616
SQL开始执行时间：20190602001616

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190602001616
SQL开始执行时间：20190602001616
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190602001624
SQL开始执行时间：20190602001624

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190602001626
SQL开始执行时间：20190602001626
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.cdepname_lv2 = b.second_dept
 ,a.cdepname_lv3 = b.third_dept
 ,a.cdepname_lv4 = b.fourth_dept
 ,a.cdepname_lv5 = b.fifth_dept
 ,a.cdepname_lv6 = b.sixth_dept

;
SQL结束执行时间：20190602001626

20190603001613开始执行2019-06-02数据加载日志:
SQL开始执行时间：20190603001613
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190603001613
SQL开始执行时间：20190603001613
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190603001614
SQL开始执行时间：20190603001614
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190603001622
SQL开始执行时间：20190603001622

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190603001623
SQL开始执行时间：20190603001623


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190603001623
SQL开始执行时间：20190603001623

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190603001625
SQL开始执行时间：20190603001625
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.cdepname_lv2 = b.second_dept
 ,a.cdepname_lv3 = b.third_dept
 ,a.cdepname_lv4 = b.fourth_dept
 ,a.cdepname_lv5 = b.fifth_dept
 ,a.cdepname_lv6 = b.sixth_dept

;
SQL结束执行时间：20190603001625

20190604001609开始执行2019-06-03数据加载日志:
SQL开始执行时间：20190604001609
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190604001609
SQL开始执行时间：20190604001609
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190604001610
SQL开始执行时间：20190604001610


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190604001611
SQL开始执行时间：20190604001611

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190604001611
SQL开始执行时间：20190604001611
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190604001619
SQL开始执行时间：20190604001619

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190604001621
SQL开始执行时间：20190604001621
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.cdepname_lv2 = b.second_dept
 ,a.cdepname_lv3 = b.third_dept
 ,a.cdepname_lv4 = b.fourth_dept
 ,a.cdepname_lv5 = b.fifth_dept
 ,a.cdepname_lv6 = b.sixth_dept

;
SQL结束执行时间：20190604001621

20190605001611开始执行2019-06-04数据加载日志:
SQL开始执行时间：20190605001611
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190605001611
SQL开始执行时间：20190605001611
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190605001612
SQL开始执行时间：20190605001612
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620

update edw.oa_budget_19 as a
inner join (select * from edw.ehr_deptment  group by name_oa) as b
on a.name_oa = b.name_oa
set 
  a.name_ehr = b.name_ehr
 ,a.cdepname_lv2 = b.name_lv3
 ,a.cdepname_lv3 = b.name_lv4
 ,a.cdepname_lv4 = b.name_lv5
 ,a.cdepname_lv5 = b.name_lv6

;
SQL结束执行时间：20190605001620
SQL开始执行时间：20190605001620

create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190605001621
SQL开始执行时间：20190605001621

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where cdepname_lv6 is not null
;
SQL结束执行时间：20190605001621
SQL开始执行时间：20190605001621

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4,cdepname_lv5) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190605001621
SQL开始执行时间：20190605001621


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv5 is not null 
  and cdepname_lv6 is null

;
SQL结束执行时间：20190605001621
SQL开始执行时间：20190605001621

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3,cdepname_lv4) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv4 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null

;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) in (select CONCAT(name,budgetperiodslist,cdepname_lv2,cdepname_lv3) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv3 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,cdepname_lv2) in (select CONCAT(name,budgetperiodslist,cdepname_lv2) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where cdepname_lv2 is not null 
and cdepname_lv6 is null
and cdepname_lv5 is null
and cdepname_lv4 is null
and cdepname_lv3 is null
;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.cdepname_lv5
      ,a.cdepname_lv6
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190605001623
SQL开始执行时间：20190605001623
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.cdepname_lv2 = b.second_dept
 ,a.cdepname_lv3 = b.third_dept
 ,a.cdepname_lv4 = b.fourth_dept
 ,a.cdepname_lv5 = b.fifth_dept
 ,a.cdepname_lv6 = b.sixth_dept

;
SQL结束执行时间：20190605001623

20190606001623开始执行2019-06-05数据加载日志:
SQL开始执行时间：20190606001623
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190606001623
SQL开始执行时间：20190606001623
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190606001624
SQL开始执行时间：20190606001624


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190606001625
SQL开始执行时间：20190606001625

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190606001625
SQL开始执行时间：20190606001625
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190606001633
SQL开始执行时间：20190606001633

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190606001634
SQL开始执行时间：20190606001634

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190606001634
SQL开始执行时间：20190606001634

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190606001634
SQL开始执行时间：20190606001634

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190606001634
SQL开始执行时间：20190606001634
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190606001634

20190607001600开始执行2019-06-06数据加载日志:
SQL开始执行时间：20190607001600
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190607001600
SQL开始执行时间：20190607001600
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190607001600
SQL开始执行时间：20190607001600



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190607001600
SQL开始执行时间：20190607001600
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190607001600
SQL开始执行时间：20190607001600

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190607001600
SQL开始执行时间：20190607001600

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190607001601
SQL开始执行时间：20190607001601

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190607001602
SQL开始执行时间：20190607001602
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190607001610
SQL开始执行时间：20190607001610

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190607001611
SQL开始执行时间：20190607001611

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190607001611
SQL开始执行时间：20190607001611

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190607001611
SQL开始执行时间：20190607001611

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190607001611
SQL开始执行时间：20190607001611
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190607001611

20190608001609开始执行2019-06-07数据加载日志:
SQL开始执行时间：20190608001609
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190608001609
SQL开始执行时间：20190608001609
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190608001610
SQL开始执行时间：20190608001610


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190608001611
SQL开始执行时间：20190608001611

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190608001611
SQL开始执行时间：20190608001611
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190608001619
SQL开始执行时间：20190608001619

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190608001620
SQL开始执行时间：20190608001620
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190608001620

20190610084641开始执行2019-06-09数据加载日志:
SQL开始执行时间：20190610084641
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190610084641
SQL开始执行时间：20190610084641
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190610084641
SQL开始执行时间：20190610084641



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190610084641
SQL开始执行时间：20190610084641
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190610084641
SQL开始执行时间：20190610084641

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190610084641
SQL开始执行时间：20190610084641

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190610084642
SQL开始执行时间：20190610084642


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190610084643
SQL开始执行时间：20190610084643

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190610084643
SQL开始执行时间：20190610084643
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190610084651
SQL开始执行时间：20190610084651

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190610084652
SQL开始执行时间：20190610084652

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190610084652
SQL开始执行时间：20190610084652

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190610084652
SQL开始执行时间：20190610084652

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190610084652
SQL开始执行时间：20190610084652
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190610084652

20190611001609开始执行2019-06-10数据加载日志:
SQL开始执行时间：20190611001609
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190611001609
SQL开始执行时间：20190611001609
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190611001609
SQL开始执行时间：20190611001609



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190611001609
SQL开始执行时间：20190611001609
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190611001609
SQL开始执行时间：20190611001609

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190611001609
SQL开始执行时间：20190611001609

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190611001609
SQL开始执行时间：20190611001609
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190611001610
SQL开始执行时间：20190611001610
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190611001619
SQL开始执行时间：20190611001619

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190611001620
SQL开始执行时间：20190611001620

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190611001620
SQL开始执行时间：20190611001620

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190611001620
SQL开始执行时间：20190611001620

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190611001620
SQL开始执行时间：20190611001620
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190611001620

20190612001611开始执行2019-06-11数据加载日志:
SQL开始执行时间：20190612001611
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190612001611
SQL开始执行时间：20190612001611
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190612001612
SQL开始执行时间：20190612001612
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190612001620
SQL开始执行时间：20190612001620


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190612001621
SQL开始执行时间：20190612001621

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190612001622
SQL开始执行时间：20190612001622

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190612001622
SQL开始执行时间：20190612001622

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190612001622
SQL开始执行时间：20190612001622

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190612001622
SQL开始执行时间：20190612001622
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190612001622

20190613001608开始执行2019-06-12数据加载日志:
SQL开始执行时间：20190613001608
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190613001608
SQL开始执行时间：20190613001608
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190613001608
SQL开始执行时间：20190613001608



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190613001608
SQL开始执行时间：20190613001608
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190613001608
SQL开始执行时间：20190613001608

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190613001608
SQL开始执行时间：20190613001608

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190613001609
SQL开始执行时间：20190613001609
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190613001618
SQL开始执行时间：20190613001618

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190613001619
SQL开始执行时间：20190613001619

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190613001619
SQL开始执行时间：20190613001619

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190613001619
SQL开始执行时间：20190613001619

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190613001619
SQL开始执行时间：20190613001619
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190613001619

20190614001629开始执行2019-06-13数据加载日志:
SQL开始执行时间：20190614001629
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190614001629
SQL开始执行时间：20190614001629
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190614001630
SQL开始执行时间：20190614001630

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190614001630
SQL开始执行时间：20190614001630





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190614001630
SQL开始执行时间：20190614001630


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190614001630
SQL开始执行时间：20190614001630

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190614001630
SQL开始执行时间：20190614001630
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190614001638
SQL开始执行时间：20190614001638

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190614001639
SQL开始执行时间：20190614001639
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190614001639

20190615001637开始执行2019-06-14数据加载日志:
SQL开始执行时间：20190615001637
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190615001637
SQL开始执行时间：20190615001637
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190615001638
SQL开始执行时间：20190615001638
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190615001647
SQL开始执行时间：20190615001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190615001648
SQL开始执行时间：20190615001648
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190615001649

20190616001633开始执行2019-06-15数据加载日志:
SQL开始执行时间：20190616001633
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190616001633
SQL开始执行时间：20190616001633
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190616001634
SQL开始执行时间：20190616001634

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190616001635
SQL开始执行时间：20190616001635
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190616001635
SQL开始执行时间：20190616001635

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190616001635
SQL开始执行时间：20190616001635





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190616001635
SQL开始执行时间：20190616001635


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190616001635
SQL开始执行时间：20190616001635

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190616001635
SQL开始执行时间：20190616001635
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190616001644
SQL开始执行时间：20190616001644

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190616001645
SQL开始执行时间：20190616001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190616001645
SQL开始执行时间：20190616001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190616001645
SQL开始执行时间：20190616001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190616001645
SQL开始执行时间：20190616001645

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190616001645
SQL开始执行时间：20190616001645

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190616001645
SQL开始执行时间：20190616001645
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190616001645

20190617001638开始执行2019-06-16数据加载日志:
SQL开始执行时间：20190617001638
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190617001638
SQL开始执行时间：20190617001638
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190617001639
SQL开始执行时间：20190617001639





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190617001640
SQL开始执行时间：20190617001640


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190617001640
SQL开始执行时间：20190617001640

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190617001640
SQL开始执行时间：20190617001640
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190617001649
SQL开始执行时间：20190617001649

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190617001650
SQL开始执行时间：20190617001650

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190617001650
SQL开始执行时间：20190617001650

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190617001650
SQL开始执行时间：20190617001650

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190617001650
SQL开始执行时间：20190617001650

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190617001650
SQL开始执行时间：20190617001650

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190617001650
SQL开始执行时间：20190617001650
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190617001650

20190618001632开始执行2019-06-17数据加载日志:
SQL开始执行时间：20190618001632
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190618001632
SQL开始执行时间：20190618001632
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190618001632
SQL开始执行时间：20190618001632



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190618001632
SQL开始执行时间：20190618001632
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190618001633
SQL开始执行时间：20190618001633


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190618001634
SQL开始执行时间：20190618001634

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190618001634
SQL开始执行时间：20190618001634
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190618001642
SQL开始执行时间：20190618001642


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190618001643
SQL开始执行时间：20190618001643

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190618001644
SQL开始执行时间：20190618001644

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190618001644
SQL开始执行时间：20190618001644

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190618001644
SQL开始执行时间：20190618001644

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190618001644
SQL开始执行时间：20190618001644
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190618001644

20190619001636开始执行2019-06-18数据加载日志:
SQL开始执行时间：20190619001636
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190619001636
SQL开始执行时间：20190619001636
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190619001637
SQL开始执行时间：20190619001637

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190619001638
SQL开始执行时间：20190619001638
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190619001638
SQL开始执行时间：20190619001638

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190619001638
SQL开始执行时间：20190619001638





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190619001638
SQL开始执行时间：20190619001638


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190619001638
SQL开始执行时间：20190619001638

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190619001638
SQL开始执行时间：20190619001638
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190619001647
SQL开始执行时间：20190619001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190619001648
SQL开始执行时间：20190619001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190619001648
SQL开始执行时间：20190619001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190619001648
SQL开始执行时间：20190619001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190619001648
SQL开始执行时间：20190619001648

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190619001648
SQL开始执行时间：20190619001648

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190619001648
SQL开始执行时间：20190619001648
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190619001648

20190620001633开始执行2019-06-19数据加载日志:
SQL开始执行时间：20190620001633
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190620001633
SQL开始执行时间：20190620001633
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190620001633
SQL开始执行时间：20190620001633



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190620001633
SQL开始执行时间：20190620001633
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190620001633
SQL开始执行时间：20190620001633

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190620001633
SQL开始执行时间：20190620001633

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190620001634
SQL开始执行时间：20190620001634


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190620001635
SQL开始执行时间：20190620001635

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190620001635
SQL开始执行时间：20190620001635
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190620001644
SQL开始执行时间：20190620001644

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190620001645
SQL开始执行时间：20190620001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190620001645
SQL开始执行时间：20190620001645

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190620001645
SQL开始执行时间：20190620001645

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190620001645
SQL开始执行时间：20190620001645
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190620001645

20190621001646开始执行2019-06-20数据加载日志:
SQL开始执行时间：20190621001646
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190621001646
SQL开始执行时间：20190621001646



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190621001647
SQL开始执行时间：20190621001647


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190621001648
SQL开始执行时间：20190621001648

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190621001648
SQL开始执行时间：20190621001648
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190621001656
SQL开始执行时间：20190621001656


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190621001657
SQL开始执行时间：20190621001657

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190621001658
SQL开始执行时间：20190621001658

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190621001658
SQL开始执行时间：20190621001658

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190621001658
SQL开始执行时间：20190621001658
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190621001658

20190622001634开始执行2019-06-21数据加载日志:
SQL开始执行时间：20190622001634
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190622001634
SQL开始执行时间：20190622001634
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190622001634
SQL开始执行时间：20190622001634



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190622001634
SQL开始执行时间：20190622001634
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190622001635
SQL开始执行时间：20190622001635


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190622001636
SQL开始执行时间：20190622001636

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190622001636
SQL开始执行时间：20190622001636
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190622001645
SQL开始执行时间：20190622001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190622001646
SQL开始执行时间：20190622001646

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190622001646
SQL开始执行时间：20190622001646

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190622001646
SQL开始执行时间：20190622001646

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190622001646
SQL开始执行时间：20190622001646
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190622001646

20190623001634开始执行2019-06-22数据加载日志:
SQL开始执行时间：20190623001634
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190623001634
SQL开始执行时间：20190623001634
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190623001634
SQL开始执行时间：20190623001634



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190623001634
SQL开始执行时间：20190623001634
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190623001634
SQL开始执行时间：20190623001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190623001634
SQL开始执行时间：20190623001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190623001634
SQL开始执行时间：20190623001634
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190623001634
SQL开始执行时间：20190623001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190623001635
SQL开始执行时间：20190623001635


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190623001636
SQL开始执行时间：20190623001636

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190623001636
SQL开始执行时间：20190623001636
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190623001644
SQL开始执行时间：20190623001644


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190623001645
SQL开始执行时间：20190623001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190623001646
SQL开始执行时间：20190623001646

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190623001646
SQL开始执行时间：20190623001646

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190623001646
SQL开始执行时间：20190623001646

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190623001646
SQL开始执行时间：20190623001646
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190623001646

20190624091131开始执行2019-06-23数据加载日志:
SQL开始执行时间：20190624091131
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190624091131
SQL开始执行时间：20190624091131
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190624091132
SQL开始执行时间：20190624091132


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190624091133
SQL开始执行时间：20190624091133

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190624091133
SQL开始执行时间：20190624091133
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190624091141
SQL开始执行时间：20190624091141


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190624091142
SQL开始执行时间：20190624091142

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190624091143
SQL开始执行时间：20190624091143

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190624091143
SQL开始执行时间：20190624091143

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190624091143
SQL开始执行时间：20190624091143

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190624091143
SQL开始执行时间：20190624091143
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190624091143

20190625001634开始执行2019-06-24数据加载日志:
SQL开始执行时间：20190625001634
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190625001634
SQL开始执行时间：20190625001634
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190625001635
SQL开始执行时间：20190625001635
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190625001636
SQL开始执行时间：20190625001636
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190625001645
SQL开始执行时间：20190625001645


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190625001646
SQL开始执行时间：20190625001646

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190625001646
SQL开始执行时间：20190625001646

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190625001646
SQL开始执行时间：20190625001646


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190625001646
SQL开始执行时间：20190625001646

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190625001646
SQL开始执行时间：20190625001646

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190625001646
SQL开始执行时间：20190625001646

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190625001647
SQL开始执行时间：20190625001647

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190625001647
SQL开始执行时间：20190625001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190625001648
SQL开始执行时间：20190625001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190625001648
SQL开始执行时间：20190625001648

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190625001648
SQL开始执行时间：20190625001648

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190625001648
SQL开始执行时间：20190625001648
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190625001648

20190626144915开始执行2019-06-25数据加载日志:
SQL开始执行时间：20190626144915
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190626144915
SQL开始执行时间：20190626144915
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190626144916
SQL开始执行时间：20190626144916


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190626144917
SQL开始执行时间：20190626144917

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190626144917
SQL开始执行时间：20190626144917
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190626144925
SQL开始执行时间：20190626144925

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190626144925
SQL开始执行时间：20190626144925
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190626144925
SQL开始执行时间：20190626144925
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190626144926
SQL开始执行时间：20190626144926

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190626144927
SQL开始执行时间：20190626144927

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190626144927
SQL开始执行时间：20190626144927

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190626144928
SQL开始执行时间：20190626144928

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190626144928
SQL开始执行时间：20190626144928

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190626144928
SQL开始执行时间：20190626144928

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190626144928
SQL开始执行时间：20190626144928
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190626144928

20190627001635开始执行2019-06-26数据加载日志:
SQL开始执行时间：20190627001635
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190627001635
SQL开始执行时间：20190627001635
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190627001635
SQL开始执行时间：20190627001635



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190627001635
SQL开始执行时间：20190627001635
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190627001635
SQL开始执行时间：20190627001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190627001636
SQL开始执行时间：20190627001636


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190627001637
SQL开始执行时间：20190627001637

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190627001637
SQL开始执行时间：20190627001637
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190627001646
SQL开始执行时间：20190627001646

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190627001647
SQL开始执行时间：20190627001647

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190627001647
SQL开始执行时间：20190627001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190627001647
SQL开始执行时间：20190627001647

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190627001647
SQL开始执行时间：20190627001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190627001648
SQL开始执行时间：20190627001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190627001648
SQL开始执行时间：20190627001648

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190627001648
SQL开始执行时间：20190627001648

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190627001648
SQL开始执行时间：20190627001648
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190627001648

20190628001656开始执行2019-06-27数据加载日志:
SQL开始执行时间：20190628001656
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190628001656
SQL开始执行时间：20190628001656
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190628001656
SQL开始执行时间：20190628001656



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190628001656
SQL开始执行时间：20190628001656
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190628001656
SQL开始执行时间：20190628001656

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190628001656
SQL开始执行时间：20190628001656

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190628001656
SQL开始执行时间：20190628001656
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190628001657
SQL开始执行时间：20190628001657


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190628001658
SQL开始执行时间：20190628001658

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190628001658
SQL开始执行时间：20190628001658
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190628001707
SQL开始执行时间：20190628001707

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190628001708
SQL开始执行时间：20190628001708

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190628001708
SQL开始执行时间：20190628001708

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190628001708
SQL开始执行时间：20190628001708

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190628001708
SQL开始执行时间：20190628001708

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190628001709
SQL开始执行时间：20190628001709

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190628001709
SQL开始执行时间：20190628001709

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190628001709
SQL开始执行时间：20190628001709

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190628001709
SQL开始执行时间：20190628001709
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190628001709

20190629001643开始执行2019-06-28数据加载日志:
SQL开始执行时间：20190629001643
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190629001645
SQL开始执行时间：20190629001645

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190629001645
SQL开始执行时间：20190629001645
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;

20190702084315开始执行2019-07-01数据加载日志:
SQL开始执行时间：20190702084315
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190702084315
SQL开始执行时间：20190702084315
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190702084316
SQL开始执行时间：20190702084316
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190702084323
SQL开始执行时间：20190702084323

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702084324
SQL开始执行时间：20190702084324


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190702084324
SQL开始执行时间：20190702084324

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702084324
SQL开始执行时间：20190702084324

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190702084324
SQL开始执行时间：20190702084324

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702084324
SQL开始执行时间：20190702084324

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190702084324
SQL开始执行时间：20190702084324

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702084325
SQL开始执行时间：20190702084325

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190702084325
SQL开始执行时间：20190702084325

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190702084325
SQL开始执行时间：20190702084325

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190702084325
SQL开始执行时间：20190702084325
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190702084325

20190702092022开始执行2019-07-01数据加载日志:
SQL开始执行时间：20190702092022
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190702092022
SQL开始执行时间：20190702092022
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190702092023
SQL开始执行时间：20190702092023


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190702092024
SQL开始执行时间：20190702092024

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190702092024
SQL开始执行时间：20190702092024
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190702092032
SQL开始执行时间：20190702092032


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190702092033
SQL开始执行时间：20190702092033

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190702092034
SQL开始执行时间：20190702092034

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190702092034
SQL开始执行时间：20190702092034

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190702092034
SQL开始执行时间：20190702092034

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190702092034
SQL开始执行时间：20190702092034
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190702092034

20190703001635开始执行2019-07-02数据加载日志:
SQL开始执行时间：20190703001635
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190703001636
SQL开始执行时间：20190703001636


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190703001637
SQL开始执行时间：20190703001637

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190703001637
SQL开始执行时间：20190703001637
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190703001647
SQL开始执行时间：20190703001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190703001648

20190704001635开始执行2019-07-03数据加载日志:
SQL开始执行时间：20190704001635
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190704001635
SQL开始执行时间：20190704001635
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190704001637
SQL开始执行时间：20190704001637
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190704001648
SQL开始执行时间：20190704001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190704001648
SQL开始执行时间：20190704001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190704001648
SQL开始执行时间：20190704001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190704001648
SQL开始执行时间：20190704001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190704001649
SQL开始执行时间：20190704001649

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190704001649
SQL开始执行时间：20190704001649

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190704001649
SQL开始执行时间：20190704001649

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190704001649
SQL开始执行时间：20190704001649
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190704001649

20190705001654开始执行2019-07-04数据加载日志:
SQL开始执行时间：20190705001654
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190705001654
SQL开始执行时间：20190705001654
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190705001656
SQL开始执行时间：20190705001656

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190705001656
SQL开始执行时间：20190705001656
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190705001705
SQL开始执行时间：20190705001705


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190705001706
SQL开始执行时间：20190705001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190705001707
SQL开始执行时间：20190705001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190705001707
SQL开始执行时间：20190705001707

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190705001707
SQL开始执行时间：20190705001707

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190705001707
SQL开始执行时间：20190705001707
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190705001707

20190706001658开始执行2019-07-05数据加载日志:
SQL开始执行时间：20190706001658
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190706001659
SQL开始执行时间：20190706001659


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190706001700
SQL开始执行时间：20190706001700

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190706001700
SQL开始执行时间：20190706001700
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190706001710
SQL开始执行时间：20190706001710

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190706001711
SQL开始执行时间：20190706001711

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190706001711
SQL开始执行时间：20190706001711


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190706001711
SQL开始执行时间：20190706001711

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190706001713
SQL开始执行时间：20190706001713

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190706001713
SQL开始执行时间：20190706001713

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190706001716
SQL开始执行时间：20190706001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190706001716
SQL开始执行时间：20190706001716

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190706001720
SQL开始执行时间：20190706001720

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190706001720
SQL开始执行时间：20190706001720

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190706001720
SQL开始执行时间：20190706001720

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190706001720
SQL开始执行时间：20190706001720
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190706001721

20190707001700开始执行2019-07-06数据加载日志:
SQL开始执行时间：20190707001700
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190707001700
SQL开始执行时间：20190707001700
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190707001700
SQL开始执行时间：20190707001700



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190707001700
SQL开始执行时间：20190707001700
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190707001700
SQL开始执行时间：20190707001700

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190707001700
SQL开始执行时间：20190707001700

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190707001700
SQL开始执行时间：20190707001700
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190707001700
SQL开始执行时间：20190707001700

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190707001702
SQL开始执行时间：20190707001702

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190707001702
SQL开始执行时间：20190707001702
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190707001713
SQL开始执行时间：20190707001713

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190707001714
SQL开始执行时间：20190707001714


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190707001714
SQL开始执行时间：20190707001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190707001716
SQL开始执行时间：20190707001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190707001716
SQL开始执行时间：20190707001716

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190707001719
SQL开始执行时间：20190707001719

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190707001719
SQL开始执行时间：20190707001719

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190707001723
SQL开始执行时间：20190707001723

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190707001723
SQL开始执行时间：20190707001723

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190707001723
SQL开始执行时间：20190707001723

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190707001723
SQL开始执行时间：20190707001723
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190707001723

20190708001712开始执行2019-07-07数据加载日志:
SQL开始执行时间：20190708001712
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190708001712
SQL开始执行时间：20190708001712
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190708001712
SQL开始执行时间：20190708001712



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190708001712
SQL开始执行时间：20190708001712
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190708001713
SQL开始执行时间：20190708001713

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190708001714
SQL开始执行时间：20190708001714





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190708001714
SQL开始执行时间：20190708001714


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190708001714
SQL开始执行时间：20190708001714

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190708001714
SQL开始执行时间：20190708001714
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190708001724
SQL开始执行时间：20190708001724

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190708001725
SQL开始执行时间：20190708001725


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190708001725
SQL开始执行时间：20190708001725

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190708001727
SQL开始执行时间：20190708001727

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190708001727
SQL开始执行时间：20190708001727

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190708001730
SQL开始执行时间：20190708001730

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190708001730
SQL开始执行时间：20190708001730

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190708001734
SQL开始执行时间：20190708001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190708001734
SQL开始执行时间：20190708001734

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190708001734
SQL开始执行时间：20190708001734

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190708001734
SQL开始执行时间：20190708001734
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190708001734

20190709001659开始执行2019-07-08数据加载日志:
SQL开始执行时间：20190709001659
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190709001701
SQL开始执行时间：20190709001701

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190709001701
SQL开始执行时间：20190709001701
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190709001712
SQL开始执行时间：20190709001712

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190709001713
SQL开始执行时间：20190709001713


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190709001713
SQL开始执行时间：20190709001713

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190709001715
SQL开始执行时间：20190709001715

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190709001715
SQL开始执行时间：20190709001715

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190709001717
SQL开始执行时间：20190709001717

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190709001717
SQL开始执行时间：20190709001717

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190709001721
SQL开始执行时间：20190709001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190709001722
SQL开始执行时间：20190709001722

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190709001722
SQL开始执行时间：20190709001722

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190709001722
SQL开始执行时间：20190709001722
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190709001722

20190710001701开始执行2019-07-09数据加载日志:
SQL开始执行时间：20190710001701
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190710001702
SQL开始执行时间：20190710001702


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190710001703
SQL开始执行时间：20190710001703

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190710001703
SQL开始执行时间：20190710001703
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190710001713
SQL开始执行时间：20190710001713


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190710001714
SQL开始执行时间：20190710001714

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190710001714
SQL开始执行时间：20190710001714

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190710001714
SQL开始执行时间：20190710001714


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190710001714
SQL开始执行时间：20190710001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190710001717
SQL开始执行时间：20190710001717

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190710001717
SQL开始执行时间：20190710001717

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190710001720
SQL开始执行时间：20190710001720

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190710001720
SQL开始执行时间：20190710001720

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190710001724
SQL开始执行时间：20190710001724

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190710001724
SQL开始执行时间：20190710001724

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190710001724
SQL开始执行时间：20190710001724

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190710001724
SQL开始执行时间：20190710001724
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190710001724

20190711001700开始执行2019-07-10数据加载日志:
SQL开始执行时间：20190711001700
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190711001700
SQL开始执行时间：20190711001700
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190711001700
SQL开始执行时间：20190711001700



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190711001700
SQL开始执行时间：20190711001700
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190711001702
SQL开始执行时间：20190711001702
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190711001714
SQL开始执行时间：20190711001714

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190711001714
SQL开始执行时间：20190711001714

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190711001714
SQL开始执行时间：20190711001714


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190711001714
SQL开始执行时间：20190711001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190711001717
SQL开始执行时间：20190711001717

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190711001717
SQL开始执行时间：20190711001717

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190711001719
SQL开始执行时间：20190711001719

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190711001719
SQL开始执行时间：20190711001719

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190711001723
SQL开始执行时间：20190711001723

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190711001723
SQL开始执行时间：20190711001723

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190711001723
SQL开始执行时间：20190711001723

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190711001723
SQL开始执行时间：20190711001723
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190711001723

20190712001720开始执行2019-07-11数据加载日志:
SQL开始执行时间：20190712001720
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190712001721
SQL开始执行时间：20190712001721


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190712001722
SQL开始执行时间：20190712001722

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190712001722
SQL开始执行时间：20190712001722
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190712001732
SQL开始执行时间：20190712001732

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190712001734
SQL开始执行时间：20190712001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190712001734
SQL开始执行时间：20190712001734

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190712001736
SQL开始执行时间：20190712001736

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190712001736
SQL开始执行时间：20190712001736

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190712001740
SQL开始执行时间：20190712001740

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190712001740
SQL开始执行时间：20190712001740

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190712001740
SQL开始执行时间：20190712001740

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190712001740
SQL开始执行时间：20190712001740
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190712001740

20190715090506开始执行2019-07-14数据加载日志:
SQL开始执行时间：20190715090506
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190715090506
SQL开始执行时间：20190715090506
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190715090507
SQL开始执行时间：20190715090507


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190715090508
SQL开始执行时间：20190715090508

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190715090508
SQL开始执行时间：20190715090508
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190715090517
SQL开始执行时间：20190715090517


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190715090518
SQL开始执行时间：20190715090518

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190715090518
SQL开始执行时间：20190715090518

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190715090518
SQL开始执行时间：20190715090518


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190715090518
SQL开始执行时间：20190715090518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190715090520
SQL开始执行时间：20190715090520

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190715090520
SQL开始执行时间：20190715090520

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190715090522
SQL开始执行时间：20190715090522

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190715090522
SQL开始执行时间：20190715090522

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190715090525
SQL开始执行时间：20190715090525

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190715090525
SQL开始执行时间：20190715090525

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190715090525
SQL开始执行时间：20190715090525

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190715090525
SQL开始执行时间：20190715090525
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190715090525

20190716003817开始执行2019-07-15数据加载日志:
SQL开始执行时间：20190716003817
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190716003817
SQL开始执行时间：20190716003817
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190716003818
SQL开始执行时间：20190716003818
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190716003828
SQL开始执行时间：20190716003828


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190716003829
SQL开始执行时间：20190716003829

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190716003829
SQL开始执行时间：20190716003829

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190716003829
SQL开始执行时间：20190716003829


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190716003829
SQL开始执行时间：20190716003829

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190716003831
SQL开始执行时间：20190716003831

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190716003831
SQL开始执行时间：20190716003831

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190716003833
SQL开始执行时间：20190716003833

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190716003833
SQL开始执行时间：20190716003833

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190716003836
SQL开始执行时间：20190716003836

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190716003836
SQL开始执行时间：20190716003836

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190716003836
SQL开始执行时间：20190716003836

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190716003836
SQL开始执行时间：20190716003836
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190716003837

20190717001657开始执行2019-07-16数据加载日志:
SQL开始执行时间：20190717001657
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190717001657
SQL开始执行时间：20190717001657
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190717001657
SQL开始执行时间：20190717001657



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190717001657
SQL开始执行时间：20190717001657
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190717001657
SQL开始执行时间：20190717001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190717001658
SQL开始执行时间：20190717001658


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190717001659
SQL开始执行时间：20190717001659

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190717001659
SQL开始执行时间：20190717001659
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190717001709
SQL开始执行时间：20190717001709

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190717001710
SQL开始执行时间：20190717001710


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190717001710
SQL开始执行时间：20190717001710

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190717001712
SQL开始执行时间：20190717001712

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190717001712
SQL开始执行时间：20190717001712

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190717001714
SQL开始执行时间：20190717001714

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190717001714
SQL开始执行时间：20190717001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190717001718
SQL开始执行时间：20190717001718

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190717001718
SQL开始执行时间：20190717001718

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190717001718
SQL开始执行时间：20190717001718

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190717001718
SQL开始执行时间：20190717001718
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190717001718

20190718001718开始执行2019-07-17数据加载日志:
SQL开始执行时间：20190718001718
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190718001720
SQL开始执行时间：20190718001720

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190718001720
SQL开始执行时间：20190718001720
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190718001731
SQL开始执行时间：20190718001731

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190718001732
SQL开始执行时间：20190718001732


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190718001732
SQL开始执行时间：20190718001732

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190718001734
SQL开始执行时间：20190718001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190718001734
SQL开始执行时间：20190718001734

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190718001736
SQL开始执行时间：20190718001736

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190718001736
SQL开始执行时间：20190718001736

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190718001739
SQL开始执行时间：20190718001739

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190718001739
SQL开始执行时间：20190718001739

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190718001739
SQL开始执行时间：20190718001739

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190718001739
SQL开始执行时间：20190718001739
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190718001739

20190719001701开始执行2019-07-18数据加载日志:
SQL开始执行时间：20190719001701
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190719001701
SQL开始执行时间：20190719001701
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190719001702
SQL开始执行时间：20190719001702


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190719001703
SQL开始执行时间：20190719001703

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190719001703
SQL开始执行时间：20190719001703
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190719001713
SQL开始执行时间：20190719001713


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190719001714
SQL开始执行时间：20190719001714

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190719001714
SQL开始执行时间：20190719001714

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190719001714
SQL开始执行时间：20190719001714


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190719001714
SQL开始执行时间：20190719001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190719001716
SQL开始执行时间：20190719001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190719001716
SQL开始执行时间：20190719001716

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190719001719
SQL开始执行时间：20190719001719

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190719001719
SQL开始执行时间：20190719001719

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190719001722
SQL开始执行时间：20190719001722

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190719001722
SQL开始执行时间：20190719001722

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190719001722
SQL开始执行时间：20190719001722

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190719001722
SQL开始执行时间：20190719001722
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190719001722

20190720001631开始执行2019-07-19数据加载日志:
SQL开始执行时间：20190720001631
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190720001632
SQL开始执行时间：20190720001632


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190720001633
SQL开始执行时间：20190720001633

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190720001633
SQL开始执行时间：20190720001633
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190720001643
SQL开始执行时间：20190720001643

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190720001644
SQL开始执行时间：20190720001644


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190720001644
SQL开始执行时间：20190720001644

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190720001645
SQL开始执行时间：20190720001645

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190720001645
SQL开始执行时间：20190720001645

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190720001647
SQL开始执行时间：20190720001647

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190720001647
SQL开始执行时间：20190720001647

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190720001650
SQL开始执行时间：20190720001650

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190720001650
SQL开始执行时间：20190720001650

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190720001650
SQL开始执行时间：20190720001650

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190720001650
SQL开始执行时间：20190720001650
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190720001650

20190721001631开始执行2019-07-20数据加载日志:
SQL开始执行时间：20190721001631
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190721001631
SQL开始执行时间：20190721001631
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190721001632
SQL开始执行时间：20190721001632


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190721001633
SQL开始执行时间：20190721001633

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190721001633
SQL开始执行时间：20190721001633
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190721001643
SQL开始执行时间：20190721001643


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190721001644
SQL开始执行时间：20190721001644

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190721001644
SQL开始执行时间：20190721001644

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190721001644
SQL开始执行时间：20190721001644


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190721001644
SQL开始执行时间：20190721001644

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190721001646
SQL开始执行时间：20190721001646

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190721001646
SQL开始执行时间：20190721001646

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190721001648
SQL开始执行时间：20190721001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190721001648
SQL开始执行时间：20190721001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190721001651
SQL开始执行时间：20190721001651

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190721001651
SQL开始执行时间：20190721001651

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190721001651
SQL开始执行时间：20190721001651

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190721001651
SQL开始执行时间：20190721001651
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190721001651

20190722001633开始执行2019-07-21数据加载日志:
SQL开始执行时间：20190722001633
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190722001633
SQL开始执行时间：20190722001633
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190722001633
SQL开始执行时间：20190722001633



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190722001633
SQL开始执行时间：20190722001633
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190722001633
SQL开始执行时间：20190722001633

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190722001633
SQL开始执行时间：20190722001633

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190722001635
SQL开始执行时间：20190722001635

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190722001635
SQL开始执行时间：20190722001635
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190722001645
SQL开始执行时间：20190722001645

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190722001645
SQL开始执行时间：20190722001645
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190722001646
SQL开始执行时间：20190722001646

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190722001648
SQL开始执行时间：20190722001648

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190722001648
SQL开始执行时间：20190722001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190722001650
SQL开始执行时间：20190722001650

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190722001650
SQL开始执行时间：20190722001650

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190722001653
SQL开始执行时间：20190722001653

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190722001653
SQL开始执行时间：20190722001653

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190722001653
SQL开始执行时间：20190722001653

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190722001653
SQL开始执行时间：20190722001653
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190722001653

20190723001636开始执行2019-07-22数据加载日志:
SQL开始执行时间：20190723001636
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190723001636
SQL开始执行时间：20190723001636
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190723001636
SQL开始执行时间：20190723001636



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190723001636
SQL开始执行时间：20190723001636
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190723001636
SQL开始执行时间：20190723001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190723001636
SQL开始执行时间：20190723001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190723001636
SQL开始执行时间：20190723001636
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190723001638
SQL开始执行时间：20190723001638

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190723001638
SQL开始执行时间：20190723001638
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190723001648
SQL开始执行时间：20190723001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190723001650
SQL开始执行时间：20190723001650

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190723001650
SQL开始执行时间：20190723001650

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190723001652
SQL开始执行时间：20190723001652

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190723001652
SQL开始执行时间：20190723001652

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190723001654
SQL开始执行时间：20190723001654

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190723001654
SQL开始执行时间：20190723001654

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190723001654
SQL开始执行时间：20190723001654

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190723001654
SQL开始执行时间：20190723001654
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190723001654

20190724001649开始执行2019-07-23数据加载日志:
SQL开始执行时间：20190724001649
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190724001649
SQL开始执行时间：20190724001649
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190724001650
SQL开始执行时间：20190724001650


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190724001651
SQL开始执行时间：20190724001651

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190724001651
SQL开始执行时间：20190724001651
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190724001700
SQL开始执行时间：20190724001700

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190724001700
SQL开始执行时间：20190724001700
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190724001700
SQL开始执行时间：20190724001700
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190724001700
SQL开始执行时间：20190724001700
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190724001703
SQL开始执行时间：20190724001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190724001703
SQL开始执行时间：20190724001703

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190724001704
SQL开始执行时间：20190724001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190724001705
SQL开始执行时间：20190724001705

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190724001707
SQL开始执行时间：20190724001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190724001707
SQL开始执行时间：20190724001707

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190724001707
SQL开始执行时间：20190724001707

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190724001708
SQL开始执行时间：20190724001708
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190724001708

20190725001640开始执行2019-07-24数据加载日志:
SQL开始执行时间：20190725001640
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190725001642
SQL开始执行时间：20190725001642

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190725001642
SQL开始执行时间：20190725001642
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190725001653
SQL开始执行时间：20190725001653

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190725001654
SQL开始执行时间：20190725001654


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190725001654
SQL开始执行时间：20190725001654

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190725001655
SQL开始执行时间：20190725001655

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190725001655
SQL开始执行时间：20190725001655

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190725001657
SQL开始执行时间：20190725001657

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190725001657
SQL开始执行时间：20190725001657

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190725001659
SQL开始执行时间：20190725001659

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190725001659
SQL开始执行时间：20190725001659

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190725001659
SQL开始执行时间：20190725001659

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190725001659
SQL开始执行时间：20190725001659
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190725001700

20190726001635开始执行2019-07-25数据加载日志:
SQL开始执行时间：20190726001635
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190726001637
SQL开始执行时间：20190726001637

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190726001637
SQL开始执行时间：20190726001637
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190726001648
SQL开始执行时间：20190726001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190726001650
SQL开始执行时间：20190726001650

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190726001650
SQL开始执行时间：20190726001650

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190726001652
SQL开始执行时间：20190726001652

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190726001652
SQL开始执行时间：20190726001652

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190726001655
SQL开始执行时间：20190726001655

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190726001655
SQL开始执行时间：20190726001655

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190726001655
SQL开始执行时间：20190726001655

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190726001655
SQL开始执行时间：20190726001655
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190726001655

20190727001651开始执行2019-07-26数据加载日志:
SQL开始执行时间：20190727001651
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190727001651
SQL开始执行时间：20190727001651
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190727001651
SQL开始执行时间：20190727001651



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190727001651
SQL开始执行时间：20190727001651
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190727001704
SQL开始执行时间：20190727001704


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190727001705
SQL开始执行时间：20190727001705

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190727001705
SQL开始执行时间：20190727001705

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190727001705
SQL开始执行时间：20190727001705


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190727001705
SQL开始执行时间：20190727001705

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190727001706
SQL开始执行时间：20190727001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190727001706
SQL开始执行时间：20190727001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190727001708
SQL开始执行时间：20190727001708

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190727001708
SQL开始执行时间：20190727001708

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190727001711
SQL开始执行时间：20190727001711

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190727001711
SQL开始执行时间：20190727001711

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190727001711
SQL开始执行时间：20190727001711

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190727001711
SQL开始执行时间：20190727001711
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190727001711

20190728001644开始执行2019-07-27数据加载日志:
SQL开始执行时间：20190728001644
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190728001644
SQL开始执行时间：20190728001644
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190728001645
SQL开始执行时间：20190728001645


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190728001646
SQL开始执行时间：20190728001646

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190728001646
SQL开始执行时间：20190728001646
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190728001657
SQL开始执行时间：20190728001657

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190728001657
SQL开始执行时间：20190728001657
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190728001658
SQL开始执行时间：20190728001658

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190728001700
SQL开始执行时间：20190728001700

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190728001700
SQL开始执行时间：20190728001700

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190728001702
SQL开始执行时间：20190728001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190728001702
SQL开始执行时间：20190728001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190728001704
SQL开始执行时间：20190728001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190728001704
SQL开始执行时间：20190728001704

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190728001705
SQL开始执行时间：20190728001705

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190728001705
SQL开始执行时间：20190728001705
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190728001705

20190729001643开始执行2019-07-28数据加载日志:
SQL开始执行时间：20190729001643
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190729001643
SQL开始执行时间：20190729001643
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190729001643
SQL开始执行时间：20190729001643



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190729001643
SQL开始执行时间：20190729001643
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190729001644
SQL开始执行时间：20190729001644
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190729001657
SQL开始执行时间：20190729001657

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190729001658
SQL开始执行时间：20190729001658


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190729001658
SQL开始执行时间：20190729001658

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190729001659
SQL开始执行时间：20190729001659

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190729001659
SQL开始执行时间：20190729001659

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190729001701
SQL开始执行时间：20190729001701

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190729001701
SQL开始执行时间：20190729001701

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190729001704
SQL开始执行时间：20190729001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190729001704
SQL开始执行时间：20190729001704

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190729001704
SQL开始执行时间：20190729001704

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190729001704
SQL开始执行时间：20190729001704
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190729001704

20190730001706开始执行2019-07-29数据加载日志:
SQL开始执行时间：20190730001706
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190730001706
SQL开始执行时间：20190730001706
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190730001707
SQL开始执行时间：20190730001707
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190730001719
SQL开始执行时间：20190730001719

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190730001721
SQL开始执行时间：20190730001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190730001721
SQL开始执行时间：20190730001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190730001723
SQL开始执行时间：20190730001723

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190730001723
SQL开始执行时间：20190730001723

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190730001726
SQL开始执行时间：20190730001726

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190730001726
SQL开始执行时间：20190730001726

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190730001726
SQL开始执行时间：20190730001726

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190730001726
SQL开始执行时间：20190730001726
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190730001726

20190731001706开始执行2019-07-30数据加载日志:
SQL开始执行时间：20190731001706
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190731001707
SQL开始执行时间：20190731001707

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190731001708
SQL开始执行时间：20190731001708
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190731001708
SQL开始执行时间：20190731001708

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190731001708
SQL开始执行时间：20190731001708





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190731001708
SQL开始执行时间：20190731001708


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190731001708
SQL开始执行时间：20190731001708

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190731001708
SQL开始执行时间：20190731001708
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190731001720
SQL开始执行时间：20190731001720

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190731001721
SQL开始执行时间：20190731001721


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190731001721
SQL开始执行时间：20190731001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190731001722
SQL开始执行时间：20190731001722

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190731001722
SQL开始执行时间：20190731001722

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190731001724
SQL开始执行时间：20190731001724

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190731001724
SQL开始执行时间：20190731001724

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190731001727
SQL开始执行时间：20190731001727

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190731001727
SQL开始执行时间：20190731001727

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190731001727
SQL开始执行时间：20190731001727

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190731001727
SQL开始执行时间：20190731001727
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190731001728

20190801001648开始执行2019-07-31数据加载日志:
SQL开始执行时间：20190801001648
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190801001648
SQL开始执行时间：20190801001648
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190801001648
SQL开始执行时间：20190801001648



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190801001648
SQL开始执行时间：20190801001648
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190801001650
SQL开始执行时间：20190801001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190801001650
SQL开始执行时间：20190801001650





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190801001650
SQL开始执行时间：20190801001650


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190801001650
SQL开始执行时间：20190801001650

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190801001650
SQL开始执行时间：20190801001650
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190801001701
SQL开始执行时间：20190801001701


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190801001702
SQL开始执行时间：20190801001702

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190801001702
SQL开始执行时间：20190801001702

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190801001702
SQL开始执行时间：20190801001702


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190801001702
SQL开始执行时间：20190801001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190801001703
SQL开始执行时间：20190801001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190801001703
SQL开始执行时间：20190801001703

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190801001706
SQL开始执行时间：20190801001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190801001706
SQL开始执行时间：20190801001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190801001709
SQL开始执行时间：20190801001709

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190801001709
SQL开始执行时间：20190801001709

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190801001709
SQL开始执行时间：20190801001709

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190801001709
SQL开始执行时间：20190801001709
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190801001709

20190802001702开始执行2019-08-01数据加载日志:
SQL开始执行时间：20190802001702
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190802001702
SQL开始执行时间：20190802001702
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190802001702
SQL开始执行时间：20190802001702



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190802001702
SQL开始执行时间：20190802001702
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190802001702
SQL开始执行时间：20190802001702

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190802001702
SQL开始执行时间：20190802001702

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190802001704
SQL开始执行时间：20190802001704

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190802001704
SQL开始执行时间：20190802001704





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190802001704
SQL开始执行时间：20190802001704


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190802001704
SQL开始执行时间：20190802001704

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190802001704
SQL开始执行时间：20190802001704
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190802001715
SQL开始执行时间：20190802001715

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190802001716
SQL开始执行时间：20190802001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190802001716
SQL开始执行时间：20190802001716

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190802001716
SQL开始执行时间：20190802001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190802001716
SQL开始执行时间：20190802001716

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190802001717
SQL开始执行时间：20190802001717

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190802001717
SQL开始执行时间：20190802001717

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190802001717
SQL开始执行时间：20190802001717

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190802001717
SQL开始执行时间：20190802001717
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190802001717

20190803001719开始执行2019-08-02数据加载日志:
SQL开始执行时间：20190803001719
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190803001719
SQL开始执行时间：20190803001719
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190803001721
SQL开始执行时间：20190803001721

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190803001721
SQL开始执行时间：20190803001721
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190803001732
SQL开始执行时间：20190803001732


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190803001733
SQL开始执行时间：20190803001733

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190803001734
SQL开始执行时间：20190803001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190803001734
SQL开始执行时间：20190803001734

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190803001734
SQL开始执行时间：20190803001734

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190803001734
SQL开始执行时间：20190803001734
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190803001734

20190804001709开始执行2019-08-03数据加载日志:
SQL开始执行时间：20190804001709
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190804001710
SQL开始执行时间：20190804001710
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190804001722
SQL开始执行时间：20190804001722


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190804001723
SQL开始执行时间：20190804001723

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190804001724
SQL开始执行时间：20190804001724

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190804001724
SQL开始执行时间：20190804001724

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190804001724
SQL开始执行时间：20190804001724

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190804001724
SQL开始执行时间：20190804001724
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190804001725

20190805001710开始执行2019-08-04数据加载日志:
SQL开始执行时间：20190805001710
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190805001710
SQL开始执行时间：20190805001710
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190805001710
SQL开始执行时间：20190805001710



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190805001710
SQL开始执行时间：20190805001710
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190805001710
SQL开始执行时间：20190805001710

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190805001710
SQL开始执行时间：20190805001710

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190805001710
SQL开始执行时间：20190805001710
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190805001710
SQL开始执行时间：20190805001710

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190805001711
SQL开始执行时间：20190805001711


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190805001712
SQL开始执行时间：20190805001712

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190805001712
SQL开始执行时间：20190805001712
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190805001723
SQL开始执行时间：20190805001723
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190805001724
SQL开始执行时间：20190805001724

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190805001725
SQL开始执行时间：20190805001725

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190805001725
SQL开始执行时间：20190805001725

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190805001725
SQL开始执行时间：20190805001725

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190805001725
SQL开始执行时间：20190805001725

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190805001725
SQL开始执行时间：20190805001725

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190805001725
SQL开始执行时间：20190805001725
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190805001726

20190806001649开始执行2019-08-05数据加载日志:
SQL开始执行时间：20190806001649
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190806001649
SQL开始执行时间：20190806001649
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190806001650
SQL开始执行时间：20190806001650


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190806001651
SQL开始执行时间：20190806001651

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190806001651
SQL开始执行时间：20190806001651
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190806001703
SQL开始执行时间：20190806001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190806001703
SQL开始执行时间：20190806001703

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190806001703
SQL开始执行时间：20190806001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190806001703
SQL开始执行时间：20190806001703

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190806001703
SQL开始执行时间：20190806001703

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190806001704
SQL开始执行时间：20190806001704
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190806001704

20190807001718开始执行2019-08-06数据加载日志:
SQL开始执行时间：20190807001718
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190807001718
SQL开始执行时间：20190807001718
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190807001718
SQL开始执行时间：20190807001718



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190807001718
SQL开始执行时间：20190807001718
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190807001720
SQL开始执行时间：20190807001720

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190807001721
SQL开始执行时间：20190807001721
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190807001732
SQL开始执行时间：20190807001732

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190807001733
SQL开始执行时间：20190807001733

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190807001733
SQL开始执行时间：20190807001733

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190807001733
SQL开始执行时间：20190807001733

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190807001733
SQL开始执行时间：20190807001733

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190807001734
SQL开始执行时间：20190807001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190807001734
SQL开始执行时间：20190807001734

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190807001734
SQL开始执行时间：20190807001734

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190807001734
SQL开始执行时间：20190807001734
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190807001734

20190808001647开始执行2019-08-07数据加载日志:
SQL开始执行时间：20190808001647
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190808001647
SQL开始执行时间：20190808001647
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190808001648
SQL开始执行时间：20190808001648
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190808001650
SQL开始执行时间：20190808001650

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190808001650
SQL开始执行时间：20190808001650
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190808001701
SQL开始执行时间：20190808001701

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190808001702
SQL开始执行时间：20190808001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190808001702
SQL开始执行时间：20190808001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190808001703
SQL开始执行时间：20190808001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190808001703
SQL开始执行时间：20190808001703

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190808001703
SQL开始执行时间：20190808001703

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190808001703
SQL开始执行时间：20190808001703
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190808001703

20190809001705开始执行2019-08-08数据加载日志:
SQL开始执行时间：20190809001705
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190809001705
SQL开始执行时间：20190809001705
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190809001706
SQL开始执行时间：20190809001706


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190809001707
SQL开始执行时间：20190809001707

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190809001707
SQL开始执行时间：20190809001707
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190809001717
SQL开始执行时间：20190809001717

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190809001718
SQL开始执行时间：20190809001718

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190809001718
SQL开始执行时间：20190809001718

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190809001719
SQL开始执行时间：20190809001719

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190809001719
SQL开始执行时间：20190809001719

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190809001719
SQL开始执行时间：20190809001719

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190809001719
SQL开始执行时间：20190809001719
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190809001719

20190812083932开始执行2019-08-11数据加载日志:
SQL开始执行时间：20190812083932
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190812083932
SQL开始执行时间：20190812083932
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190812083933
SQL开始执行时间：20190812083933


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190812083934
SQL开始执行时间：20190812083934

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190812083934
SQL开始执行时间：20190812083934
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190812083944
SQL开始执行时间：20190812083944

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190812083945
SQL开始执行时间：20190812083945

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190812083945
SQL开始执行时间：20190812083945


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190812083945
SQL开始执行时间：20190812083945

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190812083945
SQL开始执行时间：20190812083945

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190812083945
SQL开始执行时间：20190812083945

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190812083945
SQL开始执行时间：20190812083945

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190812083945
SQL开始执行时间：20190812083945

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190812083946
SQL开始执行时间：20190812083946

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190812083946
SQL开始执行时间：20190812083946

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190812083946
SQL开始执行时间：20190812083946

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190812083946
SQL开始执行时间：20190812083946
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190812083946

20190813001700开始执行2019-08-12数据加载日志:
SQL开始执行时间：20190813001700
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190813001700
SQL开始执行时间：20190813001700
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190813001701
SQL开始执行时间：20190813001701
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190813001703
SQL开始执行时间：20190813001703
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190813001714
SQL开始执行时间：20190813001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190813001715
SQL开始执行时间：20190813001715

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190813001715
SQL开始执行时间：20190813001715

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190813001716
SQL开始执行时间：20190813001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190813001716
SQL开始执行时间：20190813001716

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190813001716
SQL开始执行时间：20190813001716

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190813001716
SQL开始执行时间：20190813001716
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190813001716

20190814001659开始执行2019-08-13数据加载日志:
SQL开始执行时间：20190814001659
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190814001659
SQL开始执行时间：20190814001659
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190814001659
SQL开始执行时间：20190814001659



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190814001659
SQL开始执行时间：20190814001659
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190814001659
SQL开始执行时间：20190814001659

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190814001659
SQL开始执行时间：20190814001659

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190814001700
SQL开始执行时间：20190814001700





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190814001701
SQL开始执行时间：20190814001701


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190814001701
SQL开始执行时间：20190814001701

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190814001701
SQL开始执行时间：20190814001701
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190814001712
SQL开始执行时间：20190814001712

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190814001713
SQL开始执行时间：20190814001713

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190814001713
SQL开始执行时间：20190814001713

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190814001713
SQL开始执行时间：20190814001713

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190814001713
SQL开始执行时间：20190814001713

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190814001714
SQL开始执行时间：20190814001714

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190814001714
SQL开始执行时间：20190814001714

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190814001714
SQL开始执行时间：20190814001714

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190814001714
SQL开始执行时间：20190814001714
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190814001714

20190815001657开始执行2019-08-14数据加载日志:
SQL开始执行时间：20190815001657
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190815001658
SQL开始执行时间：20190815001658


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190815001659
SQL开始执行时间：20190815001659

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190815001659
SQL开始执行时间：20190815001659
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190815001710
SQL开始执行时间：20190815001710

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190815001711
SQL开始执行时间：20190815001711

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190815001711
SQL开始执行时间：20190815001711

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190815001712
SQL开始执行时间：20190815001712

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190815001712
SQL开始执行时间：20190815001712

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190815001712
SQL开始执行时间：20190815001712

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190815001712
SQL开始执行时间：20190815001712
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190815001712

20190816001653开始执行2019-08-15数据加载日志:
SQL开始执行时间：20190816001653
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190816001653
SQL开始执行时间：20190816001653
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190816001654
SQL开始执行时间：20190816001654


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190816001655
SQL开始执行时间：20190816001655

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190816001655
SQL开始执行时间：20190816001655
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190816001705
SQL开始执行时间：20190816001705


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190816001706
SQL开始执行时间：20190816001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190816001707
SQL开始执行时间：20190816001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190816001708
SQL开始执行时间：20190816001708

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190816001708
SQL开始执行时间：20190816001708

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190816001708
SQL开始执行时间：20190816001708
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190816001708

20190817001652开始执行2019-08-16数据加载日志:
SQL开始执行时间：20190817001652
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190817001652
SQL开始执行时间：20190817001652
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190817001653
SQL开始执行时间：20190817001653
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190817001654
SQL开始执行时间：20190817001654
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190817001706
SQL开始执行时间：20190817001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190817001706
SQL开始执行时间：20190817001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190817001706
SQL开始执行时间：20190817001706

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190817001706
SQL开始执行时间：20190817001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190817001707
SQL开始执行时间：20190817001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190817001707
SQL开始执行时间：20190817001707

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190817001708
SQL开始执行时间：20190817001708

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190817001708
SQL开始执行时间：20190817001708
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190817001708

20190818001622开始执行2019-08-17数据加载日志:
SQL开始执行时间：20190818001622
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190818001622
SQL开始执行时间：20190818001622
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190818001622
SQL开始执行时间：20190818001622



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190818001622
SQL开始执行时间：20190818001622
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190818001622
SQL开始执行时间：20190818001622

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190818001622
SQL开始执行时间：20190818001622

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190818001623
SQL开始执行时间：20190818001623





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190818001624
SQL开始执行时间：20190818001624


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190818001624
SQL开始执行时间：20190818001624

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190818001624
SQL开始执行时间：20190818001624
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190818001634
SQL开始执行时间：20190818001634


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190818001635
SQL开始执行时间：20190818001635

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190818001636
SQL开始执行时间：20190818001636

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190818001637
SQL开始执行时间：20190818001637

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190818001637
SQL开始执行时间：20190818001637

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190818001637
SQL开始执行时间：20190818001637
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190818001637

20190819001621开始执行2019-08-18数据加载日志:
SQL开始执行时间：20190819001621
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190819001621
SQL开始执行时间：20190819001621
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190819001621
SQL开始执行时间：20190819001621



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190819001621
SQL开始执行时间：20190819001621
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190819001621
SQL开始执行时间：20190819001621

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190819001621
SQL开始执行时间：20190819001621

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190819001622
SQL开始执行时间：20190819001622





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190819001623
SQL开始执行时间：20190819001623


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190819001623
SQL开始执行时间：20190819001623

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190819001623
SQL开始执行时间：20190819001623
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190819001633
SQL开始执行时间：20190819001633


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190819001634
SQL开始执行时间：20190819001634

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190819001634
SQL开始执行时间：20190819001634

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190819001634
SQL开始执行时间：20190819001634


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190819001634
SQL开始执行时间：20190819001634

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190819001634
SQL开始执行时间：20190819001634

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190819001634
SQL开始执行时间：20190819001634

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190819001635
SQL开始执行时间：20190819001635

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190819001635
SQL开始执行时间：20190819001635

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190819001635
SQL开始执行时间：20190819001635

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190819001635
SQL开始执行时间：20190819001635

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190819001635
SQL开始执行时间：20190819001635

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190819001636
SQL开始执行时间：20190819001636
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190819001636

20190820001623开始执行2019-08-19数据加载日志:
SQL开始执行时间：20190820001623
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190820001623
SQL开始执行时间：20190820001623
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190820001624
SQL开始执行时间：20190820001624
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190820001625
SQL开始执行时间：20190820001625



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190820001625
SQL开始执行时间：20190820001625

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190820001625
SQL开始执行时间：20190820001625
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190820001625
SQL开始执行时间：20190820001625

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190820001625
SQL开始执行时间：20190820001625





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190820001625
SQL开始执行时间：20190820001625


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190820001625
SQL开始执行时间：20190820001625

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190820001626
SQL开始执行时间：20190820001626
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190820001636
SQL开始执行时间：20190820001636

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190820001637
SQL开始执行时间：20190820001637

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190820001637
SQL开始执行时间：20190820001637

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190820001637
SQL开始执行时间：20190820001637

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190820001637
SQL开始执行时间：20190820001637

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190820001638
SQL开始执行时间：20190820001638

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190820001638
SQL开始执行时间：20190820001638

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190820001638
SQL开始执行时间：20190820001638

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190820001638
SQL开始执行时间：20190820001638
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190820001638

20190821001654开始执行2019-08-20数据加载日志:
SQL开始执行时间：20190821001654
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190821001654
SQL开始执行时间：20190821001654



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190821001655
SQL开始执行时间：20190821001655


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190821001656
SQL开始执行时间：20190821001656

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190821001656
SQL开始执行时间：20190821001656
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190821001708
SQL开始执行时间：20190821001708

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190821001708
SQL开始执行时间：20190821001708

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190821001708
SQL开始执行时间：20190821001708

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190821001708
SQL开始执行时间：20190821001708

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190821001708
SQL开始执行时间：20190821001708

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190821001708
SQL开始执行时间：20190821001708
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190821001708

20190822001641开始执行2019-08-21数据加载日志:
SQL开始执行时间：20190822001641
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190822001641
SQL开始执行时间：20190822001641
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190822001642
SQL开始执行时间：20190822001642
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190822001653
SQL开始执行时间：20190822001653

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190822001654
SQL开始执行时间：20190822001654

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190822001654
SQL开始执行时间：20190822001654

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190822001654
SQL开始执行时间：20190822001654

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190822001654
SQL开始执行时间：20190822001654

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190822001654
SQL开始执行时间：20190822001654

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190822001654
SQL开始执行时间：20190822001654
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190822001654

20190823001647开始执行2019-08-22数据加载日志:
SQL开始执行时间：20190823001647
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190823001647
SQL开始执行时间：20190823001647
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190823001648
SQL开始执行时间：20190823001648
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190823001649
SQL开始执行时间：20190823001649
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190823001701
SQL开始执行时间：20190823001701

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190823001701
SQL开始执行时间：20190823001701

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190823001701
SQL开始执行时间：20190823001701

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190823001701
SQL开始执行时间：20190823001701

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190823001701
SQL开始执行时间：20190823001701

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190823001701
SQL开始执行时间：20190823001701
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190823001701

20190824001708开始执行2019-08-23数据加载日志:
SQL开始执行时间：20190824001708
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190824001708
SQL开始执行时间：20190824001708
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190824001709
SQL开始执行时间：20190824001709


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190824001710
SQL开始执行时间：20190824001710

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190824001710
SQL开始执行时间：20190824001710
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190824001720
SQL开始执行时间：20190824001720

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190824001721
SQL开始执行时间：20190824001721
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190824001722

20190825001701开始执行2019-08-24数据加载日志:
SQL开始执行时间：20190825001701
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190825001701
SQL开始执行时间：20190825001701



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190825001703
SQL开始执行时间：20190825001703


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190825001703
SQL开始执行时间：20190825001703

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190825001703
SQL开始执行时间：20190825001703
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190825001715
SQL开始执行时间：20190825001715

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190825001716
SQL开始执行时间：20190825001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190825001716
SQL开始执行时间：20190825001716

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190825001716
SQL开始执行时间：20190825001716

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190825001716
SQL开始执行时间：20190825001716

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190825001716
SQL开始执行时间：20190825001716

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190825001716
SQL开始执行时间：20190825001716
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190825001716

20190826001656开始执行2019-08-25数据加载日志:
SQL开始执行时间：20190826001656
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190826001656
SQL开始执行时间：20190826001656
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190826001658
SQL开始执行时间：20190826001658


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190826001659
SQL开始执行时间：20190826001659

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190826001659
SQL开始执行时间：20190826001659
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190826001710
SQL开始执行时间：20190826001710

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190826001711
SQL开始执行时间：20190826001711

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190826001711
SQL开始执行时间：20190826001711

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190826001711
SQL开始执行时间：20190826001711

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190826001711
SQL开始执行时间：20190826001711
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190826001711

20190828085017开始执行2019-08-27数据加载日志:
SQL开始执行时间：20190828085017
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190828085017
SQL开始执行时间：20190828085017
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190828085017
SQL开始执行时间：20190828085017



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190828085017
SQL开始执行时间：20190828085017
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190828085017
SQL开始执行时间：20190828085017

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190828085017
SQL开始执行时间：20190828085017

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190828085017
SQL开始执行时间：20190828085017
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190828085018
SQL开始执行时间：20190828085018


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190828085019
SQL开始执行时间：20190828085019

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190828085019
SQL开始执行时间：20190828085019
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190828085029
SQL开始执行时间：20190828085029

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190828085030
SQL开始执行时间：20190828085030

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190828085030
SQL开始执行时间：20190828085030

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190828085030
SQL开始执行时间：20190828085030

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190828085030
SQL开始执行时间：20190828085030

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190828085030
SQL开始执行时间：20190828085030

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190828085030
SQL开始执行时间：20190828085030
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190828085030

20190829001701开始执行2019-08-28数据加载日志:
SQL开始执行时间：20190829001701
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190829001701
SQL开始执行时间：20190829001701
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190829001701
SQL开始执行时间：20190829001701



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190829001701
SQL开始执行时间：20190829001701
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190829001701
SQL开始执行时间：20190829001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190829001701
SQL开始执行时间：20190829001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190829001701
SQL开始执行时间：20190829001701
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190829001701
SQL开始执行时间：20190829001701

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190829001702
SQL开始执行时间：20190829001702


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190829001703
SQL开始执行时间：20190829001703

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190829001703
SQL开始执行时间：20190829001703
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190829001716

20190830001707开始执行2019-08-29数据加载日志:
SQL开始执行时间：20190830001707
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190830001707
SQL开始执行时间：20190830001707
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190830001708
SQL开始执行时间：20190830001708


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190830001709
SQL开始执行时间：20190830001709

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190830001709
SQL开始执行时间：20190830001709
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190830001721

20190831001636开始执行2019-08-30数据加载日志:
SQL开始执行时间：20190831001636
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190831001636
SQL开始执行时间：20190831001636
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190831001637
SQL开始执行时间：20190831001637


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190831001638
SQL开始执行时间：20190831001638

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190831001638
SQL开始执行时间：20190831001638
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190831001648
SQL开始执行时间：20190831001648

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190831001649
SQL开始执行时间：20190831001649
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190831001649

20190902094336开始执行2019-09-01数据加载日志:
SQL开始执行时间：20190902094336
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190902094336
SQL开始执行时间：20190902094336



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190902094337
SQL开始执行时间：20190902094337


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190902094338
SQL开始执行时间：20190902094338

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190902094338
SQL开始执行时间：20190902094338
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190902094348
SQL开始执行时间：20190902094348

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190902094349
SQL开始执行时间：20190902094349
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190902094349

20190903001651开始执行2019-09-02数据加载日志:
SQL开始执行时间：20190903001651
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190903001651
SQL开始执行时间：20190903001651
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190903001652
SQL开始执行时间：20190903001652


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190903001653
SQL开始执行时间：20190903001653

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190903001653
SQL开始执行时间：20190903001653
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190903001703
SQL开始执行时间：20190903001703

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190903001704
SQL开始执行时间：20190903001704
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190903001704

20190904104507开始执行2019-09-03数据加载日志:
SQL开始执行时间：20190904104507
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190904104507
SQL开始执行时间：20190904104507
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190904104508
SQL开始执行时间：20190904104508
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190904104517
SQL开始执行时间：20190904104517

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190904104517
SQL开始执行时间：20190904104517
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190904104517
SQL开始执行时间：20190904104517
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190904104517
SQL开始执行时间：20190904104517
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190904104517
SQL开始执行时间：20190904104517
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190904104517
SQL开始执行时间：20190904104517
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190904104518
SQL开始执行时间：20190904104518

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190904104519
SQL开始执行时间：20190904104519
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190904104519

20190905001650开始执行2019-09-04数据加载日志:
SQL开始执行时间：20190905001650
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190905001650
SQL开始执行时间：20190905001650
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190905001650
SQL开始执行时间：20190905001650



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190905001650
SQL开始执行时间：20190905001650
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190905001650
SQL开始执行时间：20190905001650

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190905001650
SQL开始执行时间：20190905001650

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190905001651
SQL开始执行时间：20190905001651

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190905001652
SQL开始执行时间：20190905001652





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190905001652
SQL开始执行时间：20190905001652


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190905001652
SQL开始执行时间：20190905001652

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190905001652
SQL开始执行时间：20190905001652
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190905001702
SQL开始执行时间：20190905001702

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190905001703
SQL开始执行时间：20190905001703

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190905001704
SQL开始执行时间：20190905001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190905001704
SQL开始执行时间：20190905001704

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190905001704
SQL开始执行时间：20190905001704

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190905001704
SQL开始执行时间：20190905001704
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190905001704

20190906001651开始执行2019-09-05数据加载日志:
SQL开始执行时间：20190906001651
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190906001651
SQL开始执行时间：20190906001651
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190906001651
SQL开始执行时间：20190906001651



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190906001651
SQL开始执行时间：20190906001651
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190906001652
SQL开始执行时间：20190906001652



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190906001653
SQL开始执行时间：20190906001653

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190906001653
SQL开始执行时间：20190906001653
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190906001653
SQL开始执行时间：20190906001653

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190906001653
SQL开始执行时间：20190906001653





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190906001653
SQL开始执行时间：20190906001653


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190906001653
SQL开始执行时间：20190906001653

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190906001653
SQL开始执行时间：20190906001653
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190906001704
SQL开始执行时间：20190906001704

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190906001705
SQL开始执行时间：20190906001705

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190906001705
SQL开始执行时间：20190906001705

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190906001705
SQL开始执行时间：20190906001705

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190906001705
SQL开始执行时间：20190906001705

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190906001705
SQL开始执行时间：20190906001705

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190906001705
SQL开始执行时间：20190906001705
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190906001705

20190907001705开始执行2019-09-06数据加载日志:
SQL开始执行时间：20190907001705
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190907001705
SQL开始执行时间：20190907001705
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190907001705
SQL开始执行时间：20190907001705



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190907001705
SQL开始执行时间：20190907001705
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190907001705
SQL开始执行时间：20190907001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190907001705
SQL开始执行时间：20190907001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190907001706
SQL开始执行时间：20190907001706





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190907001707
SQL开始执行时间：20190907001707


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190907001707
SQL开始执行时间：20190907001707

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190907001707
SQL开始执行时间：20190907001707
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190907001718
SQL开始执行时间：20190907001718

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190907001719
SQL开始执行时间：20190907001719

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190907001719
SQL开始执行时间：20190907001719

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190907001719
SQL开始执行时间：20190907001719

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190907001719
SQL开始执行时间：20190907001719

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190907001719
SQL开始执行时间：20190907001719

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190907001719
SQL开始执行时间：20190907001719
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190907001719

20190908001705开始执行2019-09-07数据加载日志:
SQL开始执行时间：20190908001705
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190908001705
SQL开始执行时间：20190908001705
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190908001706
SQL开始执行时间：20190908001706


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190908001707
SQL开始执行时间：20190908001707

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190908001707
SQL开始执行时间：20190908001707
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190908001717
SQL开始执行时间：20190908001717

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190908001719

20190909001656开始执行2019-09-08数据加载日志:
SQL开始执行时间：20190909001656
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190909001656
SQL开始执行时间：20190909001656
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190909001657
SQL开始执行时间：20190909001657


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190909001658
SQL开始执行时间：20190909001658

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190909001658
SQL开始执行时间：20190909001658
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190909001708
SQL开始执行时间：20190909001708

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190909001709
SQL开始执行时间：20190909001709

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190909001709
SQL开始执行时间：20190909001709

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190909001709
SQL开始执行时间：20190909001709

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190909001709
SQL开始执行时间：20190909001709

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190909001709
SQL开始执行时间：20190909001709

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190909001709
SQL开始执行时间：20190909001709
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190909001709

20190910001648开始执行2019-09-09数据加载日志:
SQL开始执行时间：20190910001648
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190910001648
SQL开始执行时间：20190910001648
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190910001649
SQL开始执行时间：20190910001649



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190910001650
SQL开始执行时间：20190910001650
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190910001650
SQL开始执行时间：20190910001650



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190910001650
SQL开始执行时间：20190910001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190910001650
SQL开始执行时间：20190910001650
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190910001650
SQL开始执行时间：20190910001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190910001650
SQL开始执行时间：20190910001650





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190910001650
SQL开始执行时间：20190910001650


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190910001651
SQL开始执行时间：20190910001651

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190910001651
SQL开始执行时间：20190910001651
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190910001701
SQL开始执行时间：20190910001701


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190910001702
SQL开始执行时间：20190910001702

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190910001703
SQL开始执行时间：20190910001703

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190910001703
SQL开始执行时间：20190910001703
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190910001703

20190911001648开始执行2019-09-10数据加载日志:
SQL开始执行时间：20190911001648
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190911001648
SQL开始执行时间：20190911001648
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190911001649
SQL开始执行时间：20190911001649



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190911001650
SQL开始执行时间：20190911001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190911001650
SQL开始执行时间：20190911001650
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190911001650
SQL开始执行时间：20190911001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190911001650
SQL开始执行时间：20190911001650





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190911001650
SQL开始执行时间：20190911001650


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190911001650
SQL开始执行时间：20190911001650

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190911001650
SQL开始执行时间：20190911001650
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190911001701
SQL开始执行时间：20190911001701

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190911001702
SQL开始执行时间：20190911001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190911001702
SQL开始执行时间：20190911001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190911001702
SQL开始执行时间：20190911001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190911001702
SQL开始执行时间：20190911001702

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190911001702
SQL开始执行时间：20190911001702

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190911001702
SQL开始执行时间：20190911001702
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190911001702

20190912001657开始执行2019-09-11数据加载日志:
SQL开始执行时间：20190912001657
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190912001657
SQL开始执行时间：20190912001657
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190912001658
SQL开始执行时间：20190912001658
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190912001659
SQL开始执行时间：20190912001659
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190912001710
SQL开始执行时间：20190912001710

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190912001711
SQL开始执行时间：20190912001711
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190912001711

20190913001707开始执行2019-09-12数据加载日志:
SQL开始执行时间：20190913001707
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190913001707
SQL开始执行时间：20190913001707
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190913001707
SQL开始执行时间：20190913001707



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190913001707
SQL开始执行时间：20190913001707
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190913001707
SQL开始执行时间：20190913001707

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190913001708
SQL开始执行时间：20190913001708

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190913001709
SQL开始执行时间：20190913001709
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190913001709
SQL开始执行时间：20190913001709

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190913001709
SQL开始执行时间：20190913001709





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190913001709
SQL开始执行时间：20190913001709


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190913001709
SQL开始执行时间：20190913001709

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190913001709
SQL开始执行时间：20190913001709
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190913001721
SQL开始执行时间：20190913001721

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190913001722
SQL开始执行时间：20190913001722

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190913001722
SQL开始执行时间：20190913001722

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190913001722
SQL开始执行时间：20190913001722

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190913001722
SQL开始执行时间：20190913001722
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190913001722

20190914001754开始执行2019-09-13数据加载日志:
SQL开始执行时间：20190914001754
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190914001754
SQL开始执行时间：20190914001754
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190914001754
SQL开始执行时间：20190914001754



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190914001754
SQL开始执行时间：20190914001754
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190914001754
SQL开始执行时间：20190914001754

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190914001754
SQL开始执行时间：20190914001754

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190914001754
SQL开始执行时间：20190914001754
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190914001754
SQL开始执行时间：20190914001754

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190914001755
SQL开始执行时间：20190914001755





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190914001756
SQL开始执行时间：20190914001756


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190914001756
SQL开始执行时间：20190914001756

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190914001756
SQL开始执行时间：20190914001756
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190914001806
SQL开始执行时间：20190914001806


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190914001807
SQL开始执行时间：20190914001807

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190914001808
SQL开始执行时间：20190914001808

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190914001808
SQL开始执行时间：20190914001808

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190914001808
SQL开始执行时间：20190914001808
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190914001808

20190915001649开始执行2019-09-14数据加载日志:
SQL开始执行时间：20190915001649
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190915001649
SQL开始执行时间：20190915001649



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190915001650
SQL开始执行时间：20190915001650





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190915001651
SQL开始执行时间：20190915001651


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190915001651
SQL开始执行时间：20190915001651

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190915001651
SQL开始执行时间：20190915001651
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190915001702
SQL开始执行时间：20190915001702

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190915001703
SQL开始执行时间：20190915001703

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190915001703
SQL开始执行时间：20190915001703

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190915001703
SQL开始执行时间：20190915001703

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190915001703
SQL开始执行时间：20190915001703
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190915001703

20190916001653开始执行2019-09-15数据加载日志:
SQL开始执行时间：20190916001653
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190916001653
SQL开始执行时间：20190916001653
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190916001653
SQL开始执行时间：20190916001653



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190916001653
SQL开始执行时间：20190916001653
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190916001653
SQL开始执行时间：20190916001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190916001653
SQL开始执行时间：20190916001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190916001653
SQL开始执行时间：20190916001653
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190916001653
SQL开始执行时间：20190916001653

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190916001654
SQL开始执行时间：20190916001654





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190916001655
SQL开始执行时间：20190916001655


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190916001655
SQL开始执行时间：20190916001655

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190916001655
SQL开始执行时间：20190916001655
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190916001706
SQL开始执行时间：20190916001706

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190916001707
SQL开始执行时间：20190916001707
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190916001707

20190917001719开始执行2019-09-16数据加载日志:
SQL开始执行时间：20190917001719
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190917001719
SQL开始执行时间：20190917001719
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190917001719
SQL开始执行时间：20190917001719



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190917001719
SQL开始执行时间：20190917001719
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190917001719
SQL开始执行时间：20190917001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190917001719
SQL开始执行时间：20190917001719

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190917001720
SQL开始执行时间：20190917001720
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190917001721
SQL开始执行时间：20190917001721

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190917001721
SQL开始执行时间：20190917001721





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190917001721
SQL开始执行时间：20190917001721


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190917001721
SQL开始执行时间：20190917001721

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190917001721
SQL开始执行时间：20190917001721
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190917001733
SQL开始执行时间：20190917001733

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190917001734
SQL开始执行时间：20190917001734
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190917001734

20190918001725开始执行2019-09-17数据加载日志:
SQL开始执行时间：20190918001725
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190918001725
SQL开始执行时间：20190918001725
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190918001725
SQL开始执行时间：20190918001725



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190918001725
SQL开始执行时间：20190918001725
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190918001725
SQL开始执行时间：20190918001725

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190918001726
SQL开始执行时间：20190918001726



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190918001739
SQL开始执行时间：20190918001739

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190918001740
SQL开始执行时间：20190918001740
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190918001740

20190919001717开始执行2019-09-18数据加载日志:
SQL开始执行时间：20190919001717
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190919001717
SQL开始执行时间：20190919001717
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190919001719
SQL开始执行时间：20190919001719


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190919001720
SQL开始执行时间：20190919001720

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190919001720
SQL开始执行时间：20190919001720
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190919001731
SQL开始执行时间：20190919001731

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190919001732
SQL开始执行时间：20190919001732

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190919001733
SQL开始执行时间：20190919001733

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190919001733
SQL开始执行时间：20190919001733

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190919001733
SQL开始执行时间：20190919001733
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190919001733

20190920001730开始执行2019-09-19数据加载日志:
SQL开始执行时间：20190920001730
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190920001732
SQL开始执行时间：20190920001732


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190920001733
SQL开始执行时间：20190920001733

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190920001733
SQL开始执行时间：20190920001733
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190920001744
SQL开始执行时间：20190920001744

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190920001745

20190921001721开始执行2019-09-20数据加载日志:
SQL开始执行时间：20190921001721
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190921001721
SQL开始执行时间：20190921001721
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190921001721
SQL开始执行时间：20190921001721



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190921001721
SQL开始执行时间：20190921001721
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190921001722
SQL开始执行时间：20190921001722
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190921001724
SQL开始执行时间：20190921001724

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190921001724
SQL开始执行时间：20190921001724
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190921001735
SQL开始执行时间：20190921001735

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190921001736
SQL开始执行时间：20190921001736

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190921001736
SQL开始执行时间：20190921001736

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190921001736
SQL开始执行时间：20190921001736

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190921001736
SQL开始执行时间：20190921001736

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190921001736
SQL开始执行时间：20190921001736

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190921001736
SQL开始执行时间：20190921001736
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190921001736

20190922001727开始执行2019-09-21数据加载日志:
SQL开始执行时间：20190922001727
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190922001727
SQL开始执行时间：20190922001727
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190922001727
SQL开始执行时间：20190922001727



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190922001727
SQL开始执行时间：20190922001727
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190922001727
SQL开始执行时间：20190922001727

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190922001727
SQL开始执行时间：20190922001727

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190922001740
SQL开始执行时间：20190922001740

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190922001741
SQL开始执行时间：20190922001741
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190922001741

20190923001813开始执行2019-09-22数据加载日志:
SQL开始执行时间：20190923001813
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190923001813
SQL开始执行时间：20190923001813
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190923001814
SQL开始执行时间：20190923001814



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190923001815
SQL开始执行时间：20190923001815

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190923001815
SQL开始执行时间：20190923001815
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190923001815
SQL开始执行时间：20190923001815

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190923001815
SQL开始执行时间：20190923001815





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190923001815
SQL开始执行时间：20190923001815


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190923001816
SQL开始执行时间：20190923001816

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190923001816
SQL开始执行时间：20190923001816
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190923001826
SQL开始执行时间：20190923001826

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190923001827
SQL开始执行时间：20190923001827

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190923001827
SQL开始执行时间：20190923001827

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190923001827
SQL开始执行时间：20190923001827

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190923001827
SQL开始执行时间：20190923001827
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190923001827

20190924001728开始执行2019-09-23数据加载日志:
SQL开始执行时间：20190924001728
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190924001728
SQL开始执行时间：20190924001728



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190924001729
SQL开始执行时间：20190924001729


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190924001730
SQL开始执行时间：20190924001730

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190924001730
SQL开始执行时间：20190924001730
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190924001743
SQL开始执行时间：20190924001743

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190924001743
SQL开始执行时间：20190924001743

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190924001743
SQL开始执行时间：20190924001743

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190924001743
SQL开始执行时间：20190924001743

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190924001743
SQL开始执行时间：20190924001743

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190924001743
SQL开始执行时间：20190924001743
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190924001743

20190925090423开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190925090423
drop table if exists edw.oa_fnabudgetinfo_pre
;
SQL结束执行时间：20190925090423
SQL开始执行时间：20190925090423
create temporary table edw.oa_fnabudgetinfo_pre as
select a.id
      ,a.budgetorganizationid
      ,b.departmentmark as cdepname
      ,b.tlevel
      ,a.remark
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 2
;
SQL结束执行时间：20190925090423
SQL开始执行时间：20190925090423



drop table if exists edw.oa_fnabudgetinfo_pre1
;
SQL结束执行时间：20190925090423
SQL开始执行时间：20190925090423
create temporary table edw.oa_fnabudgetinfo_pre1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190925090423
SQL开始执行时间：20190925090423

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424
 
insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
  left join ufdata.oa_hrmdepartment b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424

insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null' as person
      ,a.status
  from edw.oa_fnabudgetinfo_pre a
 where a.tlevel = 2
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424



insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,null
      ,b.subcompanyname as cdepname_lv1
      ,b.subcompanyname
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,'null'
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmsubcompany b
    on a.budgetorganizationid = b.id
 where a.organizationtype = 0
    or a.organizationtype = 1
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424

drop table if exists edw.oa_fnabudgetinfo_ren
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424
create temporary table edw.oa_fnabudgetinfo_ren as
select a.id
      ,a.remark
      ,b.departmentid
      ,c.departmentmark as cdepname
      ,c.tlevel
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,b.lastname as person
      ,a.status
  from ufdata.oa_fnabudgetinfo a
  left join ufdata.oa_hrmresource b
    on a.budgetorganizationid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.departmentid = c.id
 where a.organizationtype = 3
   and c.tlevel is not null
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424



drop table if exists edw.oa_fnabudgetinfo_ren1
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424
create temporary table edw.oa_fnabudgetinfo_ren1 as
select a.id
      ,a.cdepname as cdepname_lv6
      ,c.departmentmark as cdepname_lv5
      ,d.departmentmark as cdepname_lv4
      ,e.departmentmark as cdepname_lv3
      ,f.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
  left join ufdata.oa_hrmdepartment f
    on e.supdepid = f.id
 where a.tlevel = 6
;
SQL结束执行时间：20190925090424
SQL开始执行时间：20190925090424



insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,a.cdepname as cdepname_lv5
      ,c.departmentmark as cdepname_lv4
      ,d.departmentmark as cdepname_lv3
      ,e.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
  left join ufdata.oa_hrmdepartment e
    on d.supdepid = e.id
 where a.tlevel = 5
;
SQL结束执行时间：20190925090425
SQL开始执行时间：20190925090425

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,a.cdepname as cdepname_lv4
      ,c.departmentmark as cdepname_lv3
      ,d.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
  left join ufdata.oa_hrmdepartment d
    on c.supdepid = d.id
 where a.tlevel = 4
;
SQL结束执行时间：20190925090425
SQL开始执行时间：20190925090425
 
insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv3
      ,c.departmentmark as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
  left join ufdata.oa_hrmdepartment b
    on a.departmentid = b.id
  left join ufdata.oa_hrmdepartment c
    on b.supdepid = c.id
 where a.tlevel = 3
;
SQL结束执行时间：20190925090425
SQL开始执行时间：20190925090425

insert into edw.oa_fnabudgetinfo_ren1
select a.id
      ,null
      ,null
      ,null
      ,null
      ,a.cdepname as cdepname_lv2
      ,'1111111111111111' as cdepname_lv1
      ,a.cdepname as budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren a
 where a.tlevel = 2
;
SQL结束执行时间：20190925090425
SQL开始执行时间：20190925090425





insert into edw.oa_fnabudgetinfo_pre1
select a.id
      ,a.cdepname_lv6
      ,a.cdepname_lv5
      ,a.cdepname_lv4
      ,a.cdepname_lv3
      ,a.cdepname_lv2
      ,a.cdepname_lv1
      ,a.budget_depnam
      ,a.remark
      ,a.createdate
      ,a.createrid
      ,a.approverid
      ,a.person
      ,a.status
  from edw.oa_fnabudgetinfo_ren1 a

;
SQL结束执行时间：20190925090425
SQL开始执行时间：20190925090425


create index index_oa_fnabudgetinfo_pre_id on edw.oa_fnabudgetinfo_pre1(id)
;
SQL结束执行时间：20190925090425
SQL开始执行时间：20190925090425

truncate table edw.oa_budget_19
;
SQL结束执行时间：20190925090425
SQL开始执行时间：20190925090425
insert into edw.oa_budget_19
select a.budgetinfoid
      ,case when b.cdepname_lv1 = '1111111111111111' then null
       else b.cdepname_lv1 end as cdepname_lv1
      ,b.cdepname_lv2
      ,b.cdepname_lv3
      ,b.cdepname_lv4
      ,b.cdepname_lv5
      ,b.cdepname_lv6
      ,case when b.person = 'null' then null
       else b.person end as person
      ,b.budget_depnam
      ,null
      ,null
      ,c.name
      ,case when c.name = '6602人才推荐费' then '66020202' else e.u8kemubm end  as u8kemubm
      ,case when d.cdztlx = '0' then  '个人'
       else '部门' end as cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,b.createdate
      ,case when b.approverid is null then 'crm' else b.approverid end
      ,case when b.createrid = '1' then 'crm' else b.createrid end
      ,a.budgetremark
      ,a.fnaincrement
      ,b.remark
      ,localtimestamp() as sys_time
  from (select * from ufdata.oa_fnabudgetinfodetail where budgetperiods = 21 ) a
  left join edw.oa_fnabudgetinfo_pre1 b
    on a.budgetinfoid  = b.id
  left join ufdata.oa_fnabudgetfeetype c
    on a.budgettypeid = c.id
  left join ufdata.oa_uf_yslxb d
    on c.id = d.yskm
  left join ufdata.oa_uf_u8dykm e
    on c.name = e.kemumc
 where b.status = 1
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436

update edw.oa_budget_19 set name_oa = '销售一区' where person = '邓志良'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '销售二区' where person = '何珊'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '浙江省区' where person = '乔国付'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '产品推广部' where person = '史勤华'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '战略市场中心' where person = '游英'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '销售部' where person = '张志坚'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '上海技术支持组' where person = '晁建文' and name = '6601业务招待费'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '财务中心' where person = '俞晓'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436
update edw.oa_budget_19 set name_oa = '行政部' where person = '刘英'
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436


create temporary table edw.oa_budget_19_11 as 
select * 
  from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436

create temporary table edw.oa_budget_19_22 as
select *
  from edw.oa_budget_19_11
where sixth_dept is not null
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436

delete FROM edw.oa_budget_19 where person is null and CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept,fifth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436


insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
  and sixth_dept is null

;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept,fourth_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null

;
SQL结束执行时间：20190925090436
SQL开始执行时间：20190925090436

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept,third_dept) in (select CONCAT(name,budgetperiodslist,second_dept,third_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190925090437
SQL开始执行时间：20190925090437

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where fifth_dept is not null 
and sixth_dept is null
and fourth_dept is null
and third_dept is null
;
SQL结束执行时间：20190925090437
SQL开始执行时间：20190925090437

delete FROM edw.oa_budget_19_11 where person is null and  CONCAT(name,budgetperiodslist,second_dept) in (select CONCAT(name,budgetperiodslist,second_dept) from edw.oa_budget_19_22)
;
SQL结束执行时间：20190925090437
SQL开始执行时间：20190925090437

insert into edw.oa_budget_19_22
select *
  from edw.oa_budget_19_11
where second_dept is not null 
and third_dept is null
and fourth_dept is null
and fifth_dept is null
and sixth_dept is null
;
SQL结束执行时间：20190925090437
SQL开始执行时间：20190925090437

delete from edw.oa_budget_19
 where cdepname_lv1 is null
   and person is null
;
SQL结束执行时间：20190925090437
SQL开始执行时间：20190925090437

insert into edw.oa_budget_19
select a. budgetinfoid
      ,a.cdepname_lv1
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.person
      ,a.name_oa
      ,null
      ,null
      ,a.name
      ,a.u8kemubm
      ,a.cdlx
      ,a.budgetperiodslist
      ,a.budgetaccount
      ,a.createdate
      ,a.approverid
      ,a.createrid
      ,a.budgetremark
      ,a.fnaincrement
      ,a.remark
      ,localtimestamp() as sys_time
  from edw.oa_budget_19_22 a
;
SQL结束执行时间：20190925090437
SQL开始执行时间：20190925090437
  
update edw.oa_budget_19 as a
inner join (select * from edw.dic_deptment where source = 'OA'  group by cdept_name) as b
on a.name_oa = b.cdept_name
set 
  a.name_ehr = b.name_ehr
 ,a.name_ehr_id = b.cdept_id_ehr
 ,a.second_dept = b.second_dept
 ,a.third_dept = b.third_dept
 ,a.fourth_dept = b.fourth_dept
 ,a.fifth_dept = b.fifth_dept
 ,a.sixth_dept = b.sixth_dept

;
SQL结束执行时间：20190925090437
