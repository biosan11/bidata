
20190103112843开始执行2019-01-02数据加载日志:
SQL开始执行时间：20190103112843
/*
drop table if exists edw.ar_detail
;

20190103125234开始执行2019-01-02数据加载日志:
SQL开始执行时间：20190103125234



use edw
;
SQL结束执行时间：20190103125234
SQL开始执行时间：20190103125234

truncate table edw.ar_detail
;
SQL结束执行时间：20190103125234
SQL开始执行时间：20190103125234


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190103125234
SQL开始执行时间：20190103125234


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190103125237

20190104001055开始执行2019-01-03数据加载日志:
SQL开始执行时间：20190104001055



use edw
;
SQL结束执行时间：20190104001055
SQL开始执行时间：20190104001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190104001055
SQL开始执行时间：20190104001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190104001055
SQL开始执行时间：20190104001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190104001058

20190105001055开始执行2019-01-04数据加载日志:
SQL开始执行时间：20190105001055



use edw
;
SQL结束执行时间：20190105001055
SQL开始执行时间：20190105001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190105001055
SQL开始执行时间：20190105001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190105001055
SQL开始执行时间：20190105001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190105001058

20190106001055开始执行2019-01-05数据加载日志:
SQL开始执行时间：20190106001055



use edw
;
SQL结束执行时间：20190106001055
SQL开始执行时间：20190106001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190106001055
SQL开始执行时间：20190106001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190106001055
SQL开始执行时间：20190106001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190106001058

20190107001057开始执行2019-01-06数据加载日志:
SQL开始执行时间：20190107001057



use edw
;
SQL结束执行时间：20190107001057
SQL开始执行时间：20190107001057

truncate table edw.ar_detail
;
SQL结束执行时间：20190107001057
SQL开始执行时间：20190107001057


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190107001057
SQL开始执行时间：20190107001057


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190107001100

20190108001056开始执行2019-01-07数据加载日志:
SQL开始执行时间：20190108001056



use edw
;
SQL结束执行时间：20190108001056
SQL开始执行时间：20190108001056

truncate table edw.ar_detail
;
SQL结束执行时间：20190108001056
SQL开始执行时间：20190108001056


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190108001056
SQL开始执行时间：20190108001056


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190108001058

20190109001056开始执行2019-01-08数据加载日志:
SQL开始执行时间：20190109001056



use edw
;
SQL结束执行时间：20190109001056
SQL开始执行时间：20190109001056

truncate table edw.ar_detail
;
SQL结束执行时间：20190109001056
SQL开始执行时间：20190109001056


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190109001056
SQL开始执行时间：20190109001056


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190109001058

20190110001053开始执行2019-01-09数据加载日志:
SQL开始执行时间：20190110001053



use edw
;
SQL结束执行时间：20190110001053
SQL开始执行时间：20190110001053

truncate table edw.ar_detail
;
SQL结束执行时间：20190110001053
SQL开始执行时间：20190110001053


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190110001053
SQL开始执行时间：20190110001053


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190110001056

20190111001058开始执行2019-01-10数据加载日志:
SQL开始执行时间：20190111001058



use edw
;
SQL结束执行时间：20190111001058
SQL开始执行时间：20190111001058

truncate table edw.ar_detail
;
SQL结束执行时间：20190111001058
SQL开始执行时间：20190111001058


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190111001058
SQL开始执行时间：20190111001058


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190111001101

20190112001055开始执行2019-01-11数据加载日志:
SQL开始执行时间：20190112001055



use edw
;
SQL结束执行时间：20190112001055
SQL开始执行时间：20190112001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190112001055
SQL开始执行时间：20190112001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190112001055
SQL开始执行时间：20190112001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190112001058

20190113001055开始执行2019-01-12数据加载日志:
SQL开始执行时间：20190113001055



use edw
;
SQL结束执行时间：20190113001055
SQL开始执行时间：20190113001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190113001056
SQL开始执行时间：20190113001056


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190113001056
SQL开始执行时间：20190113001056


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190113001058

20190114001055开始执行2019-01-13数据加载日志:
SQL开始执行时间：20190114001055



use edw
;
SQL结束执行时间：20190114001055
SQL开始执行时间：20190114001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190114001055
SQL开始执行时间：20190114001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190114001055
SQL开始执行时间：20190114001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190114001058

20190115001057开始执行2019-01-14数据加载日志:
SQL开始执行时间：20190115001057



use edw
;
SQL结束执行时间：20190115001057
SQL开始执行时间：20190115001057

truncate table edw.ar_detail
;
SQL结束执行时间：20190115001057
SQL开始执行时间：20190115001057


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190115001057
SQL开始执行时间：20190115001057


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190115001059

20190116001055开始执行2019-01-15数据加载日志:
SQL开始执行时间：20190116001055



use edw
;
SQL结束执行时间：20190116001055
SQL开始执行时间：20190116001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190116001055
SQL开始执行时间：20190116001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190116001055
SQL开始执行时间：20190116001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190116001057

20190117001055开始执行2019-01-16数据加载日志:
SQL开始执行时间：20190117001055



use edw
;
SQL结束执行时间：20190117001055
SQL开始执行时间：20190117001055

truncate table edw.ar_detail
;
SQL结束执行时间：20190117001055
SQL开始执行时间：20190117001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190117001055
SQL开始执行时间：20190117001055


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190117001057

20190118001057开始执行2019-01-17数据加载日志:
SQL开始执行时间：20190118001057



use edw
;
SQL结束执行时间：20190118001057
SQL开始执行时间：20190118001057

truncate table edw.ar_detail
;
SQL结束执行时间：20190118001057
SQL开始执行时间：20190118001057


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190118001057
SQL开始执行时间：20190118001057


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190118001100

20190122164759开始执行2019-01-21数据加载日志:
SQL开始执行时间：20190122164759



use edw
;
SQL结束执行时间：20190122164759
SQL开始执行时间：20190122164759

truncate table edw.ar_detail
;
SQL结束执行时间：20190122164759
SQL开始执行时间：20190122164759


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190122164759
SQL开始执行时间：20190122164759


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190122164802

20190123001052开始执行2019-01-22数据加载日志:
SQL开始执行时间：20190123001052



use edw
;
SQL结束执行时间：20190123001052
SQL开始执行时间：20190123001052

truncate table edw.ar_detail
;
SQL结束执行时间：20190123001052
SQL开始执行时间：20190123001052


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190123001053
SQL开始执行时间：20190123001053


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190123001055

20190124001103开始执行2019-01-23数据加载日志:
SQL开始执行时间：20190124001103



use edw
;
SQL结束执行时间：20190124001103
SQL开始执行时间：20190124001103

truncate table edw.ar_detail
;
SQL结束执行时间：20190124001103
SQL开始执行时间：20190124001103


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190124001103
SQL开始执行时间：20190124001103


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190124001106

20190126001045开始执行2019-01-25数据加载日志:
SQL开始执行时间：20190126001046



use edw
;
SQL结束执行时间：20190126001046
SQL开始执行时间：20190126001046

truncate table edw.ar_detail
;
SQL结束执行时间：20190126001046
SQL开始执行时间：20190126001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190126001046
SQL开始执行时间：20190126001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190126001048

20190127001044开始执行2019-01-26数据加载日志:
SQL开始执行时间：20190127001044



use edw
;
SQL结束执行时间：20190127001044
SQL开始执行时间：20190127001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190127001044
SQL开始执行时间：20190127001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190127001044
SQL开始执行时间：20190127001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190127001047

20190128001044开始执行2019-01-27数据加载日志:
SQL开始执行时间：20190128001044



use edw
;
SQL结束执行时间：20190128001044
SQL开始执行时间：20190128001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190128001044
SQL开始执行时间：20190128001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190128001044
SQL开始执行时间：20190128001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190128001047

20190129001044开始执行2019-01-28数据加载日志:
SQL开始执行时间：20190129001044



use edw
;
SQL结束执行时间：20190129001044
SQL开始执行时间：20190129001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190129001044
SQL开始执行时间：20190129001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190129001044
SQL开始执行时间：20190129001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190129001046

20190130001044开始执行2019-01-29数据加载日志:
SQL开始执行时间：20190130001044



use edw
;
SQL结束执行时间：20190130001044
SQL开始执行时间：20190130001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190130001044
SQL开始执行时间：20190130001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190130001044
SQL开始执行时间：20190130001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190130001047

20190131001044开始执行2019-01-30数据加载日志:
SQL开始执行时间：20190131001044



use edw
;
SQL结束执行时间：20190131001044
SQL开始执行时间：20190131001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190131001044
SQL开始执行时间：20190131001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190131001044
SQL开始执行时间：20190131001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190131001047

20190201001044开始执行2019-01-31数据加载日志:
SQL开始执行时间：20190201001044



use edw
;
SQL结束执行时间：20190201001044
SQL开始执行时间：20190201001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190201001044
SQL开始执行时间：20190201001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190201001044
SQL开始执行时间：20190201001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190201001047

20190202001044开始执行2019-02-01数据加载日志:
SQL开始执行时间：20190202001044



use edw
;
SQL结束执行时间：20190202001044
SQL开始执行时间：20190202001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190202001044
SQL开始执行时间：20190202001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190202001044
SQL开始执行时间：20190202001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190202001046

20190203001045开始执行2019-02-02数据加载日志:
SQL开始执行时间：20190203001045



use edw
;
SQL结束执行时间：20190203001045
SQL开始执行时间：20190203001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190203001045
SQL开始执行时间：20190203001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190203001045
SQL开始执行时间：20190203001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190203001048

20190204001043开始执行2019-02-03数据加载日志:
SQL开始执行时间：20190204001043



use edw
;
SQL结束执行时间：20190204001043
SQL开始执行时间：20190204001043

truncate table edw.ar_detail
;
SQL结束执行时间：20190204001043
SQL开始执行时间：20190204001043


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190204001043
SQL开始执行时间：20190204001043


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190204001046

20190205001044开始执行2019-02-04数据加载日志:
SQL开始执行时间：20190205001044



use edw
;
SQL结束执行时间：20190205001044
SQL开始执行时间：20190205001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190205001044
SQL开始执行时间：20190205001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190205001044
SQL开始执行时间：20190205001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190205001047

20190206001044开始执行2019-02-05数据加载日志:
SQL开始执行时间：20190206001044



use edw
;
SQL结束执行时间：20190206001044
SQL开始执行时间：20190206001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190206001044
SQL开始执行时间：20190206001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190206001044
SQL开始执行时间：20190206001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190206001047

20190207001044开始执行2019-02-06数据加载日志:
SQL开始执行时间：20190207001044



use edw
;
SQL结束执行时间：20190207001044
SQL开始执行时间：20190207001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190207001044
SQL开始执行时间：20190207001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190207001044
SQL开始执行时间：20190207001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190207001047

20190208001044开始执行2019-02-07数据加载日志:
SQL开始执行时间：20190208001044



use edw
;
SQL结束执行时间：20190208001044
SQL开始执行时间：20190208001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190208001044
SQL开始执行时间：20190208001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190208001044
SQL开始执行时间：20190208001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190208001047

20190209001044开始执行2019-02-08数据加载日志:
SQL开始执行时间：20190209001044



use edw
;
SQL结束执行时间：20190209001044
SQL开始执行时间：20190209001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190209001044
SQL开始执行时间：20190209001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190209001044
SQL开始执行时间：20190209001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190209001046

20190210001044开始执行2019-02-09数据加载日志:
SQL开始执行时间：20190210001044



use edw
;
SQL结束执行时间：20190210001044
SQL开始执行时间：20190210001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190210001044
SQL开始执行时间：20190210001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190210001044
SQL开始执行时间：20190210001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190210001047

20190211001044开始执行2019-02-10数据加载日志:
SQL开始执行时间：20190211001044



use edw
;
SQL结束执行时间：20190211001044
SQL开始执行时间：20190211001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190211001044
SQL开始执行时间：20190211001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190211001044
SQL开始执行时间：20190211001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190211001047

20190212001044开始执行2019-02-11数据加载日志:
SQL开始执行时间：20190212001044



use edw
;
SQL结束执行时间：20190212001044
SQL开始执行时间：20190212001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190212001044
SQL开始执行时间：20190212001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190212001044
SQL开始执行时间：20190212001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190212001046

20190213001044开始执行2019-02-12数据加载日志:
SQL开始执行时间：20190213001044



use edw
;
SQL结束执行时间：20190213001044
SQL开始执行时间：20190213001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190213001044
SQL开始执行时间：20190213001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190213001044
SQL开始执行时间：20190213001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190213001047

20190214091840开始执行2019-02-13数据加载日志:
SQL开始执行时间：20190214091840



use edw
;
SQL结束执行时间：20190214091840
SQL开始执行时间：20190214091840

truncate table edw.ar_detail
;
SQL结束执行时间：20190214091840
SQL开始执行时间：20190214091840


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190214091840
SQL开始执行时间：20190214091840


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190214091843

20190215001045开始执行2019-02-14数据加载日志:
SQL开始执行时间：20190215001045



use edw
;
SQL结束执行时间：20190215001045
SQL开始执行时间：20190215001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190215001045
SQL开始执行时间：20190215001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190215001045
SQL开始执行时间：20190215001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190215001048

20190216001043开始执行2019-02-15数据加载日志:
SQL开始执行时间：20190216001043



use edw
;
SQL结束执行时间：20190216001043
SQL开始执行时间：20190216001043

truncate table edw.ar_detail
;
SQL结束执行时间：20190216001043
SQL开始执行时间：20190216001043


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190216001043
SQL开始执行时间：20190216001043


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190216001046

20190217001045开始执行2019-02-16数据加载日志:
SQL开始执行时间：20190217001045



use edw
;
SQL结束执行时间：20190217001045
SQL开始执行时间：20190217001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190217001045
SQL开始执行时间：20190217001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190217001045
SQL开始执行时间：20190217001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190217001048

20190218001045开始执行2019-02-17数据加载日志:
SQL开始执行时间：20190218001045



use edw
;
SQL结束执行时间：20190218001045
SQL开始执行时间：20190218001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190218001046
SQL开始执行时间：20190218001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190218001046
SQL开始执行时间：20190218001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190218001048

20190219001045开始执行2019-02-18数据加载日志:
SQL开始执行时间：20190219001045



use edw
;
SQL结束执行时间：20190219001045
SQL开始执行时间：20190219001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190219001045
SQL开始执行时间：20190219001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190219001045
SQL开始执行时间：20190219001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190219001046

20190220001045开始执行2019-02-19数据加载日志:
SQL开始执行时间：20190220001045



use edw
;
SQL结束执行时间：20190220001045
SQL开始执行时间：20190220001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190220001045
SQL开始执行时间：20190220001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190220001045
SQL开始执行时间：20190220001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190220001048

20190221001045开始执行2019-02-20数据加载日志:
SQL开始执行时间：20190221001045



use edw
;
SQL结束执行时间：20190221001045
SQL开始执行时间：20190221001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190221001045
SQL开始执行时间：20190221001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190221001045
SQL开始执行时间：20190221001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190221001047

20190222001045开始执行2019-02-21数据加载日志:
SQL开始执行时间：20190222001045



use edw
;
SQL结束执行时间：20190222001045
SQL开始执行时间：20190222001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190222001045
SQL开始执行时间：20190222001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190222001045
SQL开始执行时间：20190222001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190222001047

20190223001045开始执行2019-02-22数据加载日志:
SQL开始执行时间：20190223001045



use edw
;
SQL结束执行时间：20190223001045
SQL开始执行时间：20190223001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190223001045
SQL开始执行时间：20190223001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190223001045
SQL开始执行时间：20190223001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190223001047

20190224001046开始执行2019-02-23数据加载日志:
SQL开始执行时间：20190224001046



use edw
;
SQL结束执行时间：20190224001046
SQL开始执行时间：20190224001046

truncate table edw.ar_detail
;
SQL结束执行时间：20190224001046
SQL开始执行时间：20190224001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190224001046
SQL开始执行时间：20190224001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190224001047

20190225001045开始执行2019-02-24数据加载日志:
SQL开始执行时间：20190225001045



use edw
;
SQL结束执行时间：20190225001045
SQL开始执行时间：20190225001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190225001045
SQL开始执行时间：20190225001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190225001045
SQL开始执行时间：20190225001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190225001047

20190226001045开始执行2019-02-25数据加载日志:
SQL开始执行时间：20190226001045



use edw
;
SQL结束执行时间：20190226001045
SQL开始执行时间：20190226001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190226001045
SQL开始执行时间：20190226001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190226001045
SQL开始执行时间：20190226001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190226001047

20190227001045开始执行2019-02-26数据加载日志:
SQL开始执行时间：20190227001045



use edw
;
SQL结束执行时间：20190227001045
SQL开始执行时间：20190227001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190227001045
SQL开始执行时间：20190227001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190227001045
SQL开始执行时间：20190227001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190227001047

20190228001044开始执行2019-02-27数据加载日志:
SQL开始执行时间：20190228001044



use edw
;
SQL结束执行时间：20190228001044
SQL开始执行时间：20190228001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190228001044
SQL开始执行时间：20190228001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190228001045
SQL开始执行时间：20190228001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190228001046

20190301001045开始执行2019-02-28数据加载日志:
SQL开始执行时间：20190301001045



use edw
;
SQL结束执行时间：20190301001045
SQL开始执行时间：20190301001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190301001045
SQL开始执行时间：20190301001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190301001045
SQL开始执行时间：20190301001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190301001047

20190302001044开始执行2019-03-01数据加载日志:
SQL开始执行时间：20190302001044



use edw
;
SQL结束执行时间：20190302001044
SQL开始执行时间：20190302001044

truncate table edw.ar_detail
;
SQL结束执行时间：20190302001044
SQL开始执行时间：20190302001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190302001044
SQL开始执行时间：20190302001044


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190302001046

20190303001046开始执行2019-03-02数据加载日志:
SQL开始执行时间：20190303001046



use edw
;
SQL结束执行时间：20190303001046
SQL开始执行时间：20190303001046

truncate table edw.ar_detail
;
SQL结束执行时间：20190303001046
SQL开始执行时间：20190303001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190303001047
SQL开始执行时间：20190303001047


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190303001048

20190304001046开始执行2019-03-03数据加载日志:
SQL开始执行时间：20190304001046



use edw
;
SQL结束执行时间：20190304001046
SQL开始执行时间：20190304001046

truncate table edw.ar_detail
;
SQL结束执行时间：20190304001046
SQL开始执行时间：20190304001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190304001046
SQL开始执行时间：20190304001046


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190304001048

20190305001045开始执行2019-03-04数据加载日志:
SQL开始执行时间：20190305001045



use edw
;
SQL结束执行时间：20190305001045
SQL开始执行时间：20190305001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190305001045
SQL开始执行时间：20190305001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190305001045
SQL开始执行时间：20190305001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190305001047

20190306001045开始执行2019-03-05数据加载日志:
SQL开始执行时间：20190306001045



use edw
;
SQL结束执行时间：20190306001045
SQL开始执行时间：20190306001045

truncate table edw.ar_detail
;
SQL结束执行时间：20190306001045
SQL开始执行时间：20190306001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190306001045
SQL开始执行时间：20190306001045


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190306001046

20190307001047开始执行2019-03-06数据加载日志:
SQL开始执行时间：20190307001047



use edw
;
SQL结束执行时间：20190307001047
SQL开始执行时间：20190307001047

truncate table edw.ar_detail
;
SQL结束执行时间：20190307001047
SQL开始执行时间：20190307001047


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190307001047
SQL开始执行时间：20190307001047


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190307001048

20190308001042开始执行2019-03-07数据加载日志:
SQL开始执行时间：20190308001042



use edw
;
SQL结束执行时间：20190308001042
SQL开始执行时间：20190308001042

truncate table edw.ar_detail
;
SQL结束执行时间：20190308001042
SQL开始执行时间：20190308001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190308001042
SQL开始执行时间：20190308001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190308001044

20190308133348开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190308133348



use edw
;
SQL结束执行时间：20190308133348
SQL开始执行时间：20190308133348

truncate table edw.ar_detail
;
SQL结束执行时间：20190308133348
SQL开始执行时间：20190308133348


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190308133348
SQL开始执行时间：20190308133348


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190308133350

20190309001040开始执行2019-03-08数据加载日志:
SQL开始执行时间：20190309001040



use edw
;
SQL结束执行时间：20190309001040
SQL开始执行时间：20190309001040

truncate table edw.ar_detail
;
SQL结束执行时间：20190309001040
SQL开始执行时间：20190309001040


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190309001041
SQL开始执行时间：20190309001041


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190309001042

20190310001042开始执行2019-03-09数据加载日志:
SQL开始执行时间：20190310001042



use edw
;
SQL结束执行时间：20190310001042
SQL开始执行时间：20190310001042

truncate table edw.ar_detail
;
SQL结束执行时间：20190310001042
SQL开始执行时间：20190310001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190310001043
SQL开始执行时间：20190310001043


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190310001044

20190311001042开始执行2019-03-10数据加载日志:
SQL开始执行时间：20190311001042



use edw
;
SQL结束执行时间：20190311001042
SQL开始执行时间：20190311001042

truncate table edw.ar_detail
;
SQL结束执行时间：20190311001042
SQL开始执行时间：20190311001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190311001042
SQL开始执行时间：20190311001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190311001044

20190312001048开始执行2019-03-11数据加载日志:
SQL开始执行时间：20190312001048



use edw
;
SQL结束执行时间：20190312001048
SQL开始执行时间：20190312001048

truncate table edw.ar_detail
;
SQL结束执行时间：20190312001048
SQL开始执行时间：20190312001048


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;

20190312133248开始执行2019-03-11数据加载日志:
SQL开始执行时间：20190312133248



use edw
;
SQL结束执行时间：20190312133248
SQL开始执行时间：20190312133248

truncate table edw.ar_detail
;
SQL结束执行时间：20190312133248
SQL开始执行时间：20190312133248


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '产品'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190312133249
SQL开始执行时间：20190312133249


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '产品'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190312133254

20190313001042开始执行2019-03-12数据加载日志:
SQL开始执行时间：20190313001042



use edw
;
SQL结束执行时间：20190313001042
SQL开始执行时间：20190313001042

truncate table edw.ar_detail
;
SQL结束执行时间：20190313001042
SQL开始执行时间：20190313001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '产品'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190313001043
SQL开始执行时间：20190313001043


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '产品'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190313001048

20190313150806开始执行2019-03-14数据加载日志:
SQL开始执行时间：20190313150806



use edw
;
SQL结束执行时间：20190313150806
SQL开始执行时间：20190313150806

truncate table edw.ar_detail
;
SQL结束执行时间：20190313150806
SQL开始执行时间：20190313150806


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190313150807
SQL开始执行时间：20190313150807


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190313150812

20190314001042开始执行2019-03-13数据加载日志:
SQL开始执行时间：20190314001042



use edw
;
SQL结束执行时间：20190314001042
SQL开始执行时间：20190314001042

truncate table edw.ar_detail
;
SQL结束执行时间：20190314001042
SQL开始执行时间：20190314001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190314001042
SQL开始执行时间：20190314001042


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,a.iDAmount/(1+e.itaxrate/100)
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190314001047

20190315001205开始执行2019-03-14数据加载日志:
SQL开始执行时间：20190315001205



use edw
;
SQL结束执行时间：20190315001205
SQL开始执行时间：20190315001205

truncate table edw.ar_detail
;
SQL结束执行时间：20190315001205
SQL开始执行时间：20190315001205


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190315001206
SQL开始执行时间：20190315001206


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190315001216
SQL开始执行时间：20190315001216

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190315001216
SQL开始执行时间：20190315001216
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190315001216
SQL开始执行时间：20190315001216
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190315001216

20190316001134开始执行2019-03-15数据加载日志:
SQL开始执行时间：20190316001134



use edw
;
SQL结束执行时间：20190316001134
SQL开始执行时间：20190316001134

truncate table edw.ar_detail
;
SQL结束执行时间：20190316001134
SQL开始执行时间：20190316001134


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190316001136
SQL开始执行时间：20190316001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190316001145
SQL开始执行时间：20190316001145

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190316001145
SQL开始执行时间：20190316001145
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190316001145
SQL开始执行时间：20190316001145
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190316001145

20190317001135开始执行2019-03-16数据加载日志:
SQL开始执行时间：20190317001135



use edw
;
SQL结束执行时间：20190317001135
SQL开始执行时间：20190317001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190317001135
SQL开始执行时间：20190317001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190317001137
SQL开始执行时间：20190317001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190317001146
SQL开始执行时间：20190317001146

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190317001146
SQL开始执行时间：20190317001146
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190317001146
SQL开始执行时间：20190317001146
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190317001147

20190318001134开始执行2019-03-17数据加载日志:
SQL开始执行时间：20190318001134



use edw
;
SQL结束执行时间：20190318001134
SQL开始执行时间：20190318001134

truncate table edw.ar_detail
;
SQL结束执行时间：20190318001134
SQL开始执行时间：20190318001134


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190318001135
SQL开始执行时间：20190318001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190318001142
SQL开始执行时间：20190318001142

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190318001142
SQL开始执行时间：20190318001142
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190318001142
SQL开始执行时间：20190318001142
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190318001142

20190319001136开始执行2019-03-18数据加载日志:
SQL开始执行时间：20190319001136



use edw
;
SQL结束执行时间：20190319001136
SQL开始执行时间：20190319001136

truncate table edw.ar_detail
;
SQL结束执行时间：20190319001136
SQL开始执行时间：20190319001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190319001137
SQL开始执行时间：20190319001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190319001145
SQL开始执行时间：20190319001145

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190319001145
SQL开始执行时间：20190319001145
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190319001145
SQL开始执行时间：20190319001145
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190319001146

20190320001133开始执行2019-03-19数据加载日志:
SQL开始执行时间：20190320001133



use edw
;
SQL结束执行时间：20190320001133
SQL开始执行时间：20190320001133

truncate table edw.ar_detail
;
SQL结束执行时间：20190320001133
SQL开始执行时间：20190320001133


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190320001134
SQL开始执行时间：20190320001134


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190320001142
SQL开始执行时间：20190320001142

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190320001143
SQL开始执行时间：20190320001143
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190320001143
SQL开始执行时间：20190320001143
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190320001143

20190321001133开始执行2019-03-20数据加载日志:
SQL开始执行时间：20190321001133



use edw
;
SQL结束执行时间：20190321001133
SQL开始执行时间：20190321001133

truncate table edw.ar_detail
;
SQL结束执行时间：20190321001133
SQL开始执行时间：20190321001133


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190321001135
SQL开始执行时间：20190321001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190321001143
SQL开始执行时间：20190321001143

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190321001143
SQL开始执行时间：20190321001143
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190321001143
SQL开始执行时间：20190321001143
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190321001144

20190322001135开始执行2019-03-21数据加载日志:
SQL开始执行时间：20190322001135



use edw
;
SQL结束执行时间：20190322001135
SQL开始执行时间：20190322001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190322001135
SQL开始执行时间：20190322001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190322001136
SQL开始执行时间：20190322001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190322001145
SQL开始执行时间：20190322001145

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190322001145
SQL开始执行时间：20190322001145
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190322001145
SQL开始执行时间：20190322001145
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190322001145

20190323001135开始执行2019-03-22数据加载日志:
SQL开始执行时间：20190323001135



use edw
;
SQL结束执行时间：20190323001135
SQL开始执行时间：20190323001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190323001135
SQL开始执行时间：20190323001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190323001136
SQL开始执行时间：20190323001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190323001145
SQL开始执行时间：20190323001145

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190323001145
SQL开始执行时间：20190323001145
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190323001145
SQL开始执行时间：20190323001145
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190323001145

20190324001156开始执行2019-03-23数据加载日志:
SQL开始执行时间：20190324001156



use edw
;
SQL结束执行时间：20190324001156
SQL开始执行时间：20190324001156

truncate table edw.ar_detail
;
SQL结束执行时间：20190324001156
SQL开始执行时间：20190324001156


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190324001158
SQL开始执行时间：20190324001158


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190324001206
SQL开始执行时间：20190324001206

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190324001206
SQL开始执行时间：20190324001206
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190324001207
SQL开始执行时间：20190324001207
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190324001207

20190325001135开始执行2019-03-24数据加载日志:
SQL开始执行时间：20190325001135



use edw
;
SQL结束执行时间：20190325001135
SQL开始执行时间：20190325001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190325001135
SQL开始执行时间：20190325001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190325001136
SQL开始执行时间：20190325001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190325001144
SQL开始执行时间：20190325001144

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190325001144
SQL开始执行时间：20190325001144
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190325001144
SQL开始执行时间：20190325001144
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190325001144

20190326001136开始执行2019-03-25数据加载日志:
SQL开始执行时间：20190326001136



use edw
;
SQL结束执行时间：20190326001136
SQL开始执行时间：20190326001136

truncate table edw.ar_detail
;
SQL结束执行时间：20190326001136
SQL开始执行时间：20190326001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190326001137
SQL开始执行时间：20190326001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190326001146
SQL开始执行时间：20190326001146

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190326001146
SQL开始执行时间：20190326001146
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190326001146
SQL开始执行时间：20190326001146
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190326001146

20190327001135开始执行2019-03-26数据加载日志:
SQL开始执行时间：20190327001135



use edw
;
SQL结束执行时间：20190327001135
SQL开始执行时间：20190327001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190327001135
SQL开始执行时间：20190327001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190327001137
SQL开始执行时间：20190327001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190327001147
SQL开始执行时间：20190327001147

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190327001147
SQL开始执行时间：20190327001147
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190327001147
SQL开始执行时间：20190327001147
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190327001148

20190328001132开始执行2019-03-27数据加载日志:
SQL开始执行时间：20190328001132



use edw
;
SQL结束执行时间：20190328001132
SQL开始执行时间：20190328001132

truncate table edw.ar_detail
;
SQL结束执行时间：20190328001133
SQL开始执行时间：20190328001133


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190328001134
SQL开始执行时间：20190328001134


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190328001145
SQL开始执行时间：20190328001145

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190328001145
SQL开始执行时间：20190328001145
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190328001145
SQL开始执行时间：20190328001145
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190328001145

20190329001136开始执行2019-03-28数据加载日志:
SQL开始执行时间：20190329001136



use edw
;
SQL结束执行时间：20190329001136
SQL开始执行时间：20190329001136

truncate table edw.ar_detail
;
SQL结束执行时间：20190329001136
SQL开始执行时间：20190329001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190329001137
SQL开始执行时间：20190329001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190329001148
SQL开始执行时间：20190329001148

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190329001148
SQL开始执行时间：20190329001148
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190329001149
SQL开始执行时间：20190329001149
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190329001149

20190329165936开始执行1900-01-01数据加载日志:
SQL开始执行时间：20190329165936



use edw
;
SQL结束执行时间：20190329165936
SQL开始执行时间：20190329165936

truncate table edw.ar_detail
;
SQL结束执行时间：20190329165936
SQL开始执行时间：20190329165936


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190329165937
SQL开始执行时间：20190329165937


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190329165944
SQL开始执行时间：20190329165944

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190329165944
SQL开始执行时间：20190329165944
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190329165944
SQL开始执行时间：20190329165944
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190329165944

20190330001134开始执行2019-03-29数据加载日志:
SQL开始执行时间：20190330001134



use edw
;
SQL结束执行时间：20190330001134
SQL开始执行时间：20190330001134

truncate table edw.ar_detail
;
SQL结束执行时间：20190330001134
SQL开始执行时间：20190330001134


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190330001135
SQL开始执行时间：20190330001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190330001145
SQL开始执行时间：20190330001145

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190330001146
SQL开始执行时间：20190330001146
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190330001146
SQL开始执行时间：20190330001146
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190330001146

20190331001138开始执行2019-03-30数据加载日志:
SQL开始执行时间：20190331001138



use edw
;
SQL结束执行时间：20190331001138
SQL开始执行时间：20190331001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190331001138
SQL开始执行时间：20190331001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190331001140
SQL开始执行时间：20190331001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190331001152
SQL开始执行时间：20190331001152

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190331001152
SQL开始执行时间：20190331001152
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190331001152
SQL开始执行时间：20190331001152
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190331001152

20190401001138开始执行2019-03-31数据加载日志:
SQL开始执行时间：20190401001138



use edw
;
SQL结束执行时间：20190401001138
SQL开始执行时间：20190401001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190401001138
SQL开始执行时间：20190401001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190401001139
SQL开始执行时间：20190401001139


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190401001150
SQL开始执行时间：20190401001150

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190401001151
SQL开始执行时间：20190401001151
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190401001151
SQL开始执行时间：20190401001151
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190401001151

20190402001138开始执行2019-04-01数据加载日志:
SQL开始执行时间：20190402001138



use edw
;
SQL结束执行时间：20190402001138
SQL开始执行时间：20190402001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190402001139
SQL开始执行时间：20190402001139


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190402001140
SQL开始执行时间：20190402001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190402001153
SQL开始执行时间：20190402001153

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190402001153
SQL开始执行时间：20190402001153
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190402001153
SQL开始执行时间：20190402001153
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190402001153

20190403001138开始执行2019-04-02数据加载日志:
SQL开始执行时间：20190403001138



use edw
;
SQL结束执行时间：20190403001138
SQL开始执行时间：20190403001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190403001138
SQL开始执行时间：20190403001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190403001140
SQL开始执行时间：20190403001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190403001152
SQL开始执行时间：20190403001152

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190403001152
SQL开始执行时间：20190403001152
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190403001152
SQL开始执行时间：20190403001152
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190403001152

20190404001138开始执行2019-04-03数据加载日志:
SQL开始执行时间：20190404001138



use edw
;
SQL结束执行时间：20190404001138
SQL开始执行时间：20190404001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190404001139
SQL开始执行时间：20190404001139


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190404001140
SQL开始执行时间：20190404001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190404001152
SQL开始执行时间：20190404001152

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190404001152
SQL开始执行时间：20190404001152
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190404001152
SQL开始执行时间：20190404001152
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190404001152

20190405001139开始执行2019-04-04数据加载日志:
SQL开始执行时间：20190405001139



use edw
;
SQL结束执行时间：20190405001139
SQL开始执行时间：20190405001139

truncate table edw.ar_detail
;
SQL结束执行时间：20190405001139
SQL开始执行时间：20190405001139


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190405001140
SQL开始执行时间：20190405001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190405001150
SQL开始执行时间：20190405001150

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190405001150
SQL开始执行时间：20190405001150
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190405001150
SQL开始执行时间：20190405001150
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190405001150

20190406001138开始执行2019-04-05数据加载日志:
SQL开始执行时间：20190406001138



use edw
;
SQL结束执行时间：20190406001138
SQL开始执行时间：20190406001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190406001138
SQL开始执行时间：20190406001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190406001140
SQL开始执行时间：20190406001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190406001152
SQL开始执行时间：20190406001152

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190406001152
SQL开始执行时间：20190406001152
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190406001152
SQL开始执行时间：20190406001152
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190406001152

20190407001208开始执行2019-04-06数据加载日志:
SQL开始执行时间：20190407001208



use edw
;
SQL结束执行时间：20190407001208
SQL开始执行时间：20190407001208

truncate table edw.ar_detail
;
SQL结束执行时间：20190407001208
SQL开始执行时间：20190407001208


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190407001209
SQL开始执行时间：20190407001209


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190407001221
SQL开始执行时间：20190407001221

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190407001222
SQL开始执行时间：20190407001222
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190407001222
SQL开始执行时间：20190407001222
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190407001222

20190408001139开始执行2019-04-07数据加载日志:
SQL开始执行时间：20190408001139



use edw
;
SQL结束执行时间：20190408001139
SQL开始执行时间：20190408001139

truncate table edw.ar_detail
;
SQL结束执行时间：20190408001139
SQL开始执行时间：20190408001139


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190408001140
SQL开始执行时间：20190408001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190408001151
SQL开始执行时间：20190408001151

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190408001152
SQL开始执行时间：20190408001152
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190408001152
SQL开始执行时间：20190408001152
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190408001152

20190409001135开始执行2019-04-08数据加载日志:
SQL开始执行时间：20190409001135



use edw
;
SQL结束执行时间：20190409001135
SQL开始执行时间：20190409001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190409001135
SQL开始执行时间：20190409001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190409001137
SQL开始执行时间：20190409001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190409001148
SQL开始执行时间：20190409001148

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190409001149
SQL开始执行时间：20190409001149
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190409001149
SQL开始执行时间：20190409001149
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190409001149

20190410001137开始执行2019-04-09数据加载日志:
SQL开始执行时间：20190410001137



use edw
;
SQL结束执行时间：20190410001137
SQL开始执行时间：20190410001137

truncate table edw.ar_detail
;
SQL结束执行时间：20190410001137
SQL开始执行时间：20190410001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190410001138
SQL开始执行时间：20190410001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case when a.cVouchType = 'R0' then '试剂'
	      when a.cVouchType <> 'R0' and d.equipment = '是' then '设备'
	      when a.cVouchType <> 'R0' and d.business_class ='产品类' then '试剂'
	    else '检测' end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190410001149
SQL开始执行时间：20190410001149

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190410001150
SQL开始执行时间：20190410001150
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190410001150
SQL开始执行时间：20190410001150
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190410001150

20190411001138开始执行2019-04-10数据加载日志:
SQL开始执行时间：20190411001138



use edw
;
SQL结束执行时间：20190411001138
SQL开始执行时间：20190411001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190411001138
SQL开始执行时间：20190411001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
     ,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end as ar_class
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190411001140
SQL开始执行时间：20190411001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
    ,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end as ar_class
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190411001151
SQL开始执行时间：20190411001151

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190411001151
SQL开始执行时间：20190411001151
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190411001151
SQL开始执行时间：20190411001151
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190411001151

20190411152910开始执行1900-01-01数据加载日志:
SQL开始执行时间：20190411152910



use edw
;
SQL结束执行时间：20190411152910
SQL开始执行时间：20190411152910

truncate table edw.ar_detail
;
SQL结束执行时间：20190411152910
SQL开始执行时间：20190411152910


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190411152911
SQL开始执行时间：20190411152911


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190411152918
SQL开始执行时间：20190411152918

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190411152918
SQL开始执行时间：20190411152918
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190411152918
SQL开始执行时间：20190411152918
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190411152918

20190412001136开始执行2019-04-11数据加载日志:
SQL开始执行时间：20190412001136



use edw
;
SQL结束执行时间：20190412001136
SQL开始执行时间：20190412001136

truncate table edw.ar_detail
;
SQL结束执行时间：20190412001136
SQL开始执行时间：20190412001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190412001138
SQL开始执行时间：20190412001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190412001149
SQL开始执行时间：20190412001149

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190412001149
SQL开始执行时间：20190412001149
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190412001149
SQL开始执行时间：20190412001149
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190412001149

20190412102847开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190412102847



use edw
;
SQL结束执行时间：20190412102847
SQL开始执行时间：20190412102847

truncate table edw.ar_detail
;
SQL结束执行时间：20190412102847
SQL开始执行时间：20190412102847


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,c.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;

20190412102919开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190412102919



use edw
;
SQL结束执行时间：20190412102919
SQL开始执行时间：20190412102919

truncate table edw.ar_detail
;
SQL结束执行时间：20190412102919
SQL开始执行时间：20190412102919


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190412102921
SQL开始执行时间：20190412102921


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190412102928
SQL开始执行时间：20190412102928

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190412102928
SQL开始执行时间：20190412102928
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190412102928
SQL开始执行时间：20190412102928
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190412102928

20190413001139开始执行2019-04-12数据加载日志:
SQL开始执行时间：20190413001140



use edw
;
SQL结束执行时间：20190413001140
SQL开始执行时间：20190413001140

truncate table edw.ar_detail
;
SQL结束执行时间：20190413001140
SQL开始执行时间：20190413001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190413001141
SQL开始执行时间：20190413001141


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190413001153
SQL开始执行时间：20190413001153

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190413001153
SQL开始执行时间：20190413001153
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190413001153
SQL开始执行时间：20190413001153
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190413001153

20190509174617开始执行2019-05-07数据加载日志:
SQL开始执行时间：20190509174617



use edw
;
SQL结束执行时间：20190509174617
SQL开始执行时间：20190509174617

truncate table edw.ar_detail
;
SQL结束执行时间：20190509174617
SQL开始执行时间：20190509174617


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190509174619
SQL开始执行时间：20190509174619


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190509174625
SQL开始执行时间：20190509174625

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190509174625
SQL开始执行时间：20190509174625
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190509174625
SQL开始执行时间：20190509174625
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190509174625

20190516001145开始执行2019-05-15数据加载日志:
SQL开始执行时间：20190516001145



use edw
;
SQL结束执行时间：20190516001145
SQL开始执行时间：20190516001145

truncate table edw.ar_detail
;
SQL结束执行时间：20190516001145
SQL开始执行时间：20190516001145


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190516001147
SQL开始执行时间：20190516001147


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190516001155
SQL开始执行时间：20190516001155

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190516001156
SQL开始执行时间：20190516001156
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190516001156
SQL开始执行时间：20190516001156
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190516001156

20190517001138开始执行2019-05-16数据加载日志:
SQL开始执行时间：20190517001138



use edw
;
SQL结束执行时间：20190517001138
SQL开始执行时间：20190517001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190517001138
SQL开始执行时间：20190517001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190517001139
SQL开始执行时间：20190517001139


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190517001150
SQL开始执行时间：20190517001150

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190517001150
SQL开始执行时间：20190517001150
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190517001150
SQL开始执行时间：20190517001150
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190517001150

20190518001133开始执行2019-05-17数据加载日志:
SQL开始执行时间：20190518001133



use edw
;
SQL结束执行时间：20190518001133
SQL开始执行时间：20190518001133

truncate table edw.ar_detail
;
SQL结束执行时间：20190518001133
SQL开始执行时间：20190518001133


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190518001135
SQL开始执行时间：20190518001135


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190518001145
SQL开始执行时间：20190518001145

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190518001146
SQL开始执行时间：20190518001146
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190518001146
SQL开始执行时间：20190518001146
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190518001146

20190519001138开始执行2019-05-18数据加载日志:
SQL开始执行时间：20190519001138



use edw
;
SQL结束执行时间：20190519001138
SQL开始执行时间：20190519001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190519001138
SQL开始执行时间：20190519001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190519001140
SQL开始执行时间：20190519001140


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190519001149
SQL开始执行时间：20190519001149

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190519001150
SQL开始执行时间：20190519001150
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190519001150
SQL开始执行时间：20190519001150
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190519001150

20190520001136开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520001136



use edw
;
SQL结束执行时间：20190520001136
SQL开始执行时间：20190520001136

truncate table edw.ar_detail
;
SQL结束执行时间：20190520001136
SQL开始执行时间：20190520001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520001138
SQL开始执行时间：20190520001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520001148
SQL开始执行时间：20190520001148

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190520001148
SQL开始执行时间：20190520001148
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190520001148
SQL开始执行时间：20190520001148
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190520001148

20190520103610开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520103610



use edw
;
SQL结束执行时间：20190520103610
SQL开始执行时间：20190520103610

truncate table edw.ar_detail
;
SQL结束执行时间：20190520103610
SQL开始执行时间：20190520103610


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520103611
SQL开始执行时间：20190520103611


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520103618
SQL开始执行时间：20190520103618

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190520103618
SQL开始执行时间：20190520103618
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190520103618
SQL开始执行时间：20190520103618
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190520103618

20190520111504开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520111504



use edw
;
SQL结束执行时间：20190520111504
SQL开始执行时间：20190520111504

truncate table edw.ar_detail
;
SQL结束执行时间：20190520111504
SQL开始执行时间：20190520111504


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520111505
SQL开始执行时间：20190520111505


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520111511
SQL开始执行时间：20190520111511

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190520111512
SQL开始执行时间：20190520111512
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190520111512
SQL开始执行时间：20190520111512
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190520111512

20190520112417开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520112417



use edw
;
SQL结束执行时间：20190520112417
SQL开始执行时间：20190520112417

truncate table edw.ar_detail
;
SQL结束执行时间：20190520112418
SQL开始执行时间：20190520112418


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520112419
SQL开始执行时间：20190520112419


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520112425
SQL开始执行时间：20190520112425

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190520112425
SQL开始执行时间：20190520112425
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190520112425
SQL开始执行时间：20190520112425
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190520112425

20190520112647开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520112647



use edw
;
SQL结束执行时间：20190520112647
SQL开始执行时间：20190520112647

truncate table edw.ar_detail
;
SQL结束执行时间：20190520112647
SQL开始执行时间：20190520112647


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520112648
SQL开始执行时间：20190520112648


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520112654
SQL开始执行时间：20190520112654

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190520112654
SQL开始执行时间：20190520112654
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190520112654
SQL开始执行时间：20190520112654
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190520112654

20190520112826开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520112826



use edw
;
SQL结束执行时间：20190520112826
SQL开始执行时间：20190520112826

truncate table edw.ar_detail
;
SQL结束执行时间：20190520112826
SQL开始执行时间：20190520112826


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520112827
SQL开始执行时间：20190520112827


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.cDwCode not in ("001","002","003","004","005","006","007","008","009","010","011","012","013")
;
SQL结束执行时间：20190520112834
SQL开始执行时间：20190520112834

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190520112834
SQL开始执行时间：20190520112834
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190520112834
SQL开始执行时间：20190520112834
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190520112834

20190521001141开始执行2019-05-20数据加载日志:
SQL开始执行时间：20190521001141



use edw
;
SQL结束执行时间：20190521001141
SQL开始执行时间：20190521001141

truncate table edw.ar_detail
;
SQL结束执行时间：20190521001141
SQL开始执行时间：20190521001141


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190521001142
SQL开始执行时间：20190521001142


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190521001153
SQL开始执行时间：20190521001153

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190521001153
SQL开始执行时间：20190521001153
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190521001153
SQL开始执行时间：20190521001153
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190521001153

20190522001135开始执行2019-05-21数据加载日志:
SQL开始执行时间：20190522001135



use edw
;
SQL结束执行时间：20190522001135
SQL开始执行时间：20190522001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190522001136
SQL开始执行时间：20190522001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190522001138
SQL开始执行时间：20190522001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190522001148
SQL开始执行时间：20190522001148

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190522001148
SQL开始执行时间：20190522001148
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190522001148
SQL开始执行时间：20190522001148
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190522001148

20190523001142开始执行2019-05-22数据加载日志:
SQL开始执行时间：20190523001142



use edw
;
SQL结束执行时间：20190523001142
SQL开始执行时间：20190523001142

truncate table edw.ar_detail
;
SQL结束执行时间：20190523001143
SQL开始执行时间：20190523001143


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190523001144
SQL开始执行时间：20190523001144


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190523001154
SQL开始执行时间：20190523001154

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190523001154
SQL开始执行时间：20190523001154
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190523001154
SQL开始执行时间：20190523001154
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190523001154

20190524001138开始执行2019-05-23数据加载日志:
SQL开始执行时间：20190524001138



use edw
;
SQL结束执行时间：20190524001138
SQL开始执行时间：20190524001138

truncate table edw.ar_detail
;
SQL结束执行时间：20190524001138
SQL开始执行时间：20190524001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and a.db = b.db
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190524001141
SQL开始执行时间：20190524001141


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190524001150
SQL开始执行时间：20190524001150

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190524001150
SQL开始执行时间：20190524001150
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190524001150
SQL开始执行时间：20190524001150
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190524001150

20190524084230开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190524084230



use edw
;
SQL结束执行时间：20190524084230
SQL开始执行时间：20190524084230

truncate table edw.ar_detail
;
SQL结束执行时间：20190524084230
SQL开始执行时间：20190524084230


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)	
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190524084232
SQL开始执行时间：20190524084232


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_889_2018','UFDATA_889_2019')
;
SQL结束执行时间：20190524084238
SQL开始执行时间：20190524084238

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190524084238
SQL开始执行时间：20190524084238
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190524084238
SQL开始执行时间：20190524084238
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190524084238

20190524084558开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190524084558



use edw
;
SQL结束执行时间：20190524084558
SQL开始执行时间：20190524084558

truncate table edw.ar_detail
;
SQL结束执行时间：20190524084558
SQL开始执行时间：20190524084558


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)	
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190524084600
SQL开始执行时间：20190524084600


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_588_2018','UFDATA_588_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190524084606
SQL开始执行时间：20190524084606

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190524084606
SQL开始执行时间：20190524084606
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190524084606
SQL开始执行时间：20190524084606
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190524084606

20190524084655开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190524084655



use edw
;
SQL结束执行时间：20190524084655
SQL开始执行时间：20190524084655

truncate table edw.ar_detail
;
SQL结束执行时间：20190524084655
SQL开始执行时间：20190524084655


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)	
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190524084656
SQL开始执行时间：20190524084656


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190524084703
SQL开始执行时间：20190524084703

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190524084703
SQL开始执行时间：20190524084703
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190524084703
SQL开始执行时间：20190524084703
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190524084703

20190525001136开始执行2019-05-24数据加载日志:
SQL开始执行时间：20190525001136



use edw
;
SQL结束执行时间：20190525001136
SQL开始执行时间：20190525001136

truncate table edw.ar_detail
;
SQL结束执行时间：20190525001136
SQL开始执行时间：20190525001136


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)	
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190525001138
SQL开始执行时间：20190525001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190525001149
SQL开始执行时间：20190525001149

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190525001149
SQL开始执行时间：20190525001149
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190525001149
SQL开始执行时间：20190525001149
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190525001149

20190526001137开始执行2019-05-25数据加载日志:
SQL开始执行时间：20190526001137



use edw
;
SQL结束执行时间：20190526001137
SQL开始执行时间：20190526001137

truncate table edw.ar_detail
;
SQL结束执行时间：20190526001137
SQL开始执行时间：20190526001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)	
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190526001139
SQL开始执行时间：20190526001139


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190526001150
SQL开始执行时间：20190526001150

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190526001150
SQL开始执行时间：20190526001150
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190526001150
SQL开始执行时间：20190526001150
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190526001150

20190527001137开始执行2019-05-26数据加载日志:
SQL开始执行时间：20190527001137



use edw
;
SQL结束执行时间：20190527001137
SQL开始执行时间：20190527001137

truncate table edw.ar_detail
;
SQL结束执行时间：20190527001137
SQL开始执行时间：20190527001137


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)	
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190527001138
SQL开始执行时间：20190527001138


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,a.cinvcode
	,c.bi_cinvcode
	,c.bi_cinvname
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
where a.db not in ('UFDATA_889_2018','UFDATA_889_2019','UFDATA_666_2018','UFDATA_169_2018')
;
SQL结束执行时间：20190527001147
SQL开始执行时间：20190527001147

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190527001147
SQL开始执行时间：20190527001147
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190527001147
SQL开始执行时间：20190527001147
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190527001147

20190528001140开始执行2019-05-27数据加载日志:
SQL开始执行时间：20190528001140


use edw
;
SQL结束执行时间：20190528001140
SQL开始执行时间：20190528001140

truncate table edw.ar_detail
;
SQL结束执行时间：20190528001140
SQL开始执行时间：20190528001140

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190528001140
SQL开始执行时间：20190528001140
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190528001144
SQL开始执行时间：20190528001144


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190528001146
SQL开始执行时间：20190528001146


insert into edw.ar_detail
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,case
    when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
    when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
    when d.level_one = "健康检测" then "健康检测"
    when left(c.bi_cinvcode,2) = "yq" then "设备"
    when left(c.bi_cinvcode,2) = "jc" then "检测"
    when a.cinvcode is not null then "试剂"
    when a.cdefine8 = "检测服务" then "检测"
    when a.cdefine8 in("设备","仪器") then "设备"
    when a.cdefine8 in("其他","试剂") then "试剂"
    when a.cDigest like "%试剂%" then "试剂"
    when a.cDigest like "%检测%" then "检测"
    when a.cDigest like "%仪器%" then "设备"
    when a.cDigest like "%设备%" then "设备"
    else "试剂"
end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	      else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                 when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                 else a.iDAmount/(1+16/100) end)
	    end
	,d.specification_type
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join (select * from edw.map_inventory group by bi_cinvcode) d
  on c.bi_cinvcode = d.bi_cinvcode
left join (select * from edw.invoice_order group by csbvcode) e
  on a.cvouchid = e.csbvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190528001311
SQL开始执行时间：20190528001311

delete from edw.ar_detail where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190528001312
SQL开始执行时间：20190528001312
delete from edw.ar_detail where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190528001312
SQL开始执行时间：20190528001312
delete from edw.ar_detail where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190528001312

20190529001239开始执行2019-05-28数据加载日志:
SQL开始执行时间：20190529001239


use edw
;
SQL结束执行时间：20190529001239
SQL开始执行时间：20190529001239

truncate table edw.ar_detail
;
SQL结束执行时间：20190529001239
SQL开始执行时间：20190529001239

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190529001239
SQL开始执行时间：20190529001239
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190529001241
SQL开始执行时间：20190529001241


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190529001241
SQL开始执行时间：20190529001241


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190529001312
SQL开始执行时间：20190529001312

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190529001312
SQL开始执行时间：20190529001312
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190529001312
SQL开始执行时间：20190529001312
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190529001312
SQL开始执行时间：20190529001312

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190529001314
SQL开始执行时间：20190529001314
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190529001316
SQL开始执行时间：20190529001316
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190529001318
SQL开始执行时间：20190529001318
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190529001321
SQL开始执行时间：20190529001321


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190529001322
SQL开始执行时间：20190529001322

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190529001323
SQL开始执行时间：20190529001323

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190529001811

20190530001231开始执行2019-05-29数据加载日志:
SQL开始执行时间：20190530001231


use edw
;
SQL结束执行时间：20190530001231
SQL开始执行时间：20190530001231

truncate table edw.ar_detail
;
SQL结束执行时间：20190530001231
SQL开始执行时间：20190530001231

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190530001231
SQL开始执行时间：20190530001231
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190530001234
SQL开始执行时间：20190530001234


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190530001234
SQL开始执行时间：20190530001234


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190530001303
SQL开始执行时间：20190530001303

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190530001303
SQL开始执行时间：20190530001303
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190530001303
SQL开始执行时间：20190530001303
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190530001304
SQL开始执行时间：20190530001304

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190530001305
SQL开始执行时间：20190530001305
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190530001307
SQL开始执行时间：20190530001307
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190530001309
SQL开始执行时间：20190530001309
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190530001312
SQL开始执行时间：20190530001312


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190530001313
SQL开始执行时间：20190530001313

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190530001314
SQL开始执行时间：20190530001314

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190530001809

20190531001231开始执行2019-05-30数据加载日志:
SQL开始执行时间：20190531001231


use edw
;
SQL结束执行时间：20190531001231
SQL开始执行时间：20190531001231

truncate table edw.ar_detail
;
SQL结束执行时间：20190531001231
SQL开始执行时间：20190531001231

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190531001231
SQL开始执行时间：20190531001231
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190531001234
SQL开始执行时间：20190531001234


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190531001234
SQL开始执行时间：20190531001234


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190531001303
SQL开始执行时间：20190531001303

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190531001303
SQL开始执行时间：20190531001303
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190531001303
SQL开始执行时间：20190531001303
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190531001304
SQL开始执行时间：20190531001304

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190531001305
SQL开始执行时间：20190531001305
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190531001307
SQL开始执行时间：20190531001307
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190531001309
SQL开始执行时间：20190531001309
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190531001311
SQL开始执行时间：20190531001311


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190531001313
SQL开始执行时间：20190531001313

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190531001314
SQL开始执行时间：20190531001314

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190531001756

20190601001231开始执行2019-05-31数据加载日志:
SQL开始执行时间：20190601001231


use edw
;
SQL结束执行时间：20190601001231
SQL开始执行时间：20190601001231

truncate table edw.ar_detail
;
SQL结束执行时间：20190601001231
SQL开始执行时间：20190601001231

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190601001231
SQL开始执行时间：20190601001231
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190601001234
SQL开始执行时间：20190601001234


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190601001234
SQL开始执行时间：20190601001234


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190601001304
SQL开始执行时间：20190601001304

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190601001305
SQL开始执行时间：20190601001305
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190601001305
SQL开始执行时间：20190601001305
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190601001305
SQL开始执行时间：20190601001305

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190601001307
SQL开始执行时间：20190601001307
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190601001308
SQL开始执行时间：20190601001308
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190601001310
SQL开始执行时间：20190601001310
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190601001313
SQL开始执行时间：20190601001313


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190601001314
SQL开始执行时间：20190601001314

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190601001315
SQL开始执行时间：20190601001315

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190601001758

20190602001235开始执行2019-06-01数据加载日志:
SQL开始执行时间：20190602001235


use edw
;
SQL结束执行时间：20190602001235
SQL开始执行时间：20190602001235

truncate table edw.ar_detail
;
SQL结束执行时间：20190602001235
SQL开始执行时间：20190602001235

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190602001235
SQL开始执行时间：20190602001235
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190602001238
SQL开始执行时间：20190602001238


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190602001238
SQL开始执行时间：20190602001238


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190602001308
SQL开始执行时间：20190602001308

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190602001308
SQL开始执行时间：20190602001308
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190602001308
SQL开始执行时间：20190602001308
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190602001309
SQL开始执行时间：20190602001309

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190602001310
SQL开始执行时间：20190602001310
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190602001312
SQL开始执行时间：20190602001312
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190602001314
SQL开始执行时间：20190602001314
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190602001316
SQL开始执行时间：20190602001316


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190602001318
SQL开始执行时间：20190602001318

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190602001319
SQL开始执行时间：20190602001319

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190602001801

20190603001236开始执行2019-06-02数据加载日志:
SQL开始执行时间：20190603001236


use edw
;
SQL结束执行时间：20190603001236
SQL开始执行时间：20190603001236

truncate table edw.ar_detail
;
SQL结束执行时间：20190603001236
SQL开始执行时间：20190603001236

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190603001236
SQL开始执行时间：20190603001236
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190603001239
SQL开始执行时间：20190603001239


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190603001239
SQL开始执行时间：20190603001239


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190603001309
SQL开始执行时间：20190603001309

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190603001310
SQL开始执行时间：20190603001310
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190603001310
SQL开始执行时间：20190603001310
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190603001310
SQL开始执行时间：20190603001310

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190603001312
SQL开始执行时间：20190603001312
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190603001313
SQL开始执行时间：20190603001313
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190603001315
SQL开始执行时间：20190603001315
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190603001318
SQL开始执行时间：20190603001318


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190603001319
SQL开始执行时间：20190603001319

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190603001320
SQL开始执行时间：20190603001320

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190603001807

20190604001233开始执行2019-06-03数据加载日志:
SQL开始执行时间：20190604001233


use edw
;
SQL结束执行时间：20190604001233
SQL开始执行时间：20190604001233

truncate table edw.ar_detail
;
SQL结束执行时间：20190604001233
SQL开始执行时间：20190604001233

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190604001233
SQL开始执行时间：20190604001233
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190604001236
SQL开始执行时间：20190604001236


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190604001236
SQL开始执行时间：20190604001236


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190604001306
SQL开始执行时间：20190604001306

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190604001307
SQL开始执行时间：20190604001307
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190604001307
SQL开始执行时间：20190604001307
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190604001307
SQL开始执行时间：20190604001307

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190604001309
SQL开始执行时间：20190604001309
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190604001311
SQL开始执行时间：20190604001311
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190604001313
SQL开始执行时间：20190604001313
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190604001315
SQL开始执行时间：20190604001315


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190604001316
SQL开始执行时间：20190604001316

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190604001318
SQL开始执行时间：20190604001318

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190604001812

20190605001233开始执行2019-06-04数据加载日志:
SQL开始执行时间：20190605001233


use edw
;
SQL结束执行时间：20190605001233
SQL开始执行时间：20190605001233

truncate table edw.ar_detail
;
SQL结束执行时间：20190605001233
SQL开始执行时间：20190605001233

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190605001233
SQL开始执行时间：20190605001233
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190605001236
SQL开始执行时间：20190605001236


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190605001236
SQL开始执行时间：20190605001236


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190605001306
SQL开始执行时间：20190605001306

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190605001307
SQL开始执行时间：20190605001307
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190605001307
SQL开始执行时间：20190605001307
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190605001307
SQL开始执行时间：20190605001307

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190605001309
SQL开始执行时间：20190605001309
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190605001311
SQL开始执行时间：20190605001311
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190605001313
SQL开始执行时间：20190605001313
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190605001315
SQL开始执行时间：20190605001315


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190605001316
SQL开始执行时间：20190605001316

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190605001318
SQL开始执行时间：20190605001318

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190605001805

20190606001235开始执行2019-06-05数据加载日志:
SQL开始执行时间：20190606001235


use edw
;
SQL结束执行时间：20190606001235
SQL开始执行时间：20190606001235

truncate table edw.ar_detail
;
SQL结束执行时间：20190606001235
SQL开始执行时间：20190606001235

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190606001235
SQL开始执行时间：20190606001235
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190606001238
SQL开始执行时间：20190606001238


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190606001238
SQL开始执行时间：20190606001238


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190606001309
SQL开始执行时间：20190606001309

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190606001310
SQL开始执行时间：20190606001310
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190606001310
SQL开始执行时间：20190606001310
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190606001310
SQL开始执行时间：20190606001310

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190606001312
SQL开始执行时间：20190606001312
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190606001314
SQL开始执行时间：20190606001314
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190606001316
SQL开始执行时间：20190606001316
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190606001318
SQL开始执行时间：20190606001318


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190606001319
SQL开始执行时间：20190606001319

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190606001321
SQL开始执行时间：20190606001321

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190606001811

20190607001250开始执行2019-06-06数据加载日志:
SQL开始执行时间：20190607001250


use edw
;
SQL结束执行时间：20190607001250
SQL开始执行时间：20190607001250

truncate table edw.ar_detail
;
SQL结束执行时间：20190607001250
SQL开始执行时间：20190607001250

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190607001250
SQL开始执行时间：20190607001250
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190607001252
SQL开始执行时间：20190607001252


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190607001253
SQL开始执行时间：20190607001253


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190607001324
SQL开始执行时间：20190607001324

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190607001324
SQL开始执行时间：20190607001324
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190607001324
SQL开始执行时间：20190607001324
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190607001324
SQL开始执行时间：20190607001324

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190607001326
SQL开始执行时间：20190607001326
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190607001328
SQL开始执行时间：20190607001328
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190607001330
SQL开始执行时间：20190607001330
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190607001333
SQL开始执行时间：20190607001333


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190607001334
SQL开始执行时间：20190607001334

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190607001335
SQL开始执行时间：20190607001335

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190607001828

20190608001232开始执行2019-06-07数据加载日志:
SQL开始执行时间：20190608001232


use edw
;
SQL结束执行时间：20190608001232
SQL开始执行时间：20190608001232

truncate table edw.ar_detail
;
SQL结束执行时间：20190608001232
SQL开始执行时间：20190608001232

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190608001232
SQL开始执行时间：20190608001232
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190608001235
SQL开始执行时间：20190608001235


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190608001235
SQL开始执行时间：20190608001235


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190608001307
SQL开始执行时间：20190608001307

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190608001307
SQL开始执行时间：20190608001307
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190608001307
SQL开始执行时间：20190608001307
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190608001307
SQL开始执行时间：20190608001307

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190608001309
SQL开始执行时间：20190608001309
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190608001311
SQL开始执行时间：20190608001311
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190608001313
SQL开始执行时间：20190608001313
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190608001315
SQL开始执行时间：20190608001315


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190608001316
SQL开始执行时间：20190608001316

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190608001318
SQL开始执行时间：20190608001318

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190608001822

20190610084939开始执行2019-06-09数据加载日志:
SQL开始执行时间：20190610084939


use edw
;
SQL结束执行时间：20190610084939
SQL开始执行时间：20190610084939

truncate table edw.ar_detail
;
SQL结束执行时间：20190610084939
SQL开始执行时间：20190610084939

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190610084939
SQL开始执行时间：20190610084939
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190610084942
SQL开始执行时间：20190610084942


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190610084943
SQL开始执行时间：20190610084943


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190610085013
SQL开始执行时间：20190610085013

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190610085014
SQL开始执行时间：20190610085014
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190610085014
SQL开始执行时间：20190610085014
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190610085014
SQL开始执行时间：20190610085014

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190610085016
SQL开始执行时间：20190610085016
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190610085018
SQL开始执行时间：20190610085018
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190610085020
SQL开始执行时间：20190610085020
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190610085023
SQL开始执行时间：20190610085023


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190610085024
SQL开始执行时间：20190610085024

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190610085026
SQL开始执行时间：20190610085026

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190610085511

20190611001237开始执行2019-06-10数据加载日志:
SQL开始执行时间：20190611001237


use edw
;
SQL结束执行时间：20190611001237
SQL开始执行时间：20190611001237

truncate table edw.ar_detail
;
SQL结束执行时间：20190611001237
SQL开始执行时间：20190611001237

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190611001237
SQL开始执行时间：20190611001237
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190611001240
SQL开始执行时间：20190611001240


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190611001240
SQL开始执行时间：20190611001240


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190611001312
SQL开始执行时间：20190611001312

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190611001312
SQL开始执行时间：20190611001312
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190611001312
SQL开始执行时间：20190611001312
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190611001313
SQL开始执行时间：20190611001313

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190611001314
SQL开始执行时间：20190611001314
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190611001316
SQL开始执行时间：20190611001316
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190611001318
SQL开始执行时间：20190611001318
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190611001321
SQL开始执行时间：20190611001321


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190611001322
SQL开始执行时间：20190611001322

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190611001323
SQL开始执行时间：20190611001323

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190611001816

20190612001235开始执行2019-06-11数据加载日志:
SQL开始执行时间：20190612001235


use edw
;
SQL结束执行时间：20190612001235
SQL开始执行时间：20190612001235

truncate table edw.ar_detail
;
SQL结束执行时间：20190612001235
SQL开始执行时间：20190612001235

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190612001235
SQL开始执行时间：20190612001235
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190612001238
SQL开始执行时间：20190612001238


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190612001239
SQL开始执行时间：20190612001239


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190612001310
SQL开始执行时间：20190612001310

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190612001310
SQL开始执行时间：20190612001310
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190612001310
SQL开始执行时间：20190612001310
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190612001310
SQL开始执行时间：20190612001310

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190612001312
SQL开始执行时间：20190612001312
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190612001314
SQL开始执行时间：20190612001314
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190612001316
SQL开始执行时间：20190612001316
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190612001318
SQL开始执行时间：20190612001318


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190612001320
SQL开始执行时间：20190612001320

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190612001321
SQL开始执行时间：20190612001321

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190612001827

20190613001231开始执行2019-06-12数据加载日志:
SQL开始执行时间：20190613001231


use edw
;
SQL结束执行时间：20190613001231
SQL开始执行时间：20190613001231

truncate table edw.ar_detail
;
SQL结束执行时间：20190613001231
SQL开始执行时间：20190613001231

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190613001231
SQL开始执行时间：20190613001231
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190613001234
SQL开始执行时间：20190613001234


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190613001235
SQL开始执行时间：20190613001235


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190613001306
SQL开始执行时间：20190613001306

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190613001306
SQL开始执行时间：20190613001306
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190613001306
SQL开始执行时间：20190613001306
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190613001307
SQL开始执行时间：20190613001307

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190613001308
SQL开始执行时间：20190613001308
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190613001310
SQL开始执行时间：20190613001310
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190613001312
SQL开始执行时间：20190613001312
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190613001315
SQL开始执行时间：20190613001315


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190613001316
SQL开始执行时间：20190613001316

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190613001317
SQL开始执行时间：20190613001317

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190613001810

20190614001240开始执行2019-06-13数据加载日志:
SQL开始执行时间：20190614001240


use edw
;
SQL结束执行时间：20190614001240
SQL开始执行时间：20190614001240

truncate table edw.ar_detail
;
SQL结束执行时间：20190614001240
SQL开始执行时间：20190614001240

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190614001240
SQL开始执行时间：20190614001240
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190614001243
SQL开始执行时间：20190614001243


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190614001243
SQL开始执行时间：20190614001243


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190614001316
SQL开始执行时间：20190614001316

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190614001316
SQL开始执行时间：20190614001316
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190614001316
SQL开始执行时间：20190614001316
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190614001316
SQL开始执行时间：20190614001316

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190614001318
SQL开始执行时间：20190614001318
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190614001320
SQL开始执行时间：20190614001320
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190614001322
SQL开始执行时间：20190614001322
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190614001325
SQL开始执行时间：20190614001325


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190614001326
SQL开始执行时间：20190614001326

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190614001327
SQL开始执行时间：20190614001327

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190614001837

20190615001238开始执行2019-06-14数据加载日志:
SQL开始执行时间：20190615001238


use edw
;
SQL结束执行时间：20190615001238
SQL开始执行时间：20190615001238

truncate table edw.ar_detail
;
SQL结束执行时间：20190615001238
SQL开始执行时间：20190615001238

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190615001238
SQL开始执行时间：20190615001238
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190615001241
SQL开始执行时间：20190615001241


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190615001241
SQL开始执行时间：20190615001241


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190615001314
SQL开始执行时间：20190615001314

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190615001314
SQL开始执行时间：20190615001314
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190615001314
SQL开始执行时间：20190615001314
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190615001315
SQL开始执行时间：20190615001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190615001316
SQL开始执行时间：20190615001316
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190615001318
SQL开始执行时间：20190615001318
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190615001321
SQL开始执行时间：20190615001321
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190615001323
SQL开始执行时间：20190615001323


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190615001324
SQL开始执行时间：20190615001324

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190615001326
SQL开始执行时间：20190615001326

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190615001830

20190616001238开始执行2019-06-15数据加载日志:
SQL开始执行时间：20190616001238


use edw
;
SQL结束执行时间：20190616001238
SQL开始执行时间：20190616001238

truncate table edw.ar_detail
;
SQL结束执行时间：20190616001238
SQL开始执行时间：20190616001238

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190616001238
SQL开始执行时间：20190616001238
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190616001241
SQL开始执行时间：20190616001241


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190616001241
SQL开始执行时间：20190616001241


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190616001314
SQL开始执行时间：20190616001314

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190616001314
SQL开始执行时间：20190616001314
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190616001314
SQL开始执行时间：20190616001314
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190616001314
SQL开始执行时间：20190616001314

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190616001316
SQL开始执行时间：20190616001316
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190616001318
SQL开始执行时间：20190616001318
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190616001320
SQL开始执行时间：20190616001320
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190616001323
SQL开始执行时间：20190616001323


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190616001324
SQL开始执行时间：20190616001324

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190616001325
SQL开始执行时间：20190616001325

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190616001828

20190617001239开始执行2019-06-16数据加载日志:
SQL开始执行时间：20190617001239


use edw
;
SQL结束执行时间：20190617001239
SQL开始执行时间：20190617001239

truncate table edw.ar_detail
;
SQL结束执行时间：20190617001239
SQL开始执行时间：20190617001239

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190617001239
SQL开始执行时间：20190617001239
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190617001242
SQL开始执行时间：20190617001242


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190617001242
SQL开始执行时间：20190617001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190617001315
SQL开始执行时间：20190617001315

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190617001315
SQL开始执行时间：20190617001315
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190617001315
SQL开始执行时间：20190617001315
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190617001315
SQL开始执行时间：20190617001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190617001317
SQL开始执行时间：20190617001317
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190617001319
SQL开始执行时间：20190617001319
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190617001321
SQL开始执行时间：20190617001321
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190617001324
SQL开始执行时间：20190617001324


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190617001325
SQL开始执行时间：20190617001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190617001326
SQL开始执行时间：20190617001326

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190617001829

20190618001240开始执行2019-06-17数据加载日志:
SQL开始执行时间：20190618001240


use edw
;
SQL结束执行时间：20190618001240
SQL开始执行时间：20190618001240

truncate table edw.ar_detail
;
SQL结束执行时间：20190618001240
SQL开始执行时间：20190618001240

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190618001240
SQL开始执行时间：20190618001240
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190618001243
SQL开始执行时间：20190618001243


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190618001243
SQL开始执行时间：20190618001243


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190618001315
SQL开始执行时间：20190618001315

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190618001315
SQL开始执行时间：20190618001315
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190618001316
SQL开始执行时间：20190618001316
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190618001316
SQL开始执行时间：20190618001316

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190618001318
SQL开始执行时间：20190618001318
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190618001319
SQL开始执行时间：20190618001319
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190618001322
SQL开始执行时间：20190618001322
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190618001324
SQL开始执行时间：20190618001324


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190618001326
SQL开始执行时间：20190618001326

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190618001327
SQL开始执行时间：20190618001327

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190618001830

20190619001240开始执行2019-06-18数据加载日志:
SQL开始执行时间：20190619001240


use edw
;
SQL结束执行时间：20190619001240
SQL开始执行时间：20190619001240

truncate table edw.ar_detail
;
SQL结束执行时间：20190619001240
SQL开始执行时间：20190619001240

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190619001240
SQL开始执行时间：20190619001240
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190619001243
SQL开始执行时间：20190619001243


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190619001243
SQL开始执行时间：20190619001243


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190619001315
SQL开始执行时间：20190619001315

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190619001315
SQL开始执行时间：20190619001315
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190619001316
SQL开始执行时间：20190619001316
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190619001316
SQL开始执行时间：20190619001316

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190619001318
SQL开始执行时间：20190619001318
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190619001320
SQL开始执行时间：20190619001320
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190619001322
SQL开始执行时间：20190619001322
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190619001324
SQL开始执行时间：20190619001324


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190619001325
SQL开始执行时间：20190619001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190619001327
SQL开始执行时间：20190619001327

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190619001829

20190620001239开始执行2019-06-19数据加载日志:
SQL开始执行时间：20190620001239


use edw
;
SQL结束执行时间：20190620001239
SQL开始执行时间：20190620001239

truncate table edw.ar_detail
;
SQL结束执行时间：20190620001239
SQL开始执行时间：20190620001239

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190620001239
SQL开始执行时间：20190620001239
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190620001242
SQL开始执行时间：20190620001242


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190620001242
SQL开始执行时间：20190620001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190620001315
SQL开始执行时间：20190620001315

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190620001315
SQL开始执行时间：20190620001315
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190620001315
SQL开始执行时间：20190620001315
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190620001315
SQL开始执行时间：20190620001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190620001317
SQL开始执行时间：20190620001317
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190620001319
SQL开始执行时间：20190620001319
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190620001321
SQL开始执行时间：20190620001321
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190620001324
SQL开始执行时间：20190620001324


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190620001325
SQL开始执行时间：20190620001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190620001326
SQL开始执行时间：20190620001326

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190620001832

20190621001238开始执行2019-06-20数据加载日志:
SQL开始执行时间：20190621001238


use edw
;
SQL结束执行时间：20190621001238
SQL开始执行时间：20190621001238

truncate table edw.ar_detail
;
SQL结束执行时间：20190621001238
SQL开始执行时间：20190621001238

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190621001238
SQL开始执行时间：20190621001238
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190621001241
SQL开始执行时间：20190621001241


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190621001242
SQL开始执行时间：20190621001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190621001314
SQL开始执行时间：20190621001314

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190621001315
SQL开始执行时间：20190621001315
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190621001315
SQL开始执行时间：20190621001315
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190621001315
SQL开始执行时间：20190621001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190621001317
SQL开始执行时间：20190621001317
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190621001319
SQL开始执行时间：20190621001319
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190621001321
SQL开始执行时间：20190621001321
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190621001323
SQL开始执行时间：20190621001323


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190621001325
SQL开始执行时间：20190621001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190621001326
SQL开始执行时间：20190621001326

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190621001832

20190622001238开始执行2019-06-21数据加载日志:
SQL开始执行时间：20190622001238


use edw
;
SQL结束执行时间：20190622001238
SQL开始执行时间：20190622001238

truncate table edw.ar_detail
;
SQL结束执行时间：20190622001239
SQL开始执行时间：20190622001239

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190622001239
SQL开始执行时间：20190622001239
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190622001242
SQL开始执行时间：20190622001242


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190622001242
SQL开始执行时间：20190622001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190622001314
SQL开始执行时间：20190622001314

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190622001314
SQL开始执行时间：20190622001314
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190622001315
SQL开始执行时间：20190622001315
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190622001315
SQL开始执行时间：20190622001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190622001317
SQL开始执行时间：20190622001317
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190622001319
SQL开始执行时间：20190622001319
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190622001321
SQL开始执行时间：20190622001321
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190622001323
SQL开始执行时间：20190622001323


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190622001325
SQL开始执行时间：20190622001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190622001326
SQL开始执行时间：20190622001326

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190622001835

20190623001238开始执行2019-06-22数据加载日志:
SQL开始执行时间：20190623001238


use edw
;
SQL结束执行时间：20190623001238
SQL开始执行时间：20190623001238

truncate table edw.ar_detail
;
SQL结束执行时间：20190623001238
SQL开始执行时间：20190623001238

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190623001238
SQL开始执行时间：20190623001238
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190623001241
SQL开始执行时间：20190623001241


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190623001242
SQL开始执行时间：20190623001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190623001314
SQL开始执行时间：20190623001314

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190623001314
SQL开始执行时间：20190623001314
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190623001315
SQL开始执行时间：20190623001315
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190623001315
SQL开始执行时间：20190623001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190623001317
SQL开始执行时间：20190623001317
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190623001318
SQL开始执行时间：20190623001318
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190623001321
SQL开始执行时间：20190623001321
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190623001323
SQL开始执行时间：20190623001323


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190623001325
SQL开始执行时间：20190623001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190623001326
SQL开始执行时间：20190623001326

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190623001837

20190624090026开始执行2019-06-23数据加载日志:
SQL开始执行时间：20190624090026


use edw
;
SQL结束执行时间：20190624090026
SQL开始执行时间：20190624090026

truncate table edw.ar_detail
;
SQL结束执行时间：20190624090027
SQL开始执行时间：20190624090027

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190624090027
SQL开始执行时间：20190624090027
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190624090030
SQL开始执行时间：20190624090030


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190624090030
SQL开始执行时间：20190624090030


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190624090102
SQL开始执行时间：20190624090102

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190624090102
SQL开始执行时间：20190624090102
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190624090102
SQL开始执行时间：20190624090102
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190624090102
SQL开始执行时间：20190624090102

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190624090104
SQL开始执行时间：20190624090104
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190624090106
SQL开始执行时间：20190624090106
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190624090109
SQL开始执行时间：20190624090109
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190624090111
SQL开始执行时间：20190624090111


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190624090112
SQL开始执行时间：20190624090112

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190624090114
SQL开始执行时间：20190624090114

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190624090620

20190625001239开始执行2019-06-24数据加载日志:
SQL开始执行时间：20190625001239


use edw
;
SQL结束执行时间：20190625001239
SQL开始执行时间：20190625001239

truncate table edw.ar_detail
;
SQL结束执行时间：20190625001239
SQL开始执行时间：20190625001239

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190625001239
SQL开始执行时间：20190625001239
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190625001242
SQL开始执行时间：20190625001242


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190625001242
SQL开始执行时间：20190625001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190625001315
SQL开始执行时间：20190625001315

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190625001315
SQL开始执行时间：20190625001315
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190625001315
SQL开始执行时间：20190625001315
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190625001315
SQL开始执行时间：20190625001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190625001317
SQL开始执行时间：20190625001317
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190625001319
SQL开始执行时间：20190625001319
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190625001321
SQL开始执行时间：20190625001321
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190625001324
SQL开始执行时间：20190625001324


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190625001325
SQL开始执行时间：20190625001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190625001327
SQL开始执行时间：20190625001327

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190625001835

20190626001239开始执行2019-06-25数据加载日志:
SQL开始执行时间：20190626001239


use edw
;
SQL结束执行时间：20190626001239
SQL开始执行时间：20190626001239

truncate table edw.ar_detail
;
SQL结束执行时间：20190626001239
SQL开始执行时间：20190626001239

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190626001239
SQL开始执行时间：20190626001239
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190626001242
SQL开始执行时间：20190626001242


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190626001242
SQL开始执行时间：20190626001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190626001315
SQL开始执行时间：20190626001315

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190626001315
SQL开始执行时间：20190626001315
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190626001315
SQL开始执行时间：20190626001315
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190626001315
SQL开始执行时间：20190626001315

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190626001317
SQL开始执行时间：20190626001317
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190626001319
SQL开始执行时间：20190626001319
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190626001322
SQL开始执行时间：20190626001322
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190626001324
SQL开始执行时间：20190626001324


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190626001325
SQL开始执行时间：20190626001325

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190626001327
SQL开始执行时间：20190626001327

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190626001839

20190627001239开始执行2019-06-26数据加载日志:
SQL开始执行时间：20190627001239


use edw
;
SQL结束执行时间：20190627001239
SQL开始执行时间：20190627001239

truncate table edw.ar_detail
;
SQL结束执行时间：20190627001239
SQL开始执行时间：20190627001239

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190627001239
SQL开始执行时间：20190627001239
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190627001242
SQL开始执行时间：20190627001242


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190627001242
SQL开始执行时间：20190627001242


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190627001316
SQL开始执行时间：20190627001316

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190627001316
SQL开始执行时间：20190627001316
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190627001316
SQL开始执行时间：20190627001316
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190627001316
SQL开始执行时间：20190627001316

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190627001318
SQL开始执行时间：20190627001318
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190627001320
SQL开始执行时间：20190627001320
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190627001322
SQL开始执行时间：20190627001322
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190627001325
SQL开始执行时间：20190627001325


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190627001326
SQL开始执行时间：20190627001326

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190627001328
SQL开始执行时间：20190627001328

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190627001840

20190628001242开始执行2019-06-27数据加载日志:
SQL开始执行时间：20190628001242


use edw
;
SQL结束执行时间：20190628001242
SQL开始执行时间：20190628001242

truncate table edw.ar_detail
;
SQL结束执行时间：20190628001242
SQL开始执行时间：20190628001242

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190628001242
SQL开始执行时间：20190628001242
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190628001245
SQL开始执行时间：20190628001245


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190628001245
SQL开始执行时间：20190628001245


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190628001319
SQL开始执行时间：20190628001319

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190628001320
SQL开始执行时间：20190628001320
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190628001320
SQL开始执行时间：20190628001320
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190628001320
SQL开始执行时间：20190628001320

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190628001322
SQL开始执行时间：20190628001322
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190628001324
SQL开始执行时间：20190628001324
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190628001326
SQL开始执行时间：20190628001326
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190628001329
SQL开始执行时间：20190628001329


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190628001330
SQL开始执行时间：20190628001330

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190628001332
SQL开始执行时间：20190628001332

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190628001847

20190629001244开始执行2019-06-28数据加载日志:
SQL开始执行时间：20190629001244


use edw
;
SQL结束执行时间：20190629001244
SQL开始执行时间：20190629001244

truncate table edw.ar_detail
;
SQL结束执行时间：20190629001244
SQL开始执行时间：20190629001244

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190629001244
SQL开始执行时间：20190629001244
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190629001246
SQL开始执行时间：20190629001246


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190629001246
SQL开始执行时间：20190629001246


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190629001320
SQL开始执行时间：20190629001320

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190629001320
SQL开始执行时间：20190629001320
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190629001320
SQL开始执行时间：20190629001320
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190629001320
SQL开始执行时间：20190629001320

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190629001322
SQL开始执行时间：20190629001322
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190629001324
SQL开始执行时间：20190629001324
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190629001326
SQL开始执行时间：20190629001326
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190629001329
SQL开始执行时间：20190629001329


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190629001330
SQL开始执行时间：20190629001330

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190629001332
SQL开始执行时间：20190629001332

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190629001603

20190630001127开始执行2019-06-29数据加载日志:
SQL开始执行时间：20190630001127


use edw
;
SQL结束执行时间：20190630001127
SQL开始执行时间：20190630001127

truncate table edw.ar_detail
;
SQL结束执行时间：20190630001127
SQL开始执行时间：20190630001127

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190630001127
SQL开始执行时间：20190630001127
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190630001129
SQL开始执行时间：20190630001129


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190630001129
SQL开始执行时间：20190630001129


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190630001203
SQL开始执行时间：20190630001203

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190630001204
SQL开始执行时间：20190630001204
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190630001204
SQL开始执行时间：20190630001204
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190630001204
SQL开始执行时间：20190630001204

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190630001206
SQL开始执行时间：20190630001206
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190630001208
SQL开始执行时间：20190630001208
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190630001210
SQL开始执行时间：20190630001210
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190630001213
SQL开始执行时间：20190630001213


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190630001214
SQL开始执行时间：20190630001214

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190630001216
SQL开始执行时间：20190630001216

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190630001448

20190701001126开始执行2019-06-30数据加载日志:
SQL开始执行时间：20190701001126


use edw
;
SQL结束执行时间：20190701001126
SQL开始执行时间：20190701001126

truncate table edw.ar_detail
;
SQL结束执行时间：20190701001126
SQL开始执行时间：20190701001126

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190701001126
SQL开始执行时间：20190701001126
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190701001128
SQL开始执行时间：20190701001128


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190701001128
SQL开始执行时间：20190701001128


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190701001202
SQL开始执行时间：20190701001202

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190701001203
SQL开始执行时间：20190701001203
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190701001203
SQL开始执行时间：20190701001203
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190701001203
SQL开始执行时间：20190701001203

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190701001205
SQL开始执行时间：20190701001205
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190701001207
SQL开始执行时间：20190701001207
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190701001209
SQL开始执行时间：20190701001209
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190701001212
SQL开始执行时间：20190701001212


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190701001213
SQL开始执行时间：20190701001213

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190701001215
SQL开始执行时间：20190701001215

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190701001448

20190702001126开始执行2019-07-01数据加载日志:
SQL开始执行时间：20190702001126


use edw
;
SQL结束执行时间：20190702001126
SQL开始执行时间：20190702001126

truncate table edw.ar_detail
;
SQL结束执行时间：20190702001126
SQL开始执行时间：20190702001126

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190702001126
SQL开始执行时间：20190702001126
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190702001128
SQL开始执行时间：20190702001128


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190702001128
SQL开始执行时间：20190702001128


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190702001202
SQL开始执行时间：20190702001202

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190702001202
SQL开始执行时间：20190702001202
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190702001203
SQL开始执行时间：20190702001203
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190702001203
SQL开始执行时间：20190702001203

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190702001204
SQL开始执行时间：20190702001204
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190702001207
SQL开始执行时间：20190702001207
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190702001209
SQL开始执行时间：20190702001209
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190702001212
SQL开始执行时间：20190702001212


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190702001213
SQL开始执行时间：20190702001213

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190702001214
SQL开始执行时间：20190702001214

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190702001444

20190702164608开始执行2019-07-02数据加载日志:
SQL开始执行时间：20190702164608


use edw
;
SQL结束执行时间：20190702164608
SQL开始执行时间：20190702164608

truncate table edw.ar_detail
;
SQL结束执行时间：20190702164608
SQL开始执行时间：20190702164608

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190702164608
SQL开始执行时间：20190702164608
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190702164610
SQL开始执行时间：20190702164610


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190702164610
SQL开始执行时间：20190702164610


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190702164645
SQL开始执行时间：20190702164645

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190702164645
SQL开始执行时间：20190702164645
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190702164645
SQL开始执行时间：20190702164645
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190702164645
SQL开始执行时间：20190702164645

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190702164647
SQL开始执行时间：20190702164647
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190702164649
SQL开始执行时间：20190702164649
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190702164652
SQL开始执行时间：20190702164652
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190702164654
SQL开始执行时间：20190702164654


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190702164656
SQL开始执行时间：20190702164656

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190702164657
SQL开始执行时间：20190702164657

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190702164930

20190703001238开始执行2019-07-02数据加载日志:
SQL开始执行时间：20190703001238


use edw
;
SQL结束执行时间：20190703001238
SQL开始执行时间：20190703001238

truncate table edw.ar_detail
;
SQL结束执行时间：20190703001238
SQL开始执行时间：20190703001238

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190703001238
SQL开始执行时间：20190703001238
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190703001240
SQL开始执行时间：20190703001240


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190703001240
SQL开始执行时间：20190703001240


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190703001316
SQL开始执行时间：20190703001316

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190703001316
SQL开始执行时间：20190703001316
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190703001317
SQL开始执行时间：20190703001317
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190703001317
SQL开始执行时间：20190703001317

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190703001319
SQL开始执行时间：20190703001319
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190703001321
SQL开始执行时间：20190703001321
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190703001323
SQL开始执行时间：20190703001323
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190703001326
SQL开始执行时间：20190703001326


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190703001327
SQL开始执行时间：20190703001327

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190703001329
SQL开始执行时间：20190703001329

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190703001605

20190704001237开始执行2019-07-03数据加载日志:
SQL开始执行时间：20190704001237


use edw
;
SQL结束执行时间：20190704001237
SQL开始执行时间：20190704001237

truncate table edw.ar_detail
;
SQL结束执行时间：20190704001237
SQL开始执行时间：20190704001237

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190704001237
SQL开始执行时间：20190704001237
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190704001240
SQL开始执行时间：20190704001240


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190704001240
SQL开始执行时间：20190704001240


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190704001316
SQL开始执行时间：20190704001316

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190704001316
SQL开始执行时间：20190704001316
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190704001316
SQL开始执行时间：20190704001316
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190704001316
SQL开始执行时间：20190704001316

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190704001318
SQL开始执行时间：20190704001318
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190704001320
SQL开始执行时间：20190704001320
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190704001323
SQL开始执行时间：20190704001323
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190704001325
SQL开始执行时间：20190704001325


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190704001327
SQL开始执行时间：20190704001327

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190704001328
SQL开始执行时间：20190704001328

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190704001608

20190704103505开始执行2019-07-04数据加载日志:
SQL开始执行时间：20190704103505


use edw
;
SQL结束执行时间：20190704103505
SQL开始执行时间：20190704103505

truncate table edw.ar_detail
;
SQL结束执行时间：20190704103505
SQL开始执行时间：20190704103505

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190704103505
SQL开始执行时间：20190704103505
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190704103508
SQL开始执行时间：20190704103508


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190704103508
SQL开始执行时间：20190704103508


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190704103544
SQL开始执行时间：20190704103544

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190704103544
SQL开始执行时间：20190704103544
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190704103544
SQL开始执行时间：20190704103544
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190704103544
SQL开始执行时间：20190704103544

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190704103546
SQL开始执行时间：20190704103546
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190704103549
SQL开始执行时间：20190704103549
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190704103551
SQL开始执行时间：20190704103551
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190704103554
SQL开始执行时间：20190704103554


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190704103555
SQL开始执行时间：20190704103555

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190704103556
SQL开始执行时间：20190704103556

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190704103835

20190705001242开始执行2019-07-04数据加载日志:
SQL开始执行时间：20190705001242


use edw
;
SQL结束执行时间：20190705001242
SQL开始执行时间：20190705001242

truncate table edw.ar_detail
;
SQL结束执行时间：20190705001243
SQL开始执行时间：20190705001243

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190705001243
SQL开始执行时间：20190705001243
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190705001245
SQL开始执行时间：20190705001245


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190705001245
SQL开始执行时间：20190705001245


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190705001322
SQL开始执行时间：20190705001322

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190705001322
SQL开始执行时间：20190705001322
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190705001322
SQL开始执行时间：20190705001322
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190705001322
SQL开始执行时间：20190705001322

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190705001324
SQL开始执行时间：20190705001324
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190705001326
SQL开始执行时间：20190705001326
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190705001329
SQL开始执行时间：20190705001329
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190705001331
SQL开始执行时间：20190705001331


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190705001333
SQL开始执行时间：20190705001333

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190705001334
SQL开始执行时间：20190705001334

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190705001618

20190706001241开始执行2019-07-05数据加载日志:
SQL开始执行时间：20190706001241


use edw
;
SQL结束执行时间：20190706001241
SQL开始执行时间：20190706001241

truncate table edw.ar_detail
;
SQL结束执行时间：20190706001241
SQL开始执行时间：20190706001241

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190706001241
SQL开始执行时间：20190706001241
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190706001243
SQL开始执行时间：20190706001243


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190706001243
SQL开始执行时间：20190706001243


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190706001320
SQL开始执行时间：20190706001320

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190706001321
SQL开始执行时间：20190706001321
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190706001321
SQL开始执行时间：20190706001321
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190706001321
SQL开始执行时间：20190706001321

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190706001323
SQL开始执行时间：20190706001323
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190706001325
SQL开始执行时间：20190706001325
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190706001327
SQL开始执行时间：20190706001327
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190706001330
SQL开始执行时间：20190706001330


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190706001331
SQL开始执行时间：20190706001331

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190706001333
SQL开始执行时间：20190706001333

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190706001617

20190707001242开始执行2019-07-06数据加载日志:
SQL开始执行时间：20190707001242


use edw
;
SQL结束执行时间：20190707001242
SQL开始执行时间：20190707001242

truncate table edw.ar_detail
;
SQL结束执行时间：20190707001242
SQL开始执行时间：20190707001242

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190707001242
SQL开始执行时间：20190707001242
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190707001244
SQL开始执行时间：20190707001244


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190707001244
SQL开始执行时间：20190707001244


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190707001321
SQL开始执行时间：20190707001321

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190707001322
SQL开始执行时间：20190707001322
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190707001322
SQL开始执行时间：20190707001322
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190707001322
SQL开始执行时间：20190707001322

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190707001324
SQL开始执行时间：20190707001324
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190707001326
SQL开始执行时间：20190707001326
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190707001328
SQL开始执行时间：20190707001328
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190707001331
SQL开始执行时间：20190707001331


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190707001333
SQL开始执行时间：20190707001333

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190707001334
SQL开始执行时间：20190707001334

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190707001620

20190708001242开始执行2019-07-07数据加载日志:
SQL开始执行时间：20190708001242


use edw
;
SQL结束执行时间：20190708001242
SQL开始执行时间：20190708001242

truncate table edw.ar_detail
;
SQL结束执行时间：20190708001243
SQL开始执行时间：20190708001243

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190708001243
SQL开始执行时间：20190708001243
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190708001245
SQL开始执行时间：20190708001245


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190708001245
SQL开始执行时间：20190708001245


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190708001323
SQL开始执行时间：20190708001323

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190708001323
SQL开始执行时间：20190708001323
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190708001323
SQL开始执行时间：20190708001323
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190708001323
SQL开始执行时间：20190708001323

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190708001325
SQL开始执行时间：20190708001325
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190708001327
SQL开始执行时间：20190708001327
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190708001330
SQL开始执行时间：20190708001330
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190708001332
SQL开始执行时间：20190708001332


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190708001334
SQL开始执行时间：20190708001334

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190708001335
SQL开始执行时间：20190708001335

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190708001621

20190709001241开始执行2019-07-08数据加载日志:
SQL开始执行时间：20190709001241


use edw
;
SQL结束执行时间：20190709001241
SQL开始执行时间：20190709001241

truncate table edw.ar_detail
;
SQL结束执行时间：20190709001241
SQL开始执行时间：20190709001241

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190709001241
SQL开始执行时间：20190709001241
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190709001244
SQL开始执行时间：20190709001244


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190709001244
SQL开始执行时间：20190709001244


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190709001322
SQL开始执行时间：20190709001322

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190709001322
SQL开始执行时间：20190709001322
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190709001322
SQL开始执行时间：20190709001322
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190709001322
SQL开始执行时间：20190709001322

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190709001324
SQL开始执行时间：20190709001324
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190709001326
SQL开始执行时间：20190709001326
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190709001329
SQL开始执行时间：20190709001329
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190709001332
SQL开始执行时间：20190709001332


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190709001333
SQL开始执行时间：20190709001333

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190709001334
SQL开始执行时间：20190709001334

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190709001620

20190710001242开始执行2019-07-09数据加载日志:
SQL开始执行时间：20190710001242


use edw
;
SQL结束执行时间：20190710001242
SQL开始执行时间：20190710001242

truncate table edw.ar_detail
;
SQL结束执行时间：20190710001242
SQL开始执行时间：20190710001242

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190710001242
SQL开始执行时间：20190710001242
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190710001244
SQL开始执行时间：20190710001244


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190710001244
SQL开始执行时间：20190710001244


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190710001322
SQL开始执行时间：20190710001322

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190710001322
SQL开始执行时间：20190710001322
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190710001322
SQL开始执行时间：20190710001322
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190710001322
SQL开始执行时间：20190710001322

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190710001324
SQL开始执行时间：20190710001324
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190710001326
SQL开始执行时间：20190710001326
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190710001329
SQL开始执行时间：20190710001329
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190710001332
SQL开始执行时间：20190710001332


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190710001333
SQL开始执行时间：20190710001333

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190710001334
SQL开始执行时间：20190710001334

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190710001620

20190711001252开始执行2019-07-10数据加载日志:
SQL开始执行时间：20190711001252


use edw
;
SQL结束执行时间：20190711001252
SQL开始执行时间：20190711001252

truncate table edw.ar_detail
;
SQL结束执行时间：20190711001252
SQL开始执行时间：20190711001252

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190711001252
SQL开始执行时间：20190711001252
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190711001254
SQL开始执行时间：20190711001254


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190711001254
SQL开始执行时间：20190711001254


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190711001331
SQL开始执行时间：20190711001331

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190711001332
SQL开始执行时间：20190711001332
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190711001332
SQL开始执行时间：20190711001332
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190711001332
SQL开始执行时间：20190711001332

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190711001334
SQL开始执行时间：20190711001334
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190711001336
SQL开始执行时间：20190711001336
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190711001338
SQL开始执行时间：20190711001338
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190711001341
SQL开始执行时间：20190711001341


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190711001342
SQL开始执行时间：20190711001342

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190711001344
SQL开始执行时间：20190711001344

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190711001630

20190712001256开始执行2019-07-11数据加载日志:
SQL开始执行时间：20190712001256


use edw
;
SQL结束执行时间：20190712001256
SQL开始执行时间：20190712001256

truncate table edw.ar_detail
;
SQL结束执行时间：20190712001256
SQL开始执行时间：20190712001256

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190712001256
SQL开始执行时间：20190712001256
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190712001259
SQL开始执行时间：20190712001259


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190712001259
SQL开始执行时间：20190712001259


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190712001337
SQL开始执行时间：20190712001337

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190712001337
SQL开始执行时间：20190712001337
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190712001337
SQL开始执行时间：20190712001337
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190712001337
SQL开始执行时间：20190712001337

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190712001339
SQL开始执行时间：20190712001339
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190712001341
SQL开始执行时间：20190712001341
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190712001344
SQL开始执行时间：20190712001344
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190712001346
SQL开始执行时间：20190712001346


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190712001348
SQL开始执行时间：20190712001348

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190712001349
SQL开始执行时间：20190712001349

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190712001635

20190713001250开始执行2019-07-12数据加载日志:
SQL开始执行时间：20190713001250


use edw
;
SQL结束执行时间：20190713001250
SQL开始执行时间：20190713001250

truncate table edw.ar_detail
;
SQL结束执行时间：20190713001250
SQL开始执行时间：20190713001250

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190713001250
SQL开始执行时间：20190713001250
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190713001253
SQL开始执行时间：20190713001253


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190713001253
SQL开始执行时间：20190713001253


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190713001331
SQL开始执行时间：20190713001331

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190713001331
SQL开始执行时间：20190713001331
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190713001331
SQL开始执行时间：20190713001331
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190713001331
SQL开始执行时间：20190713001331

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190713001333
SQL开始执行时间：20190713001333
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190713001336
SQL开始执行时间：20190713001336
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190713001338
SQL开始执行时间：20190713001338
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190713001341
SQL开始执行时间：20190713001341


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190713001342
SQL开始执行时间：20190713001342

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190713001344
SQL开始执行时间：20190713001344

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190713001631

20190714001128开始执行2019-07-13数据加载日志:
SQL开始执行时间：20190714001128


use edw
;
SQL结束执行时间：20190714001128
SQL开始执行时间：20190714001128

truncate table edw.ar_detail
;
SQL结束执行时间：20190714001128
SQL开始执行时间：20190714001128

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190714001128
SQL开始执行时间：20190714001128
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190714001131
SQL开始执行时间：20190714001131


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190714001131
SQL开始执行时间：20190714001131


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190714001208
SQL开始执行时间：20190714001208

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190714001208
SQL开始执行时间：20190714001208
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190714001209
SQL开始执行时间：20190714001209
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190714001209
SQL开始执行时间：20190714001209

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190714001211
SQL开始执行时间：20190714001211
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190714001213
SQL开始执行时间：20190714001213
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190714001216
SQL开始执行时间：20190714001216
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190714001218
SQL开始执行时间：20190714001218


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190714001220
SQL开始执行时间：20190714001220

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190714001221
SQL开始执行时间：20190714001221

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190714001508

20190715001129开始执行2019-07-14数据加载日志:
SQL开始执行时间：20190715001129


use edw
;
SQL结束执行时间：20190715001129
SQL开始执行时间：20190715001129

truncate table edw.ar_detail
;
SQL结束执行时间：20190715001129
SQL开始执行时间：20190715001129

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190715001129
SQL开始执行时间：20190715001129
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190715001131
SQL开始执行时间：20190715001131


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190715001131
SQL开始执行时间：20190715001131


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190715001209
SQL开始执行时间：20190715001209

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190715001210
SQL开始执行时间：20190715001210
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190715001210
SQL开始执行时间：20190715001210
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190715001210
SQL开始执行时间：20190715001210

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190715001212
SQL开始执行时间：20190715001212
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190715001214
SQL开始执行时间：20190715001214
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190715001217
SQL开始执行时间：20190715001217
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190715001220
SQL开始执行时间：20190715001220


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190715001221
SQL开始执行时间：20190715001221

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190715001222
SQL开始执行时间：20190715001222

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190715001509

20190716002224开始执行2019-07-15数据加载日志:
SQL开始执行时间：20190716002224


use edw
;
SQL结束执行时间：20190716002224
SQL开始执行时间：20190716002224

truncate table edw.ar_detail
;
SQL结束执行时间：20190716002224
SQL开始执行时间：20190716002224

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190716002224
SQL开始执行时间：20190716002224
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190716002226
SQL开始执行时间：20190716002226


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019'
;
SQL结束执行时间：20190716002227
SQL开始执行时间：20190716002227


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
;
SQL结束执行时间：20190716002305
SQL开始执行时间：20190716002305

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190716002305
SQL开始执行时间：20190716002305
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190716002305
SQL开始执行时间：20190716002305
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190716002306
SQL开始执行时间：20190716002306

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190716002307
SQL开始执行时间：20190716002307
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190716002310
SQL开始执行时间：20190716002310
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190716002312
SQL开始执行时间：20190716002312
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190716002315
SQL开始执行时间：20190716002315


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190716002316
SQL开始执行时间：20190716002316

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190716002318
SQL开始执行时间：20190716002318

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190716002604

20190716155454开始执行2019-07-16数据加载日志:
SQL开始执行时间：20190716155454


use edw
;
SQL结束执行时间：20190716155454
SQL开始执行时间：20190716155454

truncate table edw.ar_detail
;
SQL结束执行时间：20190716155454
SQL开始执行时间：20190716155454

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190716155454
SQL开始执行时间：20190716155454
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190716155456
SQL开始执行时间：20190716155456


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190716155456
SQL开始执行时间：20190716155456


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190716155536
SQL开始执行时间：20190716155536

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190716155536
SQL开始执行时间：20190716155536
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190716155536
SQL开始执行时间：20190716155536
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190716155536
SQL开始执行时间：20190716155536

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190716155538
SQL开始执行时间：20190716155538
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190716155541
SQL开始执行时间：20190716155541
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190716155543
SQL开始执行时间：20190716155543
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190716155546
SQL开始执行时间：20190716155546


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190716155547
SQL开始执行时间：20190716155547

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190716155549
SQL开始执行时间：20190716155549

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190716155833

20190717001304开始执行2019-07-16数据加载日志:
SQL开始执行时间：20190717001304


use edw
;
SQL结束执行时间：20190717001304
SQL开始执行时间：20190717001304

truncate table edw.ar_detail
;
SQL结束执行时间：20190717001304
SQL开始执行时间：20190717001304

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190717001304
SQL开始执行时间：20190717001304
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190717001307
SQL开始执行时间：20190717001307


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190717001307
SQL开始执行时间：20190717001307


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190717001346
SQL开始执行时间：20190717001346

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190717001346
SQL开始执行时间：20190717001346
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190717001346
SQL开始执行时间：20190717001346
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190717001346
SQL开始执行时间：20190717001346

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190717001348
SQL开始执行时间：20190717001348
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190717001350
SQL开始执行时间：20190717001350
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190717001353
SQL开始执行时间：20190717001353
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190717001355
SQL开始执行时间：20190717001355


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190717001357
SQL开始执行时间：20190717001357

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190717001358
SQL开始执行时间：20190717001358

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190717001647

20190717085457开始执行2019-07-17数据加载日志:
SQL开始执行时间：20190717085457


use edw
;
SQL结束执行时间：20190717085457
SQL开始执行时间：20190717085457

truncate table edw.ar_detail
;
SQL结束执行时间：20190717085457
SQL开始执行时间：20190717085457

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190717085457
SQL开始执行时间：20190717085457
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190717085459
SQL开始执行时间：20190717085459


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190717085459
SQL开始执行时间：20190717085459


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190717085537
SQL开始执行时间：20190717085537

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190717085538
SQL开始执行时间：20190717085538
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190717085538
SQL开始执行时间：20190717085538
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190717085538
SQL开始执行时间：20190717085538

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190717085540
SQL开始执行时间：20190717085540
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190717085542
SQL开始执行时间：20190717085542
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190717085545
SQL开始执行时间：20190717085545
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190717085548
SQL开始执行时间：20190717085548


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190717085549
SQL开始执行时间：20190717085549

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190717085550
SQL开始执行时间：20190717085550

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190717085835

20190718001258开始执行2019-07-17数据加载日志:
SQL开始执行时间：20190718001258


use edw
;
SQL结束执行时间：20190718001258
SQL开始执行时间：20190718001258

truncate table edw.ar_detail
;
SQL结束执行时间：20190718001258
SQL开始执行时间：20190718001258

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190718001258
SQL开始执行时间：20190718001258
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190718001300
SQL开始执行时间：20190718001300


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190718001300
SQL开始执行时间：20190718001300


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190718001338
SQL开始执行时间：20190718001338

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190718001338
SQL开始执行时间：20190718001338
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190718001339
SQL开始执行时间：20190718001339
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190718001339
SQL开始执行时间：20190718001339

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190718001341
SQL开始执行时间：20190718001341
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190718001343
SQL开始执行时间：20190718001343
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190718001345
SQL开始执行时间：20190718001345
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190718001348
SQL开始执行时间：20190718001348


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190718001349
SQL开始执行时间：20190718001349

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190718001351
SQL开始执行时间：20190718001351

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190718001641

20190718092408开始执行2019-07-18数据加载日志:
SQL开始执行时间：20190718092408


use edw
;
SQL结束执行时间：20190718092408
SQL开始执行时间：20190718092408

truncate table edw.ar_detail
;
SQL结束执行时间：20190718092408
SQL开始执行时间：20190718092408

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190718092408
SQL开始执行时间：20190718092408
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190718092410
SQL开始执行时间：20190718092410


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190718092411
SQL开始执行时间：20190718092411


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190718092449
SQL开始执行时间：20190718092449

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190718092449
SQL开始执行时间：20190718092449
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190718092449
SQL开始执行时间：20190718092449
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190718092449
SQL开始执行时间：20190718092449

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190718092451
SQL开始执行时间：20190718092451
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190718092454
SQL开始执行时间：20190718092454
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190718092456
SQL开始执行时间：20190718092456
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190718092459
SQL开始执行时间：20190718092459


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190718092500
SQL开始执行时间：20190718092500

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190718092502
SQL开始执行时间：20190718092502

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190718092748

20190719001257开始执行2019-07-18数据加载日志:
SQL开始执行时间：20190719001257


use edw
;
SQL结束执行时间：20190719001257
SQL开始执行时间：20190719001257

truncate table edw.ar_detail
;
SQL结束执行时间：20190719001257
SQL开始执行时间：20190719001257

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190719001257
SQL开始执行时间：20190719001257
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190719001259
SQL开始执行时间：20190719001259


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190719001259
SQL开始执行时间：20190719001259


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190719001338
SQL开始执行时间：20190719001338

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190719001338
SQL开始执行时间：20190719001338
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190719001338
SQL开始执行时间：20190719001338
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190719001338
SQL开始执行时间：20190719001338

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190719001340
SQL开始执行时间：20190719001340
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190719001342
SQL开始执行时间：20190719001342
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190719001345
SQL开始执行时间：20190719001345
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190719001348
SQL开始执行时间：20190719001348


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190719001349
SQL开始执行时间：20190719001349

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190719001350
SQL开始执行时间：20190719001350

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190719001641

20190720001251开始执行2019-07-19数据加载日志:
SQL开始执行时间：20190720001251


use edw
;
SQL结束执行时间：20190720001251
SQL开始执行时间：20190720001251

truncate table edw.ar_detail
;
SQL结束执行时间：20190720001251
SQL开始执行时间：20190720001251

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190720001251
SQL开始执行时间：20190720001251
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190720001253
SQL开始执行时间：20190720001253


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190720001254
SQL开始执行时间：20190720001254


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190720001331
SQL开始执行时间：20190720001331

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190720001331
SQL开始执行时间：20190720001331
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190720001331
SQL开始执行时间：20190720001331
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190720001331
SQL开始执行时间：20190720001331

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190720001333
SQL开始执行时间：20190720001333
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190720001335
SQL开始执行时间：20190720001335
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190720001338
SQL开始执行时间：20190720001338
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190720001340
SQL开始执行时间：20190720001340


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190720001342
SQL开始执行时间：20190720001342

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190720001343
SQL开始执行时间：20190720001343

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190720001628

20190721001255开始执行2019-07-20数据加载日志:
SQL开始执行时间：20190721001255


use edw
;
SQL结束执行时间：20190721001255
SQL开始执行时间：20190721001255

truncate table edw.ar_detail
;
SQL结束执行时间：20190721001255
SQL开始执行时间：20190721001255

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190721001255
SQL开始执行时间：20190721001255
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190721001257
SQL开始执行时间：20190721001257


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190721001258
SQL开始执行时间：20190721001258


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190721001335
SQL开始执行时间：20190721001335

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190721001335
SQL开始执行时间：20190721001335
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190721001335
SQL开始执行时间：20190721001335
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190721001335
SQL开始执行时间：20190721001335

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190721001337
SQL开始执行时间：20190721001337
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190721001339
SQL开始执行时间：20190721001339
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190721001342
SQL开始执行时间：20190721001342
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190721001344
SQL开始执行时间：20190721001344


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190721001346
SQL开始执行时间：20190721001346

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190721001347
SQL开始执行时间：20190721001347

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190721001634

20190722001256开始执行2019-07-21数据加载日志:
SQL开始执行时间：20190722001256


use edw
;
SQL结束执行时间：20190722001256
SQL开始执行时间：20190722001256

truncate table edw.ar_detail
;
SQL结束执行时间：20190722001256
SQL开始执行时间：20190722001256

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190722001256
SQL开始执行时间：20190722001256
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190722001258
SQL开始执行时间：20190722001258


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190722001258
SQL开始执行时间：20190722001258


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190722001335
SQL开始执行时间：20190722001335

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190722001336
SQL开始执行时间：20190722001336
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190722001336
SQL开始执行时间：20190722001336
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190722001336
SQL开始执行时间：20190722001336

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190722001338
SQL开始执行时间：20190722001338
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190722001340
SQL开始执行时间：20190722001340
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190722001342
SQL开始执行时间：20190722001342
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190722001345
SQL开始执行时间：20190722001345


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190722001346
SQL开始执行时间：20190722001346

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190722001348
SQL开始执行时间：20190722001348

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190722001634

20190723001253开始执行2019-07-22数据加载日志:
SQL开始执行时间：20190723001253


use edw
;
SQL结束执行时间：20190723001253
SQL开始执行时间：20190723001253

truncate table edw.ar_detail
;
SQL结束执行时间：20190723001253
SQL开始执行时间：20190723001253

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190723001253
SQL开始执行时间：20190723001253
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190723001255
SQL开始执行时间：20190723001255


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190723001255
SQL开始执行时间：20190723001255


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190723001333
SQL开始执行时间：20190723001333

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190723001333
SQL开始执行时间：20190723001333
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190723001333
SQL开始执行时间：20190723001333
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190723001334
SQL开始执行时间：20190723001334

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190723001335
SQL开始执行时间：20190723001335
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190723001338
SQL开始执行时间：20190723001338
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190723001340
SQL开始执行时间：20190723001340
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190723001342
SQL开始执行时间：20190723001342


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190723001344
SQL开始执行时间：20190723001344

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190723001345
SQL开始执行时间：20190723001345

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190723001631

20190724001257开始执行2019-07-23数据加载日志:
SQL开始执行时间：20190724001257


use edw
;
SQL结束执行时间：20190724001257
SQL开始执行时间：20190724001257

truncate table edw.ar_detail
;
SQL结束执行时间：20190724001257
SQL开始执行时间：20190724001257

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190724001257
SQL开始执行时间：20190724001257
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190724001259
SQL开始执行时间：20190724001259


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190724001259
SQL开始执行时间：20190724001259


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190724001337
SQL开始执行时间：20190724001337

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190724001337
SQL开始执行时间：20190724001337
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190724001337
SQL开始执行时间：20190724001337
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190724001337
SQL开始执行时间：20190724001337

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190724001339
SQL开始执行时间：20190724001339
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190724001341
SQL开始执行时间：20190724001341
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190724001344
SQL开始执行时间：20190724001344
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190724001346
SQL开始执行时间：20190724001346


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190724001348
SQL开始执行时间：20190724001348

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190724001349
SQL开始执行时间：20190724001349

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190724001634

20190725001255开始执行2019-07-24数据加载日志:
SQL开始执行时间：20190725001255


use edw
;
SQL结束执行时间：20190725001255
SQL开始执行时间：20190725001255

truncate table edw.ar_detail
;
SQL结束执行时间：20190725001255
SQL开始执行时间：20190725001255

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190725001255
SQL开始执行时间：20190725001255
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190725001257
SQL开始执行时间：20190725001257


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190725001258
SQL开始执行时间：20190725001258


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190725001335
SQL开始执行时间：20190725001335

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190725001335
SQL开始执行时间：20190725001335
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190725001335
SQL开始执行时间：20190725001335
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190725001336
SQL开始执行时间：20190725001336

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190725001337
SQL开始执行时间：20190725001337
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190725001340
SQL开始执行时间：20190725001340
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190725001342
SQL开始执行时间：20190725001342
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190725001345
SQL开始执行时间：20190725001345


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190725001346
SQL开始执行时间：20190725001346

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190725001348
SQL开始执行时间：20190725001348

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190725001634

20190726001254开始执行2019-07-25数据加载日志:
SQL开始执行时间：20190726001254


use edw
;
SQL结束执行时间：20190726001254
SQL开始执行时间：20190726001254

truncate table edw.ar_detail
;
SQL结束执行时间：20190726001254
SQL开始执行时间：20190726001254

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190726001254
SQL开始执行时间：20190726001254
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190726001256
SQL开始执行时间：20190726001256


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190726001257
SQL开始执行时间：20190726001257


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190726001335
SQL开始执行时间：20190726001335

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190726001335
SQL开始执行时间：20190726001335
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190726001335
SQL开始执行时间：20190726001335
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190726001335
SQL开始执行时间：20190726001335

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190726001337
SQL开始执行时间：20190726001337
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190726001339
SQL开始执行时间：20190726001339
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190726001341
SQL开始执行时间：20190726001341
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190726001344
SQL开始执行时间：20190726001344


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190726001346
SQL开始执行时间：20190726001346

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190726001347
SQL开始执行时间：20190726001347

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190726001634

20190727001300开始执行2019-07-26数据加载日志:
SQL开始执行时间：20190727001300


use edw
;
SQL结束执行时间：20190727001300
SQL开始执行时间：20190727001300

truncate table edw.ar_detail
;
SQL结束执行时间：20190727001300
SQL开始执行时间：20190727001300

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190727001300
SQL开始执行时间：20190727001300
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190727001302
SQL开始执行时间：20190727001302


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190727001302
SQL开始执行时间：20190727001302


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190727001341
SQL开始执行时间：20190727001341

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190727001341
SQL开始执行时间：20190727001341
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190727001341
SQL开始执行时间：20190727001341
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190727001341
SQL开始执行时间：20190727001341

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190727001343
SQL开始执行时间：20190727001343
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190727001346
SQL开始执行时间：20190727001346
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190727001348
SQL开始执行时间：20190727001348
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190727001351
SQL开始执行时间：20190727001351


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190727001352
SQL开始执行时间：20190727001352

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190727001354
SQL开始执行时间：20190727001354

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190727001645

20190728001300开始执行2019-07-27数据加载日志:
SQL开始执行时间：20190728001300


use edw
;
SQL结束执行时间：20190728001300
SQL开始执行时间：20190728001300

truncate table edw.ar_detail
;
SQL结束执行时间：20190728001300
SQL开始执行时间：20190728001300

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190728001300
SQL开始执行时间：20190728001300
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190728001302
SQL开始执行时间：20190728001302


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190728001302
SQL开始执行时间：20190728001302


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190728001341
SQL开始执行时间：20190728001341

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190728001341
SQL开始执行时间：20190728001341
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190728001341
SQL开始执行时间：20190728001341
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190728001341
SQL开始执行时间：20190728001341

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190728001343
SQL开始执行时间：20190728001343
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190728001346
SQL开始执行时间：20190728001346
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190728001348
SQL开始执行时间：20190728001348
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190728001351
SQL开始执行时间：20190728001351


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190728001352
SQL开始执行时间：20190728001352

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190728001354
SQL开始执行时间：20190728001354

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190728001646

20190729001258开始执行2019-07-28数据加载日志:
SQL开始执行时间：20190729001258


use edw
;
SQL结束执行时间：20190729001258
SQL开始执行时间：20190729001258

truncate table edw.ar_detail
;
SQL结束执行时间：20190729001258
SQL开始执行时间：20190729001258

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190729001258
SQL开始执行时间：20190729001258
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190729001300
SQL开始执行时间：20190729001300


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190729001300
SQL开始执行时间：20190729001300


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190729001339
SQL开始执行时间：20190729001339

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190729001339
SQL开始执行时间：20190729001339
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190729001339
SQL开始执行时间：20190729001339
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190729001340
SQL开始执行时间：20190729001340

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190729001341
SQL开始执行时间：20190729001341
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190729001344
SQL开始执行时间：20190729001344
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190729001346
SQL开始执行时间：20190729001346
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190729001349
SQL开始执行时间：20190729001349


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190729001350
SQL开始执行时间：20190729001350

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190729001352
SQL开始执行时间：20190729001352

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190729001643

20190730001319开始执行2019-07-29数据加载日志:
SQL开始执行时间：20190730001319


use edw
;
SQL结束执行时间：20190730001319
SQL开始执行时间：20190730001319

truncate table edw.ar_detail
;
SQL结束执行时间：20190730001319
SQL开始执行时间：20190730001319

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190730001319
SQL开始执行时间：20190730001319
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190730001322
SQL开始执行时间：20190730001322


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190730001322
SQL开始执行时间：20190730001322


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190730001404
SQL开始执行时间：20190730001404

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190730001404
SQL开始执行时间：20190730001404
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190730001405
SQL开始执行时间：20190730001405
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190730001405
SQL开始执行时间：20190730001405

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190730001407
SQL开始执行时间：20190730001407
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190730001409
SQL开始执行时间：20190730001409
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190730001411
SQL开始执行时间：20190730001411
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190730001414
SQL开始执行时间：20190730001414


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190730001416
SQL开始执行时间：20190730001416

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190730001417
SQL开始执行时间：20190730001417

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190730001720

20190731001309开始执行2019-07-30数据加载日志:
SQL开始执行时间：20190731001309


use edw
;
SQL结束执行时间：20190731001309
SQL开始执行时间：20190731001309

truncate table edw.ar_detail
;
SQL结束执行时间：20190731001309
SQL开始执行时间：20190731001309

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190731001309
SQL开始执行时间：20190731001309
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190731001311
SQL开始执行时间：20190731001311


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190731001312
SQL开始执行时间：20190731001312


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190731001352
SQL开始执行时间：20190731001352

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190731001353
SQL开始执行时间：20190731001353
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190731001353
SQL开始执行时间：20190731001353
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190731001353
SQL开始执行时间：20190731001353

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190731001355
SQL开始执行时间：20190731001355
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190731001357
SQL开始执行时间：20190731001357
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190731001400
SQL开始执行时间：20190731001400
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190731001403
SQL开始执行时间：20190731001403


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190731001405
SQL开始执行时间：20190731001405

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190731001406
SQL开始执行时间：20190731001406

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190731001705

20190801001258开始执行2019-07-31数据加载日志:
SQL开始执行时间：20190801001258


use edw
;
SQL结束执行时间：20190801001258
SQL开始执行时间：20190801001258

truncate table edw.ar_detail
;
SQL结束执行时间：20190801001258
SQL开始执行时间：20190801001258

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190801001258
SQL开始执行时间：20190801001258
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190801001300
SQL开始执行时间：20190801001300


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190801001300
SQL开始执行时间：20190801001300


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190801001339
SQL开始执行时间：20190801001339

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190801001339
SQL开始执行时间：20190801001339
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190801001339
SQL开始执行时间：20190801001339
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190801001339
SQL开始执行时间：20190801001339

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190801001341
SQL开始执行时间：20190801001341
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190801001343
SQL开始执行时间：20190801001343
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190801001346
SQL开始执行时间：20190801001346
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190801001348
SQL开始执行时间：20190801001348


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190801001350
SQL开始执行时间：20190801001350

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190801001351
SQL开始执行时间：20190801001351

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190801001642

20190802001307开始执行2019-08-01数据加载日志:
SQL开始执行时间：20190802001307


use edw
;
SQL结束执行时间：20190802001307
SQL开始执行时间：20190802001307

truncate table edw.ar_detail
;
SQL结束执行时间：20190802001307
SQL开始执行时间：20190802001307

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190802001307
SQL开始执行时间：20190802001307
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190802001309
SQL开始执行时间：20190802001309


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190802001309
SQL开始执行时间：20190802001309


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190802001350
SQL开始执行时间：20190802001350

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190802001350
SQL开始执行时间：20190802001350
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190802001350
SQL开始执行时间：20190802001350
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190802001350
SQL开始执行时间：20190802001350

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190802001352
SQL开始执行时间：20190802001352
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190802001355
SQL开始执行时间：20190802001355
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190802001357
SQL开始执行时间：20190802001357
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190802001400
SQL开始执行时间：20190802001400


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190802001401
SQL开始执行时间：20190802001401

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190802001403
SQL开始执行时间：20190802001403

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190802001701

20190803001316开始执行2019-08-02数据加载日志:
SQL开始执行时间：20190803001316


use edw
;
SQL结束执行时间：20190803001316
SQL开始执行时间：20190803001316

truncate table edw.ar_detail
;
SQL结束执行时间：20190803001316
SQL开始执行时间：20190803001316

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190803001316
SQL开始执行时间：20190803001316
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190803001319
SQL开始执行时间：20190803001319


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190803001319
SQL开始执行时间：20190803001319


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190803001401
SQL开始执行时间：20190803001401

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190803001401
SQL开始执行时间：20190803001401
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190803001401
SQL开始执行时间：20190803001401
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190803001401
SQL开始执行时间：20190803001401

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190803001403
SQL开始执行时间：20190803001403
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190803001406
SQL开始执行时间：20190803001406
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190803001408
SQL开始执行时间：20190803001408
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190803001411
SQL开始执行时间：20190803001411


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190803001412
SQL开始执行时间：20190803001412

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190803001414
SQL开始执行时间：20190803001414

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190803001718

20190804001309开始执行2019-08-03数据加载日志:
SQL开始执行时间：20190804001309


use edw
;
SQL结束执行时间：20190804001309
SQL开始执行时间：20190804001309

truncate table edw.ar_detail
;
SQL结束执行时间：20190804001309
SQL开始执行时间：20190804001309

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190804001309
SQL开始执行时间：20190804001309
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190804001311
SQL开始执行时间：20190804001311


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190804001311
SQL开始执行时间：20190804001311


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190804001354
SQL开始执行时间：20190804001354

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190804001354
SQL开始执行时间：20190804001354
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190804001354
SQL开始执行时间：20190804001354
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190804001354
SQL开始执行时间：20190804001354

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190804001356
SQL开始执行时间：20190804001356
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190804001359
SQL开始执行时间：20190804001359
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190804001401
SQL开始执行时间：20190804001401
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190804001404
SQL开始执行时间：20190804001404


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190804001406
SQL开始执行时间：20190804001406

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190804001407
SQL开始执行时间：20190804001407

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190804001708

20190805001308开始执行2019-08-04数据加载日志:
SQL开始执行时间：20190805001308


use edw
;
SQL结束执行时间：20190805001308
SQL开始执行时间：20190805001308

truncate table edw.ar_detail
;
SQL结束执行时间：20190805001308
SQL开始执行时间：20190805001308

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190805001308
SQL开始执行时间：20190805001308
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190805001310
SQL开始执行时间：20190805001310


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190805001310
SQL开始执行时间：20190805001310


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190805001352
SQL开始执行时间：20190805001352

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190805001352
SQL开始执行时间：20190805001352
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190805001353
SQL开始执行时间：20190805001353
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190805001353
SQL开始执行时间：20190805001353

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190805001355
SQL开始执行时间：20190805001355
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190805001357
SQL开始执行时间：20190805001357
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190805001400
SQL开始执行时间：20190805001400
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190805001403
SQL开始执行时间：20190805001403


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190805001404
SQL开始执行时间：20190805001404

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190805001406
SQL开始执行时间：20190805001406

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190805001712

20190806001302开始执行2019-08-05数据加载日志:
SQL开始执行时间：20190806001302


use edw
;
SQL结束执行时间：20190806001302
SQL开始执行时间：20190806001302

truncate table edw.ar_detail
;
SQL结束执行时间：20190806001302
SQL开始执行时间：20190806001302

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190806001302
SQL开始执行时间：20190806001302
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190806001305
SQL开始执行时间：20190806001305


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190806001305
SQL开始执行时间：20190806001305


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190806001345
SQL开始执行时间：20190806001345

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190806001345
SQL开始执行时间：20190806001345
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190806001345
SQL开始执行时间：20190806001345
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190806001345
SQL开始执行时间：20190806001345

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190806001347
SQL开始执行时间：20190806001347
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190806001349
SQL开始执行时间：20190806001349
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190806001352
SQL开始执行时间：20190806001352
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190806001355
SQL开始执行时间：20190806001355


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190806001356
SQL开始执行时间：20190806001356

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190806001358
SQL开始执行时间：20190806001358

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190806001653

20190806093423开始执行2019-08-06数据加载日志:
SQL开始执行时间：20190806093423


use edw
;
SQL结束执行时间：20190806093423
SQL开始执行时间：20190806093423

truncate table edw.ar_detail
;
SQL结束执行时间：20190806093423
SQL开始执行时间：20190806093423

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190806093423
SQL开始执行时间：20190806093423
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190806093426
SQL开始执行时间：20190806093426


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190806093426
SQL开始执行时间：20190806093426


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190806093505
SQL开始执行时间：20190806093505

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190806093505
SQL开始执行时间：20190806093505
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190806093506
SQL开始执行时间：20190806093506
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190806093506
SQL开始执行时间：20190806093506

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190806093508
SQL开始执行时间：20190806093508
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190806093510
SQL开始执行时间：20190806093510
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190806093513
SQL开始执行时间：20190806093513
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190806093516
SQL开始执行时间：20190806093516


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190806093517
SQL开始执行时间：20190806093517

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190806093518
SQL开始执行时间：20190806093518

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190806094126

20190807001254开始执行2019-08-06数据加载日志:
SQL开始执行时间：20190807001254


use edw
;
SQL结束执行时间：20190807001254
SQL开始执行时间：20190807001254

truncate table edw.ar_detail
;
SQL结束执行时间：20190807001254
SQL开始执行时间：20190807001254

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190807001254
SQL开始执行时间：20190807001254
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190807001257
SQL开始执行时间：20190807001257


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190807001257
SQL开始执行时间：20190807001257


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190807001338
SQL开始执行时间：20190807001338

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190807001338
SQL开始执行时间：20190807001338
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190807001338
SQL开始执行时间：20190807001338
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190807001338
SQL开始执行时间：20190807001338

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190807001340
SQL开始执行时间：20190807001340
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190807001342
SQL开始执行时间：20190807001342
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190807001345
SQL开始执行时间：20190807001345
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190807001348
SQL开始执行时间：20190807001348


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190807001349
SQL开始执行时间：20190807001349

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190807001351
SQL开始执行时间：20190807001351

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190807001649

20190808001255开始执行2019-08-07数据加载日志:
SQL开始执行时间：20190808001255


use edw
;
SQL结束执行时间：20190808001255
SQL开始执行时间：20190808001255

truncate table edw.ar_detail
;
SQL结束执行时间：20190808001255
SQL开始执行时间：20190808001255

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190808001255
SQL开始执行时间：20190808001255
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190808001257
SQL开始执行时间：20190808001257


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190808001257
SQL开始执行时间：20190808001257


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190808001338
SQL开始执行时间：20190808001338

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190808001338
SQL开始执行时间：20190808001338
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190808001339
SQL开始执行时间：20190808001339
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190808001339
SQL开始执行时间：20190808001339

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190808001341
SQL开始执行时间：20190808001341
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190808001343
SQL开始执行时间：20190808001343
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190808001345
SQL开始执行时间：20190808001345
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190808001348
SQL开始执行时间：20190808001348


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190808001350
SQL开始执行时间：20190808001350

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190808001351
SQL开始执行时间：20190808001351

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190808001649

20190809001302开始执行2019-08-08数据加载日志:
SQL开始执行时间：20190809001302


use edw
;
SQL结束执行时间：20190809001302
SQL开始执行时间：20190809001302

truncate table edw.ar_detail
;
SQL结束执行时间：20190809001302
SQL开始执行时间：20190809001302

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190809001302
SQL开始执行时间：20190809001302
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190809001304
SQL开始执行时间：20190809001304


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190809001304
SQL开始执行时间：20190809001304


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190809001345
SQL开始执行时间：20190809001345

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190809001345
SQL开始执行时间：20190809001345
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190809001345
SQL开始执行时间：20190809001345
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190809001345
SQL开始执行时间：20190809001345

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190809001347
SQL开始执行时间：20190809001347
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190809001349
SQL开始执行时间：20190809001349
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190809001352
SQL开始执行时间：20190809001352
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190809001355
SQL开始执行时间：20190809001355


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190809001356
SQL开始执行时间：20190809001356

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190809001358
SQL开始执行时间：20190809001358

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190809001654

20190810001311开始执行2019-08-09数据加载日志:
SQL开始执行时间：20190810001311


use edw
;
SQL结束执行时间：20190810001311
SQL开始执行时间：20190810001311

truncate table edw.ar_detail
;
SQL结束执行时间：20190810001311
SQL开始执行时间：20190810001311

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190810001311
SQL开始执行时间：20190810001311
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190810001314
SQL开始执行时间：20190810001314


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190810001314
SQL开始执行时间：20190810001314


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190810001356
SQL开始执行时间：20190810001356

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190810001356
SQL开始执行时间：20190810001356
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190810001356
SQL开始执行时间：20190810001356
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190810001356
SQL开始执行时间：20190810001356

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190810001358
SQL开始执行时间：20190810001358
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190810001401
SQL开始执行时间：20190810001401
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190810001403
SQL开始执行时间：20190810001403
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190810001406
SQL开始执行时间：20190810001406


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190810001408
SQL开始执行时间：20190810001408

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190810001409
SQL开始执行时间：20190810001409

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190810001714

20190811001144开始执行2019-08-10数据加载日志:
SQL开始执行时间：20190811001144


use edw
;
SQL结束执行时间：20190811001144
SQL开始执行时间：20190811001144

truncate table edw.ar_detail
;
SQL结束执行时间：20190811001144
SQL开始执行时间：20190811001144

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190811001144
SQL开始执行时间：20190811001144
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190811001147
SQL开始执行时间：20190811001147


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190811001147
SQL开始执行时间：20190811001147


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190811001228
SQL开始执行时间：20190811001228

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190811001228
SQL开始执行时间：20190811001228
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190811001229
SQL开始执行时间：20190811001229
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190811001229
SQL开始执行时间：20190811001229

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190811001231
SQL开始执行时间：20190811001231
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190811001233
SQL开始执行时间：20190811001233
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190811001236
SQL开始执行时间：20190811001236
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190811001239
SQL开始执行时间：20190811001239


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190811001240
SQL开始执行时间：20190811001240

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190811001241
SQL开始执行时间：20190811001241

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190811001543

20190812001135开始执行2019-08-11数据加载日志:
SQL开始执行时间：20190812001135


use edw
;
SQL结束执行时间：20190812001135
SQL开始执行时间：20190812001135

truncate table edw.ar_detail
;
SQL结束执行时间：20190812001135
SQL开始执行时间：20190812001135

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190812001135
SQL开始执行时间：20190812001135
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190812001137
SQL开始执行时间：20190812001137


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190812001137
SQL开始执行时间：20190812001137


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190812001219
SQL开始执行时间：20190812001219

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190812001219
SQL开始执行时间：20190812001219
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190812001219
SQL开始执行时间：20190812001219
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190812001219
SQL开始执行时间：20190812001219

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190812001221
SQL开始执行时间：20190812001221
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190812001223
SQL开始执行时间：20190812001223
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190812001226
SQL开始执行时间：20190812001226
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190812001229
SQL开始执行时间：20190812001229


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190812001230
SQL开始执行时间：20190812001230

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190812001232
SQL开始执行时间：20190812001232

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190812001533

20190813001305开始执行2019-08-12数据加载日志:
SQL开始执行时间：20190813001305


use edw
;
SQL结束执行时间：20190813001305
SQL开始执行时间：20190813001305

truncate table edw.ar_detail
;
SQL结束执行时间：20190813001305
SQL开始执行时间：20190813001305

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190813001305
SQL开始执行时间：20190813001305
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190813001308
SQL开始执行时间：20190813001308


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190813001308
SQL开始执行时间：20190813001308


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190813001348
SQL开始执行时间：20190813001348

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190813001349
SQL开始执行时间：20190813001349
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190813001349
SQL开始执行时间：20190813001349
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190813001349
SQL开始执行时间：20190813001349

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190813001351
SQL开始执行时间：20190813001351
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190813001353
SQL开始执行时间：20190813001353
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190813001356
SQL开始执行时间：20190813001356
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190813001358
SQL开始执行时间：20190813001358


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190813001400
SQL开始执行时间：20190813001400

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190813001401
SQL开始执行时间：20190813001401

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190813001700

20190814001258开始执行2019-08-13数据加载日志:
SQL开始执行时间：20190814001258


use edw
;
SQL结束执行时间：20190814001258
SQL开始执行时间：20190814001258

truncate table edw.ar_detail
;
SQL结束执行时间：20190814001258
SQL开始执行时间：20190814001258

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190814001258
SQL开始执行时间：20190814001258
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190814001300
SQL开始执行时间：20190814001300


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190814001300
SQL开始执行时间：20190814001300


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190814001341
SQL开始执行时间：20190814001341

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190814001341
SQL开始执行时间：20190814001341
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190814001341
SQL开始执行时间：20190814001341
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190814001341
SQL开始执行时间：20190814001341

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190814001343
SQL开始执行时间：20190814001343
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190814001345
SQL开始执行时间：20190814001345
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190814001348
SQL开始执行时间：20190814001348
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190814001351
SQL开始执行时间：20190814001351


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190814001352
SQL开始执行时间：20190814001352

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190814001354
SQL开始执行时间：20190814001354

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190814001656

20190815001259开始执行2019-08-14数据加载日志:
SQL开始执行时间：20190815001259


use edw
;
SQL结束执行时间：20190815001259
SQL开始执行时间：20190815001259

truncate table edw.ar_detail
;
SQL结束执行时间：20190815001259
SQL开始执行时间：20190815001259

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190815001259
SQL开始执行时间：20190815001259
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190815001301
SQL开始执行时间：20190815001301


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190815001301
SQL开始执行时间：20190815001301


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190815001342
SQL开始执行时间：20190815001342

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190815001342
SQL开始执行时间：20190815001342
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190815001343
SQL开始执行时间：20190815001343
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190815001343
SQL开始执行时间：20190815001343

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190815001345
SQL开始执行时间：20190815001345
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190815001347
SQL开始执行时间：20190815001347
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190815001349
SQL开始执行时间：20190815001349
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190815001352
SQL开始执行时间：20190815001352


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190815001354
SQL开始执行时间：20190815001354

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190815001355
SQL开始执行时间：20190815001355

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190815001653

20190815100023开始执行2019-08-15数据加载日志:
SQL开始执行时间：20190815100023


use edw
;
SQL结束执行时间：20190815100023
SQL开始执行时间：20190815100023

truncate table edw.ar_detail
;
SQL结束执行时间：20190815100023
SQL开始执行时间：20190815100023

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190815100023
SQL开始执行时间：20190815100023
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190815100025
SQL开始执行时间：20190815100025


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190815100025
SQL开始执行时间：20190815100025


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190815100104
SQL开始执行时间：20190815100104

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190815100104
SQL开始执行时间：20190815100104
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190815100105
SQL开始执行时间：20190815100105
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190815100105
SQL开始执行时间：20190815100105

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190815100107
SQL开始执行时间：20190815100107
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190815100109
SQL开始执行时间：20190815100109
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190815100112
SQL开始执行时间：20190815100112
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190815100115
SQL开始执行时间：20190815100115


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190815100116
SQL开始执行时间：20190815100116

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190815100118
SQL开始执行时间：20190815100118

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190815100411

20190816001301开始执行2019-08-15数据加载日志:
SQL开始执行时间：20190816001301


use edw
;
SQL结束执行时间：20190816001301
SQL开始执行时间：20190816001301

truncate table edw.ar_detail
;
SQL结束执行时间：20190816001301
SQL开始执行时间：20190816001301

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190816001301
SQL开始执行时间：20190816001301
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190816001303
SQL开始执行时间：20190816001303


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190816001304
SQL开始执行时间：20190816001304


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190816001345
SQL开始执行时间：20190816001345

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190816001345
SQL开始执行时间：20190816001345
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190816001345
SQL开始执行时间：20190816001345
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190816001346
SQL开始执行时间：20190816001346

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190816001347
SQL开始执行时间：20190816001347
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190816001350
SQL开始执行时间：20190816001350
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190816001352
SQL开始执行时间：20190816001352
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190816001355
SQL开始执行时间：20190816001355


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190816001357
SQL开始执行时间：20190816001357

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190816001358
SQL开始执行时间：20190816001358

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190816001702

20190817001259开始执行2019-08-16数据加载日志:
SQL开始执行时间：20190817001259


use edw
;
SQL结束执行时间：20190817001259
SQL开始执行时间：20190817001259

truncate table edw.ar_detail
;
SQL结束执行时间：20190817001259
SQL开始执行时间：20190817001259

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190817001259
SQL开始执行时间：20190817001259
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190817001302
SQL开始执行时间：20190817001302


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190817001302
SQL开始执行时间：20190817001302


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190817001343
SQL开始执行时间：20190817001343

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190817001344
SQL开始执行时间：20190817001344
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190817001344
SQL开始执行时间：20190817001344
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190817001344
SQL开始执行时间：20190817001344

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190817001346
SQL开始执行时间：20190817001346
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190817001348
SQL开始执行时间：20190817001348
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190817001351
SQL开始执行时间：20190817001351
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190817001354
SQL开始执行时间：20190817001354


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190817001355
SQL开始执行时间：20190817001355

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190817001357
SQL开始执行时间：20190817001357

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190817001703

20190820090124开始执行2019-08-19数据加载日志:
SQL开始执行时间：20190820090124


use edw
;
SQL结束执行时间：20190820090124
SQL开始执行时间：20190820090124

truncate table edw.ar_detail
;
SQL结束执行时间：20190820090124
SQL开始执行时间：20190820090124

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190820090124
SQL开始执行时间：20190820090124
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190820090126
SQL开始执行时间：20190820090126


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190820090127
SQL开始执行时间：20190820090127


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190820090207
SQL开始执行时间：20190820090207

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190820090207
SQL开始执行时间：20190820090207
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190820090207
SQL开始执行时间：20190820090207
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190820090207
SQL开始执行时间：20190820090207

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190820090210
SQL开始执行时间：20190820090210
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190820090212
SQL开始执行时间：20190820090212
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190820090215
SQL开始执行时间：20190820090215
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190820090218
SQL开始执行时间：20190820090218


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190820090219
SQL开始执行时间：20190820090219

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190820090220
SQL开始执行时间：20190820090220

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190820090519

20190821001301开始执行2019-08-20数据加载日志:
SQL开始执行时间：20190821001301


use edw
;
SQL结束执行时间：20190821001301
SQL开始执行时间：20190821001301

truncate table edw.ar_detail
;
SQL结束执行时间：20190821001301
SQL开始执行时间：20190821001301

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190821001301
SQL开始执行时间：20190821001301
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190821001304
SQL开始执行时间：20190821001304


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190821001304
SQL开始执行时间：20190821001304


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190821001345
SQL开始执行时间：20190821001345

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190821001345
SQL开始执行时间：20190821001345
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190821001346
SQL开始执行时间：20190821001346
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190821001346
SQL开始执行时间：20190821001346

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190821001348
SQL开始执行时间：20190821001348
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190821001350
SQL开始执行时间：20190821001350
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190821001353
SQL开始执行时间：20190821001353
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190821001355
SQL开始执行时间：20190821001355


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190821001357
SQL开始执行时间：20190821001357

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190821001358
SQL开始执行时间：20190821001358

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190821001705

20190822001254开始执行2019-08-21数据加载日志:
SQL开始执行时间：20190822001254


use edw
;
SQL结束执行时间：20190822001254
SQL开始执行时间：20190822001254

truncate table edw.ar_detail
;
SQL结束执行时间：20190822001254
SQL开始执行时间：20190822001254

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190822001254
SQL开始执行时间：20190822001254
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190822001256
SQL开始执行时间：20190822001256


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190822001256
SQL开始执行时间：20190822001256


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190822001337
SQL开始执行时间：20190822001337

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190822001338
SQL开始执行时间：20190822001338
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190822001338
SQL开始执行时间：20190822001338
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190822001338
SQL开始执行时间：20190822001338

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190822001340
SQL开始执行时间：20190822001340
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190822001342
SQL开始执行时间：20190822001342
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190822001345
SQL开始执行时间：20190822001345
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190822001347
SQL开始执行时间：20190822001347


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190822001349
SQL开始执行时间：20190822001349

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190822001351
SQL开始执行时间：20190822001351

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190822001655

20190823001255开始执行2019-08-22数据加载日志:
SQL开始执行时间：20190823001255


use edw
;
SQL结束执行时间：20190823001255
SQL开始执行时间：20190823001255

truncate table edw.ar_detail
;
SQL结束执行时间：20190823001256
SQL开始执行时间：20190823001256

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190823001256
SQL开始执行时间：20190823001256
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190823001258
SQL开始执行时间：20190823001258


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190823001258
SQL开始执行时间：20190823001258


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190823001340
SQL开始执行时间：20190823001340

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190823001340
SQL开始执行时间：20190823001340
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190823001340
SQL开始执行时间：20190823001340
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190823001340
SQL开始执行时间：20190823001340

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190823001342
SQL开始执行时间：20190823001342
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190823001344
SQL开始执行时间：20190823001344
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190823001347
SQL开始执行时间：20190823001347
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190823001350
SQL开始执行时间：20190823001350


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190823001351
SQL开始执行时间：20190823001351

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190823001353
SQL开始执行时间：20190823001353

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190823001700

20190824001315开始执行2019-08-23数据加载日志:
SQL开始执行时间：20190824001315


use edw
;
SQL结束执行时间：20190824001315
SQL开始执行时间：20190824001315

truncate table edw.ar_detail
;
SQL结束执行时间：20190824001315
SQL开始执行时间：20190824001315

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190824001315
SQL开始执行时间：20190824001315
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190824001317
SQL开始执行时间：20190824001317


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190824001317
SQL开始执行时间：20190824001317


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190824001359
SQL开始执行时间：20190824001359

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190824001400
SQL开始执行时间：20190824001400
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190824001400
SQL开始执行时间：20190824001400
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190824001400
SQL开始执行时间：20190824001400

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190824001402
SQL开始执行时间：20190824001402
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190824001404
SQL开始执行时间：20190824001404
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190824001407
SQL开始执行时间：20190824001407
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190824001410
SQL开始执行时间：20190824001410


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190824001411
SQL开始执行时间：20190824001411

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190824001413
SQL开始执行时间：20190824001413

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190824001723

20190825001255开始执行2019-08-24数据加载日志:
SQL开始执行时间：20190825001255


use edw
;
SQL结束执行时间：20190825001255
SQL开始执行时间：20190825001255

truncate table edw.ar_detail
;
SQL结束执行时间：20190825001255
SQL开始执行时间：20190825001255

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190825001255
SQL开始执行时间：20190825001255
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190825001258
SQL开始执行时间：20190825001258


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190825001258
SQL开始执行时间：20190825001258


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190825001340
SQL开始执行时间：20190825001340

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190825001341
SQL开始执行时间：20190825001341
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190825001341
SQL开始执行时间：20190825001341
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190825001341
SQL开始执行时间：20190825001341

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190825001343
SQL开始执行时间：20190825001343
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190825001345
SQL开始执行时间：20190825001345
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190825001348
SQL开始执行时间：20190825001348
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190825001351
SQL开始执行时间：20190825001351


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190825001352
SQL开始执行时间：20190825001352

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190825001354
SQL开始执行时间：20190825001354

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190825001658

20190826001255开始执行2019-08-25数据加载日志:
SQL开始执行时间：20190826001255


use edw
;
SQL结束执行时间：20190826001255
SQL开始执行时间：20190826001255

truncate table edw.ar_detail
;
SQL结束执行时间：20190826001255
SQL开始执行时间：20190826001255

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190826001255
SQL开始执行时间：20190826001255
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190826001257
SQL开始执行时间：20190826001257


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190826001257
SQL开始执行时间：20190826001257


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190826001340
SQL开始执行时间：20190826001340

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190826001340
SQL开始执行时间：20190826001340
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190826001340
SQL开始执行时间：20190826001340
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190826001340
SQL开始执行时间：20190826001340

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190826001342
SQL开始执行时间：20190826001342
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190826001344
SQL开始执行时间：20190826001344
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190826001347
SQL开始执行时间：20190826001347
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190826001350
SQL开始执行时间：20190826001350


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190826001351
SQL开始执行时间：20190826001351

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190826001353
SQL开始执行时间：20190826001353

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190826001657

20190827001244开始执行2019-08-26数据加载日志:
SQL开始执行时间：20190827001244


use edw
;
SQL结束执行时间：20190827001244
SQL开始执行时间：20190827001244

truncate table edw.ar_detail
;
SQL结束执行时间：20190827001244
SQL开始执行时间：20190827001244

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190827001244
SQL开始执行时间：20190827001244
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190827001246
SQL开始执行时间：20190827001246


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190827001247
SQL开始执行时间：20190827001247


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190827001328
SQL开始执行时间：20190827001328

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190827001328
SQL开始执行时间：20190827001328
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190827001328
SQL开始执行时间：20190827001328
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190827001328
SQL开始执行时间：20190827001328

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190827001330
SQL开始执行时间：20190827001330
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190827001333
SQL开始执行时间：20190827001333
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190827001335
SQL开始执行时间：20190827001335
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190827001338
SQL开始执行时间：20190827001338


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190827001340
SQL开始执行时间：20190827001340

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190827001341
SQL开始执行时间：20190827001341

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190827001645

20190828001141开始执行2019-08-27数据加载日志:
SQL开始执行时间：20190828001141


use edw
;
SQL结束执行时间：20190828001141
SQL开始执行时间：20190828001141

truncate table edw.ar_detail
;
SQL结束执行时间：20190828001141
SQL开始执行时间：20190828001141

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190828001141
SQL开始执行时间：20190828001141
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190828001144
SQL开始执行时间：20190828001144


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190828001144
SQL开始执行时间：20190828001144


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190828001225
SQL开始执行时间：20190828001225

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190828001225
SQL开始执行时间：20190828001225
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190828001225
SQL开始执行时间：20190828001225
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190828001225
SQL开始执行时间：20190828001225

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190828001227
SQL开始执行时间：20190828001227
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190828001230
SQL开始执行时间：20190828001230
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190828001232
SQL开始执行时间：20190828001232
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190828001235
SQL开始执行时间：20190828001235


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190828001237
SQL开始执行时间：20190828001237

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190828001238
SQL开始执行时间：20190828001238

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190828001543

20190829001256开始执行2019-08-28数据加载日志:
SQL开始执行时间：20190829001256


use edw
;
SQL结束执行时间：20190829001256
SQL开始执行时间：20190829001256

truncate table edw.ar_detail
;
SQL结束执行时间：20190829001256
SQL开始执行时间：20190829001256

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190829001256
SQL开始执行时间：20190829001256
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190829001259
SQL开始执行时间：20190829001259


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190829001259
SQL开始执行时间：20190829001259


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190829001341
SQL开始执行时间：20190829001341

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190829001341
SQL开始执行时间：20190829001341
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190829001341
SQL开始执行时间：20190829001341
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190829001341
SQL开始执行时间：20190829001341

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190829001343
SQL开始执行时间：20190829001343
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190829001345
SQL开始执行时间：20190829001345
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190829001348
SQL开始执行时间：20190829001348
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190829001351
SQL开始执行时间：20190829001351


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190829001352
SQL开始执行时间：20190829001352

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190829001354
SQL开始执行时间：20190829001354

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190829001706

20190830001306开始执行2019-08-29数据加载日志:
SQL开始执行时间：20190830001306


use edw
;
SQL结束执行时间：20190830001306
SQL开始执行时间：20190830001306

truncate table edw.ar_detail
;
SQL结束执行时间：20190830001306
SQL开始执行时间：20190830001306

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190830001306
SQL开始执行时间：20190830001306
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190830001308
SQL开始执行时间：20190830001308


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190830001308
SQL开始执行时间：20190830001308


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190830001351
SQL开始执行时间：20190830001351

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190830001351
SQL开始执行时间：20190830001351
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190830001351
SQL开始执行时间：20190830001351
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190830001351
SQL开始执行时间：20190830001351

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190830001353
SQL开始执行时间：20190830001353
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190830001356
SQL开始执行时间：20190830001356
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190830001358
SQL开始执行时间：20190830001358
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190830001401
SQL开始执行时间：20190830001401


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190830001402
SQL开始执行时间：20190830001402

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190830001404
SQL开始执行时间：20190830001404

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190830001712

20190831001255开始执行2019-08-30数据加载日志:
SQL开始执行时间：20190831001255


use edw
;
SQL结束执行时间：20190831001255
SQL开始执行时间：20190831001255

truncate table edw.ar_detail
;
SQL结束执行时间：20190831001255
SQL开始执行时间：20190831001255

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190831001255
SQL开始执行时间：20190831001255
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190831001257
SQL开始执行时间：20190831001257


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190831001257
SQL开始执行时间：20190831001257


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190831001339
SQL开始执行时间：20190831001339

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190831001339
SQL开始执行时间：20190831001339
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190831001339
SQL开始执行时间：20190831001339
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190831001340
SQL开始执行时间：20190831001340

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190831001342
SQL开始执行时间：20190831001342
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190831001344
SQL开始执行时间：20190831001344
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190831001346
SQL开始执行时间：20190831001346
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190831001349
SQL开始执行时间：20190831001349


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190831001350
SQL开始执行时间：20190831001350

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190831001352
SQL开始执行时间：20190831001352

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190831001657

20190901001134开始执行2019-08-31数据加载日志:
SQL开始执行时间：20190901001134


use edw
;
SQL结束执行时间：20190901001134
SQL开始执行时间：20190901001134

truncate table edw.ar_detail
;
SQL结束执行时间：20190901001134
SQL开始执行时间：20190901001134

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190901001134
SQL开始执行时间：20190901001134
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190901001136
SQL开始执行时间：20190901001136


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190901001136
SQL开始执行时间：20190901001136


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190901001216
SQL开始执行时间：20190901001216

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190901001217
SQL开始执行时间：20190901001217
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190901001217
SQL开始执行时间：20190901001217
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190901001217
SQL开始执行时间：20190901001217

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190901001219
SQL开始执行时间：20190901001219
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190901001221
SQL开始执行时间：20190901001221
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190901001224
SQL开始执行时间：20190901001224
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190901001227
SQL开始执行时间：20190901001227


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190901001228
SQL开始执行时间：20190901001228

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190901001230
SQL开始执行时间：20190901001230

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190901001530

20190902001205开始执行2019-09-01数据加载日志:
SQL开始执行时间：20190902001205


use edw
;
SQL结束执行时间：20190902001205
SQL开始执行时间：20190902001205

truncate table edw.ar_detail
;
SQL结束执行时间：20190902001205
SQL开始执行时间：20190902001205

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190902001205
SQL开始执行时间：20190902001205
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190902001208
SQL开始执行时间：20190902001208


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190902001208
SQL开始执行时间：20190902001208


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190902001249
SQL开始执行时间：20190902001249

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190902001249
SQL开始执行时间：20190902001249
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190902001249
SQL开始执行时间：20190902001249
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190902001249
SQL开始执行时间：20190902001249

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190902001251
SQL开始执行时间：20190902001251
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190902001254
SQL开始执行时间：20190902001254
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190902001256
SQL开始执行时间：20190902001256
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190902001259
SQL开始执行时间：20190902001259


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190902001301
SQL开始执行时间：20190902001301

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190902001302
SQL开始执行时间：20190902001302

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190902001606

20190903001301开始执行2019-09-02数据加载日志:
SQL开始执行时间：20190903001301


use edw
;
SQL结束执行时间：20190903001301
SQL开始执行时间：20190903001301

truncate table edw.ar_detail
;
SQL结束执行时间：20190903001301
SQL开始执行时间：20190903001301

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190903001301
SQL开始执行时间：20190903001301
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190903001303
SQL开始执行时间：20190903001303


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190903001303
SQL开始执行时间：20190903001303


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190903001346
SQL开始执行时间：20190903001346

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190903001346
SQL开始执行时间：20190903001346
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190903001347
SQL开始执行时间：20190903001347
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190903001347
SQL开始执行时间：20190903001347

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190903001349
SQL开始执行时间：20190903001349
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190903001351
SQL开始执行时间：20190903001351
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190903001354
SQL开始执行时间：20190903001354
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190903001357
SQL开始执行时间：20190903001357


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190903001358
SQL开始执行时间：20190903001358

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190903001400
SQL开始执行时间：20190903001400

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190903001710

20190904001204开始执行2019-09-03数据加载日志:
SQL开始执行时间：20190904001204


use edw
;
SQL结束执行时间：20190904001204
SQL开始执行时间：20190904001204

truncate table edw.ar_detail
;
SQL结束执行时间：20190904001204
SQL开始执行时间：20190904001204

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190904001204
SQL开始执行时间：20190904001204
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190904001206
SQL开始执行时间：20190904001206


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190904001207
SQL开始执行时间：20190904001207


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190904001251
SQL开始执行时间：20190904001251

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190904001251
SQL开始执行时间：20190904001251
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190904001251
SQL开始执行时间：20190904001251
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190904001251
SQL开始执行时间：20190904001251

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190904001255
SQL开始执行时间：20190904001255
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190904001258
SQL开始执行时间：20190904001258
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190904001304
SQL开始执行时间：20190904001304
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190904001310
SQL开始执行时间：20190904001310


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190904001312
SQL开始执行时间：20190904001312

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190904001315
SQL开始执行时间：20190904001315

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190904001636

20190904183707开始执行2019-09-04数据加载日志:
SQL开始执行时间：20190904183707


use edw
;
SQL结束执行时间：20190904183707
SQL开始执行时间：20190904183707

truncate table edw.ar_detail
;
SQL结束执行时间：20190904183707
SQL开始执行时间：20190904183707

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190904183707
SQL开始执行时间：20190904183707
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190904183709
SQL开始执行时间：20190904183709


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190904183709
SQL开始执行时间：20190904183709


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190904183752
SQL开始执行时间：20190904183752

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190904183752
SQL开始执行时间：20190904183752
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190904183753
SQL开始执行时间：20190904183753
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190904183753
SQL开始执行时间：20190904183753

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190904183755
SQL开始执行时间：20190904183755
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190904183757
SQL开始执行时间：20190904183757
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190904183800
SQL开始执行时间：20190904183800
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190904183803
SQL开始执行时间：20190904183803


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190904183805
SQL开始执行时间：20190904183805

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190904183806
SQL开始执行时间：20190904183806

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190904184112

20190905001256开始执行2019-09-04数据加载日志:
SQL开始执行时间：20190905001256


use edw
;
SQL结束执行时间：20190905001256
SQL开始执行时间：20190905001256

truncate table edw.ar_detail
;
SQL结束执行时间：20190905001256
SQL开始执行时间：20190905001256

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190905001256
SQL开始执行时间：20190905001256
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190905001259
SQL开始执行时间：20190905001259


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190905001259
SQL开始执行时间：20190905001259


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190905001342
SQL开始执行时间：20190905001342

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190905001342
SQL开始执行时间：20190905001342
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190905001342
SQL开始执行时间：20190905001342
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190905001343
SQL开始执行时间：20190905001343

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190905001345
SQL开始执行时间：20190905001345
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190905001347
SQL开始执行时间：20190905001347
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190905001349
SQL开始执行时间：20190905001349
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190905001352
SQL开始执行时间：20190905001352


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190905001354
SQL开始执行时间：20190905001354

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190905001355
SQL开始执行时间：20190905001355

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190905001710

20190906001300开始执行2019-09-05数据加载日志:
SQL开始执行时间：20190906001300


use edw
;
SQL结束执行时间：20190906001300
SQL开始执行时间：20190906001300

truncate table edw.ar_detail
;
SQL结束执行时间：20190906001300
SQL开始执行时间：20190906001300

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190906001300
SQL开始执行时间：20190906001300
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190906001302
SQL开始执行时间：20190906001302


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190906001302
SQL开始执行时间：20190906001302


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190906001346
SQL开始执行时间：20190906001346

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190906001347
SQL开始执行时间：20190906001347
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190906001347
SQL开始执行时间：20190906001347
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190906001347
SQL开始执行时间：20190906001347

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190906001349
SQL开始执行时间：20190906001349
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190906001351
SQL开始执行时间：20190906001351
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190906001354
SQL开始执行时间：20190906001354
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190906001356
SQL开始执行时间：20190906001356


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190906001358
SQL开始执行时间：20190906001358

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190906001400
SQL开始执行时间：20190906001400

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190906001716

20190907001259开始执行2019-09-06数据加载日志:
SQL开始执行时间：20190907001259


use edw
;
SQL结束执行时间：20190907001259
SQL开始执行时间：20190907001259

truncate table edw.ar_detail
;
SQL结束执行时间：20190907001259
SQL开始执行时间：20190907001259

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190907001259
SQL开始执行时间：20190907001259
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190907001301
SQL开始执行时间：20190907001301


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190907001301
SQL开始执行时间：20190907001301


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190907001345
SQL开始执行时间：20190907001345

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190907001346
SQL开始执行时间：20190907001346
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190907001346
SQL开始执行时间：20190907001346
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190907001346
SQL开始执行时间：20190907001346

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190907001348
SQL开始执行时间：20190907001348
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190907001351
SQL开始执行时间：20190907001351
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190907001353
SQL开始执行时间：20190907001353
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190907001356
SQL开始执行时间：20190907001356


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190907001358
SQL开始执行时间：20190907001358

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190907001359
SQL开始执行时间：20190907001359

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190907001717

20190908001302开始执行2019-09-07数据加载日志:
SQL开始执行时间：20190908001302


use edw
;
SQL结束执行时间：20190908001302
SQL开始执行时间：20190908001302

truncate table edw.ar_detail
;
SQL结束执行时间：20190908001302
SQL开始执行时间：20190908001302

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190908001302
SQL开始执行时间：20190908001302
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190908001304
SQL开始执行时间：20190908001304


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190908001304
SQL开始执行时间：20190908001304


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190908001348
SQL开始执行时间：20190908001348

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190908001348
SQL开始执行时间：20190908001348
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190908001349
SQL开始执行时间：20190908001349
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190908001349
SQL开始执行时间：20190908001349

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190908001351
SQL开始执行时间：20190908001351
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190908001353
SQL开始执行时间：20190908001353
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190908001356
SQL开始执行时间：20190908001356
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190908001359
SQL开始执行时间：20190908001359


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190908001400
SQL开始执行时间：20190908001400

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190908001402
SQL开始执行时间：20190908001402

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190908001718

20190909001257开始执行2019-09-08数据加载日志:
SQL开始执行时间：20190909001257


use edw
;
SQL结束执行时间：20190909001257
SQL开始执行时间：20190909001257

truncate table edw.ar_detail
;
SQL结束执行时间：20190909001257
SQL开始执行时间：20190909001257

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190909001257
SQL开始执行时间：20190909001257
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190909001300
SQL开始执行时间：20190909001300


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190909001300
SQL开始执行时间：20190909001300


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190909001344
SQL开始执行时间：20190909001344

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190909001344
SQL开始执行时间：20190909001344
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190909001344
SQL开始执行时间：20190909001344
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190909001345
SQL开始执行时间：20190909001345

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190909001347
SQL开始执行时间：20190909001347
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190909001349
SQL开始执行时间：20190909001349
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190909001352
SQL开始执行时间：20190909001352
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190909001354
SQL开始执行时间：20190909001354


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190909001356
SQL开始执行时间：20190909001356

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190909001358
SQL开始执行时间：20190909001358

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190909001713

20190910001256开始执行2019-09-09数据加载日志:
SQL开始执行时间：20190910001256


use edw
;
SQL结束执行时间：20190910001256
SQL开始执行时间：20190910001256

truncate table edw.ar_detail
;
SQL结束执行时间：20190910001256
SQL开始执行时间：20190910001256

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190910001256
SQL开始执行时间：20190910001256
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190910001259
SQL开始执行时间：20190910001259


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190910001259
SQL开始执行时间：20190910001259


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190910001343
SQL开始执行时间：20190910001343

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190910001343
SQL开始执行时间：20190910001343
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190910001343
SQL开始执行时间：20190910001343
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190910001343
SQL开始执行时间：20190910001343

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190910001345
SQL开始执行时间：20190910001345
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190910001348
SQL开始执行时间：20190910001348
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190910001350
SQL开始执行时间：20190910001350
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190910001353
SQL开始执行时间：20190910001353


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190910001355
SQL开始执行时间：20190910001355

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190910001356
SQL开始执行时间：20190910001356

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190910001712

20190911001256开始执行2019-09-10数据加载日志:
SQL开始执行时间：20190911001256


use edw
;
SQL结束执行时间：20190911001256
SQL开始执行时间：20190911001256

truncate table edw.ar_detail
;
SQL结束执行时间：20190911001256
SQL开始执行时间：20190911001256

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190911001256
SQL开始执行时间：20190911001256
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190911001259
SQL开始执行时间：20190911001259


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190911001259
SQL开始执行时间：20190911001259


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190911001343
SQL开始执行时间：20190911001343

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190911001343
SQL开始执行时间：20190911001343
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190911001343
SQL开始执行时间：20190911001343
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190911001343
SQL开始执行时间：20190911001343

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190911001345
SQL开始执行时间：20190911001345
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190911001348
SQL开始执行时间：20190911001348
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190911001350
SQL开始执行时间：20190911001350
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190911001353
SQL开始执行时间：20190911001353


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190911001355
SQL开始执行时间：20190911001355

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190911001356
SQL开始执行时间：20190911001356

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190911001711

20190912001301开始执行2019-09-11数据加载日志:
SQL开始执行时间：20190912001301


use edw
;
SQL结束执行时间：20190912001301
SQL开始执行时间：20190912001301

truncate table edw.ar_detail
;
SQL结束执行时间：20190912001301
SQL开始执行时间：20190912001301

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190912001301
SQL开始执行时间：20190912001301
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190912001304
SQL开始执行时间：20190912001304


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190912001304
SQL开始执行时间：20190912001304


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190912001349
SQL开始执行时间：20190912001349

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190912001349
SQL开始执行时间：20190912001349
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190912001349
SQL开始执行时间：20190912001349
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190912001349
SQL开始执行时间：20190912001349

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190912001351
SQL开始执行时间：20190912001351
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190912001354
SQL开始执行时间：20190912001354
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190912001356
SQL开始执行时间：20190912001356
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190912001359
SQL开始执行时间：20190912001359


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190912001401
SQL开始执行时间：20190912001401

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190912001403
SQL开始执行时间：20190912001403

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190912001722

20190913001300开始执行2019-09-12数据加载日志:
SQL开始执行时间：20190913001300


use edw
;
SQL结束执行时间：20190913001300
SQL开始执行时间：20190913001300

truncate table edw.ar_detail
;
SQL结束执行时间：20190913001300
SQL开始执行时间：20190913001300

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190913001300
SQL开始执行时间：20190913001300
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190913001303
SQL开始执行时间：20190913001303


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190913001303
SQL开始执行时间：20190913001303


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190913001347
SQL开始执行时间：20190913001347

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190913001348
SQL开始执行时间：20190913001348
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190913001348
SQL开始执行时间：20190913001348
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190913001348
SQL开始执行时间：20190913001348

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190913001350
SQL开始执行时间：20190913001350
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190913001352
SQL开始执行时间：20190913001352
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190913001355
SQL开始执行时间：20190913001355
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190913001358
SQL开始执行时间：20190913001358


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190913001400
SQL开始执行时间：20190913001400

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190913001401
SQL开始执行时间：20190913001401

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190913001720

20190916160510开始执行2019-09-15数据加载日志:
SQL开始执行时间：20190916160510


use edw
;
SQL结束执行时间：20190916160510
SQL开始执行时间：20190916160510

truncate table edw.ar_detail
;
SQL结束执行时间：20190916160510
SQL开始执行时间：20190916160510

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190916160510
SQL开始执行时间：20190916160510
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190916160512
SQL开始执行时间：20190916160512


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190916160512
SQL开始执行时间：20190916160512


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190916160557
SQL开始执行时间：20190916160557

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190916160557
SQL开始执行时间：20190916160557
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190916160558
SQL开始执行时间：20190916160558
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190916160558
SQL开始执行时间：20190916160558

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190916160600
SQL开始执行时间：20190916160600
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190916160603
SQL开始执行时间：20190916160603
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190916160606
SQL开始执行时间：20190916160606
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190916160609
SQL开始执行时间：20190916160609


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190916160611
SQL开始执行时间：20190916160611

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190916160612
SQL开始执行时间：20190916160612

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190916160930

20190917001258开始执行2019-09-16数据加载日志:
SQL开始执行时间：20190917001258


use edw
;
SQL结束执行时间：20190917001258
SQL开始执行时间：20190917001258

truncate table edw.ar_detail
;
SQL结束执行时间：20190917001258
SQL开始执行时间：20190917001258

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190917001258
SQL开始执行时间：20190917001258
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190917001301
SQL开始执行时间：20190917001301


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190917001301
SQL开始执行时间：20190917001301


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190917001346
SQL开始执行时间：20190917001346

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190917001346
SQL开始执行时间：20190917001346
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190917001346
SQL开始执行时间：20190917001346
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190917001346
SQL开始执行时间：20190917001346

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190917001348
SQL开始执行时间：20190917001348
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190917001351
SQL开始执行时间：20190917001351
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190917001353
SQL开始执行时间：20190917001353
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190917001356
SQL开始执行时间：20190917001356


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190917001358
SQL开始执行时间：20190917001358

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190917001359
SQL开始执行时间：20190917001359

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190917001717

20190918001303开始执行2019-09-17数据加载日志:
SQL开始执行时间：20190918001303


use edw
;
SQL结束执行时间：20190918001303
SQL开始执行时间：20190918001303

truncate table edw.ar_detail
;
SQL结束执行时间：20190918001303
SQL开始执行时间：20190918001303

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190918001303
SQL开始执行时间：20190918001303
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190918001305
SQL开始执行时间：20190918001305


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190918001305
SQL开始执行时间：20190918001305


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190918001351
SQL开始执行时间：20190918001351

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190918001351
SQL开始执行时间：20190918001351
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190918001352
SQL开始执行时间：20190918001352
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190918001352
SQL开始执行时间：20190918001352

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190918001354
SQL开始执行时间：20190918001354
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190918001356
SQL开始执行时间：20190918001356
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190918001359
SQL开始执行时间：20190918001359
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190918001402
SQL开始执行时间：20190918001402


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190918001403
SQL开始执行时间：20190918001403

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190918001406
SQL开始执行时间：20190918001406

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190918001723

20190919001257开始执行2019-09-18数据加载日志:
SQL开始执行时间：20190919001257


use edw
;
SQL结束执行时间：20190919001257
SQL开始执行时间：20190919001257

truncate table edw.ar_detail
;
SQL结束执行时间：20190919001257
SQL开始执行时间：20190919001257

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190919001257
SQL开始执行时间：20190919001257
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190919001300
SQL开始执行时间：20190919001300


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190919001300
SQL开始执行时间：20190919001300


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190919001345
SQL开始执行时间：20190919001345

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190919001345
SQL开始执行时间：20190919001345
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190919001345
SQL开始执行时间：20190919001345
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190919001345
SQL开始执行时间：20190919001345

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190919001348
SQL开始执行时间：20190919001348
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190919001350
SQL开始执行时间：20190919001350
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190919001352
SQL开始执行时间：20190919001352
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190919001355
SQL开始执行时间：20190919001355


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190919001357
SQL开始执行时间：20190919001357

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190919001359
SQL开始执行时间：20190919001359

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190919001716

20190920001302开始执行2019-09-19数据加载日志:
SQL开始执行时间：20190920001302


use edw
;
SQL结束执行时间：20190920001302
SQL开始执行时间：20190920001302

truncate table edw.ar_detail
;
SQL结束执行时间：20190920001302
SQL开始执行时间：20190920001302

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190920001302
SQL开始执行时间：20190920001302
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190920001304
SQL开始执行时间：20190920001304


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190920001305
SQL开始执行时间：20190920001305


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190920001351
SQL开始执行时间：20190920001351

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190920001351
SQL开始执行时间：20190920001351
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190920001351
SQL开始执行时间：20190920001351
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190920001351
SQL开始执行时间：20190920001351

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190920001353
SQL开始执行时间：20190920001353
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190920001356
SQL开始执行时间：20190920001356
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190920001358
SQL开始执行时间：20190920001358
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190920001401
SQL开始执行时间：20190920001401


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190920001403
SQL开始执行时间：20190920001403

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190920001404
SQL开始执行时间：20190920001404

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190920001724

20190921001302开始执行2019-09-20数据加载日志:
SQL开始执行时间：20190921001302


use edw
;
SQL结束执行时间：20190921001302
SQL开始执行时间：20190921001302

truncate table edw.ar_detail
;
SQL结束执行时间：20190921001302
SQL开始执行时间：20190921001302

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190921001302
SQL开始执行时间：20190921001302
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190921001305
SQL开始执行时间：20190921001305


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190921001305
SQL开始执行时间：20190921001305


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190921001351
SQL开始执行时间：20190921001351

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190921001351
SQL开始执行时间：20190921001351
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190921001351
SQL开始执行时间：20190921001351
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190921001352
SQL开始执行时间：20190921001352

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190921001354
SQL开始执行时间：20190921001354
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190921001356
SQL开始执行时间：20190921001356
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190921001359
SQL开始执行时间：20190921001359
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190921001402
SQL开始执行时间：20190921001402


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190921001403
SQL开始执行时间：20190921001403

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190921001405
SQL开始执行时间：20190921001405

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190921001722

20190922001258开始执行2019-09-21数据加载日志:
SQL开始执行时间：20190922001258


use edw
;
SQL结束执行时间：20190922001258
SQL开始执行时间：20190922001258

truncate table edw.ar_detail
;
SQL结束执行时间：20190922001258
SQL开始执行时间：20190922001258

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190922001258
SQL开始执行时间：20190922001258
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190922001300
SQL开始执行时间：20190922001300


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190922001301
SQL开始执行时间：20190922001301


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190922001347
SQL开始执行时间：20190922001347

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190922001347
SQL开始执行时间：20190922001347
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190922001348
SQL开始执行时间：20190922001348
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190922001348
SQL开始执行时间：20190922001348

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190922001350
SQL开始执行时间：20190922001350
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190922001352
SQL开始执行时间：20190922001352
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190922001355
SQL开始执行时间：20190922001355
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190922001358
SQL开始执行时间：20190922001358


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190922001359
SQL开始执行时间：20190922001359

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190922001401
SQL开始执行时间：20190922001401

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190922001721

20190923001305开始执行2019-09-22数据加载日志:
SQL开始执行时间：20190923001305


use edw
;
SQL结束执行时间：20190923001305
SQL开始执行时间：20190923001305

truncate table edw.ar_detail
;
SQL结束执行时间：20190923001305
SQL开始执行时间：20190923001305

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190923001305
SQL开始执行时间：20190923001305
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190923001308
SQL开始执行时间：20190923001308


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190923001308
SQL开始执行时间：20190923001308


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190923001357
SQL开始执行时间：20190923001357

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190923001357
SQL开始执行时间：20190923001357
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190923001357
SQL开始执行时间：20190923001357
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190923001357
SQL开始执行时间：20190923001357

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190923001359
SQL开始执行时间：20190923001359
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190923001402
SQL开始执行时间：20190923001402
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190923001405
SQL开始执行时间：20190923001405
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190923001408
SQL开始执行时间：20190923001408


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190923001409
SQL开始执行时间：20190923001409

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190923001411
SQL开始执行时间：20190923001411

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190923001730

20190924001303开始执行2019-09-23数据加载日志:
SQL开始执行时间：20190924001303


use edw
;
SQL结束执行时间：20190924001303
SQL开始执行时间：20190924001303

truncate table edw.ar_detail
;
SQL结束执行时间：20190924001304
SQL开始执行时间：20190924001304

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190924001304
SQL开始执行时间：20190924001304
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190924001306
SQL开始执行时间：20190924001306


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190924001306
SQL开始执行时间：20190924001306


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190924001353
SQL开始执行时间：20190924001353

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190924001353
SQL开始执行时间：20190924001353
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190924001353
SQL开始执行时间：20190924001353
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190924001353
SQL开始执行时间：20190924001353

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190924001356
SQL开始执行时间：20190924001356
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190924001358
SQL开始执行时间：20190924001358
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190924001401
SQL开始执行时间：20190924001401
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190924001404
SQL开始执行时间：20190924001404


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190924001405
SQL开始执行时间：20190924001405

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190924001407
SQL开始执行时间：20190924001407

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190924001737

20190924093518开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924093518


use edw
;
SQL结束执行时间：20190924093518
SQL开始执行时间：20190924093518

truncate table edw.ar_detail
;
SQL结束执行时间：20190924093518
SQL开始执行时间：20190924093518

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190924093518
SQL开始执行时间：20190924093518
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190924093520
SQL开始执行时间：20190924093520


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190924093520
SQL开始执行时间：20190924093520


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190924093607
SQL开始执行时间：20190924093607

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190924093607
SQL开始执行时间：20190924093607
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190924093607
SQL开始执行时间：20190924093607
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190924093607
SQL开始执行时间：20190924093607

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190924093609
SQL开始执行时间：20190924093609
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190924093612
SQL开始执行时间：20190924093612
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190924093615
SQL开始执行时间：20190924093615
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190924093618
SQL开始执行时间：20190924093618


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190924093619
SQL开始执行时间：20190924093619

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190924093621
SQL开始执行时间：20190924093621

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190924093941

20190925001303开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190925001303


use edw
;
SQL结束执行时间：20190925001303
SQL开始执行时间：20190925001303

truncate table edw.ar_detail
;
SQL结束执行时间：20190925001303
SQL开始执行时间：20190925001303

drop table if exists edw.ap_vouch
;
SQL结束执行时间：20190925001303
SQL开始执行时间：20190925001303
create temporary table edw.ap_vouch as
select a.clink
      ,a.db
      ,a.cvouchid
      ,b.citemcode
      ,c.bi_cinvcode
      ,c.bi_cinvname
  from ufdata.ap_vouch a
  left join (select * from ufdata.ap_vouchs where citemcode is not null group by clink) b
    on a.clink = b.clink
  left join (select * from edw.dic_inventory group by left(db,10),cinvcode) c
    on b.citemcode = c.cinvcode
   and left(b.db,10) = left(c.db,10)
  where b.clink is not null

;
SQL结束执行时间：20190925001306
SQL开始执行时间：20190925001306


create temporary table edw.ar_detail_pre as
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end as cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end as true_cinvcode
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end as true_cinvname
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join edw.dic_customer as b
on a.cDwCode = b.ccuscode
and left(a.db,10) = left(b.db,10)
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db = 'UFDATA_889_2019' or a.db = 'UFDATA_555_2018'
;
SQL结束执行时间：20190925001306
SQL开始执行时间：20190925001306


insert into edw.ar_detail_pre
select 
	 a.db
	,a.Auto_ID
	,a.iPeriod
	,a.cVouchType
	,a.cVouchSType
	,a.cVouchID
	,a.dVouchDate
	,a.dRegDate
	,a.cDwCode
	,case when b.ccuscode is null then "请核查"
     else b.bi_cuscode end as true_ccuscode 
	,case when b.ccuscode is null then "请核查"
     else b.bi_cusname end as true_ccusname
	,case when a.cVouchType = 'R0' then f.citemcode else a.cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvcode else c.bi_cinvcode end
	,case when a.cVouchType = 'R0' then f.bi_cinvname else c.bi_cinvname end
	,a.iBVid
	,a.cCode
	,a.csign
	,a.isignseq
	,a.ino_id
	,a.cDigest
	,a.iDAmount
	,a.iCAmount
	,a.iDAmount_s
	,a.iCAmount_s
	,a.cOrderNo
	,a.cSSCode
	,a.cProcStyle
	,a.cCancelNo
	,a.cPZid
	,a.bPrePay
	,a.iFlag
	,a.cCoVouchType
	,a.cCoVouchID
	,a.cDefine2
	,a.cDefine8
	,a.cDefine10
	,a.iVouchAmount
	,a.iVouchAmount_s
	,case when a.cVouchType = 'R0' then 'ap_vouch' end mark
	,'11111111111' as item_code
from ufdata.ar_detail as a
left join (select ccusname,ccuscode,bi_cusname,bi_cuscode from edw.dic_customer group by ccuscode) as b
on a.cDwCode = b.ccuscode
left join (select * from edw.dic_inventory group by cinvcode) c
  on a.cinvcode = c.cinvcode
left join edw.ap_vouch f
  on a.db = f.db
 and a.cVouchID = f.cVouchID
where a.db <> 'UFDATA_889_2019'
  and a.db <> 'UFDATA_555_2018'
;
SQL结束执行时间：20190925001353
SQL开始执行时间：20190925001353

delete from edw.ar_detail_pre where db = 'UFDATA_222_2018'
;
SQL结束执行时间：20190925001353
SQL开始执行时间：20190925001353
delete from edw.ar_detail_pre where db = 'UFDATA_588_2018'
;
SQL结束执行时间：20190925001353
SQL开始执行时间：20190925001353
delete from edw.ar_detail_pre where db = 'UFDATA_168_2018'
;
SQL结束执行时间：20190925001353
SQL开始执行时间：20190925001353

CREATE INDEX index_mid2_ar_detail_pre_cVouchID ON edw.ar_detail_pre(cVouchID)
;
SQL结束执行时间：20190925001356
SQL开始执行时间：20190925001356
CREATE INDEX index_mid2_ar_detail_pre_db ON edw.ar_detail_pre(db)
;
SQL结束执行时间：20190925001358
SQL开始执行时间：20190925001358
CREATE INDEX index_mid2_ar_detail_pre_true_cinvcode ON edw.ar_detail_pre(true_cinvcode)
;
SQL结束执行时间：20190925001400
SQL开始执行时间：20190925001400
CREATE INDEX index_mid2_ar_detail_pre_cinvcode ON edw.ar_detail_pre(cinvcode)
;
SQL结束执行时间：20190925001403
SQL开始执行时间：20190925001403


update edw.ar_detail_pre a
 inner join (select * from edw.invoice_order group by csbvcode,left(db,10)) b
    on a.cVouchID = b.csbvcode
   and left(a.db,10) = left(b.db,10)
   set a.cinvcode = b.cinvcode
      ,a.true_cinvcode = b.bi_cinvcode
      ,a.true_cinvname = b.bi_cinvname
      ,a.mark = 'invoice'
 where a.cVouchType = 'R0'
   and a.cinvcode is null
	 and a.dVouchDate >= '2018-01-01'

;
SQL结束执行时间：20190925001405
SQL开始执行时间：20190925001405

update edw.ar_detail_pre a
 inner join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.true_cinvcode = b.bi_cinvcode
   set a.item_code = b.item_code

;
SQL结束执行时间：20190925001407
SQL开始执行时间：20190925001407

insert into edw.ar_detail
select a.db
      ,a.Auto_ID
      ,a.iPeriod
      ,a.cVouchType
      ,a.cVouchSType
      ,a.cVouchID
      ,a.dVouchDate
      ,a.dRegDate
      ,a.cDwCode
      ,a.true_ccuscode
      ,a.true_ccusname
      ,a.cinvcode
      ,a.true_cinvcode
      ,a.true_cinvname
	    ,case
       when a.cinvcode = "JC0100001" then "检测"  -- 科研服务
       when a.cinvcode = "05001" then "启代医疗服务" -- 启代医疗服务
       when d.level_one = "健康检测" then "健康检测"
       when left(c.bi_cinvcode,2) = "yq" then "设备"
       when left(c.bi_cinvcode,2) = "jc" then "检测"
       when a.cinvcode is not null then "试剂"
       when a.cdefine8 = "检测服务" then "检测"
       when a.cdefine8 in("设备","仪器") then "设备"
       when a.cdefine8 in("其他","试剂") then "试剂"
       when a.cDigest like "%试剂%" then "试剂"
       when a.cDigest like "%检测%" then "检测"
       when a.cDigest like "%仪器%" then "设备"
       when a.cDigest like "%设备%" then "设备"
       else "试剂" end
      ,a.iBVid
      ,a.cCode
      ,a.csign
      ,a.isignseq
      ,a.ino_id
      ,a.cDigest
      ,a.iDAmount
      ,a.iCAmount
      ,a.iDAmount_s
      ,a.iCAmount_s
      ,a.cOrderNo
      ,a.cSSCode
      ,a.cProcStyle
      ,a.cCancelNo
      ,a.cPZid
      ,a.bPrePay
      ,a.iFlag
      ,a.cCoVouchType
      ,a.cCoVouchID
      ,a.cDefine2
      ,a.cDefine8
      ,a.cDefine10
      ,a.iVouchAmount
      ,a.iVouchAmount_s
	    ,case when e.csbvcode is not null then a.iDAmount/(1+e.itaxrate/100)
	          else (case when a.cDefine8 = '检测服务' then a.iDAmount/(1+6/100) 
	                     when a.cDefine8 <> '检测服务' and dVouchDate < '2018-05-01' then a.iDAmount/(1+17/100) 
	                     else a.iDAmount/(1+16/100) end)
	        end as invoice_amount
	    ,d.specification_type
      ,a.mark
      ,case when a.item_code = '11111111111' then null else a.item_code end 
      ,localtimestamp() as sys_time
  from edw.ar_detail_pre a
  left join (select * from edw.dic_inventory group by cinvcode) c
    on a.cinvcode = c.cinvcode
  left join (select * from edw.map_inventory group by bi_cinvcode) d
    on c.bi_cinvcode = d.bi_cinvcode
  left join (select * from edw.invoice_order group by csbvcode,left(db,10)) e
    on a.cvouchid = e.csbvcode
   and left(a.db,10) = left(e.db,10)

;
SQL结束执行时间：20190925001730
