
20190401091756å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401091756
/*
drop table bidata.cusitem_analysis_mon
;

20190401091937å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401091937

*/
create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = '²©Ê¥ÌåÏµ'
 group by true_ccuscode,true_item_code,business_class

;

20190401092023å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092023

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = '²©Ê¥ÌåÏµ'
 group by true_ccuscode,true_item_code,business_class

;

20190401092119å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092119

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = '²©Ê¥ÌåÏµ'
 group by true_ccuscode,true_item_code,business_class

;

20190401092131å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092131

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092131

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092131

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092131

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092131
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092131

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092132
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092132

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092132
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092132
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class
;-- è®¡ç®—å½“å­£å»é™¤å½“æœˆçš„æ”¶å…¥
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;

20190401092209å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092209

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092209

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092209

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092209

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092209
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092209

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092211

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092212

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092212

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092212
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,null
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092214

;

20190401092229å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092229

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092229

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092229

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092229

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092229
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092230

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092231

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092232

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092232

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092232
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,null
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092234

;

20190401092335å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092335

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092335
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092335

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092335
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092335

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092335
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092335

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092335
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092335
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092335
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092335

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092336

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092336
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092336
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092337
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,null
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092339

;

20190401092504å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092504

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092504
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092504

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092505

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092505

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092505
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092505

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092506

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092506
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092506
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092506
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092506
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092506
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092507
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092507

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092507

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092507

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092507

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092507
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401092509

;

20190401093204å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093204

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093204

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093205

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093205

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093205
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093205

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093206

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093206
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093206
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093206
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093206
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093206
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093207
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093207

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093207

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093207

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093207

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093207
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093209

;

20190401093933å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093933

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093933

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093933

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093933

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093933
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093933

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093935

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093936

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093936

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093936
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401093938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401093938

;

20190401094225å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094225

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094225

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094225

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094225

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094225
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094225

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094226

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094226
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094226
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094227
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094229

;

20190401094425å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094425

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094425
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094425

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094425
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094425

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094425
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094425

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094425
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094425
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094425
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094425

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094426
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094426

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094426
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094426
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094427
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094427
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094429


insert into bidata.cusitem_analysis_form
select province
      ,item_key
      ,ifnull(plan_bf_mon,0)
      ,0
      ,ifnull(actual_bf_mon,0)
      ,ifnull(plan_bf_mon,0) - ifnull(actual_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)- ifnull(plan_quarter_new,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,0
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_form2
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094430

truncate table bidata.cusitem_analysis_city
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094430
create temporary table bidata.cusitem_analysis_city1 as
select province
      ,city
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
  group by province,product_assist,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094430
create temporary table bidata.cusitem_analysis_city2 as
select * from bidata.cusitem_analysis_city1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094430
insert into bidata.cusitem_analysis_city1
select province
      ,city
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_city2
 group by province,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094430

insert into bidata.cusitem_analysis_city
select province
      ,city
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new,0) - ifnull(plan_quarter_new2,0) - ifnull(plan_mon_new,0)
      ,ifnull(plan_quarter_new,0) - ifnull(actual_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_city1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401094430

insert into bidata.cusitem_analysis_city
select a.province
      ,a.city
      ,a.item
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
  from bidata.cusitem_dic_city a
  left join bidata.cusitem_analysis_city1 b
    on a.province = b.province
   and a.city = b.city
   and a.item = b.product_assist
 where b.province is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401094430

20190401101646å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101646

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101646

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101646

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101646

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101646
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101646

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101648

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101649

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101649
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101649
insert into bidata.cusitem_analysis_mon
select e.item_key
      ,case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;

20190401101700å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101700

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101700

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101700

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101700

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101700
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101700

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101702
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101702

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101703
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101703

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101703
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101703

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101703
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101703
insert into bidata.cusitem_analysis_mon
select case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,e.item_key
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,e.item_key
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705


insert into bidata.cusitem_analysis_form
select province
      ,item_key
      ,ifnull(plan_bf_mon,0)
      ,0
      ,ifnull(actual_bf_mon,0)
      ,ifnull(plan_bf_mon,0) - ifnull(actual_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)- ifnull(plan_quarter_new,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,0
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_form2
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

truncate table bidata.cusitem_analysis_city
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
create temporary table bidata.cusitem_analysis_city1 as
select province
      ,city
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
  group by province,product_assist,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
create temporary table bidata.cusitem_analysis_city2 as
select * from bidata.cusitem_analysis_city1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705
insert into bidata.cusitem_analysis_city1
select province
      ,city
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_city2
 group by province,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_city
select province
      ,city
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new,0) - ifnull(plan_quarter_new2,0) - ifnull(plan_mon_new,0)
      ,ifnull(plan_quarter_new,0) - ifnull(actual_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_city1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401101705

insert into bidata.cusitem_analysis_city
select a.province
      ,a.city
      ,a.item
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
  from bidata.cusitem_dic_city a
  left join bidata.cusitem_analysis_city1 b
    on a.province = b.province
   and a.city = b.city
   and a.item = b.product_assist
 where b.province is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401101705

20190401102608å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102608

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102608

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102608

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102608

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102608
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102608
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102608

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102610

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102611

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102611

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102611
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102611
insert into bidata.cusitem_analysis_mon
select case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,e.item_key
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,e.item_key
      ,c.equipment
      ,f.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,d.actual_bf_mon
      ,a.plan_quarter_new
      ,a.plan_quarter_zb
      ,d.actual_quarter_new
      ,a.plan_mon
      ,a.plan_mon_zb
      ,a.plan_mon_new
      ,d.actual_day1
      ,d.actual_day2
      ,d.actual_day3
      ,d.actual_day4
      ,ifnull(d.actual_day1,0) + ifnull(d.actual_day2,0) +  ifnull(d.actual_day3,0) + ifnull(d.actual_day4,0)
      ,d.actual_quarter_new2
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613


insert into bidata.cusitem_analysis_form
select province
      ,item_key
      ,ifnull(plan_bf_mon,0)
      ,0
      ,ifnull(actual_bf_mon,0)
      ,ifnull(plan_bf_mon,0) - ifnull(actual_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)- ifnull(plan_quarter_new,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,0
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_form2
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

truncate table bidata.cusitem_analysis_city
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
create temporary table bidata.cusitem_analysis_city1 as
select province
      ,city
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
  group by province,product_assist,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
create temporary table bidata.cusitem_analysis_city2 as
select * from bidata.cusitem_analysis_city1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613
insert into bidata.cusitem_analysis_city1
select province
      ,city
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_city2
 group by province,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_city
select province
      ,city
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new,0) - ifnull(plan_quarter_new2,0) - ifnull(plan_mon_new,0)
      ,ifnull(plan_quarter_new,0) - ifnull(actual_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_city1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401102613

insert into bidata.cusitem_analysis_city
select a.province
      ,a.city
      ,a.item
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
  from bidata.cusitem_dic_city a
  left join bidata.cusitem_analysis_city1 b
    on a.province = b.province
   and a.city = b.city
   and a.item = b.product_assist
 where b.province is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401102613

20190401110545å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110545

create temporary table bidata.ft_12_sales_budget_pre1 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_bf_mon
      ,sum(isum_budget_pro) as plan_bf_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
   and cohr = 'åšåœ£ä½“ç³»'
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110545
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110545

create temporary table bidata.ft_12_sales_budget_pre2 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_quarter_new
      ,sum(isum_budget_pro) as plan_quarter_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110546
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110546

create temporary table bidata.ft_12_sales_budget_pre3 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon
      ,sum(isum_budget_pro) as plan_mon_zb
  from bidata.ft_12_sales_budget
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110546
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110546

create temporary table bidata.ft_12_sales_budget_pre4 as
select true_ccuscode
      ,true_item_code
      ,business_class
      ,sum(isum_budget) as plan_mon_new
  from bidata.ft_13_sales_budget_new
 where left(ddate,4) = '2019'
   and cohr = 'åšåœ£ä½“ç³»'
   and left(ddate,7) = left('2019-04-02',7)
 group by true_ccuscode,true_item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110546
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110546
create temporary table bidata.ft_12_sales_budget_pre6 as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre1
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre2
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre3
union
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre4

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110546
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110546

create temporary table bidata.ft_12_sales_budget_pre5 as
select e.true_ccuscode
      ,e.true_item_code
      ,e.business_class
      ,a.plan_bf_mon
      ,a.plan_bf_zb
      ,b.plan_quarter_new
      ,b.plan_quarter_zb
      ,c.plan_mon
      ,c.plan_mon_zb
      ,d.plan_mon_new
  from bidata.ft_12_sales_budget_pre6 e
  left join bidata.ft_12_sales_budget_pre1 a
    on e.true_ccuscode = a.true_ccuscode
   and e.true_item_code = a.true_item_code
   and e.business_class = a.business_class
  left join bidata.ft_12_sales_budget_pre2 b
    on e.true_ccuscode = b.true_ccuscode
   and e.true_item_code = b.true_item_code
   and e.business_class = b.business_class
  left join bidata.ft_12_sales_budget_pre3 c
    on e.true_ccuscode = c.true_ccuscode
   and e.true_item_code = c.true_item_code
   and e.business_class = c.business_class
  left join bidata.ft_12_sales_budget_pre4 d
    on e.true_ccuscode = d.true_ccuscode
   and e.true_item_code = d.true_item_code
   and e.business_class = d.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110547
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110547

create temporary table bidata.ft_11_sales_pre1 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_bf_mon
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and left(ddate,7) < left('2019-04-02',7)
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110547
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110547
create temporary table bidata.ft_11_sales_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new
  from bidata.ft_11_sales
 where left(ddate,4) = '2019'
   and QUARTER(ddate) = QUARTER('2019-04-02')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110547
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110547
create temporary table bidata.ft_11_sales_pre8 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_quarter_new2
  from bidata.ft_11_sales
 where left(ddate,7) < left('2019-04-02',7)
   and QUARTER(ddate) = QUARTER('2019-04-02')
   and left(ddate,4) = '2019'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110547
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110547
create temporary table bidata.ft_11_sales_pre3 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day1
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'01')
   and ddate <= concat(left('2019-04-02',8),'07')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110547
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110547
create temporary table bidata.ft_11_sales_pre4 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day2
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'08')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'14')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110547
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110547
create temporary table bidata.ft_11_sales_pre5 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day3
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'15')
   and ddate <= concat(left('2019-04-02',8),'23')
   and cohr <> 'æ­å·è´ç”Ÿ'
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110548
create temporary table bidata.ft_11_sales_pre6 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,cbustype as business_class
      ,sum(isum) as actual_day4
  from bidata.ft_11_sales
 where ddate >= concat(left('2019-04-02',8),'24')
   and cohr <> 'æ­å·è´ç”Ÿ'
   and ddate <= concat(left('2019-04-02',8),'31')
 group by finnal_ccuscode,item_code,business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110548

create temporary table bidata.ft_11_sales_pre9 as
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre1
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre2
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre3
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre4
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre5
union
select ccuscode,item_code,business_class from bidata.ft_11_sales_pre6

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110548

create temporary table bidata.ft_11_sales_pre7 as
select h.ccuscode
      ,h.item_code
      ,h.business_class
      ,a.actual_bf_mon
      ,b.actual_quarter_new
      ,c.actual_day1
      ,d.actual_day2
      ,e.actual_day3
      ,f.actual_day4
      ,g.actual_quarter_new2
  from bidata.ft_11_sales_pre9 h
  left join bidata.ft_11_sales_pre1 a
    on h.ccuscode = a.ccuscode
   and h.item_code = a.item_code
   and h.business_class = a.business_class
  left join bidata.ft_11_sales_pre2 b
    on h.ccuscode = b.ccuscode
   and h.item_code = b.item_code
   and h.business_class = b.business_class
  left join bidata.ft_11_sales_pre3 c
    on h.ccuscode = c.ccuscode
   and h.item_code = c.item_code
   and h.business_class = c.business_class
  left join bidata.ft_11_sales_pre4 d
    on h.ccuscode = d.ccuscode
   and h.item_code = d.item_code
   and h.business_class = d.business_class
  left join bidata.ft_11_sales_pre5 e
    on h.ccuscode = e.ccuscode
   and h.item_code = e.item_code
   and h.business_class = e.business_class
  left join bidata.ft_11_sales_pre6 f
    on h.ccuscode = f.ccuscode
   and h.item_code = f.item_code
   and h.business_class = f.business_class
  left join bidata.ft_11_sales_pre8 g
    on h.ccuscode = g.ccuscode
   and h.item_code = g.item_code
   and h.business_class = g.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110548

create temporary table bidata.cusitem_analysis_mon_pre as
select true_ccuscode
      ,true_item_code
      ,business_class
  from bidata.ft_12_sales_budget_pre5
union
select ccuscode
      ,item_code
      ,business_class
  from bidata.ft_11_sales_pre7 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110548

truncate table bidata.cusitem_analysis_mon
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110548
insert into bidata.cusitem_analysis_mon
select case when c.equipment = 'æ˜¯' then 'ä»ªå™¨è®¾å¤‡'
            else c.level_one end
      ,e.item_key
      ,left('2019-04-02',7)
      ,b.sales_region
      ,b.province
      ,b.city
      ,b.bi_cusname
      ,c.level_one
      ,c.level_two
      ,c.level_three
      ,e.item_key
      ,c.equipment
      ,f.business_class
      ,ifnull(a.plan_bf_mon,0)
      ,ifnull(a.plan_bf_zb,0)
      ,ifnull(d.actual_bf_mon,0)
      ,ifnull(a.plan_quarter_new,0)
      ,ifnull(a.plan_quarter_zb,0)
      ,ifnull(d.actual_quarter_new,0)
      ,ifnull(a.plan_mon,0)
      ,ifnull(a.plan_mon_zb,0)
      ,ifnull(a.plan_mon_new,0)
      ,ifnull(d.actual_day1,0)
      ,ifnull(d.actual_day2,0)
      ,ifnull(d.actual_day3,0)
      ,ifnull(d.actual_day4,0)
      ,ifnull(d.actual_day1,0) + ifnull(d.actual_day2,0) +  ifnull(d.actual_day3,0) + ifnull(d.actual_day4,0)
      ,ifnull(d.actual_quarter_new2,0)
  from bidata.cusitem_analysis_mon_pre f
  left join bidata.ft_12_sales_budget_pre5 a
    on f.true_ccuscode = a.true_ccuscode
   and f.true_item_code = a.true_item_code
   and f.business_class = a.business_class
  left join edw.map_customer b
    on f.true_ccuscode = b.bi_cuscode
  left join edw.map_item c
    on f.true_item_code = c.item_code
  left join bidata.ft_11_sales_pre7 d
    on f.true_ccuscode = d.ccuscode
   and f.true_item_code = d.item_code
   and f.business_class = d.business_class
  left join (select * from bidata.dic_ppt group by level_three,business_class) e
    on c.level_three = e.level_three
   and f.business_class = e.business_class

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

truncate table bidata.cusitem_analysis_form
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
create temporary table bidata.cusitem_analysis_form1 as
select province
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
create temporary table bidata.cusitem_analysis_form3 as
select * from bidata.cusitem_analysis_form1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
insert into bidata.cusitem_analysis_form1
select province
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form3
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

create temporary table bidata.cusitem_analysis_form2 as
select province
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
  group by province,item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
create temporary table bidata.cusitem_analysis_form4 as
select * from bidata.cusitem_analysis_form2
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
insert into bidata.cusitem_analysis_form2
select province
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550


insert into bidata.cusitem_analysis_form2
select province
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_form4
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
 group by province

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_form1
select 'all'
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
 group by product_assist

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_form1
select 'all'
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(plan_bf_zb) as plan_bf_zb
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_zb) as plan_quarter_zb
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_zb) as plan_mon_zb
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
   and product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all3'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('è¡€æ¸…å­¦ç­›æŸ¥','CMA_äº§å“ç±»','CMA_LDT','NIPT','MSMS','ä»£è°¢ç—…è¯Šæ–­')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_form2
select 'all'
      ,item_key
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')
 group by item_key

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_form2
select 'all'
      ,'all2'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where item_key in('NGS','CMAè®¾å¤‡','ä¸²è”è´¨è°±ä»ª','CDS5+GSL120(å«KM1,KM2)','1235+DX6000','GSP')
   and province in('æ¹–å—çœ','æ¹–åŒ—çœ','ç¦å»ºçœ','æ±Ÿè‹çœ','å®‰å¾½çœ','æµ™æ±Ÿçœ','ä¸Šæµ·å¸‚','å±±ä¸œçœ')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550


insert into bidata.cusitem_analysis_form
select province
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(plan_bf_zb,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_zb,0)
      ,ifnull(ifnull(actual_bf_mon,0)/plan_bf_mon,0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/plan_quarter_zb,0)
      ,ifnull(ifnull(actual_quarter_new,0)/plan_quarter_zb,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0) - ifnull(plan_quarter_zb,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_zb,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_zb,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_zb,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/plan_mon_new,0)
      ,(ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)) - ifnull(plan_mon_zb,0)
  from bidata.cusitem_analysis_form1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550


insert into bidata.cusitem_analysis_form
select province
      ,item_key
      ,ifnull(plan_bf_mon,0)
      ,0
      ,ifnull(actual_bf_mon,0)
      ,ifnull(plan_bf_mon,0) - ifnull(actual_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)- ifnull(plan_quarter_new,0)
      ,ifnull(actual_quarter_new,0) - ifnull(plan_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,0
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_form2
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

truncate table bidata.cusitem_analysis_city
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
create temporary table bidata.cusitem_analysis_city1 as
select province
      ,city
      ,product_assist
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_mon
 where product_assist in('äº§å‰','æ–°ç”Ÿå„¿','æœåŠ¡ç±»','ä»ªå™¨è®¾å¤‡')
  group by province,product_assist,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
create temporary table bidata.cusitem_analysis_city2 as
select * from bidata.cusitem_analysis_city1
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550
insert into bidata.cusitem_analysis_city1
select province
      ,city
      ,'all1'
      ,sum(plan_bf_mon) as plan_bf_mon
      ,sum(actual_bf_mon) as actual_bf_mon
      ,sum(plan_quarter_new) as plan_quarter_new
      ,sum(plan_quarter_new2) as plan_quarter_new2
      ,sum(actual_quarter_new) as actual_quarter_new
      ,sum(plan_mon) as plan_mon
      ,sum(plan_mon_new) as plan_mon_new
      ,sum(actual_day1) as actual_day1
      ,sum(actual_day2) as actual_day2
      ,sum(actual_day3) as actual_day3
      ,sum(actual_day4) as actual_day4
  from bidata.cusitem_analysis_city2
 group by province,city

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_city
select province
      ,city
      ,product_assist
      ,ifnull(plan_bf_mon,0)
      ,ifnull(actual_bf_mon,0)
      ,ifnull(actual_bf_mon,0) - ifnull(plan_bf_mon,0)
      ,ifnull(ifnull(actual_bf_mon,0)/ifnull(plan_bf_mon,0),0)
      ,ifnull(plan_quarter_new,0)
      ,ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0)
      ,ifnull(actual_quarter_new,0)
      ,ifnull((ifnull(plan_quarter_new2,0) + ifnull(plan_mon_new,0))/ifnull(plan_quarter_new,0),0)
      ,ifnull(ifnull(actual_quarter_new,0)/ifnull(plan_quarter_new,0),0)
      ,ifnull(plan_quarter_new,0) - ifnull(plan_quarter_new2,0) - ifnull(plan_mon_new,0)
      ,ifnull(plan_quarter_new,0) - ifnull(actual_quarter_new,0)
      ,0
      ,ifnull(plan_mon,0)
      ,ifnull(plan_mon_new,0)
      ,ifnull(actual_day1,0)
      ,ifnull(actual_day2,0)
      ,ifnull(actual_day3,0)
      ,ifnull(actual_day4,0)
      ,ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon,0),0)
      ,ifnull((ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))/ifnull(plan_mon_new,0),0)
      ,ifnull(plan_mon,0) - (ifnull(actual_day1,0) + ifnull(actual_day2,0) +  ifnull(actual_day3,0) + ifnull(actual_day4,0))
  from bidata.cusitem_analysis_city1
 where 1 = 1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401110550

insert into bidata.cusitem_analysis_city
select a.province
      ,a.city
      ,a.item
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
      ,0
  from bidata.cusitem_dic_city a
  left join bidata.cusitem_analysis_city1 b
    on a.province = b.province
   and a.city = b.city
   and a.item = b.product_assist
 where b.province is null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401110550
