
20190516001156开始执行2019-05-15数据加载日志:
SQL开始执行时间：20190516001156

use pdm
;
SQL结束执行时间：20190516001156
SQL开始执行时间：20190516001156

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190516001156
SQL开始执行时间：20190516001156
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190516001157
SQL开始执行时间：20190516001157

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190516001157
SQL开始执行时间：20190516001157
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190516001158
SQL开始执行时间：20190516001158
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190516001200
SQL开始执行时间：20190516001200
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190516001202
SQL开始执行时间：20190516001202

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190516001202
SQL开始执行时间：20190516001202
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190516001203
SQL开始执行时间：20190516001203
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190516001204
SQL开始执行时间：20190516001204


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190516001204
SQL开始执行时间：20190516001204
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190516001216
SQL开始执行时间：20190516001216

;

20190516082515开始执行2019-05-15数据加载日志:
SQL开始执行时间：20190516082515

use pdm
;
SQL结束执行时间：20190516082515
SQL开始执行时间：20190516082515

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190516082515
SQL开始执行时间：20190516082515
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190516082515
SQL开始执行时间：20190516082515

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190516082515
SQL开始执行时间：20190516082515
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190516082516
SQL开始执行时间：20190516082516
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190516082517
SQL开始执行时间：20190516082517
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190516082519
SQL开始执行时间：20190516082519

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190516082519
SQL开始执行时间：20190516082519
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190516082520
SQL开始执行时间：20190516082520
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190516082520
SQL开始执行时间：20190516082520


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190516082520
SQL开始执行时间：20190516082520
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190516082530
SQL开始执行时间：20190516082530

;

20190516083436开始执行2019-05-15数据加载日志:
SQL开始执行时间：20190516083436

use pdm
;
SQL结束执行时间：20190516083436
SQL开始执行时间：20190516083436

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190516083436
SQL开始执行时间：20190516083436
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190516083436
SQL开始执行时间：20190516083436

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190516083436
SQL开始执行时间：20190516083436
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190516083437
SQL开始执行时间：20190516083437
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190516083439
SQL开始执行时间：20190516083439
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190516083440
SQL开始执行时间：20190516083440

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190516083440
SQL开始执行时间：20190516083440
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190516083441
SQL开始执行时间：20190516083441
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190516083441
SQL开始执行时间：20190516083441


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190516083441
SQL开始执行时间：20190516083441
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190516083451
SQL开始执行时间：20190516083451


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190516083451
SQL开始执行时间：20190516083451
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190516083451
SQL开始执行时间：20190516083451

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190516083453
SQL开始执行时间：20190516083453
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190516083454
SQL开始执行时间：20190516083454
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190516083455
SQL开始执行时间：20190516083455
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190516083457
SQL开始执行时间：20190516083457

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190516083457
SQL开始执行时间：20190516083457
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190516083457
SQL开始执行时间：20190516083457

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190516083457
SQL开始执行时间：20190516083457

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190516083457
SQL开始执行时间：20190516083457
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190516083458
SQL开始执行时间：20190516083458

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190516083458
SQL开始执行时间：20190516083458

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190516083458
SQL开始执行时间：20190516083458
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190516083459
SQL开始执行时间：20190516083459

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190516083500
SQL开始执行时间：20190516083500

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190516083501
SQL开始执行时间：20190516083501




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190516083501
SQL开始执行时间：20190516083501

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190516083502
SQL开始执行时间：20190516083502
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190516083502
SQL开始执行时间：20190516083502
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190516083504
SQL开始执行时间：20190516083504
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190516083504
SQL开始执行时间：20190516083504
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190516083505
SQL开始执行时间：20190516083505

truncate table pdm.ar_detail
;
SQL结束执行时间：20190516083505
SQL开始执行时间：20190516083505
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190516083507
SQL开始执行时间：20190516083507

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190516083507
SQL开始执行时间：20190516083507

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190516083507

20190517001151开始执行2019-05-16数据加载日志:
SQL开始执行时间：20190517001151

use pdm
;
SQL结束执行时间：20190517001151
SQL开始执行时间：20190517001151

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190517001151
SQL开始执行时间：20190517001151
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190517001151
SQL开始执行时间：20190517001151

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190517001151
SQL开始执行时间：20190517001151
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190517001153
SQL开始执行时间：20190517001153
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190517001154
SQL开始执行时间：20190517001154
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190517001157
SQL开始执行时间：20190517001157

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190517001157
SQL开始执行时间：20190517001157
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190517001158
SQL开始执行时间：20190517001158
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190517001158
SQL开始执行时间：20190517001158


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190517001158
SQL开始执行时间：20190517001158
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190517001210
SQL开始执行时间：20190517001210


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190517001210
SQL开始执行时间：20190517001210
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190517001211
SQL开始执行时间：20190517001211

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190517001213
SQL开始执行时间：20190517001213
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190517001215
SQL开始执行时间：20190517001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190517001218
SQL开始执行时间：20190517001218
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190517001220
SQL开始执行时间：20190517001220

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190517001220
SQL开始执行时间：20190517001220
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190517001220
SQL开始执行时间：20190517001220

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190517001221
SQL开始执行时间：20190517001221

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190517001221
SQL开始执行时间：20190517001221
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190517001221
SQL开始执行时间：20190517001221

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190517001221
SQL开始执行时间：20190517001221

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190517001221
SQL开始执行时间：20190517001221
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190517001223
SQL开始执行时间：20190517001223

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190517001223
SQL开始执行时间：20190517001223

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190517001224
SQL开始执行时间：20190517001224




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190517001225
SQL开始执行时间：20190517001225

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190517001226
SQL开始执行时间：20190517001226
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190517001226
SQL开始执行时间：20190517001226
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190517001227
SQL开始执行时间：20190517001227
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190517001227
SQL开始执行时间：20190517001227
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190517001229
SQL开始执行时间：20190517001229

truncate table pdm.ar_detail
;
SQL结束执行时间：20190517001229
SQL开始执行时间：20190517001229
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190517001230
SQL开始执行时间：20190517001230

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190517001230
SQL开始执行时间：20190517001230

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190517001230

20190518001146开始执行2019-05-17数据加载日志:
SQL开始执行时间：20190518001146

use pdm
;
SQL结束执行时间：20190518001146
SQL开始执行时间：20190518001146

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190518001146
SQL开始执行时间：20190518001146
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190518001146
SQL开始执行时间：20190518001146

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190518001146
SQL开始执行时间：20190518001146
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190518001148
SQL开始执行时间：20190518001148
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190518001150
SQL开始执行时间：20190518001150
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190518001152
SQL开始执行时间：20190518001152

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190518001152
SQL开始执行时间：20190518001152
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190518001153
SQL开始执行时间：20190518001153
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190518001153
SQL开始执行时间：20190518001153


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190518001153
SQL开始执行时间：20190518001153
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190518001207
SQL开始执行时间：20190518001207


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190518001207
SQL开始执行时间：20190518001207
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190518001208
SQL开始执行时间：20190518001208

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190518001210
SQL开始执行时间：20190518001210
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190518001212
SQL开始执行时间：20190518001212
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190518001214
SQL开始执行时间：20190518001214
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190518001216
SQL开始执行时间：20190518001216

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190518001216
SQL开始执行时间：20190518001216
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190518001216
SQL开始执行时间：20190518001216

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190518001216
SQL开始执行时间：20190518001216

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190518001216
SQL开始执行时间：20190518001216
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190518001216
SQL开始执行时间：20190518001216

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190518001217
SQL开始执行时间：20190518001217

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190518001217
SQL开始执行时间：20190518001217
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190518001218
SQL开始执行时间：20190518001218

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190518001218
SQL开始执行时间：20190518001218

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190518001220
SQL开始执行时间：20190518001220




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190518001220
SQL开始执行时间：20190518001220

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190518001221
SQL开始执行时间：20190518001221
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190518001222
SQL开始执行时间：20190518001222
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190518001223
SQL开始执行时间：20190518001223
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190518001223
SQL开始执行时间：20190518001223
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190518001224
SQL开始执行时间：20190518001224

truncate table pdm.ar_detail
;
SQL结束执行时间：20190518001224
SQL开始执行时间：20190518001224
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190518001226
SQL开始执行时间：20190518001226

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190518001226
SQL开始执行时间：20190518001226

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190518001226

20190519001150开始执行2019-05-18数据加载日志:
SQL开始执行时间：20190519001150

use pdm
;
SQL结束执行时间：20190519001150
SQL开始执行时间：20190519001150

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190519001150
SQL开始执行时间：20190519001150
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190519001150
SQL开始执行时间：20190519001150

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190519001150
SQL开始执行时间：20190519001150
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190519001152
SQL开始执行时间：20190519001152
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190519001154
SQL开始执行时间：20190519001154
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190519001156
SQL开始执行时间：20190519001156

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190519001156
SQL开始执行时间：20190519001156
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190519001157
SQL开始执行时间：20190519001157
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190519001158
SQL开始执行时间：20190519001158


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190519001158
SQL开始执行时间：20190519001158
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190519001210
SQL开始执行时间：20190519001210


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190519001210
SQL开始执行时间：20190519001210
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190519001212
SQL开始执行时间：20190519001212

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190519001214
SQL开始执行时间：20190519001214
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190519001215
SQL开始执行时间：20190519001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190519001217
SQL开始执行时间：20190519001217
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190519001219
SQL开始执行时间：20190519001219

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190519001219
SQL开始执行时间：20190519001219
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190519001219
SQL开始执行时间：20190519001219

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190519001220
SQL开始执行时间：20190519001220

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190519001220
SQL开始执行时间：20190519001220
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190519001220
SQL开始执行时间：20190519001220

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190519001220
SQL开始执行时间：20190519001220

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190519001220
SQL开始执行时间：20190519001220
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190519001222
SQL开始执行时间：20190519001222

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190519001222
SQL开始执行时间：20190519001222

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190519001223
SQL开始执行时间：20190519001223




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190519001223
SQL开始执行时间：20190519001223

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190519001224
SQL开始执行时间：20190519001224
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190519001225
SQL开始执行时间：20190519001225
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190519001226
SQL开始执行时间：20190519001226
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190519001226
SQL开始执行时间：20190519001226
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190519001227
SQL开始执行时间：20190519001227

truncate table pdm.ar_detail
;
SQL结束执行时间：20190519001227
SQL开始执行时间：20190519001227
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190519001228
SQL开始执行时间：20190519001228

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190519001229
SQL开始执行时间：20190519001229

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190519001229

20190520001149开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520001149

use pdm
;
SQL结束执行时间：20190520001149
SQL开始执行时间：20190520001149

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190520001149
SQL开始执行时间：20190520001149
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190520001149
SQL开始执行时间：20190520001149

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190520001149
SQL开始执行时间：20190520001149
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190520001150
SQL开始执行时间：20190520001150
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190520001152
SQL开始执行时间：20190520001152
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190520001154
SQL开始执行时间：20190520001154

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190520001154
SQL开始执行时间：20190520001154
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190520001156
SQL开始执行时间：20190520001156
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190520001156
SQL开始执行时间：20190520001156


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190520001156
SQL开始执行时间：20190520001156
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190520001210
SQL开始执行时间：20190520001210


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190520001210
SQL开始执行时间：20190520001210
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190520001211
SQL开始执行时间：20190520001211

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190520001213
SQL开始执行时间：20190520001213
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190520001215
SQL开始执行时间：20190520001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190520001217
SQL开始执行时间：20190520001217
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190520001219
SQL开始执行时间：20190520001219

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190520001219
SQL开始执行时间：20190520001219
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190520001219
SQL开始执行时间：20190520001219

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190520001219
SQL开始执行时间：20190520001219

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190520001219
SQL开始执行时间：20190520001219
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190520001220
SQL开始执行时间：20190520001220

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190520001220
SQL开始执行时间：20190520001220

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190520001220
SQL开始执行时间：20190520001220
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190520001222
SQL开始执行时间：20190520001222

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190520001222
SQL开始执行时间：20190520001222

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190520001223
SQL开始执行时间：20190520001223




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190520001223
SQL开始执行时间：20190520001223

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190520001224
SQL开始执行时间：20190520001224
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190520001224
SQL开始执行时间：20190520001224
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190520001226
SQL开始执行时间：20190520001226
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190520001226
SQL开始执行时间：20190520001226
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190520001227
SQL开始执行时间：20190520001227

truncate table pdm.ar_detail
;
SQL结束执行时间：20190520001227
SQL开始执行时间：20190520001227
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190520001228
SQL开始执行时间：20190520001228

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190520001228
SQL开始执行时间：20190520001228

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190520001228

20190520103715开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520103715

use pdm
;
SQL结束执行时间：20190520103715
SQL开始执行时间：20190520103715

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190520103715
SQL开始执行时间：20190520103715
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190520103715
SQL开始执行时间：20190520103715

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190520103715
SQL开始执行时间：20190520103715
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190520103716
SQL开始执行时间：20190520103716
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190520103717
SQL开始执行时间：20190520103717
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190520103719
SQL开始执行时间：20190520103719

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190520103719
SQL开始执行时间：20190520103719
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190520103720
SQL开始执行时间：20190520103720
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190520103720
SQL开始执行时间：20190520103720


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190520103720
SQL开始执行时间：20190520103720
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190520103729
SQL开始执行时间：20190520103729


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190520103729
SQL开始执行时间：20190520103729
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190520103730
SQL开始执行时间：20190520103730

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190520103731
SQL开始执行时间：20190520103731
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190520103733
SQL开始执行时间：20190520103733
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190520103734
SQL开始执行时间：20190520103734
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190520103736
SQL开始执行时间：20190520103736

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190520103736
SQL开始执行时间：20190520103736
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190520103736
SQL开始执行时间：20190520103736

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190520103736
SQL开始执行时间：20190520103736

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190520103736
SQL开始执行时间：20190520103736
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190520103737
SQL开始执行时间：20190520103737

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190520103737
SQL开始执行时间：20190520103737

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190520103737
SQL开始执行时间：20190520103737
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190520103738
SQL开始执行时间：20190520103738

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190520103738
SQL开始执行时间：20190520103738

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190520103740
SQL开始执行时间：20190520103740




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190520103740
SQL开始执行时间：20190520103740

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190520103741
SQL开始执行时间：20190520103741
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190520103741
SQL开始执行时间：20190520103741
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190520103743
SQL开始执行时间：20190520103743
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190520103743
SQL开始执行时间：20190520103743
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190520103744
SQL开始执行时间：20190520103744

truncate table pdm.ar_detail
;
SQL结束执行时间：20190520103744
SQL开始执行时间：20190520103744
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190520103746
SQL开始执行时间：20190520103746

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190520103746
SQL开始执行时间：20190520103746

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190520103746

20190520124701开始执行2019-05-19数据加载日志:
SQL开始执行时间：20190520124701

use pdm
;
SQL结束执行时间：20190520124701
SQL开始执行时间：20190520124701

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190520124701
SQL开始执行时间：20190520124701
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190520124701
SQL开始执行时间：20190520124701

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190520124701
SQL开始执行时间：20190520124701
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190520124703
SQL开始执行时间：20190520124703
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190520124704
SQL开始执行时间：20190520124704
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190520124706
SQL开始执行时间：20190520124706

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190520124706
SQL开始执行时间：20190520124706
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190520124706
SQL开始执行时间：20190520124706
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190520124707
SQL开始执行时间：20190520124707


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190520124707
SQL开始执行时间：20190520124707
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190520124716
SQL开始执行时间：20190520124716


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190520124716
SQL开始执行时间：20190520124716
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190520124717
SQL开始执行时间：20190520124717

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190520124718
SQL开始执行时间：20190520124718
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190520124719
SQL开始执行时间：20190520124719
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190520124721
SQL开始执行时间：20190520124721
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190520124722
SQL开始执行时间：20190520124722

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190520124722
SQL开始执行时间：20190520124722
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190520124723
SQL开始执行时间：20190520124723

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190520124723
SQL开始执行时间：20190520124723

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190520124723
SQL开始执行时间：20190520124723
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190520124723
SQL开始执行时间：20190520124723

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190520124724
SQL开始执行时间：20190520124724

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190520124724
SQL开始执行时间：20190520124724
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190520124725
SQL开始执行时间：20190520124725

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190520124725
SQL开始执行时间：20190520124725

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190520124726
SQL开始执行时间：20190520124726




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190520124727
SQL开始执行时间：20190520124727

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190520124728
SQL开始执行时间：20190520124728
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190520124728
SQL开始执行时间：20190520124728
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190520124729
SQL开始执行时间：20190520124729
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190520124730
SQL开始执行时间：20190520124730
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190520124731
SQL开始执行时间：20190520124731

truncate table pdm.ar_detail
;
SQL结束执行时间：20190520124731
SQL开始执行时间：20190520124731
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190520124733
SQL开始执行时间：20190520124733

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190520124733
SQL开始执行时间：20190520124733

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190520124733

20190521001154开始执行2019-05-20数据加载日志:
SQL开始执行时间：20190521001154

use pdm
;
SQL结束执行时间：20190521001154
SQL开始执行时间：20190521001154

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190521001154
SQL开始执行时间：20190521001154
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190521001154
SQL开始执行时间：20190521001154

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190521001154
SQL开始执行时间：20190521001154
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190521001155
SQL开始执行时间：20190521001155
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190521001157
SQL开始执行时间：20190521001157
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190521001200
SQL开始执行时间：20190521001200

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190521001200
SQL开始执行时间：20190521001200
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190521001200
SQL开始执行时间：20190521001200
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190521001201
SQL开始执行时间：20190521001201


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190521001201
SQL开始执行时间：20190521001201
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190521001215
SQL开始执行时间：20190521001215


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190521001215
SQL开始执行时间：20190521001215
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190521001217
SQL开始执行时间：20190521001217

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190521001218
SQL开始执行时间：20190521001218
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190521001220
SQL开始执行时间：20190521001220
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190521001222
SQL开始执行时间：20190521001222
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190521001223
SQL开始执行时间：20190521001223

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190521001223
SQL开始执行时间：20190521001223
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190521001223
SQL开始执行时间：20190521001223

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190521001224
SQL开始执行时间：20190521001224

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190521001224
SQL开始执行时间：20190521001224
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190521001224
SQL开始执行时间：20190521001224

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190521001224
SQL开始执行时间：20190521001224

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190521001224
SQL开始执行时间：20190521001224
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190521001226
SQL开始执行时间：20190521001226

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190521001226
SQL开始执行时间：20190521001226

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190521001228
SQL开始执行时间：20190521001228




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190521001228
SQL开始执行时间：20190521001228

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190521001229
SQL开始执行时间：20190521001229
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190521001229
SQL开始执行时间：20190521001229
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190521001230
SQL开始执行时间：20190521001230
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190521001231
SQL开始执行时间：20190521001231
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190521001232
SQL开始执行时间：20190521001232

truncate table pdm.ar_detail
;
SQL结束执行时间：20190521001232
SQL开始执行时间：20190521001232
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190521001233
SQL开始执行时间：20190521001233

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190521001233
SQL开始执行时间：20190521001233

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190521001233

20190522001148开始执行2019-05-21数据加载日志:
SQL开始执行时间：20190522001148

use pdm
;
SQL结束执行时间：20190522001148
SQL开始执行时间：20190522001148

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190522001148
SQL开始执行时间：20190522001148
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190522001149
SQL开始执行时间：20190522001149

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190522001149
SQL开始执行时间：20190522001149
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190522001150
SQL开始执行时间：20190522001150
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190522001152
SQL开始执行时间：20190522001152
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190522001154
SQL开始执行时间：20190522001154

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190522001154
SQL开始执行时间：20190522001154
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190522001155
SQL开始执行时间：20190522001155
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190522001156
SQL开始执行时间：20190522001156


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190522001156
SQL开始执行时间：20190522001156
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190522001210
SQL开始执行时间：20190522001210


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190522001210
SQL开始执行时间：20190522001210
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190522001211
SQL开始执行时间：20190522001211

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190522001213
SQL开始执行时间：20190522001213
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190522001215
SQL开始执行时间：20190522001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190522001217
SQL开始执行时间：20190522001217
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190522001218
SQL开始执行时间：20190522001218

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190522001218
SQL开始执行时间：20190522001218
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190522001218
SQL开始执行时间：20190522001218

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190522001219
SQL开始执行时间：20190522001219

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190522001219
SQL开始执行时间：20190522001219
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190522001219
SQL开始执行时间：20190522001219

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190522001219
SQL开始执行时间：20190522001219

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190522001219
SQL开始执行时间：20190522001219
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190522001221
SQL开始执行时间：20190522001221

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190522001221
SQL开始执行时间：20190522001221

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190522001222
SQL开始执行时间：20190522001222




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190522001223
SQL开始执行时间：20190522001223

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190522001224
SQL开始执行时间：20190522001224
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190522001224
SQL开始执行时间：20190522001224
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190522001225
SQL开始执行时间：20190522001225
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190522001225
SQL开始执行时间：20190522001225
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190522001226
SQL开始执行时间：20190522001226

truncate table pdm.ar_detail
;
SQL结束执行时间：20190522001226
SQL开始执行时间：20190522001226
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190522001228
SQL开始执行时间：20190522001228

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190522001228
SQL开始执行时间：20190522001228

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190522001228

20190523001155开始执行2019-05-22数据加载日志:
SQL开始执行时间：20190523001155

use pdm
;
SQL结束执行时间：20190523001155
SQL开始执行时间：20190523001155

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190523001155
SQL开始执行时间：20190523001155
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190523001155
SQL开始执行时间：20190523001155

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190523001155
SQL开始执行时间：20190523001155
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190523001157
SQL开始执行时间：20190523001157
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190523001159
SQL开始执行时间：20190523001159
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190523001201
SQL开始执行时间：20190523001201

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190523001201
SQL开始执行时间：20190523001201
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190523001202
SQL开始执行时间：20190523001202
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190523001203
SQL开始执行时间：20190523001203


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190523001203
SQL开始执行时间：20190523001203
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190523001215
SQL开始执行时间：20190523001215


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190523001215
SQL开始执行时间：20190523001215
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190523001216
SQL开始执行时间：20190523001216

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190523001218
SQL开始执行时间：20190523001218
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190523001220
SQL开始执行时间：20190523001220
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190523001221
SQL开始执行时间：20190523001221
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190523001223
SQL开始执行时间：20190523001223

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190523001223
SQL开始执行时间：20190523001223
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190523001223
SQL开始执行时间：20190523001223

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190523001223
SQL开始执行时间：20190523001223

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190523001223
SQL开始执行时间：20190523001223
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190523001223
SQL开始执行时间：20190523001223

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190523001224
SQL开始执行时间：20190523001224

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190523001224
SQL开始执行时间：20190523001224
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190523001225
SQL开始执行时间：20190523001225

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190523001225
SQL开始执行时间：20190523001225

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190523001226
SQL开始执行时间：20190523001226




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190523001227
SQL开始执行时间：20190523001227

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190523001228
SQL开始执行时间：20190523001228
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190523001228
SQL开始执行时间：20190523001228
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190523001229
SQL开始执行时间：20190523001229
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190523001229
SQL开始执行时间：20190523001229
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190523001230
SQL开始执行时间：20190523001230

truncate table pdm.ar_detail
;
SQL结束执行时间：20190523001230
SQL开始执行时间：20190523001230
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190523001232
SQL开始执行时间：20190523001232

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190523001232
SQL开始执行时间：20190523001232

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190523001232

20190524001151开始执行2019-05-23数据加载日志:
SQL开始执行时间：20190524001151

use pdm
;
SQL结束执行时间：20190524001151
SQL开始执行时间：20190524001151

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190524001151
SQL开始执行时间：20190524001151
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190524001151
SQL开始执行时间：20190524001151

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190524001151
SQL开始执行时间：20190524001151
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190524001152
SQL开始执行时间：20190524001152
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190524001154
SQL开始执行时间：20190524001154
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190524001156
SQL开始执行时间：20190524001156

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190524001156
SQL开始执行时间：20190524001156
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190524001157
SQL开始执行时间：20190524001157
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190524001158
SQL开始执行时间：20190524001158


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190524001158
SQL开始执行时间：20190524001158
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190524001212
SQL开始执行时间：20190524001212


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190524001212
SQL开始执行时间：20190524001212
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190524001213
SQL开始执行时间：20190524001213

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190524001215
SQL开始执行时间：20190524001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190524001216
SQL开始执行时间：20190524001216
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190524001218
SQL开始执行时间：20190524001218
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190524001220
SQL开始执行时间：20190524001220

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190524001220
SQL开始执行时间：20190524001220
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190524001220
SQL开始执行时间：20190524001220

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190524001220
SQL开始执行时间：20190524001220

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190524001220
SQL开始执行时间：20190524001220
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190524001220
SQL开始执行时间：20190524001220

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190524001221
SQL开始执行时间：20190524001221

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190524001221
SQL开始执行时间：20190524001221
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190524001222
SQL开始执行时间：20190524001222

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190524001222
SQL开始执行时间：20190524001222

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190524001223
SQL开始执行时间：20190524001223




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190524001224
SQL开始执行时间：20190524001224

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190524001225
SQL开始执行时间：20190524001225
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190524001225
SQL开始执行时间：20190524001225
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190524001226
SQL开始执行时间：20190524001226
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190524001226
SQL开始执行时间：20190524001226
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190524001228
SQL开始执行时间：20190524001228

truncate table pdm.ar_detail
;
SQL结束执行时间：20190524001228
SQL开始执行时间：20190524001228
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190524001229
SQL开始执行时间：20190524001229

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190524001229
SQL开始执行时间：20190524001229

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190524001229

20190525001150开始执行2019-05-24数据加载日志:
SQL开始执行时间：20190525001150

use pdm
;
SQL结束执行时间：20190525001150
SQL开始执行时间：20190525001150

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190525001150
SQL开始执行时间：20190525001150
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190525001150
SQL开始执行时间：20190525001150

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190525001150
SQL开始执行时间：20190525001150
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190525001151
SQL开始执行时间：20190525001151
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190525001153
SQL开始执行时间：20190525001153
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190525001155
SQL开始执行时间：20190525001155

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190525001155
SQL开始执行时间：20190525001155
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190525001156
SQL开始执行时间：20190525001156
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190525001157
SQL开始执行时间：20190525001157


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190525001157
SQL开始执行时间：20190525001157
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190525001210
SQL开始执行时间：20190525001210


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190525001210
SQL开始执行时间：20190525001210
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190525001212
SQL开始执行时间：20190525001212

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190525001213
SQL开始执行时间：20190525001213
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190525001215
SQL开始执行时间：20190525001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190525001217
SQL开始执行时间：20190525001217
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190525001218
SQL开始执行时间：20190525001218

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190525001218
SQL开始执行时间：20190525001218
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190525001218
SQL开始执行时间：20190525001218

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190525001219
SQL开始执行时间：20190525001219

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190525001219
SQL开始执行时间：20190525001219
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190525001219
SQL开始执行时间：20190525001219

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190525001219
SQL开始执行时间：20190525001219

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190525001219
SQL开始执行时间：20190525001219
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190525001221
SQL开始执行时间：20190525001221

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190525001221
SQL开始执行时间：20190525001221

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190525001222
SQL开始执行时间：20190525001222




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190525001223
SQL开始执行时间：20190525001223

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190525001224
SQL开始执行时间：20190525001224
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190525001224
SQL开始执行时间：20190525001224
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190525001225
SQL开始执行时间：20190525001225
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190525001225
SQL开始执行时间：20190525001225
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190525001226
SQL开始执行时间：20190525001226

truncate table pdm.ar_detail
;
SQL结束执行时间：20190525001226
SQL开始执行时间：20190525001226
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190525001228
SQL开始执行时间：20190525001228

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190525001228
SQL开始执行时间：20190525001228

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190525001228

20190526001150开始执行2019-05-25数据加载日志:
SQL开始执行时间：20190526001150

use pdm
;
SQL结束执行时间：20190526001150
SQL开始执行时间：20190526001150

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190526001150
SQL开始执行时间：20190526001150
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190526001150
SQL开始执行时间：20190526001150

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190526001150
SQL开始执行时间：20190526001150
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190526001152
SQL开始执行时间：20190526001152
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190526001153
SQL开始执行时间：20190526001153
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190526001156
SQL开始执行时间：20190526001156

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190526001156
SQL开始执行时间：20190526001156
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190526001157
SQL开始执行时间：20190526001157
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190526001158
SQL开始执行时间：20190526001158


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190526001158
SQL开始执行时间：20190526001158
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190526001212
SQL开始执行时间：20190526001212


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190526001212
SQL开始执行时间：20190526001212
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190526001213
SQL开始执行时间：20190526001213

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190526001215
SQL开始执行时间：20190526001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190526001217
SQL开始执行时间：20190526001217
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190526001218
SQL开始执行时间：20190526001218
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190526001220
SQL开始执行时间：20190526001220

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190526001220
SQL开始执行时间：20190526001220
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190526001220
SQL开始执行时间：20190526001220

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190526001220
SQL开始执行时间：20190526001220

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190526001220
SQL开始执行时间：20190526001220
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190526001221
SQL开始执行时间：20190526001221

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190526001221
SQL开始执行时间：20190526001221

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190526001221
SQL开始执行时间：20190526001221
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190526001222
SQL开始执行时间：20190526001222

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190526001223
SQL开始执行时间：20190526001223

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190526001224
SQL开始执行时间：20190526001224




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190526001224
SQL开始执行时间：20190526001224

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190526001225
SQL开始执行时间：20190526001225
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190526001225
SQL开始执行时间：20190526001225
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190526001226
SQL开始执行时间：20190526001226
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190526001227
SQL开始执行时间：20190526001227
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190526001228
SQL开始执行时间：20190526001228

truncate table pdm.ar_detail
;
SQL结束执行时间：20190526001228
SQL开始执行时间：20190526001228
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190526001229
SQL开始执行时间：20190526001229

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190526001229
SQL开始执行时间：20190526001229

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190526001229

20190527001148开始执行2019-05-26数据加载日志:
SQL开始执行时间：20190527001148

use pdm
;
SQL结束执行时间：20190527001148
SQL开始执行时间：20190527001148

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190527001148
SQL开始执行时间：20190527001148
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190527001148
SQL开始执行时间：20190527001148

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190527001148
SQL开始执行时间：20190527001148
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190527001149
SQL开始执行时间：20190527001149
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190527001151
SQL开始执行时间：20190527001151
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190527001153
SQL开始执行时间：20190527001153

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190527001153
SQL开始执行时间：20190527001153
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190527001154
SQL开始执行时间：20190527001154
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190527001155
SQL开始执行时间：20190527001155


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190527001155
SQL开始执行时间：20190527001155
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,a.invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid

;
SQL结束执行时间：20190527001207
SQL开始执行时间：20190527001207


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190527001207
SQL开始执行时间：20190527001207
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190527001208
SQL开始执行时间：20190527001208

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190527001210
SQL开始执行时间：20190527001210
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190527001213
SQL开始执行时间：20190527001213
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190527001215
SQL开始执行时间：20190527001215
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190527001217
SQL开始执行时间：20190527001217

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190527001217
SQL开始执行时间：20190527001217
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190527001217
SQL开始执行时间：20190527001217

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190527001217
SQL开始执行时间：20190527001217

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190527001217
SQL开始执行时间：20190527001217
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190527001218
SQL开始执行时间：20190527001218

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190527001218
SQL开始执行时间：20190527001218

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190527001218
SQL开始执行时间：20190527001218
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190527001220
SQL开始执行时间：20190527001220

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190527001220
SQL开始执行时间：20190527001220

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190527001221
SQL开始执行时间：20190527001221




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190527001222
SQL开始执行时间：20190527001222

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190527001223
SQL开始执行时间：20190527001223
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190527001223
SQL开始执行时间：20190527001223
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190527001224
SQL开始执行时间：20190527001224
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190527001224
SQL开始执行时间：20190527001224
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190527001226
SQL开始执行时间：20190527001226

truncate table pdm.ar_detail
;
SQL结束执行时间：20190527001226
SQL开始执行时间：20190527001226
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190527001227
SQL开始执行时间：20190527001227

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190527001227
SQL开始执行时间：20190527001227

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190527001227

20190527102252开始执行2019-05-26数据加载日志:
SQL开始执行时间：20190527102252

use pdm
;
SQL结束执行时间：20190527102252
SQL开始执行时间：20190527102252

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190527102252
SQL开始执行时间：20190527102252
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190527102252
SQL开始执行时间：20190527102252

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190527102252
SQL开始执行时间：20190527102252
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190527102253
SQL开始执行时间：20190527102253
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190527102255
SQL开始执行时间：20190527102255
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190527102256
SQL开始执行时间：20190527102256

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190527102256
SQL开始执行时间：20190527102256
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190527102257
SQL开始执行时间：20190527102257
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190527102258
SQL开始执行时间：20190527102258


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190527102258
SQL开始执行时间：20190527102258
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190527102307
SQL开始执行时间：20190527102307

;

20190527102420开始执行2019-05-26数据加载日志:
SQL开始执行时间：20190527102420

use pdm
;
SQL结束执行时间：20190527102420
SQL开始执行时间：20190527102420

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190527102420
SQL开始执行时间：20190527102420
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190527102420
SQL开始执行时间：20190527102420

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190527102420
SQL开始执行时间：20190527102420
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190527102421
SQL开始执行时间：20190527102421
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190527102422
SQL开始执行时间：20190527102422
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190527102424
SQL开始执行时间：20190527102424

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190527102424
SQL开始执行时间：20190527102424
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190527102424
SQL开始执行时间：20190527102424
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190527102425
SQL开始执行时间：20190527102425


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190527102425
SQL开始执行时间：20190527102425
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190527102434
SQL开始执行时间：20190527102434


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190527102434
SQL开始执行时间：20190527102434
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190527102435
SQL开始执行时间：20190527102435

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190527102436
SQL开始执行时间：20190527102436
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190527102438
SQL开始执行时间：20190527102438
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190527102439
SQL开始执行时间：20190527102439
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190527102441
SQL开始执行时间：20190527102441

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190527102441
SQL开始执行时间：20190527102441
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190527102441
SQL开始执行时间：20190527102441

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190527102441
SQL开始执行时间：20190527102441

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190527102441
SQL开始执行时间：20190527102441
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190527102442
SQL开始执行时间：20190527102442

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190527102442
SQL开始执行时间：20190527102442

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190527102442
SQL开始执行时间：20190527102442
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190527102444
SQL开始执行时间：20190527102444

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190527102444
SQL开始执行时间：20190527102444

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190527102445
SQL开始执行时间：20190527102445




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190527102445
SQL开始执行时间：20190527102445

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190527102446
SQL开始执行时间：20190527102446
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190527102447
SQL开始执行时间：20190527102447
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190527102448
SQL开始执行时间：20190527102448
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190527102448
SQL开始执行时间：20190527102448
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190527102450
SQL开始执行时间：20190527102450

truncate table pdm.ar_detail
;
SQL结束执行时间：20190527102450
SQL开始执行时间：20190527102450
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190527102451
SQL开始执行时间：20190527102451

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190527102451
SQL开始执行时间：20190527102451

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190527102451

20190528001312开始执行2019-05-27数据加载日志:
SQL开始执行时间：20190528001312

use pdm
;
SQL结束执行时间：20190528001312
SQL开始执行时间：20190528001312

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190528001312
SQL开始执行时间：20190528001312
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190528001312
SQL开始执行时间：20190528001312

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190528001312
SQL开始执行时间：20190528001312
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190528001313
SQL开始执行时间：20190528001313
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190528001314
SQL开始执行时间：20190528001314
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190528001316
SQL开始执行时间：20190528001316

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190528001316
SQL开始执行时间：20190528001316
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190528001316
SQL开始执行时间：20190528001316
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190528001317
SQL开始执行时间：20190528001317


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190528001317
SQL开始执行时间：20190528001317
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190528001332
SQL开始执行时间：20190528001332


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190528001332
SQL开始执行时间：20190528001332
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190528001333
SQL开始执行时间：20190528001333

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190528001334
SQL开始执行时间：20190528001334
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190528001336
SQL开始执行时间：20190528001336
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190528001337
SQL开始执行时间：20190528001337
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190528001339
SQL开始执行时间：20190528001339

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190528001339
SQL开始执行时间：20190528001339
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190528001339
SQL开始执行时间：20190528001339

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190528001339
SQL开始执行时间：20190528001339

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190528001339
SQL开始执行时间：20190528001339
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190528001339
SQL开始执行时间：20190528001339

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190528001340
SQL开始执行时间：20190528001340

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190528001340
SQL开始执行时间：20190528001340
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190528001341
SQL开始执行时间：20190528001341

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190528001341
SQL开始执行时间：20190528001341

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190528001342
SQL开始执行时间：20190528001342




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190528001343
SQL开始执行时间：20190528001343

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190528001344
SQL开始执行时间：20190528001344
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190528001344
SQL开始执行时间：20190528001344
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190528001345
SQL开始执行时间：20190528001345
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190528001346
SQL开始执行时间：20190528001346
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190528001347
SQL开始执行时间：20190528001347

truncate table pdm.ar_detail
;
SQL结束执行时间：20190528001347
SQL开始执行时间：20190528001347
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190528001348
SQL开始执行时间：20190528001348

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190528001348
SQL开始执行时间：20190528001348

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190528001349

20190529001812开始执行2019-05-28数据加载日志:
SQL开始执行时间：20190529001812

use pdm
;
SQL结束执行时间：20190529001812
SQL开始执行时间：20190529001812

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190529001812
SQL开始执行时间：20190529001812
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190529001812
SQL开始执行时间：20190529001812

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190529001812
SQL开始执行时间：20190529001812
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190529001813
SQL开始执行时间：20190529001813
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190529001815
SQL开始执行时间：20190529001815
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190529001816
SQL开始执行时间：20190529001816

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190529001816
SQL开始执行时间：20190529001816
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190529001817
SQL开始执行时间：20190529001817
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190529001818
SQL开始执行时间：20190529001818


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190529001818
SQL开始执行时间：20190529001818
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190529001833
SQL开始执行时间：20190529001833


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190529001833
SQL开始执行时间：20190529001833
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190529001834
SQL开始执行时间：20190529001834

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190529001835
SQL开始执行时间：20190529001835
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190529001837
SQL开始执行时间：20190529001837
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190529001838
SQL开始执行时间：20190529001838
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190529001840
SQL开始执行时间：20190529001840

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190529001840
SQL开始执行时间：20190529001840
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190529001840
SQL开始执行时间：20190529001840

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190529001840
SQL开始执行时间：20190529001840

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190529001840
SQL开始执行时间：20190529001840
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190529001841
SQL开始执行时间：20190529001841

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190529001841
SQL开始执行时间：20190529001841

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190529001841
SQL开始执行时间：20190529001841
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190529001843
SQL开始执行时间：20190529001843

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190529001843
SQL开始执行时间：20190529001843

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190529001844
SQL开始执行时间：20190529001844




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190529001844
SQL开始执行时间：20190529001844

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190529001845
SQL开始执行时间：20190529001845
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190529001846
SQL开始执行时间：20190529001846
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190529001847
SQL开始执行时间：20190529001847
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190529001847
SQL开始执行时间：20190529001847
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190529001849
SQL开始执行时间：20190529001849

truncate table pdm.ar_detail
;
SQL结束执行时间：20190529001849
SQL开始执行时间：20190529001849
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190529001850
SQL开始执行时间：20190529001850

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190529001850
SQL开始执行时间：20190529001850

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190529001850

20190530001809开始执行2019-05-29数据加载日志:
SQL开始执行时间：20190530001809

use pdm
;
SQL结束执行时间：20190530001809
SQL开始执行时间：20190530001809

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190530001809
SQL开始执行时间：20190530001809
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190530001809
SQL开始执行时间：20190530001809

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190530001809
SQL开始执行时间：20190530001809
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190530001810
SQL开始执行时间：20190530001810
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190530001812
SQL开始执行时间：20190530001812
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190530001813
SQL开始执行时间：20190530001813

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190530001813
SQL开始执行时间：20190530001813
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190530001814
SQL开始执行时间：20190530001814
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190530001815
SQL开始执行时间：20190530001815


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190530001815
SQL开始执行时间：20190530001815
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190530001830
SQL开始执行时间：20190530001830


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190530001830
SQL开始执行时间：20190530001830
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190530001831
SQL开始执行时间：20190530001831

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190530001832
SQL开始执行时间：20190530001832
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190530001834
SQL开始执行时间：20190530001834
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190530001835
SQL开始执行时间：20190530001835
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190530001837
SQL开始执行时间：20190530001837

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190530001837
SQL开始执行时间：20190530001837
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190530001837
SQL开始执行时间：20190530001837

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190530001837
SQL开始执行时间：20190530001837

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190530001837
SQL开始执行时间：20190530001837
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190530001837
SQL开始执行时间：20190530001837

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190530001838
SQL开始执行时间：20190530001838

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190530001838
SQL开始执行时间：20190530001838
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190530001839
SQL开始执行时间：20190530001839

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190530001839
SQL开始执行时间：20190530001839

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190530001841
SQL开始执行时间：20190530001841




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190530001841
SQL开始执行时间：20190530001841

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190530001842
SQL开始执行时间：20190530001842
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190530001842
SQL开始执行时间：20190530001842
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190530001844
SQL开始执行时间：20190530001844
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190530001844
SQL开始执行时间：20190530001844
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190530001845
SQL开始执行时间：20190530001845

truncate table pdm.ar_detail
;
SQL结束执行时间：20190530001845
SQL开始执行时间：20190530001845
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190530001847
SQL开始执行时间：20190530001847

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190530001847
SQL开始执行时间：20190530001847

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190530001847

20190531001756开始执行2019-05-30数据加载日志:
SQL开始执行时间：20190531001756

use pdm
;
SQL结束执行时间：20190531001756
SQL开始执行时间：20190531001756

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190531001756
SQL开始执行时间：20190531001756
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190531001756
SQL开始执行时间：20190531001756

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190531001756
SQL开始执行时间：20190531001756
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190531001757
SQL开始执行时间：20190531001757
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190531001759
SQL开始执行时间：20190531001759
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190531001801
SQL开始执行时间：20190531001801

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190531001801
SQL开始执行时间：20190531001801
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190531001801
SQL开始执行时间：20190531001801
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190531001802
SQL开始执行时间：20190531001802


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190531001802
SQL开始执行时间：20190531001802
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190531001817
SQL开始执行时间：20190531001817


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190531001817
SQL开始执行时间：20190531001817
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190531001818
SQL开始执行时间：20190531001818

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190531001819
SQL开始执行时间：20190531001819
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190531001821
SQL开始执行时间：20190531001821
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190531001822
SQL开始执行时间：20190531001822
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190531001824
SQL开始执行时间：20190531001824

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190531001824
SQL开始执行时间：20190531001824
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190531001824
SQL开始执行时间：20190531001824

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190531001824
SQL开始执行时间：20190531001824

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190531001824
SQL开始执行时间：20190531001824
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190531001825
SQL开始执行时间：20190531001825

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190531001825
SQL开始执行时间：20190531001825

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190531001825
SQL开始执行时间：20190531001825
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190531001826
SQL开始执行时间：20190531001826

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190531001826
SQL开始执行时间：20190531001826

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190531001828
SQL开始执行时间：20190531001828




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190531001828
SQL开始执行时间：20190531001828

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190531001829
SQL开始执行时间：20190531001829
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190531001829
SQL开始执行时间：20190531001829
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190531001831
SQL开始执行时间：20190531001831
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190531001831
SQL开始执行时间：20190531001831
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190531001833
SQL开始执行时间：20190531001833

truncate table pdm.ar_detail
;
SQL结束执行时间：20190531001833
SQL开始执行时间：20190531001833
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190531001834
SQL开始执行时间：20190531001834

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190531001834
SQL开始执行时间：20190531001834

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190531001834

20190601001758开始执行2019-05-31数据加载日志:
SQL开始执行时间：20190601001758

use pdm
;
SQL结束执行时间：20190601001758
SQL开始执行时间：20190601001758

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190601001758
SQL开始执行时间：20190601001758
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190601001758
SQL开始执行时间：20190601001758

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190601001758
SQL开始执行时间：20190601001758
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190601001800
SQL开始执行时间：20190601001800
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190601001801
SQL开始执行时间：20190601001801
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190601001803
SQL开始执行时间：20190601001803

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190601001803
SQL开始执行时间：20190601001803
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190601001804
SQL开始执行时间：20190601001804
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190601001804
SQL开始执行时间：20190601001804


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190601001804
SQL开始执行时间：20190601001804
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190601001820
SQL开始执行时间：20190601001820


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190601001820
SQL开始执行时间：20190601001820
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190601001821
SQL开始执行时间：20190601001821

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190601001822
SQL开始执行时间：20190601001822
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190601001823
SQL开始执行时间：20190601001823
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190601001825
SQL开始执行时间：20190601001825
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190601001826
SQL开始执行时间：20190601001826

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190601001826
SQL开始执行时间：20190601001826
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190601001827
SQL开始执行时间：20190601001827

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190601001827
SQL开始执行时间：20190601001827

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190601001827
SQL开始执行时间：20190601001827
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190601001827
SQL开始执行时间：20190601001827

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190601001828
SQL开始执行时间：20190601001828

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190601001828
SQL开始执行时间：20190601001828
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190601001829
SQL开始执行时间：20190601001829

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190601001829
SQL开始执行时间：20190601001829

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190601001831
SQL开始执行时间：20190601001831




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190601001831
SQL开始执行时间：20190601001831

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190601001832
SQL开始执行时间：20190601001832
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190601001832
SQL开始执行时间：20190601001832
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190601001834
SQL开始执行时间：20190601001834
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190601001834
SQL开始执行时间：20190601001834
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190601001835
SQL开始执行时间：20190601001835

truncate table pdm.ar_detail
;
SQL结束执行时间：20190601001835
SQL开始执行时间：20190601001835
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190601001837
SQL开始执行时间：20190601001837

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190601001837
SQL开始执行时间：20190601001837

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190601001837

20190602001802开始执行2019-06-01数据加载日志:
SQL开始执行时间：20190602001802

use pdm
;
SQL结束执行时间：20190602001802
SQL开始执行时间：20190602001802

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190602001802
SQL开始执行时间：20190602001802
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190602001802
SQL开始执行时间：20190602001802

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190602001802
SQL开始执行时间：20190602001802
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190602001803
SQL开始执行时间：20190602001803
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190602001804
SQL开始执行时间：20190602001804
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190602001806
SQL开始执行时间：20190602001806

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190602001806
SQL开始执行时间：20190602001806
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190602001807
SQL开始执行时间：20190602001807
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190602001808
SQL开始执行时间：20190602001808


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190602001808
SQL开始执行时间：20190602001808
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190602001823
SQL开始执行时间：20190602001823


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190602001823
SQL开始执行时间：20190602001823
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190602001824
SQL开始执行时间：20190602001824

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190602001825
SQL开始执行时间：20190602001825
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190602001827
SQL开始执行时间：20190602001827
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190602001828
SQL开始执行时间：20190602001828
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190602001830
SQL开始执行时间：20190602001830

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190602001830
SQL开始执行时间：20190602001830
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190602001830
SQL开始执行时间：20190602001830

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190602001830
SQL开始执行时间：20190602001830

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190602001830
SQL开始执行时间：20190602001830
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190602001831
SQL开始执行时间：20190602001831

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190602001831
SQL开始执行时间：20190602001831

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190602001831
SQL开始执行时间：20190602001831
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190602001833
SQL开始执行时间：20190602001833

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190602001833
SQL开始执行时间：20190602001833

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190602001834
SQL开始执行时间：20190602001834




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190602001834
SQL开始执行时间：20190602001834

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190602001835
SQL开始执行时间：20190602001835
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190602001836
SQL开始执行时间：20190602001836
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190602001837
SQL开始执行时间：20190602001837
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190602001837
SQL开始执行时间：20190602001837
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190602001839
SQL开始执行时间：20190602001839

truncate table pdm.ar_detail
;
SQL结束执行时间：20190602001839
SQL开始执行时间：20190602001839
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190602001840
SQL开始执行时间：20190602001840

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190602001840
SQL开始执行时间：20190602001840

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190602001840

20190603001807开始执行2019-06-02数据加载日志:
SQL开始执行时间：20190603001807

use pdm
;
SQL结束执行时间：20190603001807
SQL开始执行时间：20190603001807

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190603001807
SQL开始执行时间：20190603001807
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190603001807
SQL开始执行时间：20190603001807

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190603001807
SQL开始执行时间：20190603001807
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190603001808
SQL开始执行时间：20190603001808
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190603001810
SQL开始执行时间：20190603001810
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190603001812
SQL开始执行时间：20190603001812

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190603001812
SQL开始执行时间：20190603001812
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190603001812
SQL开始执行时间：20190603001812
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190603001813
SQL开始执行时间：20190603001813


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190603001813
SQL开始执行时间：20190603001813
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190603001829
SQL开始执行时间：20190603001829


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190603001829
SQL开始执行时间：20190603001829
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190603001830
SQL开始执行时间：20190603001830

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190603001831
SQL开始执行时间：20190603001831
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190603001832
SQL开始执行时间：20190603001832
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190603001834
SQL开始执行时间：20190603001834
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190603001835
SQL开始执行时间：20190603001835

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190603001835
SQL开始执行时间：20190603001835
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190603001835
SQL开始执行时间：20190603001835

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190603001835
SQL开始执行时间：20190603001835

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190603001835
SQL开始执行时间：20190603001835
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190603001836
SQL开始执行时间：20190603001836

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190603001836
SQL开始执行时间：20190603001836

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190603001836
SQL开始执行时间：20190603001836
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190603001838
SQL开始执行时间：20190603001838

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190603001838
SQL开始执行时间：20190603001838

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190603001839
SQL开始执行时间：20190603001839




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190603001840
SQL开始执行时间：20190603001840

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190603001841
SQL开始执行时间：20190603001841
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190603001841
SQL开始执行时间：20190603001841
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190603001842
SQL开始执行时间：20190603001842
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190603001842
SQL开始执行时间：20190603001842
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190603001844
SQL开始执行时间：20190603001844

truncate table pdm.ar_detail
;
SQL结束执行时间：20190603001844
SQL开始执行时间：20190603001844
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190603001845
SQL开始执行时间：20190603001845

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190603001845
SQL开始执行时间：20190603001845

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190603001846

20190604001812开始执行2019-06-03数据加载日志:
SQL开始执行时间：20190604001812

use pdm
;
SQL结束执行时间：20190604001812
SQL开始执行时间：20190604001812

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190604001812
SQL开始执行时间：20190604001812
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190604001812
SQL开始执行时间：20190604001812

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190604001812
SQL开始执行时间：20190604001812
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190604001813
SQL开始执行时间：20190604001813
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190604001815
SQL开始执行时间：20190604001815
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190604001817
SQL开始执行时间：20190604001817

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190604001817
SQL开始执行时间：20190604001817
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190604001817
SQL开始执行时间：20190604001817
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190604001818
SQL开始执行时间：20190604001818


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190604001818
SQL开始执行时间：20190604001818
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190604001833
SQL开始执行时间：20190604001833


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190604001833
SQL开始执行时间：20190604001833
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190604001833
SQL开始执行时间：20190604001833

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190604001835
SQL开始执行时间：20190604001835
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190604001836
SQL开始执行时间：20190604001836
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190604001838
SQL开始执行时间：20190604001838
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190604001839
SQL开始执行时间：20190604001839

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190604001839
SQL开始执行时间：20190604001839
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190604001839
SQL开始执行时间：20190604001839

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190604001839
SQL开始执行时间：20190604001839

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190604001839
SQL开始执行时间：20190604001839
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190604001840
SQL开始执行时间：20190604001840

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190604001840
SQL开始执行时间：20190604001840

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190604001840
SQL开始执行时间：20190604001840
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190604001842
SQL开始执行时间：20190604001842

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190604001842
SQL开始执行时间：20190604001842

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190604001843
SQL开始执行时间：20190604001843




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190604001844
SQL开始执行时间：20190604001844

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190604001845
SQL开始执行时间：20190604001845
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190604001845
SQL开始执行时间：20190604001845
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190604001846
SQL开始执行时间：20190604001846
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190604001847
SQL开始执行时间：20190604001847
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190604001848
SQL开始执行时间：20190604001848

truncate table pdm.ar_detail
;
SQL结束执行时间：20190604001848
SQL开始执行时间：20190604001848
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190604001849
SQL开始执行时间：20190604001849

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190604001849
SQL开始执行时间：20190604001849

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190604001850

20190605001806开始执行2019-06-04数据加载日志:
SQL开始执行时间：20190605001806

use pdm
;
SQL结束执行时间：20190605001806
SQL开始执行时间：20190605001806

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190605001806
SQL开始执行时间：20190605001806
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190605001806
SQL开始执行时间：20190605001806

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190605001806
SQL开始执行时间：20190605001806
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190605001807
SQL开始执行时间：20190605001807
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190605001808
SQL开始执行时间：20190605001808
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190605001810
SQL开始执行时间：20190605001810

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190605001810
SQL开始执行时间：20190605001810
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190605001811
SQL开始执行时间：20190605001811
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190605001812
SQL开始执行时间：20190605001812


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190605001812
SQL开始执行时间：20190605001812
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190605001829
SQL开始执行时间：20190605001829


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190605001829
SQL开始执行时间：20190605001829
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190605001830
SQL开始执行时间：20190605001830

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190605001831
SQL开始执行时间：20190605001831
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190605001832
SQL开始执行时间：20190605001832
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190605001834
SQL开始执行时间：20190605001834
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190605001836
SQL开始执行时间：20190605001836

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190605001836
SQL开始执行时间：20190605001836
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190605001836
SQL开始执行时间：20190605001836

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190605001836
SQL开始执行时间：20190605001836

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190605001836
SQL开始执行时间：20190605001836
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190605001836
SQL开始执行时间：20190605001836

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190605001837
SQL开始执行时间：20190605001837

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190605001837
SQL开始执行时间：20190605001837
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190605001838
SQL开始执行时间：20190605001838

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190605001838
SQL开始执行时间：20190605001838

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190605001840
SQL开始执行时间：20190605001840




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190605001840
SQL开始执行时间：20190605001840

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190605001841
SQL开始执行时间：20190605001841
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190605001841
SQL开始执行时间：20190605001841
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190605001843
SQL开始执行时间：20190605001843
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190605001843
SQL开始执行时间：20190605001843
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190605001844
SQL开始执行时间：20190605001844

truncate table pdm.ar_detail
;
SQL结束执行时间：20190605001844
SQL开始执行时间：20190605001844
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190605001846
SQL开始执行时间：20190605001846

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190605001846
SQL开始执行时间：20190605001846

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190605001846

20190606001811开始执行2019-06-05数据加载日志:
SQL开始执行时间：20190606001811

use pdm
;
SQL结束执行时间：20190606001811
SQL开始执行时间：20190606001811

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190606001811
SQL开始执行时间：20190606001811
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190606001811
SQL开始执行时间：20190606001811

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190606001811
SQL开始执行时间：20190606001811
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190606001812
SQL开始执行时间：20190606001812
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190606001814
SQL开始执行时间：20190606001814
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190606001816
SQL开始执行时间：20190606001816

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190606001816
SQL开始执行时间：20190606001816
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190606001816
SQL开始执行时间：20190606001816
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190606001817
SQL开始执行时间：20190606001817


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190606001817
SQL开始执行时间：20190606001817
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190606001832
SQL开始执行时间：20190606001832


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190606001832
SQL开始执行时间：20190606001832
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190606001833
SQL开始执行时间：20190606001833

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190606001834
SQL开始执行时间：20190606001834
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190606001836
SQL开始执行时间：20190606001836
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190606001837
SQL开始执行时间：20190606001837
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190606001839
SQL开始执行时间：20190606001839

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190606001839
SQL开始执行时间：20190606001839
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190606001839
SQL开始执行时间：20190606001839

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190606001839
SQL开始执行时间：20190606001839

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190606001839
SQL开始执行时间：20190606001839
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190606001840
SQL开始执行时间：20190606001840

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190606001840
SQL开始执行时间：20190606001840

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190606001840
SQL开始执行时间：20190606001840
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190606001842
SQL开始执行时间：20190606001842

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190606001842
SQL开始执行时间：20190606001842

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190606001843
SQL开始执行时间：20190606001843




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190606001844
SQL开始执行时间：20190606001844

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190606001845
SQL开始执行时间：20190606001845
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190606001845
SQL开始执行时间：20190606001845
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190606001846
SQL开始执行时间：20190606001846
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190606001847
SQL开始执行时间：20190606001847
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190606001848
SQL开始执行时间：20190606001848

truncate table pdm.ar_detail
;
SQL结束执行时间：20190606001848
SQL开始执行时间：20190606001848
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190606001850
SQL开始执行时间：20190606001850

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190606001850
SQL开始执行时间：20190606001850

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190606001850

20190607001829开始执行2019-06-06数据加载日志:
SQL开始执行时间：20190607001829

use pdm
;
SQL结束执行时间：20190607001829
SQL开始执行时间：20190607001829

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190607001829
SQL开始执行时间：20190607001829
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190607001829
SQL开始执行时间：20190607001829

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190607001829
SQL开始执行时间：20190607001829
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190607001830
SQL开始执行时间：20190607001830
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190607001831
SQL开始执行时间：20190607001831
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190607001833
SQL开始执行时间：20190607001833

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190607001833
SQL开始执行时间：20190607001833
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190607001834
SQL开始执行时间：20190607001834
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190607001834
SQL开始执行时间：20190607001834


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190607001834
SQL开始执行时间：20190607001834
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190607001849
SQL开始执行时间：20190607001849


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190607001849
SQL开始执行时间：20190607001849
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190607001850
SQL开始执行时间：20190607001850

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190607001852
SQL开始执行时间：20190607001852
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190607001853
SQL开始执行时间：20190607001853
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190607001855
SQL开始执行时间：20190607001855
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190607001856
SQL开始执行时间：20190607001856

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190607001856
SQL开始执行时间：20190607001856
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190607001856
SQL开始执行时间：20190607001856

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190607001857
SQL开始执行时间：20190607001857

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190607001857
SQL开始执行时间：20190607001857
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190607001857
SQL开始执行时间：20190607001857

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190607001857
SQL开始执行时间：20190607001857

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190607001857
SQL开始执行时间：20190607001857
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190607001859
SQL开始执行时间：20190607001859

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190607001859
SQL开始执行时间：20190607001859

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190607001900
SQL开始执行时间：20190607001900




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190607001901
SQL开始执行时间：20190607001901

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190607001902
SQL开始执行时间：20190607001902
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190607001902
SQL开始执行时间：20190607001902
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190607001903
SQL开始执行时间：20190607001903
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190607001904
SQL开始执行时间：20190607001904
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190607001905
SQL开始执行时间：20190607001905

truncate table pdm.ar_detail
;
SQL结束执行时间：20190607001905
SQL开始执行时间：20190607001905
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190607001907
SQL开始执行时间：20190607001907

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190607001907
SQL开始执行时间：20190607001907

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190607001907

20190608001822开始执行2019-06-07数据加载日志:
SQL开始执行时间：20190608001822

use pdm
;
SQL结束执行时间：20190608001822
SQL开始执行时间：20190608001822

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190608001822
SQL开始执行时间：20190608001822
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190608001822
SQL开始执行时间：20190608001822

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190608001822
SQL开始执行时间：20190608001822
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190608001824
SQL开始执行时间：20190608001824
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190608001825
SQL开始执行时间：20190608001825
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190608001827
SQL开始执行时间：20190608001827

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190608001827
SQL开始执行时间：20190608001827
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190608001828
SQL开始执行时间：20190608001828
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190608001828
SQL开始执行时间：20190608001828


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190608001828
SQL开始执行时间：20190608001828
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190608001843
SQL开始执行时间：20190608001843


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190608001843
SQL开始执行时间：20190608001843
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190608001844
SQL开始执行时间：20190608001844

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190608001845
SQL开始执行时间：20190608001845
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190608001847
SQL开始执行时间：20190608001847
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190608001848
SQL开始执行时间：20190608001848
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190608001850
SQL开始执行时间：20190608001850

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190608001850
SQL开始执行时间：20190608001850
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190608001850
SQL开始执行时间：20190608001850

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190608001850
SQL开始执行时间：20190608001850

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190608001850
SQL开始执行时间：20190608001850
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190608001851
SQL开始执行时间：20190608001851

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190608001851
SQL开始执行时间：20190608001851

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190608001851
SQL开始执行时间：20190608001851
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190608001853
SQL开始执行时间：20190608001853

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190608001853
SQL开始执行时间：20190608001853

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190608001854
SQL开始执行时间：20190608001854




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190608001854
SQL开始执行时间：20190608001854

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190608001856
SQL开始执行时间：20190608001856
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190608001856
SQL开始执行时间：20190608001856
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190608001857
SQL开始执行时间：20190608001857
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190608001857
SQL开始执行时间：20190608001857
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190608001859
SQL开始执行时间：20190608001859

truncate table pdm.ar_detail
;
SQL结束执行时间：20190608001859
SQL开始执行时间：20190608001859
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190608001901
SQL开始执行时间：20190608001901

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190608001901
SQL开始执行时间：20190608001901

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190608001901

20190610085511开始执行2019-06-09数据加载日志:
SQL开始执行时间：20190610085511

use pdm
;
SQL结束执行时间：20190610085511
SQL开始执行时间：20190610085511

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190610085511
SQL开始执行时间：20190610085511
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190610085512
SQL开始执行时间：20190610085512

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190610085512
SQL开始执行时间：20190610085512
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190610085513
SQL开始执行时间：20190610085513
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190610085514
SQL开始执行时间：20190610085514
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190610085516
SQL开始执行时间：20190610085516

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190610085516
SQL开始执行时间：20190610085516
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190610085517
SQL开始执行时间：20190610085517
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190610085517
SQL开始执行时间：20190610085517


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190610085517
SQL开始执行时间：20190610085517
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190610085532
SQL开始执行时间：20190610085532


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190610085532
SQL开始执行时间：20190610085532
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190610085533
SQL开始执行时间：20190610085533

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190610085534
SQL开始执行时间：20190610085534
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190610085535
SQL开始执行时间：20190610085535
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190610085537
SQL开始执行时间：20190610085537
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190610085538
SQL开始执行时间：20190610085538

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190610085538
SQL开始执行时间：20190610085538
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190610085539
SQL开始执行时间：20190610085539

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190610085539
SQL开始执行时间：20190610085539

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190610085539
SQL开始执行时间：20190610085539
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190610085539
SQL开始执行时间：20190610085539

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190610085540
SQL开始执行时间：20190610085540

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190610085540
SQL开始执行时间：20190610085540
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190610085541
SQL开始执行时间：20190610085541

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190610085541
SQL开始执行时间：20190610085541

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190610085542
SQL开始执行时间：20190610085542




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190610085543
SQL开始执行时间：20190610085543

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190610085544
SQL开始执行时间：20190610085544
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190610085544
SQL开始执行时间：20190610085544
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190610085546
SQL开始执行时间：20190610085546
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190610085546
SQL开始执行时间：20190610085546
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190610085547
SQL开始执行时间：20190610085547

truncate table pdm.ar_detail
;
SQL结束执行时间：20190610085547
SQL开始执行时间：20190610085547
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190610085549
SQL开始执行时间：20190610085549

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190610085549
SQL开始执行时间：20190610085549

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190610085549

20190611001817开始执行2019-06-10数据加载日志:
SQL开始执行时间：20190611001817

use pdm
;
SQL结束执行时间：20190611001817
SQL开始执行时间：20190611001817

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190611001817
SQL开始执行时间：20190611001817
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190611001817
SQL开始执行时间：20190611001817

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190611001817
SQL开始执行时间：20190611001817
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190611001818
SQL开始执行时间：20190611001818
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190611001819
SQL开始执行时间：20190611001819
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190611001821
SQL开始执行时间：20190611001821

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190611001821
SQL开始执行时间：20190611001821
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190611001822
SQL开始执行时间：20190611001822
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190611001822
SQL开始执行时间：20190611001822


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190611001822
SQL开始执行时间：20190611001822
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190611001837
SQL开始执行时间：20190611001837


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190611001837
SQL开始执行时间：20190611001837
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190611001838
SQL开始执行时间：20190611001838

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190611001839
SQL开始执行时间：20190611001839
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190611001841
SQL开始执行时间：20190611001841
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190611001842
SQL开始执行时间：20190611001842
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190611001844
SQL开始执行时间：20190611001844

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190611001844
SQL开始执行时间：20190611001844
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190611001844
SQL开始执行时间：20190611001844

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190611001844
SQL开始执行时间：20190611001844

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190611001844
SQL开始执行时间：20190611001844
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190611001845
SQL开始执行时间：20190611001845

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190611001845
SQL开始执行时间：20190611001845

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190611001845
SQL开始执行时间：20190611001845
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190611001846
SQL开始执行时间：20190611001846

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190611001847
SQL开始执行时间：20190611001847

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190611001848
SQL开始执行时间：20190611001848




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190611001848
SQL开始执行时间：20190611001848

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190611001849
SQL开始执行时间：20190611001849
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190611001850
SQL开始执行时间：20190611001850
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190611001851
SQL开始执行时间：20190611001851
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190611001851
SQL开始执行时间：20190611001851
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190611001853
SQL开始执行时间：20190611001853

truncate table pdm.ar_detail
;
SQL结束执行时间：20190611001853
SQL开始执行时间：20190611001853
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190611001854
SQL开始执行时间：20190611001854

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190611001854
SQL开始执行时间：20190611001854

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190611001854

20190612001827开始执行2019-06-11数据加载日志:
SQL开始执行时间：20190612001827

use pdm
;
SQL结束执行时间：20190612001827
SQL开始执行时间：20190612001827

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190612001827
SQL开始执行时间：20190612001827
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190612001828
SQL开始执行时间：20190612001828

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190612001828
SQL开始执行时间：20190612001828
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190612001829
SQL开始执行时间：20190612001829
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190612001830
SQL开始执行时间：20190612001830
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190612001832
SQL开始执行时间：20190612001832

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190612001832
SQL开始执行时间：20190612001832
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190612001833
SQL开始执行时间：20190612001833
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190612001833
SQL开始执行时间：20190612001833


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190612001833
SQL开始执行时间：20190612001833
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190612001848
SQL开始执行时间：20190612001848


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190612001848
SQL开始执行时间：20190612001848
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190612001849
SQL开始执行时间：20190612001849

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190612001850
SQL开始执行时间：20190612001850
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190612001852
SQL开始执行时间：20190612001852
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190612001853
SQL开始执行时间：20190612001853
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190612001855
SQL开始执行时间：20190612001855

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190612001855
SQL开始执行时间：20190612001855
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190612001855
SQL开始执行时间：20190612001855

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190612001855
SQL开始执行时间：20190612001855

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190612001855
SQL开始执行时间：20190612001855
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190612001856
SQL开始执行时间：20190612001856

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190612001856
SQL开始执行时间：20190612001856

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190612001856
SQL开始执行时间：20190612001856
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190612001858
SQL开始执行时间：20190612001858

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190612001858
SQL开始执行时间：20190612001858

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190612001859
SQL开始执行时间：20190612001859




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190612001859
SQL开始执行时间：20190612001859

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190612001901
SQL开始执行时间：20190612001901
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190612001901
SQL开始执行时间：20190612001901
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190612001902
SQL开始执行时间：20190612001902
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190612001902
SQL开始执行时间：20190612001902
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190612001904
SQL开始执行时间：20190612001904

truncate table pdm.ar_detail
;
SQL结束执行时间：20190612001904
SQL开始执行时间：20190612001904
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190612001905
SQL开始执行时间：20190612001905

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190612001905
SQL开始执行时间：20190612001905

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190612001906

20190613001811开始执行2019-06-12数据加载日志:
SQL开始执行时间：20190613001811

use pdm
;
SQL结束执行时间：20190613001811
SQL开始执行时间：20190613001811

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190613001811
SQL开始执行时间：20190613001811
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190613001811
SQL开始执行时间：20190613001811

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190613001811
SQL开始执行时间：20190613001811
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190613001812
SQL开始执行时间：20190613001812
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190613001814
SQL开始执行时间：20190613001814
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190613001815
SQL开始执行时间：20190613001815

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190613001815
SQL开始执行时间：20190613001815
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190613001816
SQL开始执行时间：20190613001816
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190613001817
SQL开始执行时间：20190613001817


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190613001817
SQL开始执行时间：20190613001817
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190613001832
SQL开始执行时间：20190613001832


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190613001832
SQL开始执行时间：20190613001832
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190613001832
SQL开始执行时间：20190613001832

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190613001834
SQL开始执行时间：20190613001834
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190613001835
SQL开始执行时间：20190613001835
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190613001837
SQL开始执行时间：20190613001837
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190613001838
SQL开始执行时间：20190613001838

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190613001838
SQL开始执行时间：20190613001838
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190613001838
SQL开始执行时间：20190613001838

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190613001839
SQL开始执行时间：20190613001839

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190613001839
SQL开始执行时间：20190613001839
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190613001839
SQL开始执行时间：20190613001839

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190613001839
SQL开始执行时间：20190613001839

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190613001839
SQL开始执行时间：20190613001839
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190613001841
SQL开始执行时间：20190613001841

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190613001841
SQL开始执行时间：20190613001841

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190613001842
SQL开始执行时间：20190613001842




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190613001843
SQL开始执行时间：20190613001843

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190613001844
SQL开始执行时间：20190613001844
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190613001844
SQL开始执行时间：20190613001844
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190613001846
SQL开始执行时间：20190613001846
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190613001846
SQL开始执行时间：20190613001846
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190613001847
SQL开始执行时间：20190613001847

truncate table pdm.ar_detail
;
SQL结束执行时间：20190613001848
SQL开始执行时间：20190613001848
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190613001849
SQL开始执行时间：20190613001849

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190613001849
SQL开始执行时间：20190613001849

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190613001849

20190614001837开始执行2019-06-13数据加载日志:
SQL开始执行时间：20190614001837

use pdm
;
SQL结束执行时间：20190614001837
SQL开始执行时间：20190614001837

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190614001837
SQL开始执行时间：20190614001837
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190614001837
SQL开始执行时间：20190614001837

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190614001837
SQL开始执行时间：20190614001837
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190614001839
SQL开始执行时间：20190614001839
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190614001840
SQL开始执行时间：20190614001840
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190614001842
SQL开始执行时间：20190614001842

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190614001842
SQL开始执行时间：20190614001842
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190614001843
SQL开始执行时间：20190614001843
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190614001843
SQL开始执行时间：20190614001843


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190614001843
SQL开始执行时间：20190614001843
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190614001859
SQL开始执行时间：20190614001859


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190614001859
SQL开始执行时间：20190614001859
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190614001900
SQL开始执行时间：20190614001900

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190614001901
SQL开始执行时间：20190614001901
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190614001902
SQL开始执行时间：20190614001902
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190614001904
SQL开始执行时间：20190614001904
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190614001906
SQL开始执行时间：20190614001906

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190614001906
SQL开始执行时间：20190614001906
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190614001906
SQL开始执行时间：20190614001906

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190614001906
SQL开始执行时间：20190614001906

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190614001906
SQL开始执行时间：20190614001906
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190614001906
SQL开始执行时间：20190614001906

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190614001907
SQL开始执行时间：20190614001907

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190614001907
SQL开始执行时间：20190614001907
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190614001908
SQL开始执行时间：20190614001908

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190614001909
SQL开始执行时间：20190614001909

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190614001910
SQL开始执行时间：20190614001910




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190614001910
SQL开始执行时间：20190614001910

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190614001911
SQL开始执行时间：20190614001911
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190614001912
SQL开始执行时间：20190614001912
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190614001913
SQL开始执行时间：20190614001913
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190614001913
SQL开始执行时间：20190614001913
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190614001915
SQL开始执行时间：20190614001915

truncate table pdm.ar_detail
;
SQL结束执行时间：20190614001915
SQL开始执行时间：20190614001915
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190614001916
SQL开始执行时间：20190614001916

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190614001916
SQL开始执行时间：20190614001916

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190614001916

20190615001831开始执行2019-06-14数据加载日志:
SQL开始执行时间：20190615001831

use pdm
;
SQL结束执行时间：20190615001831
SQL开始执行时间：20190615001831

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190615001831
SQL开始执行时间：20190615001831
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190615001831
SQL开始执行时间：20190615001831

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190615001831
SQL开始执行时间：20190615001831
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190615001832
SQL开始执行时间：20190615001832
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190615001833
SQL开始执行时间：20190615001833
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190615001835
SQL开始执行时间：20190615001835

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190615001835
SQL开始执行时间：20190615001835
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190615001836
SQL开始执行时间：20190615001836
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190615001837
SQL开始执行时间：20190615001837


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190615001837
SQL开始执行时间：20190615001837
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190615001852
SQL开始执行时间：20190615001852


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190615001852
SQL开始执行时间：20190615001852
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190615001853
SQL开始执行时间：20190615001853

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190615001854
SQL开始执行时间：20190615001854
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190615001856
SQL开始执行时间：20190615001856
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190615001857
SQL开始执行时间：20190615001857
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190615001859
SQL开始执行时间：20190615001859

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190615001859
SQL开始执行时间：20190615001859
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190615001859
SQL开始执行时间：20190615001859

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190615001859
SQL开始执行时间：20190615001859

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190615001859
SQL开始执行时间：20190615001859
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190615001900
SQL开始执行时间：20190615001900

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190615001900
SQL开始执行时间：20190615001900

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190615001900
SQL开始执行时间：20190615001900
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190615001902
SQL开始执行时间：20190615001902

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190615001902
SQL开始执行时间：20190615001902

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190615001903
SQL开始执行时间：20190615001903




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190615001904
SQL开始执行时间：20190615001904

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190615001905
SQL开始执行时间：20190615001905
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190615001905
SQL开始执行时间：20190615001905
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190615001907
SQL开始执行时间：20190615001907
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190615001907
SQL开始执行时间：20190615001907
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190615001909
SQL开始执行时间：20190615001909

truncate table pdm.ar_detail
;
SQL结束执行时间：20190615001909
SQL开始执行时间：20190615001909
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190615001910
SQL开始执行时间：20190615001910

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190615001910
SQL开始执行时间：20190615001910

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190615001910

20190616001829开始执行2019-06-15数据加载日志:
SQL开始执行时间：20190616001829

use pdm
;
SQL结束执行时间：20190616001829
SQL开始执行时间：20190616001829

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190616001829
SQL开始执行时间：20190616001829
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190616001829
SQL开始执行时间：20190616001829

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190616001829
SQL开始执行时间：20190616001829
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190616001830
SQL开始执行时间：20190616001830
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190616001831
SQL开始执行时间：20190616001831
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190616001833
SQL开始执行时间：20190616001833

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190616001833
SQL开始执行时间：20190616001833
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190616001834
SQL开始执行时间：20190616001834
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190616001835
SQL开始执行时间：20190616001835


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190616001835
SQL开始执行时间：20190616001835
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190616001850
SQL开始执行时间：20190616001850


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190616001850
SQL开始执行时间：20190616001850
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190616001851
SQL开始执行时间：20190616001851

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190616001852
SQL开始执行时间：20190616001852
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190616001854
SQL开始执行时间：20190616001854
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190616001855
SQL开始执行时间：20190616001855
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190616001857
SQL开始执行时间：20190616001857

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190616001857
SQL开始执行时间：20190616001857
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190616001857
SQL开始执行时间：20190616001857

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190616001857
SQL开始执行时间：20190616001857

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190616001857
SQL开始执行时间：20190616001857
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190616001858
SQL开始执行时间：20190616001858

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190616001858
SQL开始执行时间：20190616001858

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190616001858
SQL开始执行时间：20190616001858
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190616001900
SQL开始执行时间：20190616001900

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190616001900
SQL开始执行时间：20190616001900

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190616001902
SQL开始执行时间：20190616001902




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190616001902
SQL开始执行时间：20190616001902

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190616001903
SQL开始执行时间：20190616001903
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190616001903
SQL开始执行时间：20190616001903
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190616001905
SQL开始执行时间：20190616001905
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190616001905
SQL开始执行时间：20190616001905
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190616001907
SQL开始执行时间：20190616001907

truncate table pdm.ar_detail
;
SQL结束执行时间：20190616001907
SQL开始执行时间：20190616001907
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190616001908
SQL开始执行时间：20190616001908

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190616001908
SQL开始执行时间：20190616001908

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190616001908

20190617001829开始执行2019-06-16数据加载日志:
SQL开始执行时间：20190617001829

use pdm
;
SQL结束执行时间：20190617001829
SQL开始执行时间：20190617001829

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190617001829
SQL开始执行时间：20190617001829
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190617001829
SQL开始执行时间：20190617001829

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190617001829
SQL开始执行时间：20190617001829
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190617001831
SQL开始执行时间：20190617001831
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190617001832
SQL开始执行时间：20190617001832
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190617001834
SQL开始执行时间：20190617001834

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190617001834
SQL开始执行时间：20190617001834
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190617001835
SQL开始执行时间：20190617001835
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190617001835
SQL开始执行时间：20190617001835


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190617001835
SQL开始执行时间：20190617001835
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190617001851
SQL开始执行时间：20190617001851


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190617001851
SQL开始执行时间：20190617001851
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190617001852
SQL开始执行时间：20190617001852

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190617001853
SQL开始执行时间：20190617001853
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190617001854
SQL开始执行时间：20190617001854
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190617001856
SQL开始执行时间：20190617001856
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190617001858
SQL开始执行时间：20190617001858

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190617001858
SQL开始执行时间：20190617001858
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190617001858
SQL开始执行时间：20190617001858

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190617001858
SQL开始执行时间：20190617001858

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190617001858
SQL开始执行时间：20190617001858
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190617001858
SQL开始执行时间：20190617001858

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190617001859
SQL开始执行时间：20190617001859

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190617001859
SQL开始执行时间：20190617001859
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190617001900
SQL开始执行时间：20190617001900

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190617001900
SQL开始执行时间：20190617001900

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190617001902
SQL开始执行时间：20190617001902




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190617001902
SQL开始执行时间：20190617001902

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190617001903
SQL开始执行时间：20190617001903
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190617001904
SQL开始执行时间：20190617001904
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190617001905
SQL开始执行时间：20190617001905
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190617001905
SQL开始执行时间：20190617001905
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190617001907
SQL开始执行时间：20190617001907

truncate table pdm.ar_detail
;
SQL结束执行时间：20190617001907
SQL开始执行时间：20190617001907
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190617001908
SQL开始执行时间：20190617001908

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190617001908
SQL开始执行时间：20190617001908

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190617001909

20190618001830开始执行2019-06-17数据加载日志:
SQL开始执行时间：20190618001830

use pdm
;
SQL结束执行时间：20190618001830
SQL开始执行时间：20190618001830

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190618001830
SQL开始执行时间：20190618001830
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190618001830
SQL开始执行时间：20190618001830

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190618001830
SQL开始执行时间：20190618001830
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190618001832
SQL开始执行时间：20190618001832
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190618001833
SQL开始执行时间：20190618001833
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190618001835
SQL开始执行时间：20190618001835

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190618001835
SQL开始执行时间：20190618001835
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190618001836
SQL开始执行时间：20190618001836
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190618001836
SQL开始执行时间：20190618001836


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190618001836
SQL开始执行时间：20190618001836
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190618001852
SQL开始执行时间：20190618001852


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190618001852
SQL开始执行时间：20190618001852
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190618001853
SQL开始执行时间：20190618001853

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190618001855
SQL开始执行时间：20190618001855
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190618001856
SQL开始执行时间：20190618001856
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190618001858
SQL开始执行时间：20190618001858
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190618001859
SQL开始执行时间：20190618001859

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190618001859
SQL开始执行时间：20190618001859
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190618001859
SQL开始执行时间：20190618001859

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190618001900
SQL开始执行时间：20190618001900

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190618001900
SQL开始执行时间：20190618001900
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190618001900
SQL开始执行时间：20190618001900

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190618001900
SQL开始执行时间：20190618001900

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190618001900
SQL开始执行时间：20190618001900
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190618001902
SQL开始执行时间：20190618001902

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190618001902
SQL开始执行时间：20190618001902

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190618001904
SQL开始执行时间：20190618001904




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190618001904
SQL开始执行时间：20190618001904

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190618001905
SQL开始执行时间：20190618001905
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190618001906
SQL开始执行时间：20190618001906
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190618001907
SQL开始执行时间：20190618001907
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190618001907
SQL开始执行时间：20190618001907
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190618001909
SQL开始执行时间：20190618001909

truncate table pdm.ar_detail
;
SQL结束执行时间：20190618001909
SQL开始执行时间：20190618001909
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190618001910
SQL开始执行时间：20190618001910

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190618001910
SQL开始执行时间：20190618001910

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190618001910

20190619001829开始执行2019-06-18数据加载日志:
SQL开始执行时间：20190619001829

use pdm
;
SQL结束执行时间：20190619001829
SQL开始执行时间：20190619001829

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190619001829
SQL开始执行时间：20190619001829
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190619001830
SQL开始执行时间：20190619001830

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190619001830
SQL开始执行时间：20190619001830
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190619001831
SQL开始执行时间：20190619001831
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190619001832
SQL开始执行时间：20190619001832
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190619001834
SQL开始执行时间：20190619001834

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190619001834
SQL开始执行时间：20190619001834
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190619001835
SQL开始执行时间：20190619001835
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190619001835
SQL开始执行时间：20190619001835


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190619001835
SQL开始执行时间：20190619001835
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190619001851
SQL开始执行时间：20190619001851


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190619001851
SQL开始执行时间：20190619001851
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190619001852
SQL开始执行时间：20190619001852

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190619001853
SQL开始执行时间：20190619001853
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190619001854
SQL开始执行时间：20190619001854
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190619001856
SQL开始执行时间：20190619001856
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190619001858
SQL开始执行时间：20190619001858

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190619001858
SQL开始执行时间：20190619001858
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190619001858
SQL开始执行时间：20190619001858

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190619001858
SQL开始执行时间：20190619001858

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190619001858
SQL开始执行时间：20190619001858
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190619001858
SQL开始执行时间：20190619001858

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190619001859
SQL开始执行时间：20190619001859

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190619001859
SQL开始执行时间：20190619001859
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190619001900
SQL开始执行时间：20190619001900

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190619001900
SQL开始执行时间：20190619001900

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190619001902
SQL开始执行时间：20190619001902




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190619001902
SQL开始执行时间：20190619001902

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190619001903
SQL开始执行时间：20190619001903
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190619001903
SQL开始执行时间：20190619001903
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190619001905
SQL开始执行时间：20190619001905
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190619001905
SQL开始执行时间：20190619001905
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190619001907
SQL开始执行时间：20190619001907

truncate table pdm.ar_detail
;
SQL结束执行时间：20190619001907
SQL开始执行时间：20190619001907
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190619001908
SQL开始执行时间：20190619001908

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190619001908
SQL开始执行时间：20190619001908

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190619001908

20190620001832开始执行2019-06-19数据加载日志:
SQL开始执行时间：20190620001832

use pdm
;
SQL结束执行时间：20190620001832
SQL开始执行时间：20190620001832

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190620001832
SQL开始执行时间：20190620001832
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190620001832
SQL开始执行时间：20190620001832

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190620001832
SQL开始执行时间：20190620001832
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190620001834
SQL开始执行时间：20190620001834
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190620001835
SQL开始执行时间：20190620001835
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190620001837
SQL开始执行时间：20190620001837

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190620001837
SQL开始执行时间：20190620001837
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190620001838
SQL开始执行时间：20190620001838
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190620001838
SQL开始执行时间：20190620001838


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190620001838
SQL开始执行时间：20190620001838
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190620001854
SQL开始执行时间：20190620001854


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190620001854
SQL开始执行时间：20190620001854
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190620001855
SQL开始执行时间：20190620001855

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190620001856
SQL开始执行时间：20190620001856
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190620001858
SQL开始执行时间：20190620001858
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190620001859
SQL开始执行时间：20190620001859
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190620001901
SQL开始执行时间：20190620001901

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190620001901
SQL开始执行时间：20190620001901
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190620001901
SQL开始执行时间：20190620001901

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190620001901
SQL开始执行时间：20190620001901

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190620001901
SQL开始执行时间：20190620001901
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190620001902
SQL开始执行时间：20190620001902

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190620001902
SQL开始执行时间：20190620001902

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190620001902
SQL开始执行时间：20190620001902
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190620001904
SQL开始执行时间：20190620001904

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190620001904
SQL开始执行时间：20190620001904

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190620001905
SQL开始执行时间：20190620001905




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190620001906
SQL开始执行时间：20190620001906

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190620001907
SQL开始执行时间：20190620001907
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190620001907
SQL开始执行时间：20190620001907
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190620001909
SQL开始执行时间：20190620001909
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190620001909
SQL开始执行时间：20190620001909
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190620001910
SQL开始执行时间：20190620001910

truncate table pdm.ar_detail
;
SQL结束执行时间：20190620001910
SQL开始执行时间：20190620001910
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190620001912
SQL开始执行时间：20190620001912

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190620001912
SQL开始执行时间：20190620001912

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190620001912

20190621001832开始执行2019-06-20数据加载日志:
SQL开始执行时间：20190621001832

use pdm
;
SQL结束执行时间：20190621001832
SQL开始执行时间：20190621001832

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190621001832
SQL开始执行时间：20190621001832
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190621001832
SQL开始执行时间：20190621001832

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190621001832
SQL开始执行时间：20190621001832
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190621001833
SQL开始执行时间：20190621001833
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190621001835
SQL开始执行时间：20190621001835
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190621001837
SQL开始执行时间：20190621001837

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190621001837
SQL开始执行时间：20190621001837
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190621001838
SQL开始执行时间：20190621001838
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190621001838
SQL开始执行时间：20190621001838


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190621001838
SQL开始执行时间：20190621001838
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190621001854
SQL开始执行时间：20190621001854


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190621001854
SQL开始执行时间：20190621001854
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190621001854
SQL开始执行时间：20190621001854

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190621001856
SQL开始执行时间：20190621001856
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190621001857
SQL开始执行时间：20190621001857
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190621001859
SQL开始执行时间：20190621001859
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190621001900
SQL开始执行时间：20190621001900

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190621001900
SQL开始执行时间：20190621001900
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190621001901
SQL开始执行时间：20190621001901

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190621001901
SQL开始执行时间：20190621001901

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190621001901
SQL开始执行时间：20190621001901
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190621001901
SQL开始执行时间：20190621001901

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190621001902
SQL开始执行时间：20190621001902

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190621001902
SQL开始执行时间：20190621001902
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190621001903
SQL开始执行时间：20190621001903

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190621001903
SQL开始执行时间：20190621001903

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190621001905
SQL开始执行时间：20190621001905




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190621001905
SQL开始执行时间：20190621001905

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190621001906
SQL开始执行时间：20190621001906
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190621001907
SQL开始执行时间：20190621001907
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190621001908
SQL开始执行时间：20190621001908
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190621001908
SQL开始执行时间：20190621001908
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190621001910
SQL开始执行时间：20190621001910

truncate table pdm.ar_detail
;
SQL结束执行时间：20190621001910
SQL开始执行时间：20190621001910
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190621001911
SQL开始执行时间：20190621001911

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190621001911
SQL开始执行时间：20190621001911

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190621001911

20190622001835开始执行2019-06-21数据加载日志:
SQL开始执行时间：20190622001835

use pdm
;
SQL结束执行时间：20190622001835
SQL开始执行时间：20190622001835

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190622001835
SQL开始执行时间：20190622001835
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190622001835
SQL开始执行时间：20190622001835

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190622001835
SQL开始执行时间：20190622001835
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190622001837
SQL开始执行时间：20190622001837
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190622001838
SQL开始执行时间：20190622001838
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190622001840
SQL开始执行时间：20190622001840

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190622001840
SQL开始执行时间：20190622001840
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190622001841
SQL开始执行时间：20190622001841
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190622001841
SQL开始执行时间：20190622001841


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190622001841
SQL开始执行时间：20190622001841
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190622001857
SQL开始执行时间：20190622001857


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190622001857
SQL开始执行时间：20190622001857
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190622001857
SQL开始执行时间：20190622001857

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190622001859
SQL开始执行时间：20190622001859
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190622001900
SQL开始执行时间：20190622001900
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190622001902
SQL开始执行时间：20190622001902
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190622001903
SQL开始执行时间：20190622001903

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190622001903
SQL开始执行时间：20190622001903
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190622001904
SQL开始执行时间：20190622001904

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190622001904
SQL开始执行时间：20190622001904

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190622001904
SQL开始执行时间：20190622001904
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190622001904
SQL开始执行时间：20190622001904

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190622001905
SQL开始执行时间：20190622001905

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190622001905
SQL开始执行时间：20190622001905
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190622001906
SQL开始执行时间：20190622001906

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190622001906
SQL开始执行时间：20190622001906

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190622001908
SQL开始执行时间：20190622001908




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190622001908
SQL开始执行时间：20190622001908

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190622001909
SQL开始执行时间：20190622001909
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190622001910
SQL开始执行时间：20190622001910
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190622001911
SQL开始执行时间：20190622001911
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190622001911
SQL开始执行时间：20190622001911
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190622001913
SQL开始执行时间：20190622001913

truncate table pdm.ar_detail
;
SQL结束执行时间：20190622001913
SQL开始执行时间：20190622001913
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190622001914
SQL开始执行时间：20190622001914

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190622001914
SQL开始执行时间：20190622001914

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190622001915

20190623001838开始执行2019-06-22数据加载日志:
SQL开始执行时间：20190623001838

use pdm
;
SQL结束执行时间：20190623001838
SQL开始执行时间：20190623001838

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190623001838
SQL开始执行时间：20190623001838
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190623001838
SQL开始执行时间：20190623001838

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190623001838
SQL开始执行时间：20190623001838
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190623001839
SQL开始执行时间：20190623001839
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190623001840
SQL开始执行时间：20190623001840
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190623001842
SQL开始执行时间：20190623001842

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190623001842
SQL开始执行时间：20190623001842
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190623001843
SQL开始执行时间：20190623001843
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190623001843
SQL开始执行时间：20190623001843


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190623001843
SQL开始执行时间：20190623001843
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190623001859
SQL开始执行时间：20190623001859


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190623001859
SQL开始执行时间：20190623001859
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190623001900
SQL开始执行时间：20190623001900

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190623001901
SQL开始执行时间：20190623001901
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190623001903
SQL开始执行时间：20190623001903
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190623001904
SQL开始执行时间：20190623001904
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190623001906
SQL开始执行时间：20190623001906

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190623001906
SQL开始执行时间：20190623001906
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190623001906
SQL开始执行时间：20190623001906

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190623001906
SQL开始执行时间：20190623001906

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190623001906
SQL开始执行时间：20190623001906
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190623001907
SQL开始执行时间：20190623001907

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190623001907
SQL开始执行时间：20190623001907

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190623001907
SQL开始执行时间：20190623001907
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190623001909
SQL开始执行时间：20190623001909

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190623001909
SQL开始执行时间：20190623001909

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190623001910
SQL开始执行时间：20190623001910




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190623001911
SQL开始执行时间：20190623001911

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190623001912
SQL开始执行时间：20190623001912
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190623001912
SQL开始执行时间：20190623001912
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190623001913
SQL开始执行时间：20190623001913
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190623001914
SQL开始执行时间：20190623001914
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190623001915
SQL开始执行时间：20190623001915

truncate table pdm.ar_detail
;
SQL结束执行时间：20190623001915
SQL开始执行时间：20190623001915
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190623001917
SQL开始执行时间：20190623001917

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190623001917
SQL开始执行时间：20190623001917

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190623001917

20190624090621开始执行2019-06-23数据加载日志:
SQL开始执行时间：20190624090621

use pdm
;
SQL结束执行时间：20190624090621
SQL开始执行时间：20190624090621

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190624090621
SQL开始执行时间：20190624090621
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190624090621
SQL开始执行时间：20190624090621

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190624090621
SQL开始执行时间：20190624090621
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190624090622
SQL开始执行时间：20190624090622
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190624090624
SQL开始执行时间：20190624090624
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190624090626
SQL开始执行时间：20190624090626

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190624090626
SQL开始执行时间：20190624090626
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190624090626
SQL开始执行时间：20190624090626
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190624090627
SQL开始执行时间：20190624090627


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190624090627
SQL开始执行时间：20190624090627
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190624090642
SQL开始执行时间：20190624090642


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190624090642
SQL开始执行时间：20190624090642
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190624090643
SQL开始执行时间：20190624090643

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190624090644
SQL开始执行时间：20190624090644
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190624090646
SQL开始执行时间：20190624090646
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190624090647
SQL开始执行时间：20190624090647
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190624090649
SQL开始执行时间：20190624090649

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190624090649
SQL开始执行时间：20190624090649
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190624090649
SQL开始执行时间：20190624090649

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190624090650
SQL开始执行时间：20190624090650

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190624090650
SQL开始执行时间：20190624090650
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190624090650
SQL开始执行时间：20190624090650

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190624090650
SQL开始执行时间：20190624090650

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190624090650
SQL开始执行时间：20190624090650
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190624090652
SQL开始执行时间：20190624090652

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190624090652
SQL开始执行时间：20190624090652

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190624090653
SQL开始执行时间：20190624090653




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190624090654
SQL开始执行时间：20190624090654

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190624090655
SQL开始执行时间：20190624090655
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190624090655
SQL开始执行时间：20190624090655
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190624090657
SQL开始执行时间：20190624090657
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190624090657
SQL开始执行时间：20190624090657
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190624090658
SQL开始执行时间：20190624090658

truncate table pdm.ar_detail
;
SQL结束执行时间：20190624090658
SQL开始执行时间：20190624090658
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190624090700
SQL开始执行时间：20190624090700

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190624090700
SQL开始执行时间：20190624090700

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190624090700

20190625001836开始执行2019-06-24数据加载日志:
SQL开始执行时间：20190625001836

use pdm
;
SQL结束执行时间：20190625001836
SQL开始执行时间：20190625001836

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190625001836
SQL开始执行时间：20190625001836
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190625001836
SQL开始执行时间：20190625001836

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190625001836
SQL开始执行时间：20190625001836
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190625001837
SQL开始执行时间：20190625001837
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190625001839
SQL开始执行时间：20190625001839
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190625001841
SQL开始执行时间：20190625001841

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190625001841
SQL开始执行时间：20190625001841
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190625001841
SQL开始执行时间：20190625001841
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190625001842
SQL开始执行时间：20190625001842


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190625001842
SQL开始执行时间：20190625001842
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190625001857
SQL开始执行时间：20190625001857


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190625001857
SQL开始执行时间：20190625001857
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190625001858
SQL开始执行时间：20190625001858

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190625001900
SQL开始执行时间：20190625001900
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190625001901
SQL开始执行时间：20190625001901
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190625001903
SQL开始执行时间：20190625001903
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190625001904
SQL开始执行时间：20190625001904

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190625001904
SQL开始执行时间：20190625001904
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190625001905
SQL开始执行时间：20190625001905

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190625001905
SQL开始执行时间：20190625001905

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190625001905
SQL开始执行时间：20190625001905
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190625001905
SQL开始执行时间：20190625001905

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190625001906
SQL开始执行时间：20190625001906

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190625001906
SQL开始执行时间：20190625001906
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190625001907
SQL开始执行时间：20190625001907

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190625001907
SQL开始执行时间：20190625001907

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190625001909
SQL开始执行时间：20190625001909




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190625001909
SQL开始执行时间：20190625001909

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190625001910
SQL开始执行时间：20190625001910
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190625001910
SQL开始执行时间：20190625001910
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190625001912
SQL开始执行时间：20190625001912
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190625001912
SQL开始执行时间：20190625001912
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190625001914
SQL开始执行时间：20190625001914

truncate table pdm.ar_detail
;
SQL结束执行时间：20190625001914
SQL开始执行时间：20190625001914
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190625001915
SQL开始执行时间：20190625001915

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190625001915
SQL开始执行时间：20190625001915

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190625001915

20190626001839开始执行2019-06-25数据加载日志:
SQL开始执行时间：20190626001839

use pdm
;
SQL结束执行时间：20190626001839
SQL开始执行时间：20190626001839

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190626001839
SQL开始执行时间：20190626001839
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190626001839
SQL开始执行时间：20190626001839

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190626001839
SQL开始执行时间：20190626001839
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190626001841
SQL开始执行时间：20190626001841
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190626001842
SQL开始执行时间：20190626001842
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190626001844
SQL开始执行时间：20190626001844

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190626001844
SQL开始执行时间：20190626001844
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190626001845
SQL开始执行时间：20190626001845
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190626001845
SQL开始执行时间：20190626001845


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190626001845
SQL开始执行时间：20190626001845
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190626001901
SQL开始执行时间：20190626001901


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190626001901
SQL开始执行时间：20190626001901
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190626001902
SQL开始执行时间：20190626001902

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190626001903
SQL开始执行时间：20190626001903
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190626001904
SQL开始执行时间：20190626001904
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190626001906
SQL开始执行时间：20190626001906
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190626001908
SQL开始执行时间：20190626001908

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190626001908
SQL开始执行时间：20190626001908
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190626001908
SQL开始执行时间：20190626001908

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190626001908
SQL开始执行时间：20190626001908

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190626001908
SQL开始执行时间：20190626001908
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190626001909
SQL开始执行时间：20190626001909

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190626001909
SQL开始执行时间：20190626001909

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190626001909
SQL开始执行时间：20190626001909
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190626001911
SQL开始执行时间：20190626001911

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190626001911
SQL开始执行时间：20190626001911

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190626001912
SQL开始执行时间：20190626001912




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190626001912
SQL开始执行时间：20190626001912

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190626001913
SQL开始执行时间：20190626001913
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190626001914
SQL开始执行时间：20190626001914
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190626001915
SQL开始执行时间：20190626001915
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190626001915
SQL开始执行时间：20190626001915
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190626001917
SQL开始执行时间：20190626001917

truncate table pdm.ar_detail
;
SQL结束执行时间：20190626001917
SQL开始执行时间：20190626001917
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190626001918
SQL开始执行时间：20190626001918

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190626001918
SQL开始执行时间：20190626001918

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190626001919

20190627001840开始执行2019-06-26数据加载日志:
SQL开始执行时间：20190627001840

use pdm
;
SQL结束执行时间：20190627001840
SQL开始执行时间：20190627001840

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190627001840
SQL开始执行时间：20190627001840
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190627001840
SQL开始执行时间：20190627001840

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190627001840
SQL开始执行时间：20190627001840
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190627001842
SQL开始执行时间：20190627001842
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190627001843
SQL开始执行时间：20190627001843
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190627001845
SQL开始执行时间：20190627001845

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190627001845
SQL开始执行时间：20190627001845
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190627001846
SQL开始执行时间：20190627001846
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190627001846
SQL开始执行时间：20190627001846


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190627001846
SQL开始执行时间：20190627001846
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190627001902
SQL开始执行时间：20190627001902


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190627001902
SQL开始执行时间：20190627001902
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190627001903
SQL开始执行时间：20190627001903

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190627001905
SQL开始执行时间：20190627001905
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190627001906
SQL开始执行时间：20190627001906
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190627001908
SQL开始执行时间：20190627001908
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190627001909
SQL开始执行时间：20190627001909

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190627001909
SQL开始执行时间：20190627001909
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190627001910
SQL开始执行时间：20190627001910

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190627001910
SQL开始执行时间：20190627001910

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190627001910
SQL开始执行时间：20190627001910
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190627001910
SQL开始执行时间：20190627001910

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190627001910
SQL开始执行时间：20190627001910

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190627001910
SQL开始执行时间：20190627001910
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190627001912
SQL开始执行时间：20190627001912

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190627001912
SQL开始执行时间：20190627001912

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190627001914
SQL开始执行时间：20190627001914




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190627001914
SQL开始执行时间：20190627001914

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190627001915
SQL开始执行时间：20190627001915
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190627001915
SQL开始执行时间：20190627001915
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190627001917
SQL开始执行时间：20190627001917
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190627001917
SQL开始执行时间：20190627001917
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190627001919
SQL开始执行时间：20190627001919

truncate table pdm.ar_detail
;
SQL结束执行时间：20190627001919
SQL开始执行时间：20190627001919
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190627001920
SQL开始执行时间：20190627001920

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190627001920
SQL开始执行时间：20190627001920

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190627001920

20190628001847开始执行2019-06-27数据加载日志:
SQL开始执行时间：20190628001847

use pdm
;
SQL结束执行时间：20190628001847
SQL开始执行时间：20190628001847

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190628001847
SQL开始执行时间：20190628001847
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190628001847
SQL开始执行时间：20190628001847

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190628001847
SQL开始执行时间：20190628001847
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190628001849
SQL开始执行时间：20190628001849
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190628001850
SQL开始执行时间：20190628001850
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190628001852
SQL开始执行时间：20190628001852

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190628001852
SQL开始执行时间：20190628001852
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190628001853
SQL开始执行时间：20190628001853
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190628001854
SQL开始执行时间：20190628001854


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190628001854
SQL开始执行时间：20190628001854
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190628001910
SQL开始执行时间：20190628001910


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190628001910
SQL开始执行时间：20190628001910
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190628001911
SQL开始执行时间：20190628001911

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190628001912
SQL开始执行时间：20190628001912
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190628001913
SQL开始执行时间：20190628001913
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190628001915
SQL开始执行时间：20190628001915
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190628001917
SQL开始执行时间：20190628001917

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190628001917
SQL开始执行时间：20190628001917
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190628001917
SQL开始执行时间：20190628001917

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190628001917
SQL开始执行时间：20190628001917

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190628001917
SQL开始执行时间：20190628001917
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190628001917
SQL开始执行时间：20190628001917

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190628001918
SQL开始执行时间：20190628001918

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190628001918
SQL开始执行时间：20190628001918
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190628001920
SQL开始执行时间：20190628001920

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190628001920
SQL开始执行时间：20190628001920

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190628001921
SQL开始执行时间：20190628001921




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190628001921
SQL开始执行时间：20190628001921

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190628001923
SQL开始执行时间：20190628001923
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190628001923
SQL开始执行时间：20190628001923
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190628001924
SQL开始执行时间：20190628001924
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190628001924
SQL开始执行时间：20190628001924
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190628001926
SQL开始执行时间：20190628001926

truncate table pdm.ar_detail
;
SQL结束执行时间：20190628001926
SQL开始执行时间：20190628001926
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190628001928
SQL开始执行时间：20190628001928

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190628001928
SQL开始执行时间：20190628001928

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190628001928

20190629001604开始执行2019-06-28数据加载日志:
SQL开始执行时间：20190629001604

use pdm
;
SQL结束执行时间：20190629001604
SQL开始执行时间：20190629001604

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190629001604
SQL开始执行时间：20190629001604
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190629001604
SQL开始执行时间：20190629001604

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190629001604
SQL开始执行时间：20190629001604
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190629001605
SQL开始执行时间：20190629001605
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190629001607
SQL开始执行时间：20190629001607
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190629001609
SQL开始执行时间：20190629001609

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190629001609
SQL开始执行时间：20190629001609
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190629001609
SQL开始执行时间：20190629001609
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190629001610
SQL开始执行时间：20190629001610


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190629001610
SQL开始执行时间：20190629001610
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190629001626
SQL开始执行时间：20190629001626


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190629001626
SQL开始执行时间：20190629001626
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190629001627
SQL开始执行时间：20190629001627

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190629001628
SQL开始执行时间：20190629001628
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190629001629
SQL开始执行时间：20190629001629
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190629001631
SQL开始执行时间：20190629001631
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190629001632
SQL开始执行时间：20190629001632

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190629001632
SQL开始执行时间：20190629001632
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190629001633
SQL开始执行时间：20190629001633

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190629001633
SQL开始执行时间：20190629001633

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190629001633
SQL开始执行时间：20190629001633
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190629001633
SQL开始执行时间：20190629001633

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190629001634
SQL开始执行时间：20190629001634

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190629001634
SQL开始执行时间：20190629001634
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190629001635
SQL开始执行时间：20190629001635

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190629001636
SQL开始执行时间：20190629001636

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190629001637
SQL开始执行时间：20190629001637




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190629001637
SQL开始执行时间：20190629001637

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190629001638
SQL开始执行时间：20190629001638
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190629001639
SQL开始执行时间：20190629001639
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190629001640
SQL开始执行时间：20190629001640
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190629001640
SQL开始执行时间：20190629001640
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190629001642
SQL开始执行时间：20190629001642

truncate table pdm.ar_detail
;
SQL结束执行时间：20190629001642
SQL开始执行时间：20190629001642
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190629001643
SQL开始执行时间：20190629001643

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190629001644
SQL开始执行时间：20190629001644

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190629001644

20190630001449开始执行2019-06-29数据加载日志:
SQL开始执行时间：20190630001449

use pdm
;
SQL结束执行时间：20190630001449
SQL开始执行时间：20190630001449

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190630001449
SQL开始执行时间：20190630001449
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190630001449
SQL开始执行时间：20190630001449

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190630001449
SQL开始执行时间：20190630001449
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190630001450
SQL开始执行时间：20190630001450
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190630001452
SQL开始执行时间：20190630001452
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190630001454
SQL开始执行时间：20190630001454

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190630001454
SQL开始执行时间：20190630001454
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190630001454
SQL开始执行时间：20190630001454
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190630001455
SQL开始执行时间：20190630001455


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190630001455
SQL开始执行时间：20190630001455
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190630001511
SQL开始执行时间：20190630001511


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190630001511
SQL开始执行时间：20190630001511
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190630001512
SQL开始执行时间：20190630001512

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190630001513
SQL开始执行时间：20190630001513
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190630001515
SQL开始执行时间：20190630001515
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190630001516
SQL开始执行时间：20190630001516
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190630001518
SQL开始执行时间：20190630001518

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190630001518
SQL开始执行时间：20190630001518
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190630001518
SQL开始执行时间：20190630001518

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190630001518
SQL开始执行时间：20190630001518

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190630001518
SQL开始执行时间：20190630001518
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190630001519
SQL开始执行时间：20190630001519

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190630001519
SQL开始执行时间：20190630001519

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190630001519
SQL开始执行时间：20190630001519
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190630001521
SQL开始执行时间：20190630001521

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190630001521
SQL开始执行时间：20190630001521

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190630001522
SQL开始执行时间：20190630001522




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190630001523
SQL开始执行时间：20190630001523

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190630001524
SQL开始执行时间：20190630001524
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190630001524
SQL开始执行时间：20190630001524
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190630001526
SQL开始执行时间：20190630001526
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190630001526
SQL开始执行时间：20190630001526
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190630001527
SQL开始执行时间：20190630001527

truncate table pdm.ar_detail
;
SQL结束执行时间：20190630001527
SQL开始执行时间：20190630001527
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190630001529
SQL开始执行时间：20190630001529

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190630001529
SQL开始执行时间：20190630001529

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190630001529

20190701001449开始执行2019-06-30数据加载日志:
SQL开始执行时间：20190701001449

use pdm
;
SQL结束执行时间：20190701001449
SQL开始执行时间：20190701001449

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190701001449
SQL开始执行时间：20190701001449
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190701001449
SQL开始执行时间：20190701001449

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190701001449
SQL开始执行时间：20190701001449
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190701001450
SQL开始执行时间：20190701001450
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190701001452
SQL开始执行时间：20190701001452
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190701001454
SQL开始执行时间：20190701001454

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190701001454
SQL开始执行时间：20190701001454
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190701001454
SQL开始执行时间：20190701001454
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190701001455
SQL开始执行时间：20190701001455


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190701001455
SQL开始执行时间：20190701001455
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190701001511
SQL开始执行时间：20190701001511


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190701001511
SQL开始执行时间：20190701001511
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190701001512
SQL开始执行时间：20190701001512

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190701001513
SQL开始执行时间：20190701001513
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190701001515
SQL开始执行时间：20190701001515
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190701001516
SQL开始执行时间：20190701001516
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190701001518
SQL开始执行时间：20190701001518

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190701001518
SQL开始执行时间：20190701001518
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190701001518
SQL开始执行时间：20190701001518

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190701001519
SQL开始执行时间：20190701001519

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190701001519
SQL开始执行时间：20190701001519
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190701001519
SQL开始执行时间：20190701001519

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190701001519
SQL开始执行时间：20190701001519

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190701001519
SQL开始执行时间：20190701001519
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190701001521
SQL开始执行时间：20190701001521

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190701001521
SQL开始执行时间：20190701001521

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190701001522
SQL开始执行时间：20190701001522




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190701001523
SQL开始执行时间：20190701001523

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190701001524
SQL开始执行时间：20190701001524
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190701001524
SQL开始执行时间：20190701001524
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190701001526
SQL开始执行时间：20190701001526
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190701001526
SQL开始执行时间：20190701001526
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190701001527
SQL开始执行时间：20190701001527

truncate table pdm.ar_detail
;
SQL结束执行时间：20190701001528
SQL开始执行时间：20190701001528
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190701001529
SQL开始执行时间：20190701001529

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190701001529
SQL开始执行时间：20190701001529

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190701001529

20190702001444开始执行2019-07-01数据加载日志:
SQL开始执行时间：20190702001444

use pdm
;
SQL结束执行时间：20190702001444
SQL开始执行时间：20190702001444

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190702001444
SQL开始执行时间：20190702001444
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190702001444
SQL开始执行时间：20190702001444

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190702001444
SQL开始执行时间：20190702001444
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190702001446
SQL开始执行时间：20190702001446
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190702001447
SQL开始执行时间：20190702001447
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190702001449
SQL开始执行时间：20190702001449

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190702001449
SQL开始执行时间：20190702001449
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190702001450
SQL开始执行时间：20190702001450
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190702001451
SQL开始执行时间：20190702001451


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190702001451
SQL开始执行时间：20190702001451
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190702001507
SQL开始执行时间：20190702001507


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190702001507
SQL开始执行时间：20190702001507
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190702001508
SQL开始执行时间：20190702001508

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190702001509
SQL开始执行时间：20190702001509
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190702001511
SQL开始执行时间：20190702001511
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190702001512
SQL开始执行时间：20190702001512
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190702001514
SQL开始执行时间：20190702001514

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190702001514
SQL开始执行时间：20190702001514
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190702001514
SQL开始执行时间：20190702001514

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190702001515
SQL开始执行时间：20190702001515

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190702001515
SQL开始执行时间：20190702001515
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190702001515
SQL开始执行时间：20190702001515

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190702001515
SQL开始执行时间：20190702001515

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190702001515
SQL开始执行时间：20190702001515
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190702001517
SQL开始执行时间：20190702001517

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190702001517
SQL开始执行时间：20190702001517

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190702001518
SQL开始执行时间：20190702001518




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190702001519
SQL开始执行时间：20190702001519

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190702001520
SQL开始执行时间：20190702001520
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190702001520
SQL开始执行时间：20190702001520
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190702001522
SQL开始执行时间：20190702001522
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190702001522
SQL开始执行时间：20190702001522
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190702001524
SQL开始执行时间：20190702001524

truncate table pdm.ar_detail
;
SQL结束执行时间：20190702001524
SQL开始执行时间：20190702001524
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190702001525
SQL开始执行时间：20190702001525

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190702001525
SQL开始执行时间：20190702001525

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190702001525

20190702165507开始执行2019-07-02数据加载日志:
SQL开始执行时间：20190702165507

use pdm
;
SQL结束执行时间：20190702165507
SQL开始执行时间：20190702165507

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190702165507
SQL开始执行时间：20190702165507
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190702165507
SQL开始执行时间：20190702165507

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190702165507
SQL开始执行时间：20190702165507
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190702165509
SQL开始执行时间：20190702165509
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190702165510
SQL开始执行时间：20190702165510
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190702165512
SQL开始执行时间：20190702165512

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190702165512
SQL开始执行时间：20190702165512
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190702165513
SQL开始执行时间：20190702165513
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190702165514
SQL开始执行时间：20190702165514


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190702165514
SQL开始执行时间：20190702165514
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190702165529
SQL开始执行时间：20190702165529


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190702165529
SQL开始执行时间：20190702165529
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190702165530
SQL开始执行时间：20190702165530

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190702165532
SQL开始执行时间：20190702165532
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190702165533
SQL开始执行时间：20190702165533
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190702165535
SQL开始执行时间：20190702165535
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190702165537
SQL开始执行时间：20190702165537

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190702165537
SQL开始执行时间：20190702165537
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190702165537
SQL开始执行时间：20190702165537

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190702165537
SQL开始执行时间：20190702165537

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190702165537
SQL开始执行时间：20190702165537
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190702165537
SQL开始执行时间：20190702165537

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190702165538
SQL开始执行时间：20190702165538

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190702165538
SQL开始执行时间：20190702165538
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190702165539
SQL开始执行时间：20190702165539

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190702165539
SQL开始执行时间：20190702165539

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190702165541
SQL开始执行时间：20190702165541




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190702165541
SQL开始执行时间：20190702165541

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190702165542
SQL开始执行时间：20190702165542
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190702165543
SQL开始执行时间：20190702165543
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190702165544
SQL开始执行时间：20190702165544
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190702165544
SQL开始执行时间：20190702165544
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190702165546
SQL开始执行时间：20190702165546

truncate table pdm.ar_detail
;
SQL结束执行时间：20190702165546
SQL开始执行时间：20190702165546
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190702165548
SQL开始执行时间：20190702165548

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190702165548
SQL开始执行时间：20190702165548

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190702165548

20190703001605开始执行2019-07-02数据加载日志:
SQL开始执行时间：20190703001605

use pdm
;
SQL结束执行时间：20190703001605
SQL开始执行时间：20190703001605

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190703001605
SQL开始执行时间：20190703001605
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190703001605
SQL开始执行时间：20190703001605

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190703001605
SQL开始执行时间：20190703001605
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190703001606
SQL开始执行时间：20190703001606
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190703001608
SQL开始执行时间：20190703001608
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190703001610
SQL开始执行时间：20190703001610

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190703001610
SQL开始执行时间：20190703001610
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190703001611
SQL开始执行时间：20190703001611
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190703001611
SQL开始执行时间：20190703001611


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190703001611
SQL开始执行时间：20190703001611
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190703001627
SQL开始执行时间：20190703001627


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190703001627
SQL开始执行时间：20190703001627
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190703001628
SQL开始执行时间：20190703001628

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190703001629
SQL开始执行时间：20190703001629
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190703001631
SQL开始执行时间：20190703001631
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190703001633
SQL开始执行时间：20190703001633
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190703001634
SQL开始执行时间：20190703001634

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190703001634
SQL开始执行时间：20190703001634
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190703001634
SQL开始执行时间：20190703001634

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190703001635
SQL开始执行时间：20190703001635
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190703001637
SQL开始执行时间：20190703001637

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190703001638
SQL开始执行时间：20190703001638

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190703001639
SQL开始执行时间：20190703001639




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190703001640
SQL开始执行时间：20190703001640

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190703001641
SQL开始执行时间：20190703001641
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190703001641
SQL开始执行时间：20190703001641
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190703001643
SQL开始执行时间：20190703001643
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190703001643
SQL开始执行时间：20190703001643
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190703001645
SQL开始执行时间：20190703001645

truncate table pdm.ar_detail
;
SQL结束执行时间：20190703001645
SQL开始执行时间：20190703001645
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190703001648
SQL开始执行时间：20190703001648

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190703001648

20190704001609开始执行2019-07-03数据加载日志:
SQL开始执行时间：20190704001609

use pdm
;
SQL结束执行时间：20190704001609
SQL开始执行时间：20190704001609

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190704001609
SQL开始执行时间：20190704001609
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190704001609
SQL开始执行时间：20190704001609

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190704001609
SQL开始执行时间：20190704001609
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190704001610
SQL开始执行时间：20190704001610
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190704001612
SQL开始执行时间：20190704001612
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190704001614
SQL开始执行时间：20190704001614

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190704001614
SQL开始执行时间：20190704001614
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190704001614
SQL开始执行时间：20190704001614
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190704001615
SQL开始执行时间：20190704001615


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190704001615
SQL开始执行时间：20190704001615
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190704001631
SQL开始执行时间：20190704001631


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190704001631
SQL开始执行时间：20190704001631
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190704001632
SQL开始执行时间：20190704001632

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190704001633
SQL开始执行时间：20190704001633
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190704001635
SQL开始执行时间：20190704001635
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190704001636
SQL开始执行时间：20190704001636
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190704001638
SQL开始执行时间：20190704001638

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190704001638
SQL开始执行时间：20190704001638
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190704001639
SQL开始执行时间：20190704001639

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190704001639
SQL开始执行时间：20190704001639

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190704001639
SQL开始执行时间：20190704001639
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190704001639
SQL开始执行时间：20190704001639

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190704001640
SQL开始执行时间：20190704001640

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190704001640
SQL开始执行时间：20190704001640
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190704001642
SQL开始执行时间：20190704001642

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190704001642
SQL开始执行时间：20190704001642

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190704001643
SQL开始执行时间：20190704001643




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190704001644
SQL开始执行时间：20190704001644

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190704001645
SQL开始执行时间：20190704001645
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190704001646
SQL开始执行时间：20190704001646
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190704001647
SQL开始执行时间：20190704001647
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190704001648
SQL开始执行时间：20190704001648
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190704001650
SQL开始执行时间：20190704001650

truncate table pdm.ar_detail
;
SQL结束执行时间：20190704001650
SQL开始执行时间：20190704001650
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190704001652
SQL开始执行时间：20190704001652

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190704001652
SQL开始执行时间：20190704001652

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190704001652

20190704103835开始执行2019-07-04数据加载日志:
SQL开始执行时间：20190704103835

use pdm
;
SQL结束执行时间：20190704103835
SQL开始执行时间：20190704103835

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190704103835
SQL开始执行时间：20190704103835
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190704103835
SQL开始执行时间：20190704103835

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190704103835
SQL开始执行时间：20190704103835
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190704103836
SQL开始执行时间：20190704103836
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190704103838
SQL开始执行时间：20190704103838
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190704103840
SQL开始执行时间：20190704103840

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190704103840
SQL开始执行时间：20190704103840
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190704103841
SQL开始执行时间：20190704103841
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190704103841
SQL开始执行时间：20190704103841


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190704103841
SQL开始执行时间：20190704103841
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190704103857
SQL开始执行时间：20190704103857


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190704103857
SQL开始执行时间：20190704103857
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190704103858
SQL开始执行时间：20190704103858

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190704103900
SQL开始执行时间：20190704103900
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190704103901
SQL开始执行时间：20190704103901
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190704103903
SQL开始执行时间：20190704103903
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190704103905
SQL开始执行时间：20190704103905

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190704103905
SQL开始执行时间：20190704103905
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190704103905
SQL开始执行时间：20190704103905

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190704103905
SQL开始执行时间：20190704103905

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190704103905
SQL开始执行时间：20190704103905
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190704103906
SQL开始执行时间：20190704103906

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190704103906
SQL开始执行时间：20190704103906

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190704103906
SQL开始执行时间：20190704103906
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190704103908
SQL开始执行时间：20190704103908

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190704103908
SQL开始执行时间：20190704103908

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190704103909
SQL开始执行时间：20190704103909




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190704103910
SQL开始执行时间：20190704103910

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190704103911
SQL开始执行时间：20190704103911
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190704103911
SQL开始执行时间：20190704103911
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190704103913
SQL开始执行时间：20190704103913
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190704103913
SQL开始执行时间：20190704103913
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190704103915
SQL开始执行时间：20190704103915

truncate table pdm.ar_detail
;
SQL结束执行时间：20190704103915
SQL开始执行时间：20190704103915
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190704103916
SQL开始执行时间：20190704103916

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190704103916
SQL开始执行时间：20190704103916

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190704103917

20190705001618开始执行2019-07-04数据加载日志:
SQL开始执行时间：20190705001618

use pdm
;
SQL结束执行时间：20190705001618
SQL开始执行时间：20190705001618

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190705001618
SQL开始执行时间：20190705001618
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190705001619
SQL开始执行时间：20190705001619

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190705001619
SQL开始执行时间：20190705001619
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190705001620
SQL开始执行时间：20190705001620
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190705001621
SQL开始执行时间：20190705001621
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190705001623
SQL开始执行时间：20190705001623

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190705001623
SQL开始执行时间：20190705001623
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190705001624
SQL开始执行时间：20190705001624
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190705001625
SQL开始执行时间：20190705001625


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190705001625
SQL开始执行时间：20190705001625
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190705001641
SQL开始执行时间：20190705001641


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190705001641
SQL开始执行时间：20190705001641
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190705001642
SQL开始执行时间：20190705001642

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190705001644
SQL开始执行时间：20190705001644
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190705001645
SQL开始执行时间：20190705001645
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190705001647
SQL开始执行时间：20190705001647
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190705001648
SQL开始执行时间：20190705001648

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190705001648
SQL开始执行时间：20190705001648
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190705001649
SQL开始执行时间：20190705001649

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190705001649
SQL开始执行时间：20190705001649

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190705001649
SQL开始执行时间：20190705001649
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190705001649
SQL开始执行时间：20190705001649

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190705001650
SQL开始执行时间：20190705001650

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190705001650
SQL开始执行时间：20190705001650
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190705001651
SQL开始执行时间：20190705001651

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190705001651
SQL开始执行时间：20190705001651

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190705001653
SQL开始执行时间：20190705001653




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190705001653
SQL开始执行时间：20190705001653

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190705001655
SQL开始执行时间：20190705001655
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190705001657
SQL开始执行时间：20190705001657
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190705001657
SQL开始执行时间：20190705001657
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190705001659
SQL开始执行时间：20190705001659

truncate table pdm.ar_detail
;
SQL结束执行时间：20190705001659
SQL开始执行时间：20190705001659
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190705001701
SQL开始执行时间：20190705001701

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190705001701
SQL开始执行时间：20190705001701

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190705001701

20190706001618开始执行2019-07-05数据加载日志:
SQL开始执行时间：20190706001618

use pdm
;
SQL结束执行时间：20190706001618
SQL开始执行时间：20190706001618

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190706001618
SQL开始执行时间：20190706001618
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190706001618
SQL开始执行时间：20190706001618

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190706001618
SQL开始执行时间：20190706001618
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190706001619
SQL开始执行时间：20190706001619
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190706001621
SQL开始执行时间：20190706001621
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190706001623
SQL开始执行时间：20190706001623

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190706001623
SQL开始执行时间：20190706001623
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190706001624
SQL开始执行时间：20190706001624
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190706001624
SQL开始执行时间：20190706001624


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190706001624
SQL开始执行时间：20190706001624
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190706001643
SQL开始执行时间：20190706001643


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190706001643
SQL开始执行时间：20190706001643
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190706001644
SQL开始执行时间：20190706001644

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190706001646
SQL开始执行时间：20190706001646
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190706001647
SQL开始执行时间：20190706001647
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190706001649
SQL开始执行时间：20190706001649
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190706001650
SQL开始执行时间：20190706001650

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190706001650
SQL开始执行时间：20190706001650
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190706001651
SQL开始执行时间：20190706001651

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190706001651
SQL开始执行时间：20190706001651

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190706001651
SQL开始执行时间：20190706001651
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190706001651
SQL开始执行时间：20190706001651

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190706001652
SQL开始执行时间：20190706001652

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190706001652
SQL开始执行时间：20190706001652
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190706001653
SQL开始执行时间：20190706001653

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190706001653
SQL开始执行时间：20190706001653

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190706001655
SQL开始执行时间：20190706001655




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190706001655
SQL开始执行时间：20190706001655

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190706001656
SQL开始执行时间：20190706001656
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190706001657
SQL开始执行时间：20190706001657
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190706001658
SQL开始执行时间：20190706001658
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190706001700
SQL开始执行时间：20190706001700

truncate table pdm.ar_detail
;
SQL结束执行时间：20190706001700
SQL开始执行时间：20190706001700
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190706001702
SQL开始执行时间：20190706001702

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190706001702
SQL开始执行时间：20190706001702

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190706001702

20190707001620开始执行2019-07-06数据加载日志:
SQL开始执行时间：20190707001620

use pdm
;
SQL结束执行时间：20190707001620
SQL开始执行时间：20190707001620

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190707001620
SQL开始执行时间：20190707001620
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190707001620
SQL开始执行时间：20190707001620

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190707001620
SQL开始执行时间：20190707001620
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190707001622
SQL开始执行时间：20190707001622
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190707001623
SQL开始执行时间：20190707001623
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190707001625
SQL开始执行时间：20190707001625

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190707001625
SQL开始执行时间：20190707001625
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190707001626
SQL开始执行时间：20190707001626
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190707001627
SQL开始执行时间：20190707001627


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190707001627
SQL开始执行时间：20190707001627
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190707001646
SQL开始执行时间：20190707001646


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190707001646
SQL开始执行时间：20190707001646
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190707001647
SQL开始执行时间：20190707001647

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190707001648
SQL开始执行时间：20190707001648
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190707001650
SQL开始执行时间：20190707001650
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190707001651
SQL开始执行时间：20190707001651
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190707001653
SQL开始执行时间：20190707001653

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190707001653
SQL开始执行时间：20190707001653
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190707001653
SQL开始执行时间：20190707001653

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190707001654
SQL开始执行时间：20190707001654

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190707001654
SQL开始执行时间：20190707001654
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190707001654
SQL开始执行时间：20190707001654

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190707001654
SQL开始执行时间：20190707001654

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190707001654
SQL开始执行时间：20190707001654
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190707001656
SQL开始执行时间：20190707001656

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190707001656
SQL开始执行时间：20190707001656

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190707001657
SQL开始执行时间：20190707001657




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190707001658
SQL开始执行时间：20190707001658

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190707001659
SQL开始执行时间：20190707001659
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190707001659
SQL开始执行时间：20190707001659
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190707001701
SQL开始执行时间：20190707001701
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190707001703
SQL开始执行时间：20190707001703

truncate table pdm.ar_detail
;
SQL结束执行时间：20190707001703
SQL开始执行时间：20190707001703
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190707001705
SQL开始执行时间：20190707001705

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190707001705
SQL开始执行时间：20190707001705

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190707001705

20190708001622开始执行2019-07-07数据加载日志:
SQL开始执行时间：20190708001622

use pdm
;
SQL结束执行时间：20190708001622
SQL开始执行时间：20190708001622

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190708001622
SQL开始执行时间：20190708001622
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190708001622
SQL开始执行时间：20190708001622

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190708001622
SQL开始执行时间：20190708001622
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190708001623
SQL开始执行时间：20190708001623
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190708001625
SQL开始执行时间：20190708001625
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190708001627
SQL开始执行时间：20190708001627

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190708001627
SQL开始执行时间：20190708001627
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190708001628
SQL开始执行时间：20190708001628
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190708001628
SQL开始执行时间：20190708001628


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190708001628
SQL开始执行时间：20190708001628
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190708001647
SQL开始执行时间：20190708001647


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190708001647
SQL开始执行时间：20190708001647
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190708001648
SQL开始执行时间：20190708001648

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190708001650
SQL开始执行时间：20190708001650
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190708001651
SQL开始执行时间：20190708001651
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190708001653
SQL开始执行时间：20190708001653
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190708001655
SQL开始执行时间：20190708001655

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190708001655
SQL开始执行时间：20190708001655
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190708001655
SQL开始执行时间：20190708001655

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190708001655
SQL开始执行时间：20190708001655

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190708001655
SQL开始执行时间：20190708001655
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190708001655
SQL开始执行时间：20190708001655

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190708001656
SQL开始执行时间：20190708001656

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190708001656
SQL开始执行时间：20190708001656
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190708001658
SQL开始执行时间：20190708001658

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190708001658
SQL开始执行时间：20190708001658

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190708001659
SQL开始执行时间：20190708001659




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190708001659
SQL开始执行时间：20190708001659

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190708001701
SQL开始执行时间：20190708001701
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190708001701
SQL开始执行时间：20190708001701
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190708001702
SQL开始执行时间：20190708001702
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190708001702
SQL开始执行时间：20190708001702
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190708001704
SQL开始执行时间：20190708001704

truncate table pdm.ar_detail
;
SQL结束执行时间：20190708001704
SQL开始执行时间：20190708001704
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190708001706
SQL开始执行时间：20190708001706

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190708001706
SQL开始执行时间：20190708001706

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190708001706

20190709001621开始执行2019-07-08数据加载日志:
SQL开始执行时间：20190709001621

use pdm
;
SQL结束执行时间：20190709001621
SQL开始执行时间：20190709001621

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190709001621
SQL开始执行时间：20190709001621
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190709001621
SQL开始执行时间：20190709001621

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190709001621
SQL开始执行时间：20190709001621
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190709001622
SQL开始执行时间：20190709001622
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190709001624
SQL开始执行时间：20190709001624
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190709001626
SQL开始执行时间：20190709001626

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190709001626
SQL开始执行时间：20190709001626
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190709001626
SQL开始执行时间：20190709001626
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190709001627
SQL开始执行时间：20190709001627


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190709001627
SQL开始执行时间：20190709001627
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190709001647
SQL开始执行时间：20190709001647


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190709001647
SQL开始执行时间：20190709001647
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190709001647
SQL开始执行时间：20190709001647

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190709001649
SQL开始执行时间：20190709001649
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190709001650
SQL开始执行时间：20190709001650
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190709001652
SQL开始执行时间：20190709001652
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190709001654
SQL开始执行时间：20190709001654

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190709001654
SQL开始执行时间：20190709001654
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190709001654
SQL开始执行时间：20190709001654

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190709001654
SQL开始执行时间：20190709001654

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190709001654
SQL开始执行时间：20190709001654
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190709001655
SQL开始执行时间：20190709001655

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190709001655
SQL开始执行时间：20190709001655

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190709001655
SQL开始执行时间：20190709001655
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190709001657
SQL开始执行时间：20190709001657

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190709001657
SQL开始执行时间：20190709001657

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190709001658
SQL开始执行时间：20190709001658




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190709001659
SQL开始执行时间：20190709001659

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190709001700
SQL开始执行时间：20190709001700
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190709001702
SQL开始执行时间：20190709001702
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190709001702
SQL开始执行时间：20190709001702
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190709001704
SQL开始执行时间：20190709001704

truncate table pdm.ar_detail
;
SQL结束执行时间：20190709001704
SQL开始执行时间：20190709001704
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190709001706
SQL开始执行时间：20190709001706

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190709001706
SQL开始执行时间：20190709001706

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190709001706

20190710001620开始执行2019-07-09数据加载日志:
SQL开始执行时间：20190710001620

use pdm
;
SQL结束执行时间：20190710001620
SQL开始执行时间：20190710001620

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190710001620
SQL开始执行时间：20190710001620
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190710001621
SQL开始执行时间：20190710001621

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190710001621
SQL开始执行时间：20190710001621
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190710001622
SQL开始执行时间：20190710001622
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190710001623
SQL开始执行时间：20190710001623
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190710001625
SQL开始执行时间：20190710001625

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190710001625
SQL开始执行时间：20190710001625
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190710001626
SQL开始执行时间：20190710001626
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190710001627
SQL开始执行时间：20190710001627


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190710001627
SQL开始执行时间：20190710001627
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190710001646
SQL开始执行时间：20190710001646


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190710001646
SQL开始执行时间：20190710001646
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190710001647
SQL开始执行时间：20190710001647

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190710001648
SQL开始执行时间：20190710001648
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190710001649
SQL开始执行时间：20190710001649
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190710001651
SQL开始执行时间：20190710001651
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190710001653
SQL开始执行时间：20190710001653

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190710001653
SQL开始执行时间：20190710001653
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190710001653
SQL开始执行时间：20190710001653

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190710001653
SQL开始执行时间：20190710001653

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190710001653
SQL开始执行时间：20190710001653
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190710001654
SQL开始执行时间：20190710001654

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190710001654
SQL开始执行时间：20190710001654

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190710001654
SQL开始执行时间：20190710001654
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190710001656
SQL开始执行时间：20190710001656

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190710001656
SQL开始执行时间：20190710001656

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190710001657
SQL开始执行时间：20190710001657




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190710001658
SQL开始执行时间：20190710001658

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190710001659
SQL开始执行时间：20190710001659
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190710001659
SQL开始执行时间：20190710001659
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190710001700
SQL开始执行时间：20190710001700
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190710001701
SQL开始执行时间：20190710001701
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190710001703
SQL开始执行时间：20190710001703

truncate table pdm.ar_detail
;
SQL结束执行时间：20190710001703
SQL开始执行时间：20190710001703
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190710001704
SQL开始执行时间：20190710001704

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190710001704
SQL开始执行时间：20190710001704

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190710001705

20190711001631开始执行2019-07-10数据加载日志:
SQL开始执行时间：20190711001631

use pdm
;
SQL结束执行时间：20190711001631
SQL开始执行时间：20190711001631

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190711001631
SQL开始执行时间：20190711001631
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190711001631
SQL开始执行时间：20190711001631

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190711001631
SQL开始执行时间：20190711001631
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190711001632
SQL开始执行时间：20190711001632
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190711001634
SQL开始执行时间：20190711001634
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190711001636
SQL开始执行时间：20190711001636

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190711001636
SQL开始执行时间：20190711001636
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190711001636
SQL开始执行时间：20190711001636
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190711001637
SQL开始执行时间：20190711001637


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190711001637
SQL开始执行时间：20190711001637
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190711001656
SQL开始执行时间：20190711001656


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190711001656
SQL开始执行时间：20190711001656
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190711001657
SQL开始执行时间：20190711001657

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190711001658
SQL开始执行时间：20190711001658
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190711001700
SQL开始执行时间：20190711001700
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190711001701
SQL开始执行时间：20190711001701
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190711001704
SQL开始执行时间：20190711001704

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190711001704
SQL开始执行时间：20190711001704
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190711001704
SQL开始执行时间：20190711001704

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190711001704
SQL开始执行时间：20190711001704

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190711001704
SQL开始执行时间：20190711001704
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190711001705
SQL开始执行时间：20190711001705

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190711001705
SQL开始执行时间：20190711001705

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190711001705
SQL开始执行时间：20190711001705
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190711001707
SQL开始执行时间：20190711001707

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190711001707
SQL开始执行时间：20190711001707

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190711001709
SQL开始执行时间：20190711001709




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190711001709
SQL开始执行时间：20190711001709

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190711001711
SQL开始执行时间：20190711001711
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190711001711
SQL开始执行时间：20190711001711
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190711001713
SQL开始执行时间：20190711001713
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190711001716
SQL开始执行时间：20190711001716

truncate table pdm.ar_detail
;
SQL结束执行时间：20190711001716
SQL开始执行时间：20190711001716
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190711001718
SQL开始执行时间：20190711001718

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190711001718
SQL开始执行时间：20190711001718

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190711001718

20190712001636开始执行2019-07-11数据加载日志:
SQL开始执行时间：20190712001636

use pdm
;
SQL结束执行时间：20190712001636
SQL开始执行时间：20190712001636

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190712001636
SQL开始执行时间：20190712001636
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190712001636
SQL开始执行时间：20190712001636

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190712001636
SQL开始执行时间：20190712001636
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190712001637
SQL开始执行时间：20190712001637
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190712001639
SQL开始执行时间：20190712001639
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190712001641
SQL开始执行时间：20190712001641

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190712001641
SQL开始执行时间：20190712001641
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190712001642
SQL开始执行时间：20190712001642
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190712001642
SQL开始执行时间：20190712001642


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190712001642
SQL开始执行时间：20190712001642
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190712001701
SQL开始执行时间：20190712001701


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190712001701
SQL开始执行时间：20190712001701
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190712001702
SQL开始执行时间：20190712001702

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190712001703
SQL开始执行时间：20190712001703
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190712001705
SQL开始执行时间：20190712001705
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190712001707
SQL开始执行时间：20190712001707
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190712001708
SQL开始执行时间：20190712001708

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190712001708
SQL开始执行时间：20190712001708
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190712001709
SQL开始执行时间：20190712001709

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190712001709
SQL开始执行时间：20190712001709

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190712001709
SQL开始执行时间：20190712001709
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190712001709
SQL开始执行时间：20190712001709

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190712001709
SQL开始执行时间：20190712001709

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190712001709
SQL开始执行时间：20190712001709
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190712001711
SQL开始执行时间：20190712001711

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190712001711
SQL开始执行时间：20190712001711

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190712001713
SQL开始执行时间：20190712001713




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190712001713
SQL开始执行时间：20190712001713

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190712001714
SQL开始执行时间：20190712001714
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190712001715
SQL开始执行时间：20190712001715
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190712001716
SQL开始执行时间：20190712001716
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190712001716
SQL开始执行时间：20190712001716
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190712001718
SQL开始执行时间：20190712001718

truncate table pdm.ar_detail
;
SQL结束执行时间：20190712001718
SQL开始执行时间：20190712001718
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190712001720
SQL开始执行时间：20190712001720

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190712001720

20190713001632开始执行2019-07-12数据加载日志:
SQL开始执行时间：20190713001632

use pdm
;
SQL结束执行时间：20190713001632
SQL开始执行时间：20190713001632

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190713001632
SQL开始执行时间：20190713001632
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190713001632
SQL开始执行时间：20190713001632

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190713001632
SQL开始执行时间：20190713001632
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190713001633
SQL开始执行时间：20190713001633
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190713001634
SQL开始执行时间：20190713001634
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190713001637
SQL开始执行时间：20190713001637

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190713001637
SQL开始执行时间：20190713001637
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190713001637
SQL开始执行时间：20190713001637
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190713001638
SQL开始执行时间：20190713001638


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190713001638
SQL开始执行时间：20190713001638
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190713001657
SQL开始执行时间：20190713001657


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190713001657
SQL开始执行时间：20190713001657
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190713001658
SQL开始执行时间：20190713001658

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190713001659
SQL开始执行时间：20190713001659
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190713001701
SQL开始执行时间：20190713001701
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190713001703
SQL开始执行时间：20190713001703
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190713001704
SQL开始执行时间：20190713001705

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190713001705
SQL开始执行时间：20190713001705
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190713001705
SQL开始执行时间：20190713001705

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190713001705
SQL开始执行时间：20190713001705

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190713001705
SQL开始执行时间：20190713001705
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190713001705
SQL开始执行时间：20190713001705

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190713001706
SQL开始执行时间：20190713001706

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190713001706
SQL开始执行时间：20190713001706
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190713001707
SQL开始执行时间：20190713001707

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190713001708
SQL开始执行时间：20190713001708

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190713001709
SQL开始执行时间：20190713001709




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190713001709
SQL开始执行时间：20190713001709

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190713001711
SQL开始执行时间：20190713001711
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190713001711
SQL开始执行时间：20190713001711
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190713001713
SQL开始执行时间：20190713001713
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190713001713
SQL开始执行时间：20190713001713
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190713001715
SQL开始执行时间：20190713001715

truncate table pdm.ar_detail
;
SQL结束执行时间：20190713001715
SQL开始执行时间：20190713001715
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190713001716
SQL开始执行时间：20190713001716

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190713001716
SQL开始执行时间：20190713001716

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190713001716

20190714001508开始执行2019-07-13数据加载日志:
SQL开始执行时间：20190714001508

use pdm
;
SQL结束执行时间：20190714001508
SQL开始执行时间：20190714001508

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190714001508
SQL开始执行时间：20190714001508
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190714001508
SQL开始执行时间：20190714001508

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190714001509
SQL开始执行时间：20190714001509
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190714001510
SQL开始执行时间：20190714001510
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190714001511
SQL开始执行时间：20190714001511
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190714001513
SQL开始执行时间：20190714001513

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190714001513
SQL开始执行时间：20190714001513
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190714001514
SQL开始执行时间：20190714001514
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190714001515
SQL开始执行时间：20190714001515


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190714001515
SQL开始执行时间：20190714001515
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190714001534
SQL开始执行时间：20190714001534


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190714001534
SQL开始执行时间：20190714001534
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190714001535
SQL开始执行时间：20190714001535

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190714001536
SQL开始执行时间：20190714001536
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190714001538
SQL开始执行时间：20190714001538
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190714001540
SQL开始执行时间：20190714001540
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190714001541
SQL开始执行时间：20190714001541

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190714001541
SQL开始执行时间：20190714001541
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190714001542
SQL开始执行时间：20190714001542

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190714001542
SQL开始执行时间：20190714001542

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190714001542
SQL开始执行时间：20190714001542
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190714001542
SQL开始执行时间：20190714001542

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190714001543
SQL开始执行时间：20190714001543

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190714001543
SQL开始执行时间：20190714001543
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190714001544
SQL开始执行时间：20190714001544

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190714001544
SQL开始执行时间：20190714001544

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190714001546
SQL开始执行时间：20190714001546




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190714001546
SQL开始执行时间：20190714001546

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190714001548
SQL开始执行时间：20190714001548
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190714001548
SQL开始执行时间：20190714001548
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190714001549
SQL开始执行时间：20190714001549
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190714001550
SQL开始执行时间：20190714001550
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190714001551
SQL开始执行时间：20190714001551

truncate table pdm.ar_detail
;
SQL结束执行时间：20190714001551
SQL开始执行时间：20190714001551
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190714001553
SQL开始执行时间：20190714001553

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190714001553
SQL开始执行时间：20190714001553

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190714001553

20190715001509开始执行2019-07-14数据加载日志:
SQL开始执行时间：20190715001509

use pdm
;
SQL结束执行时间：20190715001509
SQL开始执行时间：20190715001509

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190715001509
SQL开始执行时间：20190715001509
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190715001509
SQL开始执行时间：20190715001509

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190715001509
SQL开始执行时间：20190715001509
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190715001510
SQL开始执行时间：20190715001510
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190715001512
SQL开始执行时间：20190715001512
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190715001514
SQL开始执行时间：20190715001514

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190715001514
SQL开始执行时间：20190715001514
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190715001515
SQL开始执行时间：20190715001515
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190715001515
SQL开始执行时间：20190715001515


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190715001515
SQL开始执行时间：20190715001515
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190715001534
SQL开始执行时间：20190715001534


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190715001534
SQL开始执行时间：20190715001534
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190715001535
SQL开始执行时间：20190715001535

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190715001537
SQL开始执行时间：20190715001537
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190715001538
SQL开始执行时间：20190715001538
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190715001540
SQL开始执行时间：20190715001540
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190715001542
SQL开始执行时间：20190715001542

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190715001542
SQL开始执行时间：20190715001542
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190715001542
SQL开始执行时间：20190715001542

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190715001542
SQL开始执行时间：20190715001542

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190715001542
SQL开始执行时间：20190715001542
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190715001542
SQL开始执行时间：20190715001542

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190715001543
SQL开始执行时间：20190715001543

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190715001543
SQL开始执行时间：20190715001543
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190715001545
SQL开始执行时间：20190715001545

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190715001545
SQL开始执行时间：20190715001545

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190715001546
SQL开始执行时间：20190715001546




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190715001547
SQL开始执行时间：20190715001547

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190715001548
SQL开始执行时间：20190715001548
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190715001548
SQL开始执行时间：20190715001548
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190715001550
SQL开始执行时间：20190715001550
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190715001550
SQL开始执行时间：20190715001550
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190715001552
SQL开始执行时间：20190715001552

truncate table pdm.ar_detail
;
SQL结束执行时间：20190715001552
SQL开始执行时间：20190715001552
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190715001553
SQL开始执行时间：20190715001553

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190715001553
SQL开始执行时间：20190715001553

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190715001553

20190716002604开始执行2019-07-15数据加载日志:
SQL开始执行时间：20190716002604

use pdm
;
SQL结束执行时间：20190716002604
SQL开始执行时间：20190716002604

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190716002604
SQL开始执行时间：20190716002604
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190716002604
SQL开始执行时间：20190716002604

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190716002604
SQL开始执行时间：20190716002604
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190716002606
SQL开始执行时间：20190716002606
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190716002607
SQL开始执行时间：20190716002607
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190716002609
SQL开始执行时间：20190716002609

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190716002609
SQL开始执行时间：20190716002609
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190716002610
SQL开始执行时间：20190716002610
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190716002611
SQL开始执行时间：20190716002611


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190716002611
SQL开始执行时间：20190716002611
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190716002630
SQL开始执行时间：20190716002630


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190716002630
SQL开始执行时间：20190716002630
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190716002631
SQL开始执行时间：20190716002631

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190716002632
SQL开始执行时间：20190716002632
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190716002634
SQL开始执行时间：20190716002634
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190716002635
SQL开始执行时间：20190716002635
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190716002637
SQL开始执行时间：20190716002637

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190716002637
SQL开始执行时间：20190716002637
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190716002637
SQL开始执行时间：20190716002637

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190716002638
SQL开始执行时间：20190716002638

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190716002638
SQL开始执行时间：20190716002638
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190716002638
SQL开始执行时间：20190716002638

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190716002638
SQL开始执行时间：20190716002638

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190716002638
SQL开始执行时间：20190716002638
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190716002640
SQL开始执行时间：20190716002640

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190716002640
SQL开始执行时间：20190716002640

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190716002642
SQL开始执行时间：20190716002642




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190716002642
SQL开始执行时间：20190716002642

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190716002643
SQL开始执行时间：20190716002643
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190716002644
SQL开始执行时间：20190716002644
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190716002645
SQL开始执行时间：20190716002645
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190716002645
SQL开始执行时间：20190716002645
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190716002647
SQL开始执行时间：20190716002647

truncate table pdm.ar_detail
;
SQL结束执行时间：20190716002647
SQL开始执行时间：20190716002647
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190716002648
SQL开始执行时间：20190716002648

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190716002648
SQL开始执行时间：20190716002648

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190716002649

20190716155833开始执行2019-07-16数据加载日志:
SQL开始执行时间：20190716155833

use pdm
;
SQL结束执行时间：20190716155833
SQL开始执行时间：20190716155833

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190716155833
SQL开始执行时间：20190716155833
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190716155833
SQL开始执行时间：20190716155833

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190716155833
SQL开始执行时间：20190716155833
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190716155835
SQL开始执行时间：20190716155835
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190716155836
SQL开始执行时间：20190716155836
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190716155839
SQL开始执行时间：20190716155839

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190716155839
SQL开始执行时间：20190716155839
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190716155839
SQL开始执行时间：20190716155839
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190716155840
SQL开始执行时间：20190716155840


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190716155840
SQL开始执行时间：20190716155840
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190716155859
SQL开始执行时间：20190716155859


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190716155859
SQL开始执行时间：20190716155859
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190716155900
SQL开始执行时间：20190716155900

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190716155901
SQL开始执行时间：20190716155901
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190716155903
SQL开始执行时间：20190716155903
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190716155904
SQL开始执行时间：20190716155904
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190716155906
SQL开始执行时间：20190716155906

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190716155906
SQL开始执行时间：20190716155906
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190716155906
SQL开始执行时间：20190716155906

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190716155906
SQL开始执行时间：20190716155906

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190716155906
SQL开始执行时间：20190716155906
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190716155907
SQL开始执行时间：20190716155907

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190716155907
SQL开始执行时间：20190716155907

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190716155907
SQL开始执行时间：20190716155907
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190716155909
SQL开始执行时间：20190716155909

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190716155909
SQL开始执行时间：20190716155909

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190716155910
SQL开始执行时间：20190716155910




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190716155911
SQL开始执行时间：20190716155911

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190716155912
SQL开始执行时间：20190716155912
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190716155912
SQL开始执行时间：20190716155912
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190716155914
SQL开始执行时间：20190716155914
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190716155914
SQL开始执行时间：20190716155914
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190716155916
SQL开始执行时间：20190716155916

truncate table pdm.ar_detail
;
SQL结束执行时间：20190716155916
SQL开始执行时间：20190716155916
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190716155918
SQL开始执行时间：20190716155918

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190716155918
SQL开始执行时间：20190716155918

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190716155918

20190717001648开始执行2019-07-16数据加载日志:
SQL开始执行时间：20190717001648

use pdm
;
SQL结束执行时间：20190717001648
SQL开始执行时间：20190717001648

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190717001648
SQL开始执行时间：20190717001648
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190717001648
SQL开始执行时间：20190717001648

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190717001648
SQL开始执行时间：20190717001648
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190717001649
SQL开始执行时间：20190717001649
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190717001651
SQL开始执行时间：20190717001651
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190717001653
SQL开始执行时间：20190717001653

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190717001653
SQL开始执行时间：20190717001653
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190717001654
SQL开始执行时间：20190717001654
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190717001654
SQL开始执行时间：20190717001654


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190717001654
SQL开始执行时间：20190717001654
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190717001714
SQL开始执行时间：20190717001714


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190717001714
SQL开始执行时间：20190717001714
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190717001715
SQL开始执行时间：20190717001715

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190717001717
SQL开始执行时间：20190717001717
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190717001719
SQL开始执行时间：20190717001719
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190717001720
SQL开始执行时间：20190717001720
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190717001722
SQL开始执行时间：20190717001722

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190717001722
SQL开始执行时间：20190717001722
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190717001723
SQL开始执行时间：20190717001723

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190717001723
SQL开始执行时间：20190717001723

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190717001723
SQL开始执行时间：20190717001723
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190717001723
SQL开始执行时间：20190717001723

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190717001724
SQL开始执行时间：20190717001724

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190717001724
SQL开始执行时间：20190717001724
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190717001725
SQL开始执行时间：20190717001725

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190717001725
SQL开始执行时间：20190717001725

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190717001727
SQL开始执行时间：20190717001727




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190717001727
SQL开始执行时间：20190717001727

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190717001729
SQL开始执行时间：20190717001729
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190717001729
SQL开始执行时间：20190717001729
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190717001730
SQL开始执行时间：20190717001730
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190717001731
SQL开始执行时间：20190717001731
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190717001732
SQL开始执行时间：20190717001732

truncate table pdm.ar_detail
;
SQL结束执行时间：20190717001732
SQL开始执行时间：20190717001732
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190717001734
SQL开始执行时间：20190717001734

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190717001734
SQL开始执行时间：20190717001734

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190717001734

20190717085835开始执行2019-07-17数据加载日志:
SQL开始执行时间：20190717085835

use pdm
;
SQL结束执行时间：20190717085835
SQL开始执行时间：20190717085835

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190717085835
SQL开始执行时间：20190717085835
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190717085835
SQL开始执行时间：20190717085835

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190717085835
SQL开始执行时间：20190717085835
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190717085836
SQL开始执行时间：20190717085836
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190717085838
SQL开始执行时间：20190717085838
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190717085840
SQL开始执行时间：20190717085840

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190717085840
SQL开始执行时间：20190717085840
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190717085841
SQL开始执行时间：20190717085841
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190717085841
SQL开始执行时间：20190717085841


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190717085841
SQL开始执行时间：20190717085841
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190717085900
SQL开始执行时间：20190717085900


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190717085900
SQL开始执行时间：20190717085900
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190717085901
SQL开始执行时间：20190717085901

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190717085903
SQL开始执行时间：20190717085903
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190717085904
SQL开始执行时间：20190717085904
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190717085906
SQL开始执行时间：20190717085906
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190717085908
SQL开始执行时间：20190717085908

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190717085908
SQL开始执行时间：20190717085908
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190717085908
SQL开始执行时间：20190717085908

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190717085908
SQL开始执行时间：20190717085908

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190717085908
SQL开始执行时间：20190717085908
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190717085909
SQL开始执行时间：20190717085909

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190717085909
SQL开始执行时间：20190717085909

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190717085909
SQL开始执行时间：20190717085909
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190717085911
SQL开始执行时间：20190717085911

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190717085911
SQL开始执行时间：20190717085911

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190717085912
SQL开始执行时间：20190717085912




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190717085913
SQL开始执行时间：20190717085913

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190717085914
SQL开始执行时间：20190717085914
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190717085914
SQL开始执行时间：20190717085914
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190717085916
SQL开始执行时间：20190717085916
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190717085916
SQL开始执行时间：20190717085916
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190717085918
SQL开始执行时间：20190717085918

truncate table pdm.ar_detail
;
SQL结束执行时间：20190717085918
SQL开始执行时间：20190717085918
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190717085919
SQL开始执行时间：20190717085919

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190717085919
SQL开始执行时间：20190717085919

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190717085920

20190718001642开始执行2019-07-17数据加载日志:
SQL开始执行时间：20190718001642

use pdm
;
SQL结束执行时间：20190718001642
SQL开始执行时间：20190718001642

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190718001642
SQL开始执行时间：20190718001642
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190718001642
SQL开始执行时间：20190718001642

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190718001642
SQL开始执行时间：20190718001642
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190718001643
SQL开始执行时间：20190718001643
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190718001645
SQL开始执行时间：20190718001645
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190718001647
SQL开始执行时间：20190718001647

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190718001647
SQL开始执行时间：20190718001647
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190718001648
SQL开始执行时间：20190718001648
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190718001648
SQL开始执行时间：20190718001648


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190718001648
SQL开始执行时间：20190718001648
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190718001708
SQL开始执行时间：20190718001708


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190718001708
SQL开始执行时间：20190718001708
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190718001709
SQL开始执行时间：20190718001709

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190718001710
SQL开始执行时间：20190718001710
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190718001711
SQL开始执行时间：20190718001711
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190718001713
SQL开始执行时间：20190718001713
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190718001715
SQL开始执行时间：20190718001715

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190718001715
SQL开始执行时间：20190718001715
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190718001715
SQL开始执行时间：20190718001715

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190718001715
SQL开始执行时间：20190718001715

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190718001715
SQL开始执行时间：20190718001715
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190718001716
SQL开始执行时间：20190718001716

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190718001716
SQL开始执行时间：20190718001716

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190718001716
SQL开始执行时间：20190718001716
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190718001718
SQL开始执行时间：20190718001718

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190718001719
SQL开始执行时间：20190718001719




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190718001720
SQL开始执行时间：20190718001720

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190718001721
SQL开始执行时间：20190718001721
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190718001722
SQL开始执行时间：20190718001722
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190718001723
SQL开始执行时间：20190718001723
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190718001724
SQL开始执行时间：20190718001724
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190718001726
SQL开始执行时间：20190718001726

truncate table pdm.ar_detail
;
SQL结束执行时间：20190718001726
SQL开始执行时间：20190718001726
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190718001728
SQL开始执行时间：20190718001728

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190718001728
SQL开始执行时间：20190718001728

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190718001728

20190718092748开始执行2019-07-18数据加载日志:
SQL开始执行时间：20190718092748

use pdm
;
SQL结束执行时间：20190718092748
SQL开始执行时间：20190718092748

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190718092748
SQL开始执行时间：20190718092748
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190718092748
SQL开始执行时间：20190718092748

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190718092748
SQL开始执行时间：20190718092748
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190718092749
SQL开始执行时间：20190718092749
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190718092751
SQL开始执行时间：20190718092751
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190718092753
SQL开始执行时间：20190718092753

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190718092753
SQL开始执行时间：20190718092753
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190718092754
SQL开始执行时间：20190718092754
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190718092754
SQL开始执行时间：20190718092754


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190718092754
SQL开始执行时间：20190718092754
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190718092813
SQL开始执行时间：20190718092813


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190718092813
SQL开始执行时间：20190718092813
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190718092814
SQL开始执行时间：20190718092814

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190718092816
SQL开始执行时间：20190718092816
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190718092817
SQL开始执行时间：20190718092817
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190718092819
SQL开始执行时间：20190718092819
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190718092821
SQL开始执行时间：20190718092821

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190718092821
SQL开始执行时间：20190718092821
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190718092821
SQL开始执行时间：20190718092821

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190718092821
SQL开始执行时间：20190718092821

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190718092821
SQL开始执行时间：20190718092821
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190718092821
SQL开始执行时间：20190718092821

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190718092822
SQL开始执行时间：20190718092822

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190718092822
SQL开始执行时间：20190718092822
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190718092824
SQL开始执行时间：20190718092824

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190718092824
SQL开始执行时间：20190718092824

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190718092825
SQL开始执行时间：20190718092825




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190718092825
SQL开始执行时间：20190718092825

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190718092827
SQL开始执行时间：20190718092827
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190718092827
SQL开始执行时间：20190718092827
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190718092829
SQL开始执行时间：20190718092829
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190718092829
SQL开始执行时间：20190718092829
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190718092830
SQL开始执行时间：20190718092830

truncate table pdm.ar_detail
;
SQL结束执行时间：20190718092831
SQL开始执行时间：20190718092831
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190718092832
SQL开始执行时间：20190718092832

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190718092832
SQL开始执行时间：20190718092832

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190718092832

20190719001641开始执行2019-07-18数据加载日志:
SQL开始执行时间：20190719001641

use pdm
;
SQL结束执行时间：20190719001641
SQL开始执行时间：20190719001641

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190719001641
SQL开始执行时间：20190719001641
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190719001641
SQL开始执行时间：20190719001641

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190719001641
SQL开始执行时间：20190719001641
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190719001643
SQL开始执行时间：20190719001643
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190719001644
SQL开始执行时间：20190719001644
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190719001646
SQL开始执行时间：20190719001646

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190719001646
SQL开始执行时间：20190719001646
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190719001647
SQL开始执行时间：20190719001647
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190719001648
SQL开始执行时间：20190719001648


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190719001648
SQL开始执行时间：20190719001648
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190719001707
SQL开始执行时间：20190719001707


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190719001707
SQL开始执行时间：20190719001707
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190719001708
SQL开始执行时间：20190719001708

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190719001710
SQL开始执行时间：20190719001710
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190719001712
SQL开始执行时间：20190719001712
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190719001714
SQL开始执行时间：20190719001714
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190719001716
SQL开始执行时间：20190719001716

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190719001716
SQL开始执行时间：20190719001716
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190719001717
SQL开始执行时间：20190719001717

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190719001717
SQL开始执行时间：20190719001717

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190719001717
SQL开始执行时间：20190719001717
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190719001718
SQL开始执行时间：20190719001718

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190719001718
SQL开始执行时间：20190719001718

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190719001718
SQL开始执行时间：20190719001718
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190719001721
SQL开始执行时间：20190719001721

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190719001721
SQL开始执行时间：20190719001721

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190719001722
SQL开始执行时间：20190719001722




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190719001723
SQL开始执行时间：20190719001723

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190719001724
SQL开始执行时间：20190719001724
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190719001724
SQL开始执行时间：20190719001724
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190719001726
SQL开始执行时间：20190719001726
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190719001726
SQL开始执行时间：20190719001726
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190719001728
SQL开始执行时间：20190719001728

truncate table pdm.ar_detail
;
SQL结束执行时间：20190719001728
SQL开始执行时间：20190719001728
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190719001729
SQL开始执行时间：20190719001729

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190719001730
SQL开始执行时间：20190719001730

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190719001730

20190720001628开始执行2019-07-19数据加载日志:
SQL开始执行时间：20190720001628

use pdm
;
SQL结束执行时间：20190720001628
SQL开始执行时间：20190720001628

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190720001628
SQL开始执行时间：20190720001628
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190720001628
SQL开始执行时间：20190720001628

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190720001628
SQL开始执行时间：20190720001628
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190720001629
SQL开始执行时间：20190720001629
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190720001631
SQL开始执行时间：20190720001631
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190720001633
SQL开始执行时间：20190720001633

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190720001633
SQL开始执行时间：20190720001633
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190720001634
SQL开始执行时间：20190720001634
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190720001634
SQL开始执行时间：20190720001634


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190720001634
SQL开始执行时间：20190720001634
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190720001654
SQL开始执行时间：20190720001654


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190720001654
SQL开始执行时间：20190720001654
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190720001655
SQL开始执行时间：20190720001655

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190720001656
SQL开始执行时间：20190720001656
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190720001658
SQL开始执行时间：20190720001658
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190720001700
SQL开始执行时间：20190720001700
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190720001702
SQL开始执行时间：20190720001702

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190720001702
SQL开始执行时间：20190720001702
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190720001702
SQL开始执行时间：20190720001702

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190720001702
SQL开始执行时间：20190720001702

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190720001702
SQL开始执行时间：20190720001702
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190720001702
SQL开始执行时间：20190720001702

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190720001703
SQL开始执行时间：20190720001703

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190720001703
SQL开始执行时间：20190720001703
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190720001705
SQL开始执行时间：20190720001705

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190720001705
SQL开始执行时间：20190720001705

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190720001706
SQL开始执行时间：20190720001706




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190720001706
SQL开始执行时间：20190720001706

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190720001708
SQL开始执行时间：20190720001708
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190720001708
SQL开始执行时间：20190720001708
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190720001709
SQL开始执行时间：20190720001709
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190720001710
SQL开始执行时间：20190720001710
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190720001711
SQL开始执行时间：20190720001711

truncate table pdm.ar_detail
;
SQL结束执行时间：20190720001711
SQL开始执行时间：20190720001711
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190720001713
SQL开始执行时间：20190720001713

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190720001713
SQL开始执行时间：20190720001713

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190720001713

20190721001635开始执行2019-07-20数据加载日志:
SQL开始执行时间：20190721001635

use pdm
;
SQL结束执行时间：20190721001635
SQL开始执行时间：20190721001635

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190721001635
SQL开始执行时间：20190721001635
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190721001635
SQL开始执行时间：20190721001635

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190721001635
SQL开始执行时间：20190721001635
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190721001637
SQL开始执行时间：20190721001637
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190721001638
SQL开始执行时间：20190721001638
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190721001641
SQL开始执行时间：20190721001641

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190721001641
SQL开始执行时间：20190721001641
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190721001642
SQL开始执行时间：20190721001642
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190721001642
SQL开始执行时间：20190721001642


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190721001642
SQL开始执行时间：20190721001642
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190721001701
SQL开始执行时间：20190721001701


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190721001701
SQL开始执行时间：20190721001701
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190721001702
SQL开始执行时间：20190721001702

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190721001704
SQL开始执行时间：20190721001704
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190721001705
SQL开始执行时间：20190721001705
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190721001707
SQL开始执行时间：20190721001707
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190721001708
SQL开始执行时间：20190721001708

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190721001708
SQL开始执行时间：20190721001708
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190721001709
SQL开始执行时间：20190721001709

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190721001709
SQL开始执行时间：20190721001709

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190721001709
SQL开始执行时间：20190721001709
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190721001709
SQL开始执行时间：20190721001709

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190721001710
SQL开始执行时间：20190721001710

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190721001710
SQL开始执行时间：20190721001710
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190721001711
SQL开始执行时间：20190721001711

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190721001711
SQL开始执行时间：20190721001711

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190721001713
SQL开始执行时间：20190721001713




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190721001713
SQL开始执行时间：20190721001713

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190721001714
SQL开始执行时间：20190721001714
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190721001715
SQL开始执行时间：20190721001715
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190721001716
SQL开始执行时间：20190721001716
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190721001716
SQL开始执行时间：20190721001716
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190721001718
SQL开始执行时间：20190721001718

truncate table pdm.ar_detail
;
SQL结束执行时间：20190721001718
SQL开始执行时间：20190721001718
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190721001719
SQL开始执行时间：20190721001719

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190721001720
SQL开始执行时间：20190721001720

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190721001720

20190722001634开始执行2019-07-21数据加载日志:
SQL开始执行时间：20190722001634

use pdm
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190722001634
SQL开始执行时间：20190722001634
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190722001636
SQL开始执行时间：20190722001636
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190722001637
SQL开始执行时间：20190722001637
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190722001640
SQL开始执行时间：20190722001640

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190722001640
SQL开始执行时间：20190722001640
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190722001641
SQL开始执行时间：20190722001641
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190722001641
SQL开始执行时间：20190722001641


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190722001641
SQL开始执行时间：20190722001641
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190722001700
SQL开始执行时间：20190722001700


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190722001700
SQL开始执行时间：20190722001700
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190722001701
SQL开始执行时间：20190722001701

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190722001703
SQL开始执行时间：20190722001703
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190722001704
SQL开始执行时间：20190722001704
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190722001706
SQL开始执行时间：20190722001706
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190722001708
SQL开始执行时间：20190722001708

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190722001708
SQL开始执行时间：20190722001708
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190722001708
SQL开始执行时间：20190722001708

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190722001708
SQL开始执行时间：20190722001708

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190722001708
SQL开始执行时间：20190722001708
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190722001709
SQL开始执行时间：20190722001709

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190722001709
SQL开始执行时间：20190722001709

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190722001709
SQL开始执行时间：20190722001709
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190722001711
SQL开始执行时间：20190722001711

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190722001711
SQL开始执行时间：20190722001711

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190722001712
SQL开始执行时间：20190722001712




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190722001713
SQL开始执行时间：20190722001713

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190722001714
SQL开始执行时间：20190722001714
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190722001714
SQL开始执行时间：20190722001714
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190722001716
SQL开始执行时间：20190722001716
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190722001716
SQL开始执行时间：20190722001716
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190722001717
SQL开始执行时间：20190722001717

truncate table pdm.ar_detail
;
SQL结束执行时间：20190722001718
SQL开始执行时间：20190722001718
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190722001719
SQL开始执行时间：20190722001719

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190722001719
SQL开始执行时间：20190722001719

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190722001719

20190723001632开始执行2019-07-22数据加载日志:
SQL开始执行时间：20190723001632

use pdm
;
SQL结束执行时间：20190723001632
SQL开始执行时间：20190723001632

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190723001632
SQL开始执行时间：20190723001632
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190723001632
SQL开始执行时间：20190723001632

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190723001632
SQL开始执行时间：20190723001632
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190723001633
SQL开始执行时间：20190723001633
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190723001634
SQL开始执行时间：20190723001634
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190723001637
SQL开始执行时间：20190723001637
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190723001638
SQL开始执行时间：20190723001638


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190723001638
SQL开始执行时间：20190723001638
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190723001657
SQL开始执行时间：20190723001657


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190723001657
SQL开始执行时间：20190723001657
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190723001658
SQL开始执行时间：20190723001658

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190723001700
SQL开始执行时间：20190723001700
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190723001701
SQL开始执行时间：20190723001701
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190723001703
SQL开始执行时间：20190723001703
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190723001705
SQL开始执行时间：20190723001705

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190723001705
SQL开始执行时间：20190723001705
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190723001705
SQL开始执行时间：20190723001705

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190723001705
SQL开始执行时间：20190723001705

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190723001705
SQL开始执行时间：20190723001705
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190723001706
SQL开始执行时间：20190723001706

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190723001706
SQL开始执行时间：20190723001706

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190723001706
SQL开始执行时间：20190723001706
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190723001708
SQL开始执行时间：20190723001708

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190723001708
SQL开始执行时间：20190723001708

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190723001709
SQL开始执行时间：20190723001709




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190723001710
SQL开始执行时间：20190723001710

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190723001711
SQL开始执行时间：20190723001711
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190723001711
SQL开始执行时间：20190723001711
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190723001713
SQL开始执行时间：20190723001713
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190723001713
SQL开始执行时间：20190723001713
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190723001714
SQL开始执行时间：20190723001714

truncate table pdm.ar_detail
;
SQL结束执行时间：20190723001714
SQL开始执行时间：20190723001714
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190723001716
SQL开始执行时间：20190723001716

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190723001716
SQL开始执行时间：20190723001716

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190723001716

20190724001635开始执行2019-07-23数据加载日志:
SQL开始执行时间：20190724001635

use pdm
;
SQL结束执行时间：20190724001635
SQL开始执行时间：20190724001635

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190724001635
SQL开始执行时间：20190724001635
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190724001635
SQL开始执行时间：20190724001635

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190724001635
SQL开始执行时间：20190724001635
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190724001636
SQL开始执行时间：20190724001636
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190724001638
SQL开始执行时间：20190724001638
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190724001640
SQL开始执行时间：20190724001640

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190724001640
SQL开始执行时间：20190724001640
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190724001640
SQL开始执行时间：20190724001640
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190724001641
SQL开始执行时间：20190724001641


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190724001641
SQL开始执行时间：20190724001641
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190724001701
SQL开始执行时间：20190724001701
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190724001702
SQL开始执行时间：20190724001702

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190724001703
SQL开始执行时间：20190724001703
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190724001706
SQL开始执行时间：20190724001706
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190724001708
SQL开始执行时间：20190724001708
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190724001710
SQL开始执行时间：20190724001710

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190724001710
SQL开始执行时间：20190724001710
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190724001710
SQL开始执行时间：20190724001710

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190724001711
SQL开始执行时间：20190724001711

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190724001711
SQL开始执行时间：20190724001711
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190724001711
SQL开始执行时间：20190724001711

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190724001712
SQL开始执行时间：20190724001712

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190724001712
SQL开始执行时间：20190724001712
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190724001713
SQL开始执行时间：20190724001713

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190724001713
SQL开始执行时间：20190724001713

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190724001715
SQL开始执行时间：20190724001715




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190724001715
SQL开始执行时间：20190724001715

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190724001716
SQL开始执行时间：20190724001716
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190724001717
SQL开始执行时间：20190724001717
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190724001718
SQL开始执行时间：20190724001718
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190724001718
SQL开始执行时间：20190724001718
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190724001720
SQL开始执行时间：20190724001720

truncate table pdm.ar_detail
;
SQL结束执行时间：20190724001720
SQL开始执行时间：20190724001720
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190724001722
SQL开始执行时间：20190724001722

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190724001722
SQL开始执行时间：20190724001722

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190724001722

20190725001635开始执行2019-07-24数据加载日志:
SQL开始执行时间：20190725001635

use pdm
;
SQL结束执行时间：20190725001635
SQL开始执行时间：20190725001635

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190725001635
SQL开始执行时间：20190725001635
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190725001635
SQL开始执行时间：20190725001635

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190725001635
SQL开始执行时间：20190725001635
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190725001636
SQL开始执行时间：20190725001636
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190725001638
SQL开始执行时间：20190725001638
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190725001640
SQL开始执行时间：20190725001640
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190725001641
SQL开始执行时间：20190725001641
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190725001642
SQL开始执行时间：20190725001642


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190725001642
SQL开始执行时间：20190725001642
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190725001701
SQL开始执行时间：20190725001701


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190725001701
SQL开始执行时间：20190725001701
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190725001702
SQL开始执行时间：20190725001702

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190725001704
SQL开始执行时间：20190725001704
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190725001705
SQL开始执行时间：20190725001705
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190725001707
SQL开始执行时间：20190725001707
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190725001709
SQL开始执行时间：20190725001709

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190725001709
SQL开始执行时间：20190725001709
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190725001709
SQL开始执行时间：20190725001709

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190725001709
SQL开始执行时间：20190725001709

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190725001709
SQL开始执行时间：20190725001709
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190725001710
SQL开始执行时间：20190725001710

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190725001710
SQL开始执行时间：20190725001710

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190725001710
SQL开始执行时间：20190725001710
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190725001712
SQL开始执行时间：20190725001712

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190725001712
SQL开始执行时间：20190725001712

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190725001713
SQL开始执行时间：20190725001713




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190725001714
SQL开始执行时间：20190725001714

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190725001715
SQL开始执行时间：20190725001715
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190725001715
SQL开始执行时间：20190725001715
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190725001717
SQL开始执行时间：20190725001717
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190725001717
SQL开始执行时间：20190725001717
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190725001719
SQL开始执行时间：20190725001719

truncate table pdm.ar_detail
;
SQL结束执行时间：20190725001719
SQL开始执行时间：20190725001719
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190725001720
SQL开始执行时间：20190725001720

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190725001720
SQL开始执行时间：20190725001720

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190725001720

20190726001635开始执行2019-07-25数据加载日志:
SQL开始执行时间：20190726001635

use pdm
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190726001635
SQL开始执行时间：20190726001635
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190726001636
SQL开始执行时间：20190726001636
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190726001638
SQL开始执行时间：20190726001638
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190726001641
SQL开始执行时间：20190726001641

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190726001641
SQL开始执行时间：20190726001641
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190726001642
SQL开始执行时间：20190726001642
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190726001643
SQL开始执行时间：20190726001643


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190726001643
SQL开始执行时间：20190726001643
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190726001703
SQL开始执行时间：20190726001703


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190726001703
SQL开始执行时间：20190726001703
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190726001704
SQL开始执行时间：20190726001704

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190726001705
SQL开始执行时间：20190726001705
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190726001706
SQL开始执行时间：20190726001706
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190726001708
SQL开始执行时间：20190726001708
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190726001710
SQL开始执行时间：20190726001710

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190726001710
SQL开始执行时间：20190726001710
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190726001710
SQL开始执行时间：20190726001710

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190726001710
SQL开始执行时间：20190726001710

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190726001710
SQL开始执行时间：20190726001710
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190726001711
SQL开始执行时间：20190726001711

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190726001711
SQL开始执行时间：20190726001711

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190726001711
SQL开始执行时间：20190726001711
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190726001713
SQL开始执行时间：20190726001713

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190726001713
SQL开始执行时间：20190726001713

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190726001715
SQL开始执行时间：20190726001715




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190726001715
SQL开始执行时间：20190726001715

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190726001716
SQL开始执行时间：20190726001716
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190726001717
SQL开始执行时间：20190726001717
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190726001718
SQL开始执行时间：20190726001718
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190726001718
SQL开始执行时间：20190726001718
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190726001720
SQL开始执行时间：20190726001720

truncate table pdm.ar_detail
;
SQL结束执行时间：20190726001720
SQL开始执行时间：20190726001720
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190726001721
SQL开始执行时间：20190726001721

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190726001721
SQL开始执行时间：20190726001721

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190726001722

20190727001646开始执行2019-07-26数据加载日志:
SQL开始执行时间：20190727001646

use pdm
;
SQL结束执行时间：20190727001646
SQL开始执行时间：20190727001646

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190727001646
SQL开始执行时间：20190727001646
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190727001646
SQL开始执行时间：20190727001646

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190727001646
SQL开始执行时间：20190727001646
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190727001647
SQL开始执行时间：20190727001647
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190727001649
SQL开始执行时间：20190727001649
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190727001651
SQL开始执行时间：20190727001651

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190727001651
SQL开始执行时间：20190727001651
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190727001652
SQL开始执行时间：20190727001652
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190727001653
SQL开始执行时间：20190727001653
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190727001713
SQL开始执行时间：20190727001713


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190727001713
SQL开始执行时间：20190727001713
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190727001714
SQL开始执行时间：20190727001714

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190727001716
SQL开始执行时间：20190727001716
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190727001718
SQL开始执行时间：20190727001718
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190727001720
SQL开始执行时间：20190727001720
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190727001722
SQL开始执行时间：20190727001722

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190727001722
SQL开始执行时间：20190727001722
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190727001722
SQL开始执行时间：20190727001722

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190727001722
SQL开始执行时间：20190727001722

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190727001722
SQL开始执行时间：20190727001722
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190727001723
SQL开始执行时间：20190727001723

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190727001723
SQL开始执行时间：20190727001723

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190727001723
SQL开始执行时间：20190727001723
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190727001725
SQL开始执行时间：20190727001725

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190727001725
SQL开始执行时间：20190727001725

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190727001726
SQL开始执行时间：20190727001726




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190727001727
SQL开始执行时间：20190727001727

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190727001728
SQL开始执行时间：20190727001728
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190727001728
SQL开始执行时间：20190727001728
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190727001730
SQL开始执行时间：20190727001730
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190727001730
SQL开始执行时间：20190727001730
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190727001732
SQL开始执行时间：20190727001732

truncate table pdm.ar_detail
;
SQL结束执行时间：20190727001732
SQL开始执行时间：20190727001732
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190727001733
SQL开始执行时间：20190727001733

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190727001733
SQL开始执行时间：20190727001733

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190727001734

20190728001646开始执行2019-07-27数据加载日志:
SQL开始执行时间：20190728001646

use pdm
;
SQL结束执行时间：20190728001646
SQL开始执行时间：20190728001646

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190728001646
SQL开始执行时间：20190728001646
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190728001646
SQL开始执行时间：20190728001646

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190728001646
SQL开始执行时间：20190728001646
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190728001648
SQL开始执行时间：20190728001648
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190728001651
SQL开始执行时间：20190728001651
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190728001653
SQL开始执行时间：20190728001653

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190728001653
SQL开始执行时间：20190728001653
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190728001654
SQL开始执行时间：20190728001654
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190728001655
SQL开始执行时间：20190728001655


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190728001655
SQL开始执行时间：20190728001655
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190728001715
SQL开始执行时间：20190728001715


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190728001715
SQL开始执行时间：20190728001715
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190728001716
SQL开始执行时间：20190728001716

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190728001717
SQL开始执行时间：20190728001717
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190728001719
SQL开始执行时间：20190728001719
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190728001720
SQL开始执行时间：20190728001720
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190728001722
SQL开始执行时间：20190728001722

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190728001722
SQL开始执行时间：20190728001722
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190728001722
SQL开始执行时间：20190728001722

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190728001723
SQL开始执行时间：20190728001723

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190728001723
SQL开始执行时间：20190728001723
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190728001723
SQL开始执行时间：20190728001723

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190728001724
SQL开始执行时间：20190728001724

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190728001724
SQL开始执行时间：20190728001724
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190728001725
SQL开始执行时间：20190728001725

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190728001725
SQL开始执行时间：20190728001725

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190728001727
SQL开始执行时间：20190728001727




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190728001727
SQL开始执行时间：20190728001727

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190728001729
SQL开始执行时间：20190728001729
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190728001729
SQL开始执行时间：20190728001729
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190728001730
SQL开始执行时间：20190728001730
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190728001730
SQL开始执行时间：20190728001730
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190728001732
SQL开始执行时间：20190728001732

truncate table pdm.ar_detail
;
SQL结束执行时间：20190728001732
SQL开始执行时间：20190728001732
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190728001734
SQL开始执行时间：20190728001734

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190728001734
SQL开始执行时间：20190728001734

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190728001734

20190729001643开始执行2019-07-28数据加载日志:
SQL开始执行时间：20190729001643

use pdm
;
SQL结束执行时间：20190729001643
SQL开始执行时间：20190729001643

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190729001643
SQL开始执行时间：20190729001643
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190729001643
SQL开始执行时间：20190729001643

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190729001643
SQL开始执行时间：20190729001643
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190729001645
SQL开始执行时间：20190729001645
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190729001647
SQL开始执行时间：20190729001647
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190729001650
SQL开始执行时间：20190729001650

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190729001650
SQL开始执行时间：20190729001650
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190729001651
SQL开始执行时间：20190729001651
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190729001652
SQL开始执行时间：20190729001652


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190729001652
SQL开始执行时间：20190729001652
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190729001712
SQL开始执行时间：20190729001712


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190729001712
SQL开始执行时间：20190729001712
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190729001713
SQL开始执行时间：20190729001713

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190729001714
SQL开始执行时间：20190729001714
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190729001716
SQL开始执行时间：20190729001716
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190729001717
SQL开始执行时间：20190729001717
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190729001719
SQL开始执行时间：20190729001719

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190729001719
SQL开始执行时间：20190729001719
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190729001719
SQL开始执行时间：20190729001719

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190729001720
SQL开始执行时间：20190729001720

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190729001720
SQL开始执行时间：20190729001720
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190729001720
SQL开始执行时间：20190729001720

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190729001720
SQL开始执行时间：20190729001720

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190729001720
SQL开始执行时间：20190729001720
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190729001722
SQL开始执行时间：20190729001722

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190729001722
SQL开始执行时间：20190729001722

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190729001724
SQL开始执行时间：20190729001724




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190729001724
SQL开始执行时间：20190729001724

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190729001725
SQL开始执行时间：20190729001725
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190729001726
SQL开始执行时间：20190729001726
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190729001727
SQL开始执行时间：20190729001727
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190729001727
SQL开始执行时间：20190729001727
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190729001729
SQL开始执行时间：20190729001729

truncate table pdm.ar_detail
;
SQL结束执行时间：20190729001729
SQL开始执行时间：20190729001729
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190729001731
SQL开始执行时间：20190729001731

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190729001731
SQL开始执行时间：20190729001731

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190729001731

20190730001720开始执行2019-07-29数据加载日志:
SQL开始执行时间：20190730001720

use pdm
;
SQL结束执行时间：20190730001720
SQL开始执行时间：20190730001720

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190730001720
SQL开始执行时间：20190730001720
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190730001720
SQL开始执行时间：20190730001720

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190730001720
SQL开始执行时间：20190730001720
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190730001722
SQL开始执行时间：20190730001722
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190730001724
SQL开始执行时间：20190730001724
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190730001726
SQL开始执行时间：20190730001726

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190730001726
SQL开始执行时间：20190730001726
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190730001727
SQL开始执行时间：20190730001727
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190730001728
SQL开始执行时间：20190730001728


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190730001728
SQL开始执行时间：20190730001728
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190730001748
SQL开始执行时间：20190730001748


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190730001748
SQL开始执行时间：20190730001748
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190730001749
SQL开始执行时间：20190730001749

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190730001751
SQL开始执行时间：20190730001751
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190730001752
SQL开始执行时间：20190730001752
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190730001754
SQL开始执行时间：20190730001754
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190730001756
SQL开始执行时间：20190730001756

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190730001756
SQL开始执行时间：20190730001756
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190730001756
SQL开始执行时间：20190730001756

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190730001756
SQL开始执行时间：20190730001756

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190730001756
SQL开始执行时间：20190730001756
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190730001756
SQL开始执行时间：20190730001756

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190730001757
SQL开始执行时间：20190730001757

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190730001757
SQL开始执行时间：20190730001757
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190730001758
SQL开始执行时间：20190730001758

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190730001759
SQL开始执行时间：20190730001759

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190730001800
SQL开始执行时间：20190730001800




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190730001800
SQL开始执行时间：20190730001800

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190730001802
SQL开始执行时间：20190730001802
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190730001802
SQL开始执行时间：20190730001802
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190730001803
SQL开始执行时间：20190730001803
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190730001804
SQL开始执行时间：20190730001804
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190730001805
SQL开始执行时间：20190730001805

truncate table pdm.ar_detail
;
SQL结束执行时间：20190730001805
SQL开始执行时间：20190730001805
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190730001807
SQL开始执行时间：20190730001807

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190730001807
SQL开始执行时间：20190730001807

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190730001807

20190731001706开始执行2019-07-30数据加载日志:
SQL开始执行时间：20190731001706

use pdm
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190731001706
SQL开始执行时间：20190731001706
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190731001708
SQL开始执行时间：20190731001708
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190731001710
SQL开始执行时间：20190731001710
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190731001713
SQL开始执行时间：20190731001713

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190731001713
SQL开始执行时间：20190731001713
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190731001714
SQL开始执行时间：20190731001714
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190731001715
SQL开始执行时间：20190731001715


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190731001715
SQL开始执行时间：20190731001715
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190731001733
SQL开始执行时间：20190731001733


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190731001733
SQL开始执行时间：20190731001733
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190731001734
SQL开始执行时间：20190731001734

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190731001736
SQL开始执行时间：20190731001736
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190731001737
SQL开始执行时间：20190731001737
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190731001739
SQL开始执行时间：20190731001739
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190731001741
SQL开始执行时间：20190731001741

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190731001741
SQL开始执行时间：20190731001741
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190731001741
SQL开始执行时间：20190731001741

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190731001741
SQL开始执行时间：20190731001741

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190731001741
SQL开始执行时间：20190731001741
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190731001742
SQL开始执行时间：20190731001742

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190731001742
SQL开始执行时间：20190731001742

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190731001742
SQL开始执行时间：20190731001742
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190731001744
SQL开始执行时间：20190731001744

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190731001744
SQL开始执行时间：20190731001744

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190731001745
SQL开始执行时间：20190731001745




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190731001746
SQL开始执行时间：20190731001746

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190731001747
SQL开始执行时间：20190731001747
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190731001747
SQL开始执行时间：20190731001747
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190731001749
SQL开始执行时间：20190731001749
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190731001749
SQL开始执行时间：20190731001749
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190731001750
SQL开始执行时间：20190731001750

truncate table pdm.ar_detail
;
SQL结束执行时间：20190731001750
SQL开始执行时间：20190731001750
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190731001752
SQL开始执行时间：20190731001752

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190731001752
SQL开始执行时间：20190731001752

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190731001752

20190801001642开始执行2019-07-31数据加载日志:
SQL开始执行时间：20190801001642

use pdm
;
SQL结束执行时间：20190801001642
SQL开始执行时间：20190801001642

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190801001642
SQL开始执行时间：20190801001642
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190801001642
SQL开始执行时间：20190801001642

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190801001642
SQL开始执行时间：20190801001642
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190801001644
SQL开始执行时间：20190801001644
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190801001645
SQL开始执行时间：20190801001645
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190801001647
SQL开始执行时间：20190801001647

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190801001647
SQL开始执行时间：20190801001647
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190801001648
SQL开始执行时间：20190801001648
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190801001649
SQL开始执行时间：20190801001649
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190801001706
SQL开始执行时间：20190801001706


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190801001706
SQL开始执行时间：20190801001706
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190801001707
SQL开始执行时间：20190801001707

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190801001709
SQL开始执行时间：20190801001709
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190801001711
SQL开始执行时间：20190801001711
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190801001713
SQL开始执行时间：20190801001713
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190801001715
SQL开始执行时间：20190801001715

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190801001715
SQL开始执行时间：20190801001715
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190801001716
SQL开始执行时间：20190801001716

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190801001716
SQL开始执行时间：20190801001716

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190801001716
SQL开始执行时间：20190801001716
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190801001716
SQL开始执行时间：20190801001716

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190801001717
SQL开始执行时间：20190801001717

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190801001717
SQL开始执行时间：20190801001717
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190801001719
SQL开始执行时间：20190801001719

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190801001719
SQL开始执行时间：20190801001719

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190801001720
SQL开始执行时间：20190801001720




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190801001721
SQL开始执行时间：20190801001721

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190801001722
SQL开始执行时间：20190801001722
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190801001722
SQL开始执行时间：20190801001722
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190801001724
SQL开始执行时间：20190801001724
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190801001724
SQL开始执行时间：20190801001724
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190801001726
SQL开始执行时间：20190801001726

truncate table pdm.ar_detail
;
SQL结束执行时间：20190801001726
SQL开始执行时间：20190801001726
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190801001727
SQL开始执行时间：20190801001727

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190801001727
SQL开始执行时间：20190801001727

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190801001727

20190802001701开始执行2019-08-01数据加载日志:
SQL开始执行时间：20190802001701

use pdm
;
SQL结束执行时间：20190802001701
SQL开始执行时间：20190802001701

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190802001701
SQL开始执行时间：20190802001701
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190802001701
SQL开始执行时间：20190802001701

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190802001701
SQL开始执行时间：20190802001701
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190802001703
SQL开始执行时间：20190802001703
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190802001704
SQL开始执行时间：20190802001704
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190802001708
SQL开始执行时间：20190802001708

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190802001708
SQL开始执行时间：20190802001708
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190802001709
SQL开始执行时间：20190802001709
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190802001710
SQL开始执行时间：20190802001710


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190802001710
SQL开始执行时间：20190802001710
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190802001727
SQL开始执行时间：20190802001727


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190802001727
SQL开始执行时间：20190802001727
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190802001729
SQL开始执行时间：20190802001729

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190802001730
SQL开始执行时间：20190802001730
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190802001732
SQL开始执行时间：20190802001732
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190802001733
SQL开始执行时间：20190802001733
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190802001735
SQL开始执行时间：20190802001735

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190802001735
SQL开始执行时间：20190802001735
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190802001735
SQL开始执行时间：20190802001735

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190802001736
SQL开始执行时间：20190802001736

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190802001736
SQL开始执行时间：20190802001736
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190802001736
SQL开始执行时间：20190802001736

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190802001737
SQL开始执行时间：20190802001737

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190802001737
SQL开始执行时间：20190802001737
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190802001738
SQL开始执行时间：20190802001738

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190802001739
SQL开始执行时间：20190802001739

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190802001740
SQL开始执行时间：20190802001740




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190802001740
SQL开始执行时间：20190802001740

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190802001742
SQL开始执行时间：20190802001742
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190802001742
SQL开始执行时间：20190802001742
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190802001743
SQL开始执行时间：20190802001743
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190802001744
SQL开始执行时间：20190802001744
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190802001745
SQL开始执行时间：20190802001745

truncate table pdm.ar_detail
;
SQL结束执行时间：20190802001745
SQL开始执行时间：20190802001745
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190802001747
SQL开始执行时间：20190802001747

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190802001747
SQL开始执行时间：20190802001747

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190802001747

20190803001718开始执行2019-08-02数据加载日志:
SQL开始执行时间：20190803001718

use pdm
;
SQL结束执行时间：20190803001718
SQL开始执行时间：20190803001718

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190803001718
SQL开始执行时间：20190803001718
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190803001718
SQL开始执行时间：20190803001718

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190803001718
SQL开始执行时间：20190803001718
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190803001720
SQL开始执行时间：20190803001720
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190803001722
SQL开始执行时间：20190803001722
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190803001726
SQL开始执行时间：20190803001726

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190803001726
SQL开始执行时间：20190803001726
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190803001727
SQL开始执行时间：20190803001727
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190803001728
SQL开始执行时间：20190803001728


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190803001728
SQL开始执行时间：20190803001728
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190803001746
SQL开始执行时间：20190803001746


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190803001746
SQL开始执行时间：20190803001746
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190803001747
SQL开始执行时间：20190803001747

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190803001749
SQL开始执行时间：20190803001749
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190803001750
SQL开始执行时间：20190803001750
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190803001752
SQL开始执行时间：20190803001752
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190803001754
SQL开始执行时间：20190803001754

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190803001754
SQL开始执行时间：20190803001754
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190803001754
SQL开始执行时间：20190803001754

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190803001754
SQL开始执行时间：20190803001754

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190803001754
SQL开始执行时间：20190803001754
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190803001755
SQL开始执行时间：20190803001755

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190803001755
SQL开始执行时间：20190803001755

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190803001755
SQL开始执行时间：20190803001755
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190803001757
SQL开始执行时间：20190803001757

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190803001757
SQL开始执行时间：20190803001757

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190803001759
SQL开始执行时间：20190803001759




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190803001759
SQL开始执行时间：20190803001759

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190803001800
SQL开始执行时间：20190803001800
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190803001801
SQL开始执行时间：20190803001801
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190803001802
SQL开始执行时间：20190803001802
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190803001802
SQL开始执行时间：20190803001802
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190803001804
SQL开始执行时间：20190803001804

truncate table pdm.ar_detail
;
SQL结束执行时间：20190803001804
SQL开始执行时间：20190803001804
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190803001806
SQL开始执行时间：20190803001806

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190803001806
SQL开始执行时间：20190803001806

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190803001806

20190804001709开始执行2019-08-03数据加载日志:
SQL开始执行时间：20190804001709

use pdm
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190804001709
SQL开始执行时间：20190804001709
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190804001711
SQL开始执行时间：20190804001711
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190804001713
SQL开始执行时间：20190804001713
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190804001716
SQL开始执行时间：20190804001716

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190804001716
SQL开始执行时间：20190804001716
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190804001717
SQL开始执行时间：20190804001717
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190804001718
SQL开始执行时间：20190804001718


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190804001718
SQL开始执行时间：20190804001718
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190804001737
SQL开始执行时间：20190804001737


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190804001737
SQL开始执行时间：20190804001737
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190804001738
SQL开始执行时间：20190804001738

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190804001739
SQL开始执行时间：20190804001739
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190804001741
SQL开始执行时间：20190804001741
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190804001742
SQL开始执行时间：20190804001742
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190804001744
SQL开始执行时间：20190804001744

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190804001744
SQL开始执行时间：20190804001744
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190804001744
SQL开始执行时间：20190804001744

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190804001745
SQL开始执行时间：20190804001745

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190804001745
SQL开始执行时间：20190804001745
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190804001745
SQL开始执行时间：20190804001745

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190804001746
SQL开始执行时间：20190804001746

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190804001746
SQL开始执行时间：20190804001746
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190804001747
SQL开始执行时间：20190804001747

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190804001747
SQL开始执行时间：20190804001747

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190804001749
SQL开始执行时间：20190804001749




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190804001749
SQL开始执行时间：20190804001749

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190804001751
SQL开始执行时间：20190804001751
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190804001751
SQL开始执行时间：20190804001751
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190804001752
SQL开始执行时间：20190804001752
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190804001753
SQL开始执行时间：20190804001753
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190804001754
SQL开始执行时间：20190804001754

truncate table pdm.ar_detail
;
SQL结束执行时间：20190804001754
SQL开始执行时间：20190804001754
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190804001756
SQL开始执行时间：20190804001756

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190804001756
SQL开始执行时间：20190804001756

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190804001756

20190805001712开始执行2019-08-04数据加载日志:
SQL开始执行时间：20190805001712

use pdm
;
SQL结束执行时间：20190805001712
SQL开始执行时间：20190805001712

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190805001712
SQL开始执行时间：20190805001712
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190805001712
SQL开始执行时间：20190805001712

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190805001712
SQL开始执行时间：20190805001712
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190805001714
SQL开始执行时间：20190805001714
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190805001717
SQL开始执行时间：20190805001717
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190805001720
SQL开始执行时间：20190805001720

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190805001720
SQL开始执行时间：20190805001720
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190805001721
SQL开始执行时间：20190805001721
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190805001721
SQL开始执行时间：20190805001721


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190805001721
SQL开始执行时间：20190805001721
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190805001740
SQL开始执行时间：20190805001740


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190805001740
SQL开始执行时间：20190805001740
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190805001741
SQL开始执行时间：20190805001741

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190805001742
SQL开始执行时间：20190805001742
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190805001744
SQL开始执行时间：20190805001744
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190805001745
SQL开始执行时间：20190805001745
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190805001747
SQL开始执行时间：20190805001747

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190805001747
SQL开始执行时间：20190805001747
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190805001748
SQL开始执行时间：20190805001748

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190805001748
SQL开始执行时间：20190805001748

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190805001748
SQL开始执行时间：20190805001748
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190805001748
SQL开始执行时间：20190805001748

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190805001749
SQL开始执行时间：20190805001749

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190805001749
SQL开始执行时间：20190805001749
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190805001751
SQL开始执行时间：20190805001751

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190805001751
SQL开始执行时间：20190805001751

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190805001752
SQL开始执行时间：20190805001752




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190805001753
SQL开始执行时间：20190805001753

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190805001754
SQL开始执行时间：20190805001754
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190805001754
SQL开始执行时间：20190805001754
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190805001755
SQL开始执行时间：20190805001755
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190805001756
SQL开始执行时间：20190805001756
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190805001757
SQL开始执行时间：20190805001757

truncate table pdm.ar_detail
;
SQL结束执行时间：20190805001757
SQL开始执行时间：20190805001757
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190805001759
SQL开始执行时间：20190805001759

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190805001759
SQL开始执行时间：20190805001759

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190805001759

20190806001653开始执行2019-08-05数据加载日志:
SQL开始执行时间：20190806001653

use pdm
;
SQL结束执行时间：20190806001653
SQL开始执行时间：20190806001653

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190806001653
SQL开始执行时间：20190806001653
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190806001653
SQL开始执行时间：20190806001653

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190806001653
SQL开始执行时间：20190806001653
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190806001655
SQL开始执行时间：20190806001655
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190806001657
SQL开始执行时间：20190806001657
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190806001700
SQL开始执行时间：20190806001700

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190806001700
SQL开始执行时间：20190806001700
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190806001701
SQL开始执行时间：20190806001701
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190806001702
SQL开始执行时间：20190806001702
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190806001719
SQL开始执行时间：20190806001719


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190806001719
SQL开始执行时间：20190806001719
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190806001720
SQL开始执行时间：20190806001720

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190806001722
SQL开始执行时间：20190806001722
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190806001723
SQL开始执行时间：20190806001723
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190806001725
SQL开始执行时间：20190806001725
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190806001727
SQL开始执行时间：20190806001727

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190806001727
SQL开始执行时间：20190806001727
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190806001727
SQL开始执行时间：20190806001727

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190806001727
SQL开始执行时间：20190806001727

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190806001727
SQL开始执行时间：20190806001727
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190806001728
SQL开始执行时间：20190806001728

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190806001728
SQL开始执行时间：20190806001728

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190806001728
SQL开始执行时间：20190806001728
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190806001730
SQL开始执行时间：20190806001730

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190806001730
SQL开始执行时间：20190806001730

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190806001732
SQL开始执行时间：20190806001732




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190806001732
SQL开始执行时间：20190806001732

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190806001733
SQL开始执行时间：20190806001733
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190806001734
SQL开始执行时间：20190806001734
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190806001735
SQL开始执行时间：20190806001735
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190806001735
SQL开始执行时间：20190806001735
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190806001737
SQL开始执行时间：20190806001737

truncate table pdm.ar_detail
;
SQL结束执行时间：20190806001737
SQL开始执行时间：20190806001737
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190806001739
SQL开始执行时间：20190806001739

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190806001739
SQL开始执行时间：20190806001739

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190806001739

20190806094126开始执行2019-08-06数据加载日志:
SQL开始执行时间：20190806094126

use pdm
;
SQL结束执行时间：20190806094126
SQL开始执行时间：20190806094126

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190806094126
SQL开始执行时间：20190806094126
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190806094126
SQL开始执行时间：20190806094126

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190806094126
SQL开始执行时间：20190806094126
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190806094127
SQL开始执行时间：20190806094127
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190806094129
SQL开始执行时间：20190806094129
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190806094131
SQL开始执行时间：20190806094131

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190806094131
SQL开始执行时间：20190806094131
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190806094132
SQL开始执行时间：20190806094132
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190806094132
SQL开始执行时间：20190806094132


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190806094132
SQL开始执行时间：20190806094132
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190806094149
SQL开始执行时间：20190806094149


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190806094149
SQL开始执行时间：20190806094149
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190806094150
SQL开始执行时间：20190806094150

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190806094152
SQL开始执行时间：20190806094152
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190806094153
SQL开始执行时间：20190806094153
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190806094155
SQL开始执行时间：20190806094155
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190806094157
SQL开始执行时间：20190806094157

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190806094157
SQL开始执行时间：20190806094157
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190806094157
SQL开始执行时间：20190806094157

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190806094157
SQL开始执行时间：20190806094157

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190806094157
SQL开始执行时间：20190806094157
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190806094158
SQL开始执行时间：20190806094158

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190806094158
SQL开始执行时间：20190806094158

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190806094158
SQL开始执行时间：20190806094158
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190806094200
SQL开始执行时间：20190806094200

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190806094200
SQL开始执行时间：20190806094200

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190806094202
SQL开始执行时间：20190806094202




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190806094202
SQL开始执行时间：20190806094202

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190806094203
SQL开始执行时间：20190806094203
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190806094204
SQL开始执行时间：20190806094204
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190806094205
SQL开始执行时间：20190806094205
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190806094205
SQL开始执行时间：20190806094205
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190806094207
SQL开始执行时间：20190806094207

truncate table pdm.ar_detail
;
SQL结束执行时间：20190806094207
SQL开始执行时间：20190806094207
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190806094209
SQL开始执行时间：20190806094209

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190806094209
SQL开始执行时间：20190806094209

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190806094209

20190807001649开始执行2019-08-06数据加载日志:
SQL开始执行时间：20190807001649

use pdm
;
SQL结束执行时间：20190807001649
SQL开始执行时间：20190807001649

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190807001649
SQL开始执行时间：20190807001649
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190807001649
SQL开始执行时间：20190807001649

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190807001649
SQL开始执行时间：20190807001649
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190807001650
SQL开始执行时间：20190807001650
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190807001652
SQL开始执行时间：20190807001652
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190807001654
SQL开始执行时间：20190807001654

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190807001654
SQL开始执行时间：20190807001654
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190807001655
SQL开始执行时间：20190807001655
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190807001656
SQL开始执行时间：20190807001656


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190807001656
SQL开始执行时间：20190807001656
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190807001714
SQL开始执行时间：20190807001714


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190807001714
SQL开始执行时间：20190807001714
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190807001715
SQL开始执行时间：20190807001715

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190807001716
SQL开始执行时间：20190807001716
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190807001717
SQL开始执行时间：20190807001717
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190807001719
SQL开始执行时间：20190807001719
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190807001722
SQL开始执行时间：20190807001722

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190807001722
SQL开始执行时间：20190807001722
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190807001722
SQL开始执行时间：20190807001722

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190807001723
SQL开始执行时间：20190807001723

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190807001723
SQL开始执行时间：20190807001723
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190807001723
SQL开始执行时间：20190807001723

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190807001724
SQL开始执行时间：20190807001724

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190807001724
SQL开始执行时间：20190807001724
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190807001726
SQL开始执行时间：20190807001726

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190807001726
SQL开始执行时间：20190807001726

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190807001728
SQL开始执行时间：20190807001728




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190807001729
SQL开始执行时间：20190807001729

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190807001731
SQL开始执行时间：20190807001731
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190807001731
SQL开始执行时间：20190807001731
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190807001733
SQL开始执行时间：20190807001733
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190807001734
SQL开始执行时间：20190807001734
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190807001736
SQL开始执行时间：20190807001736

truncate table pdm.ar_detail
;
SQL结束执行时间：20190807001736
SQL开始执行时间：20190807001736
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190807001738
SQL开始执行时间：20190807001738

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190807001738
SQL开始执行时间：20190807001738

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190807001739

20190808001649开始执行2019-08-07数据加载日志:
SQL开始执行时间：20190808001649

use pdm
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190808001649
SQL开始执行时间：20190808001649
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190808001651
SQL开始执行时间：20190808001651
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190808001653
SQL开始执行时间：20190808001653
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190808001656
SQL开始执行时间：20190808001656

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190808001656
SQL开始执行时间：20190808001656
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190808001657
SQL开始执行时间：20190808001657
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190808001658
SQL开始执行时间：20190808001658


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190808001658
SQL开始执行时间：20190808001658
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190808001716
SQL开始执行时间：20190808001716


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190808001716
SQL开始执行时间：20190808001716
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190808001717
SQL开始执行时间：20190808001717

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190808001718
SQL开始执行时间：20190808001718
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190808001720
SQL开始执行时间：20190808001720
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190808001722
SQL开始执行时间：20190808001722
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190808001724
SQL开始执行时间：20190808001724

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190808001724
SQL开始执行时间：20190808001724
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190808001724
SQL开始执行时间：20190808001724

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190808001724
SQL开始执行时间：20190808001724

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190808001724
SQL开始执行时间：20190808001724
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190808001724
SQL开始执行时间：20190808001724

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190808001725
SQL开始执行时间：20190808001725

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190808001725
SQL开始执行时间：20190808001725
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190808001727
SQL开始执行时间：20190808001727

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190808001727
SQL开始执行时间：20190808001727

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190808001728
SQL开始执行时间：20190808001728




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190808001729
SQL开始执行时间：20190808001729

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190808001730
SQL开始执行时间：20190808001730
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190808001730
SQL开始执行时间：20190808001730
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190808001732
SQL开始执行时间：20190808001732
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190808001732
SQL开始执行时间：20190808001732
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190808001734
SQL开始执行时间：20190808001734

truncate table pdm.ar_detail
;
SQL结束执行时间：20190808001734
SQL开始执行时间：20190808001734
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190808001735
SQL开始执行时间：20190808001735

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190808001735
SQL开始执行时间：20190808001735

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190808001736

20190809001655开始执行2019-08-08数据加载日志:
SQL开始执行时间：20190809001655

use pdm
;
SQL结束执行时间：20190809001655
SQL开始执行时间：20190809001655

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190809001655
SQL开始执行时间：20190809001655
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190809001655
SQL开始执行时间：20190809001655

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190809001655
SQL开始执行时间：20190809001655
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190809001656
SQL开始执行时间：20190809001656
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190809001658
SQL开始执行时间：20190809001658
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190809001700
SQL开始执行时间：20190809001700

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190809001700
SQL开始执行时间：20190809001700
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190809001701
SQL开始执行时间：20190809001701
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190809001701
SQL开始执行时间：20190809001701


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190809001701
SQL开始执行时间：20190809001701
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190809001719
SQL开始执行时间：20190809001719


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190809001719
SQL开始执行时间：20190809001719
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190809001720
SQL开始执行时间：20190809001720

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190809001722
SQL开始执行时间：20190809001722
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190809001724
SQL开始执行时间：20190809001724
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190809001726
SQL开始执行时间：20190809001726
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190809001728
SQL开始执行时间：20190809001728

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190809001728
SQL开始执行时间：20190809001728
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190809001728
SQL开始执行时间：20190809001728

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190809001729
SQL开始执行时间：20190809001729

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190809001729
SQL开始执行时间：20190809001729
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190809001729
SQL开始执行时间：20190809001729

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190809001730
SQL开始执行时间：20190809001730

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190809001730
SQL开始执行时间：20190809001730
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190809001732
SQL开始执行时间：20190809001732

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190809001732
SQL开始执行时间：20190809001732

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190809001734
SQL开始执行时间：20190809001734




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190809001734
SQL开始执行时间：20190809001734

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190809001735
SQL开始执行时间：20190809001735
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190809001736
SQL开始执行时间：20190809001736
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190809001737
SQL开始执行时间：20190809001737
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190809001738
SQL开始执行时间：20190809001738
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190809001739
SQL开始执行时间：20190809001739

truncate table pdm.ar_detail
;
SQL结束执行时间：20190809001739
SQL开始执行时间：20190809001739
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190809001741
SQL开始执行时间：20190809001741

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190809001741
SQL开始执行时间：20190809001741

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190809001741

20190810001715开始执行2019-08-09数据加载日志:
SQL开始执行时间：20190810001715

use pdm
;
SQL结束执行时间：20190810001715
SQL开始执行时间：20190810001715

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190810001715
SQL开始执行时间：20190810001715
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190810001715
SQL开始执行时间：20190810001715

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190810001715
SQL开始执行时间：20190810001715
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190810001716
SQL开始执行时间：20190810001716
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190810001718
SQL开始执行时间：20190810001718
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190810001720
SQL开始执行时间：20190810001720

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190810001720
SQL开始执行时间：20190810001720
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190810001721
SQL开始执行时间：20190810001721
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190810001721
SQL开始执行时间：20190810001721


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190810001721
SQL开始执行时间：20190810001721
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190810001740
SQL开始执行时间：20190810001740


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190810001740
SQL开始执行时间：20190810001740
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190810001740
SQL开始执行时间：20190810001740

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190810001742
SQL开始执行时间：20190810001742
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190810001743
SQL开始执行时间：20190810001743
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190810001745
SQL开始执行时间：20190810001745
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190810001747
SQL开始执行时间：20190810001747

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190810001747
SQL开始执行时间：20190810001747
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190810001747
SQL开始执行时间：20190810001747

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190810001747
SQL开始执行时间：20190810001747

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190810001747
SQL开始执行时间：20190810001747
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190810001748
SQL开始执行时间：20190810001748

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190810001748
SQL开始执行时间：20190810001748

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190810001748
SQL开始执行时间：20190810001748
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190810001750
SQL开始执行时间：20190810001750

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190810001750
SQL开始执行时间：20190810001750

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190810001752
SQL开始执行时间：20190810001752




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190810001752
SQL开始执行时间：20190810001752

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190810001753
SQL开始执行时间：20190810001753
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190810001754
SQL开始执行时间：20190810001754
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190810001755
SQL开始执行时间：20190810001755
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190810001755
SQL开始执行时间：20190810001755
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190810001757
SQL开始执行时间：20190810001757

truncate table pdm.ar_detail
;
SQL结束执行时间：20190810001757
SQL开始执行时间：20190810001757
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190810001759
SQL开始执行时间：20190810001759

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190810001759
SQL开始执行时间：20190810001759

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190810001759

20190811001544开始执行2019-08-10数据加载日志:
SQL开始执行时间：20190811001544

use pdm
;
SQL结束执行时间：20190811001544
SQL开始执行时间：20190811001544

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190811001544
SQL开始执行时间：20190811001544
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190811001544
SQL开始执行时间：20190811001544

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190811001544
SQL开始执行时间：20190811001544
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190811001545
SQL开始执行时间：20190811001545
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190811001547
SQL开始执行时间：20190811001547
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190811001549
SQL开始执行时间：20190811001549

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190811001549
SQL开始执行时间：20190811001549
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190811001550
SQL开始执行时间：20190811001550
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190811001551
SQL开始执行时间：20190811001551


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190811001551
SQL开始执行时间：20190811001551
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190811001608
SQL开始执行时间：20190811001608


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190811001608
SQL开始执行时间：20190811001608
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190811001609
SQL开始执行时间：20190811001609

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190811001611
SQL开始执行时间：20190811001611
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190811001612
SQL开始执行时间：20190811001612
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190811001614
SQL开始执行时间：20190811001614
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190811001616
SQL开始执行时间：20190811001616

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190811001616
SQL开始执行时间：20190811001616
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190811001616
SQL开始执行时间：20190811001616

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190811001616
SQL开始执行时间：20190811001616

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190811001616
SQL开始执行时间：20190811001616
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190811001617
SQL开始执行时间：20190811001617

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190811001617
SQL开始执行时间：20190811001617

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190811001617
SQL开始执行时间：20190811001617
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190811001619
SQL开始执行时间：20190811001619

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190811001619
SQL开始执行时间：20190811001619

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190811001620
SQL开始执行时间：20190811001620




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190811001621
SQL开始执行时间：20190811001621

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190811001622
SQL开始执行时间：20190811001622
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190811001622
SQL开始执行时间：20190811001622
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190811001624
SQL开始执行时间：20190811001624
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190811001624
SQL开始执行时间：20190811001624
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190811001626
SQL开始执行时间：20190811001626

truncate table pdm.ar_detail
;
SQL结束执行时间：20190811001626
SQL开始执行时间：20190811001626
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190811001627
SQL开始执行时间：20190811001627

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190811001627
SQL开始执行时间：20190811001627

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190811001628

20190812001533开始执行2019-08-11数据加载日志:
SQL开始执行时间：20190812001533

use pdm
;
SQL结束执行时间：20190812001533
SQL开始执行时间：20190812001533

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190812001533
SQL开始执行时间：20190812001533
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190812001533
SQL开始执行时间：20190812001533

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190812001533
SQL开始执行时间：20190812001533
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190812001535
SQL开始执行时间：20190812001535
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190812001536
SQL开始执行时间：20190812001536
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190812001538
SQL开始执行时间：20190812001538

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190812001538
SQL开始执行时间：20190812001538
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190812001539
SQL开始执行时间：20190812001539
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190812001540
SQL开始执行时间：20190812001540


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190812001540
SQL开始执行时间：20190812001540
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190812001557
SQL开始执行时间：20190812001557


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190812001557
SQL开始执行时间：20190812001557
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190812001558
SQL开始执行时间：20190812001558

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190812001600
SQL开始执行时间：20190812001600
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190812001601
SQL开始执行时间：20190812001601
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190812001603
SQL开始执行时间：20190812001603
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190812001605
SQL开始执行时间：20190812001605

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190812001605
SQL开始执行时间：20190812001605
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190812001605
SQL开始执行时间：20190812001605

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190812001605
SQL开始执行时间：20190812001605

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190812001605
SQL开始执行时间：20190812001605
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190812001605
SQL开始执行时间：20190812001605

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190812001606
SQL开始执行时间：20190812001606

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190812001606
SQL开始执行时间：20190812001606
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190812001608
SQL开始执行时间：20190812001608

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190812001608
SQL开始执行时间：20190812001608

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190812001609
SQL开始执行时间：20190812001609




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190812001610
SQL开始执行时间：20190812001610

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190812001611
SQL开始执行时间：20190812001611
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190812001611
SQL开始执行时间：20190812001611
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190812001613
SQL开始执行时间：20190812001613
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190812001613
SQL开始执行时间：20190812001613
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190812001614
SQL开始执行时间：20190812001614

truncate table pdm.ar_detail
;
SQL结束执行时间：20190812001615
SQL开始执行时间：20190812001615
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190812001616
SQL开始执行时间：20190812001616

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190812001616
SQL开始执行时间：20190812001616

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190812001616

20190813001700开始执行2019-08-12数据加载日志:
SQL开始执行时间：20190813001700

use pdm
;
SQL结束执行时间：20190813001700
SQL开始执行时间：20190813001700

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190813001700
SQL开始执行时间：20190813001700
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190813001700
SQL开始执行时间：20190813001700

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190813001700
SQL开始执行时间：20190813001700
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190813001702
SQL开始执行时间：20190813001702
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190813001704
SQL开始执行时间：20190813001704
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190813001708
SQL开始执行时间：20190813001708

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190813001708
SQL开始执行时间：20190813001708
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190813001709
SQL开始执行时间：20190813001709
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190813001710
SQL开始执行时间：20190813001710


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190813001710
SQL开始执行时间：20190813001710
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190813001722
SQL开始执行时间：20190813001722


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190813001722
SQL开始执行时间：20190813001722
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190813001723
SQL开始执行时间：20190813001723

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190813001725
SQL开始执行时间：20190813001725
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190813001727
SQL开始执行时间：20190813001727
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190813001729
SQL开始执行时间：20190813001729
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190813001731
SQL开始执行时间：20190813001731

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190813001731
SQL开始执行时间：20190813001731
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190813001731
SQL开始执行时间：20190813001731

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190813001732
SQL开始执行时间：20190813001732

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190813001732
SQL开始执行时间：20190813001732
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190813001732
SQL开始执行时间：20190813001732

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190813001732
SQL开始执行时间：20190813001732

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190813001732
SQL开始执行时间：20190813001732
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190813001734
SQL开始执行时间：20190813001734

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190813001734
SQL开始执行时间：20190813001734

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190813001736
SQL开始执行时间：20190813001736




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190813001736
SQL开始执行时间：20190813001736

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190813001737
SQL开始执行时间：20190813001737
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190813001738
SQL开始执行时间：20190813001738
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190813001739
SQL开始执行时间：20190813001739
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190813001739
SQL开始执行时间：20190813001739
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190813001741
SQL开始执行时间：20190813001741

truncate table pdm.ar_detail
;
SQL结束执行时间：20190813001741
SQL开始执行时间：20190813001741
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190813001743
SQL开始执行时间：20190813001743

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190813001743
SQL开始执行时间：20190813001743

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190813001743

20190814001656开始执行2019-08-13数据加载日志:
SQL开始执行时间：20190814001656

use pdm
;
SQL结束执行时间：20190814001656
SQL开始执行时间：20190814001656

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190814001656
SQL开始执行时间：20190814001656
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190814001656
SQL开始执行时间：20190814001656

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190814001656
SQL开始执行时间：20190814001656
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190814001657
SQL开始执行时间：20190814001657
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190814001659
SQL开始执行时间：20190814001659
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190814001702
SQL开始执行时间：20190814001702

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190814001702
SQL开始执行时间：20190814001702
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190814001703
SQL开始执行时间：20190814001703
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190814001704
SQL开始执行时间：20190814001704


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190814001704
SQL开始执行时间：20190814001704
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190814001716
SQL开始执行时间：20190814001716


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190814001716
SQL开始执行时间：20190814001716
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190814001718
SQL开始执行时间：20190814001718

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190814001719
SQL开始执行时间：20190814001719
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190814001721
SQL开始执行时间：20190814001721
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190814001723
SQL开始执行时间：20190814001723
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190814001726
SQL开始执行时间：20190814001726

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190814001726
SQL开始执行时间：20190814001726
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190814001726
SQL开始执行时间：20190814001726

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190814001726
SQL开始执行时间：20190814001726

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190814001726
SQL开始执行时间：20190814001726
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190814001727
SQL开始执行时间：20190814001727

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190814001727
SQL开始执行时间：20190814001727

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190814001727
SQL开始执行时间：20190814001727
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190814001729
SQL开始执行时间：20190814001729

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190814001729
SQL开始执行时间：20190814001729

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190814001731
SQL开始执行时间：20190814001731




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190814001731
SQL开始执行时间：20190814001731

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190814001732
SQL开始执行时间：20190814001732
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190814001733
SQL开始执行时间：20190814001733
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190814001734
SQL开始执行时间：20190814001734
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190814001734
SQL开始执行时间：20190814001734
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190814001736
SQL开始执行时间：20190814001736

truncate table pdm.ar_detail
;
SQL结束执行时间：20190814001736
SQL开始执行时间：20190814001736
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190814001738
SQL开始执行时间：20190814001738

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190814001738
SQL开始执行时间：20190814001738

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190814001738

20190815001654开始执行2019-08-14数据加载日志:
SQL开始执行时间：20190815001654

use pdm
;
SQL结束执行时间：20190815001654
SQL开始执行时间：20190815001654

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190815001654
SQL开始执行时间：20190815001654
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190815001654
SQL开始执行时间：20190815001654

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190815001654
SQL开始执行时间：20190815001654
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190815001655
SQL开始执行时间：20190815001655
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190815001657
SQL开始执行时间：20190815001657
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190815001700
SQL开始执行时间：20190815001700

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190815001700
SQL开始执行时间：20190815001700
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190815001701
SQL开始执行时间：20190815001701
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190815001702
SQL开始执行时间：20190815001702


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190815001702
SQL开始执行时间：20190815001702
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190815001714
SQL开始执行时间：20190815001714


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190815001714
SQL开始执行时间：20190815001714
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190815001716
SQL开始执行时间：20190815001716

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190815001717
SQL开始执行时间：20190815001717
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190815001719
SQL开始执行时间：20190815001719
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190815001722
SQL开始执行时间：20190815001722
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190815001724
SQL开始执行时间：20190815001724

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190815001724
SQL开始执行时间：20190815001724
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190815001724
SQL开始执行时间：20190815001724

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190815001724
SQL开始执行时间：20190815001724

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190815001724
SQL开始执行时间：20190815001724
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190815001725
SQL开始执行时间：20190815001725

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190815001725
SQL开始执行时间：20190815001725

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190815001725
SQL开始执行时间：20190815001725
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190815001727
SQL开始执行时间：20190815001727

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190815001728
SQL开始执行时间：20190815001728

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190815001729
SQL开始执行时间：20190815001729




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190815001729
SQL开始执行时间：20190815001729

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190815001731
SQL开始执行时间：20190815001731
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190815001731
SQL开始执行时间：20190815001731
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190815001733
SQL开始执行时间：20190815001733
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190815001733
SQL开始执行时间：20190815001733
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190815001735
SQL开始执行时间：20190815001735

truncate table pdm.ar_detail
;
SQL结束执行时间：20190815001735
SQL开始执行时间：20190815001735
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190815001736
SQL开始执行时间：20190815001736

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190815001736
SQL开始执行时间：20190815001736

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190815001736

20190815100412开始执行2019-08-15数据加载日志:
SQL开始执行时间：20190815100412

use pdm
;
SQL结束执行时间：20190815100412
SQL开始执行时间：20190815100412

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190815100412
SQL开始执行时间：20190815100412
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190815100412
SQL开始执行时间：20190815100412

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190815100412
SQL开始执行时间：20190815100412
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190815100413
SQL开始执行时间：20190815100413
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190815100415
SQL开始执行时间：20190815100415
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190815100417
SQL开始执行时间：20190815100417

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190815100417
SQL开始执行时间：20190815100417
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190815100418
SQL开始执行时间：20190815100418
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190815100418
SQL开始执行时间：20190815100418


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190815100418
SQL开始执行时间：20190815100418
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190815100430
SQL开始执行时间：20190815100430


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190815100430
SQL开始执行时间：20190815100430
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190815100431
SQL开始执行时间：20190815100431

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190815100432
SQL开始执行时间：20190815100432
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190815100434
SQL开始执行时间：20190815100434
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190815100435
SQL开始执行时间：20190815100435
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190815100437
SQL开始执行时间：20190815100437

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190815100437
SQL开始执行时间：20190815100437
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190815100438
SQL开始执行时间：20190815100438

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190815100438
SQL开始执行时间：20190815100438

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190815100438
SQL开始执行时间：20190815100438
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190815100438
SQL开始执行时间：20190815100438

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190815100439
SQL开始执行时间：20190815100439

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190815100439
SQL开始执行时间：20190815100439
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190815100440
SQL开始执行时间：20190815100440

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190815100440
SQL开始执行时间：20190815100440

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190815100442
SQL开始执行时间：20190815100442




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190815100442
SQL开始执行时间：20190815100442

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190815100443
SQL开始执行时间：20190815100443
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190815100444
SQL开始执行时间：20190815100444
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190815100445
SQL开始执行时间：20190815100445
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190815100446
SQL开始执行时间：20190815100446
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190815100447
SQL开始执行时间：20190815100447

truncate table pdm.ar_detail
;
SQL结束执行时间：20190815100447
SQL开始执行时间：20190815100447
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190815100449
SQL开始执行时间：20190815100449

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190815100449
SQL开始执行时间：20190815100449

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190815100449

20190816001703开始执行2019-08-15数据加载日志:
SQL开始执行时间：20190816001703

use pdm
;
SQL结束执行时间：20190816001703
SQL开始执行时间：20190816001703

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190816001703
SQL开始执行时间：20190816001703
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190816001703
SQL开始执行时间：20190816001703

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190816001703
SQL开始执行时间：20190816001703
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190816001704
SQL开始执行时间：20190816001704
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190816001707
SQL开始执行时间：20190816001707
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190816001709
SQL开始执行时间：20190816001709

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190816001709
SQL开始执行时间：20190816001709
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190816001710
SQL开始执行时间：20190816001710
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190816001711
SQL开始执行时间：20190816001711


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190816001711
SQL开始执行时间：20190816001711
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190816001724
SQL开始执行时间：20190816001724


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190816001724
SQL开始执行时间：20190816001724
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190816001725
SQL开始执行时间：20190816001725

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190816001726
SQL开始执行时间：20190816001726
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190816001728
SQL开始执行时间：20190816001728
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190816001729
SQL开始执行时间：20190816001729
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190816001731
SQL开始执行时间：20190816001731

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190816001731
SQL开始执行时间：20190816001731
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190816001731
SQL开始执行时间：20190816001731

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190816001732
SQL开始执行时间：20190816001732

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190816001732
SQL开始执行时间：20190816001732
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190816001732
SQL开始执行时间：20190816001732

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190816001733
SQL开始执行时间：20190816001733

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190816001733
SQL开始执行时间：20190816001733
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190816001735
SQL开始执行时间：20190816001735

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190816001735
SQL开始执行时间：20190816001735

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190816001736
SQL开始执行时间：20190816001736




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190816001737
SQL开始执行时间：20190816001737

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190816001738
SQL开始执行时间：20190816001738
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190816001738
SQL开始执行时间：20190816001738
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190816001740
SQL开始执行时间：20190816001740
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190816001740
SQL开始执行时间：20190816001740
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190816001742
SQL开始执行时间：20190816001742

truncate table pdm.ar_detail
;
SQL结束执行时间：20190816001742
SQL开始执行时间：20190816001742
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190816001743
SQL开始执行时间：20190816001743

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190816001743
SQL开始执行时间：20190816001743

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190816001743

20190817001703开始执行2019-08-16数据加载日志:
SQL开始执行时间：20190817001703

use pdm
;
SQL结束执行时间：20190817001703
SQL开始执行时间：20190817001703

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190817001703
SQL开始执行时间：20190817001703
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190817001703
SQL开始执行时间：20190817001703

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190817001703
SQL开始执行时间：20190817001703
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190817001705
SQL开始执行时间：20190817001705
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190817001708
SQL开始执行时间：20190817001708
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190817001710
SQL开始执行时间：20190817001710

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190817001710
SQL开始执行时间：20190817001710
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190817001711
SQL开始执行时间：20190817001711
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190817001712
SQL开始执行时间：20190817001712


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190817001712
SQL开始执行时间：20190817001712
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190817001725
SQL开始执行时间：20190817001725


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190817001725
SQL开始执行时间：20190817001725
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190817001726
SQL开始执行时间：20190817001726

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190817001728
SQL开始执行时间：20190817001728
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190817001729
SQL开始执行时间：20190817001729
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190817001731
SQL开始执行时间：20190817001731
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190817001733
SQL开始执行时间：20190817001733

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190817001733
SQL开始执行时间：20190817001733
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190817001733
SQL开始执行时间：20190817001733

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190817001733
SQL开始执行时间：20190817001733

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190817001733
SQL开始执行时间：20190817001733
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190817001734
SQL开始执行时间：20190817001734

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190817001734
SQL开始执行时间：20190817001734

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190817001734
SQL开始执行时间：20190817001734
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190817001736
SQL开始执行时间：20190817001736

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190817001736
SQL开始执行时间：20190817001736

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190817001738
SQL开始执行时间：20190817001738




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190817001738
SQL开始执行时间：20190817001738

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190817001740
SQL开始执行时间：20190817001740
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190817001740
SQL开始执行时间：20190817001740
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190817001741
SQL开始执行时间：20190817001741
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190817001742
SQL开始执行时间：20190817001742
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190817001743
SQL开始执行时间：20190817001743

truncate table pdm.ar_detail
;
SQL结束执行时间：20190817001744
SQL开始执行时间：20190817001744
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190817001745
SQL开始执行时间：20190817001745

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190817001745
SQL开始执行时间：20190817001745

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190817001745

20190820090520开始执行2019-08-19数据加载日志:
SQL开始执行时间：20190820090520

use pdm
;
SQL结束执行时间：20190820090520
SQL开始执行时间：20190820090520

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190820090520
SQL开始执行时间：20190820090520
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190820090520
SQL开始执行时间：20190820090520

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190820090520
SQL开始执行时间：20190820090520
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190820090521
SQL开始执行时间：20190820090521
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190820090523
SQL开始执行时间：20190820090523
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190820090525
SQL开始执行时间：20190820090525

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190820090525
SQL开始执行时间：20190820090525
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190820090526
SQL开始执行时间：20190820090526
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190820090526
SQL开始执行时间：20190820090526


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190820090526
SQL开始执行时间：20190820090526
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190820090538
SQL开始执行时间：20190820090538


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190820090538
SQL开始执行时间：20190820090538
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190820090539
SQL开始执行时间：20190820090539

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190820090541
SQL开始执行时间：20190820090541
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190820090542
SQL开始执行时间：20190820090542
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190820090544
SQL开始执行时间：20190820090544
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190820090546
SQL开始执行时间：20190820090546

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190820090546
SQL开始执行时间：20190820090546
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190820090546
SQL开始执行时间：20190820090546

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190820090546
SQL开始执行时间：20190820090546

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190820090546
SQL开始执行时间：20190820090546
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190820090547
SQL开始执行时间：20190820090547

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190820090547
SQL开始执行时间：20190820090547

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190820090547
SQL开始执行时间：20190820090547
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190820090549
SQL开始执行时间：20190820090549

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190820090549
SQL开始执行时间：20190820090549

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190820090551
SQL开始执行时间：20190820090551




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190820090551
SQL开始执行时间：20190820090551

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190820090552
SQL开始执行时间：20190820090552
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190820090553
SQL开始执行时间：20190820090553
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190820090554
SQL开始执行时间：20190820090554
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190820090554
SQL开始执行时间：20190820090554
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190820090556
SQL开始执行时间：20190820090556

truncate table pdm.ar_detail
;
SQL结束执行时间：20190820090556
SQL开始执行时间：20190820090556
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190820090558
SQL开始执行时间：20190820090558

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190820090558
SQL开始执行时间：20190820090558

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190820090558

20190821001705开始执行2019-08-20数据加载日志:
SQL开始执行时间：20190821001705

use pdm
;
SQL结束执行时间：20190821001705
SQL开始执行时间：20190821001705

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190821001705
SQL开始执行时间：20190821001705
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190821001705
SQL开始执行时间：20190821001705

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190821001705
SQL开始执行时间：20190821001705
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190821001707
SQL开始执行时间：20190821001707
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190821001709
SQL开始执行时间：20190821001709
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190821001712
SQL开始执行时间：20190821001712

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190821001712
SQL开始执行时间：20190821001712
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190821001713
SQL开始执行时间：20190821001713
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190821001714
SQL开始执行时间：20190821001714


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190821001714
SQL开始执行时间：20190821001714
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190821001727
SQL开始执行时间：20190821001727


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190821001727
SQL开始执行时间：20190821001727
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190821001728
SQL开始执行时间：20190821001728

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190821001729
SQL开始执行时间：20190821001729
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190821001731
SQL开始执行时间：20190821001731
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190821001733
SQL开始执行时间：20190821001733
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190821001735
SQL开始执行时间：20190821001735

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190821001735
SQL开始执行时间：20190821001735
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190821001735
SQL开始执行时间：20190821001735

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190821001735
SQL开始执行时间：20190821001735

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190821001735
SQL开始执行时间：20190821001735
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190821001736
SQL开始执行时间：20190821001736

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190821001736
SQL开始执行时间：20190821001736

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190821001736
SQL开始执行时间：20190821001736
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190821001738
SQL开始执行时间：20190821001738

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190821001738
SQL开始执行时间：20190821001738

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190821001740
SQL开始执行时间：20190821001740




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190821001740
SQL开始执行时间：20190821001740

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190821001742
SQL开始执行时间：20190821001742
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190821001742
SQL开始执行时间：20190821001742
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190821001743
SQL开始执行时间：20190821001743
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190821001744
SQL开始执行时间：20190821001744
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190821001745
SQL开始执行时间：20190821001745

truncate table pdm.ar_detail
;
SQL结束执行时间：20190821001745
SQL开始执行时间：20190821001745
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190821001747
SQL开始执行时间：20190821001747

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190821001747
SQL开始执行时间：20190821001747

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190821001747

20190822001656开始执行2019-08-21数据加载日志:
SQL开始执行时间：20190822001656

use pdm
;
SQL结束执行时间：20190822001656
SQL开始执行时间：20190822001656

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190822001656
SQL开始执行时间：20190822001656
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190822001656
SQL开始执行时间：20190822001656

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190822001656
SQL开始执行时间：20190822001656
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190822001658
SQL开始执行时间：20190822001658
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190822001700
SQL开始执行时间：20190822001700
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190822001703
SQL开始执行时间：20190822001703

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190822001703
SQL开始执行时间：20190822001703
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190822001704
SQL开始执行时间：20190822001704
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190822001704
SQL开始执行时间：20190822001704


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190822001704
SQL开始执行时间：20190822001704
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190822001717
SQL开始执行时间：20190822001717


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190822001717
SQL开始执行时间：20190822001717
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190822001718
SQL开始执行时间：20190822001718

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190822001719
SQL开始执行时间：20190822001719
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190822001721
SQL开始执行时间：20190822001721
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190822001723
SQL开始执行时间：20190822001723
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190822001725
SQL开始执行时间：20190822001725

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190822001725
SQL开始执行时间：20190822001725
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190822001725
SQL开始执行时间：20190822001725

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190822001725
SQL开始执行时间：20190822001725

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190822001725
SQL开始执行时间：20190822001725
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190822001726
SQL开始执行时间：20190822001726

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190822001726
SQL开始执行时间：20190822001726

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190822001726
SQL开始执行时间：20190822001726
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190822001728
SQL开始执行时间：20190822001728

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190822001728
SQL开始执行时间：20190822001728

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190822001730
SQL开始执行时间：20190822001730




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190822001730
SQL开始执行时间：20190822001730

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190822001731
SQL开始执行时间：20190822001731
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190822001732
SQL开始执行时间：20190822001732
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190822001733
SQL开始执行时间：20190822001733
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190822001733
SQL开始执行时间：20190822001733
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190822001735
SQL开始执行时间：20190822001735

truncate table pdm.ar_detail
;
SQL结束执行时间：20190822001735
SQL开始执行时间：20190822001735
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190822001737
SQL开始执行时间：20190822001737

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190822001737
SQL开始执行时间：20190822001737

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190822001737

20190823001700开始执行2019-08-22数据加载日志:
SQL开始执行时间：20190823001700

use pdm
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190823001700
SQL开始执行时间：20190823001700
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190823001702
SQL开始执行时间：20190823001702
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190823001704
SQL开始执行时间：20190823001704
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190823001708
SQL开始执行时间：20190823001708

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190823001708
SQL开始执行时间：20190823001708
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190823001709
SQL开始执行时间：20190823001709
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190823001709
SQL开始执行时间：20190823001709


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190823001709
SQL开始执行时间：20190823001709
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190823001722
SQL开始执行时间：20190823001722


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190823001722
SQL开始执行时间：20190823001722
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190823001723
SQL开始执行时间：20190823001723

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190823001725
SQL开始执行时间：20190823001725
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190823001726
SQL开始执行时间：20190823001726
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190823001728
SQL开始执行时间：20190823001728
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190823001730
SQL开始执行时间：20190823001730

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190823001730
SQL开始执行时间：20190823001730
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190823001730
SQL开始执行时间：20190823001730

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190823001731
SQL开始执行时间：20190823001731

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190823001731
SQL开始执行时间：20190823001731
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190823001731
SQL开始执行时间：20190823001731

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190823001731
SQL开始执行时间：20190823001731

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190823001731
SQL开始执行时间：20190823001731
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190823001733
SQL开始执行时间：20190823001733

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190823001734
SQL开始执行时间：20190823001734

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190823001735
SQL开始执行时间：20190823001735




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190823001735
SQL开始执行时间：20190823001735

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190823001737
SQL开始执行时间：20190823001737
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190823001737
SQL开始执行时间：20190823001737
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190823001739
SQL开始执行时间：20190823001739
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190823001739
SQL开始执行时间：20190823001739
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190823001741
SQL开始执行时间：20190823001741

truncate table pdm.ar_detail
;
SQL结束执行时间：20190823001741
SQL开始执行时间：20190823001741
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190823001742
SQL开始执行时间：20190823001742

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190823001742
SQL开始执行时间：20190823001742

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190823001743

20190824001724开始执行2019-08-23数据加载日志:
SQL开始执行时间：20190824001724

use pdm
;
SQL结束执行时间：20190824001724
SQL开始执行时间：20190824001724

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190824001724
SQL开始执行时间：20190824001724
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190824001724
SQL开始执行时间：20190824001724

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190824001724
SQL开始执行时间：20190824001724
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190824001725
SQL开始执行时间：20190824001725
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190824001728
SQL开始执行时间：20190824001728
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190824001730
SQL开始执行时间：20190824001730

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190824001730
SQL开始执行时间：20190824001730
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190824001731
SQL开始执行时间：20190824001731
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190824001732
SQL开始执行时间：20190824001732


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190824001732
SQL开始执行时间：20190824001732
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190824001744
SQL开始执行时间：20190824001745


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190824001745
SQL开始执行时间：20190824001745
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190824001746
SQL开始执行时间：20190824001746

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190824001747
SQL开始执行时间：20190824001747
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190824001749
SQL开始执行时间：20190824001749
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190824001750
SQL开始执行时间：20190824001750
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190824001752
SQL开始执行时间：20190824001752

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190824001752
SQL开始执行时间：20190824001752
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190824001753
SQL开始执行时间：20190824001753

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190824001753
SQL开始执行时间：20190824001753

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190824001753
SQL开始执行时间：20190824001753
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190824001753
SQL开始执行时间：20190824001753

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190824001754
SQL开始执行时间：20190824001754

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190824001754
SQL开始执行时间：20190824001754
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190824001756
SQL开始执行时间：20190824001756

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190824001756
SQL开始执行时间：20190824001756

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190824001757
SQL开始执行时间：20190824001757




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190824001758
SQL开始执行时间：20190824001758

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190824001759
SQL开始执行时间：20190824001759
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190824001759
SQL开始执行时间：20190824001759
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190824001801
SQL开始执行时间：20190824001801
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190824001801
SQL开始执行时间：20190824001801
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190824001803
SQL开始执行时间：20190824001803

truncate table pdm.ar_detail
;
SQL结束执行时间：20190824001803
SQL开始执行时间：20190824001803
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190824001804
SQL开始执行时间：20190824001804

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190824001805
SQL开始执行时间：20190824001805

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190824001805

20190825001659开始执行2019-08-24数据加载日志:
SQL开始执行时间：20190825001659

use pdm
;
SQL结束执行时间：20190825001659
SQL开始执行时间：20190825001659

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190825001659
SQL开始执行时间：20190825001659
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190825001659
SQL开始执行时间：20190825001659

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190825001659
SQL开始执行时间：20190825001659
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190825001700
SQL开始执行时间：20190825001700
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190825001702
SQL开始执行时间：20190825001702
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190825001706
SQL开始执行时间：20190825001706

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190825001706
SQL开始执行时间：20190825001706
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190825001707
SQL开始执行时间：20190825001707
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190825001708
SQL开始执行时间：20190825001708


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190825001708
SQL开始执行时间：20190825001708
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190825001720
SQL开始执行时间：20190825001720


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190825001720
SQL开始执行时间：20190825001720
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190825001722
SQL开始执行时间：20190825001722

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190825001723
SQL开始执行时间：20190825001723
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190825001725
SQL开始执行时间：20190825001725
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190825001727
SQL开始执行时间：20190825001727
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190825001730
SQL开始执行时间：20190825001730

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190825001730
SQL开始执行时间：20190825001730
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190825001730
SQL开始执行时间：20190825001730

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190825001730
SQL开始执行时间：20190825001730

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190825001730
SQL开始执行时间：20190825001730
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190825001731
SQL开始执行时间：20190825001731

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190825001731
SQL开始执行时间：20190825001731

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190825001731
SQL开始执行时间：20190825001731
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190825001734
SQL开始执行时间：20190825001734

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190825001734
SQL开始执行时间：20190825001734

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190825001735
SQL开始执行时间：20190825001735




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190825001736
SQL开始执行时间：20190825001736

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190825001737
SQL开始执行时间：20190825001737
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190825001737
SQL开始执行时间：20190825001737
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190825001739
SQL开始执行时间：20190825001739
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190825001739
SQL开始执行时间：20190825001739
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190825001741
SQL开始执行时间：20190825001741

truncate table pdm.ar_detail
;
SQL结束执行时间：20190825001741
SQL开始执行时间：20190825001741
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190825001743
SQL开始执行时间：20190825001743

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190825001743
SQL开始执行时间：20190825001743

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190825001743

20190826001657开始执行2019-08-25数据加载日志:
SQL开始执行时间：20190826001657

use pdm
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190826001657
SQL开始执行时间：20190826001657
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190826001659
SQL开始执行时间：20190826001659
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190826001702
SQL开始执行时间：20190826001702
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190826001705
SQL开始执行时间：20190826001705

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190826001705
SQL开始执行时间：20190826001705
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190826001706
SQL开始执行时间：20190826001706
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190826001707
SQL开始执行时间：20190826001707


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190826001707
SQL开始执行时间：20190826001707
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190826001719
SQL开始执行时间：20190826001719


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190826001719
SQL开始执行时间：20190826001719
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190826001720
SQL开始执行时间：20190826001720

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190826001722
SQL开始执行时间：20190826001722
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190826001724
SQL开始执行时间：20190826001724
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190826001726
SQL开始执行时间：20190826001726
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190826001729
SQL开始执行时间：20190826001729

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190826001729
SQL开始执行时间：20190826001729
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190826001729
SQL开始执行时间：20190826001729

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190826001729
SQL开始执行时间：20190826001729

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190826001729
SQL开始执行时间：20190826001729
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190826001730
SQL开始执行时间：20190826001730

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190826001730
SQL开始执行时间：20190826001730

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190826001730
SQL开始执行时间：20190826001730
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190826001732
SQL开始执行时间：20190826001732

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190826001732
SQL开始执行时间：20190826001732

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190826001734
SQL开始执行时间：20190826001734




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190826001734
SQL开始执行时间：20190826001734

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190826001736
SQL开始执行时间：20190826001736
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190826001736
SQL开始执行时间：20190826001736
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190826001737
SQL开始执行时间：20190826001737
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190826001738
SQL开始执行时间：20190826001738
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190826001739
SQL开始执行时间：20190826001739

truncate table pdm.ar_detail
;
SQL结束执行时间：20190826001739
SQL开始执行时间：20190826001739
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190826001741
SQL开始执行时间：20190826001741

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190826001741
SQL开始执行时间：20190826001741

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190826001741

20190827001645开始执行2019-08-26数据加载日志:
SQL开始执行时间：20190827001645

use pdm
;
SQL结束执行时间：20190827001645
SQL开始执行时间：20190827001645

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190827001645
SQL开始执行时间：20190827001645
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190827001645
SQL开始执行时间：20190827001645

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190827001645
SQL开始执行时间：20190827001645
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190827001647
SQL开始执行时间：20190827001647
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190827001648
SQL开始执行时间：20190827001648
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190827001651
SQL开始执行时间：20190827001651

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190827001651
SQL开始执行时间：20190827001651
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190827001651
SQL开始执行时间：20190827001651
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190827001652
SQL开始执行时间：20190827001652


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190827001652
SQL开始执行时间：20190827001652
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190827001704
SQL开始执行时间：20190827001704


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190827001704
SQL开始执行时间：20190827001704
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190827001705
SQL开始执行时间：20190827001705

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190827001706
SQL开始执行时间：20190827001706
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190827001708
SQL开始执行时间：20190827001708
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190827001710
SQL开始执行时间：20190827001710
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190827001712
SQL开始执行时间：20190827001712

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190827001712
SQL开始执行时间：20190827001712
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190827001712
SQL开始执行时间：20190827001712

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190827001712
SQL开始执行时间：20190827001712

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190827001712
SQL开始执行时间：20190827001712
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190827001712
SQL开始执行时间：20190827001712

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190827001713
SQL开始执行时间：20190827001713

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190827001713
SQL开始执行时间：20190827001713
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190827001715
SQL开始执行时间：20190827001715

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190827001715
SQL开始执行时间：20190827001715

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190827001716
SQL开始执行时间：20190827001716




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190827001717
SQL开始执行时间：20190827001717

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190827001718
SQL开始执行时间：20190827001718
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190827001718
SQL开始执行时间：20190827001718
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190827001720
SQL开始执行时间：20190827001720
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190827001720
SQL开始执行时间：20190827001720
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190827001722
SQL开始执行时间：20190827001722

truncate table pdm.ar_detail
;
SQL结束执行时间：20190827001722
SQL开始执行时间：20190827001722
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190827001723
SQL开始执行时间：20190827001723

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190827001723
SQL开始执行时间：20190827001723

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190827001723

20190828001544开始执行2019-08-27数据加载日志:
SQL开始执行时间：20190828001544

use pdm
;
SQL结束执行时间：20190828001544
SQL开始执行时间：20190828001544

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190828001544
SQL开始执行时间：20190828001544
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190828001544
SQL开始执行时间：20190828001544

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190828001544
SQL开始执行时间：20190828001544
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190828001545
SQL开始执行时间：20190828001545
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190828001547
SQL开始执行时间：20190828001547
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190828001549
SQL开始执行时间：20190828001549

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190828001549
SQL开始执行时间：20190828001549
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190828001550
SQL开始执行时间：20190828001550
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190828001550
SQL开始执行时间：20190828001550


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190828001550
SQL开始执行时间：20190828001550
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190828001603
SQL开始执行时间：20190828001603


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190828001603
SQL开始执行时间：20190828001603
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190828001604
SQL开始执行时间：20190828001604

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190828001605
SQL开始执行时间：20190828001605
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190828001607
SQL开始执行时间：20190828001607
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190828001608
SQL开始执行时间：20190828001608
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190828001610
SQL开始执行时间：20190828001610

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190828001610
SQL开始执行时间：20190828001610
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190828001610
SQL开始执行时间：20190828001610

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190828001611
SQL开始执行时间：20190828001611

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190828001611
SQL开始执行时间：20190828001611
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190828001611
SQL开始执行时间：20190828001611

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190828001611
SQL开始执行时间：20190828001611

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190828001611
SQL开始执行时间：20190828001611
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190828001613
SQL开始执行时间：20190828001613

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190828001613
SQL开始执行时间：20190828001613

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190828001615
SQL开始执行时间：20190828001615




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190828001615
SQL开始执行时间：20190828001615

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190828001616
SQL开始执行时间：20190828001616
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190828001617
SQL开始执行时间：20190828001617
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190828001618
SQL开始执行时间：20190828001618
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190828001618
SQL开始执行时间：20190828001618
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190828001620
SQL开始执行时间：20190828001620

truncate table pdm.ar_detail
;
SQL结束执行时间：20190828001620
SQL开始执行时间：20190828001620
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190828001622
SQL开始执行时间：20190828001622

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190828001622
SQL开始执行时间：20190828001622

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190828001622

20190829001706开始执行2019-08-28数据加载日志:
SQL开始执行时间：20190829001706

use pdm
;
SQL结束执行时间：20190829001706
SQL开始执行时间：20190829001706

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190829001706
SQL开始执行时间：20190829001706
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190829001707
SQL开始执行时间：20190829001707

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190829001707
SQL开始执行时间：20190829001707
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190829001709
SQL开始执行时间：20190829001709
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190829001711
SQL开始执行时间：20190829001711
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190829001714
SQL开始执行时间：20190829001714
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190829001715
SQL开始执行时间：20190829001715
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190829001716
SQL开始执行时间：20190829001716


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190829001716
SQL开始执行时间：20190829001716
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190829001728
SQL开始执行时间：20190829001728


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190829001728
SQL开始执行时间：20190829001728
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190829001730
SQL开始执行时间：20190829001730

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190829001732
SQL开始执行时间：20190829001732
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190829001734
SQL开始执行时间：20190829001734
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190829001736
SQL开始执行时间：20190829001736
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190829001738
SQL开始执行时间：20190829001738

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190829001738
SQL开始执行时间：20190829001738
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190829001738
SQL开始执行时间：20190829001738

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190829001738
SQL开始执行时间：20190829001738

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190829001738
SQL开始执行时间：20190829001738
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190829001739
SQL开始执行时间：20190829001739

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190829001739
SQL开始执行时间：20190829001739

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190829001739
SQL开始执行时间：20190829001739
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190829001741
SQL开始执行时间：20190829001741

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190829001741
SQL开始执行时间：20190829001741

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190829001743
SQL开始执行时间：20190829001743




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190829001743
SQL开始执行时间：20190829001743

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190829001745
SQL开始执行时间：20190829001745
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190829001745
SQL开始执行时间：20190829001745
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190829001746
SQL开始执行时间：20190829001746
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190829001747
SQL开始执行时间：20190829001747
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190829001748
SQL开始执行时间：20190829001748

truncate table pdm.ar_detail
;
SQL结束执行时间：20190829001748
SQL开始执行时间：20190829001748
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190829001750
SQL开始执行时间：20190829001750

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190829001750
SQL开始执行时间：20190829001750

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190829001750

20190830001713开始执行2019-08-29数据加载日志:
SQL开始执行时间：20190830001713

use pdm
;
SQL结束执行时间：20190830001713
SQL开始执行时间：20190830001713

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190830001713
SQL开始执行时间：20190830001713
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190830001713
SQL开始执行时间：20190830001713

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190830001713
SQL开始执行时间：20190830001713
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190830001715
SQL开始执行时间：20190830001715
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190830001717
SQL开始执行时间：20190830001717
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190830001720
SQL开始执行时间：20190830001720
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190830001721
SQL开始执行时间：20190830001721
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190830001722
SQL开始执行时间：20190830001722


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190830001722
SQL开始执行时间：20190830001722
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190830001734
SQL开始执行时间：20190830001734


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190830001734
SQL开始执行时间：20190830001734
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190830001736
SQL开始执行时间：20190830001736

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190830001738
SQL开始执行时间：20190830001738
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190830001740
SQL开始执行时间：20190830001740
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190830001742
SQL开始执行时间：20190830001742
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190830001744
SQL开始执行时间：20190830001744

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190830001744
SQL开始执行时间：20190830001744
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190830001744
SQL开始执行时间：20190830001744

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190830001744
SQL开始执行时间：20190830001744

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190830001744
SQL开始执行时间：20190830001744
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190830001745
SQL开始执行时间：20190830001745

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190830001745
SQL开始执行时间：20190830001745

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190830001745
SQL开始执行时间：20190830001745
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190830001747
SQL开始执行时间：20190830001747

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190830001747
SQL开始执行时间：20190830001747

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190830001749
SQL开始执行时间：20190830001749




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190830001749
SQL开始执行时间：20190830001749

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190830001750
SQL开始执行时间：20190830001750
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190830001751
SQL开始执行时间：20190830001751
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190830001752
SQL开始执行时间：20190830001752
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190830001752
SQL开始执行时间：20190830001752
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190830001754
SQL开始执行时间：20190830001754

truncate table pdm.ar_detail
;
SQL结束执行时间：20190830001754
SQL开始执行时间：20190830001754
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190830001756
SQL开始执行时间：20190830001756

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190830001756
SQL开始执行时间：20190830001756

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190830001756

20190831001657开始执行2019-08-30数据加载日志:
SQL开始执行时间：20190831001657

use pdm
;
SQL结束执行时间：20190831001657
SQL开始执行时间：20190831001657

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190831001657
SQL开始执行时间：20190831001657
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190831001657
SQL开始执行时间：20190831001657

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190831001657
SQL开始执行时间：20190831001657
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190831001659
SQL开始执行时间：20190831001659
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190831001701
SQL开始执行时间：20190831001701
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190831001704
SQL开始执行时间：20190831001704

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190831001704
SQL开始执行时间：20190831001704
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190831001705
SQL开始执行时间：20190831001705
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190831001706
SQL开始执行时间：20190831001706


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190831001706
SQL开始执行时间：20190831001706
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190831001718
SQL开始执行时间：20190831001718


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190831001718
SQL开始执行时间：20190831001718
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190831001719
SQL开始执行时间：20190831001719

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190831001721
SQL开始执行时间：20190831001721
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190831001722
SQL开始执行时间：20190831001722
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190831001724
SQL开始执行时间：20190831001724
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190831001726
SQL开始执行时间：20190831001726

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190831001726
SQL开始执行时间：20190831001726
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190831001726
SQL开始执行时间：20190831001726

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190831001726
SQL开始执行时间：20190831001726

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190831001726
SQL开始执行时间：20190831001726
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190831001727
SQL开始执行时间：20190831001727

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190831001727
SQL开始执行时间：20190831001727

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190831001727
SQL开始执行时间：20190831001727
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190831001729
SQL开始执行时间：20190831001729

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190831001729
SQL开始执行时间：20190831001729

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190831001731
SQL开始执行时间：20190831001731




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190831001731
SQL开始执行时间：20190831001731

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190831001733
SQL开始执行时间：20190831001733
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190831001733
SQL开始执行时间：20190831001733
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190831001734
SQL开始执行时间：20190831001734
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190831001735
SQL开始执行时间：20190831001735
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190831001736
SQL开始执行时间：20190831001736

truncate table pdm.ar_detail
;
SQL结束执行时间：20190831001736
SQL开始执行时间：20190831001736
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190831001738
SQL开始执行时间：20190831001738

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190831001738
SQL开始执行时间：20190831001738

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190831001738

20190901001530开始执行2019-08-31数据加载日志:
SQL开始执行时间：20190901001530

use pdm
;
SQL结束执行时间：20190901001530
SQL开始执行时间：20190901001530

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190901001530
SQL开始执行时间：20190901001530
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190901001530
SQL开始执行时间：20190901001530

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190901001530
SQL开始执行时间：20190901001530
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190901001532
SQL开始执行时间：20190901001532
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190901001533
SQL开始执行时间：20190901001533
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190901001536
SQL开始执行时间：20190901001536

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190901001536
SQL开始执行时间：20190901001536
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190901001536
SQL开始执行时间：20190901001536
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190901001537
SQL开始执行时间：20190901001537


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190901001537
SQL开始执行时间：20190901001537
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190901001549
SQL开始执行时间：20190901001549


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190901001549
SQL开始执行时间：20190901001549
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190901001550
SQL开始执行时间：20190901001550

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190901001551
SQL开始执行时间：20190901001551
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190901001553
SQL开始执行时间：20190901001553
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190901001555
SQL开始执行时间：20190901001555
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190901001557
SQL开始执行时间：20190901001557

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190901001557
SQL开始执行时间：20190901001557
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190901001557
SQL开始执行时间：20190901001557

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190901001557
SQL开始执行时间：20190901001557

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190901001557
SQL开始执行时间：20190901001557
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190901001558
SQL开始执行时间：20190901001558

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190901001558
SQL开始执行时间：20190901001558

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190901001558
SQL开始执行时间：20190901001558
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190901001600
SQL开始执行时间：20190901001600

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190901001600
SQL开始执行时间：20190901001600

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190901001601
SQL开始执行时间：20190901001601




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190901001602
SQL开始执行时间：20190901001602

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190901001603
SQL开始执行时间：20190901001603
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190901001603
SQL开始执行时间：20190901001603
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190901001605
SQL开始执行时间：20190901001605
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190901001605
SQL开始执行时间：20190901001605
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190901001607
SQL开始执行时间：20190901001607

truncate table pdm.ar_detail
;
SQL结束执行时间：20190901001607
SQL开始执行时间：20190901001607
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190901001609
SQL开始执行时间：20190901001609

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190901001609
SQL开始执行时间：20190901001609

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190901001609

20190902001606开始执行2019-09-01数据加载日志:
SQL开始执行时间：20190902001606

use pdm
;
SQL结束执行时间：20190902001606
SQL开始执行时间：20190902001606

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190902001606
SQL开始执行时间：20190902001606
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190902001607
SQL开始执行时间：20190902001607

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190902001607
SQL开始执行时间：20190902001607
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190902001608
SQL开始执行时间：20190902001608
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190902001610
SQL开始执行时间：20190902001610
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190902001612
SQL开始执行时间：20190902001612

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190902001612
SQL开始执行时间：20190902001612
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190902001613
SQL开始执行时间：20190902001613
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190902001613
SQL开始执行时间：20190902001613


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190902001613
SQL开始执行时间：20190902001613
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190902001625
SQL开始执行时间：20190902001625


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190902001625
SQL开始执行时间：20190902001625
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190902001626
SQL开始执行时间：20190902001626

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190902001628
SQL开始执行时间：20190902001628
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190902001630
SQL开始执行时间：20190902001630
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190902001631
SQL开始执行时间：20190902001631
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190902001633
SQL开始执行时间：20190902001633

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190902001633
SQL开始执行时间：20190902001633
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190902001633
SQL开始执行时间：20190902001633

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190902001634
SQL开始执行时间：20190902001634

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190902001634
SQL开始执行时间：20190902001634
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190902001634
SQL开始执行时间：20190902001634

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190902001634
SQL开始执行时间：20190902001634

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190902001634
SQL开始执行时间：20190902001634
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190902001636
SQL开始执行时间：20190902001636

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190902001636
SQL开始执行时间：20190902001636

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190902001638
SQL开始执行时间：20190902001638




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190902001638
SQL开始执行时间：20190902001638

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190902001640
SQL开始执行时间：20190902001640
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190902001640
SQL开始执行时间：20190902001640
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190902001641
SQL开始执行时间：20190902001641
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190902001642
SQL开始执行时间：20190902001642
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190902001643
SQL开始执行时间：20190902001643

truncate table pdm.ar_detail
;
SQL结束执行时间：20190902001643
SQL开始执行时间：20190902001643
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190902001645
SQL开始执行时间：20190902001645

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190902001645
SQL开始执行时间：20190902001645

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190902001645

20190903001711开始执行2019-09-02数据加载日志:
SQL开始执行时间：20190903001711

use pdm
;
SQL结束执行时间：20190903001711
SQL开始执行时间：20190903001711

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190903001711
SQL开始执行时间：20190903001711
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190903001711
SQL开始执行时间：20190903001711

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190903001711
SQL开始执行时间：20190903001711
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190903001712
SQL开始执行时间：20190903001712
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190903001714
SQL开始执行时间：20190903001714
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190903001717
SQL开始执行时间：20190903001717

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190903001717
SQL开始执行时间：20190903001717
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190903001718
SQL开始执行时间：20190903001718
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190903001719
SQL开始执行时间：20190903001719


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190903001719
SQL开始执行时间：20190903001719
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190903001731
SQL开始执行时间：20190903001731


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190903001731
SQL开始执行时间：20190903001731
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190903001732
SQL开始执行时间：20190903001732

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190903001734
SQL开始执行时间：20190903001734
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190903001736
SQL开始执行时间：20190903001736
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190903001737
SQL开始执行时间：20190903001737
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190903001739
SQL开始执行时间：20190903001739

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190903001739
SQL开始执行时间：20190903001739
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190903001740
SQL开始执行时间：20190903001740

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190903001740
SQL开始执行时间：20190903001740

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190903001740
SQL开始执行时间：20190903001740
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190903001740
SQL开始执行时间：20190903001740

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190903001741
SQL开始执行时间：20190903001741

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190903001741
SQL开始执行时间：20190903001741
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190903001743
SQL开始执行时间：20190903001743

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190903001743
SQL开始执行时间：20190903001743

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190903001744
SQL开始执行时间：20190903001744




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190903001745
SQL开始执行时间：20190903001745

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190903001746
SQL开始执行时间：20190903001746
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190903001746
SQL开始执行时间：20190903001746
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190903001748
SQL开始执行时间：20190903001748
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190903001748
SQL开始执行时间：20190903001748
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190903001750
SQL开始执行时间：20190903001750

truncate table pdm.ar_detail
;
SQL结束执行时间：20190903001750
SQL开始执行时间：20190903001750
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190903001752
SQL开始执行时间：20190903001752

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190903001752
SQL开始执行时间：20190903001752

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190903001752

20190904001637开始执行2019-09-03数据加载日志:
SQL开始执行时间：20190904001637

use pdm
;
SQL结束执行时间：20190904001637
SQL开始执行时间：20190904001637

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190904001637
SQL开始执行时间：20190904001637
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190904001637
SQL开始执行时间：20190904001637

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190904001637
SQL开始执行时间：20190904001637
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190904001638
SQL开始执行时间：20190904001638
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190904001640
SQL开始执行时间：20190904001640
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190904001642
SQL开始执行时间：20190904001642

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190904001642
SQL开始执行时间：20190904001642
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190904001643
SQL开始执行时间：20190904001643
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190904001643
SQL开始执行时间：20190904001643


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190904001643
SQL开始执行时间：20190904001643
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190904001656
SQL开始执行时间：20190904001656


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190904001656
SQL开始执行时间：20190904001656
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190904001657
SQL开始执行时间：20190904001657

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190904001658
SQL开始执行时间：20190904001658
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190904001700
SQL开始执行时间：20190904001700
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190904001701
SQL开始执行时间：20190904001701
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190904001703
SQL开始执行时间：20190904001703

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190904001703
SQL开始执行时间：20190904001703
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190904001703
SQL开始执行时间：20190904001703

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190904001704
SQL开始执行时间：20190904001704

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190904001704
SQL开始执行时间：20190904001704
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190904001704
SQL开始执行时间：20190904001704

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190904001704
SQL开始执行时间：20190904001704

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190904001704
SQL开始执行时间：20190904001704
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190904001706
SQL开始执行时间：20190904001706

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190904001706
SQL开始执行时间：20190904001706

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190904001708
SQL开始执行时间：20190904001708




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190904001708
SQL开始执行时间：20190904001708

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190904001710
SQL开始执行时间：20190904001710
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190904001710
SQL开始执行时间：20190904001710
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190904001711
SQL开始执行时间：20190904001711
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190904001712
SQL开始执行时间：20190904001712
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190904001713
SQL开始执行时间：20190904001713

truncate table pdm.ar_detail
;
SQL结束执行时间：20190904001713
SQL开始执行时间：20190904001713
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190904001715
SQL开始执行时间：20190904001715

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190904001715
SQL开始执行时间：20190904001715

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190904001715

20190904184112开始执行2019-09-04数据加载日志:
SQL开始执行时间：20190904184112

use pdm
;
SQL结束执行时间：20190904184112
SQL开始执行时间：20190904184112

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190904184112
SQL开始执行时间：20190904184112
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190904184113
SQL开始执行时间：20190904184113

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190904184113
SQL开始执行时间：20190904184113
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190904184114
SQL开始执行时间：20190904184114
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190904184116
SQL开始执行时间：20190904184116
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190904184118
SQL开始执行时间：20190904184118

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190904184118
SQL开始执行时间：20190904184118
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190904184119
SQL开始执行时间：20190904184119
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190904184119
SQL开始执行时间：20190904184119


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190904184119
SQL开始执行时间：20190904184119
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190904184132
SQL开始执行时间：20190904184132


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190904184132
SQL开始执行时间：20190904184132
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190904184133
SQL开始执行时间：20190904184133

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190904184135
SQL开始执行时间：20190904184135
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190904184136
SQL开始执行时间：20190904184136
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190904184138
SQL开始执行时间：20190904184138
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190904184140
SQL开始执行时间：20190904184140

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190904184140
SQL开始执行时间：20190904184140
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190904184140
SQL开始执行时间：20190904184140

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190904184140
SQL开始执行时间：20190904184140

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190904184140
SQL开始执行时间：20190904184140
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190904184141
SQL开始执行时间：20190904184141

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190904184141
SQL开始执行时间：20190904184141

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190904184141
SQL开始执行时间：20190904184141
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190904184143
SQL开始执行时间：20190904184143

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190904184143
SQL开始执行时间：20190904184143

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190904184145
SQL开始执行时间：20190904184145




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190904184145
SQL开始执行时间：20190904184145

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190904184147
SQL开始执行时间：20190904184147
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190904184147
SQL开始执行时间：20190904184147
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190904184148
SQL开始执行时间：20190904184148
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190904184149
SQL开始执行时间：20190904184149
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190904184150
SQL开始执行时间：20190904184150

truncate table pdm.ar_detail
;
SQL结束执行时间：20190904184151
SQL开始执行时间：20190904184151
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190904184152
SQL开始执行时间：20190904184152

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190904184152
SQL开始执行时间：20190904184152

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190904184152

20190905001710开始执行2019-09-04数据加载日志:
SQL开始执行时间：20190905001710

use pdm
;
SQL结束执行时间：20190905001710
SQL开始执行时间：20190905001710

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190905001710
SQL开始执行时间：20190905001710
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190905001710
SQL开始执行时间：20190905001710

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190905001710
SQL开始执行时间：20190905001710
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190905001712
SQL开始执行时间：20190905001712
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190905001714
SQL开始执行时间：20190905001714
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190905001717
SQL开始执行时间：20190905001717

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190905001717
SQL开始执行时间：20190905001717
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190905001718
SQL开始执行时间：20190905001718
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190905001718
SQL开始执行时间：20190905001718


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190905001718
SQL开始执行时间：20190905001718
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190905001732
SQL开始执行时间：20190905001732


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190905001732
SQL开始执行时间：20190905001732
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190905001733
SQL开始执行时间：20190905001733

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190905001734
SQL开始执行时间：20190905001734
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190905001736
SQL开始执行时间：20190905001736
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190905001738
SQL开始执行时间：20190905001738
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190905001740
SQL开始执行时间：20190905001740

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190905001740
SQL开始执行时间：20190905001740
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190905001740
SQL开始执行时间：20190905001740

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190905001740
SQL开始执行时间：20190905001740

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190905001740
SQL开始执行时间：20190905001740
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190905001741
SQL开始执行时间：20190905001741

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190905001741
SQL开始执行时间：20190905001741

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190905001741
SQL开始执行时间：20190905001741
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190905001743
SQL开始执行时间：20190905001743

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190905001743
SQL开始执行时间：20190905001743

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190905001745
SQL开始执行时间：20190905001745




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190905001745
SQL开始执行时间：20190905001745

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190905001747
SQL开始执行时间：20190905001747
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190905001747
SQL开始执行时间：20190905001747
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190905001748
SQL开始执行时间：20190905001748
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190905001749
SQL开始执行时间：20190905001749
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190905001751
SQL开始执行时间：20190905001751

truncate table pdm.ar_detail
;
SQL结束执行时间：20190905001751
SQL开始执行时间：20190905001751
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190905001753
SQL开始执行时间：20190905001753

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190905001753
SQL开始执行时间：20190905001753

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190905001753

20190906001717开始执行2019-09-05数据加载日志:
SQL开始执行时间：20190906001717

use pdm
;
SQL结束执行时间：20190906001717
SQL开始执行时间：20190906001717

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190906001717
SQL开始执行时间：20190906001717
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190906001717
SQL开始执行时间：20190906001717

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190906001717
SQL开始执行时间：20190906001717
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190906001718
SQL开始执行时间：20190906001718
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190906001721
SQL开始执行时间：20190906001721
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190906001724
SQL开始执行时间：20190906001724

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190906001724
SQL开始执行时间：20190906001724
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190906001725
SQL开始执行时间：20190906001725
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190906001726
SQL开始执行时间：20190906001726


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190906001726
SQL开始执行时间：20190906001726
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190906001738
SQL开始执行时间：20190906001738


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190906001738
SQL开始执行时间：20190906001738
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190906001739
SQL开始执行时间：20190906001739

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190906001741
SQL开始执行时间：20190906001741
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190906001743
SQL开始执行时间：20190906001743
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190906001745
SQL开始执行时间：20190906001745
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190906001746
SQL开始执行时间：20190906001746

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190906001746
SQL开始执行时间：20190906001746
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190906001747
SQL开始执行时间：20190906001747

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190906001747
SQL开始执行时间：20190906001747

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190906001747
SQL开始执行时间：20190906001747
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190906001747
SQL开始执行时间：20190906001747

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190906001748
SQL开始执行时间：20190906001748

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190906001748
SQL开始执行时间：20190906001748
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190906001750
SQL开始执行时间：20190906001750

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190906001750
SQL开始执行时间：20190906001750

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190906001751
SQL开始执行时间：20190906001751




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190906001752
SQL开始执行时间：20190906001752

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190906001753
SQL开始执行时间：20190906001753
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190906001753
SQL开始执行时间：20190906001753
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190906001755
SQL开始执行时间：20190906001755
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190906001755
SQL开始执行时间：20190906001755
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190906001757
SQL开始执行时间：20190906001757

truncate table pdm.ar_detail
;
SQL结束执行时间：20190906001757
SQL开始执行时间：20190906001757
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190906001759
SQL开始执行时间：20190906001759

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190906001759
SQL开始执行时间：20190906001759

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190906001759

20190906103337开始执行2019-09-06数据加载日志:
SQL开始执行时间：20190906103337

use pdm
;
SQL结束执行时间：20190906103337
SQL开始执行时间：20190906103337

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190906103337
SQL开始执行时间：20190906103337
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190906103337
SQL开始执行时间：20190906103337

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190906103337
SQL开始执行时间：20190906103337
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190906103338
SQL开始执行时间：20190906103338
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190906103340
SQL开始执行时间：20190906103340
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190906103342
SQL开始执行时间：20190906103342

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190906103342
SQL开始执行时间：20190906103342
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190906103343
SQL开始执行时间：20190906103343
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190906103344
SQL开始执行时间：20190906103344


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190906103344
SQL开始执行时间：20190906103344
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190906103357
SQL开始执行时间：20190906103357


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190906103357
SQL开始执行时间：20190906103357
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190906103358
SQL开始执行时间：20190906103358

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190906103359
SQL开始执行时间：20190906103359
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190906103401
SQL开始执行时间：20190906103401
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190906103403
SQL开始执行时间：20190906103403
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190906103405
SQL开始执行时间：20190906103405

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190906103405
SQL开始执行时间：20190906103405
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190906103405
SQL开始执行时间：20190906103405

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190906103405
SQL开始执行时间：20190906103405

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190906103405
SQL开始执行时间：20190906103405
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190906103406
SQL开始执行时间：20190906103406

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190906103406
SQL开始执行时间：20190906103406

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190906103406
SQL开始执行时间：20190906103406
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190906103408
SQL开始执行时间：20190906103408

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190906103408
SQL开始执行时间：20190906103408

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190906103410
SQL开始执行时间：20190906103410




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190906103410
SQL开始执行时间：20190906103410

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190906103411
SQL开始执行时间：20190906103411
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190906103412
SQL开始执行时间：20190906103412
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190906103413
SQL开始执行时间：20190906103413
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190906103414
SQL开始执行时间：20190906103414
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190906103415
SQL开始执行时间：20190906103415

truncate table pdm.ar_detail
;
SQL结束执行时间：20190906103415
SQL开始执行时间：20190906103415
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190906103417
SQL开始执行时间：20190906103417

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190906103417
SQL开始执行时间：20190906103417

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190906103417

20190906111820开始执行2019-09-06数据加载日志:
SQL开始执行时间：20190906111820

use pdm
;
SQL结束执行时间：20190906111820
SQL开始执行时间：20190906111820

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190906111820
SQL开始执行时间：20190906111820
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190906111820
SQL开始执行时间：20190906111820

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190906111820
SQL开始执行时间：20190906111820
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190906111822
SQL开始执行时间：20190906111822
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190906111824
SQL开始执行时间：20190906111824
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190906111826
SQL开始执行时间：20190906111826

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190906111826
SQL开始执行时间：20190906111826
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190906111827
SQL开始执行时间：20190906111827
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190906111827
SQL开始执行时间：20190906111827


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190906111827
SQL开始执行时间：20190906111827
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190906111840
SQL开始执行时间：20190906111840


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190906111840
SQL开始执行时间：20190906111840
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190906111841
SQL开始执行时间：20190906111841

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190906111843
SQL开始执行时间：20190906111843
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190906111844
SQL开始执行时间：20190906111844
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190906111846
SQL开始执行时间：20190906111846
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190906111848
SQL开始执行时间：20190906111848

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190906111848
SQL开始执行时间：20190906111848
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190906111848
SQL开始执行时间：20190906111848

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190906111849
SQL开始执行时间：20190906111849

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190906111849
SQL开始执行时间：20190906111849
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190906111849
SQL开始执行时间：20190906111849

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190906111849
SQL开始执行时间：20190906111849

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190906111849
SQL开始执行时间：20190906111849
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190906111851
SQL开始执行时间：20190906111851

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190906111851
SQL开始执行时间：20190906111851

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190906111853
SQL开始执行时间：20190906111853




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190906111853
SQL开始执行时间：20190906111853

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190906111855
SQL开始执行时间：20190906111855
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190906111855
SQL开始执行时间：20190906111855
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190906111857
SQL开始执行时间：20190906111857
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190906111857
SQL开始执行时间：20190906111857
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190906111859
SQL开始执行时间：20190906111859

truncate table pdm.ar_detail
;
SQL结束执行时间：20190906111859
SQL开始执行时间：20190906111859
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190906111900
SQL开始执行时间：20190906111900

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190906111900
SQL开始执行时间：20190906111900

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190906111901

20190907001717开始执行2019-09-06数据加载日志:
SQL开始执行时间：20190907001717

use pdm
;
SQL结束执行时间：20190907001717
SQL开始执行时间：20190907001717

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190907001717
SQL开始执行时间：20190907001717
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190907001717
SQL开始执行时间：20190907001717

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190907001717
SQL开始执行时间：20190907001717
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190907001719
SQL开始执行时间：20190907001719
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190907001722
SQL开始执行时间：20190907001722
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190907001725
SQL开始执行时间：20190907001725

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190907001725
SQL开始执行时间：20190907001725
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190907001726
SQL开始执行时间：20190907001726
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190907001727
SQL开始执行时间：20190907001727


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190907001727
SQL开始执行时间：20190907001727
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190907001740
SQL开始执行时间：20190907001740


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190907001740
SQL开始执行时间：20190907001740
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190907001741
SQL开始执行时间：20190907001741

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190907001743
SQL开始执行时间：20190907001743
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190907001745
SQL开始执行时间：20190907001745
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190907001746
SQL开始执行时间：20190907001746
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190907001748
SQL开始执行时间：20190907001748

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190907001748
SQL开始执行时间：20190907001748
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190907001749
SQL开始执行时间：20190907001749

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190907001749
SQL开始执行时间：20190907001749

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190907001749
SQL开始执行时间：20190907001749
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190907001749
SQL开始执行时间：20190907001749

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190907001750
SQL开始执行时间：20190907001750

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190907001750
SQL开始执行时间：20190907001750
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190907001752
SQL开始执行时间：20190907001752

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190907001752
SQL开始执行时间：20190907001752

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190907001753
SQL开始执行时间：20190907001753




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190907001754
SQL开始执行时间：20190907001754

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190907001755
SQL开始执行时间：20190907001755
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190907001755
SQL开始执行时间：20190907001755
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190907001757
SQL开始执行时间：20190907001757
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190907001757
SQL开始执行时间：20190907001757
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190907001759
SQL开始执行时间：20190907001759

truncate table pdm.ar_detail
;
SQL结束执行时间：20190907001759
SQL开始执行时间：20190907001759
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190907001801
SQL开始执行时间：20190907001801

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190907001801
SQL开始执行时间：20190907001801

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190907001801

20190908001718开始执行2019-09-07数据加载日志:
SQL开始执行时间：20190908001718

use pdm
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190908001718
SQL开始执行时间：20190908001718
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190908001720
SQL开始执行时间：20190908001720
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190908001723
SQL开始执行时间：20190908001723
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190908001726
SQL开始执行时间：20190908001726

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190908001726
SQL开始执行时间：20190908001726
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190908001727
SQL开始执行时间：20190908001727
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190908001727
SQL开始执行时间：20190908001727


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190908001727
SQL开始执行时间：20190908001727
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190908001741
SQL开始执行时间：20190908001741


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190908001741
SQL开始执行时间：20190908001741
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190908001742
SQL开始执行时间：20190908001742

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190908001743
SQL开始执行时间：20190908001743
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190908001745
SQL开始执行时间：20190908001745
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190908001747
SQL开始执行时间：20190908001747
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190908001749
SQL开始执行时间：20190908001749

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190908001749
SQL开始执行时间：20190908001749
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190908001749
SQL开始执行时间：20190908001749

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190908001749
SQL开始执行时间：20190908001749

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190908001749
SQL开始执行时间：20190908001749
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190908001750
SQL开始执行时间：20190908001750

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190908001750
SQL开始执行时间：20190908001750

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190908001750
SQL开始执行时间：20190908001750
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190908001752
SQL开始执行时间：20190908001752

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190908001752
SQL开始执行时间：20190908001752

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190908001754
SQL开始执行时间：20190908001754




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190908001754
SQL开始执行时间：20190908001754

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190908001756
SQL开始执行时间：20190908001756
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190908001756
SQL开始执行时间：20190908001756
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190908001758
SQL开始执行时间：20190908001758
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190908001758
SQL开始执行时间：20190908001758
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190908001800
SQL开始执行时间：20190908001800

truncate table pdm.ar_detail
;
SQL结束执行时间：20190908001800
SQL开始执行时间：20190908001800
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190908001801
SQL开始执行时间：20190908001801

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190908001801
SQL开始执行时间：20190908001801

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190908001802

20190909001714开始执行2019-09-08数据加载日志:
SQL开始执行时间：20190909001714

use pdm
;
SQL结束执行时间：20190909001714
SQL开始执行时间：20190909001714

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190909001714
SQL开始执行时间：20190909001714
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190909001714
SQL开始执行时间：20190909001714

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190909001714
SQL开始执行时间：20190909001714
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190909001716
SQL开始执行时间：20190909001716
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190909001718
SQL开始执行时间：20190909001718
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190909001721
SQL开始执行时间：20190909001721

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190909001721
SQL开始执行时间：20190909001721
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190909001722
SQL开始执行时间：20190909001722
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190909001722
SQL开始执行时间：20190909001722


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190909001722
SQL开始执行时间：20190909001722
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190909001736
SQL开始执行时间：20190909001736


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190909001736
SQL开始执行时间：20190909001736
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190909001737
SQL开始执行时间：20190909001737

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190909001738
SQL开始执行时间：20190909001738
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190909001740
SQL开始执行时间：20190909001740
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190909001742
SQL开始执行时间：20190909001742
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190909001744
SQL开始执行时间：20190909001744

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190909001744
SQL开始执行时间：20190909001744
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190909001744
SQL开始执行时间：20190909001744

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190909001744
SQL开始执行时间：20190909001744

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190909001744
SQL开始执行时间：20190909001744
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190909001745
SQL开始执行时间：20190909001745

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190909001745
SQL开始执行时间：20190909001745

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190909001745
SQL开始执行时间：20190909001745
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190909001747
SQL开始执行时间：20190909001747

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190909001747
SQL开始执行时间：20190909001747

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190909001749
SQL开始执行时间：20190909001749




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190909001749
SQL开始执行时间：20190909001749

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190909001751
SQL开始执行时间：20190909001751
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190909001751
SQL开始执行时间：20190909001751
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190909001752
SQL开始执行时间：20190909001752
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190909001753
SQL开始执行时间：20190909001753
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190909001754
SQL开始执行时间：20190909001754

truncate table pdm.ar_detail
;
SQL结束执行时间：20190909001754
SQL开始执行时间：20190909001754
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190909001756
SQL开始执行时间：20190909001756

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190909001756
SQL开始执行时间：20190909001756

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190909001756

20190910001712开始执行2019-09-09数据加载日志:
SQL开始执行时间：20190910001712

use pdm
;
SQL结束执行时间：20190910001712
SQL开始执行时间：20190910001712

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190910001712
SQL开始执行时间：20190910001712
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190910001713
SQL开始执行时间：20190910001713

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190910001713
SQL开始执行时间：20190910001713
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190910001714
SQL开始执行时间：20190910001714
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190910001716
SQL开始执行时间：20190910001716
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190910001720
SQL开始执行时间：20190910001720

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190910001720
SQL开始执行时间：20190910001720
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190910001721
SQL开始执行时间：20190910001721
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190910001722
SQL开始执行时间：20190910001722


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190910001722
SQL开始执行时间：20190910001722
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190910001735
SQL开始执行时间：20190910001735


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190910001735
SQL开始执行时间：20190910001735
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190910001736
SQL开始执行时间：20190910001736

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190910001737
SQL开始执行时间：20190910001737
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190910001739
SQL开始执行时间：20190910001739
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190910001741
SQL开始执行时间：20190910001741
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190910001743
SQL开始执行时间：20190910001743

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190910001743
SQL开始执行时间：20190910001743
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190910001743
SQL开始执行时间：20190910001743

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190910001743
SQL开始执行时间：20190910001743

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190910001743
SQL开始执行时间：20190910001743
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190910001744
SQL开始执行时间：20190910001744

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190910001744
SQL开始执行时间：20190910001744

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190910001744
SQL开始执行时间：20190910001744
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190910001746
SQL开始执行时间：20190910001746

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190910001746
SQL开始执行时间：20190910001746

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190910001748
SQL开始执行时间：20190910001748




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190910001748
SQL开始执行时间：20190910001748

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190910001749
SQL开始执行时间：20190910001749
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190910001750
SQL开始执行时间：20190910001750
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190910001751
SQL开始执行时间：20190910001751
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190910001752
SQL开始执行时间：20190910001752
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190910001753
SQL开始执行时间：20190910001753

truncate table pdm.ar_detail
;
SQL结束执行时间：20190910001753
SQL开始执行时间：20190910001753
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190910001755
SQL开始执行时间：20190910001755

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190910001755
SQL开始执行时间：20190910001755

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190910001755

20190911001712开始执行2019-09-10数据加载日志:
SQL开始执行时间：20190911001712

use pdm
;
SQL结束执行时间：20190911001712
SQL开始执行时间：20190911001712

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190911001712
SQL开始执行时间：20190911001712
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190911001712
SQL开始执行时间：20190911001712

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190911001712
SQL开始执行时间：20190911001712
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190911001713
SQL开始执行时间：20190911001713
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190911001715
SQL开始执行时间：20190911001715
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190911001718
SQL开始执行时间：20190911001718

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190911001718
SQL开始执行时间：20190911001718
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190911001719
SQL开始执行时间：20190911001719
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190911001720
SQL开始执行时间：20190911001720


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190911001720
SQL开始执行时间：20190911001720
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190911001733
SQL开始执行时间：20190911001733


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190911001733
SQL开始执行时间：20190911001733
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190911001734
SQL开始执行时间：20190911001734

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190911001736
SQL开始执行时间：20190911001736
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190911001737
SQL开始执行时间：20190911001737
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190911001739
SQL开始执行时间：20190911001739
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190911001741
SQL开始执行时间：20190911001741

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190911001741
SQL开始执行时间：20190911001741
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190911001741
SQL开始执行时间：20190911001741

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190911001742
SQL开始执行时间：20190911001742

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190911001742
SQL开始执行时间：20190911001742
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190911001742
SQL开始执行时间：20190911001742

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190911001742
SQL开始执行时间：20190911001742

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190911001742
SQL开始执行时间：20190911001742
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190911001744
SQL开始执行时间：20190911001744

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190911001744
SQL开始执行时间：20190911001744

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190911001746
SQL开始执行时间：20190911001746




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190911001746
SQL开始执行时间：20190911001746

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190911001748
SQL开始执行时间：20190911001748
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190911001748
SQL开始执行时间：20190911001748
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190911001750
SQL开始执行时间：20190911001750
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190911001750
SQL开始执行时间：20190911001750
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190911001752
SQL开始执行时间：20190911001752

truncate table pdm.ar_detail
;
SQL结束执行时间：20190911001752
SQL开始执行时间：20190911001752
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190911001753
SQL开始执行时间：20190911001753

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190911001753
SQL开始执行时间：20190911001753

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190911001754

20190912001723开始执行2019-09-11数据加载日志:
SQL开始执行时间：20190912001723

use pdm
;
SQL结束执行时间：20190912001723
SQL开始执行时间：20190912001723

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190912001723
SQL开始执行时间：20190912001723
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190912001723
SQL开始执行时间：20190912001723

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190912001723
SQL开始执行时间：20190912001723
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190912001724
SQL开始执行时间：20190912001724
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190912001727
SQL开始执行时间：20190912001727
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190912001730
SQL开始执行时间：20190912001730

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190912001730
SQL开始执行时间：20190912001730
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190912001732
SQL开始执行时间：20190912001732
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190912001732
SQL开始执行时间：20190912001732


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190912001732
SQL开始执行时间：20190912001732
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190912001745
SQL开始执行时间：20190912001745


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190912001745
SQL开始执行时间：20190912001745
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190912001747
SQL开始执行时间：20190912001747

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190912001748
SQL开始执行时间：20190912001748
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190912001750
SQL开始执行时间：20190912001750
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190912001752
SQL开始执行时间：20190912001752
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190912001754
SQL开始执行时间：20190912001754

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190912001754
SQL开始执行时间：20190912001754
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190912001754
SQL开始执行时间：20190912001754

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190912001754
SQL开始执行时间：20190912001754

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190912001754
SQL开始执行时间：20190912001754
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190912001754
SQL开始执行时间：20190912001754

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190912001755
SQL开始执行时间：20190912001755

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190912001755
SQL开始执行时间：20190912001755
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190912001757
SQL开始执行时间：20190912001757

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190912001757
SQL开始执行时间：20190912001757

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190912001758
SQL开始执行时间：20190912001758




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190912001759
SQL开始执行时间：20190912001759

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190912001800
SQL开始执行时间：20190912001800
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190912001801
SQL开始执行时间：20190912001801
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190912001802
SQL开始执行时间：20190912001802
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190912001802
SQL开始执行时间：20190912001802
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190912001804
SQL开始执行时间：20190912001804

truncate table pdm.ar_detail
;
SQL结束执行时间：20190912001804
SQL开始执行时间：20190912001804
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190912001806
SQL开始执行时间：20190912001806

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190912001806
SQL开始执行时间：20190912001806

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190912001806

20190913001720开始执行2019-09-12数据加载日志:
SQL开始执行时间：20190913001720

use pdm
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190913001720
SQL开始执行时间：20190913001720
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190913001722
SQL开始执行时间：20190913001722
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190913001724
SQL开始执行时间：20190913001724
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190913001728
SQL开始执行时间：20190913001728

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190913001728
SQL开始执行时间：20190913001728
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190913001729
SQL开始执行时间：20190913001729
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190913001730
SQL开始执行时间：20190913001730


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190913001730
SQL开始执行时间：20190913001730
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190913001743
SQL开始执行时间：20190913001743


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190913001743
SQL开始执行时间：20190913001743
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190913001744
SQL开始执行时间：20190913001744

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190913001746
SQL开始执行时间：20190913001746
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190913001748
SQL开始执行时间：20190913001748
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190913001750
SQL开始执行时间：20190913001750
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190913001752
SQL开始执行时间：20190913001752

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190913001752
SQL开始执行时间：20190913001752
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190913001752
SQL开始执行时间：20190913001752

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190913001752
SQL开始执行时间：20190913001752

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190913001752
SQL开始执行时间：20190913001752
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190913001752
SQL开始执行时间：20190913001752

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190913001753
SQL开始执行时间：20190913001753

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190913001753
SQL开始执行时间：20190913001753
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190913001755
SQL开始执行时间：20190913001755

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190913001755
SQL开始执行时间：20190913001755

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190913001757
SQL开始执行时间：20190913001757




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190913001757
SQL开始执行时间：20190913001757

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190913001758
SQL开始执行时间：20190913001758
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190913001759
SQL开始执行时间：20190913001759
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190913001800
SQL开始执行时间：20190913001800
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190913001801
SQL开始执行时间：20190913001801
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190913001802
SQL开始执行时间：20190913001802

truncate table pdm.ar_detail
;
SQL结束执行时间：20190913001802
SQL开始执行时间：20190913001802
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190913001804
SQL开始执行时间：20190913001804

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190913001804
SQL开始执行时间：20190913001804

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190913001804

20190916160930开始执行2019-09-15数据加载日志:
SQL开始执行时间：20190916160930

use pdm
;
SQL结束执行时间：20190916160930
SQL开始执行时间：20190916160930

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190916160930
SQL开始执行时间：20190916160930
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190916160930
SQL开始执行时间：20190916160930

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190916160930
SQL开始执行时间：20190916160930
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190916160932
SQL开始执行时间：20190916160932
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190916160934
SQL开始执行时间：20190916160934
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190916160936
SQL开始执行时间：20190916160936

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190916160936
SQL开始执行时间：20190916160936
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190916160937
SQL开始执行时间：20190916160937
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190916160937
SQL开始执行时间：20190916160937


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190916160937
SQL开始执行时间：20190916160937
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190916160951
SQL开始执行时间：20190916160951


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190916160951
SQL开始执行时间：20190916160951
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190916160953
SQL开始执行时间：20190916160953

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190916160954
SQL开始执行时间：20190916160954
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190916160956
SQL开始执行时间：20190916160956
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190916160958
SQL开始执行时间：20190916160958
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190916161000
SQL开始执行时间：20190916161000

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190916161000
SQL开始执行时间：20190916161000
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190916161000
SQL开始执行时间：20190916161000

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190916161000
SQL开始执行时间：20190916161000

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190916161000
SQL开始执行时间：20190916161000
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190916161001
SQL开始执行时间：20190916161001

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190916161001
SQL开始执行时间：20190916161001

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190916161001
SQL开始执行时间：20190916161001
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190916161003
SQL开始执行时间：20190916161003

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190916161003
SQL开始执行时间：20190916161003

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190916161005
SQL开始执行时间：20190916161005




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190916161005
SQL开始执行时间：20190916161005

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190916161007
SQL开始执行时间：20190916161007
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190916161007
SQL开始执行时间：20190916161007
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190916161008
SQL开始执行时间：20190916161008
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190916161009
SQL开始执行时间：20190916161009
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190916161011
SQL开始执行时间：20190916161011

truncate table pdm.ar_detail
;
SQL结束执行时间：20190916161011
SQL开始执行时间：20190916161011
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190916161013
SQL开始执行时间：20190916161013

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190916161013
SQL开始执行时间：20190916161013

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190916161013

20190917001718开始执行2019-09-16数据加载日志:
SQL开始执行时间：20190917001718

use pdm
;
SQL结束执行时间：20190917001718
SQL开始执行时间：20190917001718

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190917001718
SQL开始执行时间：20190917001718
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190917001718
SQL开始执行时间：20190917001718

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190917001718
SQL开始执行时间：20190917001718
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190917001719
SQL开始执行时间：20190917001719
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190917001722
SQL开始执行时间：20190917001722
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190917001725
SQL开始执行时间：20190917001725

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190917001725
SQL开始执行时间：20190917001725
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190917001726
SQL开始执行时间：20190917001726
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190917001727
SQL开始执行时间：20190917001727


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190917001727
SQL开始执行时间：20190917001727
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190917001741
SQL开始执行时间：20190917001741


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190917001741
SQL开始执行时间：20190917001741
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190917001742
SQL开始执行时间：20190917001742

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190917001744
SQL开始执行时间：20190917001744
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190917001746
SQL开始执行时间：20190917001746
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190917001748
SQL开始执行时间：20190917001748
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190917001751
SQL开始执行时间：20190917001751

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190917001751
SQL开始执行时间：20190917001751
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190917001751
SQL开始执行时间：20190917001751

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190917001751
SQL开始执行时间：20190917001751

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190917001751
SQL开始执行时间：20190917001751
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190917001752
SQL开始执行时间：20190917001752

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190917001753
SQL开始执行时间：20190917001753

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190917001753
SQL开始执行时间：20190917001753
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190917001755
SQL开始执行时间：20190917001755

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190917001755
SQL开始执行时间：20190917001755

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190917001757
SQL开始执行时间：20190917001757




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190917001757
SQL开始执行时间：20190917001757

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190917001758
SQL开始执行时间：20190917001758
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190917001759
SQL开始执行时间：20190917001759
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190917001800
SQL开始执行时间：20190917001800
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190917001801
SQL开始执行时间：20190917001801
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190917001803
SQL开始执行时间：20190917001803

truncate table pdm.ar_detail
;
SQL结束执行时间：20190917001803
SQL开始执行时间：20190917001803
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190917001805
SQL开始执行时间：20190917001805

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190917001805
SQL开始执行时间：20190917001805

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190917001805

20190918001723开始执行2019-09-17数据加载日志:
SQL开始执行时间：20190918001723

use pdm
;
SQL结束执行时间：20190918001723
SQL开始执行时间：20190918001723

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190918001723
SQL开始执行时间：20190918001723
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190918001723
SQL开始执行时间：20190918001723

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190918001723
SQL开始执行时间：20190918001723
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190918001725
SQL开始执行时间：20190918001725
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190918001727
SQL开始执行时间：20190918001727
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190918001730
SQL开始执行时间：20190918001730

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190918001730
SQL开始执行时间：20190918001730
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190918001732
SQL开始执行时间：20190918001732
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190918001733
SQL开始执行时间：20190918001733


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190918001733
SQL开始执行时间：20190918001733
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190918001747
SQL开始执行时间：20190918001747


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190918001747
SQL开始执行时间：20190918001747
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190918001748
SQL开始执行时间：20190918001748

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190918001750
SQL开始执行时间：20190918001750
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190918001752
SQL开始执行时间：20190918001752
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190918001754
SQL开始执行时间：20190918001754
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190918001757
SQL开始执行时间：20190918001757

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190918001757
SQL开始执行时间：20190918001757
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190918001757
SQL开始执行时间：20190918001757

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190918001757
SQL开始执行时间：20190918001757

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190918001757
SQL开始执行时间：20190918001757
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190918001758
SQL开始执行时间：20190918001758

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190918001758
SQL开始执行时间：20190918001758

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190918001758
SQL开始执行时间：20190918001758
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190918001801
SQL开始执行时间：20190918001801

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190918001801
SQL开始执行时间：20190918001801

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190918001802
SQL开始执行时间：20190918001802




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190918001803
SQL开始执行时间：20190918001803

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190918001804
SQL开始执行时间：20190918001804
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190918001805
SQL开始执行时间：20190918001805
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190918001806
SQL开始执行时间：20190918001806
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190918001807
SQL开始执行时间：20190918001807
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190918001808
SQL开始执行时间：20190918001808

truncate table pdm.ar_detail
;
SQL结束执行时间：20190918001808
SQL开始执行时间：20190918001808
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190918001810
SQL开始执行时间：20190918001810

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190918001810
SQL开始执行时间：20190918001810

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190918001810

20190919001716开始执行2019-09-18数据加载日志:
SQL开始执行时间：20190919001716

use pdm
;
SQL结束执行时间：20190919001716
SQL开始执行时间：20190919001716

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190919001716
SQL开始执行时间：20190919001716
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190919001716
SQL开始执行时间：20190919001716

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190919001716
SQL开始执行时间：20190919001716
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190919001718
SQL开始执行时间：20190919001718
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190919001720
SQL开始执行时间：20190919001720
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190919001723
SQL开始执行时间：20190919001723

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190919001723
SQL开始执行时间：20190919001723
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190919001725
SQL开始执行时间：20190919001725
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190919001725
SQL开始执行时间：20190919001725


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190919001725
SQL开始执行时间：20190919001725
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190919001739
SQL开始执行时间：20190919001739


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190919001739
SQL开始执行时间：20190919001739
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190919001740
SQL开始执行时间：20190919001740

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190919001742
SQL开始执行时间：20190919001742
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190919001744
SQL开始执行时间：20190919001744
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190919001746
SQL开始执行时间：20190919001746
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190919001749
SQL开始执行时间：20190919001749

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190919001749
SQL开始执行时间：20190919001749
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190919001749
SQL开始执行时间：20190919001749

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190919001749
SQL开始执行时间：20190919001749

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190919001749
SQL开始执行时间：20190919001749
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190919001750
SQL开始执行时间：20190919001750

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190919001750
SQL开始执行时间：20190919001750

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190919001750
SQL开始执行时间：20190919001750
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190919001753
SQL开始执行时间：20190919001753

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190919001753
SQL开始执行时间：20190919001753

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190919001755
SQL开始执行时间：20190919001755




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190919001755
SQL开始执行时间：20190919001755

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190919001757
SQL开始执行时间：20190919001757
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190919001757
SQL开始执行时间：20190919001757
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190919001758
SQL开始执行时间：20190919001758
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190919001759
SQL开始执行时间：20190919001759
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190919001801
SQL开始执行时间：20190919001801

truncate table pdm.ar_detail
;
SQL结束执行时间：20190919001801
SQL开始执行时间：20190919001801
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190919001802
SQL开始执行时间：20190919001802

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190919001802
SQL开始执行时间：20190919001802

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190919001803

20190920001724开始执行2019-09-19数据加载日志:
SQL开始执行时间：20190920001724

use pdm
;
SQL结束执行时间：20190920001724
SQL开始执行时间：20190920001724

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190920001724
SQL开始执行时间：20190920001724
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190920001724
SQL开始执行时间：20190920001724

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190920001724
SQL开始执行时间：20190920001724
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190920001726
SQL开始执行时间：20190920001726
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190920001727
SQL开始执行时间：20190920001727
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190920001730
SQL开始执行时间：20190920001730

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190920001730
SQL开始执行时间：20190920001730
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190920001730
SQL开始执行时间：20190920001730
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190920001731
SQL开始执行时间：20190920001731
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190920001745
SQL开始执行时间：20190920001745
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190920001746
SQL开始执行时间：20190920001746

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190920001748
SQL开始执行时间：20190920001748
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190920001750
SQL开始执行时间：20190920001750
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190920001753
SQL开始执行时间：20190920001753
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190920001755
SQL开始执行时间：20190920001755

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190920001755
SQL开始执行时间：20190920001755
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190920001756
SQL开始执行时间：20190920001756

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190920001756
SQL开始执行时间：20190920001756

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190920001756
SQL开始执行时间：20190920001756
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190920001757
SQL开始执行时间：20190920001757

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190920001757
SQL开始执行时间：20190920001757

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190920001757
SQL开始执行时间：20190920001757
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190920001759
SQL开始执行时间：20190920001759

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190920001800
SQL开始执行时间：20190920001800

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190920001801
SQL开始执行时间：20190920001801




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190920001802
SQL开始执行时间：20190920001802

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190920001804
SQL开始执行时间：20190920001804
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190920001804
SQL开始执行时间：20190920001804
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190920001806
SQL开始执行时间：20190920001806
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190920001806
SQL开始执行时间：20190920001806
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190920001808
SQL开始执行时间：20190920001808

truncate table pdm.ar_detail
;
SQL结束执行时间：20190920001808
SQL开始执行时间：20190920001808
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190920001810
SQL开始执行时间：20190920001810

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190920001810
SQL开始执行时间：20190920001810

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190920001810

20190921001723开始执行2019-09-20数据加载日志:
SQL开始执行时间：20190921001723

use pdm
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190921001723
SQL开始执行时间：20190921001723
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190921001725
SQL开始执行时间：20190921001725
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190921001728
SQL开始执行时间：20190921001728
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190921001731
SQL开始执行时间：20190921001731

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190921001731
SQL开始执行时间：20190921001731
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190921001732
SQL开始执行时间：20190921001732
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190921001732
SQL开始执行时间：20190921001732


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190921001732
SQL开始执行时间：20190921001732
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190921001746
SQL开始执行时间：20190921001746


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190921001746
SQL开始执行时间：20190921001746
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190921001747
SQL开始执行时间：20190921001747

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190921001749
SQL开始执行时间：20190921001749
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190921001751
SQL开始执行时间：20190921001751
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190921001753
SQL开始执行时间：20190921001753
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190921001756
SQL开始执行时间：20190921001756

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190921001756
SQL开始执行时间：20190921001756
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190921001756
SQL开始执行时间：20190921001756

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190921001756
SQL开始执行时间：20190921001756

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190921001756
SQL开始执行时间：20190921001756
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190921001757
SQL开始执行时间：20190921001757

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190921001757
SQL开始执行时间：20190921001757

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190921001757
SQL开始执行时间：20190921001757
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190921001759
SQL开始执行时间：20190921001759

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190921001759
SQL开始执行时间：20190921001759

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190921001801
SQL开始执行时间：20190921001801




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190921001801
SQL开始执行时间：20190921001801

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190921001803
SQL开始执行时间：20190921001803
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190921001803
SQL开始执行时间：20190921001803
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190921001805
SQL开始执行时间：20190921001805
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190921001805
SQL开始执行时间：20190921001805
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190921001807
SQL开始执行时间：20190921001807

truncate table pdm.ar_detail
;
SQL结束执行时间：20190921001807
SQL开始执行时间：20190921001807
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190921001809
SQL开始执行时间：20190921001809

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190921001809
SQL开始执行时间：20190921001809

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190921001809

20190922001722开始执行2019-09-21数据加载日志:
SQL开始执行时间：20190922001722

use pdm
;
SQL结束执行时间：20190922001722
SQL开始执行时间：20190922001722

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190922001722
SQL开始执行时间：20190922001722
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190922001722
SQL开始执行时间：20190922001722

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190922001722
SQL开始执行时间：20190922001722
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190922001723
SQL开始执行时间：20190922001723
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190922001725
SQL开始执行时间：20190922001725
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190922001727
SQL开始执行时间：20190922001727

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190922001728
SQL开始执行时间：20190922001728
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190922001729
SQL开始执行时间：20190922001729
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190922001743
SQL开始执行时间：20190922001743


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190922001743
SQL开始执行时间：20190922001743
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190922001745
SQL开始执行时间：20190922001745

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190922001747
SQL开始执行时间：20190922001747
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190922001750
SQL开始执行时间：20190922001750
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190922001752
SQL开始执行时间：20190922001752
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190922001754
SQL开始执行时间：20190922001754

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190922001754
SQL开始执行时间：20190922001754
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190922001754
SQL开始执行时间：20190922001754

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190922001755
SQL开始执行时间：20190922001755

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190922001755
SQL开始执行时间：20190922001755
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190922001755
SQL开始执行时间：20190922001755

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190922001756
SQL开始执行时间：20190922001756

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190922001756
SQL开始执行时间：20190922001756
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190922001758
SQL开始执行时间：20190922001758

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190922001758
SQL开始执行时间：20190922001758

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190922001800
SQL开始执行时间：20190922001800




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190922001801
SQL开始执行时间：20190922001801

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190922001802
SQL开始执行时间：20190922001802
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190922001803
SQL开始执行时间：20190922001803
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190922001804
SQL开始执行时间：20190922001804
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190922001805
SQL开始执行时间：20190922001805
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190922001807
SQL开始执行时间：20190922001807

truncate table pdm.ar_detail
;
SQL结束执行时间：20190922001807
SQL开始执行时间：20190922001807
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190922001808
SQL开始执行时间：20190922001808

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190922001808
SQL开始执行时间：20190922001808

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190922001809

20190923001730开始执行2019-09-22数据加载日志:
SQL开始执行时间：20190923001730

use pdm
;
SQL结束执行时间：20190923001730
SQL开始执行时间：20190923001730

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190923001730
SQL开始执行时间：20190923001730
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190923001730
SQL开始执行时间：20190923001730

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190923001730
SQL开始执行时间：20190923001730
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190923001732
SQL开始执行时间：20190923001732
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190923001734
SQL开始执行时间：20190923001734
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190923001736
SQL开始执行时间：20190923001736

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190923001736
SQL开始执行时间：20190923001736
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190923001737
SQL开始执行时间：20190923001737
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190923001737
SQL开始执行时间：20190923001737


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190923001737
SQL开始执行时间：20190923001737
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190923001750
SQL开始执行时间：20190923001750


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190923001750
SQL开始执行时间：20190923001750
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190923001751
SQL开始执行时间：20190923001751

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190923001753
SQL开始执行时间：20190923001753
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190923001754
SQL开始执行时间：20190923001754
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190923001756
SQL开始执行时间：20190923001756
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190923001758
SQL开始执行时间：20190923001758

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190923001758
SQL开始执行时间：20190923001758
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190923001758
SQL开始执行时间：20190923001758

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190923001758
SQL开始执行时间：20190923001758

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190923001758
SQL开始执行时间：20190923001758
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190923001759
SQL开始执行时间：20190923001759

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190923001759
SQL开始执行时间：20190923001759

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190923001759
SQL开始执行时间：20190923001759
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190923001801
SQL开始执行时间：20190923001801

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190923001801
SQL开始执行时间：20190923001801

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190923001803
SQL开始执行时间：20190923001803




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190923001803
SQL开始执行时间：20190923001803

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190923001804
SQL开始执行时间：20190923001804
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190923001805
SQL开始执行时间：20190923001805
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190923001806
SQL开始执行时间：20190923001806
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190923001806
SQL开始执行时间：20190923001806
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190923001808
SQL开始执行时间：20190923001808

truncate table pdm.ar_detail
;
SQL结束执行时间：20190923001808
SQL开始执行时间：20190923001808
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190923001810
SQL开始执行时间：20190923001810

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190923001810
SQL开始执行时间：20190923001810

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190923001810

20190924001737开始执行2019-09-23数据加载日志:
SQL开始执行时间：20190924001737

use pdm
;
SQL结束执行时间：20190924001737
SQL开始执行时间：20190924001737

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190924001737
SQL开始执行时间：20190924001737
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190924001737
SQL开始执行时间：20190924001737

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190924001737
SQL开始执行时间：20190924001737
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190924001739
SQL开始执行时间：20190924001739
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190924001742
SQL开始执行时间：20190924001742
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190924001745
SQL开始执行时间：20190924001745

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190924001745
SQL开始执行时间：20190924001745
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190924001746
SQL开始执行时间：20190924001746
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190924001747
SQL开始执行时间：20190924001747


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190924001747
SQL开始执行时间：20190924001747
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190924001802
SQL开始执行时间：20190924001802


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190924001802
SQL开始执行时间：20190924001802
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190924001803
SQL开始执行时间：20190924001803

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190924001805
SQL开始执行时间：20190924001805
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190924001807
SQL开始执行时间：20190924001807
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190924001809
SQL开始执行时间：20190924001809
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190924001811
SQL开始执行时间：20190924001811

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190924001811
SQL开始执行时间：20190924001811
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190924001811
SQL开始执行时间：20190924001811

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190924001811
SQL开始执行时间：20190924001811

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190924001811
SQL开始执行时间：20190924001811
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190924001812
SQL开始执行时间：20190924001812

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190924001812
SQL开始执行时间：20190924001812

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190924001812
SQL开始执行时间：20190924001812
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190924001814
SQL开始执行时间：20190924001814

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190924001814
SQL开始执行时间：20190924001814

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190924001816
SQL开始执行时间：20190924001816




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190924001816
SQL开始执行时间：20190924001816

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190924001818
SQL开始执行时间：20190924001818
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190924001818
SQL开始执行时间：20190924001818
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190924001820
SQL开始执行时间：20190924001820
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190924001820
SQL开始执行时间：20190924001820
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190924001822
SQL开始执行时间：20190924001822

truncate table pdm.ar_detail
;
SQL结束执行时间：20190924001822
SQL开始执行时间：20190924001822
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190924001824
SQL开始执行时间：20190924001824

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190924001824
SQL开始执行时间：20190924001824

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190924001824

20190924093941开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924093941

use pdm
;
SQL结束执行时间：20190924093941
SQL开始执行时间：20190924093941

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190924093941
SQL开始执行时间：20190924093941
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190924093941
SQL开始执行时间：20190924093941

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190924093941
SQL开始执行时间：20190924093941
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190924093942
SQL开始执行时间：20190924093942
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190924093944
SQL开始执行时间：20190924093944
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190924093946
SQL开始执行时间：20190924093946

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190924093946
SQL开始执行时间：20190924093946
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190924093947
SQL开始执行时间：20190924093947
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190924093948
SQL开始执行时间：20190924093948


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190924093948
SQL开始执行时间：20190924093948
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190924094001
SQL开始执行时间：20190924094001


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190924094001
SQL开始执行时间：20190924094001
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190924094002
SQL开始执行时间：20190924094002

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190924094004
SQL开始执行时间：20190924094004
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190924094006
SQL开始执行时间：20190924094006
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190924094007
SQL开始执行时间：20190924094007
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190924094009
SQL开始执行时间：20190924094009

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190924094009
SQL开始执行时间：20190924094009
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190924094010
SQL开始执行时间：20190924094010

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190924094010
SQL开始执行时间：20190924094010

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190924094010
SQL开始执行时间：20190924094010
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190924094010
SQL开始执行时间：20190924094010

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190924094011
SQL开始执行时间：20190924094011

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190924094011
SQL开始执行时间：20190924094011
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190924094013
SQL开始执行时间：20190924094013

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190924094013
SQL开始执行时间：20190924094013

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190924094015
SQL开始执行时间：20190924094015




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190924094015
SQL开始执行时间：20190924094015

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190924094016
SQL开始执行时间：20190924094016
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190924094017
SQL开始执行时间：20190924094017
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190924094018
SQL开始执行时间：20190924094018
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190924094019
SQL开始执行时间：20190924094019
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190924094021
SQL开始执行时间：20190924094021

truncate table pdm.ar_detail
;
SQL结束执行时间：20190924094021
SQL开始执行时间：20190924094021
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190924094022
SQL开始执行时间：20190924094022

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190924094022
SQL开始执行时间：20190924094022

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190924094022

20190925001730开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190925001730

use pdm
;
SQL结束执行时间：20190925001730
SQL开始执行时间：20190925001730

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190925001730
SQL开始执行时间：20190925001730
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190925001730
SQL开始执行时间：20190925001730

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190925001730
SQL开始执行时间：20190925001730
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190925001732
SQL开始执行时间：20190925001732
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190925001733
SQL开始执行时间：20190925001733
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190925001735
SQL开始执行时间：20190925001735

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190925001735
SQL开始执行时间：20190925001735
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190925001736
SQL开始执行时间：20190925001736
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190925001737
SQL开始执行时间：20190925001737


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190925001737
SQL开始执行时间：20190925001737
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190925001751
SQL开始执行时间：20190925001751


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190925001751
SQL开始执行时间：20190925001751
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190925001752
SQL开始执行时间：20190925001752

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190925001753
SQL开始执行时间：20190925001753
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190925001755
SQL开始执行时间：20190925001755
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190925001756
SQL开始执行时间：20190925001756
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190925001758
SQL开始执行时间：20190925001758

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190925001758
SQL开始执行时间：20190925001758
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190925001759
SQL开始执行时间：20190925001759

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190925001759
SQL开始执行时间：20190925001759

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190925001759
SQL开始执行时间：20190925001759
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190925001759
SQL开始执行时间：20190925001759

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190925001800
SQL开始执行时间：20190925001800

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190925001800
SQL开始执行时间：20190925001800
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190925001802
SQL开始执行时间：20190925001802

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190925001802
SQL开始执行时间：20190925001802

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190925001803
SQL开始执行时间：20190925001803




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190925001804
SQL开始执行时间：20190925001804

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190925001805
SQL开始执行时间：20190925001805
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190925001805
SQL开始执行时间：20190925001805
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190925001807
SQL开始执行时间：20190925001807
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190925001807
SQL开始执行时间：20190925001807
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190925001809
SQL开始执行时间：20190925001809

truncate table pdm.ar_detail
;
SQL结束执行时间：20190925001809
SQL开始执行时间：20190925001809
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190925001811
SQL开始执行时间：20190925001811

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190925001811
SQL开始执行时间：20190925001811

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190925001811

20190926001735开始执行2019-09-25数据加载日志:
SQL开始执行时间：20190926001735

use pdm
;
SQL结束执行时间：20190926001735
SQL开始执行时间：20190926001735

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190926001735
SQL开始执行时间：20190926001735
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190926001735
SQL开始执行时间：20190926001735

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190926001735
SQL开始执行时间：20190926001735
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190926001737
SQL开始执行时间：20190926001737
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190926001739
SQL开始执行时间：20190926001739
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190926001742
SQL开始执行时间：20190926001742

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190926001742
SQL开始执行时间：20190926001742
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190926001743
SQL开始执行时间：20190926001743
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190926001744
SQL开始执行时间：20190926001744


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190926001744
SQL开始执行时间：20190926001744
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190926001758
SQL开始执行时间：20190926001758


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190926001758
SQL开始执行时间：20190926001758
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190926001800
SQL开始执行时间：20190926001800

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190926001802
SQL开始执行时间：20190926001802
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190926001804
SQL开始执行时间：20190926001804
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190926001806
SQL开始执行时间：20190926001806
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190926001808
SQL开始执行时间：20190926001808

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190926001808
SQL开始执行时间：20190926001808
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190926001809
SQL开始执行时间：20190926001809

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190926001809
SQL开始执行时间：20190926001809

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190926001809
SQL开始执行时间：20190926001809
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190926001809
SQL开始执行时间：20190926001809

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190926001810
SQL开始执行时间：20190926001810

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190926001810
SQL开始执行时间：20190926001810
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190926001812
SQL开始执行时间：20190926001812

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190926001812
SQL开始执行时间：20190926001812

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190926001814
SQL开始执行时间：20190926001814




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190926001814
SQL开始执行时间：20190926001814

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190926001816
SQL开始执行时间：20190926001816
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190926001816
SQL开始执行时间：20190926001816
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190926001818
SQL开始执行时间：20190926001818
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190926001818
SQL开始执行时间：20190926001818
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190926001820
SQL开始执行时间：20190926001820

truncate table pdm.ar_detail
;
SQL结束执行时间：20190926001820
SQL开始执行时间：20190926001820
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190926001822
SQL开始执行时间：20190926001822

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190926001822
SQL开始执行时间：20190926001822

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190926001822

20190927001734开始执行2019-09-26数据加载日志:
SQL开始执行时间：20190927001734

use pdm
;
SQL结束执行时间：20190927001734
SQL开始执行时间：20190927001734

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190927001734
SQL开始执行时间：20190927001734
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190927001734
SQL开始执行时间：20190927001734

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190927001734
SQL开始执行时间：20190927001734
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190927001735
SQL开始执行时间：20190927001735
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190927001737
SQL开始执行时间：20190927001737
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190927001740
SQL开始执行时间：20190927001740

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190927001740
SQL开始执行时间：20190927001740
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190927001740
SQL开始执行时间：20190927001740
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190927001741
SQL开始执行时间：20190927001741


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190927001741
SQL开始执行时间：20190927001741
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190927001755
SQL开始执行时间：20190927001755


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190927001755
SQL开始执行时间：20190927001755
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190927001756
SQL开始执行时间：20190927001756

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190927001758
SQL开始执行时间：20190927001758
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190927001759
SQL开始执行时间：20190927001759
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190927001801
SQL开始执行时间：20190927001801
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190927001803
SQL开始执行时间：20190927001803

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190927001803
SQL开始执行时间：20190927001803
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190927001804
SQL开始执行时间：20190927001804

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190927001804
SQL开始执行时间：20190927001804

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190927001804
SQL开始执行时间：20190927001804
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190927001804
SQL开始执行时间：20190927001804

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190927001805
SQL开始执行时间：20190927001805

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190927001805
SQL开始执行时间：20190927001805
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190927001807
SQL开始执行时间：20190927001807

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190927001807
SQL开始执行时间：20190927001807

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190927001808
SQL开始执行时间：20190927001808




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190927001809
SQL开始执行时间：20190927001809

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190927001810
SQL开始执行时间：20190927001810
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190927001810
SQL开始执行时间：20190927001810
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190927001812
SQL开始执行时间：20190927001812
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190927001812
SQL开始执行时间：20190927001812
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190927001814
SQL开始执行时间：20190927001814

truncate table pdm.ar_detail
;
SQL结束执行时间：20190927001814
SQL开始执行时间：20190927001814
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190927001816
SQL开始执行时间：20190927001816

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190927001816
SQL开始执行时间：20190927001816

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190927001816

20190928001742开始执行2019-09-27数据加载日志:
SQL开始执行时间：20190928001742

use pdm
;
SQL结束执行时间：20190928001742
SQL开始执行时间：20190928001742

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190928001742
SQL开始执行时间：20190928001742
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190928001742
SQL开始执行时间：20190928001742

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190928001742
SQL开始执行时间：20190928001742
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190928001744
SQL开始执行时间：20190928001744
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190928001747
SQL开始执行时间：20190928001747
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190928001750
SQL开始执行时间：20190928001750

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190928001750
SQL开始执行时间：20190928001750
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190928001751
SQL开始执行时间：20190928001751
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190928001752
SQL开始执行时间：20190928001752


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190928001752
SQL开始执行时间：20190928001752
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190928001806
SQL开始执行时间：20190928001806


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190928001806
SQL开始执行时间：20190928001806
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190928001807
SQL开始执行时间：20190928001807

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190928001808
SQL开始执行时间：20190928001808
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190928001810
SQL开始执行时间：20190928001810
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190928001812
SQL开始执行时间：20190928001812
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190928001814
SQL开始执行时间：20190928001814

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190928001814
SQL开始执行时间：20190928001814
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190928001814
SQL开始执行时间：20190928001814

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190928001814
SQL开始执行时间：20190928001814

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190928001814
SQL开始执行时间：20190928001814
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190928001815
SQL开始执行时间：20190928001815

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190928001815
SQL开始执行时间：20190928001815

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190928001815
SQL开始执行时间：20190928001815
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190928001817
SQL开始执行时间：20190928001817

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190928001817
SQL开始执行时间：20190928001817

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190928001819
SQL开始执行时间：20190928001819




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190928001819
SQL开始执行时间：20190928001819

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190928001821
SQL开始执行时间：20190928001821
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190928001821
SQL开始执行时间：20190928001821
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190928001823
SQL开始执行时间：20190928001823
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190928001823
SQL开始执行时间：20190928001823
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190928001825
SQL开始执行时间：20190928001825

truncate table pdm.ar_detail
;
SQL结束执行时间：20190928001825
SQL开始执行时间：20190928001825
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190928001827
SQL开始执行时间：20190928001827

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190928001827
SQL开始执行时间：20190928001827

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190928001827

20190929001743开始执行2019-09-28数据加载日志:
SQL开始执行时间：20190929001743

use pdm
;
SQL结束执行时间：20190929001743
SQL开始执行时间：20190929001743

drop temporary table if exists pdm.ft_51_ar_tem
;
SQL结束执行时间：20190929001743
SQL开始执行时间：20190929001743
create temporary table if not exists pdm.ft_51_ar_tem
select a.true_ccuscode,a.class,ifnull(aperiod,90) as aperiod
from 
(select true_ccuscode,class,ddate,aperiod from edw.x_ar_plan 
order by true_ccuscode,class,ddate desc,aperiod
) as a
group by a.true_ccuscode,a.class
;
SQL结束执行时间：20190929001743
SQL开始执行时间：20190929001743

drop temporary table if exists pdm.ar_tem01
;
SQL结束执行时间：20190929001743
SQL开始执行时间：20190929001743
create temporary table if not exists pdm.ar_tem01
select 
    *
    ,concat(db,cvouchid,cdwcode) as matchid
    ,concat(db,ccancelno) as matchid2
from edw.ar_detail
where (idamount != 0 or icamount != 0)
and left(true_ccuscode,2) != "gl"
;
SQL结束执行时间：20190929001745
SQL开始执行时间：20190929001745
alter table pdm.ar_tem01 add index index_ar_tem01_matchid (matchid)
;
SQL结束执行时间：20190929001747
SQL开始执行时间：20190929001747
alter table pdm.ar_tem01 add index index_ar_tem01_matchid2 (matchid2)
;
SQL结束执行时间：20190929001750
SQL开始执行时间：20190929001750

drop temporary table if exists pdm.ar_tem03
;
SQL结束执行时间：20190929001750
SQL开始执行时间：20190929001750
create temporary table if not exists pdm.ar_tem03 
select 
    concat(db,ccancelno) as matchid2
    ,max(dvouchdate) as dvouchdate2
from edw.ar_detail 
group by db,ccancelno
;
SQL结束执行时间：20190929001751
SQL开始执行时间：20190929001751
alter table pdm.ar_tem03 add index index_ar_tem03_matchid2 (matchid2)
;
SQL结束执行时间：20190929001752
SQL开始执行时间：20190929001752


drop temporary table if exists pdm.ft_51_ar
;
SQL结束执行时间：20190929001752
SQL开始执行时间：20190929001752
create temporary table if not exists pdm.ft_51_ar as
select
case 
    when a.cvouchtype in ("26","27","r0") then "ar"
    when a.cvouchtype in ("48","49") then "ap"
    else "other"
    end as ar_ap
,case 
    when a.db = 'UFDATA_111_2018' then '博圣' 
    when a.db = 'UFDATA_118_2018' then '卓恩'
    when a.db = 'UFDATA_123_2018' then '恩允'
    when a.db = 'UFDATA_168_2018' then '杭州贝生'
    when a.db = 'UFDATA_168_2019' then '杭州贝生'
    when a.db = 'UFDATA_169_2018' then '云鼎'
    when a.db = 'UFDATA_222_2018' then '宝荣'
    when a.db = 'UFDATA_222_2019' then '宝荣'
    when a.db = 'UFDATA_333_2018' then '宁波贝生'
    when a.db = 'UFDATA_588_2018' then '奥博特'
    when a.db = 'UFDATA_588_2019' then '奥博特'
    when a.db = 'UFDATA_666_2018' then '启代'
    when a.db = 'UFDATA_889_2018' then '美博特'
    when a.db = 'UFDATA_889_2019' then '美博特'
    when a.db = 'UFDATA_555_2018' then '贝安云'
    else '其他'
    end as cohr
,a.db
,a.cvouchtype
,a.cvouchid
,a.dvouchdate
,d.dvouchdate2 as dvouchdate2
,a.dregdate
,a.cdwcode
,a.true_ccuscode
,a.cinvcode
,a.true_cinvcode
,a.ar_class
,a.cdigest
,a.ibvid
,round(a.idamount/1000,4) as idamount
,round(a.icamount/1000,4) as icamount
,a.cprocstyle
,a.ccancelno
,a.ccovouchtype
,a.ccovouchid
,ifnull(b.aperiod,90) as aperiod
,if(b.true_ccuscode is null,0,1) as mark
,a.iVouchAmount_s
,round(a.invoice_amount/1000,4) as invoice_amount
,specification_type
from pdm.ar_tem01 as a 
left join pdm.ft_51_ar_tem as b
on a.true_ccuscode = b.true_ccuscode and a.ar_class = b.class 
left join pdm.ar_tem03 as d
on a.matchid2 = d.matchid2
order by a.db,a.cdwcode,a.dvouchdate,a.ccovouchid
;
SQL结束执行时间：20190929001806
SQL开始执行时间：20190929001806


drop temporary table if exists pdm.ft_51_ar_test_tem
;
SQL结束执行时间：20190929001806
SQL开始执行时间：20190929001806
create temporary table if not exists pdm.ft_51_ar_test_tem
select 
    concat(db,cdwcode,ccovouchid) as matchid
    ,null as c_id 
    ,null as state
    ,case
        when cprocstyle in ("26","27","r0") then "ar"
        when cprocstyle in ("48","49") then "ap"
        else cprocstyle
     end as cprocstyle2
    ,case 
        when ccovouchtype in ("26","27","r0") then "ar"
        when ccovouchtype in ("48","49") then "ap"
        else "other"
     end as ccovouchtype2
    ,a.*
from pdm.ft_51_ar as a
;
SQL结束执行时间：20190929001807
SQL开始执行时间：20190929001807

alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_matchid (matchid)
;
SQL结束执行时间：20190929001809
SQL开始执行时间：20190929001809
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ar_ap (ar_ap)
;
SQL结束执行时间：20190929001811
SQL开始执行时间：20190929001811
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_cprocstyle2 (cprocstyle2)
;
SQL结束执行时间：20190929001812
SQL开始执行时间：20190929001812
alter table pdm.ft_51_ar_test_tem add index index_ft_51_ar_test_tem_ccovouchtype2 (ccovouchtype2)
;
SQL结束执行时间：20190929001814
SQL开始执行时间：20190929001814

drop temporary table if exists pdm.ft_51_ar_test_tem01
;
SQL结束执行时间：20190929001814
SQL开始执行时间：20190929001814
create temporary table if not exists pdm.ft_51_ar_test_tem01
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ar_ap = "ap"
and ccovouchtype in ("48","49")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190929001815
SQL开始执行时间：20190929001815

alter table pdm.ft_51_ar_test_tem01 add index index_ft_51_ar_test_tem01_matchid (matchid)
;
SQL结束执行时间：20190929001815
SQL开始执行时间：20190929001815

drop temporary table if exists pdm.ft_51_ar_test_tem02
;
SQL结束执行时间：20190929001815
SQL开始执行时间：20190929001815
create temporary table if not exists pdm.ft_51_ar_test_tem02
select 
     concat(db,cdwcode,ccovouchid) as matchid
    ,sum(idamount) as idamount_
    ,sum(icamount) as icamount_
from pdm.ft_51_ar
where ccovouchtype in ("26","27","r0")
group by db,cdwcode,ccovouchid
;
SQL结束执行时间：20190929001815
SQL开始执行时间：20190929001815

alter table pdm.ft_51_ar_test_tem02 add index index_ft_51_ar_test_tem02_matchid (matchid)
;
SQL结束执行时间：20190929001816
SQL开始执行时间：20190929001816

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190929001816
SQL开始执行时间：20190929001816
create table if not exists pdm.ft_51_ar_test_pre
select 
    case 
        when a.ar_ap = "ar" then "qu_ar"
        when a.ar_ap = "ap" and a.ccovouchtype2 = "ar" then "qu_ap"
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and a.idamount != 0 then "qu"
        else null 
    end as mark_
    ,case 
        when a.ar_ap = "ar" and a.cprocstyle2 = "ar" and a.ccovouchtype2 = "ar" then c.idamount_-c.icamount_ 
        else 0 
    end as balance_ar
    ,case 
        when a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and a.idamount != 0 then b.icamount_ 
        else 0 
    end as balance_ap
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,a.idamount
    ,a.icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_tem as a
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
left join pdm.ft_51_ar_test_tem02 as c
on a.matchid = c.matchid
;
SQL结束执行时间：20190929001818
SQL开始执行时间：20190929001818

insert into pdm.ft_51_ar_test_pre
select 
    "qu_in" as mark_
    ,0 as balance_ar
    ,b.icamount_ as balance_ap 
    ,a.matchid
    ,a.c_id
    ,a.state
    ,a.cprocstyle2
    ,a.ccovouchtype2
    ,a.ar_ap
    ,a.cohr
    ,a.db
    ,a.cvouchtype
    ,a.cvouchid
    ,a.dvouchdate
    ,a.dvouchdate2
    ,a.dregdate
    ,a.cdwcode
    ,a.true_ccuscode
    ,a.cinvcode
    ,a.true_cinvcode
    ,a.specification_type
    ,a.ar_class
    ,a.cdigest
    ,0 as idamount
    ,0 as icamount
    ,a.cprocstyle
    ,a.ccancelno
    ,a.ccovouchtype
    ,a.ccovouchid
    ,a.aperiod
    ,a.mark
    ,a.invoice_amount
    ,a.iVouchAmount_s
    ,a.ibvid
from pdm.ft_51_ar_test_pre as a 
left join pdm.ft_51_ar_test_tem01 as b 
on a.matchid = b.matchid
where mark_ is null 
and a.ar_ap = "ap" and a.cprocstyle2 = "ap" and a.ccovouchtype2 = "ap" and b.icamount_ != 0 and b.idamount_ = 0
;
SQL结束执行时间：20190929001818
SQL开始执行时间：20190929001818

create temporary table pdm.ft_51_ar_test_pre2 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from (select * from pdm.ft_51_ar_test_pre order by db,cdwcode,dvouchdate) a
 ,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190929001819
SQL开始执行时间：20190929001819




create temporary table pdm.ft_51_ar_test_pre1 as
select a.*
      , @rownum := @rownum +1 AS rownum1
  from
(select *
  from pdm.ft_51_ar_test_pre a
 where cprocstyle2 = 'ap'
   and ccovouchtype2 = 'ap'
   and ar_ap = 'ap'
 group by cvouchid,db
 order by db,cdwcode,dvouchdate
 ) a,(SELECT @rownum := 0) r

;
SQL结束执行时间：20190929001820
SQL开始执行时间：20190929001820

alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_cvouchid (cvouchid)
;
SQL结束执行时间：20190929001821
SQL开始执行时间：20190929001821
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_cvouchid (cvouchid)
;
SQL结束执行时间：20190929001821
SQL开始执行时间：20190929001821
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_db (db)
;
SQL结束执行时间：20190929001823
SQL开始执行时间：20190929001823
alter table pdm.ft_51_ar_test_pre1 add index index_ft_51_ar_test_pre_db (db)
;
SQL结束执行时间：20190929001823
SQL开始执行时间：20190929001823
alter table pdm.ft_51_ar_test_pre2 add index index_ft_51_ar_test_pre2_true_cinvcode (true_cinvcode)
;
SQL结束执行时间：20190929001825
SQL开始执行时间：20190929001825

truncate table pdm.ar_detail
;
SQL结束执行时间：20190929001825
SQL开始执行时间：20190929001825
insert into pdm.ar_detail
select a.rownum1
      ,a.mark_
      ,a.balance_ar
      ,a.balance_ap
      ,a.matchid
      ,a.c_id
      ,a.state
      ,a.cprocstyle2
      ,a.ccovouchtype2
      ,a.ar_ap
      ,a.cohr
      ,a.db
      ,a.cvouchtype
      ,a.cvouchid
      ,a.dvouchdate
      ,a.dvouchdate2
      ,a.dregdate
      ,a.cdwcode
      ,a.true_ccuscode
      ,d.finnal_cuscode
      ,d.sales_region
      ,d.province
      ,d.city
      ,a.cinvcode
      ,a.true_cinvcode
      ,c.item_code
      ,a.specification_type
      ,a.ar_class
      ,a.cdigest
      ,a.idamount
      ,a.icamount
      ,case when a.ar_ap = 'ar' then a.dvouchdate else null end
      ,case when a.ar_ap = 'ap' then b.dvouchdate else null end
      ,case when a.ar_ap = 'ar' then a.idamount else 0 end
      ,ifnull(a.balance_ap,0) + ifnull(a.icamount,0)
      ,a.cprocstyle
      ,a.ccancelno
      ,a.ccovouchtype
      ,a.ccovouchid
      ,a.aperiod
      ,a.mark
      ,a.invoice_amount
      ,a.iVouchAmount_s 
      ,a.ibvid
  from pdm.ft_51_ar_test_pre2 a
  left join pdm.ft_51_ar_test_pre1 b
    on a.cvouchid = b.cvouchid
   and a.db = b.db
  left join edw.map_inventory c
    on a.true_cinvcode = c.bi_cinvcode
  left join edw.map_customer d
    on a.true_ccuscode = d.bi_cuscode

;
SQL结束执行时间：20190929001827
SQL开始执行时间：20190929001827

drop table if exists pdm.ft_51_ar_test_pre
;
SQL结束执行时间：20190929001827
SQL开始执行时间：20190929001827

update pdm.ar_detail a
 inner join pdm.invoice_order b
    on a.ibvid = b.autoid
   set a.finnal_cuscode = b.finnal_ccuscode
      ,a.sales_region = b.sales_region
      ,a.province = b.province
      ,a.city = b.city
 where a.finnal_cuscode = 'multi'
;
SQL结束执行时间：20190929001827
