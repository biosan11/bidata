
20190924165916开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190924165916
drop procedure if exists  pdm.yj_outdepot_forecast_lv2
;
SQL结束执行时间：20190924165916
SQL开始执行时间：20190924165916
delimiter $
create procedure pdm.yj_outdepot_forecast_lv2()
begin
drop table if exists pdm.outdepot_forecast_pre1
;

20190924165920开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190924165920
drop procedure if exists  pdm.yj_outdepot_forecast_lv2
;
SQL结束执行时间：20190924165920
SQL开始执行时间：20190924165920
delimiter $
create procedure pdm.yj_outdepot_forecast_lv2()
begin
drop table if exists pdm.outdepot_forecast_pre1
;

20190924170401开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190924170401
drop procedure if exists  pdm.yj_outdepot_forecast_lv2
;
SQL结束执行时间：20190924170401
SQL开始执行时间：20190924170401
delimiter $
create procedure pdm.yj_outdepot_forecast_lv2()
begin
drop table if exists pdm.outdepot_forecast_pre1
;

20190924170428开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190924170428
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924170428
SQL开始执行时间：20190924170428
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924170429
SQL开始执行时间：20190924170429

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924170429
SQL开始执行时间：20190924170429
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924170429
SQL开始执行时间：20190924170429

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924170429
SQL开始执行时间：20190924170429
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924170430
SQL开始执行时间：20190924170430

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924170430
SQL开始执行时间：20190924170430
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924170430
SQL开始执行时间：20190924170430

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924170430
SQL开始执行时间：20190924170430
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924170430
SQL开始执行时间：20190924170430

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924170430
SQL开始执行时间：20190924170430
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924170437
SQL开始执行时间：20190924170437
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924170439
SQL开始执行时间：20190924170439
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924170439
SQL开始执行时间：20190924170439
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924170439
SQL开始执行时间：20190924170439

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924170439
SQL开始执行时间：20190924170439
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924170439
SQL开始执行时间：20190924170439

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924170439
SQL开始执行时间：20190924170439

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924170439
SQL开始执行时间：20190924170439
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924170440
SQL开始执行时间：20190924170440

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924170440
SQL开始执行时间：20190924170440
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924170441
SQL开始执行时间：20190924170441

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924170441
SQL开始执行时间：20190924170441
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924170442
SQL开始执行时间：20190924170442
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924170442
SQL开始执行时间：20190924170442
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924170442
SQL开始执行时间：20190924170442

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924170442
SQL开始执行时间：20190924170442
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924170442
SQL开始执行时间：20190924170442


# 删除字段
call pdm.yj_outdepot_forecast_lv2()
;

20190924170510开始执行2019-01-01数据加载日志:
SQL开始执行时间：20190924170510
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924170510
SQL开始执行时间：20190924170510
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924170510
SQL开始执行时间：20190924170510

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924170510
SQL开始执行时间：20190924170510
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924170511
SQL开始执行时间：20190924170511
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924170518
SQL开始执行时间：20190924170518
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924170520
SQL开始执行时间：20190924170520
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924170520
SQL开始执行时间：20190924170520
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924170520
SQL开始执行时间：20190924170520

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924170520
SQL开始执行时间：20190924170520
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924170520
SQL开始执行时间：20190924170520

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924170520
SQL开始执行时间：20190924170520

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924170520
SQL开始执行时间：20190924170520
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924170522
SQL开始执行时间：20190924170522

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924170522
SQL开始执行时间：20190924170522
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924170522
SQL开始执行时间：20190924170522

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924170522
SQL开始执行时间：20190924170522
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924170523
SQL开始执行时间：20190924170523
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924170523
SQL开始执行时间：20190924170523
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924170523
SQL开始执行时间：20190924170523

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924170523
SQL开始执行时间：20190924170523
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924170523
SQL开始执行时间：20190924170523


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'1'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924170524
SQL开始执行时间：20190924170524


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924170524
SQL开始执行时间：20190924170524

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924170524
SQL开始执行时间：20190924170524

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924170524

20190924170744开始执行2019Y-09m-24d数据加载日志:
SQL开始执行时间：20190924170744
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924170744
SQL开始执行时间：20190924170744
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924170744
SQL开始执行时间：20190924170744

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924170744
SQL开始执行时间：20190924170744
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924170745
SQL开始执行时间：20190924170745
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924170752
SQL开始执行时间：20190924170752
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924170754
SQL开始执行时间：20190924170754
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924170754
SQL开始执行时间：20190924170754
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924170754
SQL开始执行时间：20190924170754

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924170754
SQL开始执行时间：20190924170754
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924170755
SQL开始执行时间：20190924170755

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924170755
SQL开始执行时间：20190924170755

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924170755
SQL开始执行时间：20190924170755
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924170756
SQL开始执行时间：20190924170756

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924170756
SQL开始执行时间：20190924170756
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924170756
SQL开始执行时间：20190924170756

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924170756
SQL开始执行时间：20190924170756
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924170756
SQL开始执行时间：20190924170756
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924170757
SQL开始执行时间：20190924170757
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924170757
SQL开始执行时间：20190924170757

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924170757
SQL开始执行时间：20190924170757
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924170757
SQL开始执行时间：20190924170757


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'2'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924170757
SQL开始执行时间：20190924170757


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924170757
SQL开始执行时间：20190924170757

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924170758
SQL开始执行时间：20190924170758

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924170758

20190924171336开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924171336
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924171336
SQL开始执行时间：20190924171336
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924171336
SQL开始执行时间：20190924171336

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924171336
SQL开始执行时间：20190924171336
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924171337
SQL开始执行时间：20190924171337

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924171337
SQL开始执行时间：20190924171337
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924171337
SQL开始执行时间：20190924171337

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924171337
SQL开始执行时间：20190924171337
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924171337
SQL开始执行时间：20190924171337

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171337
SQL开始执行时间：20190924171337
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924171338
SQL开始执行时间：20190924171338

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924171338
SQL开始执行时间：20190924171338
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924171344
SQL开始执行时间：20190924171344
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924171346
SQL开始执行时间：20190924171346
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171346
SQL开始执行时间：20190924171346
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924171346
SQL开始执行时间：20190924171346

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924171347
SQL开始执行时间：20190924171347
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924171347
SQL开始执行时间：20190924171347

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924171347
SQL开始执行时间：20190924171347

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924171347
SQL开始执行时间：20190924171347
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924171348
SQL开始执行时间：20190924171348

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924171348
SQL开始执行时间：20190924171348
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924171348
SQL开始执行时间：20190924171348

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924171348
SQL开始执行时间：20190924171348
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924171349
SQL开始执行时间：20190924171349
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924171349
SQL开始执行时间：20190924171349
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924171349
SQL开始执行时间：20190924171349

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924171349
SQL开始执行时间：20190924171349
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924171349
SQL开始执行时间：20190924171349


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'i'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;

20190924171350开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924171350
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924171350
SQL开始执行时间：20190924171350
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924171350
SQL开始执行时间：20190924171350

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924171350
SQL开始执行时间：20190924171350
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924171351
SQL开始执行时间：20190924171351

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924171351
SQL开始执行时间：20190924171351
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924171352
SQL开始执行时间：20190924171352

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924171352
SQL开始执行时间：20190924171352
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924171352
SQL开始执行时间：20190924171352

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171352
SQL开始执行时间：20190924171352
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924171352
SQL开始执行时间：20190924171352

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924171352
SQL开始执行时间：20190924171352
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924171359
SQL开始执行时间：20190924171359
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924171401
SQL开始执行时间：20190924171401
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171401
SQL开始执行时间：20190924171401
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924171401
SQL开始执行时间：20190924171401

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924171401
SQL开始执行时间：20190924171401
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924171401
SQL开始执行时间：20190924171401

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924171401
SQL开始执行时间：20190924171401

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924171401
SQL开始执行时间：20190924171401
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924171402
SQL开始执行时间：20190924171402

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924171402
SQL开始执行时间：20190924171402
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;

20190924171402开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924171403
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924171403
SQL开始执行时间：20190924171403
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924171403
SQL开始执行时间：20190924171403

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924171403
SQL开始执行时间：20190924171403
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924171404
SQL开始执行时间：20190924171404

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924171404
SQL开始执行时间：20190924171404
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;

20190924171425开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924171425
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924171425
SQL开始执行时间：20190924171425
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924171426
SQL开始执行时间：20190924171426

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924171426
SQL开始执行时间：20190924171426
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924171427
SQL开始执行时间：20190924171427

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924171427
SQL开始执行时间：20190924171427
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924171427
SQL开始执行时间：20190924171427

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924171427
SQL开始执行时间：20190924171427
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924171427
SQL开始执行时间：20190924171427

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171427
SQL开始执行时间：20190924171427
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;

20190924171531开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924171531
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924171531
SQL开始执行时间：20190924171531
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924171532
SQL开始执行时间：20190924171532

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924171532
SQL开始执行时间：20190924171532
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924171532
SQL开始执行时间：20190924171532

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924171532
SQL开始执行时间：20190924171532
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924171533
SQL开始执行时间：20190924171533

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924171533
SQL开始执行时间：20190924171533
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924171533
SQL开始执行时间：20190924171533

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171533
SQL开始执行时间：20190924171533
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924171533
SQL开始执行时间：20190924171533

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924171533
SQL开始执行时间：20190924171533
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924171539
SQL开始执行时间：20190924171539

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924171539
SQL开始执行时间：20190924171539

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924171539
SQL开始执行时间：20190924171539
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171539
SQL开始执行时间：20190924171539

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924171539
SQL开始执行时间：20190924171539
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171540
SQL开始执行时间：20190924171540

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924171540
SQL开始执行时间：20190924171540
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924171540
SQL开始执行时间：20190924171540


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924171540
SQL开始执行时间：20190924171540
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924171540
SQL开始执行时间：20190924171540


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924171540
SQL开始执行时间：20190924171540
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924171542
SQL开始执行时间：20190924171542
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171542
SQL开始执行时间：20190924171542
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924171542
SQL开始执行时间：20190924171542

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924171542
SQL开始执行时间：20190924171542
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924171542
SQL开始执行时间：20190924171542

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924171542
SQL开始执行时间：20190924171542

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924171542
SQL开始执行时间：20190924171542
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924171543
SQL开始执行时间：20190924171543

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924171543
SQL开始执行时间：20190924171543
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924171543
SQL开始执行时间：20190924171543

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924171543
SQL开始执行时间：20190924171543
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924171544
SQL开始执行时间：20190924171544
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924171544
SQL开始执行时间：20190924171544
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924171544
SQL开始执行时间：20190924171544

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924171544
SQL开始执行时间：20190924171544
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924171545
SQL开始执行时间：20190924171545


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'1'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;

20190924171545开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924171545
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924171545
SQL开始执行时间：20190924171545
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924171546
SQL开始执行时间：20190924171546

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924171546
SQL开始执行时间：20190924171546
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924171546
SQL开始执行时间：20190924171546

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924171546
SQL开始执行时间：20190924171546
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924171547
SQL开始执行时间：20190924171547

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924171547
SQL开始执行时间：20190924171547
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924171547
SQL开始执行时间：20190924171547

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924171547
SQL开始执行时间：20190924171547
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924171547
SQL开始执行时间：20190924171547

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924171547
SQL开始执行时间：20190924171547
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;

20190924172010开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172010
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172010
SQL开始执行时间：20190924172010
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172010
SQL开始执行时间：20190924172010

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172010
SQL开始执行时间：20190924172010
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172011
SQL开始执行时间：20190924172011
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172018
SQL开始执行时间：20190924172018
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172020
SQL开始执行时间：20190924172020
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172020
SQL开始执行时间：20190924172020
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172020
SQL开始执行时间：20190924172020

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172020
SQL开始执行时间：20190924172020
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172020
SQL开始执行时间：20190924172020

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172020
SQL开始执行时间：20190924172020

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172020
SQL开始执行时间：20190924172020
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172021
SQL开始执行时间：20190924172021

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172021
SQL开始执行时间：20190924172021
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172021
SQL开始执行时间：20190924172021

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172021
SQL开始执行时间：20190924172021
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172022
SQL开始执行时间：20190924172022
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172022
SQL开始执行时间：20190924172022
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172022
SQL开始执行时间：20190924172022

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172022
SQL开始执行时间：20190924172022
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172023
SQL开始执行时间：20190924172023


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'1'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172023
SQL开始执行时间：20190924172023


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172023
SQL开始执行时间：20190924172023

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172023
SQL开始执行时间：20190924172023

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172024

20190924172024开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172024
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172024
SQL开始执行时间：20190924172024
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172024
SQL开始执行时间：20190924172024

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172024
SQL开始执行时间：20190924172024
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172025
SQL开始执行时间：20190924172025

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172025
SQL开始执行时间：20190924172025
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172025
SQL开始执行时间：20190924172025

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172025
SQL开始执行时间：20190924172025
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172025
SQL开始执行时间：20190924172025

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172025
SQL开始执行时间：20190924172025
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172026
SQL开始执行时间：20190924172026

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172026
SQL开始执行时间：20190924172026
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172032
SQL开始执行时间：20190924172032

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172032
SQL开始执行时间：20190924172032

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172032
SQL开始执行时间：20190924172032
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172032
SQL开始执行时间：20190924172032

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172032
SQL开始执行时间：20190924172032
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172033
SQL开始执行时间：20190924172033

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172033
SQL开始执行时间：20190924172033
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172033
SQL开始执行时间：20190924172033


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172033
SQL开始执行时间：20190924172033
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172033
SQL开始执行时间：20190924172033


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172033
SQL开始执行时间：20190924172033
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172035
SQL开始执行时间：20190924172035
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172035
SQL开始执行时间：20190924172035
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172035
SQL开始执行时间：20190924172035

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172035
SQL开始执行时间：20190924172035
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172035
SQL开始执行时间：20190924172035

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172035
SQL开始执行时间：20190924172035

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172035
SQL开始执行时间：20190924172035
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172036
SQL开始执行时间：20190924172036

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172036
SQL开始执行时间：20190924172036
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172036
SQL开始执行时间：20190924172036

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172036
SQL开始执行时间：20190924172036
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172037
SQL开始执行时间：20190924172037
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172037
SQL开始执行时间：20190924172037
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172037
SQL开始执行时间：20190924172037

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172037
SQL开始执行时间：20190924172037
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172038
SQL开始执行时间：20190924172038


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'2'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172038
SQL开始执行时间：20190924172038


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172038
SQL开始执行时间：20190924172038

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172038
SQL开始执行时间：20190924172038

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172038

20190924172038开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172038
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172038
SQL开始执行时间：20190924172038
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172039
SQL开始执行时间：20190924172039

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172039
SQL开始执行时间：20190924172039
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172040
SQL开始执行时间：20190924172040
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172047
SQL开始执行时间：20190924172047
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172049
SQL开始执行时间：20190924172049
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172049
SQL开始执行时间：20190924172049
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172050
SQL开始执行时间：20190924172050

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172050
SQL开始执行时间：20190924172050
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172050
SQL开始执行时间：20190924172050

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172050
SQL开始执行时间：20190924172050

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172050
SQL开始执行时间：20190924172050
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172051
SQL开始执行时间：20190924172051

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172051
SQL开始执行时间：20190924172051
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172051
SQL开始执行时间：20190924172051

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172051
SQL开始执行时间：20190924172051
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172052
SQL开始执行时间：20190924172052
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172052
SQL开始执行时间：20190924172052
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172052
SQL开始执行时间：20190924172052

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172052
SQL开始执行时间：20190924172052
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172052
SQL开始执行时间：20190924172052


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'3'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172052
SQL开始执行时间：20190924172052


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172053
SQL开始执行时间：20190924172053

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172053
SQL开始执行时间：20190924172053

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172053

20190924172053开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172053
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172053
SQL开始执行时间：20190924172053
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172054
SQL开始执行时间：20190924172054

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172054
SQL开始执行时间：20190924172054
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172055
SQL开始执行时间：20190924172055
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172102
SQL开始执行时间：20190924172102

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172102
SQL开始执行时间：20190924172102

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172102
SQL开始执行时间：20190924172102
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172102
SQL开始执行时间：20190924172102

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172102
SQL开始执行时间：20190924172102
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172103
SQL开始执行时间：20190924172103

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172103
SQL开始执行时间：20190924172103
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172103
SQL开始执行时间：20190924172103


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172103
SQL开始执行时间：20190924172103
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172103
SQL开始执行时间：20190924172103


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172103
SQL开始执行时间：20190924172103
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172105
SQL开始执行时间：20190924172105
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172105
SQL开始执行时间：20190924172105
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172105
SQL开始执行时间：20190924172105

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172105
SQL开始执行时间：20190924172105
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172105
SQL开始执行时间：20190924172105

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172105
SQL开始执行时间：20190924172105

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172105
SQL开始执行时间：20190924172105
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172106
SQL开始执行时间：20190924172106

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172106
SQL开始执行时间：20190924172106
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172106
SQL开始执行时间：20190924172106

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172106
SQL开始执行时间：20190924172106
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172107
SQL开始执行时间：20190924172107
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172107
SQL开始执行时间：20190924172107
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172107
SQL开始执行时间：20190924172107

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172107
SQL开始执行时间：20190924172107
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172108
SQL开始执行时间：20190924172108


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'4'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172108
SQL开始执行时间：20190924172108


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172108
SQL开始执行时间：20190924172108

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172108
SQL开始执行时间：20190924172108

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172108

20190924172108开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172108
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172108
SQL开始执行时间：20190924172108
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172109
SQL开始执行时间：20190924172109

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172109
SQL开始执行时间：20190924172109
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172110
SQL开始执行时间：20190924172110

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172110
SQL开始执行时间：20190924172110
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172111
SQL开始执行时间：20190924172111

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172111
SQL开始执行时间：20190924172111
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172111
SQL开始执行时间：20190924172111

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172111
SQL开始执行时间：20190924172111
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172111
SQL开始执行时间：20190924172111

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172111
SQL开始执行时间：20190924172111
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172118
SQL开始执行时间：20190924172118
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172120
SQL开始执行时间：20190924172120
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172120
SQL开始执行时间：20190924172120
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172120
SQL开始执行时间：20190924172120

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172120
SQL开始执行时间：20190924172120
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172120
SQL开始执行时间：20190924172120

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172120
SQL开始执行时间：20190924172120

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172120
SQL开始执行时间：20190924172120
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172121
SQL开始执行时间：20190924172121

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172121
SQL开始执行时间：20190924172121
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172122
SQL开始执行时间：20190924172122

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172122
SQL开始执行时间：20190924172122
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172122
SQL开始执行时间：20190924172122
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172122
SQL开始执行时间：20190924172122
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172122
SQL开始执行时间：20190924172122

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172122
SQL开始执行时间：20190924172122
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172123
SQL开始执行时间：20190924172123


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'5'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172123
SQL开始执行时间：20190924172123


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172123
SQL开始执行时间：20190924172123

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172123
SQL开始执行时间：20190924172123

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172124

20190924172124开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172124
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172124
SQL开始执行时间：20190924172124
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172125
SQL开始执行时间：20190924172125

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172125
SQL开始执行时间：20190924172125
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172126
SQL开始执行时间：20190924172126
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172134
SQL开始执行时间：20190924172134
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172136
SQL开始执行时间：20190924172136
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172136
SQL开始执行时间：20190924172136
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172136
SQL开始执行时间：20190924172136

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172136
SQL开始执行时间：20190924172136
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172136
SQL开始执行时间：20190924172136

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172136
SQL开始执行时间：20190924172136

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172136
SQL开始执行时间：20190924172136
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172137
SQL开始执行时间：20190924172137

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172137
SQL开始执行时间：20190924172137
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172137
SQL开始执行时间：20190924172137

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172137
SQL开始执行时间：20190924172137
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172138
SQL开始执行时间：20190924172138
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172138
SQL开始执行时间：20190924172138
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172138
SQL开始执行时间：20190924172138

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172138
SQL开始执行时间：20190924172138
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172139
SQL开始执行时间：20190924172139


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'6'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172139
SQL开始执行时间：20190924172139


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172139
SQL开始执行时间：20190924172139

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172139
SQL开始执行时间：20190924172139

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172139

20190924172140开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172140
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172140
SQL开始执行时间：20190924172140
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172140
SQL开始执行时间：20190924172140

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172140
SQL开始执行时间：20190924172140
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172141
SQL开始执行时间：20190924172141

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172141
SQL开始执行时间：20190924172141
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172142
SQL开始执行时间：20190924172142

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172142
SQL开始执行时间：20190924172142
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172142
SQL开始执行时间：20190924172142

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172142
SQL开始执行时间：20190924172142
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172142
SQL开始执行时间：20190924172142

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172142
SQL开始执行时间：20190924172142
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172149
SQL开始执行时间：20190924172149

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172149
SQL开始执行时间：20190924172149

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172149
SQL开始执行时间：20190924172149
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172149
SQL开始执行时间：20190924172149

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172149
SQL开始执行时间：20190924172149
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172150
SQL开始执行时间：20190924172150

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172150
SQL开始执行时间：20190924172150
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172150
SQL开始执行时间：20190924172150


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172150
SQL开始执行时间：20190924172150
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172150
SQL开始执行时间：20190924172150


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172150
SQL开始执行时间：20190924172150
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172152
SQL开始执行时间：20190924172152
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172152
SQL开始执行时间：20190924172152
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172152
SQL开始执行时间：20190924172152

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172152
SQL开始执行时间：20190924172152
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172152
SQL开始执行时间：20190924172152

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172152
SQL开始执行时间：20190924172152

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172152
SQL开始执行时间：20190924172152
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172153
SQL开始执行时间：20190924172153

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172153
SQL开始执行时间：20190924172153
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172153
SQL开始执行时间：20190924172153

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172153
SQL开始执行时间：20190924172153
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172154
SQL开始执行时间：20190924172154
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172154
SQL开始执行时间：20190924172154
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172154
SQL开始执行时间：20190924172154

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172154
SQL开始执行时间：20190924172154
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172155
SQL开始执行时间：20190924172155


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'7'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172155
SQL开始执行时间：20190924172155


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172155
SQL开始执行时间：20190924172155

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172155
SQL开始执行时间：20190924172155

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172155

20190924172155开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172155
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172155
SQL开始执行时间：20190924172155
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172156
SQL开始执行时间：20190924172156

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172156
SQL开始执行时间：20190924172156
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172157
SQL开始执行时间：20190924172157

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172157
SQL开始执行时间：20190924172157
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172158
SQL开始执行时间：20190924172158

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172158
SQL开始执行时间：20190924172158
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172158
SQL开始执行时间：20190924172158

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172158
SQL开始执行时间：20190924172158
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172158
SQL开始执行时间：20190924172158

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172158
SQL开始执行时间：20190924172158
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172205
SQL开始执行时间：20190924172205

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172205
SQL开始执行时间：20190924172205

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172205
SQL开始执行时间：20190924172205
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172205
SQL开始执行时间：20190924172205

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172205
SQL开始执行时间：20190924172205
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172206
SQL开始执行时间：20190924172206

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172206
SQL开始执行时间：20190924172206
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172206
SQL开始执行时间：20190924172206


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172206
SQL开始执行时间：20190924172206
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172206
SQL开始执行时间：20190924172206


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172206
SQL开始执行时间：20190924172206
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172208
SQL开始执行时间：20190924172208
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172208
SQL开始执行时间：20190924172208
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172208
SQL开始执行时间：20190924172208

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172208
SQL开始执行时间：20190924172208
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172208
SQL开始执行时间：20190924172208

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172208
SQL开始执行时间：20190924172208

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172208
SQL开始执行时间：20190924172208
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172209
SQL开始执行时间：20190924172209

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172209
SQL开始执行时间：20190924172209
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172209
SQL开始执行时间：20190924172209

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172209
SQL开始执行时间：20190924172209
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172210
SQL开始执行时间：20190924172210
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172210
SQL开始执行时间：20190924172210
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172210
SQL开始执行时间：20190924172210

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172210
SQL开始执行时间：20190924172210
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172211
SQL开始执行时间：20190924172211


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'8'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172211
SQL开始执行时间：20190924172211


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172211
SQL开始执行时间：20190924172211

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172211
SQL开始执行时间：20190924172211

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172211

20190924172211开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172211
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172211
SQL开始执行时间：20190924172211
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172212
SQL开始执行时间：20190924172212

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172212
SQL开始执行时间：20190924172212
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172213
SQL开始执行时间：20190924172213

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172213
SQL开始执行时间：20190924172213
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172214
SQL开始执行时间：20190924172214

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172214
SQL开始执行时间：20190924172214
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172214
SQL开始执行时间：20190924172214

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172214
SQL开始执行时间：20190924172214
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172214
SQL开始执行时间：20190924172214

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172214
SQL开始执行时间：20190924172214
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172221
SQL开始执行时间：20190924172221

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172222
SQL开始执行时间：20190924172222
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172224
SQL开始执行时间：20190924172224
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172224
SQL开始执行时间：20190924172224
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172224
SQL开始执行时间：20190924172224

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172224
SQL开始执行时间：20190924172224
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172224
SQL开始执行时间：20190924172224

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172224
SQL开始执行时间：20190924172224

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172224
SQL开始执行时间：20190924172224
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172225
SQL开始执行时间：20190924172225

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172225
SQL开始执行时间：20190924172225
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172225
SQL开始执行时间：20190924172225

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172225
SQL开始执行时间：20190924172225
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172226
SQL开始执行时间：20190924172226
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172226
SQL开始执行时间：20190924172226
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172226
SQL开始执行时间：20190924172226

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172226
SQL开始执行时间：20190924172226
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172227
SQL开始执行时间：20190924172227


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'9'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172227
SQL开始执行时间：20190924172227


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172227
SQL开始执行时间：20190924172227

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172227
SQL开始执行时间：20190924172227

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172227

20190924172228开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172228
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172228
SQL开始执行时间：20190924172228
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172228
SQL开始执行时间：20190924172228

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172228
SQL开始执行时间：20190924172228
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172230
SQL开始执行时间：20190924172230
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172238
SQL开始执行时间：20190924172238
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172240
SQL开始执行时间：20190924172240
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172240
SQL开始执行时间：20190924172240
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172240
SQL开始执行时间：20190924172240

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172240
SQL开始执行时间：20190924172240
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172240
SQL开始执行时间：20190924172240

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172240
SQL开始执行时间：20190924172240

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172240
SQL开始执行时间：20190924172240
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172241
SQL开始执行时间：20190924172241

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172241
SQL开始执行时间：20190924172241
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172242
SQL开始执行时间：20190924172242

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172242
SQL开始执行时间：20190924172242
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172242
SQL开始执行时间：20190924172242
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172242
SQL开始执行时间：20190924172242
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172242
SQL开始执行时间：20190924172242

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172242
SQL开始执行时间：20190924172242
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172243
SQL开始执行时间：20190924172243


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'10'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172243
SQL开始执行时间：20190924172243


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172243
SQL开始执行时间：20190924172243

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172243
SQL开始执行时间：20190924172243

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172244

20190924172244开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172244
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172244
SQL开始执行时间：20190924172244
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172245
SQL开始执行时间：20190924172245

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172245
SQL开始执行时间：20190924172245
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172246
SQL开始执行时间：20190924172246
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172254
SQL开始执行时间：20190924172254

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172254
SQL开始执行时间：20190924172254

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172254
SQL开始执行时间：20190924172254
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172254
SQL开始执行时间：20190924172254

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172254
SQL开始执行时间：20190924172254
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172255
SQL开始执行时间：20190924172255

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172255
SQL开始执行时间：20190924172255
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172255
SQL开始执行时间：20190924172255


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172255
SQL开始执行时间：20190924172255
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172255
SQL开始执行时间：20190924172255


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172255
SQL开始执行时间：20190924172255
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172257
SQL开始执行时间：20190924172257
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172257
SQL开始执行时间：20190924172257
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172257
SQL开始执行时间：20190924172257

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172257
SQL开始执行时间：20190924172257
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172257
SQL开始执行时间：20190924172257

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172257
SQL开始执行时间：20190924172257

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172257
SQL开始执行时间：20190924172257
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172258
SQL开始执行时间：20190924172258

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172258
SQL开始执行时间：20190924172258
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172258
SQL开始执行时间：20190924172258

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172258
SQL开始执行时间：20190924172258
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172259
SQL开始执行时间：20190924172259
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172259
SQL开始执行时间：20190924172259
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172259
SQL开始执行时间：20190924172259

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172259
SQL开始执行时间：20190924172259
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172300
SQL开始执行时间：20190924172300


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'11'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172300
SQL开始执行时间：20190924172300


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172300
SQL开始执行时间：20190924172300

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172300
SQL开始执行时间：20190924172300

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172300

20190924172300开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172300
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172300
SQL开始执行时间：20190924172300
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172301
SQL开始执行时间：20190924172301

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172301
SQL开始执行时间：20190924172301
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172302
SQL开始执行时间：20190924172302

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172302
SQL开始执行时间：20190924172302
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172303
SQL开始执行时间：20190924172303

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172303
SQL开始执行时间：20190924172303
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172303
SQL开始执行时间：20190924172303

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172303
SQL开始执行时间：20190924172303
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172303
SQL开始执行时间：20190924172303

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172303
SQL开始执行时间：20190924172303
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172311
SQL开始执行时间：20190924172311
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172313
SQL开始执行时间：20190924172313
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172313
SQL开始执行时间：20190924172313
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172313
SQL开始执行时间：20190924172313

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172313
SQL开始执行时间：20190924172313
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172314
SQL开始执行时间：20190924172314

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172314
SQL开始执行时间：20190924172314

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172314
SQL开始执行时间：20190924172314
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172315
SQL开始执行时间：20190924172315

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172315
SQL开始执行时间：20190924172315
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172315
SQL开始执行时间：20190924172315

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172315
SQL开始执行时间：20190924172315
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172316
SQL开始执行时间：20190924172316
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172316
SQL开始执行时间：20190924172316
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172316
SQL开始执行时间：20190924172316

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172316
SQL开始执行时间：20190924172316
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172316
SQL开始执行时间：20190924172316


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'12'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172316
SQL开始执行时间：20190924172316


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172316
SQL开始执行时间：20190924172316

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172317
SQL开始执行时间：20190924172317

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172317

20190924172317开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172317
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172317
SQL开始执行时间：20190924172317
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172318
SQL开始执行时间：20190924172318

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172318
SQL开始执行时间：20190924172318
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172319
SQL开始执行时间：20190924172319

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172319
SQL开始执行时间：20190924172319
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172320
SQL开始执行时间：20190924172320

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172320
SQL开始执行时间：20190924172320
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172320
SQL开始执行时间：20190924172320

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172320
SQL开始执行时间：20190924172320
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172320
SQL开始执行时间：20190924172320

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172320
SQL开始执行时间：20190924172320
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172328
SQL开始执行时间：20190924172328
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172330
SQL开始执行时间：20190924172330
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172330
SQL开始执行时间：20190924172330
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172331
SQL开始执行时间：20190924172331

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172331
SQL开始执行时间：20190924172331
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172331
SQL开始执行时间：20190924172331

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172331
SQL开始执行时间：20190924172331

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172331
SQL开始执行时间：20190924172331
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172332
SQL开始执行时间：20190924172332

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172332
SQL开始执行时间：20190924172332
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172332
SQL开始执行时间：20190924172332

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172332
SQL开始执行时间：20190924172332
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172333
SQL开始执行时间：20190924172333
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172333
SQL开始执行时间：20190924172333
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172333
SQL开始执行时间：20190924172333

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172333
SQL开始执行时间：20190924172333
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172334
SQL开始执行时间：20190924172334


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'13'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172334
SQL开始执行时间：20190924172334


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172334
SQL开始执行时间：20190924172334

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172334
SQL开始执行时间：20190924172334

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172334

20190924172334开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172334
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172334
SQL开始执行时间：20190924172334
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172335
SQL开始执行时间：20190924172335

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172335
SQL开始执行时间：20190924172335
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172336
SQL开始执行时间：20190924172336

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172336
SQL开始执行时间：20190924172336
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172337
SQL开始执行时间：20190924172337

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172337
SQL开始执行时间：20190924172337
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172337
SQL开始执行时间：20190924172337

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172337
SQL开始执行时间：20190924172337
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172337
SQL开始执行时间：20190924172337

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172337
SQL开始执行时间：20190924172337
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172345
SQL开始执行时间：20190924172345

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172345
SQL开始执行时间：20190924172345

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172345
SQL开始执行时间：20190924172345
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172346
SQL开始执行时间：20190924172346
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172348
SQL开始执行时间：20190924172348
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172348
SQL开始执行时间：20190924172348
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172348
SQL开始执行时间：20190924172348

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172348
SQL开始执行时间：20190924172348
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172348
SQL开始执行时间：20190924172348

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172348
SQL开始执行时间：20190924172348

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172348
SQL开始执行时间：20190924172348
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172349
SQL开始执行时间：20190924172349

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172349
SQL开始执行时间：20190924172349
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172349
SQL开始执行时间：20190924172349

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172349
SQL开始执行时间：20190924172349
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172350
SQL开始执行时间：20190924172350
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172350
SQL开始执行时间：20190924172350
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172350
SQL开始执行时间：20190924172350

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172350
SQL开始执行时间：20190924172350
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172351
SQL开始执行时间：20190924172351


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'14'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172351
SQL开始执行时间：20190924172351


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172351
SQL开始执行时间：20190924172351

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172351
SQL开始执行时间：20190924172351

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172351

20190924172352开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172352
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172352
SQL开始执行时间：20190924172352
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172353
SQL开始执行时间：20190924172353

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172353
SQL开始执行时间：20190924172353
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172354
SQL开始执行时间：20190924172354
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172403
SQL开始执行时间：20190924172403
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172405
SQL开始执行时间：20190924172405
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172405
SQL开始执行时间：20190924172405
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172405
SQL开始执行时间：20190924172405

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172405
SQL开始执行时间：20190924172405
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172405
SQL开始执行时间：20190924172405

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172405
SQL开始执行时间：20190924172405

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172405
SQL开始执行时间：20190924172405
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172406
SQL开始执行时间：20190924172406

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172406
SQL开始执行时间：20190924172406
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172407
SQL开始执行时间：20190924172407

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172407
SQL开始执行时间：20190924172407
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172407
SQL开始执行时间：20190924172407
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172407
SQL开始执行时间：20190924172407
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172408
SQL开始执行时间：20190924172408

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172408
SQL开始执行时间：20190924172408
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172408
SQL开始执行时间：20190924172408


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'15'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172408
SQL开始执行时间：20190924172408


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172408
SQL开始执行时间：20190924172408

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172408
SQL开始执行时间：20190924172408

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172409

20190924172409开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172409
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172409
SQL开始执行时间：20190924172409
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172410
SQL开始执行时间：20190924172410

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172410
SQL开始执行时间：20190924172410
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172411
SQL开始执行时间：20190924172411

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172411
SQL开始执行时间：20190924172411
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172412
SQL开始执行时间：20190924172412

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172412
SQL开始执行时间：20190924172412
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172412
SQL开始执行时间：20190924172412

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172412
SQL开始执行时间：20190924172412
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172412
SQL开始执行时间：20190924172412

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172412
SQL开始执行时间：20190924172412
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172420
SQL开始执行时间：20190924172420

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172420
SQL开始执行时间：20190924172420

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172420
SQL开始执行时间：20190924172420
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172420
SQL开始执行时间：20190924172420

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172420
SQL开始执行时间：20190924172420
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172420
SQL开始执行时间：20190924172420

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172421
SQL开始执行时间：20190924172421
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172421
SQL开始执行时间：20190924172421


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172421
SQL开始执行时间：20190924172421
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172421
SQL开始执行时间：20190924172421


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172421
SQL开始执行时间：20190924172421
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172423
SQL开始执行时间：20190924172423
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172423
SQL开始执行时间：20190924172423
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172423
SQL开始执行时间：20190924172423

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172423
SQL开始执行时间：20190924172423
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172423
SQL开始执行时间：20190924172423

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172423
SQL开始执行时间：20190924172423

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172423
SQL开始执行时间：20190924172423
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172424
SQL开始执行时间：20190924172424

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172424
SQL开始执行时间：20190924172424
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172424
SQL开始执行时间：20190924172424

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172424
SQL开始执行时间：20190924172424
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172425
SQL开始执行时间：20190924172425
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172425
SQL开始执行时间：20190924172425
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172425
SQL开始执行时间：20190924172425

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172425
SQL开始执行时间：20190924172425
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172426
SQL开始执行时间：20190924172426


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'16'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172426
SQL开始执行时间：20190924172426


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172426
SQL开始执行时间：20190924172426

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172426
SQL开始执行时间：20190924172426

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172426

20190924172426开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172426
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172426
SQL开始执行时间：20190924172426
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172427
SQL开始执行时间：20190924172427

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172427
SQL开始执行时间：20190924172427
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172429
SQL开始执行时间：20190924172429
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172438
SQL开始执行时间：20190924172438
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172440
SQL开始执行时间：20190924172440
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172440
SQL开始执行时间：20190924172440
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172440
SQL开始执行时间：20190924172440

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172440
SQL开始执行时间：20190924172440
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172440
SQL开始执行时间：20190924172440

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172440
SQL开始执行时间：20190924172440

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172440
SQL开始执行时间：20190924172440
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172441
SQL开始执行时间：20190924172441

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172441
SQL开始执行时间：20190924172441
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172442
SQL开始执行时间：20190924172442

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172442
SQL开始执行时间：20190924172442
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172442
SQL开始执行时间：20190924172442
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172442
SQL开始执行时间：20190924172442
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172443
SQL开始执行时间：20190924172443

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172443
SQL开始执行时间：20190924172443
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172443
SQL开始执行时间：20190924172443


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'17'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172443
SQL开始执行时间：20190924172443


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172443
SQL开始执行时间：20190924172443

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172443
SQL开始执行时间：20190924172443

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172444

20190924172444开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172444
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172444
SQL开始执行时间：20190924172444
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172445
SQL开始执行时间：20190924172445

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172445
SQL开始执行时间：20190924172445
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172446
SQL开始执行时间：20190924172446

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172446
SQL开始执行时间：20190924172446
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172447
SQL开始执行时间：20190924172447

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172447
SQL开始执行时间：20190924172447
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172447
SQL开始执行时间：20190924172447

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172447
SQL开始执行时间：20190924172447
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172447
SQL开始执行时间：20190924172447

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172447
SQL开始执行时间：20190924172447
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172456
SQL开始执行时间：20190924172456
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172458
SQL开始执行时间：20190924172458
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172458
SQL开始执行时间：20190924172458
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172458
SQL开始执行时间：20190924172458

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172458
SQL开始执行时间：20190924172458
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172458
SQL开始执行时间：20190924172458

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172458
SQL开始执行时间：20190924172458

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172458
SQL开始执行时间：20190924172458
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172459
SQL开始执行时间：20190924172459

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172459
SQL开始执行时间：20190924172459
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172459
SQL开始执行时间：20190924172459

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172459
SQL开始执行时间：20190924172459
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172500
SQL开始执行时间：20190924172500
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172500
SQL开始执行时间：20190924172500
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172500
SQL开始执行时间：20190924172500

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172500
SQL开始执行时间：20190924172500
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172501
SQL开始执行时间：20190924172501


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'18'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172501
SQL开始执行时间：20190924172501


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172501
SQL开始执行时间：20190924172501

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172501
SQL开始执行时间：20190924172501

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172502

20190924172502开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172502
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172502
SQL开始执行时间：20190924172502
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172503
SQL开始执行时间：20190924172503

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172503
SQL开始执行时间：20190924172503
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172504
SQL开始执行时间：20190924172504

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172504
SQL开始执行时间：20190924172504
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172505
SQL开始执行时间：20190924172505

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172505
SQL开始执行时间：20190924172505
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172505
SQL开始执行时间：20190924172505

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172505
SQL开始执行时间：20190924172505
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172505
SQL开始执行时间：20190924172505

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172505
SQL开始执行时间：20190924172505
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172514
SQL开始执行时间：20190924172514

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172515
SQL开始执行时间：20190924172515
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172517
SQL开始执行时间：20190924172517
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172517
SQL开始执行时间：20190924172517
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172517
SQL开始执行时间：20190924172517

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172517
SQL开始执行时间：20190924172517
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172517
SQL开始执行时间：20190924172517

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172517
SQL开始执行时间：20190924172517

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172517
SQL开始执行时间：20190924172517
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172518
SQL开始执行时间：20190924172518

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172518
SQL开始执行时间：20190924172518
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172519
SQL开始执行时间：20190924172519

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172519
SQL开始执行时间：20190924172519
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172519
SQL开始执行时间：20190924172519
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172520
SQL开始执行时间：20190924172520
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172520
SQL开始执行时间：20190924172520

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172520
SQL开始执行时间：20190924172520
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172520
SQL开始执行时间：20190924172520


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'19'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172520
SQL开始执行时间：20190924172520


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172521
SQL开始执行时间：20190924172521

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172521
SQL开始执行时间：20190924172521

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172521

20190924172521开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924172521
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924172521
SQL开始执行时间：20190924172521
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924172522
SQL开始执行时间：20190924172522

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924172522
SQL开始执行时间：20190924172522
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924172524
SQL开始执行时间：20190924172524

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924172524
SQL开始执行时间：20190924172524
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924172524
SQL开始执行时间：20190924172524

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924172524
SQL开始执行时间：20190924172524
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924172524
SQL开始执行时间：20190924172524

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172525
SQL开始执行时间：20190924172525
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924172525
SQL开始执行时间：20190924172525

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924172525
SQL开始执行时间：20190924172525
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924172534
SQL开始执行时间：20190924172534
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924172535
SQL开始执行时间：20190924172535


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172535
SQL开始执行时间：20190924172535
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924172537
SQL开始执行时间：20190924172537
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924172537
SQL开始执行时间：20190924172537
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924172537
SQL开始执行时间：20190924172537

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924172537
SQL开始执行时间：20190924172537
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924172537
SQL开始执行时间：20190924172537

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924172537
SQL开始执行时间：20190924172537

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924172537
SQL开始执行时间：20190924172537
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924172538
SQL开始执行时间：20190924172538

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924172538
SQL开始执行时间：20190924172538
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924172538
SQL开始执行时间：20190924172538

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924172538
SQL开始执行时间：20190924172538
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924172539
SQL开始执行时间：20190924172539
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924172539
SQL开始执行时间：20190924172539
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924172539
SQL开始执行时间：20190924172539

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924172539
SQL开始执行时间：20190924172539
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924172540
SQL开始执行时间：20190924172540


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'20'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924172540
SQL开始执行时间：20190924172540


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924172540
SQL开始执行时间：20190924172540

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924172540
SQL开始执行时间：20190924172540

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924172541

20190924175359开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924175359
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924175359
SQL开始执行时间：20190924175359
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924175359
SQL开始执行时间：20190924175359

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924175359
SQL开始执行时间：20190924175359
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924175400
SQL开始执行时间：20190924175400
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175407
SQL开始执行时间：20190924175407
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924175409
SQL开始执行时间：20190924175409
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175409
SQL开始执行时间：20190924175409
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924175409
SQL开始执行时间：20190924175409

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924175409
SQL开始执行时间：20190924175409
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924175409
SQL开始执行时间：20190924175409

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175409
SQL开始执行时间：20190924175409

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924175409
SQL开始执行时间：20190924175409
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175410
SQL开始执行时间：20190924175410

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924175410
SQL开始执行时间：20190924175410
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924175411
SQL开始执行时间：20190924175411

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924175411
SQL开始执行时间：20190924175411
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924175411
SQL开始执行时间：20190924175411
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924175411
SQL开始执行时间：20190924175411
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924175411
SQL开始执行时间：20190924175411

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924175411
SQL开始执行时间：20190924175411
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) = 0 then  d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924175412
SQL开始执行时间：20190924175412


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'1'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924175412
SQL开始执行时间：20190924175412


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924175412
SQL开始执行时间：20190924175412

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924175412
SQL开始执行时间：20190924175412

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924175413

20190924175413开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924175413
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924175413
SQL开始执行时间：20190924175413
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924175413
SQL开始执行时间：20190924175413

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924175413
SQL开始执行时间：20190924175413
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924175414
SQL开始执行时间：20190924175414
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175421
SQL开始执行时间：20190924175421
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924175423
SQL开始执行时间：20190924175423
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175423
SQL开始执行时间：20190924175423
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924175423
SQL开始执行时间：20190924175423

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924175423
SQL开始执行时间：20190924175423
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924175424
SQL开始执行时间：20190924175424

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175424
SQL开始执行时间：20190924175424

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924175424
SQL开始执行时间：20190924175424
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175425
SQL开始执行时间：20190924175425

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924175425
SQL开始执行时间：20190924175425
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924175425
SQL开始执行时间：20190924175425

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924175425
SQL开始执行时间：20190924175425
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924175425
SQL开始执行时间：20190924175425
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924175426
SQL开始执行时间：20190924175426
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924175426
SQL开始执行时间：20190924175426

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924175426
SQL开始执行时间：20190924175426
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) = 0 then  d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924175426
SQL开始执行时间：20190924175426


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'2'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924175426
SQL开始执行时间：20190924175426


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924175426
SQL开始执行时间：20190924175426

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924175426
SQL开始执行时间：20190924175426

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924175427

20190924175427开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924175427
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924175427
SQL开始执行时间：20190924175427
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924175427
SQL开始执行时间：20190924175427

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924175427
SQL开始执行时间：20190924175427
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924175428
SQL开始执行时间：20190924175428

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924175428
SQL开始执行时间：20190924175428
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924175429
SQL开始执行时间：20190924175429

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924175429
SQL开始执行时间：20190924175429
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924175429
SQL开始执行时间：20190924175429

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175429
SQL开始执行时间：20190924175429
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924175429
SQL开始执行时间：20190924175429

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924175429
SQL开始执行时间：20190924175429
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175436
SQL开始执行时间：20190924175436
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924175438
SQL开始执行时间：20190924175438
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175438
SQL开始执行时间：20190924175438
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924175438
SQL开始执行时间：20190924175438

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924175438
SQL开始执行时间：20190924175438
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924175438
SQL开始执行时间：20190924175438

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175438
SQL开始执行时间：20190924175438

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924175438
SQL开始执行时间：20190924175438
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175439
SQL开始执行时间：20190924175439

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924175439
SQL开始执行时间：20190924175439
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924175440
SQL开始执行时间：20190924175440

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924175440
SQL开始执行时间：20190924175440
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924175440
SQL开始执行时间：20190924175440
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924175440
SQL开始执行时间：20190924175440
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924175440
SQL开始执行时间：20190924175440

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924175440
SQL开始执行时间：20190924175440
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) = 0 then  d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924175441
SQL开始执行时间：20190924175441


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'3'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924175441
SQL开始执行时间：20190924175441


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924175441
SQL开始执行时间：20190924175441

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924175441
SQL开始执行时间：20190924175441

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924175441

20190924175442开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924175442
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924175442
SQL开始执行时间：20190924175442
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924175442
SQL开始执行时间：20190924175442

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924175442
SQL开始执行时间：20190924175442
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924175443
SQL开始执行时间：20190924175443

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924175443
SQL开始执行时间：20190924175443
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924175444
SQL开始执行时间：20190924175444

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924175444
SQL开始执行时间：20190924175444
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924175444
SQL开始执行时间：20190924175444

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175444
SQL开始执行时间：20190924175444
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924175444
SQL开始执行时间：20190924175444

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924175444
SQL开始执行时间：20190924175444
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175451
SQL开始执行时间：20190924175451
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924175453
SQL开始执行时间：20190924175453
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175453
SQL开始执行时间：20190924175453
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924175453
SQL开始执行时间：20190924175453

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924175453
SQL开始执行时间：20190924175453
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924175453
SQL开始执行时间：20190924175453

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175453
SQL开始执行时间：20190924175453

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924175453
SQL开始执行时间：20190924175453
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175454
SQL开始执行时间：20190924175454

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924175454
SQL开始执行时间：20190924175454
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924175455
SQL开始执行时间：20190924175455

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924175455
SQL开始执行时间：20190924175455
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924175455
SQL开始执行时间：20190924175455
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924175455
SQL开始执行时间：20190924175455
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924175455
SQL开始执行时间：20190924175455

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924175455
SQL开始执行时间：20190924175455
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) = 0 then  d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924175456
SQL开始执行时间：20190924175456


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'4'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924175456
SQL开始执行时间：20190924175456


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924175456
SQL开始执行时间：20190924175456

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924175456
SQL开始执行时间：20190924175456

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924175456

20190924175457开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924175457
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924175457
SQL开始执行时间：20190924175457
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924175457
SQL开始执行时间：20190924175457

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924175457
SQL开始执行时间：20190924175457
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924175458
SQL开始执行时间：20190924175458

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924175458
SQL开始执行时间：20190924175458
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924175459
SQL开始执行时间：20190924175459

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924175459
SQL开始执行时间：20190924175459
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924175459
SQL开始执行时间：20190924175459

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175459
SQL开始执行时间：20190924175459
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924175459
SQL开始执行时间：20190924175459

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924175459
SQL开始执行时间：20190924175459
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175506
SQL开始执行时间：20190924175506

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924175506
SQL开始执行时间：20190924175506

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924175506
SQL开始执行时间：20190924175506
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175506
SQL开始执行时间：20190924175506

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924175506
SQL开始执行时间：20190924175506
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175506
SQL开始执行时间：20190924175506

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924175507
SQL开始执行时间：20190924175507
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924175507
SQL开始执行时间：20190924175507


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924175507
SQL开始执行时间：20190924175507
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175507
SQL开始执行时间：20190924175507


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175507
SQL开始执行时间：20190924175507
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924175509
SQL开始执行时间：20190924175509
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175509
SQL开始执行时间：20190924175509
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924175509
SQL开始执行时间：20190924175509

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924175509
SQL开始执行时间：20190924175509
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924175509
SQL开始执行时间：20190924175509

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175509
SQL开始执行时间：20190924175509

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924175509
SQL开始执行时间：20190924175509
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175510
SQL开始执行时间：20190924175510

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924175510
SQL开始执行时间：20190924175510
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924175510
SQL开始执行时间：20190924175510

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924175510
SQL开始执行时间：20190924175510
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924175511
SQL开始执行时间：20190924175511
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924175511
SQL开始执行时间：20190924175511
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924175511
SQL开始执行时间：20190924175511

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924175511
SQL开始执行时间：20190924175511
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) = 0 then  d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924175511
SQL开始执行时间：20190924175511


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'5'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924175511
SQL开始执行时间：20190924175511


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924175511
SQL开始执行时间：20190924175511

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924175512
SQL开始执行时间：20190924175512

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924175512

20190924175512开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924175512
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924175512
SQL开始执行时间：20190924175512
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924175513
SQL开始执行时间：20190924175513

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924175513
SQL开始执行时间：20190924175513
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924175514
SQL开始执行时间：20190924175514

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924175514
SQL开始执行时间：20190924175514
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924175514
SQL开始执行时间：20190924175514

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924175514
SQL开始执行时间：20190924175514
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924175514
SQL开始执行时间：20190924175514

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175514
SQL开始执行时间：20190924175514
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924175515
SQL开始执行时间：20190924175515

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924175515
SQL开始执行时间：20190924175515
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175522
SQL开始执行时间：20190924175522
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924175524
SQL开始执行时间：20190924175524
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175524
SQL开始执行时间：20190924175524
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924175524
SQL开始执行时间：20190924175524

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924175524
SQL开始执行时间：20190924175524
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924175524
SQL开始执行时间：20190924175524

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924175524
SQL开始执行时间：20190924175524

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924175524
SQL开始执行时间：20190924175524
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924175525
SQL开始执行时间：20190924175525

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924175525
SQL开始执行时间：20190924175525
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924175525
SQL开始执行时间：20190924175525

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924175525
SQL开始执行时间：20190924175525
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,b.inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924175526
SQL开始执行时间：20190924175526
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924175526
SQL开始执行时间：20190924175526
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924175526
SQL开始执行时间：20190924175526

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924175526
SQL开始执行时间：20190924175526
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) = 0 then  d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person,0) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924175527
SQL开始执行时间：20190924175527


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'6'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924175527
SQL开始执行时间：20190924175527


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924175527
SQL开始执行时间：20190924175527

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924175527
SQL开始执行时间：20190924175527

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924175527

20190924175527开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924175527
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924175527
SQL开始执行时间：20190924175527
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924175528
SQL开始执行时间：20190924175528

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924175528
SQL开始执行时间：20190924175528
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924175529
SQL开始执行时间：20190924175529

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924175529
SQL开始执行时间：20190924175529
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924175530
SQL开始执行时间：20190924175530

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924175530
SQL开始执行时间：20190924175530
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924175530
SQL开始执行时间：20190924175530

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924175530
SQL开始执行时间：20190924175530
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924175530
SQL开始执行时间：20190924175530

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924175530
SQL开始执行时间：20190924175530
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;

20190924180146开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180146
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180146
SQL开始执行时间：20190924180146
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180147
SQL开始执行时间：20190924180147

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180147
SQL开始执行时间：20190924180147
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180147
SQL开始执行时间：20190924180147

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180147
SQL开始执行时间：20190924180147
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180148
SQL开始执行时间：20190924180148

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180148
SQL开始执行时间：20190924180148
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180148
SQL开始执行时间：20190924180148

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180148
SQL开始执行时间：20190924180148
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180148
SQL开始执行时间：20190924180148

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180148
SQL开始执行时间：20190924180148
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180154
SQL开始执行时间：20190924180154

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180154
SQL开始执行时间：20190924180154

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180154
SQL开始执行时间：20190924180154
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180154
SQL开始执行时间：20190924180154

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180154
SQL开始执行时间：20190924180154
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180155
SQL开始执行时间：20190924180155

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180155
SQL开始执行时间：20190924180155
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180155
SQL开始执行时间：20190924180155


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180155
SQL开始执行时间：20190924180155
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180155
SQL开始执行时间：20190924180155


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180155
SQL开始执行时间：20190924180155
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180157
SQL开始执行时间：20190924180157
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180157
SQL开始执行时间：20190924180157
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180157
SQL开始执行时间：20190924180157

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180157
SQL开始执行时间：20190924180157
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180157
SQL开始执行时间：20190924180157

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180157
SQL开始执行时间：20190924180157

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180157
SQL开始执行时间：20190924180157
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180158
SQL开始执行时间：20190924180158

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180158
SQL开始执行时间：20190924180158
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180158
SQL开始执行时间：20190924180158

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180158
SQL开始执行时间：20190924180158
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180159
SQL开始执行时间：20190924180159
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180159
SQL开始执行时间：20190924180159
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180159
SQL开始执行时间：20190924180159

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180159
SQL开始执行时间：20190924180159
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180200
SQL开始执行时间：20190924180200


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'1'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180200
SQL开始执行时间：20190924180200


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180200
SQL开始执行时间：20190924180200

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180200
SQL开始执行时间：20190924180200

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180200

20190924180200开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180200
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180200
SQL开始执行时间：20190924180200
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180201
SQL开始执行时间：20190924180201

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180201
SQL开始执行时间：20190924180201
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180201
SQL开始执行时间：20190924180201

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180201
SQL开始执行时间：20190924180201
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180202
SQL开始执行时间：20190924180202

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180202
SQL开始执行时间：20190924180202
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180202
SQL开始执行时间：20190924180202

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180202
SQL开始执行时间：20190924180202
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180202
SQL开始执行时间：20190924180202

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180202
SQL开始执行时间：20190924180202
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180209
SQL开始执行时间：20190924180209
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180211
SQL开始执行时间：20190924180211
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180211
SQL开始执行时间：20190924180211
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180211
SQL开始执行时间：20190924180211

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180211
SQL开始执行时间：20190924180211
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180211
SQL开始执行时间：20190924180211

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180211
SQL开始执行时间：20190924180211

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180211
SQL开始执行时间：20190924180211
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180212
SQL开始执行时间：20190924180212

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180212
SQL开始执行时间：20190924180212
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180212
SQL开始执行时间：20190924180212

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180212
SQL开始执行时间：20190924180212
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180213
SQL开始执行时间：20190924180213
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180213
SQL开始执行时间：20190924180213
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180213
SQL开始执行时间：20190924180213

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180213
SQL开始执行时间：20190924180213
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180214
SQL开始执行时间：20190924180214


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'2'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180214
SQL开始执行时间：20190924180214


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180214
SQL开始执行时间：20190924180214

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180214
SQL开始执行时间：20190924180214

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180214

20190924180214开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180214
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180214
SQL开始执行时间：20190924180214
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180215
SQL开始执行时间：20190924180215

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180215
SQL开始执行时间：20190924180215
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180216
SQL开始执行时间：20190924180216
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;

20190924180821开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180821
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180821
SQL开始执行时间：20190924180821
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180821
SQL开始执行时间：20190924180821

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180821
SQL开始执行时间：20190924180821
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180822
SQL开始执行时间：20190924180822
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180829
SQL开始执行时间：20190924180829
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180831
SQL开始执行时间：20190924180831
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180831
SQL开始执行时间：20190924180831
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180831
SQL开始执行时间：20190924180831

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180831
SQL开始执行时间：20190924180831
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180831
SQL开始执行时间：20190924180831

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180831
SQL开始执行时间：20190924180831

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180831
SQL开始执行时间：20190924180831
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180832
SQL开始执行时间：20190924180832

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180832
SQL开始执行时间：20190924180832
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180833
SQL开始执行时间：20190924180833

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180833
SQL开始执行时间：20190924180833
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180833
SQL开始执行时间：20190924180833
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180833
SQL开始执行时间：20190924180833
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180833
SQL开始执行时间：20190924180833

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180833
SQL开始执行时间：20190924180833
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180834
SQL开始执行时间：20190924180834


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'1'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180834
SQL开始执行时间：20190924180834


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180834
SQL开始执行时间：20190924180834

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180834
SQL开始执行时间：20190924180834

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180835

20190924180835开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180835
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180835
SQL开始执行时间：20190924180835
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180835
SQL开始执行时间：20190924180835

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180835
SQL开始执行时间：20190924180835
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180836
SQL开始执行时间：20190924180836
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180843
SQL开始执行时间：20190924180843
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180845
SQL开始执行时间：20190924180845
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180845
SQL开始执行时间：20190924180845
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180845
SQL开始执行时间：20190924180845

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180845
SQL开始执行时间：20190924180845
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180845
SQL开始执行时间：20190924180845

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180845
SQL开始执行时间：20190924180845

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180845
SQL开始执行时间：20190924180845
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180846
SQL开始执行时间：20190924180846

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180846
SQL开始执行时间：20190924180846
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180847
SQL开始执行时间：20190924180847

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180847
SQL开始执行时间：20190924180847
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180847
SQL开始执行时间：20190924180847
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180847
SQL开始执行时间：20190924180847
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180847
SQL开始执行时间：20190924180847

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180847
SQL开始执行时间：20190924180847
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180848
SQL开始执行时间：20190924180848


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'2'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180848
SQL开始执行时间：20190924180848


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180848
SQL开始执行时间：20190924180848

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180848
SQL开始执行时间：20190924180848

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180849

20190924180849开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180849
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180849
SQL开始执行时间：20190924180849
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180849
SQL开始执行时间：20190924180849

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180849
SQL开始执行时间：20190924180849
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180850
SQL开始执行时间：20190924180850

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180850
SQL开始执行时间：20190924180850
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180851
SQL开始执行时间：20190924180851

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180851
SQL开始执行时间：20190924180851
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180851
SQL开始执行时间：20190924180851

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180851
SQL开始执行时间：20190924180851
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180851
SQL开始执行时间：20190924180851

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180851
SQL开始执行时间：20190924180851
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180857
SQL开始执行时间：20190924180857

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180858
SQL开始执行时间：20190924180858
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180900
SQL开始执行时间：20190924180900
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180900
SQL开始执行时间：20190924180900
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180900
SQL开始执行时间：20190924180900

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180900
SQL开始执行时间：20190924180900
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180900
SQL开始执行时间：20190924180900

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180900
SQL开始执行时间：20190924180900

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180900
SQL开始执行时间：20190924180900
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180901
SQL开始执行时间：20190924180901

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180901
SQL开始执行时间：20190924180901
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180901
SQL开始执行时间：20190924180901

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180901
SQL开始执行时间：20190924180901
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180902
SQL开始执行时间：20190924180902
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180902
SQL开始执行时间：20190924180902
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180902
SQL开始执行时间：20190924180902

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180902
SQL开始执行时间：20190924180902
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180903
SQL开始执行时间：20190924180903


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'3'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180903
SQL开始执行时间：20190924180903


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180903
SQL开始执行时间：20190924180903

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180903
SQL开始执行时间：20190924180903

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180903

20190924180903开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180903
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180903
SQL开始执行时间：20190924180903
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180904
SQL开始执行时间：20190924180904

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180904
SQL开始执行时间：20190924180904
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180905
SQL开始执行时间：20190924180905

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180905
SQL开始执行时间：20190924180905
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180906
SQL开始执行时间：20190924180906

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180906
SQL开始执行时间：20190924180906
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180906
SQL开始执行时间：20190924180906

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180906
SQL开始执行时间：20190924180906
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180906
SQL开始执行时间：20190924180906

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180906
SQL开始执行时间：20190924180906
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180913
SQL开始执行时间：20190924180913
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180915
SQL开始执行时间：20190924180915
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180915
SQL开始执行时间：20190924180915
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180915
SQL开始执行时间：20190924180915

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180915
SQL开始执行时间：20190924180915
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180915
SQL开始执行时间：20190924180915

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180915
SQL开始执行时间：20190924180915

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180915
SQL开始执行时间：20190924180915
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180916
SQL开始执行时间：20190924180916

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180916
SQL开始执行时间：20190924180916
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180916
SQL开始执行时间：20190924180916

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180916
SQL开始执行时间：20190924180916
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180917
SQL开始执行时间：20190924180917
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180917
SQL开始执行时间：20190924180917
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180917
SQL开始执行时间：20190924180917

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180917
SQL开始执行时间：20190924180917
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180918
SQL开始执行时间：20190924180918


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'4'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180918
SQL开始执行时间：20190924180918


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180918
SQL开始执行时间：20190924180918

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180918
SQL开始执行时间：20190924180918

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180918

20190924180918开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180918
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180918
SQL开始执行时间：20190924180918
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180919
SQL开始执行时间：20190924180919

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180919
SQL开始执行时间：20190924180919
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180920
SQL开始执行时间：20190924180920

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180920
SQL开始执行时间：20190924180920
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180921
SQL开始执行时间：20190924180921

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180921
SQL开始执行时间：20190924180921
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180921
SQL开始执行时间：20190924180921

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180921
SQL开始执行时间：20190924180921
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180921
SQL开始执行时间：20190924180921

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180921
SQL开始执行时间：20190924180921
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180928
SQL开始执行时间：20190924180928
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180930
SQL开始执行时间：20190924180930
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180930
SQL开始执行时间：20190924180930
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180930
SQL开始执行时间：20190924180930

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180930
SQL开始执行时间：20190924180930
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180930
SQL开始执行时间：20190924180930

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180930
SQL开始执行时间：20190924180930

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180930
SQL开始执行时间：20190924180930
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180931
SQL开始执行时间：20190924180931

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180931
SQL开始执行时间：20190924180931
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180932
SQL开始执行时间：20190924180932

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180932
SQL开始执行时间：20190924180932
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180932
SQL开始执行时间：20190924180932
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180932
SQL开始执行时间：20190924180932
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180932
SQL开始执行时间：20190924180932

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180932
SQL开始执行时间：20190924180932
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180933
SQL开始执行时间：20190924180933


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'5'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180933
SQL开始执行时间：20190924180933


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180933
SQL开始执行时间：20190924180933

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180933
SQL开始执行时间：20190924180933

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180933

20190924180934开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180934
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180934
SQL开始执行时间：20190924180934
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180934
SQL开始执行时间：20190924180934

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180934
SQL开始执行时间：20190924180934
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180935
SQL开始执行时间：20190924180935

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180935
SQL开始执行时间：20190924180935
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180936
SQL开始执行时间：20190924180936

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180936
SQL开始执行时间：20190924180936
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180936
SQL开始执行时间：20190924180936

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180936
SQL开始执行时间：20190924180936
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180936
SQL开始执行时间：20190924180936

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180936
SQL开始执行时间：20190924180936
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180943
SQL开始执行时间：20190924180943
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180944
SQL开始执行时间：20190924180944


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180944
SQL开始执行时间：20190924180944
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924180946
SQL开始执行时间：20190924180946
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180946
SQL开始执行时间：20190924180946
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924180946
SQL开始执行时间：20190924180946

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924180946
SQL开始执行时间：20190924180946
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924180946
SQL开始执行时间：20190924180946

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180946
SQL开始执行时间：20190924180946

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924180946
SQL开始执行时间：20190924180946
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180947
SQL开始执行时间：20190924180947

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924180947
SQL开始执行时间：20190924180947
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924180947
SQL开始执行时间：20190924180947

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924180947
SQL开始执行时间：20190924180947
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924180948
SQL开始执行时间：20190924180948
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924180948
SQL开始执行时间：20190924180948
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924180948
SQL开始执行时间：20190924180948

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924180948
SQL开始执行时间：20190924180948
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924180948
SQL开始执行时间：20190924180948


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'6'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924180948
SQL开始执行时间：20190924180948


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924180949
SQL开始执行时间：20190924180949

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924180949
SQL开始执行时间：20190924180949

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924180949

20190924180949开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924180949
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924180949
SQL开始执行时间：20190924180949
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924180950
SQL开始执行时间：20190924180950

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924180950
SQL开始执行时间：20190924180950
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924180951
SQL开始执行时间：20190924180951

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924180951
SQL开始执行时间：20190924180951
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924180951
SQL开始执行时间：20190924180951

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924180951
SQL开始执行时间：20190924180951
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924180951
SQL开始执行时间：20190924180951

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924180952
SQL开始执行时间：20190924180952
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924180952
SQL开始执行时间：20190924180952

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924180952
SQL开始执行时间：20190924180952
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924180959
SQL开始执行时间：20190924180959
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181001
SQL开始执行时间：20190924181001
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181001
SQL开始执行时间：20190924181001
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181001
SQL开始执行时间：20190924181001

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181001
SQL开始执行时间：20190924181001
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181001
SQL开始执行时间：20190924181001

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181001
SQL开始执行时间：20190924181001

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181001
SQL开始执行时间：20190924181001
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181002
SQL开始执行时间：20190924181002

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181002
SQL开始执行时间：20190924181002
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181003
SQL开始执行时间：20190924181003

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181003
SQL开始执行时间：20190924181003
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181003
SQL开始执行时间：20190924181003
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181003
SQL开始执行时间：20190924181003
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181003
SQL开始执行时间：20190924181003

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181003
SQL开始执行时间：20190924181003
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181004
SQL开始执行时间：20190924181004


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'7'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181004
SQL开始执行时间：20190924181004


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181004
SQL开始执行时间：20190924181004

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181004
SQL开始执行时间：20190924181004

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181005

20190924181005开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181005
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181005
SQL开始执行时间：20190924181005
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181006
SQL开始执行时间：20190924181006

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181006
SQL开始执行时间：20190924181006
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181007
SQL开始执行时间：20190924181007
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181015
SQL开始执行时间：20190924181015
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181017
SQL开始执行时间：20190924181017
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181017
SQL开始执行时间：20190924181017
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181017
SQL开始执行时间：20190924181017

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181017
SQL开始执行时间：20190924181017
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181017
SQL开始执行时间：20190924181017

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181017
SQL开始执行时间：20190924181017

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181017
SQL开始执行时间：20190924181017
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181018
SQL开始执行时间：20190924181018

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181018
SQL开始执行时间：20190924181018
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181019
SQL开始执行时间：20190924181019

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181019
SQL开始执行时间：20190924181019
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181019
SQL开始执行时间：20190924181019
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181019
SQL开始执行时间：20190924181019
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181019
SQL开始执行时间：20190924181019

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181019
SQL开始执行时间：20190924181019
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181020
SQL开始执行时间：20190924181020


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'8'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181020
SQL开始执行时间：20190924181020


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181020
SQL开始执行时间：20190924181020

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181020
SQL开始执行时间：20190924181020

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181020

20190924181021开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181021
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181021
SQL开始执行时间：20190924181021
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181021
SQL开始执行时间：20190924181021

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181021
SQL开始执行时间：20190924181021
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181023
SQL开始执行时间：20190924181023
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181031
SQL开始执行时间：20190924181031
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181033
SQL开始执行时间：20190924181033
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181033
SQL开始执行时间：20190924181033
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181033
SQL开始执行时间：20190924181033

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181033
SQL开始执行时间：20190924181033
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181033
SQL开始执行时间：20190924181033

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181033
SQL开始执行时间：20190924181033

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181033
SQL开始执行时间：20190924181033
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181034
SQL开始执行时间：20190924181034

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181034
SQL开始执行时间：20190924181034
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181035
SQL开始执行时间：20190924181035

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181035
SQL开始执行时间：20190924181035
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181035
SQL开始执行时间：20190924181035
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181035
SQL开始执行时间：20190924181035
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181035
SQL开始执行时间：20190924181035

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181035
SQL开始执行时间：20190924181035
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181036
SQL开始执行时间：20190924181036


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'9'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181036
SQL开始执行时间：20190924181036


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181036
SQL开始执行时间：20190924181036

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181036
SQL开始执行时间：20190924181036

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181036

20190924181037开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181037
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181037
SQL开始执行时间：20190924181037
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181037
SQL开始执行时间：20190924181037

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181037
SQL开始执行时间：20190924181037
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181039
SQL开始执行时间：20190924181039
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181047
SQL开始执行时间：20190924181047
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181049
SQL开始执行时间：20190924181049
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181049
SQL开始执行时间：20190924181049
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181050
SQL开始执行时间：20190924181050

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181050
SQL开始执行时间：20190924181050
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181050
SQL开始执行时间：20190924181050

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181050
SQL开始执行时间：20190924181050

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181050
SQL开始执行时间：20190924181050
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181051
SQL开始执行时间：20190924181051

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181051
SQL开始执行时间：20190924181051
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181051
SQL开始执行时间：20190924181051

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181051
SQL开始执行时间：20190924181051
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181051
SQL开始执行时间：20190924181051
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181052
SQL开始执行时间：20190924181052
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181052
SQL开始执行时间：20190924181052

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181052
SQL开始执行时间：20190924181052
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181052
SQL开始执行时间：20190924181052


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'10'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181052
SQL开始执行时间：20190924181052


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181052
SQL开始执行时间：20190924181052

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181053
SQL开始执行时间：20190924181053

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181053

20190924181053开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181053
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181053
SQL开始执行时间：20190924181053
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181054
SQL开始执行时间：20190924181054

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181054
SQL开始执行时间：20190924181054
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181055
SQL开始执行时间：20190924181055

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181055
SQL开始执行时间：20190924181055
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181055
SQL开始执行时间：20190924181055

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181055
SQL开始执行时间：20190924181055
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181056
SQL开始执行时间：20190924181056

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181056
SQL开始执行时间：20190924181056
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181056
SQL开始执行时间：20190924181056

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181056
SQL开始执行时间：20190924181056
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181104
SQL开始执行时间：20190924181104
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181106
SQL开始执行时间：20190924181106
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181106
SQL开始执行时间：20190924181106
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181106
SQL开始执行时间：20190924181106

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181106
SQL开始执行时间：20190924181106
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181106
SQL开始执行时间：20190924181106

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181106
SQL开始执行时间：20190924181106

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181106
SQL开始执行时间：20190924181106
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181107
SQL开始执行时间：20190924181107

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181107
SQL开始执行时间：20190924181107
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181108
SQL开始执行时间：20190924181108

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181108
SQL开始执行时间：20190924181108
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181108
SQL开始执行时间：20190924181108
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181108
SQL开始执行时间：20190924181108
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181108
SQL开始执行时间：20190924181108

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181108
SQL开始执行时间：20190924181108
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181109
SQL开始执行时间：20190924181109


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'11'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181109
SQL开始执行时间：20190924181109


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181109
SQL开始执行时间：20190924181109

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181109
SQL开始执行时间：20190924181109

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181110

20190924181110开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181110
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181110
SQL开始执行时间：20190924181110
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181111
SQL开始执行时间：20190924181111

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181111
SQL开始执行时间：20190924181111
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181112
SQL开始执行时间：20190924181112
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181120
SQL开始执行时间：20190924181120

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181121
SQL开始执行时间：20190924181121
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181123
SQL开始执行时间：20190924181123
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181123
SQL开始执行时间：20190924181123
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181123
SQL开始执行时间：20190924181123

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181123
SQL开始执行时间：20190924181123
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181123
SQL开始执行时间：20190924181123

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181123
SQL开始执行时间：20190924181123

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181123
SQL开始执行时间：20190924181123
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181124
SQL开始执行时间：20190924181124

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181124
SQL开始执行时间：20190924181124
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181124
SQL开始执行时间：20190924181124

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181124
SQL开始执行时间：20190924181124
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181125
SQL开始执行时间：20190924181125
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181125
SQL开始执行时间：20190924181125
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181125
SQL开始执行时间：20190924181125

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181125
SQL开始执行时间：20190924181125
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181126
SQL开始执行时间：20190924181126


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'12'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181126
SQL开始执行时间：20190924181126


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181126
SQL开始执行时间：20190924181126

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181126
SQL开始执行时间：20190924181126

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181126

20190924181126开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181126
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181126
SQL开始执行时间：20190924181126
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181127
SQL开始执行时间：20190924181127

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181127
SQL开始执行时间：20190924181127
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181128
SQL开始执行时间：20190924181128

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181128
SQL开始执行时间：20190924181128
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181129
SQL开始执行时间：20190924181129

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181129
SQL开始执行时间：20190924181129
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181129
SQL开始执行时间：20190924181129

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181129
SQL开始执行时间：20190924181129
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181129
SQL开始执行时间：20190924181129

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181129
SQL开始执行时间：20190924181129
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181137
SQL开始执行时间：20190924181137

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181137
SQL开始执行时间：20190924181137

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181137
SQL开始执行时间：20190924181137
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181137
SQL开始执行时间：20190924181137

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181137
SQL开始执行时间：20190924181137
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181137
SQL开始执行时间：20190924181137

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181138
SQL开始执行时间：20190924181138
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181138
SQL开始执行时间：20190924181138


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181138
SQL开始执行时间：20190924181138
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181138
SQL开始执行时间：20190924181138


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181138
SQL开始执行时间：20190924181138
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181140
SQL开始执行时间：20190924181140
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181140
SQL开始执行时间：20190924181140
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181140
SQL开始执行时间：20190924181140

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181140
SQL开始执行时间：20190924181140
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181140
SQL开始执行时间：20190924181140

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181140
SQL开始执行时间：20190924181140

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181140
SQL开始执行时间：20190924181140
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181141
SQL开始执行时间：20190924181141

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181141
SQL开始执行时间：20190924181141
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181141
SQL开始执行时间：20190924181141

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181141
SQL开始执行时间：20190924181141
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181142
SQL开始执行时间：20190924181142
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181142
SQL开始执行时间：20190924181142
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181142
SQL开始执行时间：20190924181142

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181142
SQL开始执行时间：20190924181142
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181143
SQL开始执行时间：20190924181143


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'13'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181143
SQL开始执行时间：20190924181143


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181143
SQL开始执行时间：20190924181143

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181143
SQL开始执行时间：20190924181143

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181143

20190924181143开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181143
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181143
SQL开始执行时间：20190924181143
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181144
SQL开始执行时间：20190924181144

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181144
SQL开始执行时间：20190924181144
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181145
SQL开始执行时间：20190924181145

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181145
SQL开始执行时间：20190924181145
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181146
SQL开始执行时间：20190924181146

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181146
SQL开始执行时间：20190924181146
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181146
SQL开始执行时间：20190924181146

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181146
SQL开始执行时间：20190924181146
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181146
SQL开始执行时间：20190924181146

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181146
SQL开始执行时间：20190924181146
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181154
SQL开始执行时间：20190924181154

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181155
SQL开始执行时间：20190924181155
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181157
SQL开始执行时间：20190924181157
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181157
SQL开始执行时间：20190924181157
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181157
SQL开始执行时间：20190924181157

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181157
SQL开始执行时间：20190924181157
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181157
SQL开始执行时间：20190924181157

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181157
SQL开始执行时间：20190924181157

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181157
SQL开始执行时间：20190924181157
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181158
SQL开始执行时间：20190924181158

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181158
SQL开始执行时间：20190924181158
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181158
SQL开始执行时间：20190924181158

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181158
SQL开始执行时间：20190924181158
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181159
SQL开始执行时间：20190924181159
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181159
SQL开始执行时间：20190924181159
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181159
SQL开始执行时间：20190924181159

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181159
SQL开始执行时间：20190924181159
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181200
SQL开始执行时间：20190924181200


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'14'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181200
SQL开始执行时间：20190924181200


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181200
SQL开始执行时间：20190924181200

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181200
SQL开始执行时间：20190924181200

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181200

20190924181201开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181201
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181201
SQL开始执行时间：20190924181201
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181201
SQL开始执行时间：20190924181201

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181202
SQL开始执行时间：20190924181202
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181203
SQL开始执行时间：20190924181203
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181212
SQL开始执行时间：20190924181212
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181214
SQL开始执行时间：20190924181214
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181214
SQL开始执行时间：20190924181214
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181214
SQL开始执行时间：20190924181214

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181214
SQL开始执行时间：20190924181214
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181215
SQL开始执行时间：20190924181215

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181215
SQL开始执行时间：20190924181215

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181215
SQL开始执行时间：20190924181215
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181216
SQL开始执行时间：20190924181216

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181216
SQL开始执行时间：20190924181216
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181216
SQL开始执行时间：20190924181216

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181216
SQL开始执行时间：20190924181216
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181216
SQL开始执行时间：20190924181216
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181216
SQL开始执行时间：20190924181216
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181217
SQL开始执行时间：20190924181217

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181217
SQL开始执行时间：20190924181217
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181217
SQL开始执行时间：20190924181217


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'15'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181217
SQL开始执行时间：20190924181217


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181217
SQL开始执行时间：20190924181217

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181217
SQL开始执行时间：20190924181217

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181218

20190924181218开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181218
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181218
SQL开始执行时间：20190924181218
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181219
SQL开始执行时间：20190924181219

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181219
SQL开始执行时间：20190924181219
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181220
SQL开始执行时间：20190924181220

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181220
SQL开始执行时间：20190924181220
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181221
SQL开始执行时间：20190924181221

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181221
SQL开始执行时间：20190924181221
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181221
SQL开始执行时间：20190924181221

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181221
SQL开始执行时间：20190924181221
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181221
SQL开始执行时间：20190924181221

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181221
SQL开始执行时间：20190924181221
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181229
SQL开始执行时间：20190924181229

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181229
SQL开始执行时间：20190924181229

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181229
SQL开始执行时间：20190924181229
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181229
SQL开始执行时间：20190924181229

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181230
SQL开始执行时间：20190924181230
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181230
SQL开始执行时间：20190924181230

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181230
SQL开始执行时间：20190924181230
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181230
SQL开始执行时间：20190924181230


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181230
SQL开始执行时间：20190924181230
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181230
SQL开始执行时间：20190924181230


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181230
SQL开始执行时间：20190924181230
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181232
SQL开始执行时间：20190924181232
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181232
SQL开始执行时间：20190924181232
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181232
SQL开始执行时间：20190924181232

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181232
SQL开始执行时间：20190924181232
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181232
SQL开始执行时间：20190924181232

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181232
SQL开始执行时间：20190924181232

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181232
SQL开始执行时间：20190924181232
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181233
SQL开始执行时间：20190924181233

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181233
SQL开始执行时间：20190924181233
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181233
SQL开始执行时间：20190924181233

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181233
SQL开始执行时间：20190924181233
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181234
SQL开始执行时间：20190924181234
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181234
SQL开始执行时间：20190924181234
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181234
SQL开始执行时间：20190924181234

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181234
SQL开始执行时间：20190924181234
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181235
SQL开始执行时间：20190924181235


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'16'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181235
SQL开始执行时间：20190924181235


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181235
SQL开始执行时间：20190924181235

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181235
SQL开始执行时间：20190924181235

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181235

20190924181235开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181235
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181235
SQL开始执行时间：20190924181235
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181236
SQL开始执行时间：20190924181236

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181236
SQL开始执行时间：20190924181236
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181237
SQL开始执行时间：20190924181237

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181237
SQL开始执行时间：20190924181237
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181238
SQL开始执行时间：20190924181238

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181238
SQL开始执行时间：20190924181238
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181238
SQL开始执行时间：20190924181238

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181238
SQL开始执行时间：20190924181238
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181238
SQL开始执行时间：20190924181238

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181238
SQL开始执行时间：20190924181238
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181247
SQL开始执行时间：20190924181247
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181249
SQL开始执行时间：20190924181249
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181249
SQL开始执行时间：20190924181249
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181250
SQL开始执行时间：20190924181250

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181250
SQL开始执行时间：20190924181250
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181250
SQL开始执行时间：20190924181250

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181250
SQL开始执行时间：20190924181250

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181250
SQL开始执行时间：20190924181250
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181251
SQL开始执行时间：20190924181251

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181251
SQL开始执行时间：20190924181251
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181251
SQL开始执行时间：20190924181251

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181251
SQL开始执行时间：20190924181251
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181252
SQL开始执行时间：20190924181252
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181252
SQL开始执行时间：20190924181252
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181252
SQL开始执行时间：20190924181252

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181252
SQL开始执行时间：20190924181252
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181252
SQL开始执行时间：20190924181252


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'17'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181252
SQL开始执行时间：20190924181252


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181252
SQL开始执行时间：20190924181252

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181253
SQL开始执行时间：20190924181253

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181253

20190924181253开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181253
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181253
SQL开始执行时间：20190924181253
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181254
SQL开始执行时间：20190924181254

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181254
SQL开始执行时间：20190924181254
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181255
SQL开始执行时间：20190924181255

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181255
SQL开始执行时间：20190924181255
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181256
SQL开始执行时间：20190924181256

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181256
SQL开始执行时间：20190924181256
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181256
SQL开始执行时间：20190924181256

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181256
SQL开始执行时间：20190924181256
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181256
SQL开始执行时间：20190924181256

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181256
SQL开始执行时间：20190924181256
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181305
SQL开始执行时间：20190924181305
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181307
SQL开始执行时间：20190924181307
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181307
SQL开始执行时间：20190924181307
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181307
SQL开始执行时间：20190924181307

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181307
SQL开始执行时间：20190924181307
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181308
SQL开始执行时间：20190924181308

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181308
SQL开始执行时间：20190924181308

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181308
SQL开始执行时间：20190924181308
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181309
SQL开始执行时间：20190924181309

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181309
SQL开始执行时间：20190924181309
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181309
SQL开始执行时间：20190924181309

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181309
SQL开始执行时间：20190924181309
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181309
SQL开始执行时间：20190924181309
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181309
SQL开始执行时间：20190924181309
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181310
SQL开始执行时间：20190924181310

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181310
SQL开始执行时间：20190924181310
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181310
SQL开始执行时间：20190924181310


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'18'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181310
SQL开始执行时间：20190924181310


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181310
SQL开始执行时间：20190924181310

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181310
SQL开始执行时间：20190924181310

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181311

20190924181311开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181311
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181311
SQL开始执行时间：20190924181311
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181312
SQL开始执行时间：20190924181312

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181312
SQL开始执行时间：20190924181312
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181313
SQL开始执行时间：20190924181313

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181313
SQL开始执行时间：20190924181313
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181314
SQL开始执行时间：20190924181314

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181314
SQL开始执行时间：20190924181314
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181314
SQL开始执行时间：20190924181314

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181314
SQL开始执行时间：20190924181314
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181314
SQL开始执行时间：20190924181314

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181314
SQL开始执行时间：20190924181314
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181323
SQL开始执行时间：20190924181323

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181323
SQL开始执行时间：20190924181323

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181323
SQL开始执行时间：20190924181323
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181323
SQL开始执行时间：20190924181323

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181323
SQL开始执行时间：20190924181323
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181323
SQL开始执行时间：20190924181323

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181323
SQL开始执行时间：20190924181323
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181324
SQL开始执行时间：20190924181324


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181324
SQL开始执行时间：20190924181324
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181324
SQL开始执行时间：20190924181324


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181324
SQL开始执行时间：20190924181324
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181326
SQL开始执行时间：20190924181326
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181326
SQL开始执行时间：20190924181326
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181326
SQL开始执行时间：20190924181326

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181326
SQL开始执行时间：20190924181326
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181326
SQL开始执行时间：20190924181326

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181326
SQL开始执行时间：20190924181326

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181326
SQL开始执行时间：20190924181326
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181327
SQL开始执行时间：20190924181327

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181327
SQL开始执行时间：20190924181327
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181327
SQL开始执行时间：20190924181327

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181327
SQL开始执行时间：20190924181327
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181328
SQL开始执行时间：20190924181328
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181328
SQL开始执行时间：20190924181328
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181328
SQL开始执行时间：20190924181328

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181328
SQL开始执行时间：20190924181328
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181329
SQL开始执行时间：20190924181329


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'19'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181329
SQL开始执行时间：20190924181329


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181329
SQL开始执行时间：20190924181329

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181329
SQL开始执行时间：20190924181329

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181329

20190924181329开始执行2019-09-24数据加载日志:
SQL开始执行时间：20190924181329
drop table if exists pdm.outdepot_forecast_pre1
;
SQL结束执行时间：20190924181329
SQL开始执行时间：20190924181329
create temporary table pdm.outdepot_forecast_pre1 as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.inum_person
  from (select finnal_ccuscode as ccuscode
              ,item_code
              ,concat(left(tbilldate,7),'-01') as ddate
      ,round(inum_person,2) as inum_person
          from pdm.yj_outdepot_fx
         group by finnal_ccuscode,item_code,left(tbilldate,7)
         order by finnal_ccuscode,item_code,left(tbilldate,7) desc
        ) a
 group by a.ccuscode,a.item_code

;
SQL结束执行时间：20190924181330
SQL开始执行时间：20190924181330

drop table if exists pdm.outdepot_forecast_pre2
;
SQL结束执行时间：20190924181330
SQL开始执行时间：20190924181330
create temporary table pdm.outdepot_forecast_pre2 as
select finnal_ccuscode as ccuscode
      ,item_code
      ,concat(left(tbilldate,7),'-01') as ddate
      ,round(sum(inum_person),2) as inum_person
  from pdm.yj_outdepot_fx
 group by finnal_ccuscode,item_code,left(tbilldate,7)
 order by finnal_ccuscode,item_code,left(tbilldate,7) desc

;
SQL结束执行时间：20190924181332
SQL开始执行时间：20190924181332

drop table if exists pdm.outdepot_forecast
;
SQL结束执行时间：20190924181332
SQL开始执行时间：20190924181332
create temporary table pdm.outdepot_forecast as
select @r:= case when @ccuscode=a.ccuscode and @item_code = a.item_code then @r+1 else 1 end as rownum
      ,@ccuscode:=a.ccuscode as ccuscode
      ,@item_code:=a.item_code as item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast_pre2 a,(select @r:=0,@ccuscode:='',@item_code:='') b

;
SQL结束执行时间：20190924181332
SQL开始执行时间：20190924181332

drop table if exists pdm.outdepot_forecast_1
;
SQL结束执行时间：20190924181332
SQL开始执行时间：20190924181332
create temporary table pdm.outdepot_forecast_1 as
select rownum
      ,ccuscode
      ,item_code
      ,ddate
      ,inum_person
  from pdm.outdepot_forecast
 where rownum = 1

;
SQL结束执行时间：20190924181332
SQL开始执行时间：20190924181332

alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181332
SQL开始执行时间：20190924181332
alter table pdm.outdepot_forecast_1 add index index_outdepot_forecast_1_item_code(item_code)
;
SQL结束执行时间：20190924181333
SQL开始执行时间：20190924181333

drop table if exists pdm.outdepot_forecast_12
;
SQL结束执行时间：20190924181333
SQL开始执行时间：20190924181333
create temporary table pdm.outdepot_forecast_12 as
select b.rownum
      ,a.ccuscode
      ,a.item_code
      ,b.ddate
      ,TIMESTAMPDIFF(MONTH,b.ddate,a.ddate) as mon_diff
      ,b.inum_person
  from pdm.outdepot_forecast_1 a
  left join pdm.outdepot_forecast  b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342

delete from pdm.outdepot_forecast_12 where mon_diff >= 12
;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342

drop table if exists pdm.outdepot_forecast_12_first
;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342
create temporary table pdm.outdepot_forecast_12_first as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342

drop table if exists pdm.outdepot_forecast_count
;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342
create temporary table pdm.outdepot_forecast_count as
select a.ccuscode
      ,a.item_code
      ,count(*) as ct
  from pdm.outdepot_forecast_12 a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342

update pdm.outdepot_forecast_12 a
 inner join (select * from pdm.outdepot_forecast_count where ct >= 5) b
    on a.ccuscode = b.ccuscode 
   and a.item_code = b.item_code
   set inum_person = 0
 where rownum >= 5

;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342
delete from pdm.outdepot_forecast_12 where inum_person = 0
;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342


drop table if exists pdm.outdepot_forecast_last
;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342
create temporary table pdm.outdepot_forecast_last as
select a.ccuscode
      ,a.item_code
      ,max(a.mon_diff) as mon_diff
      ,inum_person
      ,ddate
  from (select * from pdm.outdepot_forecast_12 order by inum_person) a
 group by ccuscode,item_code

;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342


drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181342
SQL开始执行时间：20190924181342
create table pdm.outdepot_forecast_fx1 as
select a.rownum 
      ,a.ccuscode
      ,a.item_code
      ,c.ddate
      ,a.mon_diff
      ,a.inum_person
      ,b.ct
      ,c.mon_diff as max_mon
  from pdm.outdepot_forecast_12 a
  left join pdm.outdepot_forecast_count b
    on a.ccuscode = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_last c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
   

;
SQL结束执行时间：20190924181344
SQL开始执行时间：20190924181344
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_ccuscode(ccuscode)
;
SQL结束执行时间：20190924181344
SQL开始执行时间：20190924181344
alter table pdm.outdepot_forecast_fx1 add index index_outdepot_forecast_fx1_item_code(item_code)
;
SQL结束执行时间：20190924181344
SQL开始执行时间：20190924181344

drop table if exists pdm.outdepot_forecast_fx
;
SQL结束执行时间：20190924181344
SQL开始执行时间：20190924181344
create table pdm.outdepot_forecast_fx as
select a.ccuscode
      ,a.item_code
      ,b.ddate
      ,b.ct
      ,b.max_mon
      ,ifnull(b.inum_person,0) as mon_1
      ,ifnull(c.inum_person,0) as mon_2
      ,ifnull(d.inum_person,0) as mon_3
      ,ifnull(e.inum_person,0) as mon_4
      ,ifnull(f.inum_person,0) as mon_5
      ,ifnull(g.inum_person,0) as mon_6
      ,ifnull(h.inum_person,0) as mon_7
      ,ifnull(i.inum_person,0) as mon_8
      ,ifnull(j.inum_person,0) as mon_9
      ,ifnull(k.inum_person,0) as mon_10
      ,ifnull(l.inum_person,0) as mon_11
      ,ifnull(m.inum_person,0) as mon_12
  from pdm.outdepot_forecast_1 a
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 0) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 1) c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 2) d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 3) e
    on a.ccuscode  = e.ccuscode
   and a.item_code = e.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 4) f
    on a.ccuscode  = f.ccuscode
   and a.item_code = f.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 5) g
    on a.ccuscode  = g.ccuscode
   and a.item_code = g.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 6) h
    on a.ccuscode  = h.ccuscode
   and a.item_code = h.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 7) i
    on a.ccuscode  = i.ccuscode
   and a.item_code = i.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 8) j
    on a.ccuscode  = j.ccuscode
   and a.item_code = j.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 9) k
    on a.ccuscode  = k.ccuscode
   and a.item_code = k.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 10) l
    on a.ccuscode  = l.ccuscode
   and a.item_code = l.item_code
  left join (select * from pdm.outdepot_forecast_fx1 where mon_diff = 11) m
    on a.ccuscode  = m.ccuscode
   and a.item_code = m.item_code

;
SQL结束执行时间：20190924181344
SQL开始执行时间：20190924181344

drop table if exists pdm.outdepot_forecast_fx1
;
SQL结束执行时间：20190924181344
SQL开始执行时间：20190924181344

drop table if exists pdm.yj_outdepot_forecast_lv2_pre
;
SQL结束执行时间：20190924181345
SQL开始执行时间：20190924181345
create temporary table pdm.yj_outdepot_forecast_lv2_pre as
select a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,case when a.ct = 1 then 0
            else round((mon_2 + mon_3 + mon_4 + mon_5 + mon_6 + mon_7 + mon_8 + mon_9 + mon_10 + mon_11 + mon_12) / a.max_mon , 0 ) 
            end as avg_inum_person
  from pdm.outdepot_forecast_fx a
  left join (select * from (select * from pdm.checklist_fx_pd order by ccuscode,item_code,ym desc) c group by ccuscode,item_code) b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code

;
SQL结束执行时间：20190924181345
SQL开始执行时间：20190924181345

drop table if exists pdm.yj_outdepot_fx_maxd
;
SQL结束执行时间：20190924181345
SQL开始执行时间：20190924181345
create temporary table pdm.yj_outdepot_fx_maxd as
select finnal_ccuscode as ccuscode
      ,item_code
      ,max(tbilldate) as ddate
  from pdm.yj_outdepot_fx a
 group by finnal_ccuscode,item_code

;
SQL结束执行时间：20190924181346
SQL开始执行时间：20190924181346

drop temporary table if exists pdm.outfor_tem15
;
SQL结束执行时间：20190924181346
SQL开始执行时间：20190924181346
create temporary table if not exists pdm.outfor_tem15
select 
  a.ccuscode
  ,a.item_code
  ,a.cinvcode
  ,ifnull(b.inum_unit_person,1) as inum_unit_person
from 
  (
    select 
    finnal_ccuscode as ccuscode
    ,item_code
    ,cinvcode
    ,ddate
    from bidata.ft_21_outdepot 
    where 
    finnal_ccuscode in (select ccuscode from bidata.ft_41_cusitem_occupy group by ccuscode)
    and item_code in (select item_code from bidata.ft_41_cusitem_occupy where equipment = "否" group by item_code)
    and item_code != "XS0109"
    and cbustype = "产品类"
    and inum_person > 0 
    order by finnal_ccuscode,item_code,ddate desc
  ) as a 
  left join (select * from edw.map_inventory group by bi_cinvcode) b
    on a.cinvcode = b.bi_cinvcode
  group by a.ccuscode,a.item_code
;
SQL结束执行时间：20190924181346
SQL开始执行时间：20190924181346
alter table pdm.outfor_tem15 add index index_outfor_tem15_ccuscode (ccuscode)
;
SQL结束执行时间：20190924181346
SQL开始执行时间：20190924181346
alter table pdm.outfor_tem15 add index index_outfor_tem15_item_code (item_code)
;
SQL结束执行时间：20190924181346
SQL开始执行时间：20190924181346

drop table if exists pdm.yj_outdepot_forecast
;
SQL结束执行时间：20190924181346
SQL开始执行时间：20190924181346
create table pdm.yj_outdepot_forecast as
select  a.ccuscode
      ,a.item_code
      ,a.ddate
      ,a.mon_1
      ,a.ct
      ,a.max_mon
      ,a.avg_inum_person
      ,date_add(b.ddate, interval round(a.mon_1/a.avg_inum_person*30) day) as next_ddate
      ,case when round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) = 0 then d.inum_unit_person
            when d.inum_unit_person is null then round(c.mon_diff / a.ct * a.avg_inum_person)
            else round(c.mon_diff / a.ct * a.avg_inum_person / d.inum_unit_person) * d.inum_unit_person end as next_inum_person
      ,a.mon_1/a.avg_inum_person as zq_mon
  from pdm.yj_outdepot_forecast_lv2_pre a
  left join pdm.yj_outdepot_fx_maxd b
    on a.ccuscode  = b.ccuscode
   and a.item_code = b.item_code
  left join pdm.outdepot_forecast_12_first c
    on a.ccuscode  = c.ccuscode
   and a.item_code = c.item_code
  left join pdm.outfor_tem15 d
    on a.ccuscode  = d.ccuscode
   and a.item_code = d.item_code

;
SQL结束执行时间：20190924181347
SQL开始执行时间：20190924181347


# 删除字段
insert into pdm.yj_outdepot_fx
select 'yc'
      ,null
      ,a.next_ddate
      ,a.item_code
      ,null
      ,a.next_inum_person
      ,a.ccuscode
      ,null
      ,a.ccuscode
      ,null
      ,'20'
      ,avg_inum_person
      ,zq_mon
      ,null
  from pdm.yj_outdepot_forecast a
 where next_ddate is not null

;
SQL结束执行时间：20190924181347
SQL开始执行时间：20190924181347


update pdm.yj_outdepot_fx a
 inner join edw.map_customer b
    on a.ccuscode = b.bi_cuscode
   set a.ccusname = b.bi_cusname
      ,a.finnal_ccusname = b.bi_cusname
      ,a.province = b.province
 where a.ccusname is null

;
SQL结束执行时间：20190924181347
SQL开始执行时间：20190924181347

update pdm.yj_outdepot_fx a
 inner join (select * from edw.map_inventory group by item_code) b
    on a.item_code = b.item_code
   set a.item_name = b.level_three
 where a.item_name is null

;
SQL结束执行时间：20190924181347
SQL开始执行时间：20190924181347

update pdm.yj_outdepot_fx a
 inner join (select * from edw.x_cusitem_enddate group by item_code,ccuscode) b
    on a.item_code = b.item_code
   and a.ccuscode  = b.ccuscode
   set a.status = '停用'

;
SQL结束执行时间：20190924181348
